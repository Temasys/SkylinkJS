let e=!0,t=!0;function r(e,t,r){const n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function n(e,t,r){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,s=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return s.apply(this,arguments);const i=e=>{const t=r(e);t&&n(t);};return this._eventMap=this._eventMap||{},this._eventMap[n]=i,s.apply(this,[e,i])};const i=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return i.apply(this,arguments);const n=this._eventMap[r];return delete this._eventMap[r],i.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e);},enumerable:!0,configurable:!0});}function s(t){return "boolean"!=typeof t?new Error("Argument type: "+typeof t+". Please use a boolean."):(e=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function i(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(t=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function o(){if("object"==typeof window){if(e)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments);}}function a(e,r){t&&console.warn(e+" is deprecated, please use "+r+" instead.");}function c(e){const{navigator:t}=e,n={browser:null,version:null};if(void 0===e||!e.navigator)return n.browser="Not a browser.",n;if(t.mozGetUserMedia)n.browser="firefox",n.version=r(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)n.browser="chrome",n.version=r(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))n.browser="edge",n.version=r(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else {if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return n.browser="Not a supported browser.",n;n.browser="safari",n.version=r(t.userAgent,/AppleWebKit\/(\d+)\./,1),n.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype;}return n}function d(e){return "[object Object]"===Object.prototype.toString.call(e)}function l(e){return d(e)?Object.keys(e).reduce((function(t,r){const n=d(e[r]),s=n?l(e[r]):e[r],i=n&&!Object.keys(s).length;return void 0===s||i?t:Object.assign(t,{[r]:s})}),{}):e}function E(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((n=>{n.endsWith("Id")?E(e,e.get(t[n]),r):n.endsWith("Ids")&&t[n].forEach((t=>{E(e,e.get(t),r);}));})));}function S(e,t,r){const n=r?"outbound-rtp":"inbound-rtp",s=new Map;if(null===t)return s;const i=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&i.push(e);})),i.forEach((t=>{e.forEach((r=>{r.type===n&&r.trackId===t.id&&E(e,r,s);}));})),s}const p=o;function u(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const r=c(e),n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;const n="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const s=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[s("min",r)]=n.ideal,t.optional.push(e),e={},e[s("max",r)]=n.ideal,t.optional.push(e)):(e[s("",r)]=n.ideal,t.optional.push(e));}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[s("",r)]=n.exact):["min","max"].forEach((e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[s(e,r)]=n[e]);}));})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,s){if(r.version>=61)return s(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t]);};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio);}if(e&&"object"==typeof e.video){let i=e.video.facingMode;i=i&&("object"==typeof i?i:{ideal:i});const o=r.version<66;if(i&&("user"===i.exact||"environment"===i.exact||"user"===i.ideal||"environment"===i.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||o)){let r;if(delete e.video.facingMode,"environment"===i.exact||"environment"===i.ideal?r=["back","rear"]:"user"!==i.exact&&"user"!==i.ideal||(r=["front"]),r)return t.mediaDevices.enumerateDevices().then((t=>{let o=(t=t.filter((e=>"videoinput"===e.kind))).find((e=>r.some((t=>e.label.toLowerCase().includes(t)))));return !o&&t.length&&r.includes("back")&&(o=t[t.length-1]),o&&(e.video.deviceId=i.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=n(e.video),p("chrome: "+JSON.stringify(e)),s(e)}))}e.video=n(e.video);}return p("chrome: "+JSON.stringify(e)),s(e)},i=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,n){s(e,(e=>{t.webkitGetUserMedia(e,r,(e=>{n&&n(i(e));}));}));}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return s(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop();})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(i(e))))))};}}function R(e){e.MediaStream=e.MediaStream||e.webkitMediaStream;}function h(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e);},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===r.track.id)):{track:r.track};const s=new Event("track");s.track=r.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s);})),t.stream.getTracks().forEach((r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===r.id)):{track:r};const s=new Event("track");s.track=r,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s);}));},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)};}else n(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)));}function m(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return {track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let s=r.apply(this,arguments);return s||(s=t(this,e),this._senders.push(s)),s};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1);};}const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e));}));};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1);}));};}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}});}}function g(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const s=function(e){const t={};return e.result().forEach((e=>{const r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{r[t]=e.stat(t);})),t[r.id]=r;})),t},i=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const n=function(e){r(i(s(e)));};return t.apply(this,[n,e])}return new Promise(((e,r)=>{t.apply(this,[function(t){e(i(s(t)));},r]);})).then(r,n)};}function f(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>S(t,e.track,!0)))};}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),n(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>S(t,e.track,!1)))};}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,r,n;return this.getSenders().forEach((r=>{r.track===e&&(t?n=!0:t=r);})),this.getReceivers().forEach((t=>(t.track===e&&(r?n=!0:r=t),t.track===e))),n||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)};}function T(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();r.apply(this,arguments);const n=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(n);};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const r=this._shimmedLocalStreams[t].indexOf(e);-1!==r&&this._shimmedLocalStreams[t].splice(r,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t];})),s.apply(this,arguments)};}function _(e){if(!e.RTCPeerConnection)return;const t=c(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return T(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const r=new e.MediaStream(t.getTracks());this._streams[t.id]=r,this._reverseStreams[r.id]=t,t=r;}n.apply(this,[t]);};const s=e.RTCPeerConnection.prototype.removeStream;function i(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],s=e._streams[n.id];r=r.replace(new RegExp(s.id,"g"),n.id);})),new RTCSessionDescription({type:t.type,sdp:r})}function o(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],s=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),s.id);})),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id];},e.RTCPeerConnection.prototype.addTrack=function(t,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const s=this.getSenders().find((e=>e.track===t));if(s)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const i=this._streams[r.id];if(i)i.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"));}));else {const n=new e.MediaStream([t]);this._streams[r.id]=n,this._reverseStreams[n.id]=r,this.addStream(n);}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[t=>{const r=i(this,t);e[0].apply(null,[r]);},t=>{e[1]&&e[1].apply(null,t);},arguments[2]]):r.apply(this,arguments).then((e=>i(this,e)))}};e.RTCPeerConnection.prototype[t]=n[t];}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=o(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const d=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=d.get.apply(this);return ""===e.type?e:i(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((r=>{this._streams[r].getTracks().find((t=>e.track===t))&&(t=this._streams[r]);})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")));};}function A(e){const t=c(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const r=0===e.RTCPeerConnection.prototype.addIceCandidate.length;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t];}));const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return r||arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};}function I(e){n(e,"negotiationneeded",(e=>{if("stable"===e.target.signalingState)return e}));}var C=Object.freeze({__proto__:null,shimMediaStream:R,shimOnTrack:h,shimGetSendersWithDtmf:m,shimGetStats:g,shimSenderReceiverGetStats:f,shimAddTrackRemoveTrackWithNative:T,shimAddTrackRemoveTrack:_,shimPeerConnection:A,fixNegotiationNeeded:I,shimGetUserMedia:u,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((t=>{const n=r.video&&r.video.width,s=r.video&&r.video.height,i=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:i||3}},n&&(r.video.mandatory.maxWidth=n),s&&(r.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"));}});function O(e,t){return e(t={exports:{}},t.exports),t.exports}var N=O((function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return (t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){var r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter((function(e){return 0===e.indexOf(r)}))},t.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1];}return r},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return "a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return {id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return "a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),s=0;s<n.length;s++)r[(t=n[s].trim().split("="))[0].trim()]=t[1];return r},t.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t);})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n";}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return {type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n";})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return {semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return {algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,r){return {role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n";})),r},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return {tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return "a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return {keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,r){return t.matchPrefix(e+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,r){var n=t.matchPrefix(e+r,"a=ice-ufrag:")[0],s=t.matchPrefix(e+r,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substr(12),password:s.substr(10)}:null},t.writeIceParameters=function(e){return "a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" "),s=3;s<n.length;s++){var i=n[s],o=t.matchPrefix(e,"a=rtpmap:"+i+" ")[0];if(o){var a=t.parseRtpMap(o),c=t.matchPrefix(e,"a=fmtp:"+i+" ");switch(a.parameters=c.length?t.parseFmtp(c[0]):{},a.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+i+" ").map(t.parseRtcpFb),r.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(a.name.toUpperCase());}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){r.headerExtensions.push(t.parseExtmap(e));})),r},t.writeRtpDescription=function(e,r){var n="";n+="m="+e+" ",n+=r.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=r.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach((function(e){n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e);}));var s=0;return r.codecs.forEach((function(e){e.maxptime>s&&(s=e.maxptime);})),s>0&&(n+="a=maxptime:"+s+"\r\n"),n+="a=rtcp-mux\r\n",r.headerExtensions&&r.headerExtensions.forEach((function(e){n+=t.writeExtmap(e);})),n},t.parseRtpEncodingParameters=function(e){var r,n=[],s=t.parseRtpParameters(e),i=-1!==s.fecMechanisms.indexOf("RED"),o=-1!==s.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "cname"===e.attribute})),c=a.length>0&&a[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(r=d[0][1]),s.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&r&&(t.rtx={ssrc:r}),n.push(t),i&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},n.push(t));}})),0===n.length&&c&&n.push({ssrc:c});var l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,n.forEach((function(e){e.maxBitrate=l;}))),n},t.parseRtcpParameters=function(e){var r={},n=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "cname"===e.attribute}))[0];n&&(r.cname=n.value,r.ssrc=n.ssrc);var s=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=s.length>0,r.compound=0===s.length;var i=t.matchPrefix(e,"a=rtcp-mux");return r.mux=i.length>0,r},t.parseMsid=function(e){var r,n=t.matchPrefix(e,"a=msid:");if(1===n.length)return {stream:(r=n[0].substr(7).split(" "))[0],track:r[1]};var s=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "msid"===e.attribute}));return s.length>0?{stream:(r=s[0].value.split(" "))[0],track:r[1]}:void 0},t.parseSctpDescription=function(e){var r,n=t.parseMLine(e),s=t.matchPrefix(e,"a=max-message-size:");s.length>0&&(r=parseInt(s[0].substr(19),10)),isNaN(r)&&(r=65536);var i=t.matchPrefix(e,"a=sctp-port:");if(i.length>0)return {port:parseInt(i[0].substr(12),10),protocol:n.fmt,maxMessageSize:r};if(t.matchPrefix(e,"a=sctpmap:").length>0){var o=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return {port:parseInt(o[0],10),protocol:o[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,r,n){var s=void 0!==r?r:2;return "v=0\r\no="+(n||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,r,n,s){var i=t.writeRtpDescription(e.kind,r);if(i+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),i+="a=mid:"+e.mid+"\r\n",e.direction?i+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?i+="a=sendrecv\r\n":e.rtpSender?i+="a=sendonly\r\n":e.rtpReceiver?i+="a=recvonly\r\n":i+="a=inactive\r\n",e.rtpSender){var o="msid:"+s.id+" "+e.rtpSender.track.id+"\r\n";i+="a="+o,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n");}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),i},t.getDirection=function(e,r){for(var n=t.splitLines(e),s=0;s<n.length;s++)switch(n[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[s].substr(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return "0"===e.split(" ",2)[1]},t.parseMLine=function(e){var r=t.splitLines(e)[0].substr(2).split(" ");return {kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){var r=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return {username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return !1;for(var r=t.splitLines(e),n=0;n<r.length;n++)if(r[n].length<2||"="!==r[n].charAt(1))return !1;return !0},e.exports=t;}));function D(e,t,r,n,s){var i=N.writeRtpDescription(e.kind,t);if(i+=N.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=N.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":s||"active"),i+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?i+="a=sendrecv\r\n":e.rtpSender?i+="a=sendonly\r\n":e.rtpReceiver?i+="a=recvonly\r\n":i+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var a="msid:"+(n?n.id:"-")+" "+o+"\r\n";i+="a="+a,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n");}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+N.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+N.localCName+"\r\n"),i}function v(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},s=function(e,t,r,s){var i=n(e.parameters.apt,r),o=n(t.parameters.apt,s);return i&&o&&i.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach((function(n){for(var i=0;i<t.codecs.length;i++){var o=t.codecs[i];if(n.name.toLowerCase()===o.name.toLowerCase()&&n.clockRate===o.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&o.parameters.apt&&!s(n,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(n.numChannels,o.numChannels),r.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return !0;return !1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var s=t.headerExtensions[n];if(e.uri===s.uri){r.headerExtensions.push(s);break}}})),r}function y(e,t,r){return -1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function P(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function M(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}var k=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}));}function n(t,r,n,s){var i=new Event("track");i.track=r,i.receiver=n,i.transceiver={receiver:n},i.streams=s,e.setTimeout((function(){t._dispatchEvent("track",i);}));}var s=function(r){var n=this,s=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){n[e]=s[e].bind(s);})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw M("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all";}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced";}if(r.iceServers=function(e,t){var r=!1;return (e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var s="string"==typeof n;return s&&(n=[n]),n=n.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=s?n[0]:n,!!n.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var i=r.iceCandidatePoolSize;i>0;i--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=N.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1;};Object.defineProperty(s.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(s.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),s.prototype.onicecandidate=null,s.prototype.onaddstream=null,s.prototype.ontrack=null,s.prototype.onremovestream=null,s.prototype.onsignalingstatechange=null,s.prototype.oniceconnectionstatechange=null,s.prototype.onconnectionstatechange=null,s.prototype.onicegatheringstatechange=null,s.prototype.onnegotiationneeded=null,s.prototype.ondatachannel=null,s.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t));},s.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e);},s.prototype.getConfiguration=function(){return this._config},s.prototype.getLocalStreams=function(){return this.localStreams},s.prototype.getRemoteStreams=function(){return this.remoteStreams},s.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else {var s=this._createIceAndDtlsTransports();n.iceTransport=s.iceTransport,n.dtlsTransport=s.dtlsTransport;}return t||this.transceivers.push(n),n},s.prototype.addTrack=function(t,r){if(this._isClosed)throw M("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw M("InvalidAccessError","Track already exists.");for(var s=0;s<this.transceivers.length;s++)this.transceivers[s].track||this.transceivers[s].kind!==t.kind||(n=this.transceivers[s]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),n.track=t,n.stream=r,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},s.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e);}));else {var n=e.clone();e.getTracks().forEach((function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled;}));})),n.getTracks().forEach((function(e){r.addTrack(e,n);}));}},s.prototype.removeTrack=function(t){if(this._isClosed)throw M("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw M("InvalidAccessError","Sender was not created by this connection.");var n=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded();},s.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r);}));},s.prototype.getSenders=function(){return this.transceivers.filter((function(e){return !!e.rtpSender})).map((function(e){return e.rtpSender}))},s.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return !!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},s.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var s=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(s,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;s.state=r?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e);},s.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),s},s.prototype._gather=function(t,r){var n=this,s=this.transceivers[r].iceGatherer;if(!s.onlocalcandidate){var i=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,s.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),s.onlocalcandidate=function(e){if(!(n.usingBundle&&r>0)){var i=new Event("icecandidate");i.candidate={sdpMid:t,sdpMLineIndex:r};var o=e.candidate,a=!o||0===Object.keys(o).length;if(a)"new"!==s.state&&"gathering"!==s.state||(s.state="completed");else {"new"===s.state&&(s.state="gathering"),o.component=1,o.ufrag=s.getLocalParameters().usernameFragment;var c=N.writeCandidate(o);i.candidate=Object.assign(i.candidate,N.parseCandidate(c)),i.candidate.candidate=c,i.candidate.toJSON=function(){return {candidate:i.candidate.candidate,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex,usernameFragment:i.candidate.usernameFragment}};}var d=N.getMediaSections(n._localDescription.sdp);d[i.candidate.sdpMLineIndex]+=a?"a=end-of-candidates\r\n":"a="+i.candidate.candidate+"\r\n",n._localDescription.sdp=N.getDescription(n._localDescription.sdp)+d.join("");var l=n.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),a||n._dispatchEvent("icecandidate",i),l&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange());}},e.setTimeout((function(){i.forEach((function(e){s.onlocalcandidate(e);}));}),0);}},s.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState();};var n=new e.RTCDtlsTransport(r);return n.ondtlsstatechange=function(){t._updateConnectionState();},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState();},{iceTransport:r,dtlsTransport:n}},s.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport);},s.prototype._transceive=function(e,r,n){var s=v(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:N.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),n&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx;})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s));},s.prototype.setLocalDescription=function(e){var t,r,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(M("TypeError",'Unsupported type "'+e.type+'"'));if(!y("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(M("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=N.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=N.parseRtpParameters(e);n.transceivers[t].localCapabilities=r;})),n.transceivers.forEach((function(e,t){n._gather(e.mid,t);}));else if("answer"===e.type){t=N.splitSections(n._remoteDescription.sdp),r=t.shift();var s=N.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var i=n.transceivers[t],o=i.iceGatherer,a=i.iceTransport,c=i.dtlsTransport,d=i.localCapabilities,l=i.remoteCapabilities;if(!(N.isRejected(e)&&0===N.matchPrefix(e,"a=bundle-only").length)&&!i.rejected){var E=N.getIceParameters(e,r),S=N.getDtlsParameters(e,r);s&&(S.role="server"),n.usingBundle&&0!==t||(n._gather(i.mid,t),"new"===a.state&&a.start(o,E,s?"controlling":"controlled"),"new"===c.state&&c.start(S));var p=v(d,l);n._transceive(i,p.codecs.length>0,!1);}}));}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()},s.prototype.setRemoteDescription=function(s){var i=this;if(-1===["offer","answer"].indexOf(s.type))return Promise.reject(M("TypeError",'Unsupported type "'+s.type+'"'));if(!y("setRemoteDescription",s.type,i.signalingState)||i._isClosed)return Promise.reject(M("InvalidStateError","Can not set remote "+s.type+" in state "+i.signalingState));var o={};i.remoteStreams.forEach((function(e){o[e.id]=e;}));var a=[],c=N.splitSections(s.sdp),d=c.shift(),l=N.matchPrefix(d,"a=ice-lite").length>0,E=N.matchPrefix(d,"a=group:BUNDLE ").length>0;i.usingBundle=E;var S=N.matchPrefix(d,"a=ice-options:")[0];return i.canTrickleIceCandidates=!!S&&S.substr(14).split(" ").indexOf("trickle")>=0,c.forEach((function(n,c){var S=N.splitLines(n),p=N.getKind(n),u=N.isRejected(n)&&0===N.matchPrefix(n,"a=bundle-only").length,R=S[0].substr(2).split(" ")[2],h=N.getDirection(n,d),m=N.parseMsid(n),g=N.getMid(n)||N.generateIdentifier();if(u||"application"===p&&("DTLS/SCTP"===R||"UDP/DTLS/SCTP"===R))i.transceivers[c]={mid:g,kind:p,protocol:R,rejected:!0};else {var f,T,_,A,I,C,O,D,y;!u&&i.transceivers[c]&&i.transceivers[c].rejected&&(i.transceivers[c]=i._createTransceiver(p,!0));var M,k,w=N.parseRtpParameters(n);u||(M=N.getIceParameters(n,d),(k=N.getDtlsParameters(n,d)).role="client"),O=N.parseRtpEncodingParameters(n);var b=N.parseRtcpParameters(n),L=N.matchPrefix(n,"a=end-of-candidates",d).length>0,G=N.matchPrefix(n,"a=candidate:").map((function(e){return N.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===s.type||"answer"===s.type)&&!u&&E&&c>0&&i.transceivers[c]&&(i._disposeIceAndDtlsTransports(c),i.transceivers[c].iceGatherer=i.transceivers[0].iceGatherer,i.transceivers[c].iceTransport=i.transceivers[0].iceTransport,i.transceivers[c].dtlsTransport=i.transceivers[0].dtlsTransport,i.transceivers[c].rtpSender&&i.transceivers[c].rtpSender.setTransport(i.transceivers[0].dtlsTransport),i.transceivers[c].rtpReceiver&&i.transceivers[c].rtpReceiver.setTransport(i.transceivers[0].dtlsTransport)),"offer"!==s.type||u){if("answer"===s.type&&!u){T=(f=i.transceivers[c]).iceGatherer,_=f.iceTransport,A=f.dtlsTransport,I=f.rtpReceiver,C=f.sendEncodingParameters,D=f.localCapabilities,i.transceivers[c].recvEncodingParameters=O,i.transceivers[c].remoteCapabilities=w,i.transceivers[c].rtcpParameters=b,G.length&&"new"===_.state&&(!l&&!L||E&&0!==c?G.forEach((function(e){P(f.iceTransport,e);})):_.setRemoteCandidates(G)),E&&0!==c||("new"===_.state&&_.start(T,M,"controlling"),"new"===A.state&&A.start(k)),!v(f.localCapabilities,f.remoteCapabilities).codecs.filter((function(e){return "rtx"===e.name.toLowerCase()})).length&&f.sendEncodingParameters[0].rtx&&delete f.sendEncodingParameters[0].rtx,i._transceive(f,"sendrecv"===h||"recvonly"===h,"sendrecv"===h||"sendonly"===h),!I||"sendrecv"!==h&&"sendonly"!==h?delete f.rtpReceiver:(y=I.track,m?(o[m.stream]||(o[m.stream]=new e.MediaStream),r(y,o[m.stream]),a.push([y,I,o[m.stream]])):(o.default||(o.default=new e.MediaStream),r(y,o.default),a.push([y,I,o.default])));}}else {(f=i.transceivers[c]||i._createTransceiver(p)).mid=g,f.iceGatherer||(f.iceGatherer=i._createIceGatherer(c,E)),G.length&&"new"===f.iceTransport.state&&(!L||E&&0!==c?G.forEach((function(e){P(f.iceTransport,e);})):f.iceTransport.setRemoteCandidates(G)),D=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(D.codecs=D.codecs.filter((function(e){return "rtx"!==e.name}))),C=f.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var U,F=!1;if("sendrecv"===h||"sendonly"===h){if(F=!f.rtpReceiver,I=f.rtpReceiver||new e.RTCRtpReceiver(f.dtlsTransport,p),F)y=I.track,m&&"-"===m.stream||(m?(o[m.stream]||(o[m.stream]=new e.MediaStream,Object.defineProperty(o[m.stream],"id",{get:function(){return m.stream}})),Object.defineProperty(y,"id",{get:function(){return m.track}}),U=o[m.stream]):(o.default||(o.default=new e.MediaStream),U=o.default)),U&&(r(y,U),f.associatedRemoteMediaStreams.push(U)),a.push([y,I,U]);}else f.rtpReceiver&&f.rtpReceiver.track&&(f.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===f.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}));}(r,t);})),f.associatedRemoteMediaStreams=[]);f.localCapabilities=D,f.remoteCapabilities=w,f.rtpReceiver=I,f.rtcpParameters=b,f.sendEncodingParameters=C,f.recvEncodingParameters=O,i._transceive(i.transceivers[c],!1,F);}}})),void 0===i._dtlsRole&&(i._dtlsRole="offer"===s.type?"active":"passive"),i._remoteDescription={type:s.type,sdp:s.sdp},"offer"===s.type?i._updateSignalingState("have-remote-offer"):i._updateSignalingState("stable"),Object.keys(o).forEach((function(t){var r=o[t];if(r.getTracks().length){if(-1===i.remoteStreams.indexOf(r)){i.remoteStreams.push(r);var s=new Event("addstream");s.stream=r,e.setTimeout((function(){i._dispatchEvent("addstream",s);}));}a.forEach((function(e){var t=e[0],s=e[1];r.id===e[2].id&&n(i,t,s,[r]);}));}})),a.forEach((function(e){e[2]||n(i,e[0],e[1],[]);})),e.setTimeout((function(){i&&i.transceivers&&i.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}));}));}),4e3),Promise.resolve()},s.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop();})),this._isClosed=!0,this._updateSignalingState("closed");},s.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t);},s.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e);}}),0));},s.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++;})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r);}},s.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++);})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r);}},s.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(M("InvalidStateError","Can not call createOffer after close"));var n=r.transceivers.filter((function(e){return "audio"===e.kind})).length,s=r.transceivers.filter((function(e){return "video"===e.kind})).length,i=arguments[0];if(i){if(i.mandatory||i.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==i.offerToReceiveAudio&&(n=!0===i.offerToReceiveAudio?1:!1===i.offerToReceiveAudio?0:i.offerToReceiveAudio),void 0!==i.offerToReceiveVideo&&(s=!0===i.offerToReceiveVideo?1:!1===i.offerToReceiveVideo?0:i.offerToReceiveVideo);}for(r.transceivers.forEach((function(e){"audio"===e.kind?--n<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1);}));n>0||s>0;)n>0&&(r._createTransceiver("audio"),n--),s>0&&(r._createTransceiver("video"),s--);var o=N.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(n,s){var i=n.track,o=n.kind,a=n.mid||N.generateIdentifier();n.mid=a,n.iceGatherer||(n.iceGatherer=r._createIceGatherer(s,r.usingBundle));var c=e.RTCRtpSender.getCapabilities(o);t<15019&&(c.codecs=c.codecs.filter((function(e){return "rtx"!==e.name}))),c.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType);}));})),c.headerExtensions.forEach((function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id);}));}));var d=n.sendEncodingParameters||[{ssrc:1001*(2*s+1)}];i&&t>=15019&&"video"===o&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,o)),n.localCapabilities=c,n.sendEncodingParameters=d;})),"max-compat"!==r._config.bundlePolicy&&(o+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){o+=D(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),o+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,o+="a="+N.writeCandidate(e)+"\r\n";})),"completed"===e.iceGatherer.state&&(o+="a=end-of-candidates\r\n"));}));var a=new e.RTCSessionDescription({type:"offer",sdp:o});return Promise.resolve(a)},s.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(M("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(M("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var n=N.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(n+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),n+="a=ice-options:trickle\r\n";var s=N.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,i){if(!(i+1>s)){if(e.rejected)return "application"===e.kind?"DTLS/SCTP"===e.protocol?n+="m=application 0 DTLS/SCTP 5000\r\n":n+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?n+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(n+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(n+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var o;if(e.stream)"audio"===e.kind?o=e.stream.getAudioTracks()[0]:"video"===e.kind&&(o=e.stream.getVideoTracks()[0]),o&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var a=v(e.localCapabilities,e.remoteCapabilities);!a.codecs.filter((function(e){return "rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,n+=D(e,a,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(n+="a=rtcp-rsize\r\n");}}));var i=new e.RTCSessionDescription({type:"answer",sdp:n});return Promise.resolve(i)},s.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(n,s){if(!r._remoteDescription)return s(M("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var i=e.sdpMLineIndex;if(e.sdpMid)for(var o=0;o<r.transceivers.length;o++)if(r.transceivers[o].mid===e.sdpMid){i=o;break}var a=r.transceivers[i];if(!a)return s(M("OperationError","Can not add ICE candidate"));if(a.rejected)return n();var c=Object.keys(e.candidate).length>0?N.parseCandidate(e.candidate):{};if("tcp"===c.protocol&&(0===c.port||9===c.port))return n();if(c.component&&1!==c.component)return n();if((0===i||i>0&&a.iceTransport!==r.transceivers[0].iceTransport)&&!P(a.iceTransport,c))return s(M("OperationError","Can not add ICE candidate"));var d=e.candidate.trim();0===d.indexOf("a=")&&(d=d.substr(2)),(t=N.getMediaSections(r._remoteDescription.sdp))[i]+="a="+(c.type?d:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=N.getDescription(r._remoteDescription.sdp)+t.join("");}else for(var l=0;l<r.transceivers.length&&(r.transceivers[l].rejected||(r.transceivers[l].iceTransport.addRemoteCandidate({}),(t=N.getMediaSections(r._remoteDescription.sdp))[l]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=N.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));l++);n();}))},s.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver);})),!r)throw M("InvalidAccessError","Invalid selector.");return r.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats());}));})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e);}));})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var n;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[r]).type]||n.type,t.set(r,e[r]);})),t}))};}}));var i=["createOffer","createAnswer"];return i.forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t]);}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t]);})):t.apply(this,arguments)};})),(i=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null);}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t]);})):t.apply(this,arguments)};})),["getStats"].forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null);})):t.apply(this,arguments)};})),s};function w(e){const t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch((e=>Promise.reject(function(e){return {name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e))))};}function b(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)));}function L(e){const t=c(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const r=new Event("enabled");r.enabled=e,this.dispatchEvent(r);}});}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const r=k(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let r=!1;return (e=JSON.parse(JSON.stringify(e))).filter((e=>{if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&a("RTCIceServer.url","RTCIceServer.urls");const n="string"==typeof t;return n&&(t=[t]),t=t.filter((e=>{if(0===e.indexOf("stun:"))return !1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r})),delete e.url,e.urls=n?t[0]:t,!!t.length}}))}(e.iceServers,t.version),o("ICE servers after filtering:",e.iceServers)),new r(e)},e.RTCPeerConnection.prototype=r.prototype;}function G(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack);}var U=Object.freeze({__proto__:null,shimPeerConnection:L,shimReplaceTrack:G,shimGetUserMedia:w,shimGetDisplayMedia:b});function F(e){const t=c(e),r=e&&e.navigator,n=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){a("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n);},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t]);},t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return "object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),e(r.audio,"autoGainControl","mozAutoGainControl"),e(r.audio,"noiseSuppression","mozNoiseSuppression")),t(r)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const r=t.apply(this,arguments);return e(r,"mozAutoGainControl","autoGainControl"),e(r,"mozNoiseSuppression","noiseSuppression"),r};}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(r){return "audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),e(r,"autoGainControl","mozAutoGainControl"),e(r,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[r])};}}}function B(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function x(e){const t=c(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t];})),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};}const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,s,i]=arguments;return n.apply(this,[e||null]).then((e=>{if(t.version<53&&!s)try{e.forEach((e=>{e.type=r[e.type]||e.type;}));}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,n)=>{e.set(n,Object.assign({},t,{type:r[t.type]||t.type}));}));}return e})).then(s,i)};}function H(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)};}function V(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),n(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)};}function j(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){a("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t);}));});}function $(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel);}function W(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=t.apply(this,arguments);if(r){const{sender:t}=n,r=t.getParameters();"encodings"in r||(r.encodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(r).catch((()=>{}))));}return n});}function K(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[];})):t.apply(this,arguments)};}function z(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[];})):t.apply(this,arguments)};}var Y=Object.freeze({__proto__:null,shimOnTrack:B,shimPeerConnection:x,shimSenderGetStats:H,shimReceiverGetStats:V,shimRemoveStream:j,shimRTCDataChannel:$,shimAddTransceiver:W,shimCreateOffer:K,shimCreateAnswer:z,shimGetUserMedia:F,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return !0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)});}});function J(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((r=>t.call(this,r,e))),e.getVideoTracks().forEach((r=>t.call(this,r,e)));},e.RTCPeerConnection.prototype.addTrack=function(e,...r){return r&&r.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e];})),t.apply(this,arguments)};}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const r=e.getTracks();this.getSenders().forEach((e=>{r.includes(e.track)&&this.removeTrack(e);}));});}}function Q(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t);}));});}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const r=new Event("addstream");r.stream=t,e.dispatchEvent(r);}));}),t.apply(e,arguments)};}}function q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,s=t.setLocalDescription,i=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:e,s=r.apply(this,[n]);return t?(s.then(e,t),Promise.resolve()):s},t.createAnswer=function(e,t){const r=arguments.length>=2?arguments[2]:e,s=n.apply(this,[r]);return t?(s.then(e,t),Promise.resolve()):s};let a=function(e,t,r){const n=s.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,r){const n=i.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,r){const n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=a;}function X(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>r(Z(e));}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n);}.bind(t));}function Z(e){return e&&void 0!==e.video?Object.assign({},e,{video:l(e.video)}):e}function ee(e){const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){const t=[];for(let r=0;r<e.iceServers.length;r++){let n=e.iceServers[r];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(a("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[r]);}e.iceServers=t;}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate});}function te(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function re(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video");}return t.apply(this,arguments)};}var ne=Object.freeze({__proto__:null,shimLocalStreamsAPI:J,shimRemoteStreamsAPI:Q,shimCallbacksAPI:q,shimGetUserMedia:X,shimConstraints:Z,shimRTCIceServerUrls:ee,shimTrackEventTransceiver:te,shimCreateOfferLegacy:re});function se(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const r=new t(e),n=N.parseCandidate(e.candidate),s=Object.assign(r,n);return s.toJSON=function(){return {candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,n(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)));}function ie(e){if(!e.RTCPeerConnection)return;const t=c(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const r=function(e){if(!e||!e.sdp)return !1;const t=N.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=N.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return -1;const r=parseInt(t[1],10);return r!=r?-1:r},s=function(e){let r=65536;return "firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},i=function(e,r){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const s=N.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?n=parseInt(s[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0});}if(r(arguments[0])){const e=n(arguments[0]),t=s(e),r=i(arguments[0],e);let o;o=0===t&&0===r?Number.POSITIVE_INFINITY:0===t||0===r?Math.max(t,r):Math.min(t,r);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a;}return o.apply(this,arguments)};}function oe(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const r=e.send;e.send=function(){const n=arguments[0],s=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&s>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)};}const r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=r.apply(this,arguments);return t(e,this),e},n(e,"datachannel",(e=>(t(e.channel,e.target),e)));}function ae(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return {completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e);},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const r=new Event("connectionstatechange",e);t.dispatchEvent(r);}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)};}));}function ce(e){if(!e.RTCPeerConnection)return;const t=c(e);if("chrome"===t.browser&&t.version>=71)return;const r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n")),r.apply(this,arguments)};}var de=Object.freeze({__proto__:null,shimRTCIceCandidate:se,shimMaxMessageSize:ie,shimSendThrowTypeError:oe,shimConnectionState:ae,removeAllowExtmapMixed:ce});const le=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const n=o,a=c(e),d={browserDetails:a,commonShim:de,extractVersion:r,disableLog:s,disableWarnings:i};switch(a.browser){case"chrome":if(!C||!A||!t.shimChrome)return n("Chrome shim is not included in this adapter release."),d;n("adapter.js shimming chrome."),d.browserShim=C,u(e),R(e),A(e),h(e),_(e),m(e),g(e),f(e),I(e),se(e),ae(e),ie(e),oe(e),ce(e);break;case"firefox":if(!Y||!x||!t.shimFirefox)return n("Firefox shim is not included in this adapter release."),d;n("adapter.js shimming firefox."),d.browserShim=Y,F(e),x(e),B(e),j(e),H(e),V(e),$(e),W(e),K(e),z(e),se(e),ae(e),ie(e),oe(e);break;case"edge":if(!U||!L||!t.shimEdge)return n("MS edge shim is not included in this adapter release."),d;n("adapter.js shimming edge."),d.browserShim=U,w(e),b(e),L(e),G(e),ie(e),oe(e);break;case"safari":if(!ne||!t.shimSafari)return n("Safari shim is not included in this adapter release."),d;n("adapter.js shimming safari."),d.browserShim=ne,ee(e),re(e),q(e),J(e),Q(e),te(e),X(e),se(e),ie(e),oe(e),ce(e);break;default:n("Unsupported browser!");}return d}({window:window});le.options=le.options||{},le.onwebrtcreadyDone=!1,le.WebRTCPlugin={plugin:null},le._onwebrtcreadies=[],le.webRTCReady=function(e){if("function"!=typeof e)throw new Error("Callback provided is not a function");var t=function(){"function"==typeof window.require&&"function"==typeof le._defineMediaSourcePolyfill&&le._defineMediaSourcePolyfill(),e(null!==le.WebRTCPlugin.plugin);};!0===le.onwebrtcreadyDone?t():le._onwebrtcreadies.push(t);},le.maybeThroughWebRTCReady=function(){le.onwebrtcreadyDone||(le.onwebrtcreadyDone=!0,le._onwebrtcreadies.length?le._onwebrtcreadies.forEach((function(e){"function"==typeof e&&e(null!==le.WebRTCPlugin.plugin);})):"function"==typeof le.onwebrtcready&&le.onwebrtcready(null!==le.WebRTCPlugin.plugin));},window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,window.webrtcMinimumVersion=null,window.webrtcDetectedDCSupport=null,le.parseWebrtcDetectedBrowser=function(){var e=null;if(window.navigator.userAgent.match(/React-Native/gi)||navigator.userAgent.match(/React-Native/gi))window.webrtcDetectedBrowser="react-native",window.webrtcDetectedVersion="",window.webrtcMinimumVersion=0,window.webrtcDetectedType="react-native",window.webrtcDetectedDCSupport=null;else if(window.opr&&opr.addons||window.opera||navigator.userAgent.indexOf(" OPR/")>=0)e=navigator.userAgent.match(/OPR\/(\d+)/i)||[],window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=26,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport="SCTP";else if(navigator.userAgent.match(/Bowser\/[0-9.]*/g)){e=navigator.userAgent.match(/Bowser\/[0-9.]*/g)||[];var t=parseInt((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[])[2]||"0",10);window.webrtcDetectedBrowser="bowser",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=0,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=t>30?"SCTP":"RTP";}else if(navigator.userAgent.indexOf("OPiOS")>0)e=navigator.userAgent.match(/OPiOS\/([0-9]+)\./),window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("CriOS")>0){e=navigator.userAgent.match(/CriOS\/([0-9]+)\./)||[];const t=navigator.userAgent.match(/CPU( iPhone| iPad)? OS ([0-9]+)_([0-9]+)/g)[0].split(" ");t[t.length-1].split("_")[0]>13?(window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=53,window.webrtcDetectedType="AppleWebKit",window.webrtcDetectedBrowser="chrome",window.webrtcDetectedDCSupport=null):(window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedBrowser="chrome",window.webrtcDetectedDCSupport=null);}else if(navigator.userAgent.indexOf("FxiOS")>0)e=navigator.userAgent.match(/FxiOS\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(document.documentMode)e=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedBrowser="IE",window.webrtcDetectedVersion=parseInt(e[1],10),window.webrtcMinimumVersion=9,window.webrtcDetectedType="plugin",window.webrtcDetectedDCSupport="SCTP",webrtcDetectedVersion||(e=/\bMSIE[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10));else if(window.StyleMedia||navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e=navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||[],window.webrtcDetectedBrowser="edge",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=13.10547,window.webrtcDetectedType="ms",window.webrtcDetectedDCSupport=null;else if("undefined"!=typeof InstallTrigger||navigator.userAgent.indexOf("irefox")>0)e=navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=33,window.webrtcDetectedType="moz",window.webrtcDetectedDCSupport="SCTP";else if(window.chrome&&window.chrome.webstore||navigator.userAgent.indexOf("Chrom")>0)e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[],window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(e[2]||"0",10),window.webrtcMinimumVersion=38,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=window.webrtcDetectedVersion>30?"SCTP":"RTP";else if(/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()||navigator.userAgent.match(/AppleWebKit\/(\d+)\./)||navigator.userAgent.match(/Version\/(\d+).(\d+)/)){e=navigator.userAgent.match(/version\/(\d+)\.(\d+)/i)||[];var r=navigator.userAgent.match(/AppleWebKit\/(\d+)/i)||[],n=navigator.userAgent.match(/(iPhone|iPad)/gi),s=r.length>=1&&r[1]>=604;if(window.webrtcDetectedBrowser="safari",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=7,n)window.webrtcDetectedType=s?"AppleWebKit":null;else {var i=window.webrtcDetectedVersion,o=parseInt(e[2]||"0",10),a=11==i&&o<2;window.webrtcDetectedType=!s||le.options.forceSafariPlugin&&a?"plugin":"AppleWebKit";}window.webrtcDetectedDCSupport="SCTP";}le.webrtcDetectedBrowser=window.webrtcDetectedBrowser,le.webrtcDetectedVersion=window.webrtcDetectedVersion,le.webrtcMinimumVersion=window.webrtcMinimumVersion,le.webrtcDetectedType=window.webrtcDetectedType,le.webrtcDetectedDCSupport=window.webrtcDetectedDCSupport;},le.addExtensions=function(){var e=null,t=null;navigator.mozGetUserMedia?(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}):navigator.webkitGetUserMedia?(e=function(e,t){return le.webrtcDetectedVersion>=43?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.error("Error attaching stream to element."),e},t=function(e,t){return le.webrtcDetectedVersion>=43?e.srcObject=t.srcObject:e.src=t.src,e}):"AppleWebKit"===le.webrtcDetectedType&&("chrome"===le.webrtcDetectedBrowser?e=function(e,t){return le.webrtcDetectedVersion>=43?e.srcObject=t:console.error("Error attaching stream to element."),e}:(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e})),window.attachMediaStream=e,window.reattachMediaStream=t,le.attachMediaStream=e,le.reattachMediaStream=t;},le.parseWebrtcDetectedBrowser(),le.addExtensions(),le.maybeThroughWebRTCReady();var Ee=Object.freeze({__proto__:null,ON_INCOMING_STREAM:"onIncomingStream",ON_INCOMING_SCREEN_STREAM:"onIncomingScreenStream",STREAM_ENDED:"streamEnded",PEER_UPDATED:"peerUpdated",PEER_JOINED:"peerJoined",PEER_LEFT:"peerLeft",PEER_CONNECTION_STATE:"peerConnectionState",DATA_CHANNEL_STATE:"dataChannelState",ON_INCOMING_MESSAGE:"onIncomingMessage",HANDSHAKE_PROGRESS:"handshakeProgress",SERVER_PEER_JOINED:"serverPeerJoined",SERVER_PEER_LEFT:"serverPeerLeft",CANDIDATE_PROCESSING_STATE:"candidateProcessingState",CANDIDATE_GENERATION_STATE:"candidateGenerationState",CANDIDATES_GATHERED:"candidatesGathered",DATA_STREAM_STATE:"dataStreamState",DATA_TRANSFER_STATE:"dataTransferState",ON_INCOMING_DATA:"onIncomingData",ON_INCOMING_DATA_REQUEST:"onIncomingDataRequest",ON_INCOMING_DATA_STREAM:"onIncomingDataStream",ON_INCOMING_DATA_STREAM_STARTED:"onIncomingDataStreamStarted",ON_INCOMING_DATA_STREAM_STOPPED:"onIncomingDataStreamStopped",GET_PEERS_STATE_CHANGE:"getPeersStateChange",SESSION_DISCONNECT:"sessionDisconnect",STREAM_MUTED:"streamMuted",CHANNEL_OPEN:"channelOpen",CHANNEL_REOPEN:"channelReopen",CHANNEL_CLOSE:"channelClose",CHANNEL_MESSAGE:"channelMessage",CHANNEL_ERROR:"channelError",CHANNEL_RETRY:"channelRetry",SOCKET_ERROR:"socketError",SYSTEM_ACTION:"systemAction",MEDIA_ACCESS_FALLBACK:"mediaAccessFallback",MEDIA_ACCESS_REQUIRED:"mediaAccessRequired",MEDIA_ACCESS_STOPPED:"mediaAccessStopped",MEDIA_ACCESS_SUCCESS:"mediaAccessSuccess",RECORDING_STATE:"recordingState",LOCAL_MEDIA_MUTED:"localMediaMuted",MEDIA_ACCESS_ERROR:"mediaAccessError",GET_CONNECTION_STATUS_STATE_CHANGE:"getConnectionStatusStateChange",READY_STATE_CHANGE:"readyStateChange",ROOM_LOCK:"roomLock",INTRODUCE_STATE_CHANGE:"introduceStateChange",ICE_CONNECTION_STATE:"iceConnectionState",BYE:"bye",RTMP_STATE:"rtmpState",LOGGED_ON_CONSOLE:"loggedOnConsole",MEDIA_INFO_DELETED:"mediaInfoDeleted",STORED_MESSAGES:"storedMessages",ENCRYPT_SECRETS_UPDATED:"encryptSecretsUpdated",PERSISTENT_MESSAGE_STATE:"persistentMessageState",ROOM_REJOIN:"roomRejoin"});class Se{constructor(e,t){this.name=e,this.detail=t;}}const pe=(e={})=>new Se("onIncomingStream",{detail:e}),ue=(e={})=>new Se("onIncomingScreenStream",{detail:e}),Re=(e={})=>new Se("streamEnded",{detail:e}),he=(e={})=>new Se("streamMuted",{detail:e}),me=(e={})=>new Se("dataChannelState",{detail:e}),ge=(e={})=>new Se("onIncomingMessage",{detail:e}),fe=(e={})=>new Se("handshakeProgress",{detail:e}),Te=(e={})=>new Se("readyStateChange",{detail:e}),_e=e=>new Se("candidateProcessingState",{detail:e}),Ae=e=>new Se("candidateGenerationState",{detail:e}),Ie=e=>new Se("iceConnectionState",{detail:e}),Ce=(e={})=>new Se("roomLock",{detail:e}),Oe=e=>new Se("dataTransferState",{detail:e}),Ne=e=>new Se("onIncomingData",{detail:e}),De=e=>new Se("onIncomingDataRequest",{detail:e}),ve=(e={})=>new Se("peerUpdated",{detail:e}),ye=(e={})=>new Se("peerJoined",{detail:e}),Pe=(e={})=>new Se("peerLeft",{detail:e}),Me=(e={})=>new Se("serverPeerJoined",{detail:e}),ke=(e={})=>new Se("serverPeerLeft",{detail:e}),we=(e={})=>new Se("getPeersStateChange",{detail:e}),be=(e={})=>new Se("peerConnectionState",{detail:e}),Le=(e={})=>new Se("getConnectionStatusStateChange",{detail:e}),Ge=(e={})=>new Se("mediaAccessFallback",{detail:e}),Ue=(e={})=>new Se("rtmpState",{detail:e}),Fe=(e={})=>new Se("mediaAccessError",{detail:e});const Be={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error",CREATE_ERROR:"createError",BUFFERED_AMOUNT_LOW:"bufferedAmountLow",SEND_MESSAGE_ERROR:"sendMessageError"},xe={MESSAGING:"messaging",DATA:"data"},He={PROTOCOL:"protocol",CHUNK:"chunk"},Ve={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob",STRING:"string"},je={UPLOAD:"upload",DOWNLOAD:"download"},$e={BLOB:"blob",DATA:"data"},We={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted",USER_REJECTED:"userRejected",USER_UPLOAD_REQUEST:"userRequest"},Ke={REJECT:-1,ACCEPT:0,CANCEL:0},ze={REQUEST:"request",SUCCESS:"success",ERROR:"error"},Ye={NEW:"new",GATHERING:"gathering",COMPLETED:"complete"},Je={RECEIVED:"received",DROPPED:"dropped",BUFFERED:"buffered",PROCESSING:"processing",PROCESS_SUCCESS:"processSuccess",PROCESS_ERROR:"processError"},Qe={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},qe={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},Xe={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed",CONNECTING:"connecting",FAILED:"failed",DISCONNECTED:"disconnected",CONNECTED:"connected"},Ze={RETRIEVING:0,RETRIEVE_SUCCESS:1,RETRIEVE_ERROR:-1},et={MAX_COMPAT:"max-compat",BALANCED:"balanced",MAX_BUNDLE:"max-bundle",NONE:"none"},tt={REQUIRE:"require",NEGOTIATE:"negotiate"},rt={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",ERROR:"error"},nt={ENQUIRED:"enquired",DISPATCHED:"dispatched",RECEIVED:"received"},st={WARNING:"warning",REJECT:"reject",LOCKED:"locked"},it={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},ot={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,API_OVER_SEAT_LIMIT:4020,API_RETRIEVAL_FAILED:4021,API_WRONG_ACCESS_DOMAIN:5005,XML_HTTP_REQUEST_ERROR:-1,XML_HTTP_NO_REPONSE_ERROR:-2,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,ADAPTER_NO_LOADED:7,PARSE_CODECS:8},at={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},ct={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},dt={AUTO:"auto",VP8:"VP8",H264:"H264",VP9:"VP9"},lt={AUTO:"auto",ISAC:"ISAC",OPUS:"opus",ILBC:"ILBC",G722:"G722",PCMU:"PCMU",PCMA:"PCMA"},Et={QQVGA:{width:160,height:120},HQVGA:{width:240,height:160},QVGA:{width:320,height:240},WQVGA:{width:384,height:240},HVGA:{width:480,height:320},VGA:{width:640,height:480},WVGA:{width:768,height:480},FWVGA:{width:854,height:480},SVGA:{width:800,height:600},DVGA:{width:960,height:640},WSVGA:{width:1024,height:576},HD:{width:1280,height:720},HDPLUS:{width:1600,height:900},FHD:{width:1920,height:1080},QHD:{width:2560,height:1440},WQXGAPLUS:{width:3200,height:1800},UHD:{width:3840,height:2160},UHDPLUS:{width:5120,height:2880},FUHD:{width:7680,height:4320},QUHD:{width:15360,height:8640}},St={FALLBACKING:0,FALLBACKED:1,ERROR:-1},pt={START:0,STOP:1,LINK:2,ERROR:-1},ut={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},Rt={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach",START_RECORDING:"startRecordingRoom",STOP_RECORDING:"stopRecordingRoom",RECORDING:"recordingEvent",END_OF_CANDIDATES:"endOfCandidates",START_SCREENSHARE:"startScreenshare",START_RTMP:"startRTMP",STOP_RTMP:"stopRTMP",RTMP:"rtmpEvent",MEDIA_INFO_EVENT:"mediaInfoEvent",MESSAGE:"message",GET_STORED_MESSAGES:"getStoredMessages",STORED_MESSAGES:"storedMessages",RESTART:"restart"},ht={ENDED:"ended"},mt=[Rt.STREAM,Rt.UPDATE_USER,Rt.PUBLIC_MESSAGE],gt={PLAN_B:"plan-b",UNIFIED:"unified-plan"},ft={START:0,STOP:1,ERROR:-1},Tt={MUTED:0,ACTIVE:1,UNAVAILABLE:-1},_t={SKYLINK_EVENT:"SKYLINK EVENT",SKYLINK_ERROR:"SKYLINK ERROR",STATS_MODULE:"RTCStatsReport",SESSION_DESCRIPTION:"RTCSessionDescription",PEER_CONNECTION:"RTCPeerConnection",CANDIDATE_HANDLER:"RTCIceCandidate",DATA_CHANNEL:"RTCDataChannel",SIG_SERVER:"SIG SERVER",PEER_MEDIA:"PEER MEDIA",PEER_INFORMATION:"PEER INFORMATION",ROOM:"ROOM",RECORDING:"RECORDING",MEDIA_STREAM:"MEDIA STREAM",MESSAGING:"MESSAGING",ASYNC_MESSAGING:"ASYNC MESSAGING",ENCRYPTED_MESSAGING:"ENCRYPTED MESSAGING",STATS:"STATS",NEGOTIATION:"NEGOTIATION"},At={AUDIO_MIC:"audioMic",VIDEO_CAMERA:"videoCamera",VIDEO_SCREEN:"videoScreen",VIDEO_OTHER:"videoOther",AUDIO:"audio",VIDEO:"video"},It={LIVE:"live",ENDED:"ended"},Ct={AUDIO:"audio",VIDEO:"video"},Ot={MUTED:"muted",ACTIVE:"active",STOPPED:"stopped",UNAVAILABLE:"unavailable"},Nt={PUBLISHER_ID:"publisherId",MEDIA_ID:"mediaId",MEDIA_TYPE:"mediaType",MEDIA_STATE:"mediaState",TRANSCEIVER_MID:"transceiverMid",MEDIA_META_DATA:"mediaMetaData",SIMULCAST:"simulcast",STREAM_ID:"streamId"},Dt="2.6.2",vt={WEB:"Web SDK",ANDROID:"Android SDK",IOS:"iOS SDK",CPP:"C++ SDK"},yt={CHROME:"chrome",FIREFOX:"firefox",SAFARI:"safari",REACT_NATIVE:"react-native"},Pt={MCU:"MCU",REC_SRV:"REC_SRV"},Mt={CONNECT:"connect",DISCONNECT:"disconnect",RECONNECT_ATTEMPT:"reconnect_attempt",RECONNECT_SUCCESS:"reconnect_success",RECONNECT_FAILED:"reconnect_failed",RECONNECT_ERROR:"reconnect_error",MESSAGE:"message",ERROR:"error"},kt={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"},wt={SIGNALING:Mt},bt={PEER_CONNECTION:"PEER_CONNECTION",SOCKET:"SOCKET"},Lt={ENTERING:"entering",WELCOMING:"welcoming",LOCAL_OFFER_SENT:"localOfferSent",LOCAL_OFFER_SET:" localOfferSet",REMOTE_OFFER_RECEIVED:"remoteOfferReceived",REMOTE_ANSWER_RECEIVED:"remoteAnswerReceived",REMOTE_OFFER_SET:"remoteOfferSet",LOCAL_ANSWER_SET:"localAnswerSet",REMOTE_ANSWER_SET:"remoteAnswerSet",NEGOTIATED:"negotiated"},Gt=Ee;var Ut=Object.freeze({__proto__:null,DATA_CHANNEL_STATE:Be,DATA_CHANNEL_TYPE:xe,DATA_CHANNEL_MESSAGE_TYPE:He,DATA_CHANNEL_MESSAGE_ERROR:{MESSAGE:"message",TRANSFER:"transfer"},DATA_TRANSFER_DATA_TYPE:Ve,DT_PROTOCOL_VERSION:"0.1.3",DATA_TRANSFER_DIRECTION:je,DATA_TRANSFER_SESSION_TYPE:$e,SESSION_CHUNK_TYPE:{STRING:"string",BINARY:"binary"},DATA_TRANSFER_STATE:We,ACK_PROTOCOL_NUMBER:Ke,AUTH_STATE:ze,DATA_STREAM_STATE:{SENDING_STARTED:"sendStart",SENDING_STOPPED:"sendStop",RECEIVING_STARTED:"receiveStart",RECEIVING_STOPPED:"receiveStop",RECEIVED:"received",SENT:"sent",ERROR:"error",START_ERROR:"startError"},CANDIDATE_GENERATION_STATE:Ye,CANDIDATE_PROCESSING_STATE:Je,ICE_CONNECTION_STATE:Qe,TURN_TRANSPORT:qe,PEER_CONNECTION_STATE:Xe,GET_CONNECTION_STATUS_STATE:Ze,BUNDLE_POLICY:et,RTCP_MUX_POLICY:tt,PEER_CERTIFICATE:{RSA:"RSA",ECDSA:"ECDSA",AUTO:"AUTO"},HANDSHAKE_PROGRESS:rt,GET_PEERS_STATE:nt,INTRODUCE_STATE:{INTRODUCING:"introducing",ERROR:"error"},SYSTEM_ACTION:st,SYSTEM_ACTION_REASON:{CREDENTIALS_EXPIRED:"oldTimeStamp",CREDENTIALS_ERROR:"credentialError",DUPLICATED_LOGIN:"duplicatedLogin",ROOM_NOT_STARTED:"notStart",EXPIRED:"expired",ROOM_LOCKED:"locked",FAST_MESSAGE:"fastmsg",ROOM_CLOSING:"toclose",ROOM_CLOSED:"roomclose",SERVER_ERROR:"serverError",KEY_ERROR:"keyFailed"},READY_STATE_CHANGE:it,READY_STATE_CHANGE_ERROR:ot,REGIONAL_SERVER:{APAC1:"",US1:""},LOG_LEVEL:{DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0,NONE:-1},SOCKET_ERROR:at,SOCKET_FALLBACK:ct,SM_PROTOCOL_VERSION:"2.1.0",VIDEO_CODEC:dt,AUDIO_CODEC:lt,MEDIA_SOURCE:{SCREEN:"screen",WINDOW:"window",TAB:"tab",TAB_AUDIO:"audio",APPLICATION:"application",BROWSER:"browser",CAMERA:"camera"},VIDEO_RESOLUTION:Et,MEDIA_ACCESS_FALLBACK_STATE:St,RECORDING_STATE:pt,CHUNK_FILE_SIZE:49152,MOZ_CHUNK_FILE_SIZE:12288,BINARY_FILE_SIZE:65456,MOZ_BINARY_FILE_SIZE:16384,CHUNK_DATAURL_SIZE:1212,DC_PROTOCOL_TYPE:ut,SIG_MESSAGE_TYPE:Rt,STREAM_STATUS:ht,GROUP_MESSAGE_LIST:mt,VIDEO_QUALITY:{HD:{video:3200,audio:150},HQ:{video:1200,audio:80},SQ:{video:800,audio:30},LQ:{video:400,audio:20}},SDP_SEMANTICS:gt,RTMP_STATE:ft,MEDIA_STATUS:Tt,TAGS:_t,MEDIA_TYPE:At,TRACK_READY_STATE:It,TRACK_KIND:Ct,MEDIA_STATE:Ot,MEDIA_INFO:Nt,SDK_VERSION:Dt,SDK_NAME:vt,API_VERSION:"9.0.0",SIGNALING_VERSION:"sig-v2",BROWSER_AGENT:yt,PEER_TYPE:Pt,SOCKET_EVENTS:Mt,SOCKET_TYPE:kt,STATES:wt,CONFIG_NAME:bt,NEGOTIATION_STATES:Lt,EVENTS:Gt});const Ft={INIT:{ERRORS:{NO_ADAPTER:"AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used",NO_SOCKET_IO:"Socket.io not loaded - Please load socket.io",NO_FETCH_SUPPORT:"Fetch API is not supported in your browser. Please make sure you are using a modern browser: https://caniuse.com/#search=fetch",NO_APP_KEY:"Please provide an App Key - Get one at console.temasys.io!",AUTH_CORS:"Promise rejected due to CORS forbidden request - Please visit: https://support.temasys.com.sg/support/solutions/articles/12000006761-i-get-a-403-forbidden-access-is-denied-when-i-load-the-application-why-",AUTH_GENERAL:"Promise rejected due to authentication issue",SOCKET_CREATE_FAILED:"Failed creating socket connection object ->",SOCKET_ERROR_ABORT:"Reconnection aborted as the connection timed out or there no more available ports, transports and final attempts left"},INCOMPATIBLE_BROWSER:"Incompatible browser agent detected",INFO:{API_SUCCESS:"Promise resolved: APP Authenticated Successfully!"}},SOCKET:{ABORT_RECONNECT:"Aborting socket reconnect"},JOIN_ROOM:{ERRORS:{CODEC_SUPPORT:"No audio/video codecs available to start connection"},AUTO_BANDWIDTH_DEPRECATED:"autoBandwidthAdjustment option in joinRoom method has been deprecated"},ROOM:{ERRORS:{STOP:{SCREEN_SHARE:"Error stopping screenshare"},NOT_IN_ROOM:"User is not in room",NO_PEERS:"No peers in room"},LEAVE_ROOM:{ERROR:"Leave room error --\x3e",NO_PEERS:"No peers in room",DROPPING_HANGUP:"Dropping hang-up from remote peer",DROPPING_DUPLICATE_BYE:"Dropping duplicate bye",LEAVE_ALL_ROOMS:{SUCCESS:"Successfully left all rooms",ERROR:"Leave all rooms error --\x3e"},PEER_LEFT:{START:"Initiating peer left process",SUCCESS:"Successfully completed peer left process",ERROR:"Failed peer left process"},SENDING_BYE:"Sending bye message to all peers",DISCONNECT_SOCKET:{SUCCESS:"Successfully disconnected socket"},REMOVE_STATE:{SUCCESS:"Successfully removed room state"}}},ROOM_STATE:{NOT_FOUND:"Could not retrieve room state for room name/key",LEFT:"Peer left room",NO_ROOM_NAME:"No room name specified"},PEER_INFORMATIONS:{NO_PEER_INFO:"Not able to retrieve Peer Information for peerId:",UPDATE_USER_DATA:"Peer updated userData: ",OUTDATED_MSG:"Dropping outdated status ->",USER_DATA_NOT_JSON:"UserData is not JSON",SET_PEER_PRIORITY_WEIGHT:"Setting peerPriorityWeight with tiebreaker value from inRoom signalling message"},PEER_CONNECTION:{NOT_INITIALISED:"Peer Connection not initialised",CREATE_NEW:"Creating new Peer Connection",NO_PEER_CONNECTION:"No Peer Connection detected",PEER_CONNECTION_CLOSED:"Peer Connection is closed",PEER_ID_NOT_FOUND:"Peer Id not found",STATE_CHANGE:"Peer connection state changed ->",STATS_API_UNAVAILABLE:"getStats() API is not available",MCU:"MCU connected",FAILED_STATE:"Peer Connection state: failed",ADD_TRANSCEIVER:"Adding empty transceiver",SDP_ERROR:"Sdp error",ERRORS:{REMOVE_TRACK:"Error removing track from peer connection",NOT_FOUND:"Peer Connection not found",NOT_STABLE:"Peer Connection is not stable"},REFRESH_CONNECTION:{START:"Refreshing peer connections",SUCCESS:"Peer Connection refreshed successfully",FAILED:"Peer Connection failed to refresh",COMPLETED:"All Peer Connections refreshed with resolve or errors",RESTART_ICE_UNAVAILABLE:"Dropping iceRestart option as it is not available on the peer connection",NOT_SUPPORTED:"Refresh connection not supported by browser",SEND_RESTART_OFFER:"Sending restart offer message to signaling server",NO_LOCAL_DESCRIPTION:"No localDescription set to connection. There could be a handshaking step error."}},PEER_PRIVILEGED:{not_privileged:"Please upgrade your key to privileged to use this function",no_appkey:"App key is not defined - Please authenticate again",getPeerListFromServer:"Enquired server for peers within the App space"},ICE_CONNECTION:{END_OF_CANDIDATES_SUCCESS:"Signaling of end-of-candidates remote ICE gathering",END_OF_CANDIDATES_FAILURE:"Failed signaling of end-of-candidates remote ICE gathering",ICE_GATHERING_STARTED:"ICE gathering has started",ICE_GATHERING_COMPLETED:"ICE gathering has completed",DROP_EOC:"Dropping of sending ICE candidate end-of-candidates signal or unused ICE candidates ->",STATE_CHANGE:"Ice connection state changed ->",TURN_NOT_ENABLED:"TURN is not enabled but forceTURN init options is enforced"},ICE_CANDIDATE:{DROPPING_CANDIDATE:"Dropping ICE candidate",INVALID_CANDIDATE:"Received invalid ICE candidate message ->",VALID_CANDIDATE:"Received ICE candidate ->",FILTERED_CANDIDATE:"Dropping received ICE candidate as it matches ICE candidate filtering flag ->",FILTERING_FLAG_NOT_HONOURED:"Not dropping received ICE candidate even though TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->",CANDIDATE_ADDED:"Added ICE candidate successfully",ADDING_CANDIDATE:"Adding ICE Candidate",FAILED_ADDING_CANDIDATE:"Failed adding ICE candidate ->",ADD_BUFFERED_CANDIDATE:"Adding buffered ICE candidate",ADD_CANDIDATE_TO_BUFFER:"Adding ICE candidate to buffer",CANDIDATE_GENERATED:"Generated ICE candidate ->",SENDING_CANDIDATE:"Sending ICE candidate ->",NO_SDP_MID:"No mid for the candidate in sdp"},SESSION_DESCRIPTION:{parsing_media_ssrc:"Parsing session description media SSRCs ->",NO_REMOTE_DESCRIPTION:"No remote description"},DATA_CHANNEL:{NO_DATA_CHANNEL_CONNECTION:"No Data Channel connection",DATA_CHANNEL_NOT_OPEN:"Data Channel connection is not open",DATA_CHANNEL_DISABLED:"Data Channel is disabled",CLOSING:"Closing Data Channel",NO_REMOTE_DATA_CHANNEL:"Remote peer does not have Data Channel",RECEIVED_CHUNK:"Received binary string data chunk",reviving_dataChannel:"Reviving Datachannel connection",refresh_error:"Not a valid Datachannel connection",closed:"Datachannel has closed",onclose_error:"Error in data-channel onclose callback",DATA_TRANSFER_UPLOAD_TERMINATED:"Data upload terminated",DATA_TRANSFER_DOWNLOAD_TERMINATED:"Data download terminated",DATA_TRANSFER_CANCEL_TERMINATED:"Cancel data transfer terminated",IGNORE_TIMEOUT:"Ignoring data transfer timeout",CLEAR_TIMEOUT:"Clearing data transfer timeout",SET_TIMEOUT:"Setting data transfer timeout",DATA_TRANSFER_COMPLETED:"Data transfer completed",UNABLE_TO_SEND_BLOB:"Unable to send Blob data",DATA_TRANSFER_ERROR:"Data transfer error",CANCEL_DATA_TRANSFER:"Peer cancelled data transfer",RECEIVED_P2P_MESSAGE:"Received P2P message",DATA_TRANSFER_STATE:"Data transfer state",CHUNKING_BLOB:"Chunking Blob data",ERRORS:{PEER_ID_INVALID_TYPE:"Peer ID is not type array string or string",TIMEOUT_INVALID_TYPE:"Timeout is not type number",REMOTE_REJECTED_TRANSFER:"Remote peer rejected data transfer request",USER_REJECTED_TRANSFER:"User rejected data transfer request",REMOTE_CANCELLED_TRANSFER:"Remote peer cancelled data transfer",USER_CANCELLED_TRANSFER:"User cancelled data transfer",NOT_BLOB:"Data is not type Blob",INVALID_DATA:"Invalid data",FAILED_CLOSING:"Failed closing Data Channels",NO_SESSIONS:"Peer Connection does not have Data Channel sessions",DROP_SENDING_MESSAGE:"Drop sending message",FAILED_SENDING_MESSAGE:"Failed sending message",FAILED_PARSING_PROTOCOL:"Failed parsing protocol data",DISCARDING_DATA_CHUNK:"Discarding data chunk",CHUNK_ADDED:"Data chunk has been added",CANCEL_TRANSFER:"Received cancel data transfer from peer",RECEIVED_ERROR:"Received error from peer",DATA_TRANSFER_TIMEOUT:"Data transfer connection timed out",NO_DATA_TRANSFER_SESSION:"No data transfer sessions",NO_TRANSFER_ID:"No Transfer ID",NO_PEER_ID:"No Peer ID",DATA_TRANSFER_IN_PROGRESS:"Data Channel has a transfer in progress",MCU_NOT_SUPPORTED:"MCU does not support sendBlobData"}},NEGOTIATION_PROGRESS:{SET_LOCAL_DESCRIPTION:"Successfully set local description --\x3e",SET_REMOTE_DESCRIPTION:"Successfully set remote description --\x3e",APPLYING_BUFFERED_REMOTE_OFFER:"Applying buffered remote offer",BUFFERING_RESTART:"Buffering restart offer until 'negotiated' state is reached",APPLY_BUFFERED_RESTART:"Applying buffered restart offer now that 'negotiated' state is reached",RESET_SET_REMOTE_DESCRIPTION_SUCCESS:"Resetting setRemoteDescriptionSuccess flag",ERRORS:{FAILED_SET_LOCAL_DESCRIPTION:"Failed setting local description --\x3e",FAILED_SET_REMOTE_DESCRIPTION:"Failed setting remote description --\x3e",FAILED_SET_REMOTE_ANSWER:"Remote Peer failed to set answer.",FAILED_PROCESSING_OFFER:"Failed processing OFFER ->",FAILED_PROCESSING_ANSWER:"Failed processing ANSWER ->",FAILED_PROCESSING_ANSWER_ACK:"Failed processing ANSWER_ACK ->",FAILED_RENEGOTIATION:"Failed renegotiation after answerAck",OFFER_TIEBREAKER:"Dropping the received offer: self weight is greater than incoming offer weight --\x3e",NO_LOCAL_BUFFERED_OFFER:"FATAL: No buffered local offer found - Unable to setLocalDescription",ADDING_REMOTE_OFFER_TO_BUFFER:"Adding remote offer received to buffer as current negotiation has not completed",STOP_RENEGOTIATION_FORCE_TURN:"Stopping renegotiation as TURN is not enabled but forceTURN in init options is enforced",DROPPING_ANSWER:"Dropping ANSWER as previous negotiation state is not 'LOCAL_OFFER_SENT'",DROPPING_ANSWER_ACK:"Dropping ANSWER_ACK as previous negotiation state is not 'LOCAL_ANSWER_SET'",DROPPING_WELCOME_NEG_STATE:"Dropping WELCOME as previous negotiation state is not 'undefined'",DROPPING_WELCOME_MCU_FORWARDED:"Dropping extra WELCOME from remote peer in MCU room"}},SIGNALING:{MESSAGE_ADDED_TO_BUFFER:"Message buffered as enter message has not been sent",ENTER_LISTENER:"Enter listener initialized",BUFFERED_MESSAGES_SENT:"Buffered messages sent",BUFFERED_MESSAGES_DROPPED:"Buffered messages dropped - no mid",OUTDATED_MSG:"Dropping outdated status ->",DROPPING_MUTE_EVENT:"Dropping mute audio / video event message as it is processed by mediaInfoEvent",BUFFER_NOT_NEEDED:"Enter message sent. Messages do not need to be buffered",ABORTING_OFFER:"Aborting offer as current negotiation has not completed",DROPPING_ENTER:"Dropping enter message as inRoom message has not been received"},MESSAGING:{PRIVATE_MESSAGE:"Sending private message to Peer",BROADCAST_MESSAGE:"Broadcasting message to Peers",RECEIVED_MESSAGE:"Received message from Peer",PERSISTENCE:{SEND_MESSAGE:"Sending persisted message",NOT_PERSISTED:"Message will not be persisted as persistent flag is set to false",STORED_MESSAGES:"Received stored messages for room",IS_PERSISTENT_CONFIG:"Persistent message flag is set to",ERRORS:{FAILED_SETTING_PERSISTENCE:"Failed setting persistent message flag",INVALID_TYPE:"Persistent message flag must be of type boolean",PRIVATE_MESSAGE:"Cannot persist private messages",PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED:"Persistent Message feature is not enabled. Enable this feature on the key under 'Advanced Settings' in the Temasys Console"}},ENCRYPTION:{SEND_MESSAGE:"Sending encrypted message",DELETE_ALL:"Deleting all stored secrets",ERRORS:{FAILED_DECRYPTING_MESSAGE:"Failed decrypting message",ENCRYPT_SECRET:"Incorrect secret provided",INVALID_SECRETS:"No or invalid secret and secret id provided",SET_SELECTED_SECRET:"Failed setting selected secret",DELETE_ENCRYPT_SECRETS:"Failed deleting secret",SET_ENCRYPT_SECRET:"Failed setting secret",SECRET_ID_NOT_FOUND:"Secret id not found",NO_SECRET_OR_SECRET_ID:"Secret and / or secret id not provided",INVALID_TYPE:"Secret and secret id must be of type string and not empty",SECRET_ID_NOT_UNIQUE:"Secret id provided is not unique",SECRET_ID_NOT_SELECTED:"Secret id not selected",SECRET_ID_NOT_PROVIDED:"Secret id not provided",SECRETS_NOT_PROVIDED:"Secrets not provided"}},ERRORS:{DROPPING_MESSAGE:"Dropping message",FAILED_SENDING_MESSAGE:"Failed to send user message"}},MEDIA_INFO:{UPDATE_SUCCESS:"Successfully updated media info",ERRORS:{NO_ASSOCIATED_STREAM_ID:"There is no streamId associated with the mediaId and transceiverMid pair",FAILED_PROCESSING_MEDIA_INFO_EVENT:"Failed to process mediaInfoEvent message",FAILED_UPDATING:"Failed to update media info",FAILED_PROCESSING_PEER_MEDIA:"Failed to process media info",FAILED_UPDATING_TRANSCEIVER_MID:"Failed updating media info transceiverMid after setLocalDescription",FAILED_SETTING_PEER_MEDIA_INFO:"Failed setting peer media at offer / answer",STREAM_ID_NOT_MATCHED:"There is no mediaInfo associated with the streamId"},WARN:{READ_ONLY_VALUE:"Attempting to change media info read only value: ",INVALID_MEDIA_TYPE:"Invalid media info media type: "},VIDEO_STATE_CHANGE:"Peers's video state changed to ->",AUDIO_STATE_CHANGE:"Peers's audio state changed to ->",VIDEO_SCREEN_STATE_CHANGE:"Peers's video screen state changed to ->"},MEDIA_STREAM:{STOP_SETTINGS:"Stopped streams with settings:",STOP_SUCCESS:"Successfully stopped stream",REMOTE_TRACK_REMOVED:"Remote MediaStreamTrack removed",START_FALLBACK:"Fall back to retrieve audio only stream",NO_OPTIONS:"No user media options provided",DEFAULT_OPTIONS:"Using default options",FALLBACK_SUCCESS:"Successfully retrieved audio fallback stream",START_SCREEN_SUCCESS:"Successfully retrieved screen share stream",STOP_SCREEN_SUCCESS:"Successfully stopped screen share stream",UPDATE_MUTED_SETTINGS:"Updated stream muted setting",UPDATE_MEDIA_STATUS:"Updated stream media status",AUDIO_MUTED:"Peers's audio muted: ",VIDEO_MUTED:"Peers's video muted: ",ERRORS:{STOP_SCREEN:"Error stopping screen share stream",START_SCREEN:"Error starting screen share stream",STOP_ADDED_STREAM:"Error stopping added stream",STOP_USER_MEDIA:"Error stopping user media",STOP_AUDIO_TRACK:"Error stopping audio tracks in stream",STOP_VIDEO_TRACK:"Error stopping video tracks in stream",STOP_MEDIA_TRACK:"Error stopping MediaTrack",STOP_SCREEN_TRACK:"Error stopping screen track in stream",DROPPING_ONREMOVETRACK:"Dropping onremovetrack",NO_STREAM:"No stream to process",INVALID_STREAM_ID:"No stream detected with stream id",NO_USER_MEDIA_STREAMS:"No user media streams detected",INVALID_STREAM_ID_TYPE:"Stream id is not a string",NO_STREAM_ID:"No stream id provided",PEER_SCREEN_ACTIVE:"Peer has existing screen share",FALLBACK:"Error retrieving fallback audio stream",INVALID_GUM_OPTIONS:"Invalid user media options",INVALID_GDM_OPTIONS:"Invalid display media options",GET_USER_MEDIA:"Error retrieving stream from 'getUserMedia' method",INVALID_MUTE_OPTIONS:"Invalid muteStreams options provided",NO_STREAMS_MUTED:"No streams to mute",SEND_STREAM:"Error sending stream",INVALID_MEDIA_STREAM_ARRAY:"Array is not of type MediaStream",INACTIVE_MEDIA_STREAM:"One or more media streams is inactive",ACTIVE_STREAMS:"There are currently active streams being sent to remote peers. Please stop streams.",INVALID_PREFETCHED_STREAMS:"Invalid prefetched streams provided"}},STATS_MODULE:{NOT_INITIATED:"Stats Module is not initiated",STATS_DISCARDED:"Stats report discarded as peer has left the room",ERRORS:{RETRIEVE_STATS_FAILED:"Failed retrieving stats",POST_FAILED:"Failed posting to stats api",PARSE_FAILED:"Failed parsing stats report",STATS_IS_NULL:"Stats object is null",INVALID_TRACK_KIND:"Media kind is not audio or video"},HANDLE_ICE_GATHERING_STATS:{PROCESS_FAILED:"process_failed",PROCESS_SUCCESS:"process_success",PROCESSING:"processing",DROPPED:"dropped",BUFFERED:"buffered"},HANDLE_NEGOTIATION_STATS:{WELCOME:{dropped:"dropped_welcome"},OFFER:{create:"create_offer",create_error:"error_create_offer",set:"set_offer",set_error:"error_set_offer",offer:"offer",dropped:"dropped_offer",error:"error_offer"},ANSWER:{create:"create_answer",create_error:"error_create_answer",set:"set_answer",set_error:"error_set_ANSWER",answer:"answer",dropped:"dropped_answer",error:"error_answer"},ANSWERACK:{error:"error_answer_ack"}},HANDLE_DATA_CHANNEL_STATS:{open:"open",closed:"closed",reconnecting:"reconnecting"},HANDLE_CONNECTION_STATS:{},HANDLE_BANDWIDTH_STATS:{RETRIEVE_FAILED:"Failed posting bandwidth stats: ",NO_STATE:"No room state"},HANDLE_ICE_CONNECTION_STATS:{RETRIEVE_FAILED:"Failed retrieving stats: ",SEND_FAILED:"Failed sending ice connection stats: "},HANDLE_RECORDING_STATS:{START:"start",STOP:"stop",REQUEST_START:"request-start",REQUEST_STOP:"request-stop",ERROR_NO_MCU_START:"error-no-mcu-start",ERROR_NO_MCU_STOP:"error-no-mcu-stop",ERROR_START_ACTIVE:"error-start-when-active",ERROR_STOP_ACTIVE:"error-stop-when-active",ERROR_MIN_STOP:"error-min-stop",MCU_RECORDING_ERROR:"mcu-recording-error",REC_SERVER_UNAVAILABLE:"rec-server-unavailable"}},RECORDING:{AVAILABLE:"Recording server is available to start a recording",UNAVAILABLE:"Recording server is unavailable to start a recording",START_SUCCESS:"Started recording",STOP_SUCCESS:"Stopped recording",START_FAILED:"Failed to start recording",STOP_FAILED:"Failed to stop recording",MIN_RECORDING_TIME_REACHED:"4 seconds has been recorded - Recording can be stopped now",ERRORS:{MCU_NOT_CONNECTED:"MCU is not connected",EXISTING_RECORDING_IN_PROGRESS:"There is an existing recording in-progress",NO_RECORDING_IN_PROGRESS:"There is no existing recording in-progress",MIN_RECORDING_TIME:"4 seconds has not been recorded yet",STOP_ABRUPT:"Recording stopped abruptly before 4 seconds",SESSION_EMPTY:'Received request of "off" but the session is empty',REC_SERVER_UNAVAILABLE:"Recording server is unavailable to start a recording - retry later",MCU_RECORDING_ERROR:"Recording error received from MCU ->"}},RTMP:{start_no_mcu:"Unable to start RTMP session as MCU is not connected",stop_no_mcu:"Unable to stop RTMP as MCU is not connected",start_no_stream_id:"Unable to start RTMP Session stream id is missing",start_no_endpoint:"Unable to start RTMP Session as Endpoint is missing",starting_rtmp:"Starting RTMP Session",stopping_rtmp:"Stopping RTMP Session",message_received_from_sig:"Received RTMP Session message ->",stop_session_empty:'Received request of "off" but the session is empty',stopped_success:"Stopped RTMP Session",started_success:"Started RTMP Session",error_session_empty:"Received error but the session is empty ->",error_session:"RTMP session failure ->",error_Session_abrupt:"Stopped RTMP session abruptly"},PERSISTENT_MESSAGE:{ERRORS:{NO_DEPENDENCY:"CryptoJS is not available"}},UTILS:{INVALID_BROWSER_AGENT:"Invalid browser agent",CONFIG_NOT_FOUND:"Config not found"},LOGGER:{EVENT_DISPATCHED:"Event dispatched",EVENT_REGISTERED:"Event successfully registered",EVENT_UNREGISTERED:"Event successfully unregistered",EVENT_DISPATCH_ERROR:"Error dispatching event",EVENT_REGISTER_ERROR:"Error registering event",EVENT_UNREGISTER_ERROR:"Error unregistering event",LOGS_NOT_STORED:"Store logs feature is not enabled. Enable it via SkylinkLogger.setLevel(logLevel, storeLogs)",LOGS_CLEARED:"Stored logs cleared",INVALID_CB:"Dropping listener as it is not a function"},BROWSER_AGENT:{REACT_NATIVE:{ERRORS:{DROPPING_ONREMOVETRACK:"Dropping onremovetrack as trackInfo is malformed"}}}};const Bt=new class{constructor(){this.events={},this.privateEvents={};}addPrivateEventListener(e,t){this.addListener(e,t,!0);}addEventListener(e,t){this.addListener(e,t,!1);}addListener(e,t,r){try{const n=r?"privateEvents":"events";if(!Bi(t))return void zt.log.DEBUG([null,_t.SKYLINK_EVENT,e,Ft.LOGGER.INVALID_CB]);this[n][e]||(this[n][e]={}),this[n][e].callbacks||(this[n][e].callbacks=[]),this[n][e].callbacks.push(t),r||zt.log.DEBUG([null,_t.SKYLINK_EVENT,e,Ft.LOGGER.EVENT_REGISTERED]);}catch(t){zt.log.ERROR([null,_t.SKYLINK_EVENT,e,Ft.LOGGER.EVENT_REGISTER_ERROR],t);}}dispatchEvent(e){if(e.name===Gt.LOGGED_ON_CONSOLE)return;let t=[];if(this.events[e.name]){const r=this.events[e.name].callbacks;t=t.concat(r);}else zt.log.DEBUG([null,_t.SKYLINK_EVENT,e.name,Ft.LOGGER.EVENT_DISPATCHED]);if(this.privateEvents[e.name]){const r=this.privateEvents[e.name]?this.privateEvents[e.name].callbacks:[];t=t.concat(r);}t.forEach((t=>{try{t(e.detail);}catch(t){zt.log.ERROR([null,_t.SKYLINK_EVENT,e.name,Ft.LOGGER.EVENT_DISPATCH_ERROR],t);}}));}removeEventListener(e,t){this.removeListener(e,t,!1);}removePrivateEventListener(e,t){this.removeListener(e,t,!0);}removeListener(e,t,r){const n=r?"privateEvents":"events";if(r||this.events[e]&&this.events[e].callbacks)try{this[n][e].callbacks.forEach(((s,i)=>{s===t&&(delete this[n][e].callbacks[i],r||zt.log.DEBUG([null,_t.SKYLINK_EVENT,e,Ft.LOGGER.EVENT_UNREGISTERED]));}));}catch(t){zt.log.ERROR([null,_t.SKYLINK_EVENT,e,Ft.LOGGER.EVENT_DISPATCH_ERROR],t);}else zt.log.WARN([null,_t.SKYLINK_EVENT,e,Ft.LOGGER.EVENT_UNREGISTERED]);}},xt=Bt.addPrivateEventListener.bind(Bt),Ht=Bt.removePrivateEventListener.bind(Bt),Vt=Bt.dispatchEvent.bind(Bt),jt=["trace","debug","info","warn","error"],$t=e=>{let t=!0;return ("undefined"==typeof console||void 0===console[e])&&(t=!1),t},Wt=(e,t,r,n=null)=>{const s=`[${(new Date).toISOString()}]`,i=e.level,{logLevels:o}=e;if(i<=t&&i!==o.SILENT){const e=jt[t];if(!$t(e))return;const i=(e=>{let t="SkylinkJS -";if(Array.isArray(e)){const[r,n,s,i]=e;if(t+=r?` [${r}]`:" -",t+=n?` <<${n}>>`:r?"":" <<Method>>",s)if(Array.isArray(s))for(let e=0;e<s.length;e+=1)t+=` (${s[e]})`;else t+=` (${s})`;t+=` ${i}`;}else t+=` ${e}`;return t})(r);if($t(e)&&(console[e](s,i,n||""),Vt(((e={})=>new Se("loggedOnConsole",{detail:e}))({level:e,message:i,debugObject:n}))),zt.storeLogs){const t=[s,e.toUpperCase(),i];n&&t.push(n),zt.storedLogs.push(t);}}};class Kt{constructor(){this.logLevels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},this.level=(e=>{try{const t=window.localStorage.getItem("loglevel:skylinkjs");return null===t||Number.isNaN(+t)?e.ERROR:+t}catch(t){return e.ERROR}})(this.logLevels),this.storeLogs=!1,this.storedLogs=[];}setLevel(e=this.levels.ERROR,t){Fi(e)?(this.level=e,(e=>{try{window.localStorage.setItem("loglevel:skylinkjs",e);}catch(e){console.warn("[ENVIRONMENT] window.localStorage is unavailable. Defaulting to log level: Error");}})(this.level)):this.level=this.levels.ERROR,t&&(this.storeLogs=t);}enableAll(){this.setLevel(this.logLevels.TRACE);}disableAll(){this.setLevel(this.logLevels.SILENT);}getLogs(){return this.storeLogs?this.storedLogs:(this.log.WARN(Ft.LOGGER.LOGS_NOT_STORED),null)}clearLogs(){this.log.INFO(Ft.LOGGER.LOGS_CLEARED),this.storedLogs=[];}}const zt=new Kt;Kt.prototype.log={TRACE:(...e)=>{Wt(zt,zt.logLevels.TRACE,...e);},DEBUG:(...e)=>{Wt(zt,zt.logLevels.DEBUG,...e);},INFO:(...e)=>{Wt(zt,zt.logLevels.INFO,...e);},WARN:(...e)=>{Wt(zt,zt.logLevels.WARN,...e);},ERROR:(...e)=>{Wt(zt,zt.logLevels.ERROR,...e);}};var Yt=O((function(e){var t=function(){function e(e,t){return null!=t&&e instanceof t}var t,r,n;try{t=Map;}catch(e){t=function(){};}try{r=Set;}catch(e){r=function(){};}try{n=Promise;}catch(e){n=function(){};}function s(i,a,c,d,l){"object"==typeof a&&(c=a.depth,d=a.prototype,l=a.includeNonEnumerable,a=a.circular);var E=[],S=[],p="undefined"!=typeof Buffer;return void 0===a&&(a=!0),void 0===c&&(c=1/0),function i(c,u){if(null===c)return null;if(0===u)return c;var R,h;if("object"!=typeof c)return c;if(e(c,t))R=new t;else if(e(c,r))R=new r;else if(e(c,n))R=new n((function(e,t){c.then((function(t){e(i(t,u-1));}),(function(e){t(i(e,u-1));}));}));else if(s.__isArray(c))R=[];else if(s.__isRegExp(c))R=new RegExp(c.source,o(c)),c.lastIndex&&(R.lastIndex=c.lastIndex);else if(s.__isDate(c))R=new Date(c.getTime());else {if(p&&Buffer.isBuffer(c))return R=Buffer.allocUnsafe?Buffer.allocUnsafe(c.length):new Buffer(c.length),c.copy(R),R;e(c,Error)?R=Object.create(c):void 0===d?(h=Object.getPrototypeOf(c),R=Object.create(h)):(R=Object.create(d),h=d);}if(a){var m=E.indexOf(c);if(-1!=m)return S[m];E.push(c),S.push(R);}for(var g in e(c,t)&&c.forEach((function(e,t){var r=i(t,u-1),n=i(e,u-1);R.set(r,n);})),e(c,r)&&c.forEach((function(e){var t=i(e,u-1);R.add(t);})),c){var f;h&&(f=Object.getOwnPropertyDescriptor(h,g)),f&&null==f.set||(R[g]=i(c[g],u-1));}if(Object.getOwnPropertySymbols){var T=Object.getOwnPropertySymbols(c);for(g=0;g<T.length;g++){var _=T[g];(!(I=Object.getOwnPropertyDescriptor(c,_))||I.enumerable||l)&&(R[_]=i(c[_],u-1),I.enumerable||Object.defineProperty(R,_,{enumerable:!1}));}}if(l){var A=Object.getOwnPropertyNames(c);for(g=0;g<A.length;g++){var I,C=A[g];(I=Object.getOwnPropertyDescriptor(c,C))&&I.enumerable||(R[C]=i(c[C],u-1),Object.defineProperty(R,C,{enumerable:!1}));}}return R}(i,c)}function i(e){return Object.prototype.toString.call(e)}function o(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return s.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},s.__objToStr=i,s.__isDate=function(e){return "object"==typeof e&&"[object Date]"===i(e)},s.__isArray=function(e){return "object"==typeof e&&"[object Array]"===i(e)},s.__isRegExp=function(e){return "object"==typeof e&&"[object RegExp]"===i(e)},s.__getRegExpFlags=o,s}();e.exports&&(e.exports=t);}));const Jt={RECONNECTION_ATTEMPTS:{WEBSOCKET:10,POLLING:4},RECONNECTION_DELAY_MAX:5e3,RECONNECTION_DELAY:1e3},Qt={SOCKET:Jt,MEDIA_OPTIONS:{AUDIO:{stereo:!1,echoCancellation:!0,exactConstraints:!1},VIDEO:{resolution:Et.VGA,frameRate:30,exactConstraints:!1},SCREENSHARE:{video:!0}}},qt=(e,t={})=>{switch(e){case bt.PEER_CONNECTION:return (e=>{const t=ko.getInitOptions(),r=ko.getSkylinkState(e.rid),{filterCandidatesType:n}=t;return {bundlePolicy:et.BALANCED,rtcpMuxPolicy:tt.REQUIRE,iceTransportPolicy:!r.hasMCU&&n.host&&n.srflx&&!n.relay?"relay":"all",iceCandidatePoolSize:0}})(t);case bt.SOCKET:return (e=>({forceNew:!0,reconnection:!1,timeout:e.socketTimeout,path:e.socketServerPath,reconnectionAttempts:Jt.RECONNECTION_ATTEMPTS.WEBSOCKET,reconnectionDelayMax:Jt.RECONNECTION_DELAY_MAX,reconnectionDelay:Jt.RECONNECTION_DELAY,transports:[kt.WEBSOCKET.toLowerCase()],query:{Skylink_SDK_type:vt.WEB,Skylink_SDK_version:Dt,Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"},extraHeaders:{Skylink_SDK_type:vt.WEB,Skylink_SDK_version:Dt,Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"}}))(t);default:zt.log.INFO([null,null,null,Ft.UTILS.CONFIG_NOT_FOUND],e);}},Xt={defaultRoom:null,appKey:null,roomServer:"//api.temasys.io",enableDataChannel:!0,enableSTUNServer:!0,enableTURNServer:!0,socketServerPath:null,enableStatsGathering:!0,audioFallback:!0,socketTimeout:7e3,forceTURNSSL:!1,forceTURN:!1,forceSSL:!0,usePublicSTUN:!1,filterCandidatesType:{host:!1,srflx:!1,relay:!1},mcuUseRenegoRestart:!0,useEdgeWebRTC:!1,enableSimultaneousTransfers:!0,TURNServerTransport:qe.ANY,credentials:null,iceServer:null,socketServer:null,audioCodec:lt.AUTO,videoCodec:dt.AUTO,codecParams:{audio:{opus:{stereo:null,"sprop-stereo":null,usedtx:null,useinbandfec:null,maxplaybackrate:null,minptime:null}},video:{h264:{profileLevelId:null,levelAsymmetryAllowed:null,packetizationMode:null},vp8:{maxFs:null,maxFr:null},vp9:{maxFs:null,maxFr:null}}},beSilentOnStatsLogs:!1,beSilentOnParseLogs:!1,statsInterval:20};class Zt{constructor(e){this.id=e.room_key,this.token=e.roomCred,this.startDateTime=e.start,this.duration=e.len,this.roomName=e.roomName,this.roomSessionId=e.roomSessionId,this.connection={peerConstraints:JSON.parse(e.pc_constraints),offerConstraints:JSON.parse(e.offer_constraints),sdpConstraints:{},peerConfig:{iceServers:[]},mediaConstraints:JSON.parse(e.media_constraints)},this.isLocked=!1;}}class er{constructor(e){this.uid=e.username,this.token=e.userCred,this.timeStamp=e.timeStamp,this.sid=null,this.bufferMessage=null,this.peerSessionId=e.peerSessionId;}}const tr={};class rr{constructor(e,t){if(Hi(t)&&tr[t])return tr[t];const{offer_constraints:r,pc_constraints:n,cid:s,apiOwner:i,ipSigserver:o,isPrivileged:a,autoIntroduce:c,httpPortList:d,httpsPortList:l,hasMCU:E,ipSigserverPath:S,hasPersistentMessage:p,room_key:u,enable_stats_config:R}=e;r||n||zt.log.ERROR(["API",null,"init","pc_constraints or offer_constraints are null"]),zt.log.DEBUG(["API",null,"init","Parsed Peer Connection constraints:"],JSON.parse(n)),zt.log.DEBUG(["API",null,"init","Parsed Offer constraints"],JSON.parse(r)),this.key=s,this.appKeyOwner=i,this.isPrivileged=a,this.autoIntroduce=c,this.room=new Zt(e),this.user=new er(e),this.hasMCU=E,this.socketServer=o,this.socketServerPath=S,this.socketPorts={"http:":Array.isArray(d)&&d.length>0?d:[80,3e3],"https:":Array.isArray(l)&&l.length>0?l:[443,3443]},this.hasPersistentMessage=p,this.enableStatsGathering=R,tr[u]=this;}deleteApiResponseInstance(e){delete tr[e];}}const nr={stats:{endPoints:{client:"/client",session:"/session",auth:"/auth",signaling:"/client/signaling",iceConnection:"/client/iceconnection",iceCandidate:"/client/icecandidate",iceGathering:"/client/icegathering",negotiation:"/client/negotiation",bandwidth:"/client/bandwidth",recording:"/client/recording",dataChannel:"/client/datachannel",userMedia:"/client/usermedia"}}};nr.stats.statsBase="/rest/stats";class sr{constructor(){this.endpoints=nr.stats.endPoints,this.stats_buffer={},this.bufferTimeout=!1;}postStats(e,t){const{STATS_MODULE:r}=Ft,n=ko.getInitOptions().beSilentOnStatsLogs;try{const r=this.processData(t);this.postStatObj(e,n,r);}catch(e){zt.log.WARN(r.ERRORS.POST_FAILED,e);}}processData(e){return Array.isArray(e)?{client_id:e[0].client_id,data:e}:e}async postStatObj(e,t,r){const{roomServer:n}=ko.getInitOptions(),{fetch:s}=window,i=await s(`https:${n}${nr.stats.statsBase}${e}`,{method:"POST",mode:"cors",headers:{"Content-type":"application/json"},body:JSON.stringify(r)});t||i.json().then((t=>{zt.log.INFO([null,_t.STATS,null,`${e}`],t);})).catch((t=>{zt.log.INFO([null,_t.STATS,null,`${e}`],t);}));}addToStatsBuffer(e,t,r){this.stats_buffer[e]||(this.stats_buffer[e]={},this.stats_buffer[e].url=r,this.stats_buffer[e].data=[]);const n=Object.assign({},t);this.stats_buffer[e].data.push(n);}manageStatsBuffer(){this.bufferTimeout||(this.bufferTimeout=!0,setInterval((()=>{const e=Object.keys(this.stats_buffer);for(let t=0;t<e.length;t+=1)this.stats_buffer[e[t]].data.length>0&&(this.postStats(this.stats_buffer[e[t]].url,this.stats_buffer[e[t]].data),this.stats_buffer[e[t]].data=[]);}),5e3));}}class ir extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,state:null,http_status:null,http_error:null,api_url:null,api_result:null};}send(e,t,r,n={},s){this.model.room_id=e,this.model.http_status=s?-1:r&&r.status?r.status:null,this.model.http_error=("string"==typeof s?s:s&&s.message)||null,this.model.api_url=r&&r.endpoint?r.endpoint:r.url,this.model.client_id=ko.getInitOptions().clientId,this.model.app_key=ko.getInitOptions().appKey,this.model.state=t,this.model.timestamp=(new Date).toISOString(),this.model.api_result=n,this.postStats(this.endpoints.auth,this.model);}}const or=e=>{const{appKey:t}=e,r={isValid:!0,message:""};return zt.log.INFO(["API",null,"init","API initialised with options:"],e),t||(r.isValid=!1,r.message=Ft.INIT.ERRORS.NO_APP_KEY,Vt(Te({readyState:it.ERROR,error:{status:-2,content:new Error(Ft.INIT.ERRORS.NO_APP_KEY),errorCode:ot.NO_PATH},room:null}))),r.isValid||zt.log.ERROR(["API",null,"init",r.message]),r},ar=e=>{const{ok:t}=e;return (e=>{const{status:t,ok:r}=e,n=r?"INFO":"ERROR";let s=Ft.INIT.INFO.API_SUCCESS;r||(s=Ft.INIT.ERRORS.AUTH_GENERAL,403===t&&(s=Ft.INIT.ERRORS.AUTH_CORS)),zt.log[n](["API",null,"auth",s],e);})(e),t},cr=e=>{const t=e;return !0===t.forceTURN&&(t.enableTURNServer=!0,t.enableSTUNServer=!1,t.filterCandidatesType.host=!0,t.filterCandidatesType.srflx=!0,t.filterCandidatesType.relay=!1),t},dr=async e=>{const{fetch:t}=window,r=(e=>{const{roomServer:t,appKey:r,defaultRoom:n,credentials:s,forceSSL:i}=e;let o=`${t}/api/${r}/${n}`,a="?";if(o=i?`https:${o}`:`${window.location.protocol}${o}`,s){const{startDateTime:e,duration:t}=s;o+=`/${e}/${t}?cred=${s.credentials}`,a="&";}return o+=`${a}rand=${Date.now()}`,o})(e);(new ir).send(e.defaultRoom,ze.REQUEST,{endpoint:r});return {endpoint:r,response:await t(r,{headers:{Skylink_SDK_type:vt.WEB,Skylink_SDK_version:Dt,Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"}})}},lr=()=>{const e={ready:!0,message:""};return (()=>{try{const e=new window.RTCPeerConnection(null);return ["object","function"].indexOf(typeof e.createOffer)>-1&&null!==e.createOffer}catch(e){return !1}})()||(e.message="WebRTC not supported. Please upgrade your browser",e.ready=!1,Vt(Te({readyState:it.ERROR,error:{status:-2,content:new Error(e.message),errorCode:ot.NO_WEBRTC_SUPPORT},room:null}))),e};let Er=null;class Sr{constructor(){return Er||(Er=this),this.options={},Er}init(e=Xt){e&&(e.socketServer&&!e.socketServerPath&&(e.socketServerPath=""),e.clientId=zi(),ko.setUserInitOptions(e)),Vt(Te({readyState:it.INIT,error:null,room:null}));const t=(()=>{const e={fulfilled:!0,message:""},{AdapterJS:t,io:r,fetch:n}=window,s="Validating Dependencies";return "function"!=typeof(t||window.AdapterJS||window.AdapterJS||{}).webRTCReady?(e.message=Ft.INIT.ERRORS.NO_ADAPTER,e.fulfilled=!1,e.readyStateChangeErrorCode=ot.ADAPTER_NO_LOADED):r||window.io?n&&window.fetch||(e.message=Ft.INIT.ERRORS.NO_FETCH_SUPPORT,e.fulfilled=!1,e.readyStateChangeErrorCode=ot.NO_XMLHTTPREQUEST_SUPPORT):(e.message=Ft.INIT.ERRORS.NO_SOCKET_IO,e.fulfilled=!1,e.readyStateChangeErrorCode=ot.NO_SOCKET_IO),Zi(yt.FIREFOX)&&"moz"===t.webrtcDetectedType||Zi(yt.SAFARI)||Zi(yt.CHROME)&&"webkit"===t.webrtcDetectedType||Zi(yt.CHROME)&&"AppleWebKit"===t.webrtcDetectedType||Zi(yt.REACT_NATIVE)||zt.log.WARN([s,null,null,Ft.INIT.INCOMPATIBLE_BROWSER]),e.fulfilled||zt.log.ERROR([s,null,null,e.message]),e})(),{AdapterJS:r}=window;if(!t.fulfilled)throw Vt(Te({readyState:it.ERROR,error:{status:-2,content:new Error(t.message),errorCode:t.readyStateChangeErrorCode},room:null})),new Error(t.message);let n=Object.assign({},Xt,e);const s=or(n);if(!s.isValid)throw new Error(s.message);return r.webRTCReady((()=>{const e=lr();if(!e.ready)throw new Error(e.message)})),n=cr(n),n}createRoom(e){return new Promise(((t,r)=>{const n=ko.getInitOptions();n.defaultRoom=e,dr(n).then((n=>{const{endpoint:s,response:i}=n;ar(i)?(Vt(Te({readyState:it.COMPLETED,error:null,room:e})),i.json().then((e=>{(new ir).send(e.room_key,ze.SUCCESS,i,e),t({endpoint:s,response:e});}))):(Vt(Te({readyState:it.ERROR,error:{status:i.status,content:new Error(i.info||`XMLHttpRequest status not OK\nStatus was: ${i.status}`),errorCode:i.error||i.status},room:e})),i.json().then((t=>{(new ir).send(e,ze.ERROR,i,null,t.info),r(t);})));})).catch((t=>{Vt(Te({readyState:it.ERROR,error:{status:t.status||-1,content:new Error(t.message||"Network error occurred"),errorCode:ot.XML_HTTP_REQUEST_ERROR},room:e}));}));}))}checkCodecSupport(e){return (e=>new Promise(((t,r)=>{so.getCodecsSupport(e).then((n=>{const s=ko.getSkylinkState(e),{room:i}=s;0===Object.keys(n.audio).length&&0===Object.keys(n.video).length?(zt.log.ERROR(Ft.JOIN_ROOM.ERRORS.CODEC_SUPPORT),Vt(Te({readyState:it.ERROR,error:{status:-2,content:new Error(Ft.JOIN_ROOM.ERRORS.CODEC_SUPPORT),errorCode:ot.PARSE_CODECS},room:Ri.getRoomInfo(i)})),r(new Error(Ft.JOIN_ROOM.ERRORS.CODEC_SUPPORT))):t(!0),s.currentCodecSupport=n,ko.setSkylinkState(s);})).catch((t=>{const n=ko.getSkylinkState(e),{room:s}=n;zt.log.ERROR(t),Vt(Te({readyState:it.ERROR,error:{status:-2,content:new Error(t.message||t.toString()),errorCode:ot.PARSE_CODECS},room:Ri.getRoomInfo(s)})),r(new Error(t.message||t.toString()));}));})))(e)}static parseAPIResponseBody(e){return new rr(e)}enforceUserInitOptions(e){return (e=>{const t=ko.getUserInitOptions(),r=ko.getInitOptions();let n=Object.assign(r,e,t);const s=or(n);if(!s.isValid)throw new Error(s.message);return n=cr(n),ko.setInitOptions(n),n})(e)}static getRoomNameFromParams(e){const t=ko.getInitOptions(),{roomName:r}=e,{defaultRoom:n}=t;let s=null;return s=void 0!==r&&""!==r&&n!==r?r:n,s}static getStateByKey(e){return $i(e)}}const pr=e=>{const t=ko.getSkylinkState(e.roomKey),r=ko.getInitOptions(),{config:n}=e,{socketServer:s,socketTimeout:i,socketServerPath:o}=r,{socketPorts:a}=new rr(null,e.roomKey),c=qt(bt.SOCKET,{socketTimeout:i,socketServerPath:o});let d=[];s&&Gi(s)&&Array.isArray(s.ports)&&s.ports.length?({ports:d}=s):d=a[n.signalingServerProtocol],(e=>!e.signalingServerPort)(n)?(n.signalingServerPort=d[0],n.fallbackType=ct.NON_FALLBACK):((e,t)=>e.indexOf(t.signalingServerPort)===e.length-1)(d,n)||Hi(r.socketServer)?n.socketType===kt.WEBSOCKET?(n.socketType=kt.POLLING,n.signalingServerPort=d[0]):(n.socketSession.finalAttempts+=1,n.signalingServerPort=d[0]):n.signalingServerPort=d[d.indexOf(n.signalingServerPort)+1],n.socketType===kt.POLLING&&(c.reconnectionDelayMax=Qt.SOCKET.RECONNECTION_DELAY_MAX,c.reconnectionAttempts=Qt.SOCKET.RECONNECTION_ATTEMPTS.POLLING,c.transports=[kt.XHR_POLLING,kt.JSONP_POLLING,kt.POLLING.toLowerCase()]);const l=(e=>{const{signalingServerProtocol:t,signalingServer:r,signalingServerPort:n,socketServer:s}=e;let i="";return i=Hi(r)?`${t}//${r}`:r&&Gi(r)&&r.protocol?`${r.protocol}//${s.url}:${n}?rand=${Date.now()}`:`${t}//${r}:${n}?rand=${Date.now()}`,i})({signalingServerProtocol:n.signalingServerProtocol,signalingServer:t.socketServer,signalingServerPort:n.signalingServerPort,socketServer:s});return n.socketServer=s,n.socketServerPath=o,t.socketSession=n,ko.setSkylinkState(t,e.roomKey),window.io(l,c)},ur=(e,t,r)=>{const n=ko.getSkylinkState(e)||Object.values(ko.getSkylinkState())[0],{socketSession:s,room:i,user:o}=n;var a;zt.log.INFO([null,"Socket",null,`Channel closed. Reason - ${r}`]),n.channelOpen=!1,ko.setSkylinkState(n,e),Vt((a={socketSession:Yt(s),reason:r,peerId:t},new Se("channelClose",{detail:a}))),i.inRoom&&o&&o.sid&&Vt(((e={})=>new Se("sessionDisconnect",{detail:e}))({peerId:t,peerInfo:fi.getCurrentSessionInfo(i),reason:r}));};class Rr extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,signaling_url:null,signaling_transport:null,attempts:null,error:null};}send(e,t,r,n){const s=ko.getSkylinkState(e),{socketSession:i}=s;this.model.room_id=e,this.model.user_id=r||null,this.model.client_id=s.clientId,this.model.state=t,this.model.signaling_url=s.socketSession.socketServer,this.model.signaling_transport=s.socketSession.socketType.toLowerCase(),this.model.attempts=0===i.socketSession.finalAttempts?i.socketSession.attempts:2*i.socketSession.finalAttempts+i.socketSession.attempts,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.attempts="number"==typeof n?n:null,this.model.error=("string"==typeof n?n:n&&n.message)||null,this.postStats(this.endpoints.signaling,this.model);}}const hr=(e,t,r)=>{const n=ko.getSkylinkState(r),{socketSession:s,user:i}=n,o=e.socket.id||i.sid||null;var a;(new Rr).send(r,wt.SIGNALING.CONNECT,o,null),n.channelOpen||(n.channelOpen=!0,ko.setSkylinkState(n,r)),Vt((a={socketSession:Yt(s),peerId:o},new Se("channelOpen",{detail:a}))),t();},mr=(e,t)=>{const r=ko.getSkylinkState(e)||Object.values(ko.getSkylinkState())[0],n=r.channelOpen,{room:s,user:i}=r;let o=null;const a=i.sid||null;"io client disconnect"!==t&&(o=t),(new Rr).send(s.id,wt.SIGNALING.DISCONNECT,a,o),(n||!n&&e!==s.roomName)&&Ar(s.id,a,t);},gr=(e,t,r)=>{const n=ko.getSkylinkState(t),{socketSession:s,user:i}=n,o=e.socket.id||i.sid||null;var a;(new Rr).send(t,wt.SIGNALING.ERROR,o,r),zt.log.ERROR([null,"Socket",null,"Exception occurred ->"],r),Vt((a={error:r,socketSession:Yt(s),peerId:o},new Se("channelError",{detail:a})));},fr=e=>xi(e)&&e,Tr=e=>{const{rid:t}=e,r=ko.getSkylinkState(t),{user:n,room:s}=r;let i;return i=((e,t)=>{const r=ko.getSkylinkState(e),{detail:n}=t;if(n.state===rt.ENTER){const e=Yt(r.socketMessageQueue);r.user.bufferMessage=!1,r.socketMessageQueue=[],ko.setSkylinkState(r,r.room.id),zt.log.DEBUG([r.user.sid,_t.SIG_SERVER,null,`${Ft.SIGNALING.BUFFERED_MESSAGES_SENT}: ${e.length}`]),((e,t)=>{const r=new ii;for(let n=t.length-1;n>=0;n-=1){const s=t[n];if(!s.mid){if(!e.user.sid)return void zt.log.DEBUG([e.user.sid,_t.SIG_SERVER,null,`${Ft.SIGNALING.BUFFERED_MESSAGES_DROPPED}`]);s.mid=e.user.sid;}r.sendMessage(s),t.splice(n,1);}})(r,e),Bt.removeEventListener(Gt.HANDSHAKE_PROGRESS,i);}}).bind(void 0,t),!Ui(n.bufferMessage)&&!fr(n.bufferMessage)||(e=>{const{JOIN_ROOM:t,ENTER:r,WELCOME:n,OFFER:s,ANSWER:i,ANSWER_ACK:o,CANDIDATE:a,END_OF_CANDIDATES:c}=Rt;return [t,r,n,s,i,o,a,c].indexOf(e.type)>-1})(e)?(e.type===rt.ENTER&&Ui(n.bufferMessage)&&(zt.log.DEBUG([n.sid,_t.SIG_SERVER,null,Ft.SIGNALING.BUFFER_NOT_NEEDED]),r.user.bufferMessage=!1,r.socketMessageQueue=[],ko.setSkylinkState(r,r.room.id)),!1):(zt.log.DEBUG([n.sid,_t.SIG_SERVER,null,Ft.SIGNALING.MESSAGE_ADDED_TO_BUFFER]),r.socketMessageQueue.unshift(e),fr(n.bufferMessage)||(r.user.bufferMessage=!0,zt.log.DEBUG([n.sid,_t.SIG_SERVER,null,Ft.SIGNALING.ENTER_LISTENER]),Bt.addEventListener(Gt.HANDSHAKE_PROGRESS,i)),ko.setSkylinkState(r,s.id),!0)},_r=(e,t)=>{((e,t)=>{const{type:r}=t;switch(zt.log.INFO(["SIG SERVER",null,r,"received"]),r){case Rt.IN_ROOM:e.inRoomHandler(t);break;case Rt.ENTER:e.enterRoomHandler(t);break;case Rt.OFFER:e.offerHandler(t);break;case Rt.WELCOME:e.welcomeHandler(t);break;case Rt.ANSWER:e.answerHandler(t);break;case Rt.ANSWER_ACK:e.answerAckHandler(t);break;case Rt.CANDIDATE:e.candidateHandler(t);break;case Rt.PEER_LIST:e.getPeerListHandler(t);break;case Rt.INTRODUCE_ERROR:e.introduceError(t);break;case Rt.BYE:e.byeHandler(t);break;case Rt.STREAM:e.streamHandler(t);break;case Rt.RECORDING:e.recordingHandler(t);break;case Rt.REDIRECT:e.redirectHandler(t);break;case Rt.RTMP:e.rtmpHandler(t);break;case Rt.UPDATE_USER:e.setUserDataHandler(t);break;case Rt.MEDIA_INFO_EVENT:e.mediaInfoEventHandler(t);break;case Rt.MESSAGE:e.userMessageHandler(t,null);break;case Rt.STORED_MESSAGES:e.storedMessagesHandler(t);break;case Rt.ROOM_LOCK:e.roomLockHandler(t);break;case Rt.PUBLIC_MESSAGE:e.userMessageHandler(t,!0);break;case Rt.PRIVATE_MESSAGE:e.userMessageHandler(t,!1);}})(e,t);},Ar=(e,t,r)=>{ur(e,t,r);},Ir=(e,t,r)=>{((e,t,r)=>{t.socket.on(Mt.CONNECT,(()=>hr(t,r,e))),t.socket.on(Mt.MESSAGE,t.onMessage.bind(t)),t.socket.on(Mt.DISCONNECT,(t=>mr(e,t))),t.socket.on(Mt.ERROR,(r=>gr(t,e,r)));})(e,t,r);};var Cr=O((function(e,t){var r;e.exports=r=r||function(e,t){var r=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),n={},s=n.lib={},i=s.Base={extend:function(e){var t=r(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments);}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString);},clone:function(){return this.init.prototype.extend(this)}},o=s.WordArray=i.extend({init:function(e,r){e=this.words=e||[],this.sigBytes=r!=t?r:4*e.length;},toString:function(e){return (e||c).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,s=e.sigBytes;if(this.clamp(),n%4)for(var i=0;i<s;i++){var o=r[i>>>2]>>>24-i%4*8&255;t[n+i>>>2]|=o<<24-(n+i)%4*8;}else for(i=0;i<s;i+=4)t[n+i>>>2]=r[i>>>2];return this.sigBytes+=s,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4);},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r,n=[],s=function(t){t=t;var r=987654321,n=4294967295;return function(){var s=((r=36969*(65535&r)+(r>>16)&n)<<16)+(t=18e3*(65535&t)+(t>>16)&n)&n;return s/=4294967296,(s+=.5)*(e.random()>.5?1:-1)}},i=0;i<t;i+=4){var a=s(4294967296*(r||e.random()));r=987654071*a(),n.push(4294967296*a()|0);}return new o.init(n,t)}}),a=n.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s++){var i=t[s>>>2]>>>24-s%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16));}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new o.init(r,t/2)}},d=a.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s++){var i=t[s>>>2]>>>24-s%4*8&255;n.push(String.fromCharCode(i));}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new o.init(r,t)}},l=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},E=s.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new o.init,this._nDataBytes=0;},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes;},_process:function(t){var r=this._data,n=r.words,s=r.sigBytes,i=this.blockSize,a=s/(4*i),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*i,d=e.min(4*c,s);if(c){for(var l=0;l<c;l+=i)this._doProcessBlock(n,l);var E=n.splice(0,c);r.sigBytes-=d;}return new o.init(E,d)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});s.Hasher=E.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset();},reset:function(){E.reset.call(this),this._doReset();},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new S.HMAC.init(e,r).finalize(t)}}});var S=n.algo={};return n}(Math);})),Or=(O((function(e,t){var r,n,s,i,o,a,c;e.exports=(s=(n=c=Cr).lib,i=s.Base,o=s.WordArray,(a=n.x64={}).Word=i.extend({init:function(e,t){this.high=e,this.low=t;}}),a.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=t!=r?t:8*e.length;},toX32:function(){for(var e=this.words,t=e.length,r=[],n=0;n<t;n++){var s=e[n];r.push(s.high),r.push(s.low);}return o.create(r,this.sigBytes)},clone:function(){for(var e=i.clone.call(this),t=e.words=this.words.slice(0),r=t.length,n=0;n<r;n++)t[n]=t[n].clone();return e}}),c);})),O((function(e,t){var r;e.exports=(r=Cr,function(){if("function"==typeof ArrayBuffer){var e=r.lib.WordArray,t=e.init;(e.init=function(e){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var r=e.byteLength,n=[],s=0;s<r;s++)n[s>>>2]|=e[s]<<24-s%4*8;t.call(this,n,r);}else t.apply(this,arguments);}).prototype=e;}}(),r.lib.WordArray);})),O((function(e,t){var r;e.exports=(r=Cr,function(){var e=r,t=e.lib.WordArray,n=e.enc;function s(e){return e<<8&4278255360|e>>>8&16711935}n.Utf16=n.Utf16BE={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s+=2){var i=t[s>>>2]>>>16-s%4*8&65535;n.push(String.fromCharCode(i));}return n.join("")},parse:function(e){for(var r=e.length,n=[],s=0;s<r;s++)n[s>>>1]|=e.charCodeAt(s)<<16-s%2*16;return t.create(n,2*r)}},n.Utf16LE={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i+=2){var o=s(t[i>>>2]>>>16-i%4*8&65535);n.push(String.fromCharCode(o));}return n.join("")},parse:function(e){for(var r=e.length,n=[],i=0;i<r;i++)n[i>>>1]|=s(e.charCodeAt(i)<<16-i%2*16);return t.create(n,2*r)}};}(),r.enc.Utf16);})),O((function(e,t){var r;e.exports=(r=Cr,function(){var e=r,t=e.lib.WordArray;function n(e,r,n){for(var s=[],i=0,o=0;o<r;o++)if(o%4){var a=n[e.charCodeAt(o-1)]<<o%4*2,c=n[e.charCodeAt(o)]>>>6-o%4*2;s[i>>>2]|=(a|c)<<24-i%4*8,i++;}return t.create(s,i)}e.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var s=[],i=0;i<r;i+=3)for(var o=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,a=0;a<4&&i+.75*a<r;a++)s.push(n.charAt(o>>>6*(3-a)&63));var c=n.charAt(64);if(c)for(;s.length%4;)s.push(c);return s.join("")},parse:function(e){var t=e.length,r=this._map,s=this._reverseMap;if(!s){s=this._reverseMap=[];for(var i=0;i<r.length;i++)s[r.charCodeAt(i)]=i;}var o=r.charAt(64);if(o){var a=e.indexOf(o);-1!==a&&(t=a);}return n(e,t,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="};}(),r.enc.Base64);})),O((function(e,t){var r;e.exports=(r=Cr,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0;}();var c=o.MD5=i.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878]);},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var n=t+r,s=e[n];e[n]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8);}var i=this._hash.words,o=e[t+0],c=e[t+1],p=e[t+2],u=e[t+3],R=e[t+4],h=e[t+5],m=e[t+6],g=e[t+7],f=e[t+8],T=e[t+9],_=e[t+10],A=e[t+11],I=e[t+12],C=e[t+13],O=e[t+14],N=e[t+15],D=i[0],v=i[1],y=i[2],P=i[3];D=d(D,v,y,P,o,7,a[0]),P=d(P,D,v,y,c,12,a[1]),y=d(y,P,D,v,p,17,a[2]),v=d(v,y,P,D,u,22,a[3]),D=d(D,v,y,P,R,7,a[4]),P=d(P,D,v,y,h,12,a[5]),y=d(y,P,D,v,m,17,a[6]),v=d(v,y,P,D,g,22,a[7]),D=d(D,v,y,P,f,7,a[8]),P=d(P,D,v,y,T,12,a[9]),y=d(y,P,D,v,_,17,a[10]),v=d(v,y,P,D,A,22,a[11]),D=d(D,v,y,P,I,7,a[12]),P=d(P,D,v,y,C,12,a[13]),y=d(y,P,D,v,O,17,a[14]),D=l(D,v=d(v,y,P,D,N,22,a[15]),y,P,c,5,a[16]),P=l(P,D,v,y,m,9,a[17]),y=l(y,P,D,v,A,14,a[18]),v=l(v,y,P,D,o,20,a[19]),D=l(D,v,y,P,h,5,a[20]),P=l(P,D,v,y,_,9,a[21]),y=l(y,P,D,v,N,14,a[22]),v=l(v,y,P,D,R,20,a[23]),D=l(D,v,y,P,T,5,a[24]),P=l(P,D,v,y,O,9,a[25]),y=l(y,P,D,v,u,14,a[26]),v=l(v,y,P,D,f,20,a[27]),D=l(D,v,y,P,C,5,a[28]),P=l(P,D,v,y,p,9,a[29]),y=l(y,P,D,v,g,14,a[30]),D=E(D,v=l(v,y,P,D,I,20,a[31]),y,P,h,4,a[32]),P=E(P,D,v,y,f,11,a[33]),y=E(y,P,D,v,A,16,a[34]),v=E(v,y,P,D,O,23,a[35]),D=E(D,v,y,P,c,4,a[36]),P=E(P,D,v,y,R,11,a[37]),y=E(y,P,D,v,g,16,a[38]),v=E(v,y,P,D,_,23,a[39]),D=E(D,v,y,P,C,4,a[40]),P=E(P,D,v,y,o,11,a[41]),y=E(y,P,D,v,u,16,a[42]),v=E(v,y,P,D,m,23,a[43]),D=E(D,v,y,P,T,4,a[44]),P=E(P,D,v,y,I,11,a[45]),y=E(y,P,D,v,N,16,a[46]),D=S(D,v=E(v,y,P,D,p,23,a[47]),y,P,o,6,a[48]),P=S(P,D,v,y,g,10,a[49]),y=S(y,P,D,v,O,15,a[50]),v=S(v,y,P,D,h,21,a[51]),D=S(D,v,y,P,I,6,a[52]),P=S(P,D,v,y,u,10,a[53]),y=S(y,P,D,v,_,15,a[54]),v=S(v,y,P,D,c,21,a[55]),D=S(D,v,y,P,f,6,a[56]),P=S(P,D,v,y,N,10,a[57]),y=S(y,P,D,v,m,15,a[58]),v=S(v,y,P,D,C,21,a[59]),D=S(D,v,y,P,R,6,a[60]),P=S(P,D,v,y,A,10,a[61]),y=S(y,P,D,v,p,15,a[62]),v=S(v,y,P,D,T,21,a[63]),i[0]=i[0]+D|0,i[1]=i[1]+v|0,i[2]=i[2]+y|0,i[3]=i[3]+P|0;},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,s=8*t.sigBytes;r[s>>>5]|=128<<24-s%32;var i=e.floor(n/4294967296),o=n;r[15+(s+64>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),r[14+(s+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(r.length+1),this._process();for(var a=this._hash,c=a.words,d=0;d<4;d++){var l=c[d];c[d]=16711935&(l<<8|l>>>24)|4278255360&(l<<24|l>>>8);}return a},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});function d(e,t,r,n,s,i,o){var a=e+(t&r|~t&n)+s+o;return (a<<i|a>>>32-i)+t}function l(e,t,r,n,s,i,o){var a=e+(t&n|r&~n)+s+o;return (a<<i|a>>>32-i)+t}function E(e,t,r,n,s,i,o){var a=e+(t^r^n)+s+o;return (a<<i|a>>>32-i)+t}function S(e,t,r,n,s,i,o){var a=e+(r^(t|~n))+s+o;return (a<<i|a>>>32-i)+t}t.MD5=i._createHelper(c),t.HmacMD5=i._createHmacHelper(c);}(Math),r.MD5);})),O((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=Cr).lib,s=n.WordArray,i=n.Hasher,o=r.algo,a=[],c=o.SHA1=i.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],c=r[4],d=0;d<80;d++){if(d<16)a[d]=0|e[t+d];else {var l=a[d-3]^a[d-8]^a[d-14]^a[d-16];a[d]=l<<1|l>>>31;}var E=(n<<5|n>>>27)+c+a[d];E+=d<20?1518500249+(s&i|~s&o):d<40?1859775393+(s^i^o):d<60?(s&i|s&o|i&o)-1894007588:(s^i^o)-899497514,c=o,o=i,i=s<<30|s>>>2,s=n,n=E;}r[0]=r[0]+n|0,r[1]=r[1]+s|0,r[2]=r[2]+i|0,r[3]=r[3]+o|0,r[4]=r[4]+c|0;},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(n+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}}),r.SHA1=i._createHelper(c),r.HmacSHA1=i._createHmacHelper(c),d.SHA1);})),O((function(e,t){var r;e.exports=(r=Cr,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=[],c=[];!function(){function t(t){for(var r=e.sqrt(t),n=2;n<=r;n++)if(!(t%n))return !1;return !0}function r(e){return 4294967296*(e-(0|e))|0}for(var n=2,s=0;s<64;)t(n)&&(s<8&&(a[s]=r(e.pow(n,.5))),c[s]=r(e.pow(n,1/3)),s++),n++;}();var d=[],l=o.SHA256=i.extend({_doReset:function(){this._hash=new s.init(a.slice(0));},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],a=r[4],l=r[5],E=r[6],S=r[7],p=0;p<64;p++){if(p<16)d[p]=0|e[t+p];else {var u=d[p-15],R=(u<<25|u>>>7)^(u<<14|u>>>18)^u>>>3,h=d[p-2],m=(h<<15|h>>>17)^(h<<13|h>>>19)^h>>>10;d[p]=R+d[p-7]+m+d[p-16];}var g=n&s^n&i^s&i,f=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),T=S+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&l^~a&E)+c[p]+d[p];S=E,E=l,l=a,a=o+T|0,o=i,i=s,s=n,n=T+(f+g)|0;}r[0]=r[0]+n|0,r[1]=r[1]+s|0,r[2]=r[2]+i|0,r[3]=r[3]+o|0,r[4]=r[4]+a|0,r[5]=r[5]+l|0,r[6]=r[6]+E|0,r[7]=r[7]+S|0;},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,s=8*t.sigBytes;return r[s>>>5]|=128<<24-s%32,r[14+(s+64>>>9<<4)]=e.floor(n/4294967296),r[15+(s+64>>>9<<4)]=n,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=i._createHelper(l),t.HmacSHA256=i._createHmacHelper(l);}(Math),r.SHA256);})),O((function(e,t){var r,n,s,i,o,a;e.exports=(n=(r=a=Cr).lib.WordArray,s=r.algo,i=s.SHA256,o=s.SHA224=i.extend({_doReset:function(){this._hash=new n.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]);},_doFinalize:function(){var e=i._doFinalize.call(this);return e.sigBytes-=4,e}}),r.SHA224=i._createHelper(o),r.HmacSHA224=i._createHmacHelper(o),a.SHA224);})),O((function(e,t){var r;e.exports=(r=Cr,function(){var e=r,t=e.lib.Hasher,n=e.x64,s=n.Word,i=n.WordArray,o=e.algo;function a(){return s.create.apply(s,arguments)}var c=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],d=[];!function(){for(var e=0;e<80;e++)d[e]=a();}();var l=o.SHA512=t.extend({_doReset:function(){this._hash=new i.init([new s.init(1779033703,4089235720),new s.init(3144134277,2227873595),new s.init(1013904242,4271175723),new s.init(2773480762,1595750129),new s.init(1359893119,2917565137),new s.init(2600822924,725511199),new s.init(528734635,4215389547),new s.init(1541459225,327033209)]);},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],a=r[4],l=r[5],E=r[6],S=r[7],p=n.high,u=n.low,R=s.high,h=s.low,m=i.high,g=i.low,f=o.high,T=o.low,_=a.high,A=a.low,I=l.high,C=l.low,O=E.high,N=E.low,D=S.high,v=S.low,y=p,P=u,M=R,k=h,w=m,b=g,L=f,G=T,U=_,F=A,B=I,x=C,H=O,V=N,j=D,$=v,W=0;W<80;W++){var K=d[W];if(W<16)var z=K.high=0|e[t+2*W],Y=K.low=0|e[t+2*W+1];else {var J=d[W-15],Q=J.high,q=J.low,X=(Q>>>1|q<<31)^(Q>>>8|q<<24)^Q>>>7,Z=(q>>>1|Q<<31)^(q>>>8|Q<<24)^(q>>>7|Q<<25),ee=d[W-2],te=ee.high,re=ee.low,ne=(te>>>19|re<<13)^(te<<3|re>>>29)^te>>>6,se=(re>>>19|te<<13)^(re<<3|te>>>29)^(re>>>6|te<<26),ie=d[W-7],oe=ie.high,ae=ie.low,ce=d[W-16],de=ce.high,le=ce.low;z=(z=(z=X+oe+((Y=Z+ae)>>>0<Z>>>0?1:0))+ne+((Y+=se)>>>0<se>>>0?1:0))+de+((Y+=le)>>>0<le>>>0?1:0),K.high=z,K.low=Y;}var Ee,Se=U&B^~U&H,pe=F&x^~F&V,ue=y&M^y&w^M&w,Re=P&k^P&b^k&b,he=(y>>>28|P<<4)^(y<<30|P>>>2)^(y<<25|P>>>7),me=(P>>>28|y<<4)^(P<<30|y>>>2)^(P<<25|y>>>7),ge=(U>>>14|F<<18)^(U>>>18|F<<14)^(U<<23|F>>>9),fe=(F>>>14|U<<18)^(F>>>18|U<<14)^(F<<23|U>>>9),Te=c[W],_e=Te.high,Ae=Te.low,Ie=j+ge+((Ee=$+fe)>>>0<$>>>0?1:0),Ce=me+Re;j=H,$=V,H=B,V=x,B=U,x=F,U=L+(Ie=(Ie=(Ie=Ie+Se+((Ee+=pe)>>>0<pe>>>0?1:0))+_e+((Ee+=Ae)>>>0<Ae>>>0?1:0))+z+((Ee+=Y)>>>0<Y>>>0?1:0))+((F=G+Ee|0)>>>0<G>>>0?1:0)|0,L=w,G=b,w=M,b=k,M=y,k=P,y=Ie+(he+ue+(Ce>>>0<me>>>0?1:0))+((P=Ee+Ce|0)>>>0<Ee>>>0?1:0)|0;}u=n.low=u+P,n.high=p+y+(u>>>0<P>>>0?1:0),h=s.low=h+k,s.high=R+M+(h>>>0<k>>>0?1:0),g=i.low=g+b,i.high=m+w+(g>>>0<b>>>0?1:0),T=o.low=T+G,o.high=f+L+(T>>>0<G>>>0?1:0),A=a.low=A+F,a.high=_+U+(A>>>0<F>>>0?1:0),C=l.low=C+x,l.high=I+B+(C>>>0<x>>>0?1:0),N=E.low=N+V,E.high=O+H+(N>>>0<V>>>0?1:0),v=S.low=v+$,S.high=D+j+(v>>>0<$>>>0?1:0);},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(n+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=t.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32});e.SHA512=t._createHelper(l),e.HmacSHA512=t._createHmacHelper(l);}(),r.SHA512);})),O((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=Cr).x64,s=n.Word,i=n.WordArray,o=r.algo,a=o.SHA512,c=o.SHA384=a.extend({_doReset:function(){this._hash=new i.init([new s.init(3418070365,3238371032),new s.init(1654270250,914150663),new s.init(2438529370,812702999),new s.init(355462360,4144912697),new s.init(1731405415,4290775857),new s.init(2394180231,1750603025),new s.init(3675008525,1694076839),new s.init(1203062813,3204075428)]);},_doFinalize:function(){var e=a._doFinalize.call(this);return e.sigBytes-=16,e}}),r.SHA384=a._createHelper(c),r.HmacSHA384=a._createHmacHelper(c),d.SHA384);})),O((function(e,t){var r;e.exports=(r=Cr,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.x64.Word,a=t.algo,c=[],d=[],l=[];!function(){for(var e=1,t=0,r=0;r<24;r++){c[e+5*t]=(r+1)*(r+2)/2%64;var n=(2*e+3*t)%5;e=t%5,t=n;}for(e=0;e<5;e++)for(t=0;t<5;t++)d[e+5*t]=t+(2*e+3*t)%5*5;for(var s=1,i=0;i<24;i++){for(var a=0,E=0,S=0;S<7;S++){if(1&s){var p=(1<<S)-1;p<32?E^=1<<p:a^=1<<p-32;}128&s?s=s<<1^113:s<<=1;}l[i]=o.create(a,E);}}();var E=[];!function(){for(var e=0;e<25;e++)E[e]=o.create();}();var S=a.SHA3=i.extend({cfg:i.cfg.extend({outputLength:512}),_doReset:function(){for(var e=this._state=[],t=0;t<25;t++)e[t]=new o.init;this.blockSize=(1600-2*this.cfg.outputLength)/32;},_doProcessBlock:function(e,t){for(var r=this._state,n=this.blockSize/2,s=0;s<n;s++){var i=e[t+2*s],o=e[t+2*s+1];i=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),o=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),(v=r[s]).high^=o,v.low^=i;}for(var a=0;a<24;a++){for(var S=0;S<5;S++){for(var p=0,u=0,R=0;R<5;R++)p^=(v=r[S+5*R]).high,u^=v.low;var h=E[S];h.high=p,h.low=u;}for(S=0;S<5;S++){var m=E[(S+4)%5],g=E[(S+1)%5],f=g.high,T=g.low;for(p=m.high^(f<<1|T>>>31),u=m.low^(T<<1|f>>>31),R=0;R<5;R++)(v=r[S+5*R]).high^=p,v.low^=u;}for(var _=1;_<25;_++){var A=(v=r[_]).high,I=v.low,C=c[_];C<32?(p=A<<C|I>>>32-C,u=I<<C|A>>>32-C):(p=I<<C-32|A>>>64-C,u=A<<C-32|I>>>64-C);var O=E[d[_]];O.high=p,O.low=u;}var N=E[0],D=r[0];for(N.high=D.high,N.low=D.low,S=0;S<5;S++)for(R=0;R<5;R++){var v=r[_=S+5*R],y=E[_],P=E[(S+1)%5+5*R],M=E[(S+2)%5+5*R];v.high=y.high^~P.high&M.high,v.low=y.low^~P.low&M.low;}v=r[0];var k=l[a];v.high^=k.high,v.low^=k.low;}},_doFinalize:function(){var t=this._data,r=t.words;this._nDataBytes;var n=8*t.sigBytes,i=32*this.blockSize;r[n>>>5]|=1<<24-n%32,r[(e.ceil((n+1)/i)*i>>>5)-1]|=128,t.sigBytes=4*r.length,this._process();for(var o=this._state,a=this.cfg.outputLength/8,c=a/8,d=[],l=0;l<c;l++){var E=o[l],S=E.high,p=E.low;S=16711935&(S<<8|S>>>24)|4278255360&(S<<24|S>>>8),p=16711935&(p<<8|p>>>24)|4278255360&(p<<24|p>>>8),d.push(p),d.push(S);}return new s.init(d,a)},clone:function(){for(var e=i.clone.call(this),t=e._state=this._state.slice(0),r=0;r<25;r++)t[r]=t[r].clone();return e}});t.SHA3=i._createHelper(S),t.HmacSHA3=i._createHmacHelper(S);}(Math),r.SHA3);})),O((function(e,t){var r;e.exports=(r=Cr,
/** @preserve
	(c) 2012 by Cdric Mesnil. All rights reserved.

	Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

	    - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
	    - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
	*/
function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=s.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),c=s.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),d=s.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),l=s.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),E=s.create([0,1518500249,1859775393,2400959708,2840853838]),S=s.create([1352829926,1548603684,1836072691,2053994217,0]),p=o.RIPEMD160=i.extend({_doReset:function(){this._hash=s.create([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var n=t+r,s=e[n];e[n]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8);}var i,o,p,T,_,A,I,C,O,N,D,v=this._hash.words,y=E.words,P=S.words,M=a.words,k=c.words,w=d.words,b=l.words;for(A=i=v[0],I=o=v[1],C=p=v[2],O=T=v[3],N=_=v[4],r=0;r<80;r+=1)D=i+e[t+M[r]]|0,D+=r<16?u(o,p,T)+y[0]:r<32?R(o,p,T)+y[1]:r<48?h(o,p,T)+y[2]:r<64?m(o,p,T)+y[3]:g(o,p,T)+y[4],D=(D=f(D|=0,w[r]))+_|0,i=_,_=T,T=f(p,10),p=o,o=D,D=A+e[t+k[r]]|0,D+=r<16?g(I,C,O)+P[0]:r<32?m(I,C,O)+P[1]:r<48?h(I,C,O)+P[2]:r<64?R(I,C,O)+P[3]:u(I,C,O)+P[4],D=(D=f(D|=0,b[r]))+N|0,A=N,N=O,O=f(C,10),C=I,I=D;D=v[1]+p+O|0,v[1]=v[2]+T+N|0,v[2]=v[3]+_+A|0,v[3]=v[4]+i+I|0,v[4]=v[0]+o+C|0,v[0]=D;},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),e.sigBytes=4*(t.length+1),this._process();for(var s=this._hash,i=s.words,o=0;o<5;o++){var a=i[o];i[o]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8);}return s},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});function u(e,t,r){return e^t^r}function R(e,t,r){return e&t|~e&r}function h(e,t,r){return (e|~t)^r}function m(e,t,r){return e&r|t&~r}function g(e,t,r){return e^(t|~r)}function f(e,t){return e<<t|e>>>32-t}t.RIPEMD160=i._createHelper(p),t.HmacRIPEMD160=i._createHmacHelper(p);}(),r.RIPEMD160);})),O((function(e,t){var r,n,s;e.exports=(n=(r=Cr).lib.Base,s=r.enc.Utf8,void(r.algo.HMAC=n.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=s.parse(t));var r=e.blockSize,n=4*r;t.sigBytes>n&&(t=e.finalize(t)),t.clamp();for(var i=this._oKey=t.clone(),o=this._iKey=t.clone(),a=i.words,c=o.words,d=0;d<r;d++)a[d]^=1549556828,c[d]^=909522486;i.sigBytes=o.sigBytes=n,this.reset();},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey);},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})));})),O((function(e,t){var r,n,s,i,o,a,c,d,l;e.exports=(n=(r=l=Cr).lib,s=n.Base,i=n.WordArray,o=r.algo,a=o.SHA1,c=o.HMAC,d=o.PBKDF2=s.extend({cfg:s.extend({keySize:4,hasher:a,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e);},compute:function(e,t){for(var r=this.cfg,n=c.create(r.hasher,e),s=i.create(),o=i.create([1]),a=s.words,d=o.words,l=r.keySize,E=r.iterations;a.length<l;){var S=n.update(t).finalize(o);n.reset();for(var p=S.words,u=p.length,R=S,h=1;h<E;h++){R=n.finalize(R),n.reset();for(var m=R.words,g=0;g<u;g++)p[g]^=m[g];}s.concat(S),d[0]++;}return s.sigBytes=4*l,s}}),r.PBKDF2=function(e,t,r){return d.create(r).compute(e,t)},l.PBKDF2);})),O((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=Cr).lib,s=n.Base,i=n.WordArray,o=r.algo,a=o.MD5,c=o.EvpKDF=s.extend({cfg:s.extend({keySize:4,hasher:a,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e);},compute:function(e,t){for(var r=this.cfg,n=r.hasher.create(),s=i.create(),o=s.words,a=r.keySize,c=r.iterations;o.length<a;){d&&n.update(d);var d=n.update(e).finalize(t);n.reset();for(var l=1;l<c;l++)d=n.finalize(d),n.reset();s.concat(d);}return s.sigBytes=4*a,s}}),r.EvpKDF=function(e,t,r){return c.create(r).compute(e,t)},d.EvpKDF);})),O((function(e,t){var r;e.exports=void((r=Cr).lib.Cipher||function(e){var t=r,n=t.lib,s=n.Base,i=n.WordArray,o=n.BufferedBlockAlgorithm,a=t.enc;a.Utf8;var c=a.Base64,d=t.algo.EvpKDF,l=n.Cipher=o.extend({cfg:s.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset();},reset:function(){o.reset.call(this),this._doReset();},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function e(e){return "string"==typeof e?f:m}return function(t){return {encrypt:function(r,n,s){return e(n).encrypt(t,r,n,s)},decrypt:function(r,n,s){return e(n).decrypt(t,r,n,s)}}}}()});n.StreamCipher=l.extend({_doFinalize:function(){return this._process(!0)},blockSize:1});var E=t.mode={},S=n.BlockCipherMode=s.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t;}}),p=E.CBC=function(){var t=S.extend();function r(t,r,n){var s=this._iv;if(s){var i=s;this._iv=e;}else i=this._prevBlock;for(var o=0;o<n;o++)t[r+o]^=i[o];}return t.Encryptor=t.extend({processBlock:function(e,t){var n=this._cipher,s=n.blockSize;r.call(this,e,t,s),n.encryptBlock(e,t),this._prevBlock=e.slice(t,t+s);}}),t.Decryptor=t.extend({processBlock:function(e,t){var n=this._cipher,s=n.blockSize,i=e.slice(t,t+s);n.decryptBlock(e,t),r.call(this,e,t,s),this._prevBlock=i;}}),t}(),u=(t.pad={}).Pkcs7={pad:function(e,t){for(var r=4*t,n=r-e.sigBytes%r,s=n<<24|n<<16|n<<8|n,o=[],a=0;a<n;a+=4)o.push(s);var c=i.create(o,n);e.concat(c);},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}};n.BlockCipher=l.extend({cfg:l.cfg.extend({mode:p,padding:u}),reset:function(){l.reset.call(this);var e=this.cfg,t=e.iv,r=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var n=r.createEncryptor;else n=r.createDecryptor,this._minBufferSize=1;this._mode&&this._mode.__creator==n?this._mode.init(this,t&&t.words):(this._mode=n.call(r,this,t&&t.words),this._mode.__creator=n);},_doProcessBlock:function(e,t){this._mode.processBlock(e,t);},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0);}else t=this._process(!0),e.unpad(t);return t},blockSize:4});var R=n.CipherParams=s.extend({init:function(e){this.mixIn(e);},toString:function(e){return (e||this.formatter).stringify(this)}}),h=(t.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,r=e.salt;if(r)var n=i.create([1398893684,1701076831]).concat(r).concat(t);else n=t;return n.toString(c)},parse:function(e){var t=c.parse(e),r=t.words;if(1398893684==r[0]&&1701076831==r[1]){var n=i.create(r.slice(2,4));r.splice(0,4),t.sigBytes-=16;}return R.create({ciphertext:t,salt:n})}},m=n.SerializableCipher=s.extend({cfg:s.extend({format:h}),encrypt:function(e,t,r,n){n=this.cfg.extend(n);var s=e.createEncryptor(r,n),i=s.finalize(t),o=s.cfg;return R.create({ciphertext:i,key:r,iv:o.iv,algorithm:e,mode:o.mode,padding:o.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(r,n).finalize(t.ciphertext)},_parse:function(e,t){return "string"==typeof e?t.parse(e,this):e}}),g=(t.kdf={}).OpenSSL={execute:function(e,t,r,n){n||(n=i.random(8));var s=d.create({keySize:t+r}).compute(e,n),o=i.create(s.words.slice(t),4*r);return s.sigBytes=4*t,R.create({key:s,iv:o,salt:n})}},f=n.PasswordBasedCipher=m.extend({cfg:m.cfg.extend({kdf:g}),encrypt:function(e,t,r,n){var s=(n=this.cfg.extend(n)).kdf.execute(r,e.keySize,e.ivSize);n.iv=s.iv;var i=m.encrypt.call(this,e,t,s.key,n);return i.mixIn(s),i},decrypt:function(e,t,r,n){n=this.cfg.extend(n),t=this._parse(t,n.format);var s=n.kdf.execute(r,e.keySize,e.ivSize,t.salt);return n.iv=s.iv,m.decrypt.call(this,e,t,s.key,n)}});}());})),O((function(e,t){var r;e.exports=((r=Cr).mode.CFB=function(){var e=r.lib.BlockCipherMode.extend();function t(e,t,r,n){var s=this._iv;if(s){var i=s.slice(0);this._iv=void 0;}else i=this._prevBlock;n.encryptBlock(i,0);for(var o=0;o<r;o++)e[t+o]^=i[o];}return e.Encryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize;t.call(this,e,r,s,n),this._prevBlock=e.slice(r,r+s);}}),e.Decryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize,i=e.slice(r,r+s);t.call(this,e,r,s,n),this._prevBlock=i;}}),e}(),r.mode.CFB);})),O((function(e,t){var r,n,s;e.exports=((s=Cr).mode.CTR=(r=s.lib.BlockCipherMode.extend(),n=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,s=this._iv,i=this._counter;s&&(i=this._counter=s.slice(0),this._iv=void 0);var o=i.slice(0);r.encryptBlock(o,0),i[n-1]=i[n-1]+1|0;for(var a=0;a<n;a++)e[t+a]^=o[a];}}),r.Decryptor=n,r),s.mode.CTR);})),O((function(e,t){var r;e.exports=(
/** @preserve
	 * Counter block mode compatible with  Dr Brian Gladman fileenc.c
	 * derived from CryptoJS.mode.CTR
	 * Jan Hruby jhruby.web@gmail.com
	 */
(r=Cr).mode.CTRGladman=function(){var e=r.lib.BlockCipherMode.extend();function t(e){if(255==(e>>24&255)){var t=e>>16&255,r=e>>8&255,n=255&e;255===t?(t=0,255===r?(r=0,255===n?n=0:++n):++r):++t,e=0,e+=t<<16,e+=r<<8,e+=n;}else e+=1<<24;return e}function n(e){return 0===(e[0]=t(e[0]))&&(e[1]=t(e[1])),e}var s=e.Encryptor=e.extend({processBlock:function(e,t){var r=this._cipher,s=r.blockSize,i=this._iv,o=this._counter;i&&(o=this._counter=i.slice(0),this._iv=void 0),n(o);var a=o.slice(0);r.encryptBlock(a,0);for(var c=0;c<s;c++)e[t+c]^=a[c];}});return e.Decryptor=s,e}(),r.mode.CTRGladman);})),O((function(e,t){var r,n,s;e.exports=((s=Cr).mode.OFB=(r=s.lib.BlockCipherMode.extend(),n=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,s=this._iv,i=this._keystream;s&&(i=this._keystream=s.slice(0),this._iv=void 0),r.encryptBlock(i,0);for(var o=0;o<n;o++)e[t+o]^=i[o];}}),r.Decryptor=n,r),s.mode.OFB);})),O((function(e,t){var r,n;e.exports=((n=Cr).mode.ECB=((r=n.lib.BlockCipherMode.extend()).Encryptor=r.extend({processBlock:function(e,t){this._cipher.encryptBlock(e,t);}}),r.Decryptor=r.extend({processBlock:function(e,t){this._cipher.decryptBlock(e,t);}}),r),n.mode.ECB);})),O((function(e,t){var r;e.exports=((r=Cr).pad.AnsiX923={pad:function(e,t){var r=e.sigBytes,n=4*t,s=n-r%n,i=r+s-1;e.clamp(),e.words[i>>>2]|=s<<24-i%4*8,e.sigBytes+=s;},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},r.pad.Ansix923);})),O((function(e,t){var r;e.exports=((r=Cr).pad.Iso10126={pad:function(e,t){var n=4*t,s=n-e.sigBytes%n;e.concat(r.lib.WordArray.random(s-1)).concat(r.lib.WordArray.create([s<<24],1));},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},r.pad.Iso10126);})),O((function(e,t){var r;e.exports=((r=Cr).pad.Iso97971={pad:function(e,t){e.concat(r.lib.WordArray.create([2147483648],1)),r.pad.ZeroPadding.pad(e,t);},unpad:function(e){r.pad.ZeroPadding.unpad(e),e.sigBytes--;}},r.pad.Iso97971);})),O((function(e,t){var r;e.exports=((r=Cr).pad.ZeroPadding={pad:function(e,t){var r=4*t;e.clamp(),e.sigBytes+=r-(e.sigBytes%r||r);},unpad:function(e){for(var t=e.words,r=e.sigBytes-1;!(t[r>>>2]>>>24-r%4*8&255);)r--;e.sigBytes=r+1;}},r.pad.ZeroPadding);})),O((function(e,t){var r;e.exports=((r=Cr).pad.NoPadding={pad:function(){},unpad:function(){}},r.pad.NoPadding);})),O((function(e,t){var r,n,s,i;e.exports=(n=(r=i=Cr).lib.CipherParams,s=r.enc.Hex,r.format.Hex={stringify:function(e){return e.ciphertext.toString(s)},parse:function(e){var t=s.parse(e);return n.create({ciphertext:t})}},i.format.Hex);})),O((function(e,t){var r;e.exports=(r=Cr,function(){var e=r,t=e.lib.BlockCipher,n=e.algo,s=[],i=[],o=[],a=[],c=[],d=[],l=[],E=[],S=[],p=[];!function(){for(var e=[],t=0;t<256;t++)e[t]=t<128?t<<1:t<<1^283;var r=0,n=0;for(t=0;t<256;t++){var u=n^n<<1^n<<2^n<<3^n<<4;u=u>>>8^255&u^99,s[r]=u,i[u]=r;var R=e[r],h=e[R],m=e[h],g=257*e[u]^16843008*u;o[r]=g<<24|g>>>8,a[r]=g<<16|g>>>16,c[r]=g<<8|g>>>24,d[r]=g,g=16843009*m^65537*h^257*R^16843008*r,l[u]=g<<24|g>>>8,E[u]=g<<16|g>>>16,S[u]=g<<8|g>>>24,p[u]=g,r?(r=R^e[e[e[m^R]]],n^=e[e[n]]):r=n=1;}}();var u=[0,1,2,4,8,16,32,64,128,27,54],R=n.AES=t.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var e=this._keyPriorReset=this._key,t=e.words,r=e.sigBytes/4,n=4*((this._nRounds=r+6)+1),i=this._keySchedule=[],o=0;o<n;o++)if(o<r)i[o]=t[o];else {var a=i[o-1];o%r?r>6&&o%r==4&&(a=s[a>>>24]<<24|s[a>>>16&255]<<16|s[a>>>8&255]<<8|s[255&a]):(a=s[(a=a<<8|a>>>24)>>>24]<<24|s[a>>>16&255]<<16|s[a>>>8&255]<<8|s[255&a],a^=u[o/r|0]<<24),i[o]=i[o-r]^a;}for(var c=this._invKeySchedule=[],d=0;d<n;d++)o=n-d,a=d%4?i[o]:i[o-4],c[d]=d<4||o<=4?a:l[s[a>>>24]]^E[s[a>>>16&255]]^S[s[a>>>8&255]]^p[s[255&a]];}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,o,a,c,d,s);},decryptBlock:function(e,t){var r=e[t+1];e[t+1]=e[t+3],e[t+3]=r,this._doCryptBlock(e,t,this._invKeySchedule,l,E,S,p,i),r=e[t+1],e[t+1]=e[t+3],e[t+3]=r;},_doCryptBlock:function(e,t,r,n,s,i,o,a){for(var c=this._nRounds,d=e[t]^r[0],l=e[t+1]^r[1],E=e[t+2]^r[2],S=e[t+3]^r[3],p=4,u=1;u<c;u++){var R=n[d>>>24]^s[l>>>16&255]^i[E>>>8&255]^o[255&S]^r[p++],h=n[l>>>24]^s[E>>>16&255]^i[S>>>8&255]^o[255&d]^r[p++],m=n[E>>>24]^s[S>>>16&255]^i[d>>>8&255]^o[255&l]^r[p++],g=n[S>>>24]^s[d>>>16&255]^i[l>>>8&255]^o[255&E]^r[p++];d=R,l=h,E=m,S=g;}R=(a[d>>>24]<<24|a[l>>>16&255]<<16|a[E>>>8&255]<<8|a[255&S])^r[p++],h=(a[l>>>24]<<24|a[E>>>16&255]<<16|a[S>>>8&255]<<8|a[255&d])^r[p++],m=(a[E>>>24]<<24|a[S>>>16&255]<<16|a[d>>>8&255]<<8|a[255&l])^r[p++],g=(a[S>>>24]<<24|a[d>>>16&255]<<16|a[l>>>8&255]<<8|a[255&E])^r[p++],e[t]=R,e[t+1]=h,e[t+2]=m,e[t+3]=g;},keySize:8});e.AES=t._createHelper(R);}(),r.AES);})),O((function(e,t){var r;e.exports=(r=Cr,function(){var e=r,t=e.lib,n=t.WordArray,s=t.BlockCipher,i=e.algo,o=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],d=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],l=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],E=i.DES=s.extend({_doReset:function(){for(var e=this._key.words,t=[],r=0;r<56;r++){var n=o[r]-1;t[r]=e[n>>>5]>>>31-n%32&1;}for(var s=this._subKeys=[],i=0;i<16;i++){var d=s[i]=[],l=c[i];for(r=0;r<24;r++)d[r/6|0]|=t[(a[r]-1+l)%28]<<31-r%6,d[4+(r/6|0)]|=t[28+(a[r+24]-1+l)%28]<<31-r%6;for(d[0]=d[0]<<1|d[0]>>>31,r=1;r<7;r++)d[r]=d[r]>>>4*(r-1)+3;d[7]=d[7]<<5|d[7]>>>27;}var E=this._invSubKeys=[];for(r=0;r<16;r++)E[r]=s[15-r];},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys);},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys);},_doCryptBlock:function(e,t,r){this._lBlock=e[t],this._rBlock=e[t+1],S.call(this,4,252645135),S.call(this,16,65535),p.call(this,2,858993459),p.call(this,8,16711935),S.call(this,1,1431655765);for(var n=0;n<16;n++){for(var s=r[n],i=this._lBlock,o=this._rBlock,a=0,c=0;c<8;c++)a|=d[c][((o^s[c])&l[c])>>>0];this._lBlock=o,this._rBlock=i^a;}var E=this._lBlock;this._lBlock=this._rBlock,this._rBlock=E,S.call(this,1,1431655765),p.call(this,8,16711935),p.call(this,2,858993459),S.call(this,16,65535),S.call(this,4,252645135),e[t]=this._lBlock,e[t+1]=this._rBlock;},keySize:2,ivSize:2,blockSize:2});function S(e,t){var r=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=r,this._lBlock^=r<<e;}function p(e,t){var r=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=r,this._rBlock^=r<<e;}e.DES=s._createHelper(E);var u=i.TripleDES=s.extend({_doReset:function(){var e=this._key.words;this._des1=E.createEncryptor(n.create(e.slice(0,2))),this._des2=E.createEncryptor(n.create(e.slice(2,4))),this._des3=E.createEncryptor(n.create(e.slice(4,6)));},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t);},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t);},keySize:6,ivSize:2,blockSize:2});e.TripleDES=s._createHelper(u);}(),r.TripleDES);})),O((function(e,t){var r;e.exports=(r=Cr,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=n.RC4=t.extend({_doReset:function(){for(var e=this._key,t=e.words,r=e.sigBytes,n=this._S=[],s=0;s<256;s++)n[s]=s;s=0;for(var i=0;s<256;s++){var o=s%r,a=t[o>>>2]>>>24-o%4*8&255;i=(i+n[s]+a)%256;var c=n[s];n[s]=n[i],n[i]=c;}this._i=this._j=0;},_doProcessBlock:function(e,t){e[t]^=i.call(this);},keySize:8,ivSize:0});function i(){for(var e=this._S,t=this._i,r=this._j,n=0,s=0;s<4;s++){r=(r+e[t=(t+1)%256])%256;var i=e[t];e[t]=e[r],e[r]=i,n|=e[(e[t]+e[r])%256]<<24-8*s;}return this._i=t,this._j=r,n}e.RC4=t._createHelper(s);var o=n.RC4Drop=s.extend({cfg:s.cfg.extend({drop:192}),_doReset:function(){s._doReset.call(this);for(var e=this.cfg.drop;e>0;e--)i.call(this);}});e.RC4Drop=t._createHelper(o);}(),r.RC4);})),O((function(e,t){var r;e.exports=(r=Cr,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=[],i=[],o=[],a=n.Rabbit=t.extend({_doReset:function(){for(var e=this._key.words,t=this.cfg.iv,r=0;r<4;r++)e[r]=16711935&(e[r]<<8|e[r]>>>24)|4278255360&(e[r]<<24|e[r]>>>8);var n=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],s=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];for(this._b=0,r=0;r<4;r++)c.call(this);for(r=0;r<8;r++)s[r]^=n[r+4&7];if(t){var i=t.words,o=i[0],a=i[1],d=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),l=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),E=d>>>16|4294901760&l,S=l<<16|65535&d;for(s[0]^=d,s[1]^=E,s[2]^=l,s[3]^=S,s[4]^=d,s[5]^=E,s[6]^=l,s[7]^=S,r=0;r<4;r++)c.call(this);}},_doProcessBlock:function(e,t){var r=this._X;c.call(this),s[0]=r[0]^r[5]>>>16^r[3]<<16,s[1]=r[2]^r[7]>>>16^r[5]<<16,s[2]=r[4]^r[1]>>>16^r[7]<<16,s[3]=r[6]^r[3]>>>16^r[1]<<16;for(var n=0;n<4;n++)s[n]=16711935&(s[n]<<8|s[n]>>>24)|4278255360&(s[n]<<24|s[n]>>>8),e[t+n]^=s[n];},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,r=0;r<8;r++)i[r]=t[r];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<i[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<i[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<i[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<i[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<i[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<i[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<i[6]>>>0?1:0)|0,this._b=t[7]>>>0<i[7]>>>0?1:0,r=0;r<8;r++){var n=e[r]+t[r],s=65535&n,a=n>>>16,c=((s*s>>>17)+s*a>>>15)+a*a,d=((4294901760&n)*n|0)+((65535&n)*n|0);o[r]=c^d;}e[0]=o[0]+(o[7]<<16|o[7]>>>16)+(o[6]<<16|o[6]>>>16)|0,e[1]=o[1]+(o[0]<<8|o[0]>>>24)+o[7]|0,e[2]=o[2]+(o[1]<<16|o[1]>>>16)+(o[0]<<16|o[0]>>>16)|0,e[3]=o[3]+(o[2]<<8|o[2]>>>24)+o[1]|0,e[4]=o[4]+(o[3]<<16|o[3]>>>16)+(o[2]<<16|o[2]>>>16)|0,e[5]=o[5]+(o[4]<<8|o[4]>>>24)+o[3]|0,e[6]=o[6]+(o[5]<<16|o[5]>>>16)+(o[4]<<16|o[4]>>>16)|0,e[7]=o[7]+(o[6]<<8|o[6]>>>24)+o[5]|0;}e.Rabbit=t._createHelper(a);}(),r.Rabbit);})),O((function(e,t){var r;e.exports=(r=Cr,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=[],i=[],o=[],a=n.RabbitLegacy=t.extend({_doReset:function(){var e=this._key.words,t=this.cfg.iv,r=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],n=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];this._b=0;for(var s=0;s<4;s++)c.call(this);for(s=0;s<8;s++)n[s]^=r[s+4&7];if(t){var i=t.words,o=i[0],a=i[1],d=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),l=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),E=d>>>16|4294901760&l,S=l<<16|65535&d;for(n[0]^=d,n[1]^=E,n[2]^=l,n[3]^=S,n[4]^=d,n[5]^=E,n[6]^=l,n[7]^=S,s=0;s<4;s++)c.call(this);}},_doProcessBlock:function(e,t){var r=this._X;c.call(this),s[0]=r[0]^r[5]>>>16^r[3]<<16,s[1]=r[2]^r[7]>>>16^r[5]<<16,s[2]=r[4]^r[1]>>>16^r[7]<<16,s[3]=r[6]^r[3]>>>16^r[1]<<16;for(var n=0;n<4;n++)s[n]=16711935&(s[n]<<8|s[n]>>>24)|4278255360&(s[n]<<24|s[n]>>>8),e[t+n]^=s[n];},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,r=0;r<8;r++)i[r]=t[r];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<i[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<i[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<i[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<i[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<i[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<i[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<i[6]>>>0?1:0)|0,this._b=t[7]>>>0<i[7]>>>0?1:0,r=0;r<8;r++){var n=e[r]+t[r],s=65535&n,a=n>>>16,c=((s*s>>>17)+s*a>>>15)+a*a,d=((4294901760&n)*n|0)+((65535&n)*n|0);o[r]=c^d;}e[0]=o[0]+(o[7]<<16|o[7]>>>16)+(o[6]<<16|o[6]>>>16)|0,e[1]=o[1]+(o[0]<<8|o[0]>>>24)+o[7]|0,e[2]=o[2]+(o[1]<<16|o[1]>>>16)+(o[0]<<16|o[0]>>>16)|0,e[3]=o[3]+(o[2]<<8|o[2]>>>24)+o[1]|0,e[4]=o[4]+(o[3]<<16|o[3]>>>16)+(o[2]<<16|o[2]>>>16)|0,e[5]=o[5]+(o[4]<<8|o[4]>>>24)+o[3]|0,e[6]=o[6]+(o[5]<<16|o[5]>>>16)+(o[4]<<16|o[4]>>>16)|0,e[7]=o[7]+(o[6]<<8|o[6]>>>24)+o[5]|0;}e.RabbitLegacy=t._createHelper(a);}(),r.RabbitLegacy);})),O((function(e,t){e.exports=Cr;})));const Nr={isExisting:(e,t)=>Object.keys(t).filter((t=>t===e)).length>0,isValidString:e=>{if(!Hi(e)||!Hi(e)||Li(e))throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return !0},hasCrypto:()=>Or||(zt.log.ERROR([null,_t.ASYNC_MESSAGING,null,Ft.PERSISTENT_MESSAGE.ERRORS.NO_DEPENDENCY]),!1),canEncrypt:(e,t)=>{if(wi(t)&&Li(e))throw new Error(`${Ft.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED}, ${Ft.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_PROVIDED}`);if(Li(e))throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_SELECTED);if(wi(t))throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return !0},canDecrypt:e=>{if(wi(e))throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return !0}};class Dr{static throwError(e,t,r="",n="",s){throw zt.log.ERROR([e,t,null,`${r}${n?` - ${n}`:""}`],s),new Error(`${r}${n?` - ${n}`:""}`)}}const vr={getMessageConfig:(e,t,r)=>{const{peerInformations:n,room:s,user:i}=e;let o,a=!1;if(!s.inRoom||!i)throw Error(Ft.ROOM.ERRORS.NOT_IN_ROOM);return Array.isArray(t)&&!bi(t)?(o=t,a=!0):t&&Hi(t)?(o=[t],a=!0):o=Object.keys(n),o.forEach(((e,t)=>{n[e]?e===Pt.MCU&&o.splice(t,1):(zt.log.WARN([e,_t.MESSAGING,null,`${Ft.MESSAGING.ERRORS.DROPPING_MESSAGE} - ${Ft.PEER_CONNECTION.NO_PEER_CONNECTION}`]),o.splice(t,1));})),0===o.length&&zt.log.WARN([null,_t.MESSAGING,null,Ft.PEER_CONNECTION.NO_PEER_CONNECTION]),{listOfPeers:o,isPrivate:a,peerSessionId:r}},sendMessageToSig:(e,t,r,n="",s)=>{(new ii).sendUserMessage(e,t,n||r),vr.dispatchOnIncomingMessage(e,t,r,!0,s);},dispatchOnIncomingMessage:(e,t,r,n,s)=>{const{room:i,user:o}=e;zt.log.DEBUG([n?null:s,_t.MESSAGING,null,`${Ft.MESSAGING.RECEIVED_MESSAGE} - isPrivate: ${t.isPrivate}`]);const a={targetPeerId:n?t.isPrivate?s:null:o.sid,content:r,senderPeerId:t.peerSessionId||(n?o.sid:s),isDataChannel:!1,isPrivate:t.isPrivate,timeStamp:to()};n&&(a.listOfPeers=t.listOfPeers),Vt(ge({room:Ri.getRoomInfo(i),message:a,isSelf:n,peerId:n?o.sid:s,peerInfo:n?fi.getCurrentSessionInfo(i):fi.getPeerInfo(s,i)}));},trySendMessage:(e,t,r,n)=>{try{const s=vr.getMessageConfig(e,r,n);vr.sendMessageToSig(e,s,t,null,r);}catch(e){Dr.throwError(r,Ft.MESSAGING.ERRORS.FAILED_SENDING_MESSAGE);}}},yr={deleteEncryptSecrets:(e,t,r)=>{const n={encryptSecrets:e,selectedSecretId:t};if(r){if(!n.encryptSecrets[r])throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);n.selectedSecretId===r&&(n.selectedSecretId=yr.setSelectedSecretId()),delete n.encryptSecrets[r];}else zt.log.DEBUG([null,_t.ENCRYPTED_MESSAGING,null,`${Ft.MESSAGING.ENCRYPTION.DELETE_ALL}`]),n.selectedSecretId=yr.setSelectedSecretId(),n.encryptSecrets={};return n},setEncryptSecret:(e,t,r)=>{const n=e;if((e=>{if(!e)throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);return yr.utils.isValidString(e),!0})(t)&&((e,t)=>{if(!e)throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(yr.utils.isValidString(e),yr.utils.isExisting(e,t))throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_UNIQUE);return !0})(r,n))return n[r]=t,n},setSelectedSecretId:(e,t)=>{if(!t)return "";if(yr.utils.isValidString(t),!e[t])throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return t},utils:Nr,getMessageConfig:(e,t,r,n,s,i)=>{const o=vr.getMessageConfig(e,t,i);return yr.utils.hasCrypto()&&yr.utils.canEncrypt(n,r)&&(o.secretId=n),s&&(o.isPersistent=s),o},encryptMessage:(e,t,r=!1)=>{if(r)try{return Or.AES.decrypt(e,t).toString(Or.enc.Utf8)}catch(e){throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET)}return Or.AES.encrypt(e,t).toString()},tryDecryptMessage:(e,t,r)=>{const n=yr.encryptMessage(e,r[t],!0);if(Li(n))throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET);return n}},Pr=e=>{const t=gi.getCurrentSessionInfo(e);return delete t.room,t},Mr={};class kr{constructor(e){const{room:t,user:r}=e;return Mr[t.id]||(Mr[t.id]=this),this.room=t,this.peerId=r.sid,this.encryptSecrets={},this.selectedSecretId="",Mr[t.id]}setEncryptSecret(e,t){try{this.encryptSecrets=yr.setEncryptSecret(this.encryptSecrets,e,t),this.dispatchEncryptSecretEvent();}catch(e){Dr.throwError(null,_t.ASYNC_MESSAGING,Ft.MESSAGING.ENCRYPTION.ERRORS.SET_ENCRYPT_SECRET,e.message);}}getEncryptSecrets(){return this.encryptSecrets}deleteEncryptSecrets(e){try{const t=yr.deleteEncryptSecrets(this.encryptSecrets,this.selectedSecretId,e);this.encryptSecrets=t.encryptSecrets,this.selectedSecretId=t.selectedSecretId,this.dispatchEncryptSecretEvent();}catch(e){Dr.throwError(null,_t.ASYNC_MESSAGING,Ft.MESSAGING.ENCRYPTION.ERRORS.DELETE_ENCRYPT_SECRETS,e.message);}}setSelectedSecretId(e){try{this.selectedSecretId=yr.setSelectedSecretId(this.encryptSecrets,e),this.dispatchEncryptSecretEvent();}catch(e){Dr.throwError(null,_t.ASYNC_MESSAGING,Ft.MESSAGING.ENCRYPTION.ERRORS.SET_SELECTED_SECRET,e.message);}}getSelectedSecretId(){return this.selectedSecretId}dispatchEncryptSecretEvent(){Vt(((e={})=>new Se("encryptSecretsUpdated",{detail:e}))({room:Ri.getRoomInfo(this.room),encryptSecrets:this.encryptSecrets,selectedSecretId:this.selectedSecretId,peerInfo:Pr(this.room),peerId:this.peerId}));}canEncrypt(e){try{return !!yr.utils.canEncrypt(this.selectedSecretId,this.encryptSecrets)&&(yr.utils.isValidString(this.selectedSecretId)&&yr.utils.isValidString(this.encryptSecrets[this.selectedSecretId]))}catch(t){if(e)throw new Error(t.message);return !1}}decryptStoredMessages(e,t){if(yr.utils.canEncrypt(t,this.encryptSecrets)&&!Object.keys(this.encryptSecrets).filter((e=>e===t)).length)throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return this.decryptMessage(e,t)}decryptMessage(e,t=""){if(t&&yr.utils.canDecrypt(this.encryptSecrets))return yr.tryDecryptMessage(e,t,this.encryptSecrets);throw new Error(Ft.MESSAGING.ENCRYPTION.ERRORS.INVALID_SECRETS)}sendMessage(e,t,r,n=!1,s){const i=Wi(e);if(Vi(t,"message","sendMessage")&&i)try{zt.log.DEBUG([null,_t.ASYNC_MESSAGING,null,Ft.MESSAGING.ENCRYPTION.SEND_MESSAGE]);const e=yr.getMessageConfig(i,r,this.encryptSecrets,this.selectedSecretId,n,s),o=yr.encryptMessage(t,this.encryptSecrets[this.selectedSecretId]);vr.sendMessageToSig(i,e,t,o,r);}catch(e){Dr.throwError(r,_t.ASYNC_MESSAGING,Ft.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message);}}static deleteEncryptedInstance(e){delete Mr[e.id];}}const wr=(e,t)=>({targetPeerId:t,senderPeerId:e.peerSessionId||e.mid,content:e.data,timeStamp:eo(e.timeStamp),isPrivate:!1,isDataChannel:!1}),br={};class Lr{constructor(e){const{user:t,room:r,hasPersistentMessage:n}=e;return br[r.id]||(br[r.id]=this),this.room=r,this.peerId=t.sid,this.isPersistent=n,this.hasPersistentMessage=n,br[r.id]}setMessagePersistence(e){if(!xi(e))throw Dr.throwError(null,_t.ASYNC_MESSAGING,Ft.MESSAGING.PERSISTENCE.ERRORS.FAILED_SETTING_PERSISTENCE,Ft.MESSAGING.PERSISTENCE.ERRORS.INVALID_TYPE);if(!this.hasPersistentMessage)throw this.isPersistent=e,Dr.throwError(null,_t.ASYNC_MESSAGING,Ft.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);this.isPersistent=e,Vt(((e={})=>new Se("persistentMessageState",{detail:e}))({room:Ri.getRoomInfo(this.room),isPersistent:this.isPersistent,peerInfo:Pr(this.room),peerId:this.peerId}));}getMessagePersistence(){return this.isPersistent}sendMessage(e,t,r,n){const s=Wi(e),i=!r||Array.isArray(r)&&bi(r);if(Vi(t,"message","sendMessage")&&s)try{zt.log.DEBUG([null,_t.ASYNC_MESSAGING,null,Ft.MESSAGING.PERSISTENCE.SEND_MESSAGE]);const o=new kr(s);if(!i)throw new Error(Ft.MESSAGING.PERSISTENCE.ERRORS.PRIVATE_MESSAGE);o.canEncrypt(!0)&&o.sendMessage(e,t,r,this.isPersistent,n);}catch(e){Dr.throwError(r,_t.ASYNC_MESSAGING,Ft.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message);}}getStoredMessages(e){const t=ko.getSkylinkState(this.room.id);this.hasPersistentMessage?(new ii).getStoredMessages(t,e):zt.log.WARN([this.peerId,_t.ASYNC_MESSAGING,null,`${Ft.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED}`]);}canPersist(){if(this.hasPersistentMessage)return !!this.isPersistent||(zt.log.DEBUG([null,_t.ASYNC_MESSAGING,null,Ft.MESSAGING.PERSISTENCE.NOT_PERSISTED]),!1);if(this.isPersistent)throw zt.log.DEBUG([null,_t.ASYNC_MESSAGING,null,`${Ft.MESSAGING.PERSISTENCE.IS_PERSISTENT_CONFIG} ${this.isPersistent}`]),new Error(Ft.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);return !1}static processStoredMessages(e){const t=ko.getSkylinkState(e.rid),{room:r}=t,n=e.mid,s=JSON.parse(e.data),i=new kr(t),o=[];zt.log.DEBUG([n,_t.ASYNC_MESSAGING,null,Ft.MESSAGING.PERSISTENCE.STORED_MESSAGES],s);try{for(let e=0;e<s.length;e+=1)s[e].data=i.decryptStoredMessages(s[e].data,s[e].secretId),o.push(wr(s[e],n));}catch(e){throw Dr.throwError(n,_t.ASYNC_MESSAGING,Ft.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}Vt(((e={})=>new Se("storedMessages",{detail:e}))({room:Ri.getRoomInfo(r),storedMessages:o,isSelf:!0,peerId:n,peerInfo:fi.getCurrentSessionInfo(r)}));}static deleteAsyncInstance(e){delete br[e.id];}}class Gr{static sendMessage(e,t,r,n){const s=Wi(e);if(Vi(t,"message","sendMessage")&&s){const i=new kr(s),o=new Lr(s);o.canPersist()?o.sendMessage(e,t,r,n):i.canEncrypt()?i.sendMessage(e,t,r,n):vr.trySendMessage(s,t,r,n);}}static sendP2PMessage(e,t,r){const n=Wi(e);Vi(t,"message","sendP2PMessage")&&n&&lo.sendP2PMessage(e,t,r);}static processMessage(e,t){const{mid:r,target:n,rid:s,secretId:i,data:o,peerSessionId:a}=e,c=ko.getSkylinkState(s),d=r;let l=o;if(i)try{l=new kr(c).decryptMessage(o,i);}catch(e){Dr.throwError(d,_t.ENCRYPTED_MESSAGING,Ft.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message);}vr.dispatchOnIncomingMessage(c,{isPrivate:xi(t)?!t:!!n,peerSessionId:a},l,!1,d);}}const Ur={udp:[3478,19302,19303,19304],tcp:[80,443],both:[19305,19306,19307,19308]},Fr={STUN:"stun",TURN:"turn",TEMASYS:"temasys",DEFAULT_TURN_SERVER:"turn.temasys.io",TCP:"TCP",UDP:"UDP"},Br=(e,t)=>{const{urls:r}=e;return [{urls:r,username:t.iceServers[1].username||null,credential:t.iceServers[1].credential||null}]};class xr extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:!1,candidate_id:null,candidate_sdp_mid:null,candidate_sdp_mindex:null,candidate_candidate:null,error:null};}send(e,t,r,n,s,i){const o=ko.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=r,this.model.client_id=o.clientId,this.model.state=t,this.model.is_remote=!!n,this.model.candidate_id=n||null,this.model.candidate_sdp_mid=s.sdpMid,this.model.candidate_sdp_mindex=s.sdpMLineIndex,this.model.candidate_candidate=s.candidate,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.error=("string"==typeof i?i:i&&i.message)||null,this.addToStatsBuffer("iceCandidate",this.model,this.endpoints.iceCandidate),this.manageStatsBuffer();}}const Hr=new xr,Vr=(e,t,r,n,s,i)=>{const{STATS_MODULE:o,ICE_CANDIDATE:a}=Ft,{CANDIDATE_PROCESSING_STATE:c,TAGS:d}=Ut;zt.log.WARN([t,d.CANDIDATE_HANDLER,`${r}:${n}`,a.FAILED_ADDING_CANDIDATE],i),Vt(_e({room:Ri.getRoomInfo(e),state:c.PROCESS_ERROR,peerId:t,candidateId:r,candidateType:n,candidate:s,error:i})),Hr.send(e.id,o.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,t,r,s,i);};const jr=new class extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,bundlePolicy:null,rtcpMuxPolicy:null};}send(e,t,r,n){const s=ko.getSkylinkState(e);this.model.client_id=s.clientId,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=r,this.model.state=t,this.model.is_remote=n,this.model.bundlePolicy=qt(bt.PEER_CONNECTION,{rid:e}).bundlePolicy,this.model.rtcpMuxPolicy=qt(bt.PEER_CONNECTION,{rid:e}).rtcpMuxPolicy,this.addToStatsBuffer("iceGathering",this.model,this.endpoints.iceGathering),this.manageStatsBuffer();}},$r=(e,t)=>{const r=ko.getInitOptions(),n=ko.getSkylinkState(e),s={iceServerName:null,iceServerPorts:Ur,iceServerProtocol:Fr.STUN,iceServers:[{urls:[]},{urls:[]}]},{iceServer:i,enableTURNServer:o,forceTURNSSL:a,TURNServerTransport:c,enableSTUNServer:d,usePublicSTUN:l}=r;if(t.forEach((e=>{if(0===e.url.indexOf(`${Fr.STUN}:`))e.url.indexOf(`${Fr.TEMASYS}`)>0?s.iceServerName=(e.url.split(":")[1]||"").split("?")[0]||null:s.iceServers[0].urls.push(e.url);else if(0===e.url.indexOf("turn:")&&e.url.indexOf("@")>0&&e.credential&&!s.iceServers[1].username&&!s.iceServers[1].credential){const t=(e.url.split(":")[1]||"").split("@");s.iceServerName=(t[1]||"").split("?")[0],s.iceServers[1].username=t[0],s.iceServers[1].credential=e.credential,s.iceServerProtocol=Fr.TURN;}})),i)return {iceServers:Br(i,s)};if(s.iceServerName=s.iceServerName||Fr.DEFAULT_TURN_SERVER,s.iceServerProtocol!==Fr.TURN||o||a){const e=(e=>{const{forceTURNSSL:t,serverConfig:r}=e,n={tcp:r.iceServerPorts.tcp,udp:r.iceServerPorts.udp,both:r.iceServerPorts.both,iceServerProtocol:r.iceServerProtocol,iceServerPorts:r.iceServerPorts};return t?(n.iceServerPorts.udp=[],n.iceServerProtocol="turns"):Zi(yt.FIREFOX)&&(n.udp=[3478],n.both=[]),n})({forceTURNSSL:a,enableTURNServer:o,CONSTANTS:Fr,serverConfig:s});s.iceServerPorts.tcp=e.tcp,s.iceServerPorts.udp=e.udp,s.iceServerPorts.both=e.both,s.iceServerProtocol=e.iceServerProtocol;}else s.iceServerProtocol=Fr.STUN;const E=(e=>{const{TURNServerTransport:t,forceTURNSSL:r,udp:n,tcp:s,both:i}=e,o={udp:[],tcp:[],both:[]};return t!==qe.UDP||r?t===qe.TCP?(o.tcp=s.concat(i),o.udp=[],o.both=[]):t===qe.NONE?(o.tcp=[],o.udp=[]):(o.tcp=s,o.udp=n,o.both=i):(o.udp=n.concat(i),o.tcp=[],o.both=[]),o})({forceTURNSSL:a,TURNServerTransport:c,udp:s.iceServerPorts.udp,tcp:s.iceServerPorts.tcp,both:s.iceServerPorts.both});return s.iceServerPorts.tcp=E.tcp,s.iceServerPorts.udp=E.udp,s.iceServerPorts.both=E.both,s.iceServerProtocol===Fr.STUN&&(s.iceServerPorts.tcp=[]),s.iceServerProtocol!==Fr.STUN||d||n.hasMCU?(s.iceServerPorts.tcp.forEach((e=>{s.iceServers[1].urls.push(`${s.iceServerProtocol}:${s.iceServerName}:${e}?transport=tcp`);})),s.iceServerPorts.udp.forEach((e=>{s.iceServers[1].urls.push(`${s.iceServerProtocol}:${s.iceServerName}:${e}?transport=udp`);})),s.iceServerPorts.both.forEach((e=>{s.iceServers[1].urls.push(`${s.iceServerProtocol}:${s.iceServerName}:${e}`);})),l||s.iceServers.splice(0,1)):s.iceServers=[],bi(s.iceServers)&&r.forceTURN&&!n.hasMCU&&zt.log.WARN([null,_t.PEER_CONNECTION,null,Ft.ICE_CONNECTION.TURN_NOT_ENABLED]),{iceServers:s.iceServers}},Wr=(e,t)=>{const r=ko.getSkylinkState(t.id),n=r.peerCandidatesQueue[e]||[],s=r.peerConnections[e],{TAGS:i,PEER_CONNECTION_STATE:o}=Ut;for(let t=0;t<n.length;t+=1){const a=n[t];if(a){const t=a[1],n=a[0],s=t.candidate.split(" ")[7];zt.log.DEBUG([e,i.CANDIDATE_HANDLER,`${n}:${s}`,Ft.ICE_CANDIDATE.ADD_BUFFERED_CANDIDATE]),Jr.addIceCandidate(e,n,s,t,r);}else if(s&&s.signalingState!==o.CLOSED)try{s.addIceCandidate(null),zt.log.DEBUG([e,i.CANDIDATE_HANDLER,null,Ft.ICE_CANDIDATE.CANDIDATE_ADDED]);}catch(t){zt.log.DEBUG([e,i.CANDIDATE_HANDLER,null,Ft.ICE_CANDIDATE.FAILED_ADDING_CANDIDATE]);}}delete r.peerCandidatesQueue[e],lo.signalingEndOfCandidates(e,r);},Kr=(e,t,r,n,s)=>{const i=ko.getSkylinkState(s.room.id),{peerConnections:o,room:a}=i,c=o[e],d={candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex},{STATS_MODULE:l,ICE_CANDIDATE:E,PEER_CONNECTION:S,SESSION_DESCRIPTION:p}=Ft,{CANDIDATE_PROCESSING_STATE:u,PEER_CONNECTION_STATE:R,TAGS:h}=Ut;zt.log.DEBUG([e,h.CANDIDATE_HANDLER,`${t}:${r}`,E.ADDING_CANDIDATE]),Vt(_e({peerId:e,room:Ri.getRoomInfo(a),candidateType:r,candidate:d,candidateId:t,state:u.PROCESSING,error:null})),Hr.send(a.id,l.HANDLE_ICE_GATHERING_STATS.PROCESSING,e,t,d);let m=null;if(c||(m=S.NO_PEER_CONNECTION),c.signalingState===R.CLOSED&&(m=S.PEER_CONNECTION_CLOSED),c.remoteDescription&&c.remoteDescription.sdp||(m=p.NO_REMOTE_DESCRIPTION),e!==Pt.REC_SRV&&-1===c.remoteDescription.sdp.indexOf(`\r\na=mid:${d.sdpMid}\r\n`)&&(m=S.SDP_ERROR),m)return zt.log.WARN([e,h.CANDIDATE_HANDLER,`${t}:${r}`,`${E.DROPPING_CANDIDATE} - ${m}`]),Vt(_e({peerId:e,room:Ri.getRoomInfo(a),candidateType:r,candidate:d,candidateId:t,state:Je.DROPPED,error:new Error(m)})),Hr.send(a.id,l.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,e,t,d,m);try{c.addIceCandidate(d).then((()=>{((e,t,r,n,s)=>{const{STATS_MODULE:i,ICE_CANDIDATE:o}=Ft,{CANDIDATE_PROCESSING_STATE:a,TAGS:c}=Ut;zt.log.INFO([t,c.CANDIDATE_HANDLER,`${r}:${n}`,o.CANDIDATE_ADDED]),Vt(_e({room:Ri.getRoomInfo(e),state:a.PROCESS_SUCCESS,peerId:t,candidateId:r,candidateType:n,candidate:s,error:null})),Hr.send(e.id,i.HANDLE_ICE_GATHERING_STATS.PROCESS_SUCCESS,t,r,s);})(a,e,t,r,d);})).catch((n=>{Vr(a,e,t,r,d,n);}));}catch(n){Vr.bind(c,a,e,t,r,d,n);}},zr=(e,t,r)=>{const n=ko.getSkylinkState(r.id),s=ko.getInitOptions(),i=n.peerConnections[e],o=new ii;let a=n.gatheredCandidates[e];const{filterCandidatesType:c}=s,{CANDIDATE_GENERATION_STATE:d,TAGS:l}=Ut;if(!i)return zt.log.WARN([e,l.CANDIDATE_HANDLER,null,Ft.PEER_CONNECTION.NO_PEER_CONNECTION],t),null;if(t.candidate){i.gathering||(zt.log.INFO([e,l.CANDIDATE_HANDLER,null,Ft.ICE_CONNECTION.ICE_GATHERING_STARTED],t),i.gathering=!0,i.gathered=!1,Vt(Ae({room:Ri.getRoomInfo(r),peerId:e,state:Ye.GATHERING})),jr.send(r.id,d.GATHERING,e,!1));const E=t.candidate.split(" ")[7];if(zt.log.DEBUG([e,l.CANDIDATE_HANDLER,E,Ft.ICE_CANDIDATE.CANDIDATE_GENERATED],t),"endOfCandidates"===E||!(i&&i.localDescription&&i.localDescription.sdp&&i.localDescription.sdp.indexOf(`\r\na=mid:${t.sdpMid}\r\n`)>-1))return zt.log.WARN([e,l.CANDIDATE_HANDLER,E,Ft.ICE_CONNECTION.DROP_EOC],t),null;if(c[E]){if(!n.hasMCU||!s.forceTURN)return zt.log.WARN([e,l.CANDIDATE_HANDLER,E,Ft.ICE_CANDIDATE.FILTERED_CANDIDATE],t),null;zt.log.WARN([e,l.CANDIDATE_HANDLER,E,Ft.ICE_CANDIDATE.FILTERING_FLAG_NOT_HONOURED],t);}a||(a={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),a.sending[E].push({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),n.gatheredCandidates[e]=a,ko.setSkylinkState(n,r.id),zt.log.DEBUG([e,l.CANDIDATE_HANDLER,E,Ft.ICE_CANDIDATE.SENDING_CANDIDATE],t),o.sendCandidate(e,n,t);}else {if(zt.log.INFO([e,l.CANDIDATE_HANDLER,null,Ft.ICE_CONNECTION.ICE_GATHERING_COMPLETED]),i.gathered)return null;if(i.gathering=!1,i.gathered=!0,Vt(Ae({peerId:e,state:Ye.COMPLETED,room:r})),jr.send(r.id,d.COMPLETED,e,!1),n.gatheredCandidates[e]){setTimeout((()=>{if(!n.gatheredCandidates[e])return;ko.getSkylinkState(r.id)?o.sendMessage({type:Rt.END_OF_CANDIDATES,noOfExpectedCandidates:n.gatheredCandidates[e].sending.srflx.length+n.gatheredCandidates[e].sending.host.length+n.gatheredCandidates[e].sending.relay.length,mid:n.user.sid,target:e,rid:r.id}):zt.log.WARN([e,l.CANDIDATE_HANDLER,null,`${Ft.ICE_CONNECTION.DROP_EOC} peer has left the room`]);}),6e3);}}return null},Yr=(e,t,r,n,s)=>{const{STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:i}}=Ft,o=s,{room:a}=o,c=new xr;zt.log.DEBUG([e,_t.CANDIDATE_HANDLER,`${t}:${r}`,Ft.ICE_CANDIDATE.ADD_CANDIDATE_TO_BUFFER]),c.send(a.id,i.BUFFERED,e,t,n),Vt(_e({room:Ri.getRoomInfo(a),state:Je.BUFFERED,peerId:e,candidateId:t,candidateType:r,candidate:n.candidate,error:null})),o.peerCandidatesQueue[e]=o.peerCandidatesQueue[e]||[],o.peerCandidatesQueue[e].push([t,n]),ko.setSkylinkState(o,a.id);};class Jr{static setIceServers(e,t){return $r(e,t)}static addIceCandidateFromQueue(e,t){return Wr(e,t)}static addIceCandidateToQueue(e,t,r,n,s){return Yr(e,t,r,n,s)}static addIceCandidate(e,t,r,n,s){return Kr(e,t,r,n,s)}static onIceCandidate(e,t,r){return zr(e,t,r)}}const Qr=(e,t)=>e.id===t.id;class qr extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,local_candidate:{},remote_candidate:{}};}send(e,t,r){try{const n=ko.getSkylinkState(e);if(!n)return;this.model.room_id=e,this.model.user_id=n&&n.user&&n.user.sid||null,this.model.peer_id=r,this.model.client_id=n.clientId,this.model.state=t,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),lo.retrieveStatistics(e,r,ko.getInitOptions().beSilentOnStatsLogs).then((e=>{e&&["local","remote"].forEach((t=>{const r=e.selectedCandidatePair[t];if(r){const e=this.model[`${t}_candidate`];e.ip_address=r.ipAddress||null,e.port_number=r.portNumber||null,e.candidate_type=r.candidateType||null,e.protocol=r.transport||null,e.priority=r.priority||null,"local"===t&&(this.model.local_candidate.network_type=r.networkType||null);}})),this.postStats(this.endpoints.iceConnection,this.model);})).catch((e=>{zt.log.DEBUG(Ft.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.RETRIEVE_FAILED,e);}));}catch(e){zt.log.DEBUG(Ft.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.SEND_FAILED,e);}}}const Xr=(e,t,r,n)=>{const s=e[t]["send"===r?"sending":"receiving"][n];return ["number","string","boolean"].indexOf(typeof s)>-1?s:null};class Zr extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,audio_send:{tracks:[]},audio_recv:{},video_send:{tracks:[]},video_recv:{},error:null},this.stats=null;}gatherSendAudioPacketsStats(){this.model.audio_send.bytes=Xr(this.stats,"audio","send","bytes"),this.model.audio_send.packets=Xr(this.stats,"audio","send","packets"),this.model.audio_send.echo_return_loss=Xr(this.stats,"audio","send","echoReturnLoss"),this.model.audio_send.echo_return_loss_enhancement=Xr(this.stats,"audio","send","echoReturnLossEnhancement"),this.model.audio_send.round_trip_time=Xr(this.stats,"audio","send","roundTripTime"),this.model.audio_send.audio_level=Xr(this.stats,"audio","send","audioLevel"),this.model.audio_send.jitter=Xr(this.stats,"audio","send","jitter");}gatherReceiveAudioPacketsStats(){this.model.audio_recv.bytes=Xr(this.stats,"audio","recv","bytes"),this.model.audio_recv.packets=Xr(this.stats,"audio","recv","packets"),this.model.audio_recv.packets_lost=Xr(this.stats,"audio","recv","packetsLost"),this.model.audio_recv.jitter=Xr(this.stats,"audio","recv","jitter"),this.model.audio_recv.audio_level=Xr(this.stats,"audio","recv","audioLevel");}gatherSendVideoPacketsStats(){this.model.video_send.bytes=Xr(this.stats,"video","send","bytes"),this.model.video_send.packets=Xr(this.stats,"video","send","packets"),this.model.video_send.nack_count=Xr(this.stats,"video","send","nacks"),this.model.video_send.firs_count=Xr(this.stats,"video","send","firs"),this.model.video_send.plis_count=Xr(this.stats,"video","send","plis"),this.model.video_send.frames_encoded=Xr(this.stats,"video","send","framesEncoded"),this.model.video_send.frame_width=Xr(this.stats,"video","send","frameWidth"),this.model.video_send.frame_height=Xr(this.stats,"video","send","frameHeight"),this.model.video_send.round_trip_time=Xr(this.stats,"video","send","roundTripTime"),this.model.video_send.qp_sum=Xr(this.stats,"video","send","qpSum"),this.model.video_send.jitter=Xr(this.stats,"video","send","jitter"),this.model.video_send.frames=Xr(this.stats,"video","send","frames"),this.model.video_send.hugeFrames=Xr(this.stats,"video","send","hugeFramesSent"),this.model.video_send.framesPerSecond=Xr(this.stats,"video","send","framesPerSecond");}gatherReceiveVideoPacketsStats(){this.model.video_recv.bytes=Xr(this.stats,"video","recv","bytes"),this.model.video_recv.packets=Xr(this.stats,"video","recv","packets"),this.model.video_recv.packets_lost=Xr(this.stats,"video","recv","packetsLost"),this.model.video_recv.nack_count=Xr(this.stats,"video","recv","nacks"),this.model.video_recv.firs_count=Xr(this.stats,"video","recv","firs"),this.model.video_recv.plis_count=Xr(this.stats,"video","recv","plis"),this.model.video_recv.frames_decoded=Xr(this.stats,"video","recv","framesDecoded"),this.model.video_recv.qp_sum=Xr(this.stats,"video","recv","qpSum"),this.model.video_recv.frames_decoded=Xr(this.stats,"video","recv","framesDecoded"),this.model.video_recv.frames_dropped=Xr(this.stats,"video","recv","framesDropped"),this.model.video_recv.decoderImplementation=Xr(this.stats,"video","recv","decoderImplementation");}buildTrackInfo(e){const t=ko.getSkylinkState(e),{peerStreams:r,user:n,streamsSettings:s}=t;if(r[n.sid]){Object.values(r[n.sid]).forEach((e=>{if(e){const t=e,{settings:r}=s[e.id],n=t.getAudioTracks(),i=t.getVideoTracks();n.forEach((e=>{const r=((e,t)=>({stream_id:e.id,id:t.id,label:t.label,muted:!t.enabled}))(t,e);this.model.audio_send.tracks.push(r);})),i.forEach((e=>{const n=((e,t,r)=>({stream_id:e.id,id:t.id,label:t.label,height:r.video.resolution.height,width:r.video.resolution.width,muted:!t.enabled}))(t,e,r);this.model.video_send.tracks.push(n);}));}}));}}send(e,t,r){const{STATS_MODULE:n}=Ft,s=ko.getSkylinkState(e);s?wi(s.peerStreams)||(this.model.client_id=s.clientId,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=r,lo.retrieveStatistics(e,r,ko.getInitOptions().beSilentOnStatsLogs).then((t=>{t&&(this.stats=t,this.gatherSendAudioPacketsStats(),this.gatherReceiveAudioPacketsStats(),this.gatherSendVideoPacketsStats(),this.gatherReceiveVideoPacketsStats(),this.buildTrackInfo(e),this.postStats(this.endpoints.bandwidth,this.model));})).catch((e=>{this.model.error=e?e.message:null,zt.log.DEBUG(n.HANDLE_BANDWIDTH_STATS.RETRIEVE_FAILED,e);}))):zt.log.DEBUG([r,"Statistics","Bandwidth_Stats",n.HANDLE_BANDWIDTH_STATS.NO_STATE]);}}class en extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,send_audio:null,recv_audio:null,send_video:null,recv_video:null,send_screen:null,recv_screen:null,mode:null};}getMediaCount(e,t,r){let n=0,s=0,i=0;const{peerMedias:o}=e;return Object.values(r).forEach((e=>{const r=e.getAudioTracks()[0],a=e.getVideoTracks()[0];if(r)n+=1;else if(a){!wi(o)&&o[t][`VIDEO_${e.id}`]&&o[t][`VIDEO_${e.id}`].mediaType===At.VIDEO_SCREEN?i+=1:s+=1;}})),{audioCount:n,videoCount:s,screenCount:i}}parseMediaStats(e){const{peerStreams:t,user:r,peerConnections:n}=e,s=t[r.sid]||[];let i=0,o=0,a=0;if(!wi(n)){const t=this.getMediaCount(e,r.sid,s);i=t.audioCount,o=t.videoCount,a=t.screenCount;}let c=0,d=0,l=0;return Object.keys(t).filter((e=>e!==r.sid)).forEach((r=>{const n=t[r],s=this.getMediaCount(e,r,n);c+=s.audioCount,d+=s.videoCount,l+=s.screenCount;})),{send_audio:i,send_video:o,send_screen:a,recv_audio:c,recv_video:d,recv_screen:l}}send(e){const t=ko.getSkylinkState(e);this.model.client_id=t.clientId,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=t&&t.user&&t.user.sid||null,this.model.mode=t.hasMCU?"MCU":"P2P";const r=this.parseMediaStats(t);this.model.send_audio=r.send_audio,this.model.recv_audio=r.recv_audio,this.model.send_video=r.send_video,this.model.recv_video=r.recv_video,this.model.send_screen=r.send_screen,this.model.recv_screen=r.recv_screen,this.postStats(this.endpoints.userMedia,this.model);}}class tn{static updatePeerStreamWithUserSid(e,t){const r=ko.getSkylinkState(e.id);r.peerStreams.null&&(r.peerStreams[t]=Object.assign({},r.peerStreams.null),delete r.peerStreams.null,ko.setSkylinkState(r,e.id));}static addStream(e,t=null,r){if(!t)return;const n=ko.getSkylinkState(r),{peerStreams:s}=n;s[e]&&s[e][t.id]||(s[e]=s[e]||{},s[e][t.id]=t,ko.setSkylinkState(n,r));}static deleteStream(e,t,r){const n=ko.getSkylinkState(t.id),s=r;delete n.peerStreams[e][s],wi(n.peerStreams[e])&&delete n.peerStreams[e],ko.setSkylinkState(n,n.room.id),(new en).send(t.id);}static dispatchStreamEvent(e,t){switch(e){case"onIncomingStream":Vt(pe(t));break;case"onIncomingScreenStream":Vt(ue(t));break;case"streamEnded":Vt(Re(t));break;case"streamMuted":Vt(he(t));}}}const rn=(e,t)=>!(!e||!e[0])&&(e.forEach((e=>{try{e.stop();}catch(r){zt.log.ERROR([t,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.ERRORS.STOP_MEDIA_TRACK} - track id: ${e.id}`],r);}})),!0),nn=(e,t,r)=>{const{room:n}=e,s=e;let i=-1;if(!s.currentRTCRTPSenders[t])return;const o=s.currentRTCRTPSenders[t];for(let e=0;e<o.length;e+=1)if(r===o[e]){i=e;break}-1!==i?(o.splice(i,1),s.currentRTCRTPSenders[t]=o,ko.setSkylinkState(s,n.id)):zt.log.WARN([t,null,null,"No matching sender was found for the peer."],r);},sn={prepStopStreams:(e,t,r=!1,n=!1)=>new Promise(((s,i)=>{const o=ko.getSkylinkState(e),{user:a,peerStreams:c}=o;o||i(new Error(`${Ft.ROOM_STATE.NOT_FOUND} - ${e}`)),(!c[a.sid]||t&&!c[a.sid][t])&&i(new Error(`${Ft.MEDIA_STREAM.ERRORS.NO_STREAM} - ${t}`)),n?sn.prepStopScreenStream(o.room,t,r).then((()=>s())).catch((e=>i(e))):sn.prepStopUserMediaStreams(o,t,r).then((()=>s())).catch((e=>i(e)));})),prepStopUserMediaStreams:(e,t,r)=>new Promise(((n,s)=>{const{user:i,peerStreams:o}=e,a=(e=>{const{peerStreams:t,user:r,room:n}=e;return Object.keys(t[r.sid]).map((e=>fs.retrieveScreenMediaInfo(n,r.sid,{streamId:e})?null:t[r.sid][e])).filter((e=>null!==e))})(e);try{if(t){const n=o[i.sid][t];sn.stopAddedStream(e,n,false,r);}else sn.stopAddedStreams(e,a,false,r);return sn.initRefreshConnectionAndResolve(e.room,r,n,s)}catch(e){zt.log.DEBUG([i.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA],e),s(Ft.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA);}})),stopAddedStream:(e,t,r=!1,n=!1)=>{const{room:s,user:i}=e;try{sn.tryStopStream(t,i.sid),n||(sn.removeTracks(s,t),fs.setMediaStateToUnavailable(s,i.sid,fs.retrieveMediaId(t.getTracks()[0].kind,t.id)),tn.deleteStream(i.sid,s,t.id),sn.listenForEventAndDeleteMediaInfo(s,t),sn.dispatchEvents(s,t,r),sn.updateMediaStatusMutedSettings(s,t),r&&new mo(e).deleteScreensharingInstance(s)),zt.log.INFO([i.sid,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id} ${r?"(screenshare)":""}`]);}catch(e){zt.log.ERROR([i.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.STOP_ADDED_STREAM],e);}},tryStopStream:(e,t)=>{if(e){try{rn(e.getAudioTracks());}catch(r){zt.log.ERROR([t,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.ERRORS.STOP_AUDIO_TRACK} - stream id: ${e.id}`],r);}try{rn(e.getVideoTracks());}catch(r){zt.log.ERROR([t,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.ERRORS.STOP_VIDEO_TRACK} - stream id: ${e.id}`],r);}}},removeTracks:(e,t)=>{const r=ko.getSkylinkState(e.id),{peerConnections:n,user:s}=r,i=t.getTracks();try{i.forEach((e=>{((e,t,r)=>{const n=r.id,s=Object.keys(t);for(let r=0;r<s.length;r+=1)try{const i=s[r],o=t[i];if(o.connectionState===Xe.CLOSED)break;const a=o.getSenders();let c=null;for(let t=0;t<a.length;t+=1)a[t].track&&a[t].track.id===n&&(c=a[t],o.removeTrack(c),nn(e,i,c));}catch(e){zt.log.ERROR([s[r],_t.PEER_CONNECTION,null,Ft.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e);}})(r,n,e);}));}catch(e){zt.log.ERROR([s.sid,_t.PEER_CONNECTION,null,Ft.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e);}},listenForEventAndDeleteMediaInfo:(e,t)=>{const r=ko.getSkylinkState(e.id),n=n=>{const s=t,{user:i}=r,{detail:o}=n;if(o.state===rt.OFFER){const t=fs.retrieveMediaId(qi(s)?Ct.AUDIO:Ct.VIDEO,s.id);fs.deleteUnavailableMedia(e,i.sid,t);}},s=()=>{Ht(Gt.HANDSHAKE_PROGRESS,n),Ht(Gt.MEDIA_INFO_DELETED,s);};xt(Gt.HANDSHAKE_PROGRESS,n),xt(Gt.MEDIA_INFO_DELETED,s);},stopAddedStreams:(e,t,r,n)=>{t.forEach((t=>{sn.stopAddedStream(e,t,r,n);}));},updateMediaInfoMediaState:(e,t)=>{const r=ko.getSkylinkState(e.id),{user:n}=r,s=t.id,i=fs.retrieveMediaId(t.getTracks()[0].kind,s);fs.setMediaStateToUnavailable(e,n.sid,i);},dispatchEvents:(e,t,r=!1)=>{const n=ko.getSkylinkState(e.id),{MEDIA_STREAM:s}=Ft,{user:i}=n;zt.log.INFO([i.sid,_t.MEDIA_STREAM,null,s.STOP_SETTINGS],{peerId:i.sid,isSelf:true,isScreensharing:r,stream:t}),tn.dispatchStreamEvent("streamEnded",{room:Ri.getRoomInfo(e),peerId:i.sid,peerInfo:fi.getCurrentSessionInfo(e),isSelf:true,isScreensharing:r,streamId:t.id,isVideo:Xi(t),isAudio:qi(t)}),Vt(((e={})=>new Se("mediaAccessStopped",{detail:e}))({isScreensharing:r,streamId:t.id})),Vt(ve({peerId:i.sid,peerInfo:gi.getCurrentSessionInfo(e),isSelf:!0}));},prepStopScreenStream:(e,t,r=!1)=>new Promise(((n,s)=>{const i=ko.getSkylinkState(e.id),{user:o,peerStreams:a}=i,c=a[o.sid][t];try{sn.stopAddedStream(i,c,true,r),sn.initRefreshConnectionAndResolve(i.room,r,n,s);}catch(e){zt.log.DEBUG([o.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.STOP_SCREEN],e),s(new Error(Ft.MEDIA_STREAM.ERRORS.STOP_SCREEN));}})),initRefreshConnectionAndResolve:(e,t,r,n)=>{const s=ko.getSkylinkState(e.id),{peerConnections:i}=s;try{if(!t){if(bi(Object.keys(i)))return (e=>{const{room:t,user:r}=e;Vt(ve({peerId:r.sid,isSelf:!0,peerInfo:fi.getCurrentSessionInfo(t)}));})(s),fs.deleteUnavailableMedia(s.room,s.user.sid),r();{const e=e=>{const{detail:t}=e;if(t.state===rt.ANSWER_ACK)return r()};xt(Gt.HANDSHAKE_PROGRESS,e),lo.refreshConnection(s);}}}catch(e){n(e);}},updateMediaStatusMutedSettings:(e,t)=>{const r=ko.getSkylinkState(e.id);delete r.streamsMediaStatus[t.id],delete r.streamsMutedSettings[t.id],delete r.streamsSettings[t.id],ko.setSkylinkState(r,e.id);}};class on{static getUserMedia(e,t={}){const{room:r}=e,n=ki.parseMediaOptions(t,e),{audio:s,video:i}=t,o=!!t.useExactConstraints;return ko.setSkylinkState(n,r.id),ki.prepMediaAccessRequest({useExactConstraints:o,audio:s,video:i,roomKey:r.id})}static processUserMediaOptions(e,t=null){return new Promise(((r,n)=>{let s={audio:!0,video:!0};t||zt.log.WARN([e.user.sid,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.NO_OPTIONS} - ${Ft.MEDIA_STREAM.DEFAULT_OPTIONS}`],s),Gi(t)||(zt.log.ERROR([e.user.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS],t),n(new Error(Ft.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),null)),s=t;on.getUserMedia(e,s).then((e=>{r(e);})).catch((e=>{n(e);}));}))}static stopStreams(e,t){return sn.prepStopStreams(e.room.id,t)}static addLocalMediaStreams(e,t){ki.addLocalMediaStreams(e,t);}static onRemoteTrackAdded(e,t,r,n,s,i){ki.onRemoteTrackAdded(e,t,r,n,s,i);}static muteStreams(e,t,r){return ki.muteStreams(e,t,r)}static sendStream(e,t){return ki.sendStream(e,t)}static getStreamSources(){return ki.getStreamSources()}static getStreams(e,t){return ki.getStreams(e,t)}static usePrefetchedStream(e,t){return new Promise((r=>{const n={audio:0!==t.getAudioTracks().length,video:0!==t.getVideoTracks().length},s=ki.parseStreamSettings(n,Ct.AUDIO),i=ki.parseStreamSettings(n,Ct.VIDEO);r(ki.onStreamAccessSuccess(e,t,s,i,!1,!1,!0));}))}static processPrefetchedStreams(e,t,r=null){return new Promise(((n,s)=>{const i=[];if(t&&r.id)return void s(Ft.MEDIA_STREAM.ERRORS.INVALID_PREFETCHED_STREAMS);if(t?Array.isArray(t)?t.forEach((e=>{e&&e.id&&e.active&&i.push(e);})):i.push(t):r.id&&r.active?i.push(r):Array.isArray(r)&&r.forEach((e=>{e&&e.id&&e.active&&i.push(e);})),bi(i))return void s(Ft.MEDIA_STREAM.ERRORS.INVALID_PREFETCHED_STREAMS);const o=[];i.forEach((t=>{o.push(on.usePrefetchedStream(e,t));})),Promise.all(o).then((e=>n(e)));}))}static buildStreamSettings(e,t,r){return ki.buildStreamSettings(e,t,r)}}const an=(e,t,r,n,s)=>{const i=ko.getSkylinkState(r.room.id),{bufferedLocalOffer:o,peerPriorityWeight:a,room:c}=i,d={type:n.type,sdp:n.sdp};if(zt.log.INFO([t,"RTCSessionDescription",n.type,"Local session description updated ->"],d.sdp),n.type===rt.OFFER){zt.log.INFO([t,"RTCSessionDescription",n.type,"Local offer saved."]),o[t]=n;const l={type:d.type,sdp:d.sdp,mid:i.user.sid,target:t,rid:r.room.id,userInfo:fi.getUserInfo(r.room),weight:a,mediaInfoList:fs.retrieveMediaInfoForOfferAnswer(c,d)};if(s&&Object.keys(s).length){const e=Object.keys(s),t=Object.keys(l);for(let r=0;r<e.length;r+=1){const n=e[r];-1===t.indexOf(n)&&(l[n]=s[n]);}}e(l);}else {e({type:d.type,sdp:d.sdp,mid:i.user.sid,target:t,rid:r.room.id,userInfo:fi.getUserInfo(r.room),mediaInfoList:fs.retrieveMediaInfoForOfferAnswer(c,d)});}};const cn=new class extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,weight:null,sdp_type:null,sdp_sdp:null,error:null};}send(e,t,r,n,s,i){const o=ko.getSkylinkState(e);this.model.client_id=o.clientId,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=r,this.model.state=t,this.model.is_remote=s,this.model.weight=n.weight||null,this.model.error=("string"==typeof i?i:i&&i.msg)||null,this.model.sdp_type=null,this.model.sdp_sdp=null,-1===["enter","welcome"].indexOf(this.model.state)&&(this.model.weight=this.model.is_remote&&fi.getPeerInfo(this.model.peer_id,o.room).config&&fi.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight?fi.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight:fi.getCurrentSessionInfo(o.room).config.priorityWeight,this.model.sdp_type=n&&n.type||null,this.model.sdp_sdp=n&&n.sdp||null),this.addToStatsBuffer("negotiation",this.model,this.endpoints.negotiation),this.manageStatsBuffer();}},{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:dn}}=Ft,ln=e=>{let t=null;const{currentRoom:r,targetMid:n,cert:s,hasScreenShare:i}=e,o=ko.getSkylinkState(r.id),{room:a}=o,c=Object.assign({iceServers:a.connection.peerConfig.iceServers},qt(bt.PEER_CONNECTION,{rid:r.id}));s&&(c.certificates=[s]),ko.setSkylinkState(o,r.id);try{t=((e,t,r,n)=>{const s=ko.getInitOptions(),i=ko.getSkylinkState(n.id);zt.log.DEBUG([e,_t.PEER_CONNECTION,null,Ft.PEER_CONNECTION.CREATE_NEW],{constraints:t});const{RTCPeerConnection:o,msRTCPeerConnection:a}=window,c=new(s.useEdgeWebRTC&&a?window.msRTCPeerConnection:o)(t),d=[c,e,i];return c.setOffer="",c.setAnswer="",c.hasMainChannel=!1,c.gathered=!1,c.gathering=!1,c.setRemoteDescriptionSuccess=null,i.gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}},i.peerEndOfCandidatesCounter[e]=i.peerEndOfCandidatesCounter[e]||{},e===Pt.MCU&&(zt.log.INFO("Creating an empty transceiver of kind video with MCU"),"function"==typeof c.addTransceiver&&c.addTransceiver("video")),c.restartIce&&(i.enableIceRestart=!0),ko.setSkylinkState(i,n.id),c.ontrack=ms.ontrack.bind(c,...d),c.ondatachannel=ms.ondatachannel.bind(c,...d),c.onicecandidate=ms.onicecandidate.bind(c,...d),c.oniceconnectionstatechange=ms.oniceconnectionstatechange.bind(c,...d),c.onconnectionstatechange=ms.onconnectionstatechange.bind(c,...d),c.onsignalingstatechange=ms.onsignalingstatechange.bind(c,...d),c.onicegatheringstatechange=ms.onicegatheringstatechange.bind(c,...d),Zi(yt.REACT_NATIVE)&&(c.onsenderadded=ms.onsenderadded.bind(c,...d),c.onremovetrack=ms.onremovetrack.bind(c,e,i.room,!1)),c})(n,c,0,r),t.constraints=c;}catch(e){zt.log.ERROR([n,null,null,"Failed creating peer connection:"],e),t=null,Vt(fe({state:rt.ERROR,peerId:n,error:e,room:Ri.getRoomInfo(a)}));}return t},{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:En}}=Ft,Sn=(e,t,r,n,s)=>{const i=ko.getSkylinkState(e),o=i.peerDataChannels[t],a=n,{channelName:c,channelType:d}=o[a],l=xe.MESSAGING;if(((e,t,r,n,s)=>{const i=e.peerConnections[t],o=e.peerDataChannels[t],a=n,{channelName:c,channelType:d,channel:l}=o[a],E=xe.MESSAGING;return (s!==He.PROTOCOL||"object"==typeof r&&r)&&(s!==He.CHUNK||"string"==typeof r&&r)?i?i&&i.signalingState===Xe.CLOSED?(zt.log.WARN([t,_t.DATA_CHANNEL,a,`${Ft.DATA_CHANNEL.ERRORS.DROP_SENDING_MESSAGE} - ${Ft.PEER_CONNECTION.PEER_CONNECTION_CLOSED}`],r),!1):o&&o[a]?(l.readyState!==Be.OPEN&&(Vt(me({peerId:t,channelName:c,channelType:d,messageType:E,error:`${Ft.DATA_CHANNEL.ERRORS.FAILED_SENDING_MESSAGE} - ${Ft.DATA_CHANNEL.DATA_CHANNEL_NOT_OPEN}`,state:Be.SEND_MESSAGE_ERROR})),Dr.throwError(t,_t.DATA_CHANNEL,`${Ft.DATA_CHANNEL.ERRORS.FAILED_SENDING_MESSAGE} - ${Ft.DATA_CHANNEL.DATA_CHANNEL_NOT_OPEN}`,`Current readyState is ${l.readyState}`,r)),!0):(zt.log.WARN([t,_t.DATA_CHANNEL,a,`${Ft.DATA_CHANNEL.ERRORS.DROP_SENDING_MESSAGE} - ${Ft.DATA_CHANNEL.NO_DATA_CHANNEL_CONNECTION}`],r),!1):(zt.log.WARN([t,_t.DATA_CHANNEL,a,`${Ft.DATA_CHANNEL.ERRORS.DROP_SENDING_MESSAGE} - ${Ft.PEER_CONNECTION.NO_PEER_CONNECTION}`],r),!1):(zt.log.WARN([t,_t.DATA_CHANNEL,a,`${Ft.DATA_CHANNEL.ERRORS.DROP_SENDING_MESSAGE} - ${Ft.DATA_CHANNEL.ERRORS.INVALID_DATA}`],r),!1)})(i,t,r,n,s))try{const e=Hi(r)?r:JSON.stringify(r);s===He.PROTOCOL&&zt.log.DEBUG([t,_t.DATA_CHANNEL,a,`Sending ${r.type} protocol message ->`],r),o[a].channel.send(e);}catch(e){Vt(me({peerId:t,channelName:c,channelType:d,messageType:l,error:e,state:Be.SEND_MESSAGE_ERROR})),Dr.throwError(t,_t.DATA_CHANNEL,Ft.DATA_CHANNEL.ERRORS.FAILED_SENDING_MESSAGE,null,{error:e,data:r});}return null};var pn={chunkBlobData:(e,t)=>{const r=[],n=e.size;let s=0,i=0;if(zt.log.DEBUG([null,_t.DATA_CHANNEL,null,Ft.DATA_CHANNEL.CHUNKING_BLOB]),n>t){for(;n-1>i;)i=s+t,r.push(e.slice(s,i)),s+=t;n-(s+1)>0&&r.push(e.slice(s,n-1));}else r.push(e);return r},getTransferInfo:(e,t,r)=>{const n=ko.getSkylinkState(e),{room:s,dataTransfers:i}=n;if(i[t]){const{name:e,chunkSize:o,chunkType:a,dataType:c,mimeType:d,direction:l,timeout:E,isPrivate:S,percentage:p,originalSize:u,size:R}=i[t],h={name:e,size:R,chunkSize:o,chunkType:a,dataType:c,mimeType:d,direction:l,timeout:E,isPrivate:S,percentage:p,originalSize:u,data:null};return l===je.DOWNLOAD&&i[t].sessions[r]?i[t].sessions[r].receivedSize===h.size?h.percentage=100:h.percentage=parseFloat((i[t].sessions[r].receivedSize/i[t].size*100).toFixed(2)):l===je.UPLOAD&&i[t].sessions[r]&&(i[t].chunks.length===i[t].sessions[r].ackN?h.percentage=100:h.percentage=parseFloat((i[t].sessions[r].ackN/i[t].chunks.length*100).toFixed(2))),100===h.percentage&&(h.data=pn.getTransferData(s.id,t)),n.dataTransfers[t].percentage=h.percentage,ko.setSkylinkState(n,s.id),h}return null},blobToBase64:e=>new Promise((t=>{const{FileReader:r}=window,n=new r;n.readAsDataURL(e),n.onload=()=>{const e=n.result.split(",")[1];return t(e)};})),getTransferData:(e,t)=>{const r=ko.getSkylinkState(e),{dataTransfers:n}=r;if(!n[t])return null;if(n[t].dataType===$e.BLOB){const e={name:n[t].name};return n[t].mimeType&&(e.type=n[t].mimeType),new Blob(n[t].chunks,e)}return n[t].chunks.join("")},base64ToBlob:e=>{const t=atob(e),r=new ArrayBuffer(t.length),n=new Uint8Array(r);for(let e=0;e<t.length;e+=1)n[e]=t.charCodeAt(e);return new Blob([r])},sendACKProtocol:(e,t,r,n,s)=>{Sn(e,t,{type:ut.ACK,sender:r,ackN:n},s,He.PROTOCOL);},manageDataTransferTimeout:(e,t,r,n)=>{const s=ko.getSkylinkState(e),{room:i,user:o,dataTransfers:a,peerDataChannels:c}=s;if(!a[t]||!a[t].sessions[r])return zt.log.DEBUG([r,_t.DATA_CHANNEL,t,`${Ft.DATA_CHANNEL.IGNORE_TIMEOUT} - ${Ft.DATA_CHANNEL.ERRORS.NO_DATA_TRANSFER_SESSION}`]);zt.log.DEBUG([r,_t.DATA_CHANNEL,t,Ft.DATA_CHANNEL.CLEAR_TIMEOUT]),a[t].sessions[r].timer&&clearTimeout(a[t].sessions[r].timer),a[t].sessions[r].timer=null,n&&(zt.log.DEBUG([r,_t.DATA_CHANNEL,t,Ft.DATA_CHANNEL.SET_TIMEOUT]),s.dataTransfers[t].sessions[r].timer=setTimeout((()=>{if(!a[t]||!a[t].sessions[r])return zt.log.DEBUG([r,_t.DATA_CHANNEL,t,`${Ft.DATA_CHANNEL.IGNORE_TIMEOUT} - ${Ft.DATA_CHANNEL.DATA_TRANSFER_COMPLETED}`]);if(!o||!o.sid)return zt.log.DEBUG([r,_t.DATA_CHANNEL,t,`${Ft.DATA_CHANNEL.IGNORE_TIMEOUT} - ${Ft.ROOM.ERRORS.NOT_IN_ROOM}`]);if(!c[r])return zt.log.DEBUG([r,_t.DATA_CHANNEL,t,`${Ft.DATA_CHANNEL.IGNORE_TIMEOUT} - ${Ft.DATA_CHANNEL.NO_DATA_CHANNEL_CONNECTION}`]);zt.log.ERROR([r,_t.DATA_CHANNEL,t,Ft.DATA_CHANNEL.ERRORS.DATA_TRANSFER_TIMEOUT]);const e=`${Ft.DATA_CHANNEL.ERRORS.DATA_TRANSFER_TIMEOUT} - Longer than ${a[t].timeout}`;Nn.sendMessageToDataChannel(i.id,r,{type:ut.ERROR,content:e,sender:o.sid,name:a[t].name},"main",He.PROTOCOL),Vt(Oe({state:We.ERROR,transferId:t,peerId:r,transferInfo:pn.getTransferInfo(i.id,t,r),error:{message:new Error(e),transferType:a[t].direction}}));}),1e3*a[t].timeout));},canDataTransferProceed:(e,t,r,n,s,i,o)=>{const a=ko.getSkylinkState(e),{user:c,peerConnections:d,peerInformations:l,dataTransfers:E,peerDataChannels:S,room:p}=a;try{switch(t){case je.UPLOAD:if(!d[r])throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_UPLOAD_TERMINATED} - ${Ft.PEER_CONNECTION.NO_PEER_CONNECTION}`);if(!l[r])throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_UPLOAD_TERMINATED} - ${Ft.PEER_CONNECTION.NO_PEER_CONNECTION}`);if(d[r].signalingState!==Xe.STABLE)throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_UPLOAD_TERMINATED} - ${Ft.PEER_CONNECTION.ERRORS.NOT_STABLE}`);if(!E[n])throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_UPLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_DATA_TRANSFER_SESSION}`);if(!S[r]||!S[r].main)throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_UPLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.NO_DATA_CHANNEL_CONNECTION}`);if(S[r].main.channel.readyState!==Be.OPEN)throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_UPLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.DATA_CHANNEL_NOT_OPEN}`);if(S[r].main.transferId&&"main"===s)throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_UPLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.DATA_TRANSFER_IN_PROGRESS}`);return !0;case je.DOWNLOAD:if(!i)return pn.sendACKProtocol(p.id,r,c.sid,Ke.REJECT,s),zt.log.ERROR([r,_t.DATA_CHANNEL,s,`${Ft.DATA_CHANNEL.DATA_TRANSFER_DOWNLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.USER_REJECTED_TRANSFER}`]),Vt(Oe({state:We.USER_REJECTED,transferId:n,peerId:r,transferInfo:pn.getTransferInfo(p.id,n,r),error:{message:new Error(Ft.DATA_CHANNEL.ERRORS.REJECTED_TRANSFER),transferType:t}})),!1;if(!Hi(n))throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_DOWNLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_TRANSFER_ID}`);if(!Hi(r))throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_DOWNLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_PEER_ID}`);if(!S[r])throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_DOWNLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_SESSIONS}`);if(!E[n])throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_DOWNLOAD_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_DATA_TRANSFER_SESSION}`);return !0;case We.CANCEL:if(!Hi(n))throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_CANCEL_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_TRANSFER_ID}`);if(!Hi(r))throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_CANCEL_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_PEER_ID}`);if(!S[r])throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_CANCEL_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_SESSIONS}`);if(!E[n])throw new Error(`${Ft.DATA_CHANNEL.DATA_TRANSFER_CANCEL_TERMINATED} - ${Ft.DATA_CHANNEL.ERRORS.NO_DATA_TRANSFER_SESSION}`);return !0;default:return !1}}catch(e){return zt.log.ERROR([r,_t.DATA_CHANNEL,s,Ft.DATA_CHANNEL.DATA_TRANSFER_ERROR],e),Vt(Oe({state:We.ERROR,transferId:n,peerId:r,transferInfo:pn.getTransferInfo(p.id,n,r),error:{message:e,transferType:t}})),o(e)}},listenOnDataTransferState:(e,t,r,n,s,i)=>{zt.log.DEBUG([r,_t.DATA_CHANNEL,n,"Registering data transfer state listeners"]);const o=a=>{const{state:c,error:d}=a.detail,l=ko.getSkylinkState(e);zt.log.DEBUG([r,_t.DATA_CHANNEL,n,`${Ft.DATA_CHANNEL.DATA_TRANSFER_STATE} - ${c}`]),a.detail.peerId===r&&(t===je.UPLOAD&&c===We.UPLOAD_COMPLETED||t===je.DOWNLOAD&&c===We.DOWNLOAD_COMPLETED?(Ht(Gt.DATA_TRANSFER_STATE,o),s({[r]:{success:pn.getTransferInfo(e,n,r),transferType:je.UPLOAD}}),l.peerDataChannels[r].main.transferId=null):c!==We.ERROR&&c!==We.CANCEL&&c!==We.REJECTED&&c!==We.REJECTED||(Ht(Gt.DATA_TRANSFER_STATE,o),i({[r]:{error:d.message,transferType:je.UPLOAD}}),c===We.CANCEL&&(l.dataTransfers[n].cancelled=!0),l.peerDataChannels[r].main.transferId=null),ko.setSkylinkState(l,e));};xt(Gt.DATA_TRANSFER_STATE,o);},sendWRQMessage:(e,t,r,n)=>{const s=ko.getSkylinkState(e),{dataTransfers:i,user:o,room:a}=s,{size:c,chunkSize:d,sessionChunkType:l}=i[t],{AdapterJS:E}=window;Nn.sendMessageToDataChannel(a.id,r,{type:ut.WRQ,transferId:t,name:i[t].name,size:c,originalSize:i[t].originalSize,dataType:i[t].sessionType,mimeType:i[t].mimeType,chunkType:l,chunkSize:d,timeout:i[t].timeout,isPrivate:i[t].isPrivate,sender:o.sid,agent:E.webrtcDetectedBrowser,version:E.webrtcDetectedVersion,target:r},n,He.PROTOCOL),Vt(De({transferId:t,peerId:o.sid,transferInfo:pn.getTransferInfo(a.id,t,r),isSelf:!0})),zt.log.DEBUG([r,_t.DATA_CHANNEL,t,`${Ft.DATA_CHANNEL.DATA_TRANSFER_STATE} - ${We.USER_UPLOAD_REQUEST}`]),Vt(Oe({state:We.USER_UPLOAD_REQUEST,transferId:t,peerId:r,transferInfo:pn.getTransferInfo(a.id,t,r)}));}};const un=(e,t,r,n)=>{const s=r.sender||t;zt.log.INFO([s,_t.DATA_CHANNEL,n,Ft.DATA_CHANNEL.RECEIVED_P2P_MESSAGE],r),Vt(ge({room:Ri.getRoomInfo(e.room),message:{targetPeerId:r.target,content:r.data,senderPeerId:s,isDataChannel:!0,isPrivate:r.isPrivate},isSelf:!1,peerId:s,peerInfo:fi.getPeerInfo(s,e.room)}));},Rn=(e,t,r,n)=>{const s=ko.getSkylinkState(e),{room:i,dataTransfers:o,peerDataChannels:a}=s;let c="main"===n?r.transferId||null:n;c||(c=`transfer_${t}_${(new Date).getTime()}`),o[c]={name:r.name||c,size:r.size||0,chunkSize:r.chunkSize,originalSize:r.originalSize||0,timeout:r.timeout||60,isPrivate:!!r.isPrivate,senderPeerId:r.sender||t,dataType:$e.BLOB,mimeType:r.mimeType||null,chunkType:Ve.BINARY_STRING,direction:je.DOWNLOAD,chunks:[],sessions:{},sessionType:r.dataType||"blob",sessionChunkType:r.chunkType||"string",cancelled:!1},a[t][n].transferId=c,o[c].sessions[t]={timer:null,ackN:0,receivedSize:0},Vt(De({transferId:c,peerId:t,transferInfo:pn.getTransferInfo(i.id,c,t),isSelf:!1})),Vt(Oe({state:We.UPLOAD_REQUEST,transferId:c,peerId:t,transferInfo:pn.getTransferInfo(i.id,c,t)}));},hn=(e,t,r,n)=>{const s=ko.getSkylinkState(e),{room:i,dataTransfers:o,peerDataChannels:a}=s;let c=n;if("main"===n&&(c=a[t].main.transferId),pn.manageDataTransferTimeout(i.id,c,t,!1),r.ackN>-1){if(0===r.ackN)zt.log.DEBUG([t,_t.DATA_CHANNEL,c,`${Ft.DATA_CHANNEL.DATA_TRANSFER_STATE} - ${We.UPLOAD_STARTED}`]),Vt(Oe({state:We.UPLOAD_STARTED,transferId:c,peerId:t,transferInfo:pn.getTransferInfo(i.id,c,t)}));else if(o[c]&&r.ackN===o[c].chunks.length)return s.dataTransfers[c].sessions[t].ackN=r.ackN,Vt(Oe({state:We.UPLOAD_COMPLETED,transferId:c,peerId:t,transferInfo:pn.getTransferInfo(i.id,c,t)})),void Vt(Ne({data:pn.getTransferData(i.id,c),transferId:c,peerId:t,transferInfo:pn.getTransferInfo(i.id,c,t),isSelf:!0}));o[c]&&!o[c].cancelled&&(o[c].sessions[t].ackN=r.ackN,pn.blobToBase64(o[c].chunks[r.ackN]).then((e=>((e,t,r,n,s,i)=>{const o=ko.getSkylinkState(e),{room:a,dataTransfers:c}=o;Nn.sendMessageToDataChannel(a.id,t,i,n,He.CHUNK),s<c[r].chunks.length&&Vt(Oe({state:We.UPLOADING,transferId:r,peerId:t,transferInfo:pn.getTransferInfo(a.id,r,t)})),pn.manageDataTransferTimeout(a.id,r,t,!0);})(i.id,t,c,n,r.ackN,e))));}else Vt(Oe({state:We.REJECTED,transferId:c,peerId:t,transferInfo:pn.getTransferInfo(i.id,c,t),error:{message:new Error(Ft.DATA_CHANNEL.ERRORS.REMOTE_REJECTED_TRANSFER),transferType:je.UPLOAD}}));},mn=(e,t,r,n,s,i)=>{const o=ko.getSkylinkState(e),{room:a,dataTransfers:c,peerDataChannels:d,user:l}=o;let E=i,S=t;d[t]&&d[t][i]&&("main"===i&&(E=d[t].main.transferId),c[E].senderPeerId&&(S=c[E].senderPeerId),pn.manageDataTransferTimeout(a.id,E,t,!1),o.dataTransfers[E].chunkType=n,o.dataTransfers[E].sessions[t].receivedSize+=s,o.dataTransfers[E].chunks[c[E].sessions[t].ackN]=r,ko.setSkylinkState(o,a.id),c[E].sessions[t].receivedSize>=c[E].size?(zt.log.DEBUG([t,_t.DATA_CHANNEL,i,"Data transfer has been completed. Computed size ->"],c[E].sessions[t].receivedSize),pn.sendACKProtocol(a.id,t,l.sid,c[E].sessions[t].ackN+1,i),Vt(Ne({data:pn.getTransferData(a.id,E),transferId:E,peerId:t,transferInfo:pn.getTransferInfo(a.id,E,S),isSelf:!0})),Vt(Oe({state:We.DOWNLOAD_COMPLETED,transferId:E,peerId:S,transferInfo:pn.getTransferInfo(a.id,E,S)}))):c[E].cancelled||(o.dataTransfers[E].sessions[t].ackN+=1,ko.setSkylinkState(o,a.id),pn.sendACKProtocol(a.id,t,l.sid,c[E].sessions[t].ackN,i),Vt(Oe({state:We.DOWNLOADING,transferId:E,peerId:S,transferInfo:pn.getTransferInfo(a.id,E,S)})),pn.manageDataTransferTimeout(a.id,E,t,!0)));},gn=(e,t,r,n)=>{const s=ko.getSkylinkState(e),{room:i,peerDataChannels:o,dataTransfers:a}=s,c="main"===n?o[t].main.transferId:n;zt.log.ERROR([t,_t.DATA_CHANNEL,n||null,Ft.DATA_CHANNEL.ERRORS.CANCEL_TRANSFER],r),pn.manageDataTransferTimeout(i.id,c,t,!1),Vt(Oe({state:We.CANCEL,transferId:c,peerId:t,transferInfo:pn.getTransferInfo(i.id,c,t),error:{message:r.content,transferType:a[c]?a[c].direction:null}}));},fn=(e,t,r,n)=>{const s=ko.getSkylinkState(e),{room:i,peerDataChannels:o,dataTransfers:a}=s;let c=n;"main"===n&&(c=o[t].main.transferId),pn.manageDataTransferTimeout(i.id,c,t,!1),zt.log.ERROR([t,_t.DATA_CHANNEL,c,Ft.DATA_CHANNEL.ERRORS.RECEIVED_ERROR],r),Vt(Oe({state:We.ERROR,transferId:c,peerId:t,transferInfo:pn.getTransferInfo(i.id,c,t),error:{message:new Error(r.content),transferType:a[c].direction}}));},Tn=(e,t,r,n,s)=>{const i=ko.getSkylinkState(e);if(!i)return zt.log.WARN([r,_t.DATA_CHANNEL,null,"Dropping data received as peer is no longer in the room"],t),null;const{room:o,dataTransfers:a}=i;let c=null;const d=s===xe.MESSAGING?"main":n,l=i.peerDataChannels[r]||{};if(!l.hasOwnProperty(d)||"object"!=typeof l[d])return null;if(c=l[d].transferId,!i.peerConnections[r])return zt.log.WARN([r,_t.DATA_CHANNEL,d,"Dropping data received from Peer as connection is not present ->"],t),null;if(!i.peerDataChannels[r]||!i.peerDataChannels[r][d])return zt.log.WARN([r,_t.DATA_CHANNEL,d,"Dropping data received from Peer as Datachannel connection is not present ->"],t),null;if("string"==typeof t){const e=((e,t,r,n,s)=>{try{return JSON.parse(e)}catch(i){if(e.indexOf("{")>-1&&e.indexOf("}")>0)return Vt(me({peerId:t,channelName:r,channelType:n,error:i,state:Be.ERROR})),Dr.throwError(t,_t.DATA_CHANNEL,Ft.DATA_CHANNEL.ERRORS.FAILED_PARSING_PROTOCOL,s,{error:i,data:e}),!1}})(t,d);if(!e){const e=t;if(!(c&&a[c]&&a[c].sessions[r]))return zt.log.WARN([r,_t.DATA_CHANNEL,d,""+(Ft.DATA_CHANNEL.ERRORS.DISCARDING_DATA_CHUNK-Ft.DATA_CHANNEL.ERRORS.NO_DATA_TRANSFER_SESSION)],e);if(c&&a[c].chunks[a[c].sessions[r].ackN])return zt.log.WARN([r,_t.DATA_CHANNEL,c,`${Ft.DATA_CHANNEL.ERRORS.DISCARDING_DATA_CHUNK} - ${Ft.DATA_CHANNEL.ERRORS.CHUNK_ADDED} @${a[c].sessions[r].ackN}`],e);const n=e.replace(/\s|\r|\n/g,"");return zt.log.DEBUG([r,_t.DATA_CHANNEL,c,`${Ft.DATA_CHANNEL.RECEIVED_CHUNK} @${a[c].sessions[r].ackN}, Size:`],n.length||n.size||"-"),mn(o.id,r,pn.base64ToBlob(n),Ve.BINARY_STRING,n.length||n.size||0,d)}switch(zt.log.DEBUG([r,_t.DATA_CHANNEL,d,`Received protocol ${e.type} message ->`],e),e.type){case ut.WRQ:Rn(o.id,r,e,d);break;case ut.ACK:hn(o.id,r,e,d);break;case ut.ERROR:fn(o.id,r,e,d);break;case ut.CANCEL:gn(o.id,r,e,d);break;case ut.MESSAGE:un(i,r,e,d);break;default:zt.log.WARN([r,_t.DATA_CHANNEL,d,`Discarded unknown ${e.type} message ->`],e);}}return null};class _n extends sr{constructor(){super();const{AdapterJS:e}=window;this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,channel_id:null,channel_label:null,channel_type:null,channel_binary_type:null,error:null,agent_name:e.webrtcDetectedBrowser,agent_type:e.webrtcDetectedType,agent_version:e.webrtcDetectedVersion};}sendWithRoomState(e,t,r,n,s,i){this.model.room_id=e.room.id,this.model.user_id=e&&e.user&&e.user.uid,this.model.peer_id=r,this.model.client_id=e&&e.clientId,this.model.state=t,this.model.channel=n,this.model.channel_id=n.id,this.model.channel_label=n.label,this.model.channel_type="main"===s?"persistent":"temporal",this.model.channel_binary_type=n.binaryType,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.error=("string"==typeof i?i:i&&i.message)||null,"plugin"===this.model.agent_name&&(this.model.channel_binary_type="int8Array","IE"===this.model.agent_name&&this.model.agent_version<11&&(this.model.channel_binary_type="none")),this.postStats(this.endpoints.dataChannel,this.model);}send(e,t,r,n,s,i){const o=ko.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.uid,this.model.peer_id=r,this.model.client_id=o&&o.clientId,this.model.state=t,this.model.channel=n,this.model.channel_id=`${n.id}`,this.model.channel_label=n.label,this.model.channel_type="main"===s?"persistent":"temporal",this.model.channel_binary_type=n.binaryType,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.error=("string"==typeof i?i:i&&i.message)||null,"plugin"===this.model.agent_name&&(this.model.channel_binary_type="int8Array","IE"===this.model.agent_name&&this.model.agent_version<11&&(this.model.channel_binary_type="none")),this.postStats(this.endpoints.dataChannel,this.model);}}const An={onopen:e=>{const{dataChannel:t,channelProp:r,channelName:n,channelType:s,peerId:i,roomState:o,bufferThreshold:a}=e,c=new _n,{room:d}=o,{STATS_MODULE:l}=Ft;zt.log.DEBUG([i,"RTCDataChannel",r,"Datachannel has opened"]),t.bufferedAmountLowThreshold=a||0,c.send(d.id,l.HANDLE_DATA_CHANNEL_STATS.closed,i,t,r),Vt(me({state:Be.OPEN,peerId:i,channelName:n,channelType:s,bufferAmount:lo.getDataChannelBuffer(t)}));},onmessage:(e,t)=>{const{peerId:r,channelName:n,channelType:s,roomState:i}=e;Tn(i.room.id,t.data,r,n,s);},onerror:(e,t)=>{const{dataChannel:r,peerId:n,channelName:s,channelProp:i,channelType:o,roomState:a}=e;if("NONE"===t.error.errorDetail||0===t.error.code)zt.log.DEBUG([n,"RTCDataChannel",i,"Datachannel state ->"],t.error.message);else {const e=ko.getSkylinkState(a.room.id);e||zt.log.DEBUG([n,"RTCDataChannel",i,`No roomState for room ${a.room.id}`]);const c=new _n;zt.log.ERROR([n,"RTCDataChannel",i,"Datachannel has an exception ->"],t),c.send(e?e.room.id:a.room.id,Be.ERROR,n,r,i,t),Vt(me({state:Be.ERROR,peerId:n,channelName:s,channelType:o,bufferAmount:lo.getDataChannelBuffer(r),error:t}));}},onbufferedamountlow:e=>{const{dataChannel:t,peerId:r,channelName:n,channelProp:s,channelType:i,roomState:o}=e,a=ko.getSkylinkState(o.room.id),{room:c}=a;zt.log.DEBUG([r,"RTCDataChannel",s,"Datachannel buffering data transfer low"]),Vt(me({state:Be.BUFFERED_AMOUNT_LOW,room:Ri.getRoomInfo(c),peerId:r,channelName:n,channelType:i,bufferAmount:lo.getDataChannelBuffer(t)}));},onclose:e=>{const{dataChannel:t,peerId:r,channelName:n,channelProp:s,channelType:i,roomState:o}=e,{DATA_CHANNEL:a,STATS_MODULE:c}=Ft,d=ko.getSkylinkState(o.room.id),l=new _n;if(zt.log.DEBUG([r,"RTCDataChannel",s,a.closed]),!d)return l.sendWithRoomState(o,c.HANDLE_DATA_CHANNEL_STATS.closed,r,t,s),void Vt(me({state:Be.CLOSED,peerId:r,room:Ri.getRoomInfo(o.room),channelName:n,channelType:i,bufferAmount:lo.getDataChannelBuffer(t)}));try{const{room:e,peerConnections:o}=d;if(l.send(e.id,c.HANDLE_DATA_CHANNEL_STATS.closed,r,t,s),Vt(me({state:Be.CLOSED,peerId:r,room:Ri.getRoomInfo(e),channelName:n,channelType:i,bufferAmount:lo.getDataChannelBuffer(t)})),o[r]&&o[r].remoteDescription&&o[r].remoteDescription.sdp&&(-1===o[r].remoteDescription.sdp.indexOf("m=application")||o[r].remoteDescription.sdp.indexOf("m=application 0")>0))return;i===xe.MESSAGING&&setTimeout((()=>{o[r]&&o[r].signalingState!==Xe.CLOSED&&o[r].localDescription&&o[r].localDescription.type===rt.OFFER&&(zt.log.DEBUG([r,"RTCDataChannel",s,a.reviving_dataChannel]),lo.createDataChannel({peerId:r,dataChannel:t,bufferThreshold:lo.getDataChannelBuffer(t),createAsMessagingChannel:!0,roomState:d}),l.send(e.id,c.HANDLE_DATA_CHANNEL_STATS.reconnecting,r,{label:n},"main"));}),100);}catch(e){zt.log.WARN([r,"RTCDataChannel",s,a.closed]);}}},In=(e,t)=>{const{room:r,peerDataChannels:n,peerConnections:s}=e;if((e=>!wi(e))(n)&&Object.hasOwnProperty.call(n,t)){if(Object.hasOwnProperty.call(n[t],"main")){const i=n[t].main,{channelName:o,channelType:a}=i,c=i.channel.bufferedAmountLowThreshold||0;a===xe.MESSAGING&&setTimeout((()=>{Object.hasOwnProperty.call(s,t)&&s[t].signalingState!==Xe.CLOSED&&s[t].localDescription.type===rt.OFFER&&(lo.closeDataChannel(r.id,t),zt.log.DEBUG([t,"RTCDataChannel","main",Ft.DATA_CHANNEL.reviving_dataChannel]),lo.createDataChannel({roomState:e,peerId:t,dataChannel:o,bufferThreshold:c,createAsMessagingChannel:!0}));}),100);}}else zt.log.DEBUG([t,"RTCDataChannel",Ft.DATA_CHANNEL.refresh_error]);},Cn=(e,t,r)=>{const{peerDataChannels:n}=e,s=n[t][r],{channelName:i,channelType:o}=s;if(s.channel.readyState!==Be.CLOSED){const{room:a}=e,c=new _n;zt.log.DEBUG([t,_t.DATA_CHANNEL,r,Ft.DATA_CHANNEL.CLOSING]),c.send(a.id,Be.CLOSING,t,s.channel,r),Vt(me({room:a,peerId:t,state:Be.CLOSING,channelName:i,channelType:o,bufferAmount:lo.getDataChannelBuffer(s.channel)})),s.channel.close(),delete n[t][r];}},On=(e,t,r="main")=>{try{const n=ko.getSkylinkState(e),{peerDataChannels:s,room:i}=n;if(!s[t]||!s[t][r])return void zt.log.WARN([t,_t.DATA_CHANNEL,r||null,Ft.DATA_CHANNEL.ERRORS.NO_SESSIONS]);if("main"===r)return void((e,t)=>{const{peerDataChannels:r}=e,n=Object.keys(r[t]);for(let s=0;s<n.length;s+=1)Object.hasOwnProperty.call(r[t],n[s])&&Cn(e,t,n[s]);delete r[t];})(n,t);Cn(n,t,r),ko.setSkylinkState(n,i.id);}catch(e){zt.log.ERROR([t,_t.DATA_CHANNEL,r||null,Ft.DATA_CHANNEL.ERRORS.FAILED_CLOSING],e);}};class Nn{static createDataChannel(e){(e=>{let{peerId:t,dataChannel:r,bufferThreshold:n,createAsMessagingChannel:s,roomState:i}=e;const o=ko.getSkylinkState(i.room.id),{room:a,user:c,peerConnections:d,peerDataChannels:l}=o,E=d[t];let S=`-_${t}`,p=!0===s?xe.MESSAGING:xe.DATA,u=p===xe.MESSAGING?"main":S;if(!c||!c.sid)return zt.log.ERROR([t,"RTCDataChannel",u,"Aborting of creating or initializing DataChannel as User does not have Room session"]),null;if(S=`${a.id}_${c.sid}_${t}`,!E||E.signalingState===Xe.CLOSED)return zt.log.ERROR([t,"RTCDataChannel",u,"Aborting of creating or initializing Datachannel as Peer connection does not exists"]),null;if(r&&"object"==typeof r?S=r.label:"string"==typeof r&&(S=r,r=null),l[t]?l[t].main&&l[t].main.channel.label===S&&(u="main",p=xe.MESSAGING):(u="main",p=xe.MESSAGING,l[t]={},zt.log.DEBUG([t,"RTCDataChannel",u,"initializing main DataChannel"])),!r)try{r=E.createDataChannel(S,{reliable:!0,ordered:!0});}catch(e){return zt.log.ERROR([t,"RTCDataChannel",u,"Failed creating Datachannel ->"],e),(new _n).send(a.id,Be.ERROR,t,{label:S},u,e),Vt(me({state:Be.CREATE_ERROR,peerId:t,error:e,channelName:S,channelType:p,buferAmount:lo.getDataChannelBuffer(r)})),null}const R={dataChannel:r,peerId:t,channelName:S,channelProp:u,channelType:p,roomState:i,bufferThreshold:n};r.onopen=An.onopen.bind(r,R),r.onmessage=An.onmessage.bind(r,R),r.onerror=An.onerror.bind(r,R),r.onbufferedamountlow=An.onbufferedamountlow.bind(r,R),r.onclose=An.onclose.bind(r,R);const h=p===xe.MESSAGING?"main":S;o.peerDataChannels[t][h]={channelName:S,channelType:p,transferId:null,streamId:null,channel:r},ko.setSkylinkState(o,i.room.id);})(e);}static closeDataChannel(e,t,r){On(e,t,r);}static refreshDataChannel(e,t){In(e,t);}static sendMessageToDataChannel(e,t,r,n,s){Sn(e,t,r,n,s);}}const Dn=(e,t,r)=>{const n=ko.getInitOptions(),{peerDataChannels:s,room:i,user:o,hasMCU:a}=e;let c=Object.keys(s),d=!1;if(Array.isArray(r)&&r.length?(c=r,d=!0):r&&"string"==typeof r&&(c=[r],d=!0),!i.inRoom||!o||!o.sid)return zt.log.ERROR("Unable to send message as User is not in Room. ->",t),null;if(!n.enableDataChannel)return zt.log.ERROR("Unable to send message as User does not have DataChannel enabled. ->",t),null;for(let e=0;e<c.length;e+=1){const n=c[e];s[n]||a?n===Pt.MCU?(c.splice(e,1),e-=1):a||(zt.log.DEBUG([n,"RTCDataChannel",null,`Sending ${d?"private":""} P2P message to Peer.`]),Nn.sendMessageToDataChannel(i.id,n,{type:ut.MESSAGE,isPrivate:d,sender:o.sid,target:r?n:null,data:t},"main",He.PROTOCOL)):(zt.log.ERROR([n,"RTCDataChannel",null,"Dropping of sending message to Peer as DataChannel connection does not exist."]),c.splice(e,1),e-=1);}return 0===c.length&&zt.log.WARN("Currently there are no Peers to send P2P message to."),a&&(zt.log.DEBUG([Pt.MCU,"RTCDataChannel",null,`Broadcasting ${d?"private":""} P2P message to Peers.`]),Nn.sendMessageToDataChannel(i.id,Pt.MCU,{type:ut.MESSAGE,isPrivate:d,sender:o.sid,target:c,data:t},"main",He.PROTOCOL)),!r&&a||Vt(ge({room:Ri.getRoomInfo(i),message:{targetPeerId:r||null,content:t,senderPeerId:o.sid,isDataChannel:!0,isPrivate:d},isSelf:!0,peerId:o.sid,peerInfo:fi.getCurrentSessionInfo(e.room)})),null},vn=(e,t,r)=>{const n={};return n.listOfPeers=e,n.refreshErrors=t,n.refreshSettings=r,n},yn=(e,t,r)=>{const n=[];return Object.keys(e).forEach((s=>{n.push(((e,t,r,n)=>{const s=ko.getSkylinkState(t.id),{hasMCU:i,peerInformations:o,enableIceRestart:a}=s,c=fi.getPeersCustomSettings(s),d={};return d[e]={iceRestart:!i&&o[e]&&o[e].config&&o[e].config.enableIceRestart&&a&&r,customSettings:c[e]||{}},n&&(d.errors=n),d})(e[s],t,r));})),n},Pn=(e,t)=>{const r={};return r[e]=t,r},Mn=(e,t,r,n)=>new Promise(((s,i)=>{e||i(new Error(Ft.ROOM_STATE.NO_ROOM_NAME));const{peerConnections:o,hasMCU:a,room:c}=e,d=ko.getInitOptions(),{mcuUseRenegoRestart:l}=d,{PEER_CONNECTION:E}=Ft,S=((e,t,r,n)=>{let s=!1,i={},o=Object.keys(n);return Array.isArray(e)?o=e:Hi(e)?o=[e]:xi(e)?s=e:e&&Gi(e)&&(i=e),xi(t)?s=t:t&&Gi(t)&&(i=t),r&&Gi(r)&&(i=r),{listOfPeers:o,doIceRestart:s,bwOptions:i}})(t,r,n,o),{listOfPeers:p,doIceRestart:u,bwOptions:R}=S;try{!bi(p)||a&&!l||(zt.log.ERROR(E.NO_PEER_CONNECTION),i({refreshErrors:{self:E.NO_PEER_CONNECTION},listOfPeers:p})),zt.log.INFO([null,_t.PEER_CONNECTION,null,E.REFRESH_CONNECTION.START]);lo.refreshPeerConnection(p,e,u,R).then((e=>{const t=a?[e]:e,r=[];for(let e=0;e<t.length;e+=1)if(Array.isArray(t[e])){const n=t[e];r.push(Pn(n[0],n[1])),zt.log.WARN([p,_t.PEER_CONNECTION,null,E.REFRESH_CONNECTION.FAILED],n[0]);}else Hi(t[e])&&zt.log.INFO([p,_t.PEER_CONNECTION,null,E.REFRESH_CONNECTION.SUCCESS],t[e]);r.length===p.length?i(vn(p,r,yn(p,c,u))):s(vn(p,r,yn(p,c,u)));})).catch((e=>zt.log.ERROR([null,_t.PEER_CONNECTION,null,E.REFRESH_CONNECTION.FAILED],e))).finally((()=>zt.log.INFO(E.REFRESH_CONNECTION.COMPLETED)));}catch(e){i(e);}})),kn=(e,t,r,n,s)=>{const{room:i,user:o}=e,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:a}}=Ft;cn.send(i.id,a[r.type.toUpperCase()].set_error,t,r,n,s),Vt(fe({state:rt.ERROR,peerId:n?t:o.sid,error:s,room:Ri.getRoomInfo(i)}));},wn=(e,t,r,n)=>{const s=ko.getSkylinkState(e.id),{NEGOTIATION_PROGRESS:i}=Ft;zt.log.ERROR([t,_t.SESSION_DESCRIPTION,r.type,i.FAILED_SET_LOCAL_DESCRIPTION],n),kn(s,t,r,!1,n);},bn=(e,t,r,n)=>{const s=ko.getSkylinkState(e.id),{peerConnections:i}=s,o=i[t],{type:a}=r;o.setRemoteDescriptionSuccess=!1,zt.log.ERROR([t,_t.SESSION_DESCRIPTION,a,`${Ft.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_DESCRIPTION} ->`],{error:n,state:o.signalingState,[a]:r}),kn(s,t,r,!0,n);},Ln=(e,t,r)=>{const n=ko.getSkylinkState(t.id);n.peerConnections[r]=e,ko.setSkylinkState(n,t.id);},Gn=(e,t,r)=>Ln(e,t,r),Un=(e,t,r,n)=>{const{type:s}=n,{NEGOTIATION_PROGRESS:i}=Ft,o=ko.getSkylinkState(t.id);"offer"===n.type?o.peerConnections[r].setOffer="remote":"answer"===n.type&&(o.peerConnections[r].setAnswer="remote"),o.peerConnections[r].setRemoteDescriptionSuccess=!0,ko.setSkylinkState(o,t.id),zt.log.DEBUG([r,_t.SESSION_DESCRIPTION,s,i.SET_REMOTE_DESCRIPTION],n),Vt(fe({state:rt[n.type.toUpperCase()],peerId:r,room:Ri.getRoomInfo(t)})),Jr.addIceCandidateFromQueue(r,t);},Fn=(e,t,r,n)=>{Ln(e,t,r);const s=ko.getSkylinkState(t.id),{NEGOTIATION_PROGRESS:i}=Ft;"offer"===n.type?s.peerConnections[r].setOffer="local":"answer"===n.type&&(s.peerConnections[r].setAnswer="local"),s.bufferedLocalOffer[r]=null,ko.setSkylinkState(s,t.id),zt.log.DEBUG([r,_t.SESSION_DESCRIPTION,n.type,i.SET_LOCAL_DESCRIPTION],n);},Bn=(e,t,r)=>{const n=ko.getSkylinkState(e.id),{peerConnections:s}=n,{type:i}=r,o=s[t];if(o){const n=((e,t,r)=>{const n=t;return n.sdp=so.setSDPBitrate(e,n,r),n.sdp=so.removeSDPFilteredCandidates(e,n,r),zt.log.DEBUG([e,_t.SESSION_DESCRIPTION,n.type,`Updated remote ${n.type} ->`],n),n})(t,r,e.id);return cn.send(e.id,Ft.STATS_MODULE.HANDLE_NEGOTIATION_STATS[i.toUpperCase()][i],t,n,!0),o.setRemoteDescription(n).then((()=>o))}return zt.log.ERROR([t,_t.NEGOTIATION,i,`${Ft.PEER_CONNECTION.NO_PEER_CONNECTION} - Unable to set remote ${i}`]),cn.send(e.id,Ft.STATS_MODULE.HANDLE_NEGOTIATION_STATS[i.toUpperCase()].dropped,t,r,!0,Ft.PEER_CONNECTION.NO_PEER_CONNECTION)},xn=(e,t,r)=>{const n=ko.getSkylinkState(e.id),{peerConnections:s}=n,{type:i}=r,o=s[t];return o?(cn.send(e.id,Ft.STATS_MODULE.HANDLE_NEGOTIATION_STATS[i.toUpperCase()][i],t,r,!1),o.setLocalDescription(r).then((()=>o))):(zt.log.ERROR([t,_t.NEGOTIATION,i,`${Ft.PEER_CONNECTION.NO_PEER_CONNECTION} - Unable to set local ${i}`]),cn.send(e.id,Ft.STATS_MODULE.HANDLE_NEGOTIATION_STATS[i.toUpperCase()].dropped,t,r,!0,Ft.PEER_CONNECTION.NO_PEER_CONNECTION))},Hn={enterAndWelcome:e=>{const t=ko.getSkylinkState(e.rid),r={},{hasMCU:n}=t,{rid:s,mid:i,enableIceRestart:o,enableDataChannel:a,weight:c,agent:d,os:l,temasysPluginVersion:E,SMProtocolVersion:S,DTProtocolVersion:p,version:u,publisherId:R}=e;return r.type=e.type,r.publisherId=R||null,r.rid=s,r.mid=i,r.agent=d&&Hi(d)?d:"other",r.version=(e=>{if(!e||"string"!=typeof e)return 0;if(e.indexOf(".")>-1){const t=e.split(".");if(t.length>2){const e=t[0]||"0";return t.splice(0,1),parseFloat(`${e}.${t.join("0")}`,10)}return parseFloat(e||"0",10)}return parseInt(e||"0",10)})(u),r.SMProtocolVersion=Hi(S)?S:"2.1.0",r.DTProtocolVersion=Hi(p)?p:n||i===Pt.MCU?"0.1.3":"0.1.0",r.weight=Fi(c)?c:0,r.enableDataChannel=!xi(a)||a,r.enableIceRestart=!!xi(o)&&o,r.os=l&&Hi(l)?l:null,r.temasysPluginVersion=E&&Hi(E)?E:null,r.userInfo=Hn.parseUserInfo(t,e,r),n&&(r.peersInRoom=e.peersInRoom),Yt(r)},parseUserInfo:(e,t,r)=>{const n=Object.assign({},t.userInfo);return n.config=n.config?n.config:{enableDataChannel:r.enableDataChannel,enableIceRestart:r.enableIceRestart,priorityWeight:r.weight},n.agent=n.agent?n.agent:{name:r.agent,version:r.version,os:r.os,pluginVersion:r.temasysPluginVersion,SMProtocolVersion:r.SMProtocolVersion,DTProtocolVersion:r.DTProtocolVersion},n.settings=n.settings?n.settings:{},n.mediaStatus=n.mediaStatus?n.mediaStatus:{},n}},Vn=e=>{const{currentRoom:t,targetMid:r,cert:n,userInfo:s,message:i}=e,o=ko.getSkylinkState(t.id),a=!!s.screenshare;lo.buildAndSetPeerInformations(r,i.userInfo,o),lo.addPeer({currentRoom:t,targetMid:r,peerBrowser:{agent:s.agent.name,version:s.agent.version,os:s.agent.os},cert:n,hasScreenshare:a});},jn=(e,t,r)=>{const n=ko.getSkylinkState(e.id);zt.log.DEBUG([t,_t.SESSION_DESCRIPTION,r.type,Ft.NEGOTIATION_PROGRESS.ERRORS.ADDING_REMOTE_OFFER_TO_BUFFER],r),n.bufferedRemoteOffers[t]=n.bufferedRemoteOffers[t]?n.bufferedRemoteOffers[t]:[],n.bufferedRemoteOffers[t].push(r),ko.setSkylinkState(n,e.id);},$n=e=>{const t=Hn.enterAndWelcome(e),{rid:r,mid:n,userInfo:s,publisherId:i}=t,o=ko.getSkylinkState(r),{hasMCU:a}=o,c=a&&i?i:n,d={currentRoom:o.room,targetMid:c,userInfo:s,message:t},l=ko.getSkylinkState(r);l.peerMessagesStamps[c]=l.peerMessagesStamps[c]||{userData:0,audioMuted:0,videoMuted:0},ko.setSkylinkState(l,r),"enter"===e.type?(e=>{const{currentRoom:t,userInfo:r,targetMid:n}=e,s=ko.getSkylinkState(t.id),{hasMCU:i,peerInformations:o}=s;switch(i){case!0:lo.buildAndSetPeerInformations(n,r,s),Vt(ye({peerId:n,peerInfo:fi.getPeerInfo(n,t),isSelf:!1,room:Ri.getRoomInfo(t)}));break;case!1:o[n]||(Vn(e),Vt(n===Pt.REC_SRV?Me({peerId:n,serverPeerType:Pt.REC_SRV,room:Ri.getRoomInfo(t)}):ye({peerId:n,peerInfo:fi.getPeerInfo(n,t),isSelf:!1,room:Ri.getRoomInfo(t)})));}})(d):"welcome"===e.type&&(e=>{const{currentRoom:t,targetMid:r,message:n}=e,s=ko.getSkylinkState(t.id),{hasMCU:i,peerInformations:o}=s;switch(i){case!0:if(r!==Pt.MCU||o.MCU||(Vn(e),zt.log.INFO([r,_t.PEER_CONNECTION,null,Ft.PEER_CONNECTION.MCU]),s.hasMCU=!0,Vt(Me({peerId:r,serverPeerType:Pt.MCU,room:Ri.getRoomInfo(t)})),Vt(fe({peerId:r,state:rt.WELCOME,error:null,room:Ri.getRoomInfo(t)}))),Array.isArray(n.peersInRoom)&&n.peersInRoom.length){const e=s.user.sid;for(let r=0;r<n.peersInRoom.length;r+=1){const i=n.peersInRoom[r].mid;if(i!==e){const e=Hn.enterAndWelcome(n.peersInRoom[r]).userInfo;lo.buildAndSetPeerInformations(i,e,s),Vt(ye({peerId:i,peerInfo:fi.getPeerInfo(i,t),isSelf:!1,room:Ri.getRoomInfo(t)}));}}}break;case!1:o[r]||(Vn(e),Vt(r===Pt.REC_SRV?Me({peerId:r,serverPeerType:Pt.REC_SRV,room:Ri.getRoomInfo(t)}):ye({peerId:r,peerInfo:fi.getPeerInfo(r,t),isSelf:!1,room:Ri.getRoomInfo(t)})),Vt(fe({peerId:r,state:rt.WELCOME,error:null,room:Ri.getRoomInfo(t)})));}})(d);},Wn=(e,t)=>{const r=e,{userInfo:n,rid:s,mid:i,mediaInfoList:o}=t,{room:a}=r,c=n,d=i;n&&"object"==typeof n&&(c.settings.data=!!(r.peerDataChannels[d]&&r.peerDataChannels[d].main&&r.peerDataChannels[d].main.channel&&r.peerDataChannels[d].main.channel.readyState===Be.OPEN),r.peerInformations[d].settings=c.settings||{},r.peerInformations[d].mediaStatus=c.mediaStatus||{},r.peerInformations[d].userData=c.userData),ko.setSkylinkState(r,s),fs.setPeerMediaInfo(a,d,o),fs.deleteUnavailableMedia(a,d);},Kn=(e,t)=>{if(e.bufferedRemoteOffers[t]&&!bi(e.bufferedRemoteOffers[t])){const r=e.bufferedRemoteOffers[t].shift();return zt.log.DEBUG([t,_t.SESSION_DESCRIPTION,r.type,Ft.NEGOTIATION_PROGRESS.APPLYING_BUFFERED_REMOTE_OFFER],r),r}return null},zn=(e,t,r,n,s,i,o)=>({DEBUG:()=>(zt.log.DEBUG([e,_t.NEGOTIATION,t,i],o),cn.send(r.id,Ft.STATS_MODULE.HANDLE_NEGOTIATION_STATS[t.toUpperCase()].dropped,e,n,s,i)),ERROR:()=>(zt.log.ERROR([e,_t.NEGOTIATION,t,i],o||null),cn.send(r.id,Ft.STATS_MODULE.HANDLE_NEGOTIATION_STATS[t.toUpperCase()].error,e,n,s,i))}),Yn=(e,t)=>{const r=ko.getSkylinkState(e.id),{bufferedRestart:n}=r;n[t]&&(delete r.bufferedRestart[t],ko.setSkylinkState(r,e.id),zt.log.DEBUG([t,_t.NEGOTIATION,null,Ft.NEGOTIATION_PROGRESS.APPLY_BUFFERED_RESTART]),es(r,t,n.doIceRestart));};class Jn{static _changeState(e,t,r){const n=ko.getSkylinkState(e);n.negotiationState[t]=r,ko.setSkylinkState(n,e);}static _getState(e,t){return ko.getSkylinkState(e).negotiationState[t]}static clearState(e,t){const r=ko.getSkylinkState(e);delete r.negotiationState[t],ko.setSkylinkState(r,e);}static changeState(e,t,r){return this._changeState(e,t,r)}static getState(e,t){return this._getState(e,t)}static onEnterReceived(e){const{rid:t,mid:r,publisherId:n}=e,s=ko.getSkylinkState(t),{hasMCU:i,room:o}=s,a=i&&n?n:r;if(!s.peerConnections[a]){this._changeState(t,a,Lt.ENTERING),$n(e),this._changeState(t,a,Lt.WELCOMING);(new ii).welcome(o,a);}}static onWelcomeReceived(e){const{rid:t,mid:r,publisherId:n,type:s}=e,i=ko.getSkylinkState(t),{hasMCU:o,room:a}=i,c=o&&n?n:r,d=this._getState(t,c);return d?zn(c,s,a,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.DROPPING_WELCOME_NEG_STATE,`Current state: ${d}`).DEBUG():o&&c!==Pt.MCU?zn(c,s,a,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.DROPPING_WELCOME_MCU_FORWARDED,`Current state: ${d}`).DEBUG():!i.peerConnections[c]&&($n(e),Xn(a,c).then((e=>{this._changeState(t,c,Lt.LOCAL_OFFER_SENT),Zn(a,e);})))}static onOfferReceived(e){const{rid:t,mid:r,publisherId:n,weight:s,type:i,sdp:o}=e,a=ko.getSkylinkState(t),{hasMCU:c,room:d,peerPriorityWeight:l}=a,E=c&&n?n:r,S={type:i,sdp:c?o.replace(/\r\n/g,"\n").split("\n").join("\r\n"):o};let p,u;const R=this._getState(t,E);if(R===Lt.LOCAL_OFFER_SENT&&l>s)return zn(E,i,d,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.OFFER_TIEBREAKER,{selfWeight:l,messageWeight:s}).DEBUG();if(R!==Lt.WELCOMING&&R!==Lt.NEGOTIATED&&R!==Lt.LOCAL_OFFER_SENT)return jn(d,E,e);this._changeState(t,E,Lt.REMOTE_OFFER_RECEIVED);try{return Wn(a,e),as(d,E,S).then((e=>(this._changeState(t,E,Lt.REMOTE_OFFER_SET),ls(e,d,E,S),Qn(a,E)))).catch((e=>Ss(d,E,S,e))).then((e=>(u=e,p={type:u.type,sdp:u.sdp},rs(d,E,p)))).then((e=>{this._changeState(t,E,Lt.LOCAL_ANSWER_SET),ss(e,d,E,p),qn(d,u);})).catch((e=>os(d,E,p,e)))}catch(e){return zn(r,i,d,u,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.FAILED_PROCESSING_OFFER,e).ERROR()}}static onAnswerReceived(e){const{rid:t,mid:r,publisherId:n,type:s,sdp:i}=e,o=ko.getSkylinkState(t),{hasMCU:a,room:c,bufferedLocalOffer:d}=o,l=a&&n?n:r,E=this._getState(t,l);if(E!==Lt.LOCAL_OFFER_SENT)return zn(l,s,c,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.DROPPING_ANSWER,`Current state: ${E}`).DEBUG();if(!d[l])return zn(l,s,c,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.NO_LOCAL_BUFFERED_OFFER).ERROR();this._changeState(t,l,Lt.REMOTE_ANSWER_RECEIVED);try{Wn(o,e);const r=d[l],n={type:s,sdp:a?i.replace(/\r\n/g,"\n").split("\n").join("\r\n"):i};return ts(c,l,r).then((e=>(this._changeState(t,l,Lt.LOCAL_OFFER_SET),ns(e,c,l,r)))).catch((e=>is(c,l,r,e))).then((()=>cs(c,l,n))).then((e=>(this._changeState(t,l,Lt.REMOTE_ANSWER_SET),Es(e,c,l,n)))).catch((e=>ps(c,l,n,e))).then((()=>(this._changeState(t,l,Lt.NEGOTIATED),ds(c,l,!0),Yn(c,l))))}catch(t){return zn(r,s,c,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.FAILED_PROCESSING_ANSWER,t).ERROR()}}static onAnswerAckReceived(e){const{rid:t,mid:r,publisherId:n,type:s,success:i}=e,o=ko.getSkylinkState(t),{hasMCU:a,room:c}=o,d=a&&n?n:r,l=o.peerConnections[d],E=this._getState(t,d);if(E!==Lt.LOCAL_ANSWER_SET)return zn(d,s,c,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.DROPPING_ANSWER_ACK,`Current state: ${E}`).DEBUG();if(!i)return zn(r,s,c,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_ANSWER).ERROR();this._changeState(t,d,Lt.NEGOTIATED);try{const t=Kn(o,d);return t?this.onOfferReceived(t):hs.renegotiateIfNeeded(o,d).then((t=>{t?(zn(r,s,c,e,!0,Ft.NEGOTIATION_PROGRESS.RESET_SET_REMOTE_DESCRIPTION_SUCCESS).DEBUG(),l.setRemoteDescriptionSuccess=null,Mn(o,d).catch((t=>zn(r,s,c,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.FAILED_RENEGOTIATION,t).ERROR()))):Yn(c,d);}))}catch(t){return zn(r,s,c,e,!0,Ft.NEGOTIATION_PROGRESS.ERRORS.FAILED_PROCESSING_ANSWER_ACK,t).ERROR()}}}const Qn=(e,t)=>lo.createAnswer(e,t),qn=(e,t)=>{const r=ko.getSkylinkState(e.id);(new ii).answer(r,t);},Xn=(e,t,r,n)=>lo.createOffer(e,t,r,n),Zn=(e,t)=>{const r=ko.getSkylinkState(e.id);(new ii).offer(r,t);},es=(e,t,r)=>{const{room:n}=e,s=new ii;try{if(Jn.getState(n.id,t)!==Lt.NEGOTIATED){const s=e;return s.bufferedRestart[t]={doIceRestart:r},ko.setSkylinkState(s,n.id),zt.log.DEBUG([t,_t.NEGOTIATION,null,Ft.NEGOTIATION_PROGRESS.BUFFERING_RESTART])}const i=s.messageBuilder.getRestartOfferMessage(n.id,t,r);return Xn(n,t,r,i).then((e=>(Jn.changeState(n.id,t,Lt.LOCAL_OFFER_SENT),Zn(n,e),t)))}catch(e){return [t,e]}},ts=(e,t,r)=>xn(e,t,r),rs=(e,t,r)=>xn(e,t,r),ns=(e,t,r,n)=>Fn(e,t,r,n),ss=(e,t,r,n)=>Fn(e,t,r,n),is=(e,t,r,n)=>wn(e,t,r,n),os=(e,t,r,n)=>wn(e,t,r,n),as=(e,t,r)=>Bn(e,t,r),cs=(e,t,r)=>Bn(e,t,r),ds=(e,t,r)=>{const n=ko.getSkylinkState(e.id);(new ii).answerAck(n,t,r);},ls=(e,t,r,n)=>{Gn(e,t,r),Un(0,t,r,n);},Es=(e,t,r,n)=>{Gn(e,t,r),Un(0,t,r,n);const s=ko.getSkylinkState(t.id),i=s.peerConnections[r],{DATA_CHANNEL:o}=Ft;s.peerDataChannels[r]&&(-1===i.remoteDescription.sdp.indexOf("m=application")||i.remoteDescription.sdp.indexOf("m=application 0")>0)&&(zt.log.WARN([r,_t.PEER_CONNECTION,null,`${o.CLOSING} - ${o.NO_REMOTE_DATA_CHANNEL}`]),lo.closeDataChannel(t.id,r));},Ss=(e,t,r,n)=>bn(e,t,r,n),ps=(e,t,r,n)=>{bn(e,t,r,n),ds(e,t,!1);},us=(e,t,r)=>{const n=ko.getSkylinkState(t.room.id),{peerConnections:s,streamsBandwidthSettings:i,peerEndOfCandidatesCounter:o,room:a,user:c}=n,{doIceRestart:d,bwOptions:l}=r,E=new ii,S=[];return new Promise((t=>{if(!s[e])return zt.log.ERROR([e,null,null,Ft.PEER_CONNECTION.ERRORS.NOT_FOUND]),S.push(Ft.PEER_CONNECTION.ERRORS.NOT_FOUND),t([e,S]);const r=s[e];if(0!==S.length)return t([e,S]);if(r.signalingState===Xe.STABLE)return zt.log.INFO([e,null,null,Ft.PEER_CONNECTION.REFRESH_CONNECTION.SEND_RESTART_OFFER],{iceRestart:d,options:l}),n.streamsBandwidthSettings.bAS=l.bandwidth||i.bAS,n.peerEndOfCandidatesCounter[e]=o[e]||{},n.peerEndOfCandidatesCounter[e].len=0,ko.setSkylinkState(n,n.room.id),t(es(n,e,d));const p=r.localDescription&&r.localDescription.sdp;return r.signalingState===Xe.HAVE_LOCAL_OFFER&&p?(E.sendMessage({type:r.localDescription.type,sdp:r.localDescription.sdp,mid:c.sid,target:e,rid:a.id,restart:!0}),t(e)):(zt.log.DEBUG([e,_t.PEER_CONNECTION,null,Ft.PEER_CONNECTION.REFRESH_CONNECTION.NO_LOCAL_DESCRIPTION],{localDescription:r.localDescription,remoteDescription:r.remoteDescription,signalingState:r.signalingState}),S.push(Ft.PEER_CONNECTION.REFRESH_CONNECTION.NO_LOCAL_DESCRIPTION),t([e,S]),null)}))},Rs=(e,t,r)=>us(e,t,r),hs={createOffer:(e,t,r=!1,n)=>{const s=ko.getSkylinkState(e.id),i=ko.getInitOptions(),{enableDataChannel:o}=i,{peerConnections:a,hasMCU:c,enableIceRestart:d,peerInformations:l,voiceActivityDetection:E,peerDataChannels:S}=s,p=a[t],u={iceRestart:!!((l[t]||{}).config||{}).enableIceRestart&&r&&d,voiceActivityDetection:E};return c&&"function"!=typeof p.addTransceiver&&(u.offerToReceiveVideo=!0),c&&t!==Pt.MCU||on.addLocalMediaStreams(t,s),o&&l[t].config.enableDataChannel&&(S[t]&&S[t].main||(lo.createDataChannel({peerId:t,roomState:s,createAsMessagingChannel:!0}),s.peerConnections[t].hasMainChannel=!0)),zt.log.DEBUG([t,null,null,"Creating offer with config:"],u),p.endOfCandidates=!1,p.sdpConstraints=u,ko.setSkylinkState(s,e.id),new Promise(((e,r)=>{p.createOffer(u).then((r=>((e,t,r,n,s)=>{const{room:i}=r;zt.log.DEBUG([t,null,null,"Created offer"],s),cn.send(i.id,dn.OFFER.create,t,s,!1),an(e,t,r,s,n);})(e,t,s,n,r))).catch((e=>((e,t,r,n)=>{const{room:s}=r;zt.log.ERROR([t,null,null,"Failed creating an offer:"],n),cn.send(s.id,dn.OFFER.create_error,t,null,!1,n),Vt(fe({state:rt.ERROR,peerId:t,error:n,room:Ri.getRoomInfo(r.room)})),e(n);})(r,t,s,e)));}))},createAnswer:(e,t)=>{const r=ko.getSkylinkState(e.room.id),{peerConnections:n,hasMCU:s,voiceActivityDetection:i}=r,o=n[t],a={voiceActivityDetection:i};return zt.log.INFO([t,null,null,"Creating answer with config:"],a),s&&t!==Pt.MCU||on.addLocalMediaStreams(t,e),new Promise(((r,n)=>o.createAnswer(a).then((n=>((e,t,r,n)=>{const{room:s}=r;zt.log.DEBUG([t,null,null,"Created answer"],n),cn.send(s.id,En.ANSWER.create,t,n,!1),an(e,t,r,n);})(r,t,e,n))).catch((r=>((e,t,r,n)=>{const{room:s}=r;zt.log.ERROR([t,null,null,"Failed creating an answer:"],n),cn.send(s.id,En.ANSWER.create_error,t,null,!1,n),Vt(fe({state:rt.ERROR,peerId:t,error:n,room:Ri.getRoomInfo(r.room)})),e(n);})(n,t,e,r)))))},addPeer:e=>{let t=null;const{currentRoom:r,targetMid:n,peerBrowser:s,cert:i,hasScreenShare:o}=e,a=ko.getInitOptions(),c=ko.getSkylinkState(r.id),{peerConnections:d,room:l}=c;if(d[n])zt.log.WARN([n,null,null,"Connection to peer has already been made."]);else {zt.log.INFO([n,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:s,enableDataChannel:a.enableDataChannel}),t=ln({currentRoom:r,targetMid:n,hasScreenShare:o,cert:i,sdpSemantics:gt.UNIFIED});try{const e=t.getConfiguration();e.sdpSemantics===gt.UNIFIED?zt.log.INFO([n,"SDP Semantics",null,"Peer Connection has Unified plan."]):e.sdpSemantics===gt.PLAN_B?zt.log.INFO([n,"SDP Semantics",null,"Peer Connection has Plan-B."]):zt.log.INFO([n,"SDP Semantics",null,"The sdpSemantics parameter is not supported by this browser version."]);}catch(e){zt.log.INFO([n,"SDP Semantics",null,"getConfiguration() is not available in this browser version. Ex : "],e);}c.peerConnections[n]=t,ko.setSkylinkState(c,r.id),jr.send(l.id,"new",n,!1);}return t},sendP2PMessage:(e,t,r)=>{const n=Wi(e);if(n)Dn(n,t,r);else {const e=ko.getSkylinkState(),n=Object.keys(e);for(let s=0;s<n.length;s+=1){const i=e[n[s]];Dn(i,t,r);}}},getPeersInRoom:e=>{const t=Wi(e);if(t){const e={},r=Object.keys(t.peerInformations);for(let n=0;n<r.length;n+=1)r[n]!==Pt.MCU&&(e[r[n]]=Object.assign({},fi.getPeerInfo(r[n],t.room)),e[r[n]].isSelf=!1);return t.user&&t.user.sid&&(e[t.user.sid]=Object.assign({},fi.getCurrentSessionInfo(t.room)),e[t.user.sid].isSelf=!0),e}return null},signalingEndOfCandidates:(e,t)=>{const r=ko.getSkylinkState(t.room.id),n=r.peerEndOfCandidatesCounter[e],s=r.peerConnections[e],i=r.peerCandidatesQueue[e],o=r.gatheredCandidates[e],{TAGS:a}=Ut,{ICE_CONNECTION:c}=Ft;if(!n)return null;if(s&&s.signalingState!==Xe.CLOSED&&s.remoteDescription&&s.remoteDescription.sdp&&"number"==typeof n.expectedLen&&n.len>=n.expectedLen&&(!i||0===i.length)&&!n.hasSet){zt.log.DEBUG([e,a.PEER_CONNECTION,null,c.END_OF_CANDIDATES_SUCCESS]),n.hasSet=!0;try{if(o){const t={expected:n.expectedLen||0,received:n.len||0,processed:o.receiving.srflx.length+o.receiving.relay.length+o.receiving.host.length};Vt((d={room:Ri.getRoomInfo(r.room),peerId:e,candidatesLength:t},new Se("candidatesGathered",{detail:d})));}r.peerEndOfCandidatesCounter[e]=n,ko.setSkylinkState(r,t.room.id);}catch(t){zt.log.ERROR([e,a.PEER_CONNECTION,null,c.END_OF_CANDIDATES_FAILURE],t);}}var d;return null},refreshConnection:Mn,refreshPeerConnection:(e,t,r=!1,n={})=>{const s=ko.getSkylinkState(t.room.id),{hasMCU:i}=s;try{if(!i){const t=[];for(let i=0;i<e.length;i+=1){const o=e[i],a=Rs(o,s,{doIceRestart:r,bwOptions:n});t.push(a);}return Promise.all(t)}return ((e,t,r)=>new Promise((n=>{const s=e,i=ko.getInitOptions(),{mcuUseRenegoRestart:o}=i;try{s.streamsBandwidthSettings.bAS=r.bandwidth||s.streamsBandwidthSettings.bAS,o&&(s.peerEndOfCandidatesCounter.MCU=s.peerEndOfCandidatesCounter.MCU||{},s.peerEndOfCandidatesCounter.MCU.len=0,ko.setSkylinkState(s),n(es(s,Pt.MCU,t)));}catch(e){n([Pt.MCU,e]);}})))(t,r,n)}catch(e){return zt.log.ERROR([null,_t.PEER_CONNECTION,null,Ft.PEER_CONNECTION.REFRESH_CONNECTION.FAILED],e),null}},restartPeerConnection:us,buildAndSetPeerInformations:(e,t,r)=>{const n=r,s=t;return s.room=r.room.roomName,s.settings.data=!!(r.peerDataChannels[e]&&r.peerDataChannels[e].main&&r.peerDataChannels[e].main.channel&&r.peerDataChannels[e].main.channel.readyState===Be.OPEN),n.peerInformations[e]=s,ko.setSkylinkState(n,r.room.id),s},getConnectionStatus:(e,t=null)=>{const{ROOM_STATE:r}=Ft;if(!e)return zt.log.WARN(r.NO_ROOM_NAME),Ji(r.NO_ROOM_NAME);const{room:n}=e,s=((e,t)=>{const{peerConnections:r,room:n}=e,{PEER_CONNECTION:s}=Ft;let i=null,o=null;return bi(Object.keys(r))?o=s.NOT_INITIALISED:Array.isArray(t)?(i=t,i.forEach((e=>{Qi(n,e)||(o=`${s.PEER_ID_NOT_FOUND} ${e}`);}))):Hi(t)?(Qi(n,t)||(o=`${s.PEER_ID_NOT_FOUND} ${t}`),i=[t]):i=Object.keys(r),{peerIds:i,errorMsg:o}})(e,t);if(s.errorMsg)return zt.log.WARN(s.errorMsg),Ji(s.errorMsg);const{peerIds:i}=s,o=[];for(let e=0;e<i.length;e+=1){const t=new co(n.id,i[e]);o.push(t.getConnectionStatus());}return Promise.all(o)},closePeerConnection:(e,t)=>{const r=ko.getSkylinkState(e.room.id),{peerConnections:n,room:s}=r;n[t].close(),ko.setSkylinkState(r,s.id);},updatePeerInformationsMediaStatus:(e,t,r,n)=>{const s=ko.getSkylinkState(e.id);s.peerInformations[t].mediaStatus=((e,t,r,n)=>{const{peerMedias:s,peerInformations:i}=e,o=s[t],a=i[t].mediaStatus||{};return Object.values(o).forEach((e=>{e.transceiverMid===r.mid&&(a[n.id]={audioMuted:qi(n)?e.mediaState===Ot.MUTED?0:1:-1,videoMuted:Xi(n)?e.mediaState===Ot.MUTED?0:1:-1});})),delete a.audioMuted,delete a.videoMuted,a})(s,t,r,n),ko.setSkylinkState(s,e.id);},processNewSender:(e,t,r)=>{const n=e;n.currentRTCRTPSenders[t]||(n.currentRTCRTPSenders[t]=[]),n.currentRTCRTPSenders[t].push(r),ko.setSkylinkState(n,n.room.id);},renegotiateIfNeeded:(e,t)=>{const{peerConnections:r,currentRTCRTPSenders:n,hasMCU:s}=e,i=ko.getInitOptions(),{AdapterJS:o}=window;return new Promise((e=>{const a=r[t],c=a.getSenders()?a.getSenders():[],d=[],l=n[t]||[];let E=!1;if(bi(a.constraints.iceServers)&&i.forceTURN&&!s)return zt.log.WARN([null,_t.PEER_CONNECTION,null,Ft.NEGOTIATION_PROGRESS.ERRORS.STOP_RENEGOTIATION_FORCE_TURN]),e(E);const S=[];c.forEach((e=>{e.track&&(S.push(e),d.push(e.getStats()));}));const p={};Promise.all(d).then((t=>{t.forEach(((e,t)=>{e.forEach((e=>{e&&e.ssrc?(o.webrtcDetectedBrowser===yt.FIREFOX&&0!==e.bytesSent||o.webrtcDetectedBrowser!==yt.FIREFOX)&&(p[e.ssrc]=S[t]):e&&"ssrc"===e.type&&e.id.indexOf("send")>1&&e.values.forEach((e=>{e.ssrc&&(p[e.ssrc]=S[t]);}));}));}));const r=Object.keys(p);if(r.length!==l.length)E=!0;else {let e=0;for(let t=0;t<r.length;t+=1){const n=p[r[t]];for(let t=0;t<l.length;t+=1){if(n===l[t]){e+=1;break}}}E=e!==r.length;}e(E);}));}))}},ms={ontrack:(e,t,r,n)=>{const s=ko.getSkylinkState(r.room.id),{peerConnections:i,room:o,hasMCU:a}=s,c=n.streams[0],{transceiver:d,track:l}=n;let E=t;if(!c)return zt.log.WARN("ontrack stream is null"),null;if(null===d.mid&&zt.log.WARN("Transceiver mid is null",d),!i[E])return null;a&&(E=((e,t)=>{const{peerMedias:r,user:n}=e,s=Object.keys(r);for(let e=0;e<s.length;e+=1)if(s[e]!==n.sid){const n=Object.values(r[s[e]]);for(let r=0;r<n.length;r+=1)if(n[r].transceiverMid===t.mid)return s[e]}return null})(s,d));const S=fs.retrieveScreenMediaInfo(s.room,E,{transceiverMid:d.mid}),p=[E,o,S];return c.onremovetrack=ms.onremovetrack.bind(void 0,...p),fs.updateStreamIdFromOntrack(s.room,E,d.mid,c.id),lo.updatePeerInformationsMediaStatus(s.room,E,d,c),tn.addStream(E,c,o.id),(new en).send(o.id),on.onRemoteTrackAdded(c,r,E,S,l.kind===Ct.VIDEO,l.kind===Ct.AUDIO),null},ondatachannel:(e,t,r,n)=>{const s=n.channel||n,i=ko.getInitOptions(),o=ko.getSkylinkState(r.room.id),{peerInformations:a}=o,{enableDataChannel:c}=i;zt.log.DEBUG([t,"RTCDataChannel",s.label,"Received datachannel ->"],s),c&&a[t].config.enableDataChannel?(e.hasMainChannel||(e.hasMainChannel=!0),lo.createDataChannel({peerId:t,dataChannel:s,roomState:r})):zt.log.WARN([t,"RTCDataChannel",s.label,"Not adding datachannel as enable datachannel is set to false"]);},onicecandidate:(e,t,r,n)=>{Jr.onIceCandidate(t,n.candidate||n,r.room);},oniceconnectionstatechange:(e,t,r)=>{const{ROOM_STATE:n,ICE_CONNECTION:s,PEER_CONNECTION:i}=Ft,{ICE_CONNECTION_STATE:o,PEER_CONNECTION_STATE:a,BROWSER_AGENT:c}=Ut,d=ko.getSkylinkState(r.room.id),{peerStreams:l,user:E,enableStatsGathering:S}=d,p=ko.getInitOptions();let u=null;const R=e.iceConnectionState;if(Zi(c.REACT_NATIVE)&&!d&&R===o.CLOSED)return;if(!d)return void zt.log.DEBUG([t,"RTCIceConnectionState",null,n.NOT_FOUND]);const{peerStats:h}=d;if(R===o.FAILED&&Zi(c.FIREFOX)&&!l[E.sid])return;zt.log.DEBUG([t,"RTCIceConnectionState",null,s.STATE_CHANGE],R);const m=new qr;m.send(r.room.id,e.iceConnectionState,t),Vt(Ie({state:R,peerId:t})),!u&&(e=>{const{ICE_CONNECTION_STATE:t}=Ut;return [t.COMPLETED,t.CONNECTED].indexOf(e)>-1})(R)&&!h[t]&&S&&(u=!0,h[t]={},zt.log.DEBUG([t,"RTCStatsReport",null,"Retrieving first report to tabulate results"]),lo.getConnectionStatus(d,t).then((()=>{u=setInterval((()=>{const n=ko.getSkylinkState(d.room.id);n&&n.room.inRoom?e.connectionState===a.CLOSED||e.iceConnectionState===o.CLOSED?(e.connectionState===a.CLOSED&&(zt.log.DEBUG([t,"RTCPeerConnectionState",null,i.STATE_CHANGE],e.connectionState),Vt(be({state:a.CLOSED,peerId:t}))),e.iceConnectionState===o.CLOSED&&(zt.log.DEBUG([t,"RTCIceConnectionState",null,s.STATE_CHANGE],e.iceConnectionState),m.send(r.room.id,e.iceConnectionState,t),Vt(Ie({state:o.CLOSED,peerId:t}))),clearInterval(u)):(new Zr).send(d.room.id,e,t):clearInterval(u);}),1e3*p.statsInterval);})));},onicegatheringstatechange:(e,t,r)=>{const{ICE_CONNECTION:n}=Ft,{iceGatheringState:s}=e;zt.log.INFO([t,"RTCIceGatheringState",null,n.STATE_CHANGE],s),Vt(Ae({state:s,room:Ri.getRoomInfo(r.room),peerId:t}));},onsignalingstatechange:(e,t)=>{const{PEER_CONNECTION:r}=Ft;zt.log.DEBUG([t,"RTCPeerConnectionSignalingState",null,r.STATE_CHANGE],e.signalingState),Vt(be({state:e.signalingState,peerId:t}));},onremovetrack:(e,t,r,n)=>{const s=$i(t.id),{peerInformations:i}=s,{MEDIA_STREAM:o,PEER_INFORMATIONS:a}=Ft,c=Zi(yt.REACT_NATIVE)?n.stream:n.target;zt.log.INFO([e,_t.MEDIA_STREAM,null,o.REMOTE_TRACK_REMOVED],{peerId:e,isSelf:!1,isScreensharing:r,track:n.track}),i[e]?c?(((e,t,r)=>{const n=e;delete n.peerInformations[t].mediaStatus[r],tn.deleteStream(t,n.room,r),ko.setSkylinkState(n,n.room.id);})(s,e,c.id),((e,t,r,n,s)=>{tn.dispatchStreamEvent("streamEnded",{room:e.room,peerId:t,peerInfo:fi.getPeerInfo(t,e.room),isSelf:!1,isScreensharing:r,streamId:s.id,isVideo:n.track.kind===Ct.VIDEO,isAudio:n.track.kind===Ct.AUDIO});})(s,e,r,n,c),((e,t)=>{Vt(ve({peerId:t,peerInfo:fi.getPeerInfo(t,e.room),isSelf:!1}));})(s,e)):zt.log.DEBUG([e,_t.MEDIA_STREAM,null,`${o.ERRORS.DROPPING_ONREMOVETRACK}`-`${o.NO_STREAM}`]):zt.log.DEBUG([e,_t.MEDIA_STREAM,null,`${o.ERRORS.DROPPING_ONREMOVETRACK}`-`${a.NO_PEER_INFO} ${e}`]);},onsenderadded:(e,t,r,n)=>{const s=ko.getSkylinkState(r.room.id),{sender:i}=n;hs.processNewSender(s,t,i);},onconnectionstatechange:(e,t,r)=>{const{room:n}=r,{connectionState:s,iceConnectionState:i}=e;(new qr).send(n.id,s===Xe.FAILED?Qe.FAILED:i,t),zt.log.DEBUG([t,"RTCPeerConnectionState",null,Ft.PEER_CONNECTION.STATE_CHANGE],e.connectionState),Vt(be({state:s,peerId:t}));}},gs={retrieveTransceiverMid:(e,t)=>{const r=ko.getSkylinkState(e.id),{peerConnections:n}=r,s=Object.values(n);let i=null;for(let e=0;e<s.length;e+=1){const r=s[e].getTransceivers();for(let e=0;e<r.length;e+=1)if(r[e].sender.track&&r[e].sender.track.id===t.id){i=r[e].mid;break}}return i},retrieveMediaState:e=>e.readyState===It.ENDED?Ot.UNAVAILABLE:e.muted?Ot.MUTED:Ot.ACTIVE,retrieveMediaId:(e,t)=>`${e===Ct.AUDIO?"AUDIO":"VIDEO"}_${t}`,buildPeerMediaInfo:(e,t,r,n,s)=>({publisherId:t,mediaId:gs.retrieveMediaId(r.kind,n),mediaType:s,mediaState:gs.retrieveMediaState(r),transceiverMid:gs.retrieveTransceiverMid(e,r),streamId:n,trackId:r.id,mediaMetaData:"",simulcast:""}),retrieveStreamIdOfTrack:(e,t)=>{const r=ko.getSkylinkState(e.id),{peerStreams:n,user:s}=r,i=Object.values(n[s.sid]);let o=null;for(let e=0;e<i.length;e+=1){const r=i[e].getTracks();for(let n=0;n<r.length;n+=1)if(Qr(r[n],t)){o=i[e].id;break}}return o},updatePeerMediaInfo:(e,t,r,n,s=!1,i=!1,o=!1)=>{try{((e,t,r,n,s=!1,i=!1,o=!1)=>{const a=ko.getSkylinkState(e.id);!o&&s&&i?(a.peerMedias[t][n][s]=i,zt.log.INFO([t,_t.PEER_MEDIA,null,`${Ft.MEDIA_INFO.UPDATE_SUCCESS} -- ${n} - ${s}: ${i}`])):!o||s||i||(a.peerMedias[t]=a.peerMedias[t]||{},a.peerMedias[t][n]=o),ko.setSkylinkState(a,e.id);})(e,t,0,n,s,i,o),((e,t,r,n)=>{const s=ko.getSkylinkState(e.id);s.user.sid===t&&r&&gs.sendMediaInfoMsg(e,s.peerMedias[t][n]);})(e,t,r,n);}catch(e){const r=o?JSON.stringify(o):`${n} - ${s}: ${i}`;zt.log.ERROR([t,_t.PEER_MEDIA,null,`${Ft.MEDIA_INFO.ERRORS.FAILED_UPDATING} -- ${r}`],e);}},sendMediaInfoMsg:(e,t)=>{const r=new ii,n=ko.getSkylinkState(e.id),{user:s,hasMCU:i,peerConnections:o}=n;(i?[Pt.MCU]:Object.keys(o).filter((e=>e!==s.sid&&e!==Pt.MCU))).forEach((e=>{r.mediaInfoEvent(n,e,t);}));},parseSDPForTransceiverMid:(e,t,r)=>{const n=ko.getSkylinkState(e.id),{peerMedias:s}=n,{beSilentOnParseLogs:i}=ko.getInitOptions(),o=Object.values(s[t]),a=so.getTransceiverMid(r,i),c=a.audio,d=a.video;for(let r=0;r<o.length;r+=1){const n=o[r];n.transceiverMid=n.mediaState===Ot.UNAVAILABLE?n.transceiverMid:null;for(let r=0;r<c.length;r+=1)if(c[r].streamId===n.streamId&&("sendonly"===c[r].direction||"sendrecv"===c[r].direction)){gs.updatePeerMediaInfo(e,t,!1,n.mediaId,Nt.TRANSCEIVER_MID,c[r].transceiverMid);break}for(let r=0;r<d.length;r+=1)if(d[r].streamId===n.streamId&&("sendonly"===d[r].direction||"sendrecv"===d[r].direction)){gs.updatePeerMediaInfo(e,t,!1,n.mediaId,Nt.TRANSCEIVER_MID,d[r].transceiverMid);break}}},retrieveValueGivenTransceiverMid:(e,t,r,n)=>{const{peerMedias:s}=e,i=Object.values(s[t]);for(let e=0;e<i.length;e+=1)if(i[e].transceiverMid===r)return i[e][n];return null},retrieveFormattedMediaInfo:(e,t)=>{const r=ko.getSkylinkState(e.id),{peerMedias:n}=r,s=Object.values(n[t]),i=[];for(let e=0;e<s.length;e+=1){const t=s[e],r=Yt(t);delete r.trackId,delete r.streamId,i.push(r);}return i},resetPeerMedia:(e,t)=>{const r=ko.getSkylinkState(e.id);return r.peerMedias[t]&&(r.peerMedias[t]={}),r},populatePeerMediaInfo:(e,t,r)=>{const n=e.peerMedias[r.publisherId]||{};return n[r.mediaId]=r,((e,t)=>!wi(e)&&e[t])(t,r.mediaId)&&(n[r.mediaId].streamId=r.transceiverMid===t[r.mediaId].transceiverMid?t[r.mediaId].streamId:""),n},processOnRemoveTrack:(e,t,r)=>{if(Zi(yt.REACT_NATIVE)&&r){const{room:n}=e,s={track:{id:null,kind:null}},i={id:null};if(s.track.id=r.trackId,s.track.kind=r.mediaType===At.AUDIO||r.mediaType===At.AUDIO_MIC?Ct.AUDIO:Ct.VIDEO,i.id=r.streamId,s.stream=i,!(s.track.id||s.track.kind||i.id))return void zt.log.DEBUG([t,_t.MEDIA_STREAM,null,`${Ft.BROWSER_AGENT.REACT_NATIVE.ERRORS.DROPPING_ONREMOVETRACK}`],s);ms.onremovetrack(t,n,r.mediaType===At.VIDEO_SCREEN,s);}}};class fs{static updatePeerMediaWithUserSid(e,t){const r=ko.getSkylinkState(e.id);r.peerMedias[t]=Object.assign({},r.peerMedias.null),delete r.peerMedias.null,ko.setSkylinkState(r,e.id),Object.keys(r.peerMedias[t]).forEach((r=>{gs.updatePeerMediaInfo(e,t,!1,r,Nt.PUBLISHER_ID,t);}));}static updateStreamIdFromOntrack(e,t,r,n){const s=ko.getSkylinkState(e.id),i=gs.retrieveValueGivenTransceiverMid(s,t,r,Nt.MEDIA_ID);gs.updatePeerMediaInfo(e,t,!1,i,Nt.STREAM_ID,n);}static isVideoScreenTrack(e,t,r){const{peerMedias:n}=e,s=Object.values(n[t]);for(let e=0;e<s.length;e+=1)if(s[e].transceiverMid===r)return s[e].mediaType===At.VIDEO_SCREEN;return !1}static setMediaStateToUnavailable(e,t,r){gs.updatePeerMediaInfo(e,t,!1,r,Nt.MEDIA_STATE,Ot.UNAVAILABLE);}static deleteUnavailableMedia(e,t,r=null){const n=ko.getSkylinkState(e.id);if(t===Pt.MCU||!n.peerMedias[t])return;let s;if(r)s=Yt(n.peerMedias[t][r]),delete n.peerMedias[t][r];else {const e=n.peerMedias[t];Object.values(e).forEach((e=>{e.mediaState===Ot.UNAVAILABLE&&(s=Yt(e),delete n.peerMedias[t][e.mediaId]);}));}ko.setSkylinkState(n,e.id),gs.processOnRemoveTrack(n,t,s),s&&Vt(((e={})=>new Se("mediaInfoDeleted",{detail:e}))({mediaInfo:s}));}static updatePeerMediaInfo(e,t,r,n,s){gs.updatePeerMediaInfo(e,t,!0,r,n,s);}static setPeerMediaInfo(e,t,r=[]){try{const n=ko.getSkylinkState(e.id);if(t!==Pt.MCU||bi(r)){if(t!==Pt.MCU){const s=Yt(n.peerMedias[t])||{},i=gs.resetPeerMedia(e,t);r.forEach((e=>{i.peerMedias[e.publisherId]=gs.populatePeerMediaInfo(i,s,e);})),ko.setSkylinkState(i,e.id);}}else {const t=[];r.forEach((e=>{-1===t.indexOf(e.publisherId)&&t.push(e.publisherId);})),t.forEach((t=>{const n=r.filter((e=>{if(e.publisherId===t)return e}));this.setPeerMediaInfo(e,t,n);}));}}catch(e){zt.log.ERROR([t,_t.PEER_MEDIA,null,Ft.MEDIA_INFO.ERRORS.FAILED_SETTING_PEER_MEDIA_INFO]);}}static retrieveStreamId(e,t,r){const n=ko.getSkylinkState(e.id),{peerMedias:s}=n,i=s[t][r],{streamId:o}=i;return o||zt.log.ERROR([t,_t.PEER_MEDIA,null,Ft.MEDIA_INFO.ERRORS.NO_ASSOCIATED_STREAM_ID]),o}static retrieveMediaId(e,t){return gs.retrieveMediaId(e,t)}static retrieveMediaInfoForOfferAnswer(e,t){const r=ko.getSkylinkState(e.id).user.sid;return gs.parseSDPForTransceiverMid(e,r,t),gs.retrieveFormattedMediaInfo(e,r)}static processPeerMedia(e,t,r,n,s=!1){const i=ko.getSkylinkState(e.id).peerMedias[t]||{},o=r.getTracks();let a=null;try{o.forEach((o=>{a=gs.retrieveMediaId(o.kind,r.id),i[a]=gs.buildPeerMediaInfo(e,t,o,r.id,o.kind===Ct.AUDIO?At.AUDIO_MIC:n?At.VIDEO_SCREEN:At.VIDEO_CAMERA),gs.updatePeerMediaInfo(e,t,s,a,null,null,i[a]);}));}catch(e){zt.log.ERROR([t,_t.MEDIA_INFO,Ft.MEDIA_INFO.ERRORS.FAILED_PROCESSING_PEER_MEDIA],e);}}static retrieveScreenMediaInfo(e,t,r){const n=ko.getSkylinkState(e.id),{peerMedias:s}=n,i=Object.values(s[t]);for(let e=0;e<i.length;e+=1){if(r.streamId&&i[e].streamId===r.streamId)return i[e].mediaType===At.VIDEO_SCREEN&&i[e];if(r.transceiverMid&&i[e].transceiverMid===r.transceiverMid)return i[e].mediaType===At.VIDEO_SCREEN;if(!r)return i[e].mediaType===At.VIDEO_SCREEN}return zt.log.ERROR([t,_t.PEER_MEDIA,null,Ft.MEDIA_INFO.ERRORS.STREAM_ID_NOT_MATCHED]),!1}}class Ts extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,message:null};}send(e,t){const r=ko.getSkylinkState(e);this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.client_id=r.clientId,this.model.state=t.type,this.model.message=JSON.stringify(t),this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.session,this.model);}}const _s=e=>{const t=Hn.enterAndWelcome(e),{rid:r,mid:n,publisherId:s}=t,i=ko.getSkylinkState(r),{hasMCU:o,user:a}=i,c=o&&s?s:n;return a.sid?(zt.log.INFO([c,_t.PEER_CONNECTION,null,`Peer ${t.type} received ->`],e),cn.send(r,t.type,c,e,!0),"enter"===t.type?Jn.onEnterReceived(e):"welcome"===t.type?Jn.onWelcomeReceived(e):void 0):zt.log.DEBUG([c,_t.PEER_CONNECTION,null,[Ft.SIGNALING.DROPPING_ENTER]])},As=(e,t)=>{ko.getSkylinkState(e).peerConnections[t]&&((e,t)=>{const r=ko.getSkylinkState(e);r.peerConnections[t].signalingState!==Xe.CLOSED&&r.peerConnections[t].close();})(e,t);},Is=(e,t)=>{const r=ko.getSkylinkState(e);if(!((e,t)=>{const r=e;return !(!r||(r.peerConnections[t]?!r.peerInformations[t]&&(zt.log.DEBUG([t,_t.PEER_CONNECTION,null,`${Ft.ROOM.LEAVE_ROOM.DROPPING_HANGUP} - ${Ft.PEER_INFORMATIONS.NO_PEER_INFO} ${t}`]),1):(zt.log.DEBUG([t,_t.PEER_CONNECTION,null,`${Ft.ROOM.LEAVE_ROOM.DROPPING_HANGUP} - ${Ft.PEER_CONNECTION.NO_PEER_CONNECTION}`]),1)))})(r,t))return;const{room:n}=r,s=fi.getPeerInfo(t,n);if(t===Pt.MCU||t===Pt.REC_SRV){const e=r;return Vt(ke({peerId:t,serverPeerType:t,room:Ri.getRoomInfo(n)})),e.hasMCU=!1,ko.setSkylinkState(e,n.id)}Vt(Pe({peerId:t,peerInfo:s,isSelf:!1,room:Ri.getRoomInfo(n)}));};class Cs extends sr{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,recording_id:null,recordings:null,error:null};}send(e,t,r,n,s){const i=ko.getSkylinkState(e);this.model.client_id=i.clientId,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.state=t,this.model.recording_id=r,this.model.recordings=n,this.error=("string"==typeof s?s:s&&s.message)||null,this.postStats(this.endpoints.recording,this.model);}}const Os=new Cs,Ns=(e,t,r)=>{const n={state:e,recordingId:t};r&&(n.error=r),Vt(((e={})=>new Se("recordingState",{detail:e}))(n));},Ds="startSuccess",vs="stopSuccess",ys=(e,t,r,n,s)=>{const i=fi.getPeerInfo(r,e.room);Vt(he({isSelf:!1,peerId:r,peerInfo:i,streamId:t,isAudio:n===Ct.AUDIO,isVideo:n===Ct.VIDEO,isScreensharing:s})),Vt(ve({isSelf:!1,peerId:r,peerInfo:i}));},Ps=(e,t,r)=>{zt.log.WARN([e,_t.SIG_SERVER,`${Ft.MEDIA_INFO.WARN.READ_ONLY_VALUE} ${r}`],t);},Ms=(e,t)=>{const{rid:r,mediaId:n,transceiverMid:s}=t,i=ko.getSkylinkState(r);fs.updatePeerMediaInfo(i.room,e,n,Nt.TRANSCEIVER_MID,s);},ks=(e,t,r,n)=>{if(n.mediaState===Ot.UNAVAILABLE)((e,t,r,n)=>{const{mediaId:s}=n;fs.setMediaStateToUnavailable(e,r,s),fs.deleteUnavailableMedia(e,r,s);})(e,0,r,n);else switch(t){case At.VIDEO_SCREEN:case At.VIDEO_CAMERA:case At.VIDEO_OTHER:case At.VIDEO:setTimeout((()=>{((e,t)=>{const{type:r,rid:n,mediaId:s,mediaState:i,mediaType:o}=t,a=ko.getSkylinkState(n),{room:c}=a,d=fs.retrieveStreamId(c,e,s),l=(new Date).toISOString();if(zt.log.INFO([e,_t.SIG_SERVER,r,Ft.MEDIA_INFO.VIDEO_STATE_CHANGE,i,d],t),a.peerInformations[e]){if(a.peerMessagesStamps[e]){if(l<a.peerMessagesStamps[e].videoMuted)return void zt.log.WARN([e,_t.SIG_SERVER,r,Ft.SIGNALING.OUTDATED_MSG],t);a.peerMessagesStamps[e].videoMuted=l;}a.peerInformations[e].mediaStatus[d]||(a.peerInformations[e].mediaStatus[d]={}),a.peerInformations[e].mediaStatus[d].videoMuted=i===Ot.MUTED||i===Ot.STOPPED?Tt.MUTED:Tt.ACTIVE,ko.setSkylinkState(a,c.id),ys(a,d,e,Ct.VIDEO,o===At.VIDEO_SCREEN);}else zt.log.WARN([e,_t.PEER_INFORMATION,r,`${Ft.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`]);})(r,n);}),100);break;case At.AUDIO_MIC:case At.AUDIO:setTimeout((()=>{((e,t)=>{const{type:r,rid:n,mediaId:s,mediaState:i}=t,o=ko.getSkylinkState(n),{room:a}=o,c=fs.retrieveStreamId(a,e,s),d=(new Date).toISOString();if(zt.log.INFO([e,_t.SIG_SERVER,r,Ft.MEDIA_INFO.AUDIO_STATE_CHANGE,i,c],t),o.peerInformations[e]){if(o.peerMessagesStamps[e]){if(d<o.peerMessagesStamps[e].audioMuted)return void zt.log.WARN([e,_t.SIG_SERVER,r,Ft.SIGNALING.OUTDATED_MSG],t);o.peerMessagesStamps[e].audioMuted=d;}o.peerInformations[e].mediaStatus[c]||(o.peerInformations[e].mediaStatus[c]={}),o.peerInformations[e].mediaStatus[c].audioMuted=i===Ot.MUTED||i===Ot.STOPPED?Tt.MUTED:Tt.ACTIVE,ko.setSkylinkState(o,a.id),ys(o,c,e,Ct.AUDIO,!1);}else zt.log.WARN([e,_t.PEER_INFORMATION,r,`${Ft.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`]);})(r,n);}),100);break;default:zt.log.ERROR([r,_t.SIG_SERVER,`${Ft.MEDIA_INFO.WARN.INVALID_MEDIA_TYPE} ${t}`],n);}},ws=(e,t,r,n,s)=>{const i=ko.getSkylinkState(e),{peerMedias:o}=i,a=o[t][r];return a[n]&&a[n]!==s},bs=(e,t)=>{Gr.processMessage(e,t);},Ls=e=>{zt.log.INFO([e.mid,null,e.type,"Received ANSWER from peer:"],e),Jn.onAnswerReceived(e);},Gs=e=>{const{mid:t,rid:r,type:n}=e,s=ko.getSkylinkState(r),i=t;zt.log.INFO([e.mid,null,e.type,"Received ANSWER_ACK from peer:"],e),Vt(fe({state:n,peerId:i,room:Ri.getRoomInfo(s.room)})),Jn.onAnswerAckReceived(e);},Us=e=>{const{pc_config:{iceServers:t},sid:r,rid:n,tieBreaker:s}=e,i=ko.getSkylinkState(n),o=new ii;i.room.connection.peerConfig=Jr.setIceServers(n,t),i.room.inRoom=!0,i.user.sid=r,zt.log.INFO([null,_t.SIG_SERVER,null,`${Ft.PEER_INFORMATIONS.SET_PEER_PRIORITY_WEIGHT}: `],s),i.peerPriorityWeight=s,fs.updatePeerMediaWithUserSid(i.room,r),tn.updatePeerStreamWithUserSid(i.room,r),ko.setSkylinkState(i,n),Vt(ye({peerId:i.user.sid,peerInfo:fi.getCurrentSessionInfo(i.room),isSelf:!0,room:Ri.getRoomInfo(i.room),peerSessionId:i.user.peerSessionId})),(new Ts).send(n,e),((e,t)=>{const r=ko.getSkylinkState(e.id);r.peerStreams[t]&&Object.values(r.peerStreams[t]).forEach((r=>{tn.dispatchStreamEvent("onIncomingStream",{stream:r,peerId:t,room:Ri.getRoomInfo(e),isSelf:!0,peerInfo:fi.getCurrentSessionInfo(e),streamId:r.id,isVideo:r.getVideoTracks().length>0,isAudio:r.getAudioTracks().length>0});}));})(i.room,r),((e,t)=>{const r=ko.getInitOptions();(new en).send(e);const n=setInterval((()=>{const r=ko.getSkylinkState(e),s=r?r.user.sid:null;r&&s===t?(new en).send(r.room.id):clearInterval(n);}),1e3*r.statsInterval);})(i.room.id,r),o.enterRoom(i);},Fs=e=>{_s(e);},Bs=e=>{zt.log.INFO([e.mid,null,e.type,"Received OFFER from peer:"],e),Jn.onOfferReceived(e);},xs=e=>{_s(e);},Hs=e=>{const{candidate:t,mid:r,rid:n}=e,s=ko.getSkylinkState(n),{room:i}=s,o=s.peerConnections[r],a=s.peerEndOfCandidatesCounter[r]||{},{RTCIceCandidate:c}=window,{ICE_CANDIDATE:d,PEER_CONNECTION:l,STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:E}}=Ft,S=ko.getInitOptions(),p=new xr;if(!t&&!e.id)return zt.log.WARN([r,_t.CANDIDATE_HANDLER,null,d.INVALID_CANDIDATE],e),null;const u=new c({sdpMLineIndex:e.label,candidate:t,sdpMid:e.id}),R=`can-${u.foundation}`,h=u.candidate.split(" ")[7]||"";zt.log.DEBUG([r,_t.CANDIDATE_HANDLER,`${R}:${h}`,d.VALID_CANDIDATE],u),a.len=a.len||0,a.hasSet=!1,a.len+=1,ko.setSkylinkState(s,n);const m={candidate:{candidate:u.candidate,sdpMid:u.sdpMid,sdpMLineIndex:u.sdpMLineIndex},error:null};if(Vt(_e({room:Ri.getRoomInfo(i),state:Je.RECEIVED,peerId:r,candidateId:R,candidateType:h,candidate:m.candidate,error:m.error})),!o||o.signalingState===Xe.CLOSED)return zt.log.WARN([r,_t.CANDIDATE_HANDLER,`${R}:${h}`,l.NO_PEER_CONNECTION]),m.error=new Error(l.NO_PEER_CONNECTION),p.send(i.id,E.PROCESS_FAILED,r,R,m.candidate,m.error),Vt(_e({room:Ri.getRoomInfo(i),state:Je.DROPPED,peerId:r,candidateId:R,candidateType:h,candidate:m.candidate,error:m.error})),lo.signalingEndOfCandidates(r,s),null;if(S.filterCandidatesType[h]){if(!s.hasMCU||!S.forceTURN)return zt.log.WARN([r,_t.CANDIDATE_HANDLER,`${R}:${h}`,d.FILTERED_CANDIDATE],u),m.error=new Error(d.FILTERED_CANDIDATE),p.send(i.id,E.DROPPED,r,R,m.candidate,m.error),Vt(_e({room:Ri.getRoomInfo(i),state:Je.DROPPED,peerId:r,candidateId:R,candidateType:h,candidate:m.candidate,error:m.error})),lo.signalingEndOfCandidates(r,s),null;zt.log.WARN([r,_t.CANDIDATE_HANDLER,`${R}:${h}`,d.FILTERING_FLAG_NOT_HONOURED],u);}o.remoteDescription&&o.remoteDescription.sdp&&o.setRemoteDescriptionSuccess?Jr.addIceCandidate(r,R,h,u,s):Jr.addIceCandidateToQueue(r,R,h,u,s),lo.signalingEndOfCandidates(r,s);let g=s.gatheredCandidates[r];return g||(g={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),g.receiving[h].push({sdpMid:u.sdpMid,sdpMLineIndex:u.sdpMLineIndex,candidate:u.candidate}),s.gatheredCandidates[r]=g,ko.setSkylinkState(s,n),null},Vs=e=>{const{result:t,type:r}=e,n=t;zt.log.INFO(["Server",null,r,"Received list of peers"],n),Vt(we({state:nt.DISPATCHED,privilegePeerId:null,peerList:n}));},js=e=>{const t=ko.getSkylinkState(),{room:r,user:n}=t;zt.log.WARN(["Server",null,e.type,`Introduce failed. Reason: ${e.reason}`]);(new Ts).send(r.id,e),Vt(((e={})=>new Se("introduceStateChange",{detail:e}))({state:"introduceStateChange".ERROR,privilegedPeerId:n.sid,receivingPeerId:e.receivingPeerId,sendingPeerId:e.sendingPeerId,reason:e.reason}));},$s=e=>{const{mid:t,rid:r,status:n,streamId:s,settings:i}=e,o=ji(r),{room:a,peerInformations:c}=o;return n===ht.ENDED&&(i.isScreensharing&&(c[t].screenshare=!1,ko.setSkylinkState(o,a.id)),Vt(Re({room:Ri.getRoomInfo(a),peerId:t,peerInfo:fi.getPeerInfo(t,a),streamId:s,isSelf:!1,isScreensharing:i.isScreensharing,options:i,isVideo:!!i.audio,isAudio:!!i.video}))),null},Ws=e=>{const{mid:t,rid:r,publisherId:n}=e,s=r,i=ko.getSkylinkState(s);let o=t;if(i.hasMCU&&(o=n),!i.peerConnections[o]||!i.peerInformations[o])return zt.log.DEBUG([o,_t.PEER_CONNECTION,null,Ft.ROOM.LEAVE_ROOM.DROPPING_DUPLICATE_BYE],e);zt.log.INFO([o,_t.PEER_CONNECTION,null,Ft.ROOM.LEAVE_ROOM.PEER_LEFT.START]);try{Is(s,o),As(s,o),((e,t)=>{const r=ko.getSkylinkState(e);setTimeout((()=>{const r=ko.getSkylinkState(e);r&&!wi(r)&&(delete r.peerConnections[t],ko.setSkylinkState(r,r.room.id)),r&&!r.hasMCU&&(new en).send(e),zt.log.INFO([t,r.room.roomName,null,Ft.ROOM.LEAVE_ROOM.PEER_LEFT.SUCCESS]);}),500),delete r.peerInformations[t],delete r.peerMedias[t],delete r.peerMessagesStamps[t],delete r.peerEndOfCandidatesCounter[t],delete r.peerCandidatesQueue[t],delete r.peerStats[t],delete r.gatheredCandidates[t],delete r.peerStreams[t],delete r.currentRTCRTPSenders[t],delete r.bufferedLocalOffer[t],delete r.negotiationState[t];})(s,o),((e,t)=>{lo.closeDataChannel(e,t);})(s,o);}catch(e){zt.log.DEBUG([o,_t.ROOM,null,Ft.ROOM.LEAVE_ROOM.PEER_LEFT.ERROR],e);}},Ks=e=>{const{action:t,rid:r,recordingId:n,error:s}=e,i=ji(r);"on"===t?((e,t)=>{const r=Object.assign({},e),{room:n}=r;zt.log.DEBUG([Pt.MCU,_t.RECORDING,t,Ft.RECORDING.START_SUCCESS]),Os.send(n.id,Ft.STATS_MODULE.HANDLE_RECORDING_STATS.START,t,null,null),r.currentRecordingId=t,r.recordings[t]={active:!0,state:pt.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,error:null},r.recordingStartInterval=setTimeout((()=>{zt.log.INFO([Pt.MCU,_t.RECORDING,t,Ft.RECORDING.MIN_RECORDING_TIME_REACHED]),r.recordingStartInterval=null;}),4e3),ko.setSkylinkState(r,n.id),Ns(pt.START,t);})(i,n):"off"===t?((e,t)=>{const r=Object.assign({},e),{room:n,recordings:s}=r;Os.send(n.id,Ft.STATS_MODULE.HANDLE_RECORDING_STATS.STOP,t,null,null),s[t]?(r.currentRecordingId=null,r.recordingStartInterval&&(clearTimeout(r.recordingStartInterval),zt.log.WARN([Pt.MCU,_t.RECORDING,t,Ft.RECORDING.ERRORS.STOP_ABRUPT]),r.recordingStartInterval=null),zt.log.DEBUG([Pt.MCU,_t.RECORDING,t,Ft.RECORDING.STOP_SUCCESS]),r.recordings[t].active=!1,r.recordings[t].state=pt.STOP,r.recordings[t].endedDateTime=(new Date).toISOString(),ko.setSkylinkState(r,n.id),Ns(pt.STOP,t)):zt.log.ERROR([Pt.MCU,_t.RECORDING,t,Ft.RECORDING.ERRORS.SESSION_EMPTY]);})(i,n):"error"===t&&(Ns(pt.ERROR,n,s),zt.log.ERROR([Pt.MCU,_t.RECORDING,n,Ft.RECORDING.ERRORS.MCU_RECORDING_ERROR],s),Os.send(i.room.id,Ft.STATS_MODULE.HANDLE_RECORDING_STATS.MCU_RECORDING_ERROR,n,null,s));},zs=e=>{const{action:t,info:r,reason:n,rid:s,type:i}=e;zt.log.INFO(["Server",null,i,"System action warning:"],e),Object.keys((new fo).getAllStates()).length>1&&t===st.REJECT&&Ki(),ko.removeSkylinkState(ko.getSkylinkState(s)),(new Ts).send(s,e),Vt(new Se("systemAction",{detail:{action:t,info:r,reason:n,rid:s}}));},Ys=e=>{const{action:t,rid:r}=e,n=ji(r);zt.log.DEBUG([Pt.MCU,"RTMP",null,Ft.RTMP.message_received_from_sig]),t===Ds?((e,t)=>{const{rtmpSessions:r}=e,{rtmpId:n,peerId:s,streamId:i}=t;if(!r[n]){const t=Object.assign({},e);zt.log.DEBUG([Pt.MCU,"RTMP",Ft.RTMP.started_success]),t.rtmpSessions[n]={active:!0,state:ft.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,peerId:s,streamId:i},Vt(Ue({state:ft.START,rtmpId:n,error:null})),ko.setSkylinkState(t,t.room.id);}})(n,e):t===vs?((e,t)=>{const{rtmpSessions:r}=e,{rtmpId:n}=t,s=Object.assign({},e);r[n]?(zt.log.DEBUG([Pt.MCU,"RTMP",Ft.RTMP.stopped_success]),s.rtmpSessions[n].active=!1,s.rtmpSessions[n].state=ft.STOP,s.rtmpSessions[n].endedDateTime=(new Date).toISOString(),Vt(Ue({state:ft.STOP,rtmpId:n,error:null})),ko.setSkylinkState(s,s.room.id)):zt.log.DEBUG([Pt.MCU,"RTMP",Ft.RTMP.stop_session_empty]);})(n,e):((e,t)=>{const{error:r,rtmpId:n}=t,{rtmpSessions:s}=e,i=new Error(r||"Unkown Error"),o=Object.assign({},e);s[n]?(zt.log.DEBUG([Pt.MCU,"RTMP",Ft.RTMP.error_session]),o.rtmpSessions[n].state=ft.ERROR,o.rtmpSessions[n].error=i,s[n].active&&(zt.log.DEBUG([Pt.MCU,"RTMP",Ft.RTMP.error_Session_abrupt]),o.rtmpSessions[n].active=!1),Vt(Ue({state:ft.ERROR,rtmpId:n,error:i})),ko.setSkylinkState(o,o.room.id)):zt.log.DEBUG([Pt.MCU,"RTMP",Ft.RTMP.error_session_empty]);})(n,e);},Js=e=>{const{type:t,mid:r,rid:n,userData:s,stamp:i}=e,o=ko.getSkylinkState(n),{peerInformations:a,peerMessagesStamps:c}=o,d=r,{PEER_INFORMATIONS:l}=Ft;let E=s.replace(/&quot;/g,'"');try{E=JSON.parse(E);}catch(e){zt.log.INFO([d,null,t,`${l.USER_DATA_NOT_JSON}`],E);}finally{zt.log.INFO([d,null,t,`${l.UPDATE_USER_DATA}`],E);}if(a[d]){if(c[d]&&Fi(i)){if(i<c[d].userData)return void zt.log.WARN([d,null,t,`${l.OUTDATED_MSG}`],e);c[d].userData=i;}a[d].userData=E||{},Vt(ve({peerId:d,peerInfo:fi.getPeerInfo(d,o.room),isSelf:!1}));}else zt.log.INFO([d,null,t,`${l.NO_PEER_INFO} ${d}`]);},Qs=e=>{const{mid:t,rid:r,mediaType:n,mediaId:s,publisherId:i}=e,o=ko.getSkylinkState(r),{hasMCU:a,room:c}=o,d=a?i:t;try{if(!((e,t)=>{const r=e,{mediaId:n,publisherId:s}=t;return r.peerMedias[s]=r.peerMedias[s]||{},!r.peerMedias[s][n]&&(r.peerMedias[s][n]=t,ko.setSkylinkState(r,r.room.id),!0)})(o,e)){const t=Object.values(Nt);for(let i=0;i<t.length;i+=1)if(ws(r,d,s,t[i],e[t[i]])){if(fs.updatePeerMediaInfo(o.room,d,s,t[i],e[t[i]]),t[i]===Nt.MEDIA_STATE)return void ks(c,n,d,e);if(t[i]===Nt.TRANSCEIVER_MID)return void Ms(d,e);Ps(d,e,t[i]);}}}catch(e){zt.log.ERROR([d,_t.SIG_SERVER,Ft.MEDIA_INFO.FAILED_PROCESSING_MEDIA_INFO_EVENT],e);}},qs=e=>{Lr.processStoredMessages(e);},Xs=e=>{const{rid:t,lock:r,mid:n}=e,s=ko.getSkylinkState(t);s.room.isLocked=r,ko.setSkylinkState(s,s.room.id),Vt(Ce({isLocked:r,peerInfo:fi.getPeerInfo(n,s.room),peerId:n,isSelf:!1,room:Ri.getRoomInfo(s.room)}));};class Zs{userMessageHandler(...e){bs(...e);}answerHandler(...e){Ls(...e);}answerAckHandler(...e){Gs(...e);}inRoomHandler(...e){Us(...e);}enterRoomHandler(...e){Fs(...e);}offerHandler(...e){Bs(...e);}welcomeHandler(...e){xs(...e);}candidateHandler(...e){Hs(...e);}getPeerListHandler(...e){Vs(...e);}introduceErrorHandler(...e){js(...e);}byeHandler(...e){Ws(...e);}streamHandler(...e){$s(...e);}recordingHandler(...e){Ks(...e);}redirectHandler(...e){zs(...e);}rtmpHandler(...e){Ys(...e);}setUserDataHandler(...e){Js(...e);}mediaInfoEventHandler(...e){Qs(...e);}storedMessagesHandler(...e){qs(...e);}roomLockHandler(...e){Xs(...e);}}const ei={joinRoom:e=>{const{room:t,user:r}=e,n=ko.getSkylinkState(t.id),s=ko.getInitOptions(),i=new rr(null,t.id);return {type:Rt.JOIN_ROOM,uid:n.user.uid,cid:i.key,rid:t.id,userCred:r.token,timeStamp:r.timeStamp,apiOwner:i.appKeyOwner,roomCred:t.token,start:t.startDateTime,len:t.duration,isPrivileged:i.isPrivileged,autoIntroduce:i.autoIntroduce,key:s.appKey}},enterRoom:e=>{const{room:t}=e,r=ko.getSkylinkState(t.id),n=ko.getInitOptions(),{user:s,peerPriorityWeight:i,enableIceRestart:o,hasMCU:a}=r,{enableDataChannel:c}=n,{AdapterJS:d,navigator:l}=window,E=fi.getUserInfo(t),S={type:Rt.ENTER,mid:s.sid,rid:t.id,agent:d.webrtcDetectedBrowser,version:(d.webrtcDetectedVersion||0).toString(),os:l.platform,userInfo:E,weight:i,temasysPluginVersion:null,enableDataChannel:c,enableIceRestart:o,SMProtocolVersion:"2.1.0",DTProtocolVersion:"0.1.3"};return a&&(S.target=Pt.MCU,S.publisherId=s.sid),S},welcome:(e,t)=>{const r=ko.getSkylinkState(e.id),n=ko.getInitOptions(),{user:s,peerPriorityWeight:i,enableIceRestart:o,room:a}=r,{enableDataChannel:c}=n,{AdapterJS:d}=window,l=fi.getUserInfo(a);return {type:Rt.WELCOME,mid:s.sid,rid:a.id,agent:d.webrtcDetectedBrowser,version:(d.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,weight:i,temasysPluginVersion:null,enableDataChannel:c,enableIceRestart:o,SMProtocolVersion:"2.1.0",DTProtocolVersion:"0.1.3",target:t}},offer:(...e)=>lo.createOffer(...e),answer:(...e)=>lo.createAnswer(...e),answerAck:(e,t,r)=>{const{room:n,user:s}=e;return {type:Rt.ANSWER_ACK,rid:n.id,mid:s.sid,target:t,success:r}},candidate:(e,t,r)=>{const n=t.room.id,s=ko.getSkylinkState(n);return {type:Rt.CANDIDATE,label:r.sdpMLineIndex,id:r.sdpMid,candidate:r.candidate,mid:s.user.sid,target:e,rid:n}},setUserData:e=>({type:Rt.UPDATE_USER,mid:e.user.sid,rid:e.room.id,userData:Hi(e.user.userData)?e.user.userData:JSON.stringify(e.user.userData),stamp:(new Date).getTime()}),getPeerList:(e,t)=>({type:Rt.GET_PEERS,showAll:t,rid:e.room.id}),restartOffer:(e,t,r)=>{const n=ko.getSkylinkState(e),{AdapterJS:s}=window,i=ko.getInitOptions(),{user:o,room:a,enableIceRestart:c,peerInformations:d,peerPriorityWeight:l}=n;return {type:Rt.RESTART,mid:o.sid,rid:a.id,agent:s.webrtcDetectedBrowser,version:(s.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:fi.getUserInfo(a),target:t,weight:l,enableDataChannel:i.enableDataChannel,enableIceRestart:c,doIceRestart:!0===r&&c&&d[t]&&d[t].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:null,SMProtocolVersion:"2.1.0",DTProtocolVersion:"0.1.3"}},stream:(e,t,r,n,s)=>({type:Rt.STREAM,mid:t.sid,rid:e,status:n,streamId:r.id,settings:s}),recording:(e,t)=>({type:t,rid:e,target:ko.getSkylinkState(e).hasMCU?Pt.MCU:Pt.REC_SRV}),rtmp:(e,t,r,n,s=null,i=null)=>{const o={type:e,rid:t,rtmpId:n,streamId:s,endpoint:i,mid:r,target:Pt.MCU};return e===Rt.STOP_RTMP&&(delete o.endpoint,delete o.streamId),o},bye:(e,t)=>{const{room:r,user:n,hasMCU:s}=e,i={type:Rt.BYE,rid:r.id,mid:n.sid,target:t};return s&&(i.publisherId=n.sid),i},roomLock:e=>{const{user:t,room:r}=e;return {type:Rt.ROOM_LOCK,mid:t.sid,rid:r.id,lock:r.isLocked}},mediaInfoEvent:(e,t,r)=>({type:Rt.MEDIA_INFO_EVENT,rid:e.room.id,mid:r.publisherId,target:t,publisherId:r.publisherId,mediaId:r.mediaId,mediaType:r.mediaType,mediaState:r.mediaState}),getStoredMessages:(e,t)=>{const{user:r,room:n}=e;return {mid:r.sid,rid:n.id,target:r.sid,roomSessionId:t,type:Rt.GET_STORED_MESSAGES}},userMessages:(e,t,r)=>{const n=[],{user:s,room:i}=e,{listOfPeers:o,isPrivate:a,isPersistent:c,secretId:d,peerSessionId:l}=t,E={data:r,mid:s.sid,rid:i.id,msgId:zi(),roomSessionId:i.roomSessionId,peerSessionId:l,type:Rt.MESSAGE};if(d&&(E.secretId=d),a)for(let e=0;e<o.length;e+=1){const t=o[e],s=Object.assign({},E);s.target=t,n.push(s),zt.log.DEBUG([t,_t.MESSAGING,null,Ft.MESSAGING.PRIVATE_MESSAGE],{message:r});}else c&&(E.isPersistent=c),n.push(E),zt.log.DEBUG([null,_t.MESSAGING,null,Ft.MESSAGING.BROADCAST_MESSAGE],{message:r});return n}};class ti{constructor(){this.messageBuilders=ei;}getJoinRoomMessage(...e){return this.messageBuilders.joinRoom(...e)}getWelcomeMessage(...e){return this.messageBuilders.welcome(...e)}getEnterRoomMessage(...e){return this.messageBuilders.enterRoom(...e)}getAnswerMessage(...e){return this.messageBuilders.answer(...e)}getAnswerAckMessage(...e){return this.messageBuilders.answerAck(...e)}getOfferMessage(...e){return this.messageBuilders.offer(...e)}getCandidateMessage(...e){return this.messageBuilders.candidate(...e)}getSetUserDataMessage(e){return this.messageBuilders.setUserData(e)}getPeerListMessage(...e){return this.messageBuilders.getPeerList(...e)}getRestartOfferMessage(...e){return this.messageBuilders.restartOffer(...e)}getStreamMessage(...e){return this.messageBuilders.stream(...e)}getRecordingMessage(...e){return this.messageBuilders.recording(...e)}getPeerMessagesForSignaling(...e){return this.messageBuilders.signalingMessages(...e)}getRTMPMessage(...e){return this.messageBuilders.rtmp(...e)}getByeMessage(...e){return this.messageBuilders.bye(...e)}getRoomLockMessage(...e){return this.messageBuilders.roomLock(...e)}getMediaInfoEventMessage(...e){return this.messageBuilders.mediaInfoEvent(...e)}getGetStoredMessagesMessage(...e){return this.messageBuilders.getStoredMessages(...e)}getUserMessages(...e){return this.messageBuilders.userMessages(...e)}}const ri="Polling",ni="WebSocket";let si=null;class ii{constructor(){return si||(si=this),this.socket=null,this.attempts=0,this.timestamp=(new Date).valueOf(),this.messageHandler=new Zs,this.messageBuilder=new ti,this.config=null,si}resetSocketConfig(e){return {protocol:e,socketType:window.WebSocket?ni:ri,signalingServerProtocol:e,socketSession:{finalAttempts:0,attempts:0},fallbackType:null,signalingServerPort:null,socketTimeout:!1}}createSocket(e){const t=ko.getSkylinkState(e);return t.socketSession=this.resetSocketConfig(t.signalingServerProtocol),ko.setSkylinkState(t,e),new Promise(((t,r)=>{try{null!==this.socket&&this.socket instanceof window.io.Socket&&this.socket.connected?t():this.tryCreateSocket(e,t,r);}catch(n){this.handleCreateSocketFailure(e,t,r,n);}}))}tryCreateSocket(e,t,r){try{const r=ko.getSkylinkState(e),{socketSession:n}=r;this.socket=pr({config:n,roomKey:e}),Ir(e,this,t);}catch(e){r(e);}}handleCreateSocketFailure(e,t,r,n){const s=ko.getSkylinkState(e),{socketSession:i}=s;var o;zt.log.ERROR(Ft.INIT.SOCKET_CREATE_FAILED,n),Vt((o={session:Yt(i),errorCode:at.CONNECTION_FAILED,type:i.fallbackType,error:n},new Se("socketError",{detail:o}))),r(n);}dispatchHandshakeProgress(e,t){Vt(fe({peerId:e.user.sid,state:rt[t],error:null,room:Ri.getRoomInfo(e.room)}));}logClientSessionStats(e,t){(new Ts).send(e,t);}answer(e,t){this.sendMessage(t),this.dispatchHandshakeProgress(e,"ANSWER");}answerAck(...e){const t=this.messageBuilder.getAnswerAckMessage(...e),r=e[0];this.sendMessage(t),this.dispatchHandshakeProgress(r,"ANSWER_ACK");}enterRoom(...e){const t=this.messageBuilder.getEnterRoomMessage(...e);this.sendMessage(t),this.dispatchHandshakeProgress(...e,"ENTER"),this.logClientSessionStats(e[0].room.id,t);}joinRoom(...e){const t=this.messageBuilder.getJoinRoomMessage(...e);this.sendMessage(t),this.logClientSessionStats(e[0].room.id,t);}offer(e,t){this.sendMessage(t),this.dispatchHandshakeProgress(e,"OFFER");}welcome(...e){const t=this.messageBuilder.getWelcomeMessage(...e);this.sendMessage(t);}noop(){return null}sendCandidate(...e){const t=this.messageBuilder.getCandidateMessage(...e);t&&this.sendMessage(t);}setUserData(e){const t=this.messageBuilder.getSetUserDataMessage(e);t&&this.sendMessage(t);}getPeerList(e,t){const r=this.messageBuilder.getPeerListMessage(e,t);r&&this.sendMessage(r);}stream(...e){const t=this.messageBuilder.getStreamMessage(...e);t&&this.sendMessage(t);}recording(...e){const t=this.messageBuilder.getRecordingMessage(...e);this.sendMessage(t);}rtmp(...e){const t=this.messageBuilder.getRTMPMessage(...e);this.sendMessage(t);}roomLock(e){const t=this.messageBuilder.getRoomLockMessage(e);t&&this.sendMessage(t);}bye(...e){const t=this.messageBuilder.getByeMessage(...e);this.sendMessage(t);}mediaInfoEvent(e,t,r){const n=this.messageBuilder.getMediaInfoEventMessage(e,t,r);n&&this.sendMessage(n);}getStoredMessages(e,t){const r=this.messageBuilder.getGetStoredMessagesMessage(e,t);r&&this.sendMessage(r);}onMessage(e){const t=ko.getSkylinkState(JSON.parse(e).rid);if(!t)return;const{socketSession:r}=t;var n;Vt((n={message:e,socketSession:Yt(r)},new Se("channelMessage",{detail:n}))),_r(this.messageHandler,JSON.parse(e));}sendMessage(e){(e=>Tr(e))(e)||(zt.log.INFO(["SIG SERVER",null,e.type,"sent"]),((e,t)=>{e.send(JSON.stringify(t));})(this.socket,e));}sendUserMessage(e,t,r){const n=this.messageBuilder.getUserMessages(e,t,r);Array.isArray(n)&&n.length&&n.map((e=>(this.sendMessage(e),null)));}updateAttempts(e,t,r){this.attempts=r;const n=ko.getSkylinkState(e),{socketSession:s}=n;s.socketSession[t]=r,ko.setSkylinkState(n,e);}getAttempts(){return this.attempts}}const oi=e=>new Promise((t=>{const r=ko.getSkylinkState(e.room.id),{room:n,peerConnections:s}=r,{ROOM:{LEAVE_ROOM:i}}=Ft,o=new ii,a=Object.keys(ko.getSkylinkState()).length>1;if(n.inRoom=!1,ko.setSkylinkState(r,n.id),a)zt.log.INFO([n.roomName,null,null,i.SENDING_BYE]),Object.keys(s).forEach((e=>{o.bye(r,e);})),t(r);else {o.config=o.resetSocketConfig(window.location.protocol);const e=()=>{zt.log.INFO([n.roomName,null,null,i.DISCONNECT_SOCKET.SUCCESS]),Ht(Gt.CHANNEL_CLOSE,e),t(r);};xt(Gt.CHANNEL_CLOSE,e),o.socket.connected?o.socket.disconnect():t(r);}})),ai=e=>{const{room:t,peerStreams:r,user:n}=e;r[n.sid]&&sn.prepStopStreams(t.id,null,!0),new mo(e).stop(!0);},ci=e=>{ko.clearRoomStateFromSingletons(e),ko.removeSkylinkState(e);},di=(e,t=!0)=>new Promise(((r,n)=>{const{peerConnections:s,peerInformations:i,room:o,hasMCU:a,user:c}=e,{ROOM:{LEAVE_ROOM:d}}=Ft;try{const n=a?s.MCU?[Pt.MCU]:[]:Array.from(new Set([...Object.keys(s),...Object.keys(i)]));if(bi(n))zt.log.DEBUG([o.roomName,null,null,d.NO_PEERS]),t&&ai(e),oi(e).then((e=>{zt.log.INFO([o.roomName,null,null,d.REMOVE_STATE.SUCCESS]),Vt(Pe({peerId:c.sid,peerInfo:fi.getCurrentSessionInfo(o),isSelf:!0,room:Ri.getRoomInfo(o)})),ci(e.room.id),r(e.room.roomName);}));else {const s=[];n.forEach((t=>{s.push(((e,t)=>new Promise((r=>{const{room:n,peerConnections:s}=e,{ROOM:{LEAVE_ROOM:i}}=Ft,{enableDataChannel:o}=ko.getInitOptions();if(zt.log.INFO([t,n.roomName,null,i.PEER_LEFT.START]),t===Pt.MCU&&Vt(ke({peerId:t,serverPeerType:Pt.MCU,room:Ri.getRoomInfo(n)})),s[t]&&s[t].signalingState!==Xe.CLOSED&&lo.closePeerConnection(e,t),o){const e=t=>{const{detail:s}=t;s.state!==Be.CLOSED&&s.state!==Be.CLOSING||(zt.log.INFO([s.peerId,n.roomName,null,i.PEER_LEFT.SUCCESS]),Ht(Gt.DATA_CHANNEL_STATE,e),r(s.peerId));};xt(Gt.DATA_CHANNEL_STATE,e),lo.closeDataChannel(n.id,t);}else r(t);})))(e,t));})),Promise.all(s).then((()=>(t&&ai(e),oi(e)))).then((e=>{zt.log.INFO([o.roomName,null,null,d.REMOVE_STATE.SUCCESS]),Vt(Pe({peerId:c.sid,peerInfo:fi.getCurrentSessionInfo(o),isSelf:!0,room:Ri.getRoomInfo(o)})),ci(e.room.id),r(e.room.roomName);}));}}catch(e){zt.log.ERROR([o.roomName,null,null,d.ERROR],e),n(e);}})),li=(e=!0,t=[],r=[])=>new Promise(((n,s)=>{const{ROOM:{LEAVE_ROOM:i}}=Ft;try{const s=ko.getSkylinkState(),o=Object.values(s);o[0]?di(o[0],e).then((s=>{t.push(s),r.push(n),li(e,t,r);})):(zt.log.INFO([t,"Room",null,i.LEAVE_ALL_ROOMS.SUCCESS]),r.forEach((e=>e(t))));}catch(e){zt.log.ERROR([null,"Room",null,i.LEAVE_ALL_ROOMS.ERROR],e),s(e);}}));class Ei extends sr{constructor(){super();const{AdapterJS:e,navigator:t}=window;this.model={client_id:null,app_key:null,timestamp:null,username:null,sdk_name:vt.WEB,sdk_version:null,agent_name:e.webrtcDetectedBrowser,agent_version:e.webrtcDetectedVersion,agent_platform:t.platform,agent_plugin_version:null,device_version:null,enumerated_devices:null,device_muted:null,network_type:t.connection?t.connection.type:"-",language:t.language};}send(e){const t=ko.getSkylinkState(e);this.model.username=t.user&&t.user.uid||null,this.model.sdk_version=t.VERSION,this.model.client_id=t.clientId,this.model.app_key=ko.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.client,this.model);}}class Si{constructor(e){this.apiResponse={},this.peerDataChannels={},this.peerCandidatesQueue={},this.peerEndOfCandidatesCounter={},this.gatheredCandidates={},this.retryCounters={},this.peerConnections={},this.peerStats={},this.peerInformations={},this.user=e.user,this.peerPriorityWeight=0,this.isPrivileged=e.isPrivileged,this.socketSession={},this.socketMessageQueue=[],this.channelOpen=!1,this.socketServer=e.socketServer,this.signalingServerProtocol=e.forceSSL?"https:":window.location.protocol,this.enableIceRestart=!1,this.hasMCU=e.hasMCU,this.room=e.room,this.peerMessagesStamps={},this.streamsMutedSettings={},this.streamsBandwidthSettings={bAS:{}},this.recordings={},this.currentRecordingId=!1,this.recordingStartInterval=null,this.currentCodecSupport=null,this.voiceActivityDetection=!0,this.rtmpSessions={},this.bufferedLocalOffer={},this.bufferedRestart={},this.bufferedRemoteOffers={},this.currentRTCRTPSenders={},this.clientId=e.clientId,this.streamsMediaStatus={},this.peerMedias={},this.hasPersistentMessage=e.hasPersistentMessage,this.peerStreams={},this.streamsSettings={},this.enableStatsGathering=e.enableStatsGathering,this.dataTransfers={},this.negotiationState={};}}const pi=(e,t)=>{const r=new Sr,n=new rr(e),s=r.enforceUserInitOptions(n),i=new Si(s);return i.user.userData=t.userData,i.apiResponse=Object.freeze((e=>{const t=Yt(e);return delete t.room,delete t.user,t})(n)),ko.setSkylinkState(i,e.roomName),i},ui=(e,t=!0)=>{const r=e,{room:n,user:s}=r,i=new ii;r.room.isLocked=t,ko.setSkylinkState(r,n.id),i.roomLock(r),Vt(Ce({isLocked:r.room.isLocked,peerInfo:fi.getCurrentSessionInfo(n),peerId:s.sid,isSelf:!0,room:Ri.getRoomInfo(n)}));};class Ri{static leaveRoom(e,t){return di(e,t)}static leaveAllRooms(e){return li(e)}static lockRoom(e){return (e=>ui(e,!0))(e)}static unlockRoom(e){return (e=>ui(e,!1))(e)}static joinRoom(...e){return ((e={},t=null)=>new Promise(((r,n)=>{const s=e||{},{navigator:i}=window,o=new Sr,a=new ii,c=ko.getInitOptions(),d=new Ei,l=Sr.getRoomNameFromParams(s)?Sr.getRoomNameFromParams(s):c.defaultRoom;l?(Vt(Te({readyState:it.LOADING,error:null,room:{roomName:l}})),o.createRoom(l).then((e=>{const{response:c}=e;c.roomName=l;const E=pi(c,s);o.checkCodecSupport(E.room.id).then((()=>(d.send(E.room.id),a.createSocket(c.room_key).then((()=>{const e=Sr.getStateByKey(c.room_key),o=Object.assign({},s);if(o.room=e,t||s.id&&s.active||Array.isArray(s)){const i=ki.parseMediaOptions(s,E);ko.setSkylinkState(i,e.id),on.processPrefetchedStreams(c.room_key,t,s).then((()=>{a.joinRoom(e),r(null);})).catch((e=>{n(e);}));}else if(s.audio||s.video)on.getUserMedia(E,o).then((t=>{a.joinRoom(e),r(t);})).catch((e=>{n(e);}));else {const t=ki.parseMediaOptions(s,E);ko.setSkylinkState(t,e.id),Zi(yt.SAFARI)?i.mediaDevices.getUserMedia({audio:!0}).then((()=>a.joinRoom(e))):a.joinRoom(e),r(null);}}))))).catch((e=>{n(e);}));})).catch((e=>{n(e);}))):n(Ft.ROOM_STATE.NO_ROOM_NAME);})))(...e)}static getRoomInfo(e){return (e=>{const t=ko.getSkylinkState(e.id);let r;r=t?t.room:e;const n=Object.assign({},r);return delete n.connection,delete n.token,delete n.startDateTime,n})(e)}}const hi=e=>!wi(e),mi=(e,t)=>{const r=e.hasMCU?Pt.MCU:t;let n={};if(e.peerConnections[r].connectionState!==Xe.CLOSED){const r=fi.getPeerInfo(t,e.room);n=Yt(r.settings);}else zt.log.WARN([t,_t.PEER_CONNECTION,null,Ft.PEER_CONNECTION.NO_PEER_CONNECTION]);return n},gi={getPeerInfo:(e,t)=>{let r=null;if(!e)return null;const n=ko.getSkylinkState(t.id);return n?((e,t)=>{const{user:r}=t;return e===r.sid})(e,n)?fi.getCurrentSessionInfo(t):(r=Yt(n.peerInformations[e]),r?(r.room=Ri.getRoomInfo(t),r.settings.data=!!(n.peerDataChannels[e]&&n.peerDataChannels[e].main&&n.peerDataChannels[e].main.channel&&n.peerDataChannels[e].main.channel.readyState===Be.OPEN),r):(zt.log.ERROR(`${Ft.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`),r)):(zt.log.ERROR(`${Ft.ROOM_STATE.NOT_FOUND} ${t.id}`),r)},getCurrentSessionInfo:e=>{const t=ko.getSkylinkState(e.id),r=ko.getInitOptions(),{AdapterJS:n,navigator:s}=window,{enableDataChannel:i}=r,{streamsMediaStatus:o,peerPriorityWeight:a,enableIceRestart:c,peerStreams:d,streamsBandwidthSettings:l,streamsSettings:E,user:S}=t,p={userData:"",settings:{audio:!1,video:!1},mediaStatus:{},agent:{name:n.webrtcDetectedBrowser,version:n.webrtcDetectedVersion,os:s.platform,pluginVersion:null,SMProtocolVersion:"2.1.0",DTProtocolVersion:"0.1.3",SDKVersion:Dt},room:Ri.getRoomInfo(e),config:{enableDataChannel:i,enableIceRestart:c,priorityWeight:a}};if(d[S.sid]){Object.keys(d[S.sid]).forEach((e=>{E[e].settings.audio?(p.settings.audio=p.settings.audio||{},p.settings.audio[e]=Yt(E[e].settings.audio)):E[e].settings.video&&(p.settings.video=p.settings.video||{},p.settings.video[e]=Yt(E[e].settings.video));}));}return p.mediaStatus=o,p.userData=S.userData||null,p.settings.maxBandwidth=Yt(l.bAS),p.settings.data=i,Yt(p)},getUserInfo:Pr,getUserData:(e,t)=>{if(t&&e.peerInformations[t]){let r=e.peerInformations[t].userData;return r||(r=""),r}return e.user.userData},setUserData:(e,t)=>{const r=ko.getSkylinkState(e.id),{PEER_INFORMATIONS:{UPDATE_USER_DATA:n}}=Ft,s=t||"";r.user.userData=s,ko.setSkylinkState(r,r.room.id),(new ii).setUserData(r),Vt(ve({peerId:r.user.sid,peerInfo:gi.getCurrentSessionInfo(e),isSelf:!0})),zt.log.INFO(n,s);},getPeersDataChannels:e=>{const{peerDataChannels:t}=e,r={},n=Object.keys(t);for(let e=0;e<n.length;e+=1){const s=n[e];if(r[s]={},hi(t)){const e=Object.keys(t[s]);for(let n=0;n<e.length;n+=1){const i=t[s][e[n]],{channelName:o,channelType:a,transferId:c,streamId:d}=i;let l=null;l=lo.getDataChannelBuffer(i),l.channelProp=e[n],l.channelName=o,l.channelType=a,l.currentTransferId=c,l.currentStreamId=d,l.readyState=i.channel?i.channel.readyState:Be.CREATE_ERROR,r[s][o]=l;}}}return r},getPeersCustomSettings:e=>{const{peerInformations:t}=e,r={};if((e=>!wi(e))(t)){const n=Object.keys(t);for(let t=0;t<n.length;t+=1)n[t]!==Pt.MCU&&(r[n[t]]=mi(e,n[t]));return r}return r}};class fi{static getPeerInfo(e,t){return gi.getPeerInfo(e,t)}static getCurrentSessionInfo(e){return gi.getCurrentSessionInfo(e)}static getUserInfo(e){return gi.getUserInfo(e)}static getUserData(e,t){return gi.getUserData(e,t)}static setUserData(e,t){gi.setUserData(e,t);}static getPeersStreams(e,t){return gi.getPeersStreams(e,t)}static getPeersDataChannels(e){return gi.getPeersDataChannels(e)}static getPeersCustomSettings(e){return gi.getPeersCustomSettings(e)}}const Ti=(e,t,r,n,s=!1)=>{const i=ko.getSkylinkState(n);return (Xi(r)&&e||qi(r)&&t)&&Vt(((e={})=>new Se("localMediaMuted",{detail:e}))({streamId:r.id,isScreensharing:s,mediaStatus:i.streamsMediaStatus[r.id]})),!0},_i=(e,t,r,n)=>{const s=ko.getSkylinkState(r.id),i=n,{streamsMutedSettings:o}=s;if(e){const e=fs.retrieveMediaId(Ct.VIDEO,i);fs.updatePeerMediaInfo(r,s.user.sid,e,Nt.MEDIA_STATE,o[i].videoMuted?Ot.MUTED:Ot.ACTIVE);}if(t){const t=fs.retrieveMediaId(Ct.AUDIO,i);setTimeout((()=>fs.updatePeerMediaInfo(r,s.user.sid,t,Nt.MEDIA_STATE,o[i].audioMuted?Ot.MUTED:Ot.ACTIVE)),e?1050:0);}},Ai=(e,t,r)=>{const{peerStreams:n,streamsMutedSettings:s,user:i}=e;let o=!1,a=!1;return n[i.sid]&&n[i.sid][r]&&(qi(n[i.sid][r])&&s[r].audioMuted!==t.audioMuted&&(o=!0),Xi(n[i.sid][r])&&s[r].videoMuted!==t.videoMuted&&(a=!0)),{hasToggledAudio:o,hasToggledVideo:a}},Ii=(e,t,r)=>{const n=ko.getSkylinkState(e),{room:s,peerConnections:i,peerInformations:o,peerStreams:a,user:c}=n,d=Ai(n,r,t),{hasToggledAudio:l,hasToggledVideo:E}=d;let S=null;a[c.sid]&&a[c.sid][t]&&(S=a[c.sid][t]);const p=!!fs.retrieveScreenMediaInfo(s,c.sid,{streamId:t});if(S)if(((e,t,r)=>{const n=e,{room:s}=n;t.hasToggledAudio&&(n.streamsMutedSettings[r].audioMuted=!n.streamsMutedSettings[r].audioMuted),t.hasToggledVideo&&(n.streamsMutedSettings[r].videoMuted=!n.streamsMutedSettings[r].videoMuted),zt.log.DEBUG(Ft.MEDIA_STREAM.UPDATE_MUTED_SETTINGS,n.streamsMutedSettings,r),ko.setSkylinkState(n,s.id);})(n,d,t),((e,t)=>{const r=t,{room:n}=r,s=(e=>e.getAudioTracks())(e),i=(e=>e.getVideoTracks())(e);r.streamsMediaStatus[e.id].audioMuted=Tt.UNAVAILABLE,r.streamsMediaStatus[e.id].videoMuted=Tt.UNAVAILABLE,s.forEach((t=>{t.enabled=!r.streamsMutedSettings[e.id].audioMuted,r.streamsMediaStatus[e.id].audioMuted=r.streamsMutedSettings[e.id].audioMuted?Tt.MUTED:Tt.ACTIVE;})),i.forEach((t=>{t.enabled=!r.streamsMutedSettings[e.id].videoMuted,r.streamsMediaStatus[e.id].videoMuted=r.streamsMutedSettings[e.id].videoMuted?Tt.MUTED:Tt.ACTIVE;})),ko.setSkylinkState(r,n.id),zt.log.DEBUG(Ft.MEDIA_STREAM.UPDATE_MEDIA_STATUS,r.streamsMediaStatus,e.id);})(S,n),Ti(E,l,S,s.id,p),(e=>{const t=ko.getSkylinkState(e.id).user.sid,r=fi.getCurrentSessionInfo(e);Vt(ve({isSelf:!0,peerId:t,peerInfo:r}));})(s),((e,t,r)=>{const n=ko.getSkylinkState(e.id);tn.dispatchStreamEvent("streamMuted",{isSelf:!0,peerId:n.user.sid,peerInfo:fi.getUserInfo(e),streamId:t.id,isScreensharing:r,isAudio:qi(t),isVideo:Xi(t)});})(s,S,p),!i[Pt.MCU]&&bi(Object.keys(i))||i[Pt.MCU]&&bi(Object.keys(o))){const e=r=>{const{state:n}=r.detail;n===rt.ANSWER_ACK&&(_i(E,l,s,t),Ht(Gt.HANDSHAKE_PROGRESS,e));};xt(Gt.HANDSHAKE_PROGRESS,e);}else setTimeout((()=>{_i(E,l,s,t);}),500);},Ci=e=>{switch(e){case 1:return !1;case 0:default:return !0}},Oi=(e,t,r=null)=>{const{peerStreams:n,room:s,user:i}=e;if(!Gi(t))return void zt.log.ERROR(Ft.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);if(!n[i.sid])return void zt.log.WARN(Ft.MEDIA_STREAM.ERRORS.NO_STREAM);if(r&&!n[i.sid][r])return void zt.log.ERROR(Ft.MEDIA_STREAM.ERRORS.INVALID_STREAM_ID,r);const o={audioMuted:xi(t.audioMuted)?t.audioMuted:!Fi(t.audioMuted)||Ci(t.audioMuted),videoMuted:xi(t.videoMuted)?t.videoMuted:!Fi(t.videoMuted)||Ci(t.videoMuted)},a=r?[r]:n[i.sid]&&Object.keys(n[i.sid])||[];if(bi(a))return void zt.log.ERROR(Ft.MEDIA_STREAM.ERRORS.NO_STREAMS_MUTED,t);Object.values(a).filter((t=>Ai(e,o,t).hasToggledAudio||Ai(e,o,t).hasToggledVideo)).forEach((e=>{Ii(s.id,e,o);}));},Ni=(e,t)=>{for(let r=0;r<t.length;r+=1)if(e.id===t[r].id)return !0;return !1},Di=(e,t)=>{const r=e.getTransceivers?e.getTransceivers():[],n=t.getTracks();if(bi(r))return !1;for(let e=0;e<r.length;e+=1)if(r[e].sender.track&&Ni(r[e].sender.track,n))return !0;return !1},vi=(e,t,r,n)=>{const s=e,i=r.getTracks();for(let e=0;e<i.length;e+=1){const o=n.addTrack(i[e],r);o&&hs.processNewSender(s,t,o);}ko.setSkylinkState(s,s.room.id);},yi=(e,t,r,n)=>{const{peerConnections:s,hasMCU:i}=e;try{if((e=>{const{user:t,room:r}=e,n=t.sid,s=fi.getCurrentSessionInfo(r);Vt(ve({isSelf:!0,peerId:n,peerInfo:s}));})(e),Object.keys(s).length>0||i){lo.refreshPeerConnection(Object.keys(s),e,!1,{}).then((()=>{r(t);})).catch((e=>{zt.log.ERROR(Ft.PEER_CONNECTION.REFRESH_CONNECTION.FAILED),n(e);}));}else zt.log.WARN(Ft.ROOM.ERRORS.NO_PEERS),r(t);}catch(e){zt.log.ERROR(e);}},Pi=e=>{const t={audio:{input:[],output:[]},video:{input:[]}};return e.forEach((e=>{const r={deviceId:e.deviceId||e.sourceId||"default",label:e.label,groupId:e.groupId||null};r.label=r.label||`Source for ${r.deviceId}`,["audio","audioinput"].indexOf(e.kind)>-1?t.audio.input.push(r):["video","videoinput"].indexOf(e.kind)>-1?t.video.input.push(r):"audiooutput"===e.kind&&t.audio.output.push(r);})),t},Mi=(e,t,r)=>{const n={streams:{video:null,audio:null,screenShare:null}};return Object.keys(r[t]).forEach((s=>{qi(r[t][s])?(n.streams.audio=n.streams.audio||{},n.streams.audio[s]=r[t][s]):Xi(r[t][s])&&fs.retrieveScreenMediaInfo(e.room,t,{streamId:s})?(n.streams.screenShare=n.streams.screenShare||{},n.streams.screenShare[s]=r[t][s]):(n.streams.video=n.streams.video||{},n.streams.video[s]=r[t][s]);})),n},ki={parseMediaOptions:(e,t)=>{const r=ko.getSkylinkState(t.room.id),n=e||{};return r.voiceActivityDetection="boolean"!=typeof n.voiceActivityDetection||n.voiceActivityDetection,n.bandwidth&&("number"==typeof n.bandwidth.audio&&(r.streamsBandwidthSettings.bAS.audio=n.bandwidth.audio),"number"==typeof n.bandwidth.video&&(r.streamsBandwidthSettings.bAS.video=n.bandwidth.video),"number"==typeof n.bandwidth.data&&(r.streamsBandwidthSettings.bAS.data=n.bandwidth.data)),n.autoBandwidthAdjustment&&zt.log.WARN(Ft.JOIN_ROOM.AUTO_BANDWIDTH_DEPRECATED),r},parseStreamSettings:(e,t="")=>{const r=((e,t="")=>{const r={audio:!1,video:!1};return (e.audio&&!t||e.audio&&t===Ct.AUDIO)&&(r.audio=Yt(Qt.MEDIA_OPTIONS.AUDIO),Gi(e.audio)&&(xi(e.audio.stereo)&&(r.audio.stereo=e.audio.stereo),xi(e.audio.echoCancellation)&&(r.audio.echoCancellation=e.audio.echoCancellation),e.audio.deviceId&&Hi(e.audio.deviceId)&&(r.audio.deviceId=e.audio.deviceId),e.useExactConstraints&&xi(e.useExactConstraints)&&(r.audio.exactConstraints=e.useExactConstraints))),(e.video&&!t||e.video&&t===Ct.VIDEO)&&(r.video=Yt(Qt.MEDIA_OPTIONS.VIDEO),Gi(e.video)&&(e.video.deviceId&&Hi(e.video.deviceId)&&(r.video.deviceId=e.video.deviceId),e.video.resolution&&Gi(e.video.resolution)&&((e.video.resolution.width&&Hi(e.video.resolution.width)||Fi(e.video.resolution.width)||Gi(e.video.resolution.width))&&(r.video.resolution.width=e.video.resolution.width),(e.video.resolution.height&&Hi(e.video.resolution.height)||Fi(e.video.resolution.height)||Gi(e.video.resolution.height))&&(r.video.resolution.height=e.video.resolution.height)),(e.video.frameRate&&Hi(e.video.frameRate)||Fi(e.video.frameRate)||Gi(e.video.frameRate))&&(r.video.frameRate=e.video.frameRate),e.useExactConstraints&&xi(e.useExactConstraints)&&(r.video.exactConstraints=e.useExactConstraints))),r})(e,t);return {settings:r,mutedSettings:{shouldAudioMuted:!(!e.audio||!xi(e.audio.mute))&&e.audio.mute,shouldVideoMuted:!(!e.video||!xi(e.video.mute))&&e.video.mute},getUserMediaSettings:((e,t)=>{const r={audio:!1,video:!1};return (e.audio&&!t||e.audio&&t===Ct.AUDIO)&&e.audio&&Gi(e.audio)&&(r.audio={},r.audio.echoCancellation=!0,xi(e.audio.echoCancellation)&&(r.audio.echoCancellation=e.audio.echoCancellation),e.audio.deviceId&&Hi(e.audio.deviceId)&&(r.audio.deviceId=e.audio.exactConstraints?{exact:e.audio.deviceId}:{ideal:e.audio.deviceId})),(e.video&&!t||e.video&&t===Ct.VIDEO)&&(e.video&&Gi(e.video)?(r.video={},e.video.deviceId&&Hi(e.video.deviceId)&&(r.video.deviceId=e.video.exactConstraints?{exact:e.video.deviceId}:{ideal:e.video.deviceId}),r.video.width=Gi(e.video.resolution.width)?e.video.resolution.width:e.video.exactConstraints?{exact:e.video.resolution.width}:{max:e.video.resolution.width},r.video.height=Gi(e.video.resolution.height)?e.video.resolution.height:e.video.exactConstraints?{exact:e.video.resolution.height}:{max:e.video.resolution.height},(e.video.frameRate&&Gi(e.video.frameRate)||Fi(e.video.frameRate))&&(r.video.frameRate=Gi(e.video.frameRate)?e.video.frameRate:e.video.exactConstraints?{exact:e.video.frameRate}:{max:e.video.frameRate})):e.video&&(r.video={width:e.video.exactConstraints?{exact:e.video.resolution.width}:{max:e.video.resolution.width},height:e.video.exactConstraints?{exact:e.video.resolution.height}:{max:e.video.resolution.height}})),r})(r,t)}},prepMediaAccessRequest:e=>new Promise(((t,r)=>{const{roomKey:n}=e,s=ki.parseStreamSettings(e,Ct.AUDIO),i=ki.parseStreamSettings(e,Ct.VIDEO),{AdapterJS:o}=window;s.getUserMediaSettings.audio||i.getUserMediaSettings.video||r(Ft.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),o.webRTCReady((()=>{window.navigator.mediaDevices.getUserMedia({audio:s.getUserMediaSettings.audio,video:i.getUserMediaSettings.video}).then((e=>{const r=ki.onStreamAccessSuccess(n,e,s,i,!1),o=ko.getSkylinkState(n);r[0]&&s.mutedSettings.shouldAudioMuted&&Oi(o,{audioMuted:s.mutedSettings.shouldAudioMuted,videoMuted:i.mutedSettings.shouldVideoMuted},r[0].id),r[1]&&i.mutedSettings.shouldVideoMuted&&Oi(o,{audioMuted:s.mutedSettings.shouldAudioMuted,videoMuted:i.mutedSettings.shouldVideoMuted},r[1].id),t(r);})).catch((e=>ki.onStreamAccessError(e,r,t,n,s,i)));}));})),addLocalMediaStreams:(e,t)=>{const r=ko.getSkylinkState(t.room.id),{peerConnections:n,user:s,peerStreams:i}=r,o=n[e];i[s.sid]&&!wi(i[s.sid])&&((e,t,r,n)=>{const s=Object.values(r);for(let r=0;r<s.length;r+=1)Di(n,s[r])||vi(e,t,s[r],n);})(r,e,i[s.sid],o);},onRemoteTrackAdded:(e,t,r,n,s,i)=>{const{user:o,hasMCU:a,room:c}=t,d={dispatchOnIncomingStream:e=>{Vt(pe(e));},dispatchOnIncomingScreenStream:e=>{Vt(ue(e));}},l=n?"dispatchOnIncomingScreenStream":"dispatchOnIncomingStream",E={stream:e,peerId:r,room:Ri.getRoomInfo(c),isSelf:a&&r===o.sid||!1,peerInfo:fi.getPeerInfo(r,c),streamId:e.id,isVideo:s,isAudio:i};d[l](E),Vt(ve({peerId:r,peerInfo:fi.getPeerInfo(r,c),isSelf:a&&r===o.sid||!1,room:c}));},onStreamAccessError:(e,t,r,n,s,i)=>{const o=ko.getInitOptions(),a=ko.getSkylinkState(n),{audioFallback:c}=o;if(s.settings.audio&&i.settings.video&&c){const o=!0;return zt.log.DEBUG([a.user.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.START_FALLBACK]),Vt(Ge({error:e,state:St.FALLBACKING,isAudioFallback:o})),window.navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{const t=ki.onStreamAccessSuccess(n,e,s,i,o);r(t);})).catch((r=>{zt.log.ERROR([a.user.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.FALLBACK,r]),Vt(Fe({error:r,isAudioFallbackError:!0})),Vt(Ge({error:e,state:St.ERROR,isAudioFallback:o})),t(r);}))}zt.log.ERROR([a.user.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.GET_USER_MEDIA],e),Vt(Fe({error:e,isAudioFallbackError:!1})),t(e);},muteStreams:Oi,sendStream:(e,t=null)=>new Promise(((r,n)=>{if(!e)return n(new Error(Ft.ROOM_STATE.NO_ROOM_NAME));const{room:s}=e,i=!Gi(t)||null===t;if(!s.inRoom)return zt.log.WARN(Ft.ROOM.ERRORS.NOT_IN_ROOM),n(new Error(`${Ft.ROOM.ERRORS.NOT_IN_ROOM}`));if(i)return n(new Error(`${Ft.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${t}`));let o=!1;try{if(Array.isArray(t)){let s=!0;if(t.forEach((e=>{Bi(e.getAudioTracks)&&Bi(e.getVideoTracks)||(s=!1);})),!s)return n(new Error(Ft.MEDIA_STREAM.ERRORS.INVALID_MEDIA_STREAM_ARRAY));let i=!0;return t.forEach((e=>{e.active||(i=!1);})),i?((e,t,r,n)=>{const s=[];return t.forEach((t=>{s.push(on.usePrefetchedStream(e.room.id,t));})),Promise.all(s).then((t=>{yi(e,t,r,n);})).catch((e=>{n(e);}))})(e,t,r,n):n(new Error(Ft.MEDIA_STREAM.ERRORS.INACTIVE_MEDIA_STREAM))}return o=!!t&&(Bi(t.getAudioTracks)||Bi(t.getVideoTracks)),o?((e,t,r,n)=>on.usePrefetchedStream(e.room.id,t).then((t=>{yi(e,t,r,n);})).catch((e=>{n(e);})))(e,t,r,n):((e,t,r,n)=>on.getUserMedia(e,t).then((t=>{yi(e,t,r,n);})).catch((e=>{n(e);})))(e,t,r,n)}catch(e){zt.log.ERROR(Ft.MEDIA_STREAM.ERRORS.SEND_STREAM,e);}})),getStreamSources:()=>{const{navigator:e}=window;return new Promise(((t,r)=>{e.mediaDevices&&Bi(e.mediaDevices.enumerateDevices)?e.mediaDevices.enumerateDevices().then((e=>{t(Pi(e));})):r(Pi([]));}))},getStreams:(e,t=!0)=>{const r=ko.getSkylinkState(e.room.id),{peerStreams:n,user:s}=r,i={},o=Object.keys(n);for(let e=0;e<o.length;e+=1){const a=o[e];t&&a===s.sid?(i[a]=Mi(r,a,n),i[a].isSelf=!0):a!==s.sid&&(i[a]=Mi(r,a,n));}return i},updateStreamsMediaStatus:(e,t,r)=>{const n=ko.getSkylinkState(e),{room:s,streamsMediaStatus:i}=n,{mutedSettings:{shouldAudioMuted:o,shouldVideoMuted:a},settings:{audio:c,video:d}}=t;i[r.id]={},i[r.id].audioMuted=c?o?Tt.MUTED:Tt.ACTIVE:Tt.UNAVAILABLE,i[r.id].videoMuted=d?a?Tt.MUTED:Tt.ACTIVE:Tt.UNAVAILABLE,ko.setSkylinkState(n,s.id);},splitAudioAndVideoStream:e=>{const{MediaStream:t}=window,r=[],n=e.getAudioTracks(),s=e.getVideoTracks();return qi(e)?r.push(new t(n)):r.push(null),Xi(e)?r.push(new t(s)):r.push(null),r},updateStreamsMutedSettings:(e,t,r)=>{const n=ko.getSkylinkState(e),{room:s,streamsMutedSettings:i}=n,{audio:o,video:a}=t.settings;i[r.id]={},i[r.id].audioMuted=!o,i[r.id].videoMuted=!a,ko.setSkylinkState(n,s.id);},onStreamAccessSuccess:(e,t,r,n,s,i=!1,o)=>{const a=i?[t]:ki.splitAudioAndVideoStream(t),c=ko.getSkylinkState(e),{room:d,user:l}=c;return a.forEach((t=>{t&&(tn.addStream(l.sid,t,e),on.buildStreamSettings(d,t,qi(t)?r:n),ki.updateStreamsMutedSettings(d.id,qi(t)?r:n,t),ki.updateStreamsMediaStatus(d.id,qi(t)?r:n,t),fs.processPeerMedia(d,l.sid,t,i),null!==l.sid&&(new en).send(d.id),s&&zt.log.DEBUG([l.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.FALLBACK_SUCCESS]),i?(zt.log.DEBUG([l.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.START_SCREEN_SUCCESS]),tn.dispatchStreamEvent("onIncomingScreenStream",{stream:t,peerId:l.sid,room:Ri.getRoomInfo(d),isSelf:!0,peerInfo:fi.getCurrentSessionInfo(d),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0})):l.sid&&tn.dispatchStreamEvent("onIncomingStream",{stream:t,peerId:l.sid,room:Ri.getRoomInfo(d),isSelf:!0,peerInfo:fi.getCurrentSessionInfo(d),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0}),o||Vt(((e={})=>new Se("mediaAccessSuccess",{detail:e}))({stream:t,isScreensharing:i,isAudioFallback:s,streamId:t.id,isAudio:qi(t),isVideo:Xi(t)})));})),a},buildStreamSettings:(e,t,r)=>{const n=ko.getSkylinkState(e.id);n.streamsSettings[t.id]={settings:r.settings,constraints:r.getUserMediaSettings},ko.setSkylinkState(n,e.id);}},wi=e=>0===Object.keys(e).length,bi=e=>0===e.length,Li=e=>""===e,Gi=e=>"object"==typeof e&&null!==e,Ui=e=>"object"==typeof e&&null==e,Fi=e=>"number"==typeof e,Bi=e=>"function"==typeof e,xi=e=>void 0!==e&&"boolean"==typeof e,Hi=e=>"string"==typeof e,Vi=(e,t,r)=>{let n=!0;return null!=e&&Hi(e)||(zt.log.ERROR(`${r}: ${t} is null, undefined or not a string.`),n=!1),n},ji=e=>{if(Vi(e,"roomId","getStateByRid")){const t=ko.getSkylinkState(),r=Object.keys(t);let n=null;for(let s=0;s<r.length;s+=1){const i=r[s];if(i===e){n=t[i];break}}return n}return zt.log.ERROR(`getRoomStateByRid: ${Ft.ROOM_STATE.NOT_FOUND} - ${e}`),null},$i=e=>ji(e),Wi=e=>{let t=null;if(Vi(e,"roomName","getRoomStateByName")){const r=ko.getSkylinkState(),n=Object.keys(r);for(let s=0;s<n.length;s+=1){const i=r[n[s]];if(i.room.roomName.toLowerCase()===e.toLowerCase()){t=i;break}}}return t||zt.log.ERROR(`getRoomStateByName: ${Ft.ROOM_STATE.NOT_FOUND} - ${e}`),t},Ki=()=>{try{(new ii).socket.disconnect();}catch(e){zt.log.ERROR(e);}},zi=()=>{let e=(new Date).getTime();return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(t=>{const r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?r:r&&15).toString(16)}))},Yi=e=>new Promise(((t,r)=>{const{navigator:n}=window;e&&Gi(e)||r(new Error(`${Ft.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${e}`)),n.mediaDevices.getUserMedia(e).then((e=>{const r=ki.splitAudioAndVideoStream(e);t(r);})).catch((e=>{r(e);}));})),Ji=e=>new Promise(((t,r)=>{r(new Error(e));})),Qi=(e,t)=>{const r=ko.getSkylinkState(e.id),{peerConnections:n}=r,s=Object.keys(n);let i=!1;return s.forEach((e=>{e===t&&(i=!0);})),i},qi=e=>e.getAudioTracks().length>0,Xi=e=>e.getVideoTracks().length>0,Zi=e=>{const{AdapterJS:t}=window;switch(e){case yt.CHROME:return t.webrtcDetectedBrowser===yt.CHROME;case yt.SAFARI:return t.webrtcDetectedBrowser===yt.SAFARI;case yt.FIREFOX:return t.webrtcDetectedBrowser===yt.FIREFOX;case yt.REACT_NATIVE:return t.webrtcDetectedBrowser===yt.REACT_NATIVE;default:return zt.log.DEBUG(Ft.UTILS.INVALID_BROWSER_AGENT),!1}},eo=e=>new Date(e).toISOString(),to=()=>(new Date).toISOString(),ro=(e,t,r,n,s)=>{const i="data"===n?"application":n;let o=-1,a=-1;for(let e=0;e<t.length;e+=1)if(0===t[e].indexOf("m="+i))o=e;else if(o>0){if(0===t[e].indexOf("m="))break;0===t[e].indexOf("c=")?a=e:0!==t[e].indexOf("b=AS:")&&0!==t[e].indexOf("b:TIAS:")||(t.splice(e,1),e-=1);}"number"==typeof s&&s>0?-1!==o&&-1!==a?(zt.log.INFO([e,"RTCSessionDescription",r,`Limiting maximum sending ${n} bandwidth ->`],s),t.splice(a+1,0,"firefox"===window.webrtcDetectedBrowser?"b=TIAS:"+(1e3*s).toFixed(0):"b=AS:"+s)):zt.log.INFO([e,"RTCSessionDescription",r,`Not limiting ${n} bandwidth as ${n} is not being sent`]):zt.log.INFO([e,"RTCSessionDescription",r,`Not limiting ${n} bandwidth`]);},no={getSDPCommonSupports:(e,t=null,r)=>{const n=ko.getSkylinkState(r),s={audio:!1,video:!1},{currentCodecSupport:i,peerInformations:o}=n,{beSilentOnParseLogs:a}=ko.getInitOptions();if(!e||!t||!t.sdp){if(s.video=!(!i.video.h264&&!i.video.vp8),s.audio=!!i.audio.opus,e){const t=((o[e]||{}).agent||{}).name||"";Zi(t)&&(s.video=Object.keys(i.video).length>0,s.audio=Object.keys(i.audio).length>0);}return s}const c=no.getSDPCodecsSupport(e,t,a),d=i;for(const e in d.audio)if(d.audio.hasOwnProperty(e)&&d.audio[e]&&c.audio[e]){s.audio=!0;break}for(const e in d.video)if(d.video.hasOwnProperty(e)&&d.video[e]&&c.video[e]){s.video=!0;break}return s},getSDPCodecsSupport:(e,t,r)=>{const n={audio:{},video:{}};if(!t||!t.sdp)return n;const s=t.sdp.split("\r\n");let i="";for(let e=0;e<s.length;e+=1)if(0!==s[e].indexOf("m=")){if(0===s[e].indexOf("a=rtpmap:")){const t=(s[e].split(" ")[1]||"").split("/"),r=(t[0]||"").toLowerCase(),o=t[1]+(t[2]?`/${t[2]}`:"");if(["ulpfec","red","telephone-event","cn","rtx"].indexOf(r)>-1)continue;n[i][r]=n[i][r]||[],-1===n[i][r].indexOf(o)&&n[i][r].push(o);}}else i=(s[e].split("m=")[1]||"").split(" ")[0];return r||zt.log.INFO([e||null,"RTCSessionDescription",t.type,"Parsed codecs support ->"],n),n},getCodecsSupport:e=>new Promise(((t,r)=>{const n=ko.getSkylinkState(e),{beSilentOnParseLogs:s}=ko.getInitOptions(),i=n,{RTCPeerConnection:o}=window;n.currentCodecSupport&&t(n.currentCodecSupport),i.currentCodecSupport={audio:{},video:{}},Zi(yt.SAFARI)&&(i.currentCodecSupport.audio={opus:["48000/2"]},i.currentCodecSupport.video={h264:["48000"]},t(i.currentCodecSupport));try{const e=new o(null);let n={};e.addTransceiver?(e.addTransceiver(Ct.VIDEO),e.addTransceiver(Ct.AUDIO)):n={mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}},e.createOffer(n).then((e=>{i.currentCodecSupport=so.getSDPCodecsSupport(null,e,s),t(i.currentCodecSupport);})).catch((e=>{r(e);}));}catch(e){r(e);}})),setSDPBitrate:(e,t,r)=>{const n=ko.getSkylinkState(r),s=t.sdp.split("\r\n"),i=t.type;let o,a,c;const d=fi.getPeersCustomSettings(n);return n.streamsBandwidthSettings.bAS?(o=n.streamsBandwidthSettings.bAS.audio,a=n.streamsBandwidthSettings.bAS.video,c=n.streamsBandwidthSettings.bAS.data):d[e]&&d[e].maxBandwidth&&"object"==typeof d[e].maxBandwidth&&("number"==typeof d[e].maxBandwidth.audio&&(o=d[e].maxBandwidth.audio),"number"==typeof d[e].maxBandwidth.video&&(a=d[e].maxBandwidth.video),"number"==typeof d[e].maxBandwidth.data&&(c=d[e].maxBandwidth.data)),n.hasMCU&&!a&&(zt.log.DEBUG([e,"RTCSessionDescription",i,"Setting max video bandwidth limit to 500 for MCU connection"]),a=500),ro(e,s,i,"audio",o),ro(e,s,i,"video",a),ro(e,s,i,"data",c),s.join("\r\n")},getSDPICECandidates:(e,t,r)=>{const{RTCIceCandidate:n}=window,s={host:[],srflx:[],relay:[]};return t&&t.sdp?(t.sdp.split("m=").forEach(((e,t)=>{if(0===t)return;const r=((e.match(/a=mid:.*\r\n/gi)||[])[0]||"").replace(/a=mid:/gi,"").replace(/\r\n/,""),i=t-1;(e.match(/a=candidate:.*\r\n/gi)||[]).forEach((e=>{const t=(e.split(" ")[7]||"host").replace(/\r\n/g,"");s[t]=s[t]||[],s[t].push(new n({sdpMid:r,sdpMLineIndex:i,candidate:(e.split("a=")[1]||"").replace(/\r\n/g,"")}));}));})),r||zt.log.INFO([e,"RTCSessionDesription",t.type,"Parsing session description ICE candidates ->"],s),s):s},getSDPSelectedCodec:(e,t,r,n)=>{const s={name:null,implementation:null,clockRate:null,channels:null,payloadType:null,params:null};return t&&t.sdp?(t.sdp.split("m=").forEach(((e,t)=>{if(0===t||0!==e.indexOf(`${r} `))return;const n=(e.split("\r\n")[0]||"").split(" ");n.splice(0,3);for(let t=0;t<n.length;t+=1){const r=e.match(new RegExp(`a=rtpmap:${n[t]}.*\r\n`,"gi"));if(!r)continue;const i=((r[0]||"").replace(/\r\n/g,"").split(" ")[1]||"").split("/");if(["red","ulpfec","telephone-event","cn","rtx"].indexOf(i[0].toLowerCase())>-1)continue;s.name=i[0],s.clockRate=parseInt(i[1],10)||0,s.channels=parseInt(i[2]||"1",10)||1,s.payloadType=parseInt(n[t],10),s.params="";(e.match(new RegExp(`a=fmtp:${n[t]}.*\r\n`,"gi"))||[]).forEach((e=>{s.params+=e.replace(new RegExp(`a=fmtp:${n[t]}`,"gi"),"").replace(/ /g,"").replace(/\r\n/g,"");}));break}})),n||zt.log.INFO([e,"RTCSessionDesription",t.type,`Parsing session description "${r}" codecs ->`],s),s):s},getTransceiverMid:(e,t)=>{const r={audio:[],video:[]};return e.sdp.split("m=").forEach(((e,t)=>{const n=e.split(/\n/),s=n[0].split(" ")[0];if("application"===s||0===t)return;let i={};for(let e=0;e<n.length;e+=1){if(n[e].match(/a=recvonly|a=sendonly|a=sendrecv|a=inactive/)){const t=n[e].split("=");i.direction=t[1].trim();}if(n[e].match(/a=mid:*/)&&(i.transceiverMid=n[e].split(/:/)[1].trim()),n[e].match(/a=msid:([\w|-|{]+)/)){const t=n[e].split(" "),r=t[0].split(/:/)[1].trim();i.streamId="-"===r?"":r,i.trackId=t[1].trim();}i.transceiverMid&&i.streamId&&i.trackId&&(r[s].push(i),i={});}})),t||zt.log.INFO([null,"RTCSessionDesription",e.type,`Parsing session description "${e.type}" transceivers ->`],r),r},removeSDPFilteredCandidates:(e,t,r)=>{const n=ko.getInitOptions(),s=ko.getSkylinkState(r);return n.forceTURN&&s.hasMCU?(zt.log.WARN([e,"RTCSessionDesription",t.type,Ft.ICE_CANDIDATE.FILTERING_FLAG_NOT_HONOURED]),t.sdp):(n.filterCandidatesType.host&&(zt.log.INFO([e,"RTCSessionDesription",t.type,'Removing "host" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*host.*\r\n/g,"")),n.filterCandidatesType.srflx&&(zt.log.INFO([e,"RTCSessionDesription",t.type,'Removing "srflx" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*srflx.*\r\n/g,"")),n.filterCandidatesType.relay&&(zt.log.INFO([e,"RTCSessionDesription",t.type,'Removing "relay" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*relay.*\r\n/g,"")),t.sdp)}};class so{static getSDPCommonSupports(...e){return no.getSDPCommonSupports(...e)}static getCodecsSupport(...e){return no.getCodecsSupport(...e)}static setSDPBitrate(...e){return no.setSDPBitrate(...e)}static getSDPCodecsSupport(...e){return no.getSDPCodecsSupport(...e)}static getSDPICECandidates(...e){return no.getSDPICECandidates(...e)}static getSDPSelectedCodec(...e){return no.getSDPSelectedCodec(...e)}static getTransceiverMid(...e){return no.getTransceiverMid(...e)}static removeSDPFilteredCandidates(...e){return no.removeSDPFilteredCandidates(...e)}}const oo=e=>"relay"===e?"relayed":"host"===e||e.indexOf("host")>-1?"local":"srflx"===e?"serverreflexive":"prflx"===e?"peerreflexive":e,ao={parseSelectedCandidatePair:(e,t,r,n,s,i)=>{const{peerStats:o}=e,{raw:a,selectedCandidatePair:c}=t,d=Object.keys(t.raw);let l=null,E=null,S=null;if(Zi(yt.CHROME))for(let e=0;e<d.length;e+=1)"transport"===a[d[e]].type&&(l=a[d[e]]);else Zi(yt.FIREFOX)&&(l={});if(l)for(let e=0;e<d.length;e+=1){const t=a[d[e]];if("candidate-pair"===t.type&&t.id===l.selectedCandidatePairId||"candidate-pair"===t.type&&t.selected){const e=t;E=e.localCandidateId,S=e.remoteCandidateId,c.id=e.id,c.writable=e.writable,c.priority=e.priority,c.nominated=e.nominated;const r=o[i][t.id],n=parseInt(t.totalRoundTripTime||"0",10);c.totalRoundTripTime=n,c.roundTripTime=ao.tabulateStats(r,t,"totalRoundTripTime");const s=parseInt(t.consentRequestsSent||"0",10);c.consentRequests.totalSent=s,c.consentRequests.sent=ao.tabulateStats(r,t,"consentRequestsSent");const a=parseInt(t.requestsReceived||"0",10);c.requests.totalReceived=a,c.requests.received=ao.tabulateStats(r,t,"requestsReceived");const d=parseInt(t.requestsSent||"0",10);c.requests.totalSent=d,c.requests.sent=ao.tabulateStats(r,t,"requestsSent");const l=parseInt(t.responsesSent||"0",10);c.responses.totalSent=l,c.responses.sent=ao.tabulateStats(r,t,"responsesSent");const p=parseInt(t.responsesReceived||"0",10);c.responses.totalReceived=p,c.responses.received=ao.tabulateStats(r,t,"responsesReceived");}}if(E&&S){if("remote-candidate"===r){const e=n;e.id===S&&(c.remote.ipAddress=e.ip?e.ip:e.address,c.remote.portNumber=e.port,c.remote.transport=e.protocol,c.remote.priority=e.priority,c.remote.candidateType=oo(e.candidateType));}if("local-candidate"===r){const e=n;e.id===E&&(c.local.ipAddress=e.ip?e.ip:e.address,c.local.portNumber=e.port,c.local.transport=e.protocol,c.local.priority=e.priority,c.local.networkType=e.networkType,c.local.candidateType=oo(e.candidateType));}}},parseCertificates:(e,t)=>{const{certificate:r,raw:n}=e,s=Object.keys(e.raw);let i=null;for(let e=0;e<s.length;e+=1)"transport"===n[s[e]].type&&(i=n[s[e]]);if(i){r.srtpCipher=i.srtpCipher,r.dtlsCipher=i.dtlsCipher,r.tlsVersion=i.tlsVersion;const{localCertificateId:e,remoteCertificateId:n}=i;t.id===e?(r.local={},r.local.base64Certificate=t.base64Certificate,r.local.fingerprintAlgorithm=t.fingerprintAlgorithm):t.id===n&&(r.remote={},r.remote.base64Certificate=t.base64Certificate,r.remote.fingerprintAlgorithm=t.fingerprintAlgorithm);}},tabulateStats:(e=null,t,r)=>{const n=t.timestamp,s=e&&e.timestamp||new Date(t.timestamp).getTime()-2e4,i=parseFloat(t[r]||"0",10);let o=parseFloat(e&&e[r]||"0",10);return i<o&&(o=0),new Date(n).getTime()===new Date(s).getTime()?i:parseFloat(((i-o)/(n-s)*1e3).toFixed(3)||"0",10)},parseAudio:(e,t,r,n,s,i)=>{const{peerStats:o}=e,a=o[s][n.id];switch(i){case"receiving":((e,t,r)=>{const n=e.audio.receiving;if(n.bytes=n.bytes||0,t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);n.totalBytes=e,n.bytes+=ao.tabulateStats(r,t,"bytesReceived");}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);n.totalPackets=e,n.packets=ao.tabulateStats(r,t,"packetsReceived");}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);n.totalPacketsLost=e,n.packetsLost=ao.tabulateStats(r,t,"packetsLost");}n.jitter=parseInt(t.jitter||"0",10),n.ssrc=t.ssrc;const{trackId:s}=t,i=e.raw[s];i&&(n.audioLevel=i.audioLevel?parseFloat(i.audioLevel).toFixed(5):"0",n.totalSamplesReceived=parseInt(i.totalSamplesReceived||"0",10),n.totalSamplesDuration=parseInt(i.totalSamplesDuration||"0",10));})(t,n,a);break;case"sending":((e,t,r)=>{const n=e.audio.sending;if(n.bytes=n.bytes||0,t.bytesSent){n.bytes=n.bytes?n.bytes:0;const e=parseInt(t.bytesSent||"0",10);n.totalBytes=e,n.bytes+=ao.tabulateStats(r,t,"bytesSent");}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);n.totalPackets=e,n.packets=ao.tabulateStats(r,t,"packetsSent");}if(t.retransmittedBytesSent||Fi(t.retransmittedBytesSent)){const e=parseInt(t.retransmittedBytesSent||"0",10);n.totalRetransmittedBytesSent=e,n.retransmittedBytesSent=ao.tabulateStats(r,t,"retransmittedBytesSent");}if(t.retransmittedPacketsSent||Fi(t.retransmittedPacketsSent)){const e=parseInt(t.retransmittedPacketsSent||"0",10);n.totalRetransmittedPacketsSent=e,n.retransmittedPacketsSent=ao.tabulateStats(r,t,"retransmittedPacketsSent");}n.ssrc=t.ssrc,t.jitter&&(n.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(n.roundTripTime=parseInt(t.roundTripTime||"0",10));const{trackId:s,mediaSourceId:i}=t,o=e.raw[s];o&&(n.echoReturnLoss=parseInt(o.echoReturnLoss||"0",10),n.echoReturnLossEnhancement=parseInt(o.echoReturnLossEnhancement||"0",10));const a=e.raw[i];a&&(n.audioLevel=a.audioLevel?parseFloat(a.audioLevel).toFixed(5):"0",n.totalSamplesDuration=parseInt(a.totalSamplesDuration||"0",10));})(t,n,a);break;default:zt.log.DEBUG([s,_t.STATS_MODULE,null,Ft.STATS_MODULE.ERRORS.PARSE_FAILED]);}},parseVideo:(e,t,r,n,s,i)=>{const{peerStats:o}=e,a=o[s][n.id];switch(i){case"receiving":((e,t,r)=>{const n=e.video.receiving;if(n.bytes=n.bytes||0,t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);n.totalBytes=e,n.bytes+=ao.tabulateStats(r,t,"bytesReceived");}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);n.totalPackets=e,n.packets=ao.tabulateStats(r,t,"packetsReceived");}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);n.totalPacketsLost=e,n.packetsLost=ao.tabulateStats(r,t,"packetsLost");}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);n.totalFirs=e,n.firs=ao.tabulateStats(r,t,"firCount");}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);n.totalNacks=e,n.nacks=ao.tabulateStats(r,t,"nackCount");}if(t.pliCount||Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);n.totalPlis=e,n.plis=ao.tabulateStats(r,t,"pliCount");}n.ssrc=t.ssrc,n.qpSum=parseInt(t.qpSum||"0",10),n.decoderImplementation=t.decoderImplementation;const{trackId:s}=t,i=e.raw[s];i&&(n.framesDropped=parseFloat(i.framesDropped||"0"),n.frames=parseInt(i.framesReceived||"0",10),n.framesDecoded=parseInt(i.framesDecoded||"0",10),n.frameWidth=parseInt(i.frameWidth||"0",10),n.frameHeight=parseInt(i.frameHeight||"0",10));})(t,n,a);break;case"sending":((e,t,r)=>{const n=e.video.sending;if(n.bytes=n.bytes||0,t.bytesSent){const e=parseInt(t.bytesSent||"0",10);n.totalBytes=e,n.bytes+=ao.tabulateStats(r,t,"bytesSent");}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);n.totalPackets=e,n.packets=ao.tabulateStats(r,t,"packetsSent");}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);n.totalFirs=e,n.firs=ao.tabulateStats(r,t,"firCount");}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);n.totalNacks=e,n.nacks=ao.tabulateStats(r,t,"nackCount");}if(Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);n.totalPlis=e,n.plis=ao.tabulateStats(r,t,"pliCount");}t.jitter&&(n.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(n.roundTripTime=parseInt(t.roundTripTime||"0",10)),Number.isInteger(t.framesEncoded)&&(n.framesEncoded=parseInt(t.framesEncoded||"0",10)),n.ssrc=t.ssrc,n.qpSum=parseInt(t.qpSum||"0",10);const{trackId:s,mediaSourceId:i}=t,o=e.raw[s];o&&(n.frameWidth=parseInt(o.frameWidth||"0",10),n.frameHeight=parseInt(o.frameHeight||"0",10),n.frames=parseInt(o.framesSent||"0",10),n.hugeFramesSent=parseInt(o.hugeFramesSent||"0",10));const a=e.raw[i];a&&(n.framesPerSecond=parseInt(a.framesPerSecond||"0",10));})(t,n,a);break;default:zt.log.DEBUG([s,_t.STATS_MODULE,null,Ft.STATS_MODULE.ERRORS.PARSE_FAILED]);}},parseMedia:(e,t,r,n,s,i,o)=>{const a=n.kind||n.mediaType;a===Ct.AUDIO?ao.parseAudio(e,t,r,n,i,o):a===Ct.VIDEO?ao.parseVideo(e,t,r,n,i,o):zt.log.DEBUG([i,_t.STATS_MODULE,null,Ft.STATS_MODULE.INVALID_TRACK_KIND],n);}};class co{constructor(e,t){this.roomState=ko.getSkylinkState(e),this.peerConnection=this.roomState.peerConnections[t]||null,this.dataChannel=this.roomState.peerDataChannels[t]||null,this.peerId=t,this.roomKey=e,this.output={peerId:t,raw:{},connection:{},audio:{sending:{},receiving:{}},video:{sending:{},receiving:{}},selectedCandidatePair:{id:null,local:{},remote:{},consentRequests:{},responses:{},requests:{}},certificate:{}},this.beSilentOnLogs=ko.getInitOptions().beSilentOnStatsLogs,this.beSilentOnParseLogs=ko.getInitOptions().beSilentOnParseLogs,this.bandwidth=null;}getConnectionStatus(){return this.getStatistics(!1,!1)}getStatsSuccess(e,t,r){if(!r&&Zi(yt.REACT_NATIVE))return void e(this.output);const{peerStats:n,room:s}=this.roomState;"function"==typeof r.forEach?r.forEach(((e,t)=>{this.output.raw[t]=e;})):this.output.raw=r;try{if(wi(n))return void zt.log.DEBUG([this.peerId,_t.STATS_MODULE,null,Ft.STATS_MODULE.STATS_DISCARDED]);Object.entries(this.output.raw).forEach((e=>{const t=e[0],r=e[1],{type:i}=r;switch(i){case"remote-inbound-rtp":case"outbound-rtp":case"inbound-rtp":"inbound-rtp"===i?ao.parseMedia(this.roomState,this.output,i,r,this.peerConnection,this.peerId,"receiving"):ao.parseMedia(this.roomState,this.output,i,r,this.peerConnection,this.peerId,"sending");break;case"certificate":ao.parseCertificates(this.output,r);break;case"local-candidate":case"remote-candidate":case"media-source":ao.parseSelectedCandidatePair(this.roomState,this.output,i,r,this.peerConnection,this.peerId);}n[this.peerId][t]=this.output.raw[t],ko.setSkylinkState(this.roomState,s.id);}));}catch(e){this.getStatsFailure(t,Ft.STATS_MODULE.ERRORS.PARSE_FAILED,e);}this.beSilentOnLogs||Vt(Le({state:Ze.RETRIEVE_SUCCESS,peerId:this.peerId,stats:this.output})),e(this.output);}getStatsFailure(e,t,r){const n=t||Ft.STATS_MODULE.RETRIEVE_STATS_FAILED;this.beSilentOnLogs||(zt.log.ERROR([this.peerId,_t.STATS_MODULE,null,n],r),Vt(Le({state:Ze.RETRIEVE_ERROR,peerId:this.peerId,error:r}))),e(r);}getStatistics(e=!1){const{STATS_MODULE:t}=Ft;return new Promise(((r,n)=>{if(this.roomState.peerStats[this.peerId]){this.beSilentOnLogs=e;try{this.gatherRTCPeerConnectionDetails(),this.gatherSDPIceCandidates(),this.gatherSDPCodecs(),this.gatherRTCDataChannelDetails();}catch(e){zt.log.WARN([this.peerId,_t.STATS_MODULE,null,Ft.STATS_MODULE.ERRORS.PARSE_FAILED],e);}"function"!=typeof this.peerConnection.getStats&&this.getStatsFailure(n,Ft.PEER_CONNECTION.STATS_API_UNAVAILABLE),this.beSilentOnLogs||Vt(Le({state:Ze.RETRIEVING,peerId:this.peerId})),this.peerConnection.getStats().then((e=>{this.getStatsSuccess(r,n,e);})).catch((e=>{e.message!==Ft.STATS_MODULE.ERRORS.STATS_IS_NULL?this.getStatsFailure(n,null,e):zt.log.WARN([this.peerId,_t.STATS_MODULE,null,Ft.STATS_MODULE.ERRORS.RETRIEVE_STATS_FAILED],e.message);}));}else zt.log.WARN(t.NOT_INITIATED),r(null);}))}gatherRTCPeerConnectionDetails(){const{peerConnection:e}=this;this.output.connection.iceConnectionState=e.iceConnectionState,this.output.connection.iceGatheringState=e.iceGatheringState,this.output.connection.signalingState=e.signalingState,this.output.connection.remoteDescription={type:e.remoteDescription&&e.remoteDescription.type||"",sdp:e.remoteDescription&&e.remoteDescription.sdp||""},this.output.connection.localDescription={type:e.localDescription&&e.localDescription.type||"",sdp:e.localDescription&&e.localDescription.sdp||""},this.output.connection.constraints=this.peerConnection.constraints?this.peerConnection.constraints:null,this.output.connection.sdpConstraints=this.peerConnection.sdpConstraints?this.peerConnection.sdpConstraints:null;}gatherSDPIceCandidates(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.connection.candidates={sending:so.getSDPICECandidates(this.peerId,e.localDescription,t),receiving:so.getSDPICECandidates(this.peerId,e.remoteDescription,t)};}gatherSDPCodecs(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.audio.sending.codec=so.getSDPSelectedCodec(this.peerId,e.remoteDescription,"audio",t),this.output.video.sending.codec=so.getSDPSelectedCodec(this.peerId,e.remoteDescription,"video",t),this.output.audio.receiving.codec=so.getSDPSelectedCodec(this.peerId,e.localDescription,"audio",t),this.output.video.receiving.codec=so.getSDPSelectedCodec(this.peerId,e.localDescription,"video",t);}gatherRTCDataChannelDetails(){const{dataChannel:e}=this;if(e){const t=Object.keys(e);this.output.connection.peerDataChannels={},t.forEach((t=>{const r=e[t];this.output.connection.peerDataChannels[r.channel.label]={label:r.channel.label,readyState:r.channel.readyState,channelType:xe["main"===t?"MESSAGING":"DATA"],currentTransferId:r.transferId||null,currentStreamId:r.streamId||null};}));}}}class lo{static addPeer(e){hs.addPeer(e);}static createOffer(...e){return hs.createOffer(...e)}static createAnswer(...e){return hs.createAnswer(...e)}static createDataChannel(...e){return Nn.createDataChannel(...e)}static sendP2PMessage(...e){return hs.sendP2PMessage(...e)}static getPeersInRoom(...e){return hs.getPeersInRoom(...e)}static retrieveStatistics(e,t,r){return new co(e,t).getStatistics(r)}static signalingEndOfCandidates(...e){return hs.signalingEndOfCandidates(...e)}static getConnectionStatus(e,t){return hs.getConnectionStatus(e,t)}static getDataChannelBuffer(e){return null}static refreshDataChannel(e,t){return Nn.refreshDataChannel(e,t)}static closeDataChannel(e,t){return Nn.closeDataChannel(e,t)}static refreshConnection(e,t,r,n,s){return hs.refreshConnection(e,t,r,n,s)}static refreshPeerConnection(e,t,r,n){return hs.refreshPeerConnection(e,t,r,n)}static buildAndSetPeerInformations(...e){return hs.buildAndSetPeerInformations(...e)}static closePeerConnection(e,t){return hs.closePeerConnection(e,t)}static updatePeerInformationsMediaStatus(e,t,r,n){return hs.updatePeerInformationsMediaStatus(e,t,r,n)}}const Eo=(e,t,r,n=!1)=>{sn.prepStopStreams(e.id,t.id,n,!0).then((()=>zt.log.DEBUG([r,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.STOP_SCREEN_SUCCESS}`]))).catch((e=>zt.log.DEBUG([r,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.ERRORS.STOP_SCREEN}`],e)));},So=(e,t)=>{t.getTracks().forEach((r=>{r.onended=()=>Eo(e.room,t,e.user.sid);}));},po=e=>{const{peerMedias:t,user:r}=e,n={},s=Object.keys(t).filter((e=>e!==r.sid));for(let e=0;e<s.length;e+=1){const r=s[e];Object.values(t[r]).forEach((e=>{e.mediaType===At.VIDEO_SCREEN&&(n[r]=e.streamId);}));}return n},uo=Eo,Ro=(e,t,r,n,s,i)=>{ki.onStreamAccessSuccess(e,t,r,n,s,i);},ho={};class mo{constructor(e){const{room:t}=e;if(ho[t.id])return ho[t.id];this.roomState=e,this.stream=null,this.signaling=new ii,this.streamId=null,this.settings=null,ho[t.id]=this;}streamExists(){const e=ki.getStreams(this.roomState,this.roomState.room.name),t=Object.keys(e.userMedia);for(let e=0;e<t.length;e+=1)if(t[e]===this.streamId)return !0;return !1}async start(e=null,t){this.streamId=e,this.settings=this.isValidOptions(t)?ki.parseStreamSettings(t):ki.parseStreamSettings(Qt.MEDIA_OPTIONS.SCREENSHARE),t&&t.video&&t.video.resolution||(delete this.settings.getUserMediaSettings.video.width,delete this.settings.settings.video.width,delete this.settings.getUserMediaSettings.video.height,delete this.settings.settings.video.height);try{if(this.checkForExistingScreenStreams(),this.stream=await this.startScreenCapture(t),!this.stream)return this.deleteScreensharingInstance(this.roomState.room),null;Ro(this.roomState.room.id,this.stream,null,this.settings,!1,!0),So(this.roomState,this.stream),this.addScreenshareStream();}catch(e){zt.log.ERROR([this.roomState.user.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.START_SCREEN],e);}return this.stream}stop(e=!1){if(!this.stream)return zt.log.DEBUG([this.roomState.user.sid,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.ERRORS.STOP_SCREEN} - ${Ft.MEDIA_STREAM.ERRORS.NO_STREAM}`]),null;try{uo(this.roomState.room,this.stream,this.roomState.user.sid,e),this.streamId=null,this.stream=null;}catch(e){zt.log.ERROR([this.roomState.user.sid,_t.MEDIA_STREAM,null,`${Ft.MEDIA_STREAM.ERRORS.STOP_SCREEN}`],e);}return null}startScreenCapture(){const{navigator:e}=window,t=this.settings.getUserMediaSettings;return e.mediaDevices.getDisplayMedia?e.mediaDevices.getDisplayMedia(t).then((e=>e)).catch((e=>("NotAllowedError"===e.name?zt.log.WARN(e):zt.log.ERROR(e),null))):(t.video.mediaSource="screen",e.mediaDevices.getUserMedia(t).then((e=>e)).catch((e=>(zt.log.ERROR(e),null))))}isValidOptions(e){return !!(e&&Gi(e)&&e.video)||(e&&zt.log.WARN([this.roomState.user.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.INVALID_GDM_OPTIONS],e),!1)}checkForExistingScreenStreams(){const e=po(this.roomState);wi(e)||zt.log.WARN([this.roomState.user.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.PEER_SCREEN_ACTIVE]);}addScreenshareStream(){const{peerConnections:e}=this.roomState;wi(e)||lo.refreshConnection(this.roomState).catch((e=>zt.log.ERROR([this.roomState.user.sid,_t.MEDIA_STREAM,null,Ft.MEDIA_STREAM.ERRORS.START_SCREEN],e)));}deleteScreensharingInstance(e){delete ho[e.id];}}let go=null;class fo{constructor(){return go||(go=this),this.states={},go}setState(e){this.states[e.room.id]=e;}getAllStates(){return this.states}getState(e){return this.states[e]}removeStateByRoomId(e){return delete this.states[e]}clearRoomStateFromSingletons(e){const t=this.getState(e);new mo(t).deleteScreensharingInstance(t.room),Lr.deleteAsyncInstance(t.room),kr.deleteEncryptedInstance(t.room),new rr(null,e).deleteApiResponseInstance(e);}}const To=(e,t,r,n=null,s=null)=>{const i=new Cs;return zt.log.ERROR(t),i.send(e.room.id,r,n,s,t),new Error(t)},_o=(e,t)=>new Promise(((r,n)=>{const{currentRecordingId:s,recordingStartInterval:i,peerConnections:o,hasMCU:a}=e;let c=t?Ft.RECORDING.START_FAILED:Ft.RECORDING.STOP_FAILED;if(!a){c=`${c} - ${Ft.RECORDING.ERRORS.MCU_NOT_CONNECTED}`;const r=t?Ft.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_START:Ft.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_STOP;n(To(e,c,r,null,null));}if(t&&s){return n(To(e,`${c} - ${Ft.RECORDING.ERRORS.EXISTING_RECORDING_IN_PROGRESS}`,Ft.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_START_ACTIVE,s,null))}if(t&&!a&&o[Pt.REC_SRV]){return n(To(e,`${c} - ${Ft.RECORDING.ERRORS.REC_SERVER_UNAVAILABLE}`,Ft.STATS_MODULE.HANDLE_RECORDING_STATS.REC_SERVER_UNAVAILABLE,s||null,null))}if(!t&&!s){return n(To(e,`${c} - ${Ft.RECORDING.ERRORS.NO_RECORDING_IN_PROGRESS}`,Ft.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_STOP_ACTIVE,s,null))}if(!t&&i){return n(To(e,`${c} - ${Ft.RECORDING.ERRORS.MIN_RECORDING_TIME}`,Ft.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_MIN_STOP,s,null))}((e,t)=>{const r=n=>{const s=n.detail,i=t?pt.START:pt.STOP;s.state===i&&(Ht(Gt.RECORDING_STATE,r),e(s.recordingId));};xt(Gt.RECORDING_STATE,r);})(r,t),((e,t,r=null)=>{const n=new ii,s=new Cs;n.recording(e.room.id,t?Rt.START_RECORDING:Rt.STOP_RECORDING),s.send(e.room.id,t?Ft.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_START:Ft.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_STOP,r,null,null);})(e,t,s);}));class Ao{static start(...e){return (e=>_o(e,!0))(...e)}static stop(...e){return (e=>_o(e,!1))(...e)}static getRecordings(e){const{recordings:t}=e;return Object.assign({},t)}}var Io=(e,t,r=null,n=null)=>{const s={shouldProceed:!0,errorMessage:""},{hasMCU:i}=t;return i?e&&!r?(s.errorMessage=Ft.RTMP.start_no_stream_id,s.shouldProceed=!1,s):e&&!n?(s.errorMessage=Ft.RTMP.start_no_endpoint,s.shouldProceed=!1,s):s:(s.errorMessage=e?Ft.RTMP.start_no_mcu:Ft.RTMP.stop_no_mcu,s.shouldProceed=!1,s)},Co=(e,t)=>{const r=n=>{const s=n.detail,i=e?ft.START:ft.STOP;s.state===i&&(Ht(Gt.RTMP_STATE,r),t(s.rtmpId));};xt(Gt.RTMP_STATE,r);},Oo=(e,t,r,n=null,s=null)=>{const{room:i,user:o}=e,a=new ii,c=t?Rt.START_RTMP:Rt.STOP_RTMP;a.rtmp(c,i.id,o.sid,r,n,s);};class No{static startSession(e,t,r){return this.commonRTMPOperations(e,t,null,r,!0,Ft.RTMP.starting_rtmp)}static stopSession(e,t){return this.commonRTMPOperations(e,null,t,null,!1,Ft.RTMP.stopping_rtmp)}static logErrorAndReject(e,t){zt.log.ERROR(e),t(e);}static commonRTMPOperations(e,t,r,n,s,i){return new Promise(((o,a)=>{try{const c=Io(s,e,t,n),d=r||zi();c.shouldProceed?(Co(s,o),Oo(e,s,d,t,n),zt.log.INFO([Pt.MCU,"RTMP",i])):this.logErrorAndReject(new Error(c.errorMessage),a);}catch(e){this.logErrorAndReject(e,a);}}))}}class Do{static sendBlobData(e,t,r=null,n=null){const s=e,{user:i,peerInformations:o,room:a,hasMCU:c}=e,d=`${i.sid}_${(new Date).getTime()}`,l=ko.getInitOptions(),{enableDataChannel:E}=l;if(c)return Promise.reject(new Error(`${Ft.DATA_CHANNEL.UNABLE_TO_SEND_BLOB} - ${Ft.DATA_CHANNEL.ERRORS.MCU_NOT_SUPPORTED}`));let S=Object.keys(o);if(!(t&&Gi(t)&&t instanceof Blob))return Promise.reject(new Error(`${Ft.DATA_CHANNEL.UNABLE_TO_SEND_BLOB} - ${Ft.DATA_CHANNEL.ERRORS.NOT_BLOB}`));if(t.size<1)return Promise.reject(new Error(`${Ft.DATA_CHANNEL.UNABLE_TO_SEND_BLOB} - ${Ft.DATA_CHANNEL.ERRORS.INVALID_DATA}`));if(!E)return Promise.reject(new Error(`${Ft.DATA_CHANNEL.UNABLE_TO_SEND_BLOB} - ${Ft.DATA_CHANNEL.ERRORS.DATA_CHANNEL_DISABLED}`));if(0===S.length)return Promise.reject(new Error(`${Ft.DATA_CHANNEL.UNABLE_TO_SEND_BLOB} - ${Ft.ROOM.ERRORS.NO_PEERS}`));if(Array.isArray(r))S=r;else if(r&&Hi(r))S=[r];else if(r&&Fi(r))n=r;else if(r)return Promise.reject(new Error(`${Ft.DATA_CHANNEL.UNABLE_TO_SEND_BLOB} - ${Ft.DATA_CHANNEL.ERRORS.PEER_ID_INVALID_TYPE}`));if(n&&!Fi(n))return Promise.reject(new Error(`${Ft.DATA_CHANNEL.UNABLE_TO_SEND_BLOB} - ${Ft.DATA_CHANNEL.ERRORS.TIMEOUT_INVALID_TYPE}`));const p={name:t.name||d,size:4*Math.ceil(t.size/3),chunkSize:49152,chunkType:Ve.BINARY_STRING,dataType:$e.BLOB,mimeType:t.type||null,direction:je.UPLOAD,timeout:n||60,isPrivate:!1,percentage:0,originalSize:t.size,cancelled:!1},u=pn.chunkBlobData(t,p.chunkSize);s.dataTransfers[d]=Yt(p),s.dataTransfers[d].sessions={},s.dataTransfers[d].chunks=u,s.dataTransfers[d].enforceBSPeers=[],s.dataTransfers[d].enforcedBSInfo={},s.dataTransfers[d].sessionType=p.dataType,s.dataTransfers[d].sessionChunkType=p.chunkType,s.dataTransfers[d].senderPeerId=i.sid,ko.setSkylinkState(s,a.id);const R=[];return S.forEach((e=>{R.push(this.transferDataToPeer(a.id,e,d,"main").then((e=>e),(e=>e)));})),Promise.all(R)}static acceptDataTransfer(e,t,r,n){return new Promise(((s,i)=>{const{room:o,user:a}=e,c="main";pn.listenOnDataTransferState(o.id,je.DOWNLOAD,t,r,s,i),pn.canDataTransferProceed(o.id,je.DOWNLOAD,t,r,c,n,i)&&(pn.sendACKProtocol(o.id,t,a.sid,Ke.ACCEPT,c),zt.log.DEBUG([t,_t.DATA_CHANNEL,r,`${Ft.DATA_CHANNEL.DATA_TRANSFER_STATE} - ${We.DOWNLOAD_STARTED}`]),Vt(Oe({state:We.DOWNLOAD_STARTED,transferId:r,peerId:t,transferInfo:pn.getTransferInfo(o.id,r,t)})));}))}static cancelBlobTransfer(e,t,r){return new Promise(((n,s)=>{const{room:i,user:o,dataTransfers:a}=e,c="main";pn.canDataTransferProceed(i.id,We.CANCEL,t,r,c,null,s)&&(pn.manageDataTransferTimeout(i.id,r,t,!1),n({peerId:t,transferId:r}),Nn.sendMessageToDataChannel(i.id,t,{type:ut.CANCEL,sender:o.sid,content:Ft.DATA_CHANNEL.ERRORS.REMOTE_CANCELLED_TRANSFER,name:a[r].name,ackN:Ke.CANCEL},c,He.PROTOCOL),Vt(Oe({state:We.CANCEL,transferId:r,peerId:t,transferInfo:pn.getTransferInfo(i.id,r,t),error:{message:Ft.DATA_CHANNEL.ERRORS.USER_CANCELLED_TRANSFER,transferType:a[r].direction}})));}))}static transferDataToPeer(e,t,r,n){return new Promise(((s,i)=>{const o=ko.getSkylinkState(e);if(pn.canDataTransferProceed(e,je.UPLOAD,t,r,n,null,i))return o.dataTransfers[r].sessions[t]={timer:null,ackN:0},o.peerDataChannels[t].main.transferId=r,ko.setSkylinkState(o,o.room.id),pn.sendWRQMessage(o.room.id,r,t,n),pn.listenOnDataTransferState(e,je.UPLOAD,t,r,s,i)}))}}window.AdapterJS=le,window.io=io;const vo=new fo;let yo={},Po={};const Mo=Gt;class ko extends class{async joinRoom(e={},t){return Ri.joinRoom(e,t)}sendP2PMessage(e="",t="",r=""){lo.sendP2PMessage(e,t,r);}sendMessage(e="",t="",r="",n=""){Gr.sendMessage(e,t,r,n);}getStoredMessages(e,t=""){const r=Wi(e);r&&new Lr(r).getStoredMessages(t);}getPeersInRoom(e){return Vi(e,"roomName","getPeersInRoom")?lo.getPeersInRoom(e):null}getPeerInfo(e,t=null){const r=Wi(e);return t&&r?fi.getPeerInfo(t,r.room):!t&&r?fi.getCurrentSessionInfo(r.room):null}getUserData(e,t){const r=Wi(e);return r&&r.room?fi.getUserData(r,t):null}setUserData(e,t){const r=Wi(e);return r&&r.room?fi.setUserData(r.room,t):null}getConnectionStatus(e,t){const r=Wi(e);return lo.getConnectionStatus(r,t)}getPeers(e,t=!1){const r=Wi(e);return r?class{static shouldProceed(e,t,r){let n=null;return e.isPrivileged||(n=Ft.PEER_PRIVILEGED.not_privileged),t||(n=Ft.PEER_PRIVILEGED.no_appkey),n&&(zt.log.DEBUG(n),r(new Error(n))),!n}static getPeerList(e,t){return new Promise(((r,n)=>{try{const s=ko.getSkylinkState(e.id),i=ko.getInitOptions(),o=t||!1,a=e=>{const t=e.detail;t.state===nt.DISPATCHED&&(Ht(Gt.GET_PEERS_STATE_CHANGE,a),Vt(we({state:nt.RECEIVED,privilegePeerId:s.user.sid,peerList:t.peerList})),r(t.peerList));};this.shouldProceed(s,i.appKey,n)&&((new ii).getPeerList(s,o),Vt(we({state:nt.ENQUIRED,privilegePeerId:s.user.sid,peerList:null})),zt.log.INFO(Ft.PEER_PRIVILEGED.getPeerListFromServer),xt(Gt.GET_PEERS_STATE_CHANGE,a));}catch(e){zt.log.ERROR(e),n(e);}}))}}.getPeerList(r.room,t):null}getPeersDataChannels(e){const t=Wi(e);return t?fi.getPeersDataChannels(t):null}getPeersCustomSettings(e){const t=Wi(e);return t?fi.getPeersCustomSettings(t):null}refreshDatachannel(e,t){const r=Wi(e);return r?lo.refreshDataChannel(r,t):null}refreshConnection(e,t,r,n){const s=Wi(e);return lo.refreshConnection(s,t,r,n)}shareScreen(e,t){const r=Wi(e);if(r){return new mo(r).start(null,t)}return null}getUserMedia(e=null,t){if(!e)return Yi(t);if(Hi(e)){const r=Wi(e);if(r)return on.processUserMediaOptions(r,t)}else if(Gi(e))return Yi(e)}stopPrefetchedStream(e){if(e){const t=e.getAudioTracks().length>0,r=e.getVideoTracks().length>0;e.getTracks().forEach((e=>{e.stop();})),Vt(Re({room:null,peerId:null,peerInfo:null,isSelf:!0,isAudio:t,isVideo:r,streamId:e.id}));}return null}stopScreen(e){const t=Wi(e);if(t){new mo(t).stop();}return null}stopStreams(e,t){const r=Wi(e);return r?on.stopStreams(r,t):null}leaveRoom(e,t=!0){const r=Wi(e);return r?Ri.leaveRoom(r,t):null}leaveAllRooms(e=!0){return Ri.leaveAllRooms(e)}startRecording(e){const t=Wi(e);return t?Ao.start(t):null}stopRecording(e){const t=Wi(e);return t?Ao.stop(t):null}lockRoom(e){const t=Wi(e);return t?Ri.lockRoom(t):null}unlockRoom(e){const t=Wi(e);return t?Ri.unlockRoom(t):null}getRecordings(e){const t=Wi(e);return t?Ao.getRecordings(t):null}muteStreams(e,t={audioMuted:!0,videoMuted:!0},r){const n=Wi(e);return n?on.muteStreams(n,t,r):null}startRTMPSession(e,t,r){const n=Wi(e);return n?No.startSession(n,t,r):null}stopRTMPSession(e,t){const r=Wi(e);return r?No.stopSession(r,t):null}getStreamSources(){return on.getStreamSources()}sendStream(e,t){const r=Wi(e);return on.sendStream(r,t)}getStreams(e,t=!0){const r=Wi(e);return r?on.getStreams(r,t):null}generateUUID(){return zi()}setEncryptSecret(e="",t="",r=""){const n=Wi(e);return new kr(n).setEncryptSecret(t,r)}getEncryptSecrets(e=""){const t=Wi(e);return new kr(t).getEncryptSecrets()}deleteEncryptSecrets(e="",t=""){const r=Wi(e);return new kr(r).deleteEncryptSecrets(t)}setSelectedSecret(e="",t=""){const r=Wi(e);new kr(r).setSelectedSecretId(t);}getSelectedSecret(e,t){const r=Wi(e);return new kr(r).getSelectedSecretId(t)}setMessagePersistence(e,t){const r=Wi(e);return new Lr(r).setMessagePersistence(t)}getMessagePersistence(e){const t=Wi(e);return new Lr(t).getMessagePersistence()}getSdkVersion(){return Dt}sendBlobData(e,t,r,n){const s=Wi(e);return Do.sendBlobData(s,t,r,n)}respondBlobRequest(e,t,r,n){const s=Wi(e);return Do.acceptDataTransfer(s,t,r,n)}cancelBlobTransfer(e,t,r){const n=Wi(e);return Do.cancelBlobTransfer(n,t,r)}}{constructor(e){super();const t=(new Sr).init(e);ko.setInitOptions(t);}static getSkylinkState(e=null){return e?vo.getState(e):vo.getAllStates()}static setSkylinkState(e,t){t&&vo.setState(e);}static removeSkylinkState(e){if(e)return vo.removeStateByRoomId(e)}static clearRoomStateFromSingletons(e){if(e)return vo.clearRoomStateFromSingletons(e)}static getInitOptions(){return yo}static setInitOptions(e){yo=e;}static setUserInitOptions(e){Po=e;}static getUserInitOptions(){return Po}}

export { Ut as SkylinkConstants, Bt as SkylinkEventManager, Mo as SkylinkEvents, zt as SkylinkLogger, ko as default };
