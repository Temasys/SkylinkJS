(function (factory) {
  typeof define === 'function' && define.amd ? define(factory) :
  factory();
}(function () { 'use strict';

  !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Skylink={});}(undefined,(function(e){let t=!0,r=!0;function n(e,t,r){const n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function s(e,t,r){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,s=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return s.apply(this,arguments);const i=e=>{const t=r(e);t&&n(t);};return this._eventMap=this._eventMap||{},this._eventMap[n]=i,s.apply(this,[e,i])};const i=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return i.apply(this,arguments);const n=this._eventMap[r];return delete this._eventMap[r],i.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e);},enumerable:!0,configurable:!0});}function i(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(t=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function o(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(r=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function a(){if("object"==typeof window){if(t)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments);}}function c(e,t){r&&console.warn(e+" is deprecated, please use "+t+" instead.");}function d(e){const{navigator:t}=e,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=n(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)r.browser="chrome",r.version=n(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=n(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=n(t.userAgent,/AppleWebKit\/(\d+)\./,1),r.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype;}return r}function l(e){return "[object Object]"===Object.prototype.toString.call(e)}function u(e){return l(e)?Object.keys(e).reduce((function(t,r){const n=l(e[r]),s=n?u(e[r]):e[r],i=n&&!Object.keys(s).length;return void 0===s||i?t:Object.assign(t,{[r]:s})}),{}):e}function p(e,t,r){const n=r?"outbound-rtp":"inbound-rtp",s=new Map;if(null===t)return s;const i=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&i.push(e);}),i.forEach(t=>{e.forEach(r=>{r.type===n&&r.trackId===t.id&&function e(t,r,n){r&&!n.has(r.id)&&(n.set(r.id,r),Object.keys(r).forEach(s=>{s.endsWith("Id")?e(t,t.get(r[s]),n):s.endsWith("Ids")&&r[s].forEach(r=>{e(t,t.get(r),n);});}));}(e,r,s);});}),s}const S=a;function E(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const r=d(e),n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;const n="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const s=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[s("min",r)]=n.ideal,t.optional.push(e),e={},e[s("max",r)]=n.ideal,t.optional.push(e)):(e[s("",r)]=n.ideal,t.optional.push(e));}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[s("",r)]=n.exact):["min","max"].forEach(e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[s(e,r)]=n[e]);});}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,s){if(r.version>=61)return s(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t]);};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio);}if(e&&"object"==typeof e.video){let i=e.video.facingMode;i=i&&("object"==typeof i?i:{ideal:i});const o=r.version<66;if(i&&("user"===i.exact||"environment"===i.exact||"user"===i.ideal||"environment"===i.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||o)){let r;if(delete e.video.facingMode,"environment"===i.exact||"environment"===i.ideal?r=["back","rear"]:"user"!==i.exact&&"user"!==i.ideal||(r=["front"]),r)return t.mediaDevices.enumerateDevices().then(t=>{let o=(t=t.filter(e=>"videoinput"===e.kind)).find(e=>r.some(t=>e.label.toLowerCase().includes(t)));return !o&&t.length&&r.includes("back")&&(o=t[t.length-1]),o&&(e.video.deviceId=i.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=n(e.video),S("chrome: "+JSON.stringify(e)),s(e)})}e.video=n(e.video);}return S("chrome: "+JSON.stringify(e)),s(e)},i=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,n){s(e,e=>{t.webkitGetUserMedia(e,r,e=>{n&&n(i(e));});});}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return s(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop();}),new DOMException("","NotFoundError");return e},e=>Promise.reject(i(e))))};}}function h(e){e.MediaStream=e.MediaStream||e.webkitMediaStream;}function m(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e);},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===r.track.id):{track:r.track};const s=new Event("track");s.track=r.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s);}),t.stream.getTracks().forEach(r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===r.id):{track:r};const s=new Event("track");s.track=r,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s);});},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)};}else s(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e));}function g(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return {track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let s=r.apply(this,arguments);return s||(s=t(this,e),this._senders.push(s)),s};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1);};}const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e));});};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1);});};}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}});}}function R(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const s=function(e){const t={};return e.result().forEach(e=>{const r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{r[t]=e.stat(t);}),t[r.id]=r;}),t},i=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};if(arguments.length>=2){const n=function(e){r(i(s(e)));};return t.apply(this,[n,e])}return new Promise((e,r)=>{t.apply(this,[function(t){e(i(s(t)));},r]);}).then(r,n)};}function f(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>p(t,e.track,!0))};}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),s(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>p(t,e.track,!1))};}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,r,n;return this.getSenders().forEach(r=>{r.track===e&&(t?n=!0:t=r);}),this.getReceivers().forEach(t=>(t.track===e&&(r?n=!0:r=t),t.track===e)),n||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)};}function T(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();r.apply(this,arguments);const n=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(n);};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const r=this._shimmedLocalStreams[t].indexOf(e);-1!==r&&this._shimmedLocalStreams[t].splice(r,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t];}),s.apply(this,arguments)};}function _(e){if(!e.RTCPeerConnection)return;const t=d(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return T(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const r=new e.MediaStream(t.getTracks());this._streams[t.id]=r,this._reverseStreams[r.id]=t,t=r;}n.apply(this,[t]);};const s=e.RTCPeerConnection.prototype.removeStream;function i(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],s=e._streams[n.id];r=r.replace(new RegExp(s.id,"g"),n.id);}),new RTCSessionDescription({type:t.type,sdp:r})}function o(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],s=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),s.id);}),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id];},e.RTCPeerConnection.prototype.addTrack=function(t,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const s=this.getSenders().find(e=>e.track===t);if(s)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const i=this._streams[r.id];if(i)i.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"));});else{const n=new e.MediaStream([t]);this._streams[r.id]=n,this._reverseStreams[n.id]=r,this.addStream(n);}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[t=>{const r=i(this,t);e[0].apply(null,[r]);},t=>{e[1]&&e[1].apply(null,t);},arguments[2]]):r.apply(this,arguments).then(e=>i(this,e))}};e.RTCPeerConnection.prototype[t]=n[t];}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=o(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return ""===e.type?e:i(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(r=>{this._streams[r].getTracks().find(t=>e.track===t)&&(t=this._streams[r]);}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")));};}function I(e){const t=d(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const r=0===e.RTCPeerConnection.prototype.addIceCandidate.length;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t];}));const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return r||arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};}function C(e){s(e,"negotiationneeded",e=>{if("stable"===e.target.signalingState)return e});}var O=Object.freeze({shimMediaStream:h,shimOnTrack:m,shimGetSendersWithDtmf:g,shimGetStats:R,shimSenderReceiverGetStats:f,shimAddTrackRemoveTrackWithNative:T,shimAddTrackRemoveTrack:_,shimPeerConnection:I,fixNegotiationNeeded:C,shimGetUserMedia:E,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then(t=>{const n=r.video&&r.video.width,s=r.video&&r.video.height,i=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:i||3}},n&&(r.video.mandatory.maxWidth=n),s&&(r.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(r)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"));}});function A(e,t){return e(t={exports:{}},t.exports),t.exports}var v=A((function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return (t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){var r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter((function(e){return 0===e.indexOf(r)}))},t.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1];}return r},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return "a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return {id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return "a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),s=0;s<n.length;s++)r[(t=n[s].trim().split("="))[0].trim()]=t[1];return r},t.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t);})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n";}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return {type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n";})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return {semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return {algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,r){return {role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n";})),r},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return {tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return "a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return {keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,r){return t.matchPrefix(e+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,r){var n=t.matchPrefix(e+r,"a=ice-ufrag:")[0],s=t.matchPrefix(e+r,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substr(12),password:s.substr(10)}:null},t.writeIceParameters=function(e){return "a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" "),s=3;s<n.length;s++){var i=n[s],o=t.matchPrefix(e,"a=rtpmap:"+i+" ")[0];if(o){var a=t.parseRtpMap(o),c=t.matchPrefix(e,"a=fmtp:"+i+" ");switch(a.parameters=c.length?t.parseFmtp(c[0]):{},a.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+i+" ").map(t.parseRtcpFb),r.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(a.name.toUpperCase());}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){r.headerExtensions.push(t.parseExtmap(e));})),r},t.writeRtpDescription=function(e,r){var n="";n+="m="+e+" ",n+=r.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=r.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach((function(e){n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e);}));var s=0;return r.codecs.forEach((function(e){e.maxptime>s&&(s=e.maxptime);})),s>0&&(n+="a=maxptime:"+s+"\r\n"),n+="a=rtcp-mux\r\n",r.headerExtensions&&r.headerExtensions.forEach((function(e){n+=t.writeExtmap(e);})),n},t.parseRtpEncodingParameters=function(e){var r,n=[],s=t.parseRtpParameters(e),i=-1!==s.fecMechanisms.indexOf("RED"),o=-1!==s.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "cname"===e.attribute})),c=a.length>0&&a[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(r=d[0][1]),s.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&r&&(t.rtx={ssrc:r}),n.push(t),i&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},n.push(t));}})),0===n.length&&c&&n.push({ssrc:c});var l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,n.forEach((function(e){e.maxBitrate=l;}))),n},t.parseRtcpParameters=function(e){var r={},n=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "cname"===e.attribute}))[0];n&&(r.cname=n.value,r.ssrc=n.ssrc);var s=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=s.length>0,r.compound=0===s.length;var i=t.matchPrefix(e,"a=rtcp-mux");return r.mux=i.length>0,r},t.parseMsid=function(e){var r,n=t.matchPrefix(e,"a=msid:");if(1===n.length)return {stream:(r=n[0].substr(7).split(" "))[0],track:r[1]};var s=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "msid"===e.attribute}));return s.length>0?{stream:(r=s[0].value.split(" "))[0],track:r[1]}:void 0},t.parseSctpDescription=function(e){var r,n=t.parseMLine(e),s=t.matchPrefix(e,"a=max-message-size:");s.length>0&&(r=parseInt(s[0].substr(19),10)),isNaN(r)&&(r=65536);var i=t.matchPrefix(e,"a=sctp-port:");if(i.length>0)return {port:parseInt(i[0].substr(12),10),protocol:n.fmt,maxMessageSize:r};if(t.matchPrefix(e,"a=sctpmap:").length>0){var o=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return {port:parseInt(o[0],10),protocol:o[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,r,n){var s=void 0!==r?r:2;return "v=0\r\no="+(n||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,r,n,s){var i=t.writeRtpDescription(e.kind,r);if(i+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),i+="a=mid:"+e.mid+"\r\n",e.direction?i+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?i+="a=sendrecv\r\n":e.rtpSender?i+="a=sendonly\r\n":e.rtpReceiver?i+="a=recvonly\r\n":i+="a=inactive\r\n",e.rtpSender){var o="msid:"+s.id+" "+e.rtpSender.track.id+"\r\n";i+="a="+o,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n");}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),i},t.getDirection=function(e,r){for(var n=t.splitLines(e),s=0;s<n.length;s++)switch(n[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[s].substr(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return "0"===e.split(" ",2)[1]},t.parseMLine=function(e){var r=t.splitLines(e)[0].substr(2).split(" ");return {kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){var r=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return {username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return !1;for(var r=t.splitLines(e),n=0;n<r.length;n++)if(r[n].length<2||"="!==r[n].charAt(1))return !1;return !0},e.exports=t;}));function N(e,t,r,n,s){var i=v.writeRtpDescription(e.kind,t);if(i+=v.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=v.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":s||"active"),i+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?i+="a=sendrecv\r\n":e.rtpSender?i+="a=sendonly\r\n":e.rtpReceiver?i+="a=recvonly\r\n":i+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var a="msid:"+(n?n.id:"-")+" "+o+"\r\n";i+="a="+a,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n");}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+v.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+v.localCName+"\r\n"),i}function D(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},s=function(e,t,r,s){var i=n(e.parameters.apt,r),o=n(t.parameters.apt,s);return i&&o&&i.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach((function(n){for(var i=0;i<t.codecs.length;i++){var o=t.codecs[i];if(n.name.toLowerCase()===o.name.toLowerCase()&&n.clockRate===o.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&o.parameters.apt&&!s(n,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(n.numChannels,o.numChannels),r.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return !0;return !1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var s=t.headerExtensions[n];if(e.uri===s.uri){r.headerExtensions.push(s);break}}})),r}function y(e,t,r){return -1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function P(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function M(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}var k=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}));}function n(t,r,n,s){var i=new Event("track");i.track=r,i.receiver=n,i.transceiver={receiver:n},i.streams=s,e.setTimeout((function(){t._dispatchEvent("track",i);}));}var s=function(r){var n=this,s=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){n[e]=s[e].bind(s);})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw M("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all";}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced";}if(r.iceServers=function(e,t){var r=!1;return (e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var s="string"==typeof n;return s&&(n=[n]),n=n.filter((function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!r?(r=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")})),delete e.url,e.urls=s?n[0]:n,!!n.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var i=r.iceCandidatePoolSize;i>0;i--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=v.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1;};Object.defineProperty(s.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(s.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),s.prototype.onicecandidate=null,s.prototype.onaddstream=null,s.prototype.ontrack=null,s.prototype.onremovestream=null,s.prototype.onsignalingstatechange=null,s.prototype.oniceconnectionstatechange=null,s.prototype.onconnectionstatechange=null,s.prototype.onicegatheringstatechange=null,s.prototype.onnegotiationneeded=null,s.prototype.ondatachannel=null,s.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t));},s.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e);},s.prototype.getConfiguration=function(){return this._config},s.prototype.getLocalStreams=function(){return this.localStreams},s.prototype.getRemoteStreams=function(){return this.remoteStreams},s.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var s=this._createIceAndDtlsTransports();n.iceTransport=s.iceTransport,n.dtlsTransport=s.dtlsTransport;}return t||this.transceivers.push(n),n},s.prototype.addTrack=function(t,r){if(this._isClosed)throw M("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw M("InvalidAccessError","Track already exists.");for(var s=0;s<this.transceivers.length;s++)this.transceivers[s].track||this.transceivers[s].kind!==t.kind||(n=this.transceivers[s]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),n.track=t,n.stream=r,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},s.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e);}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled;}));})),n.getTracks().forEach((function(e){r.addTrack(e,n);}));}},s.prototype.removeTrack=function(t){if(this._isClosed)throw M("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw M("InvalidAccessError","Sender was not created by this connection.");var n=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded();},s.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r);}));},s.prototype.getSenders=function(){return this.transceivers.filter((function(e){return !!e.rtpSender})).map((function(e){return e.rtpSender}))},s.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return !!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},s.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var s=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(s,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;s.state=r?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e);},s.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),s},s.prototype._gather=function(t,r){var n=this,s=this.transceivers[r].iceGatherer;if(!s.onlocalcandidate){var i=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,s.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),s.onlocalcandidate=function(e){if(!(n.usingBundle&&r>0)){var i=new Event("icecandidate");i.candidate={sdpMid:t,sdpMLineIndex:r};var o=e.candidate,a=!o||0===Object.keys(o).length;if(a)"new"!==s.state&&"gathering"!==s.state||(s.state="completed");else{"new"===s.state&&(s.state="gathering"),o.component=1,o.ufrag=s.getLocalParameters().usernameFragment;var c=v.writeCandidate(o);i.candidate=Object.assign(i.candidate,v.parseCandidate(c)),i.candidate.candidate=c,i.candidate.toJSON=function(){return {candidate:i.candidate.candidate,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex,usernameFragment:i.candidate.usernameFragment}};}var d=v.getMediaSections(n._localDescription.sdp);d[i.candidate.sdpMLineIndex]+=a?"a=end-of-candidates\r\n":"a="+i.candidate.candidate+"\r\n",n._localDescription.sdp=v.getDescription(n._localDescription.sdp)+d.join("");var l=n.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),a||n._dispatchEvent("icecandidate",i),l&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange());}},e.setTimeout((function(){i.forEach((function(e){s.onlocalcandidate(e);}));}),0);}},s.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState();};var n=new e.RTCDtlsTransport(r);return n.ondtlsstatechange=function(){t._updateConnectionState();},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState();},{iceTransport:r,dtlsTransport:n}},s.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport);},s.prototype._transceive=function(e,r,n){var s=D(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:v.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),n&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx;})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s));},s.prototype.setLocalDescription=function(e){var t,r,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(M("TypeError",'Unsupported type "'+e.type+'"'));if(!y("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(M("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=v.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=v.parseRtpParameters(e);n.transceivers[t].localCapabilities=r;})),n.transceivers.forEach((function(e,t){n._gather(e.mid,t);}));else if("answer"===e.type){t=v.splitSections(n._remoteDescription.sdp),r=t.shift();var s=v.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var i=n.transceivers[t],o=i.iceGatherer,a=i.iceTransport,c=i.dtlsTransport,d=i.localCapabilities,l=i.remoteCapabilities;if(!(v.isRejected(e)&&0===v.matchPrefix(e,"a=bundle-only").length)&&!i.rejected){var u=v.getIceParameters(e,r),p=v.getDtlsParameters(e,r);s&&(p.role="server"),n.usingBundle&&0!==t||(n._gather(i.mid,t),"new"===a.state&&a.start(o,u,s?"controlling":"controlled"),"new"===c.state&&c.start(p));var S=D(d,l);n._transceive(i,S.codecs.length>0,!1);}}));}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()},s.prototype.setRemoteDescription=function(s){var i=this;if(-1===["offer","answer"].indexOf(s.type))return Promise.reject(M("TypeError",'Unsupported type "'+s.type+'"'));if(!y("setRemoteDescription",s.type,i.signalingState)||i._isClosed)return Promise.reject(M("InvalidStateError","Can not set remote "+s.type+" in state "+i.signalingState));var o={};i.remoteStreams.forEach((function(e){o[e.id]=e;}));var a=[],c=v.splitSections(s.sdp),d=c.shift(),l=v.matchPrefix(d,"a=ice-lite").length>0,u=v.matchPrefix(d,"a=group:BUNDLE ").length>0;i.usingBundle=u;var p=v.matchPrefix(d,"a=ice-options:")[0];return i.canTrickleIceCandidates=!!p&&p.substr(14).split(" ").indexOf("trickle")>=0,c.forEach((function(n,c){var p=v.splitLines(n),S=v.getKind(n),E=v.isRejected(n)&&0===v.matchPrefix(n,"a=bundle-only").length,h=p[0].substr(2).split(" ")[2],m=v.getDirection(n,d),g=v.parseMsid(n),R=v.getMid(n)||v.generateIdentifier();if(E||"application"===S&&("DTLS/SCTP"===h||"UDP/DTLS/SCTP"===h))i.transceivers[c]={mid:R,kind:S,protocol:h,rejected:!0};else{var f,T,_,I,C,O,A,N,y;!E&&i.transceivers[c]&&i.transceivers[c].rejected&&(i.transceivers[c]=i._createTransceiver(S,!0));var M,k,w=v.parseRtpParameters(n);E||(M=v.getIceParameters(n,d),(k=v.getDtlsParameters(n,d)).role="client"),A=v.parseRtpEncodingParameters(n);var b=v.parseRtcpParameters(n),L=v.matchPrefix(n,"a=end-of-candidates",d).length>0,G=v.matchPrefix(n,"a=candidate:").map((function(e){return v.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===s.type||"answer"===s.type)&&!E&&u&&c>0&&i.transceivers[c]&&(i._disposeIceAndDtlsTransports(c),i.transceivers[c].iceGatherer=i.transceivers[0].iceGatherer,i.transceivers[c].iceTransport=i.transceivers[0].iceTransport,i.transceivers[c].dtlsTransport=i.transceivers[0].dtlsTransport,i.transceivers[c].rtpSender&&i.transceivers[c].rtpSender.setTransport(i.transceivers[0].dtlsTransport),i.transceivers[c].rtpReceiver&&i.transceivers[c].rtpReceiver.setTransport(i.transceivers[0].dtlsTransport)),"offer"!==s.type||E){if("answer"===s.type&&!E){T=(f=i.transceivers[c]).iceGatherer,_=f.iceTransport,I=f.dtlsTransport,C=f.rtpReceiver,O=f.sendEncodingParameters,N=f.localCapabilities,i.transceivers[c].recvEncodingParameters=A,i.transceivers[c].remoteCapabilities=w,i.transceivers[c].rtcpParameters=b,G.length&&"new"===_.state&&(!l&&!L||u&&0!==c?G.forEach((function(e){P(f.iceTransport,e);})):_.setRemoteCandidates(G)),u&&0!==c||("new"===_.state&&_.start(T,M,"controlling"),"new"===I.state&&I.start(k)),!D(f.localCapabilities,f.remoteCapabilities).codecs.filter((function(e){return "rtx"===e.name.toLowerCase()})).length&&f.sendEncodingParameters[0].rtx&&delete f.sendEncodingParameters[0].rtx,i._transceive(f,"sendrecv"===m||"recvonly"===m,"sendrecv"===m||"sendonly"===m),!C||"sendrecv"!==m&&"sendonly"!==m?delete f.rtpReceiver:(y=C.track,g?(o[g.stream]||(o[g.stream]=new e.MediaStream),r(y,o[g.stream]),a.push([y,C,o[g.stream]])):(o.default||(o.default=new e.MediaStream),r(y,o.default),a.push([y,C,o.default])));}}else{(f=i.transceivers[c]||i._createTransceiver(S)).mid=R,f.iceGatherer||(f.iceGatherer=i._createIceGatherer(c,u)),G.length&&"new"===f.iceTransport.state&&(!L||u&&0!==c?G.forEach((function(e){P(f.iceTransport,e);})):f.iceTransport.setRemoteCandidates(G)),N=e.RTCRtpReceiver.getCapabilities(S),t<15019&&(N.codecs=N.codecs.filter((function(e){return "rtx"!==e.name}))),O=f.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var U,F=!1;if("sendrecv"===m||"sendonly"===m){if(F=!f.rtpReceiver,C=f.rtpReceiver||new e.RTCRtpReceiver(f.dtlsTransport,S),F)y=C.track,g&&"-"===g.stream||(g?(o[g.stream]||(o[g.stream]=new e.MediaStream,Object.defineProperty(o[g.stream],"id",{get:function(){return g.stream}})),Object.defineProperty(y,"id",{get:function(){return g.track}}),U=o[g.stream]):(o.default||(o.default=new e.MediaStream),U=o.default)),U&&(r(y,U),f.associatedRemoteMediaStreams.push(U)),a.push([y,C,U]);}else f.rtpReceiver&&f.rtpReceiver.track&&(f.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===f.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}));}(r,t);})),f.associatedRemoteMediaStreams=[]);f.localCapabilities=N,f.remoteCapabilities=w,f.rtpReceiver=C,f.rtcpParameters=b,f.sendEncodingParameters=O,f.recvEncodingParameters=A,i._transceive(i.transceivers[c],!1,F);}}})),void 0===i._dtlsRole&&(i._dtlsRole="offer"===s.type?"active":"passive"),i._remoteDescription={type:s.type,sdp:s.sdp},"offer"===s.type?i._updateSignalingState("have-remote-offer"):i._updateSignalingState("stable"),Object.keys(o).forEach((function(t){var r=o[t];if(r.getTracks().length){if(-1===i.remoteStreams.indexOf(r)){i.remoteStreams.push(r);var s=new Event("addstream");s.stream=r,e.setTimeout((function(){i._dispatchEvent("addstream",s);}));}a.forEach((function(e){var t=e[0],s=e[1];r.id===e[2].id&&n(i,t,s,[r]);}));}})),a.forEach((function(e){e[2]||n(i,e[0],e[1],[]);})),e.setTimeout((function(){i&&i.transceivers&&i.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}));}));}),4e3),Promise.resolve()},s.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop();})),this._isClosed=!0,this._updateSignalingState("closed");},s.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t);},s.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e);}}),0));},s.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++;})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r);}},s.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++);})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r);}},s.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(M("InvalidStateError","Can not call createOffer after close"));var n=r.transceivers.filter((function(e){return "audio"===e.kind})).length,s=r.transceivers.filter((function(e){return "video"===e.kind})).length,i=arguments[0];if(i){if(i.mandatory||i.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==i.offerToReceiveAudio&&(n=!0===i.offerToReceiveAudio?1:!1===i.offerToReceiveAudio?0:i.offerToReceiveAudio),void 0!==i.offerToReceiveVideo&&(s=!0===i.offerToReceiveVideo?1:!1===i.offerToReceiveVideo?0:i.offerToReceiveVideo);}for(r.transceivers.forEach((function(e){"audio"===e.kind?--n<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1);}));n>0||s>0;)n>0&&(r._createTransceiver("audio"),n--),s>0&&(r._createTransceiver("video"),s--);var o=v.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(n,s){var i=n.track,o=n.kind,a=n.mid||v.generateIdentifier();n.mid=a,n.iceGatherer||(n.iceGatherer=r._createIceGatherer(s,r.usingBundle));var c=e.RTCRtpSender.getCapabilities(o);t<15019&&(c.codecs=c.codecs.filter((function(e){return "rtx"!==e.name}))),c.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType);}));})),c.headerExtensions.forEach((function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id);}));}));var d=n.sendEncodingParameters||[{ssrc:1001*(2*s+1)}];i&&t>=15019&&"video"===o&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,o)),n.localCapabilities=c,n.sendEncodingParameters=d;})),"max-compat"!==r._config.bundlePolicy&&(o+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){o+=N(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),o+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,o+="a="+v.writeCandidate(e)+"\r\n";})),"completed"===e.iceGatherer.state&&(o+="a=end-of-candidates\r\n"));}));var a=new e.RTCSessionDescription({type:"offer",sdp:o});return Promise.resolve(a)},s.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(M("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(M("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var n=v.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(n+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),n+="a=ice-options:trickle\r\n";var s=v.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,i){if(!(i+1>s)){if(e.rejected)return "application"===e.kind?"DTLS/SCTP"===e.protocol?n+="m=application 0 DTLS/SCTP 5000\r\n":n+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?n+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(n+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(n+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var o;if(e.stream)"audio"===e.kind?o=e.stream.getAudioTracks()[0]:"video"===e.kind&&(o=e.stream.getVideoTracks()[0]),o&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var a=D(e.localCapabilities,e.remoteCapabilities);!a.codecs.filter((function(e){return "rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,n+=N(e,a,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(n+="a=rtcp-rsize\r\n");}}));var i=new e.RTCSessionDescription({type:"answer",sdp:n});return Promise.resolve(i)},s.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(n,s){if(!r._remoteDescription)return s(M("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var i=e.sdpMLineIndex;if(e.sdpMid)for(var o=0;o<r.transceivers.length;o++)if(r.transceivers[o].mid===e.sdpMid){i=o;break}var a=r.transceivers[i];if(!a)return s(M("OperationError","Can not add ICE candidate"));if(a.rejected)return n();var c=Object.keys(e.candidate).length>0?v.parseCandidate(e.candidate):{};if("tcp"===c.protocol&&(0===c.port||9===c.port))return n();if(c.component&&1!==c.component)return n();if((0===i||i>0&&a.iceTransport!==r.transceivers[0].iceTransport)&&!P(a.iceTransport,c))return s(M("OperationError","Can not add ICE candidate"));var d=e.candidate.trim();0===d.indexOf("a=")&&(d=d.substr(2)),(t=v.getMediaSections(r._remoteDescription.sdp))[i]+="a="+(c.type?d:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=v.getDescription(r._remoteDescription.sdp)+t.join("");}else for(var l=0;l<r.transceivers.length&&(r.transceivers[l].rejected||(r.transceivers[l].iceTransport.addRemoteCandidate({}),(t=v.getMediaSections(r._remoteDescription.sdp))[l]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=v.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));l++);n();}))},s.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver);})),!r)throw M("InvalidAccessError","Invalid selector.");return r.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats());}));})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e);}));})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var n;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[r]).type]||n.type,t.set(r,e[r]);})),t}))};}}));var i=["createOffer","createAnswer"];return i.forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t]);}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t]);})):t.apply(this,arguments)};})),(i=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null);}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t]);})):t.apply(this,arguments)};})),["getStats"].forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null);})):t.apply(this,arguments)};})),s};function w(e){const t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch(e=>Promise.reject(function(e){return {name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))};}function b(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)));}function L(e){const t=d(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const r=new Event("enabled");r.enabled=e,this.dispatchEvent(r);}});}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const r=k(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let r=!1;return (e=JSON.parse(JSON.stringify(e))).filter(e=>{if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&c("RTCIceServer.url","RTCIceServer.urls");const n="string"==typeof t;return n&&(t=[t]),t=t.filter(e=>{if(0===e.indexOf("stun:"))return !1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r}),delete e.url,e.urls=n?t[0]:t,!!t.length}})}(e.iceServers,t.version),a("ICE servers after filtering:",e.iceServers)),new r(e)},e.RTCPeerConnection.prototype=r.prototype;}function G(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack);}var U=Object.freeze({shimPeerConnection:L,shimReplaceTrack:G,shimGetUserMedia:w,shimGetDisplayMedia:b});function F(e){const t=d(e),r=e&&e.navigator,n=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){c("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n);},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t]);},t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return "object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),e(r.audio,"autoGainControl","mozAutoGainControl"),e(r.audio,"noiseSuppression","mozNoiseSuppression")),t(r)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const r=t.apply(this,arguments);return e(r,"mozAutoGainControl","autoGainControl"),e(r,"mozNoiseSuppression","noiseSuppression"),r};}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(r){return "audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),e(r,"autoGainControl","mozAutoGainControl"),e(r,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[r])};}}}function B(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function x(e){const t=d(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t];})),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};}const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,s,i]=arguments;return n.apply(this,[e||null]).then(e=>{if(t.version<53&&!s)try{e.forEach(e=>{e.type=r[e.type]||e.type;});}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,n)=>{e.set(n,Object.assign({},t,{type:r[t.type]||t.type}));});}return e}).then(s,i)};}function V(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)};}function H(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),s(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)};}function j(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){c("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t);});});}function W(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel);}function K(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach(e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const n=t.apply(this,arguments);if(r){const{sender:t}=n,r=t.getParameters();"encodings"in r||(r.encodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(r).catch(()=>{})));}return n});}function $(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[];}):t.apply(this,arguments)};}function Y(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[];}):t.apply(this,arguments)};}var z=Object.freeze({shimOnTrack:B,shimPeerConnection:x,shimSenderGetStats:V,shimReceiverGetStats:H,shimRemoveStream:j,shimRTCDataChannel:W,shimAddTransceiver:K,shimCreateOffer:$,shimCreateAnswer:Y,shimGetUserMedia:F,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return !0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)});}});function J(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(r=>t.call(this,r,e)),e.getVideoTracks().forEach(r=>t.call(this,r,e));},e.RTCPeerConnection.prototype.addTrack=function(e,...r){return r&&r.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e];}),t.apply(this,arguments)};}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const r=e.getTracks();this.getSenders().forEach(e=>{r.includes(e.track)&&this.removeTrack(e);});});}}function Q(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t);});});}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const r=new Event("addstream");r.stream=t,e.dispatchEvent(r);});}),t.apply(e,arguments)};}}function X(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,s=t.setLocalDescription,i=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:e,s=r.apply(this,[n]);return t?(s.then(e,t),Promise.resolve()):s},t.createAnswer=function(e,t){const r=arguments.length>=2?arguments[2]:e,s=n.apply(this,[r]);return t?(s.then(e,t),Promise.resolve()):s};let a=function(e,t,r){const n=s.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,r){const n=i.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,r){const n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=a;}function q(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>r(Z(e));}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n);}.bind(t));}function Z(e){return e&&void 0!==e.video?Object.assign({},e,{video:u(e.video)}):e}function ee(e){const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){const t=[];for(let r=0;r<e.iceServers.length;r++){let n=e.iceServers[r];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(c("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[r]);}e.iceServers=t;}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate});}function te(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function re(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video");}return t.apply(this,arguments)};}var ne=Object.freeze({shimLocalStreamsAPI:J,shimRemoteStreamsAPI:Q,shimCallbacksAPI:X,shimGetUserMedia:q,shimConstraints:Z,shimRTCIceServerUrls:ee,shimTrackEventTransceiver:te,shimCreateOfferLegacy:re});function se(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const r=new t(e),n=v.parseCandidate(e.candidate),s=Object.assign(r,n);return s.toJSON=function(){return {candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,s(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t));}function ie(e){if(!e.RTCPeerConnection)return;const t=d(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const r=function(e){if(!e||!e.sdp)return !1;const t=v.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=v.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return -1;const r=parseInt(t[1],10);return r!=r?-1:r},s=function(e){let r=65536;return "firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},i=function(e,r){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const s=v.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?n=parseInt(s[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0});}if(r(arguments[0])){const e=n(arguments[0]),t=s(e),r=i(arguments[0],e);let o;o=0===t&&0===r?Number.POSITIVE_INFINITY:0===t||0===r?Math.max(t,r):Math.min(t,r);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a;}return o.apply(this,arguments)};}function oe(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const r=e.send;e.send=function(){const n=arguments[0],s=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&s>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)};}const r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=r.apply(this,arguments);return t(e,this),e},s(e,"datachannel",e=>(t(e.channel,e.target),e));}function ae(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return {completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e);},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const r=new Event("connectionstatechange",e);t.dispatchEvent(r);}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)};});}function ce(e){if(!e.RTCPeerConnection)return;const t=d(e);if("chrome"===t.browser&&t.version>=71)return;const r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n")),r.apply(this,arguments)};}var de=Object.freeze({shimRTCIceCandidate:se,shimMaxMessageSize:ie,shimSendThrowTypeError:oe,shimConnectionState:ae,removeAllowExtmapMixed:ce});const le=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const r=a,s=d(e),c={browserDetails:s,commonShim:de,extractVersion:n,disableLog:i,disableWarnings:o};switch(s.browser){case"chrome":if(!O||!I||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),c;r("adapter.js shimming chrome."),c.browserShim=O,E(e),h(e),I(e),m(e),_(e),g(e),R(e),f(e),C(e),se(e),ae(e),ie(e),oe(e),ce(e);break;case"firefox":if(!z||!x||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),c;r("adapter.js shimming firefox."),c.browserShim=z,F(e),x(e),B(e),j(e),V(e),H(e),W(e),K(e),$(e),Y(e),se(e),ae(e),ie(e),oe(e);break;case"edge":if(!U||!L||!t.shimEdge)return r("MS edge shim is not included in this adapter release."),c;r("adapter.js shimming edge."),c.browserShim=U,w(e),b(e),L(e),G(e),ie(e),oe(e);break;case"safari":if(!ne||!t.shimSafari)return r("Safari shim is not included in this adapter release."),c;r("adapter.js shimming safari."),c.browserShim=ne,ee(e),re(e),X(e),J(e),Q(e),te(e),q(e),se(e),ie(e),oe(e),ce(e);break;default:r("Unsupported browser!");}return c}({window:window});le.options=le.options||{},le.onwebrtcreadyDone=!1,le.WebRTCPlugin={plugin:null},le._onwebrtcreadies=[],le.webRTCReady=function(e){if("function"!=typeof e)throw new Error("Callback provided is not a function");var t=function(){"function"==typeof window.require&&"function"==typeof le._defineMediaSourcePolyfill&&le._defineMediaSourcePolyfill(),e(null!==le.WebRTCPlugin.plugin);};!0===le.onwebrtcreadyDone?t():le._onwebrtcreadies.push(t);},le.maybeThroughWebRTCReady=function(){le.onwebrtcreadyDone||(le.onwebrtcreadyDone=!0,le._onwebrtcreadies.length?le._onwebrtcreadies.forEach((function(e){"function"==typeof e&&e(null!==le.WebRTCPlugin.plugin);})):"function"==typeof le.onwebrtcready&&le.onwebrtcready(null!==le.WebRTCPlugin.plugin));},window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,window.webrtcMinimumVersion=null,window.webrtcDetectedDCSupport=null,le.parseWebrtcDetectedBrowser=function(){var e=null;if(window.navigator.userAgent.match(/React-Native/gi)||navigator.userAgent.match(/React-Native/gi))window.webrtcDetectedBrowser="react-native",window.webrtcDetectedVersion="",window.webrtcMinimumVersion=0,window.webrtcDetectedType="react-native",window.webrtcDetectedDCSupport=null;else if(window.opr&&opr.addons||window.opera||navigator.userAgent.indexOf(" OPR/")>=0)e=navigator.userAgent.match(/OPR\/(\d+)/i)||[],window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=26,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport="SCTP";else if(navigator.userAgent.match(/Bowser\/[0-9.]*/g)){e=navigator.userAgent.match(/Bowser\/[0-9.]*/g)||[];var t=parseInt((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[])[2]||"0",10);window.webrtcDetectedBrowser="bowser",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=0,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=t>30?"SCTP":"RTP";}else if(navigator.userAgent.indexOf("OPiOS")>0)e=navigator.userAgent.match(/OPiOS\/([0-9]+)\./),window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("CriOS")>0)e=navigator.userAgent.match(/CriOS\/([0-9]+)\./)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedBrowser="chrome",window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("FxiOS")>0)e=navigator.userAgent.match(/FxiOS\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(document.documentMode)e=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedBrowser="IE",window.webrtcDetectedVersion=parseInt(e[1],10),window.webrtcMinimumVersion=9,window.webrtcDetectedType="plugin",window.webrtcDetectedDCSupport="SCTP",webrtcDetectedVersion||(e=/\bMSIE[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10));else if(window.StyleMedia||navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e=navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||[],window.webrtcDetectedBrowser="edge",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=13.10547,window.webrtcDetectedType="ms",window.webrtcDetectedDCSupport=null;else if("undefined"!=typeof InstallTrigger||navigator.userAgent.indexOf("irefox")>0)e=navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=33,window.webrtcDetectedType="moz",window.webrtcDetectedDCSupport="SCTP";else if(window.chrome&&window.chrome.webstore||navigator.userAgent.indexOf("Chrom")>0)e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[],window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(e[2]||"0",10),window.webrtcMinimumVersion=38,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=window.webrtcDetectedVersion>30?"SCTP":"RTP";else if(/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()||navigator.userAgent.match(/AppleWebKit\/(\d+)\./)||navigator.userAgent.match(/Version\/(\d+).(\d+)/)){e=navigator.userAgent.match(/version\/(\d+)\.(\d+)/i)||[];var r=navigator.userAgent.match(/AppleWebKit\/(\d+)/i)||[],n=navigator.userAgent.match(/(iPhone|iPad)/gi),s=r.length>=1&&r[1]>=604;if(window.webrtcDetectedBrowser="safari",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=7,n)window.webrtcDetectedType=s?"AppleWebKit":null;else{var i=window.webrtcDetectedVersion,o=parseInt(e[2]||"0",10),a=11==i&&o<2;window.webrtcDetectedType=!s||le.options.forceSafariPlugin&&a?"plugin":"AppleWebKit";}window.webrtcDetectedDCSupport="SCTP";}le.webrtcDetectedBrowser=window.webrtcDetectedBrowser,le.webrtcDetectedVersion=window.webrtcDetectedVersion,le.webrtcMinimumVersion=window.webrtcMinimumVersion,le.webrtcDetectedType=window.webrtcDetectedType,le.webrtcDetectedDCSupport=window.webrtcDetectedDCSupport;},le.addExtensions=function(){var e=null,t=null;navigator.mozGetUserMedia?(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}):navigator.webkitGetUserMedia?(e=function(e,t){return le.webrtcDetectedVersion>=43?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.error("Error attaching stream to element."),e},t=function(e,t){return le.webrtcDetectedVersion>=43?e.srcObject=t.srcObject:e.src=t.src,e}):"AppleWebKit"===le.webrtcDetectedType&&(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}),window.attachMediaStream=e,window.reattachMediaStream=t,le.attachMediaStream=e,le.reattachMediaStream=t;},le.parseWebrtcDetectedBrowser(),le.addExtensions(),le.maybeThroughWebRTCReady();var ue=Object.freeze({ON_INCOMING_STREAM:"onIncomingStream",ON_INCOMING_SCREEN_STREAM:"onIncomingScreenStream",STREAM_ENDED:"streamEnded",PEER_UPDATED:"peerUpdated",PEER_JOINED:"peerJoined",PEER_LEFT:"peerLeft",PEER_CONNECTION_STATE:"peerConnectionState",DATA_CHANNEL_STATE:"dataChannelState",ON_INCOMING_MESSAGE:"onIncomingMessage",HANDSHAKE_PROGRESS:"handshakeProgress",SERVER_PEER_JOINED:"serverPeerJoined",SERVER_PEER_LEFT:"serverPeerLeft",CANDIDATE_PROCESSING_STATE:"candidateProcessingState",CANDIDATE_GENERATION_STATE:"candidateGenerationState",CANDIDATES_GATHERED:"candidatesGathered",DATA_STREAM_STATE:"dataStreamState",DATA_TRANSFER_STATE:"dataTransferState",ON_INCOMING_DATA:"onIncomingData",ON_INCOMING_DATA_REQUEST:"onIncomingDataRequest",ON_INCOMING_DATA_STREAM:"onIncomingDataStream",ON_INCOMING_DATA_STREAM_STARTED:"onIncomingDataStreamStarted",ON_INCOMING_DATA_STREAM_STOPPED:"onIncomingDataStreamStopped",GET_PEERS_STATE_CHANGE:"getPeersStateChange",SESSION_DISCONNECT:"sessionDisconnect",STREAM_MUTED:"streamMuted",CHANNEL_OPEN:"channelOpen",CHANNEL_REOPEN:"channelReopen",CHANNEL_CLOSE:"channelClose",CHANNEL_MESSAGE:"channelMessage",CHANNEL_ERROR:"channelError",CHANNEL_RETRY:"channelRetry",SOCKET_ERROR:"socketError",SYSTEM_ACTION:"systemAction",MEDIA_ACCESS_FALLBACK:"mediaAccessFallback",MEDIA_ACCESS_REQUIRED:"mediaAccessRequired",MEDIA_ACCESS_STOPPED:"mediaAccessStopped",MEDIA_ACCESS_SUCCESS:"mediaAccessSuccess",RECORDING_STATE:"recordingState",LOCAL_MEDIA_MUTED:"localMediaMuted",MEDIA_ACCESS_ERROR:"mediaAccessError",GET_CONNECTION_STATUS_STATE_CHANGE:"getConnectionStatusStateChange",READY_STATE_CHANGE:"readyStateChange",ROOM_LOCK:"roomLock",INTRODUCE_STATE_CHANGE:"introduceStateChange",ICE_CONNECTION_STATE:"iceConnectionState",BYE:"bye",RTMP_STATE:"rtmpState",LOGGED_ON_CONSOLE:"loggedOnConsole",MEDIA_INFO_DELETED:"mediaInfoDeleted",STORED_MESSAGES:"storedMessages",ENCRYPT_SECRETS_UPDATED:"encryptSecretsUpdated",PERSISTENT_MESSAGE_STATE:"persistentMessageState",ROOM_REJOIN:"roomRejoin"});class pe{constructor(e,t){this.name=e,this.detail=t;}}const Se=(e={})=>new pe("onIncomingStream",{detail:e}),Ee=(e={})=>new pe("onIncomingScreenStream",{detail:e}),he=(e={})=>new pe("streamEnded",{detail:e}),me=(e={})=>new pe("streamMuted",{detail:e}),ge=(e={})=>new pe("dataChannelState",{detail:e}),Re=(e={})=>new pe("onIncomingMessage",{detail:e}),fe=(e={})=>new pe("handshakeProgress",{detail:e}),Te=(e={})=>new pe("readyStateChange",{detail:e}),_e=e=>new pe("candidateProcessingState",{detail:e}),Ie=e=>new pe("candidateGenerationState",{detail:e}),Ce=e=>new pe("iceConnectionState",{detail:e}),Oe=(e={})=>new pe("roomLock",{detail:e}),Ae=(e={})=>new pe("peerUpdated",{detail:e}),ve=(e={})=>new pe("peerJoined",{detail:e}),Ne=(e={})=>new pe("peerLeft",{detail:e}),De=(e={})=>new pe("serverPeerLeft",{detail:e}),ye=(e={})=>new pe("getPeersStateChange",{detail:e}),Pe=(e={})=>new pe("peerConnectionState",{detail:e}),Me=(e={})=>new pe("getConnectionStatusStateChange",{detail:e}),ke=(e={})=>new pe("mediaAccessFallback",{detail:e}),we=(e={})=>new pe("rtmpState",{detail:e}),be=(e={})=>new pe("mediaAccessError",{detail:e});const Le={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error",CREATE_ERROR:"createError",BUFFERED_AMOUNT_LOW:"bufferedAmountLow",SEND_MESSAGE_ERROR:"sendMessageError"},Ge={MESSAGING:"messaging",DATA:"data"},Ue={MESSAGE:"message",TRANSFER:"transfer"},Fe={REQUEST:"request",SUCCESS:"success",ERROR:"error"},Be={NEW:"new",GATHERING:"gathering",COMPLETED:"complete"},xe={RECEIVED:"received",DROPPED:"dropped",BUFFERED:"buffered",PROCESSING:"processing",PROCESS_SUCCESS:"processSuccess",PROCESS_ERROR:"processError"},Ve={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},He={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},je={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed",CONNECTING:"connecting",FAILED:"failed",DISCONNECTED:"disconnected",CONNECTED:"connected"},We={RETRIEVING:0,RETRIEVE_SUCCESS:1,RETRIEVE_ERROR:-1},Ke={MCU:"mcu"},$e={MAX_COMPAT:"max-compat",BALANCED:"balanced",MAX_BUNDLE:"max-bundle",NONE:"none"},Ye={REQUIRE:"require",NEGOTIATE:"negotiate"},ze={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",ERROR:"error"},Je={ENQUIRED:"enquired",DISPATCHED:"dispatched",RECEIVED:"received"},Qe={WARNING:"warning",REJECT:"reject",LOCKED:"locked"},Xe={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},qe={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,API_OVER_SEAT_LIMIT:4020,API_RETRIEVAL_FAILED:4021,API_WRONG_ACCESS_DOMAIN:5005,XML_HTTP_REQUEST_ERROR:-1,XML_HTTP_NO_REPONSE_ERROR:-2,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,ADAPTER_NO_LOADED:7,PARSE_CODECS:8},Ze={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},et={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},tt={AUTO:"auto",VP8:"VP8",H264:"H264",VP9:"VP9"},rt={AUTO:"auto",ISAC:"ISAC",OPUS:"opus",ILBC:"ILBC",G722:"G722",PCMU:"PCMU",PCMA:"PCMA"},nt={QQVGA:{width:160,height:120},HQVGA:{width:240,height:160},QVGA:{width:320,height:240},WQVGA:{width:384,height:240},HVGA:{width:480,height:320},VGA:{width:640,height:480},WVGA:{width:768,height:480},FWVGA:{width:854,height:480},SVGA:{width:800,height:600},DVGA:{width:960,height:640},WSVGA:{width:1024,height:576},HD:{width:1280,height:720},HDPLUS:{width:1600,height:900},FHD:{width:1920,height:1080},QHD:{width:2560,height:1440},WQXGAPLUS:{width:3200,height:1800},UHD:{width:3840,height:2160},UHDPLUS:{width:5120,height:2880},FUHD:{width:7680,height:4320},QUHD:{width:15360,height:8640}},st={FALLBACKING:0,FALLBACKED:1,ERROR:-1},it={START:0,STOP:1,LINK:2,ERROR:-1},ot={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},at={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach",START_RECORDING:"startRecordingRoom",STOP_RECORDING:"stopRecordingRoom",RECORDING:"recordingEvent",END_OF_CANDIDATES:"endOfCandidates",START_SCREENSHARE:"startScreenshare",START_RTMP:"startRTMP",STOP_RTMP:"stopRTMP",RTMP:"rtmpEvent",MEDIA_INFO_EVENT:"mediaInfoEvent",MESSAGE:"message",GET_STORED_MESSAGES:"getStoredMessages",STORED_MESSAGES:"storedMessages",RESTART:"restart"},ct={ENDED:"ended"},dt=[at.STREAM,at.UPDATE_USER,at.PUBLIC_MESSAGE],lt={PLAN_B:"plan-b",UNIFIED:"unified-plan"},ut={START:0,STOP:1,ERROR:-1},pt={MUTED:0,ACTIVE:1,UNAVAILABLE:-1},St={SKYLINK_EVENT:"SKYLINK EVENT",SKYLINK_ERROR:"SKYLINK ERROR",STATS_MODULE:"RTCStatsReport",SESSION_DESCRIPTION:"RTCSessionDescription",PEER_CONNECTION:"RTCPeerConnection",CANDIDATE_HANDLER:"RTCIceCandidate",DATA_CHANNEL:"RTCDataChannel",SIG_SERVER:"SIG SERVER",PEER_MEDIA:"PEER MEDIA",PEER_INFORMATION:"PEER INFORMATION",ROOM:"ROOM",RECORDING:"RECORDING",MEDIA_STREAM:"MEDIA STREAM",MESSAGING:"MESSAGING",ASYNC_MESSAGING:"ASYNC MESSAGING",ENCRYPTED_MESSAGING:"ENCRYPTED MESSAGING",STATS:"STATS"},Et={AUDIO_MIC:"audioMic",VIDEO_CAMERA:"videoCamera",VIDEO_SCREEN:"videoScreen",VIDEO_OTHER:"videoOther",AUDIO:"audio",VIDEO:"video"},ht={LIVE:"live",ENDED:"ended"},mt={AUDIO:"audio",VIDEO:"video"},gt={MUTED:"muted",ACTIVE:"active",STOPPED:"stopped",UNAVAILABLE:"unavailable"},Rt={PUBLISHER_ID:"publisherId",MEDIA_ID:"mediaId",MEDIA_TYPE:"mediaType",MEDIA_STATE:"mediaState",TRANSCEIVER_MID:"transceiverMid",MEDIA_META_DATA:"mediaMetaData",SIMULCAST:"simulcast",STREAM_ID:"streamId"},ft="2.2.2",Tt={WEB:"Web SDK",ANDROID:"Android SDK",IOS:"iOS SDK",CPP:"C++ SDK"},_t={CHROME:"chrome",FIREFOX:"firefox",SAFARI:"safari",REACT_NATIVE:"react-native"},It={MCU:"MCU"},Ct={CONNECT:"connect",DISCONNECT:"disconnect",RECONNECT_ATTEMPT:"reconnect_attempt",RECONNECT_SUCCESS:"reconnect_success",RECONNECT_FAILED:"reconnect_failed",RECONNECT_ERROR:"reconnect_error",MESSAGE:"message",ERROR:"error"},Ot={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"},At={SIGNALING:Ct},vt=ue;var Nt=Object.freeze({DATA_CHANNEL_STATE:Le,DATA_CHANNEL_TYPE:Ge,DATA_CHANNEL_MESSAGE_ERROR:Ue,DATA_TRANSFER_DATA_TYPE:{BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob",STRING:"string"},DT_PROTOCOL_VERSION:"0.1.3",DATA_TRANSFER_TYPE:{UPLOAD:"upload",DOWNLOAD:"download"},DATA_TRANSFER_SESSION_TYPE:{BLOB:"blob",DATA_URL:"dataURL"},DATA_TRANSFER_STATE:{UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted",USER_REJECTED:"userRejected",USER_UPLOAD_REQUEST:"userRequest",START_ERROR:"startError"},AUTH_STATE:Fe,DATA_STREAM_STATE:{SENDING_STARTED:"sendStart",SENDING_STOPPED:"sendStop",RECEIVING_STARTED:"receiveStart",RECEIVING_STOPPED:"receiveStop",RECEIVED:"received",SENT:"sent",ERROR:"error",START_ERROR:"startError"},CANDIDATE_GENERATION_STATE:Be,CANDIDATE_PROCESSING_STATE:xe,ICE_CONNECTION_STATE:Ve,TURN_TRANSPORT:He,PEER_CONNECTION_STATE:je,GET_CONNECTION_STATUS_STATE:We,SERVER_PEER_TYPE:Ke,BUNDLE_POLICY:$e,RTCP_MUX_POLICY:Ye,PEER_CERTIFICATE:{RSA:"RSA",ECDSA:"ECDSA",AUTO:"AUTO"},HANDSHAKE_PROGRESS:ze,GET_PEERS_STATE:Je,INTRODUCE_STATE:{INTRODUCING:"introducing",ERROR:"error"},SYSTEM_ACTION:Qe,SYSTEM_ACTION_REASON:{CREDENTIALS_EXPIRED:"oldTimeStamp",CREDENTIALS_ERROR:"credentialError",DUPLICATED_LOGIN:"duplicatedLogin",ROOM_NOT_STARTED:"notStart",EXPIRED:"expired",ROOM_LOCKED:"locked",FAST_MESSAGE:"fastmsg",ROOM_CLOSING:"toclose",ROOM_CLOSED:"roomclose",SERVER_ERROR:"serverError",KEY_ERROR:"keyFailed"},READY_STATE_CHANGE:Xe,READY_STATE_CHANGE_ERROR:qe,REGIONAL_SERVER:{APAC1:"",US1:""},LOG_LEVEL:{DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0,NONE:-1},SOCKET_ERROR:Ze,SOCKET_FALLBACK:et,SM_PROTOCOL_VERSION:"2.1.0",VIDEO_CODEC:tt,AUDIO_CODEC:rt,MEDIA_SOURCE:{SCREEN:"screen",WINDOW:"window",TAB:"tab",TAB_AUDIO:"audio",APPLICATION:"application",BROWSER:"browser",CAMERA:"camera"},VIDEO_RESOLUTION:nt,MEDIA_ACCESS_FALLBACK_STATE:st,RECORDING_STATE:it,CHUNK_FILE_SIZE:49152,MOZ_CHUNK_FILE_SIZE:12288,BINARY_FILE_SIZE:65456,MOZ_BINARY_FILE_SIZE:16384,CHUNK_DATAURL_SIZE:1212,DC_PROTOCOL_TYPE:ot,SIG_MESSAGE_TYPE:at,STREAM_STATUS:ct,GROUP_MESSAGE_LIST:dt,VIDEO_QUALITY:{HD:{video:3200,audio:150},HQ:{video:1200,audio:80},SQ:{video:800,audio:30},LQ:{video:400,audio:20}},SDP_SEMANTICS:lt,RTMP_STATE:ut,MEDIA_STATUS:pt,TAGS:St,MEDIA_TYPE:Et,TRACK_READY_STATE:ht,TRACK_KIND:mt,MEDIA_STATE:gt,MEDIA_INFO:Rt,SDK_VERSION:ft,SDK_NAME:Tt,API_VERSION:"9.0.0",SIGNALING_VERSION:"sig-v2",BROWSER_AGENT:_t,PEER_TYPE:It,SOCKET_EVENTS:Ct,SOCKET_TYPE:Ot,STATES:At,EVENTS:vt});const Dt={INIT:{ERRORS:{NO_ADAPTER:"AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used",NO_SOCKET_IO:"Socket.io not loaded - Please load socket.io",NO_FETCH_SUPPORT:"Fetch API is not supported in your browser. Please make sure you are using a modern browser: https://caniuse.com/#search=fetch",NO_APP_KEY:"Please provide an App Key - Get one at console.temasys.io!",AUTH_CORS:"Promise rejected due to CORS forbidden request - Please visit: http://support.temasys.com.sg/support/solutions/articles/12000006761-i-get-a-403-forbidden-access-is-denied-when-i-load-the-application-why-",AUTH_GENERAL:"Promise rejected due to network issue",SOCKET_CREATE_FAILED:"Failed creating socket connection object ->",SOCKET_ERROR_ABORT:"Reconnection aborted as the connection timed out or there no more available ports, transports and final attempts left"},INCOMPATIBLE_BROWSER:"Incompatible browser agent detected",INFO:{API_SUCCESS:"Promise resolved: APP Authenticated Successfully!"}},SOCKET:{ABORT_RECONNECT:"Aborting socket reconnect"},JOIN_ROOM:{ERRORS:{CODEC_SUPPORT:"No audio/video codecs available to start connection"}},ROOM:{ERRORS:{STOP:{SCREEN_SHARE:"Error stopping screenshare"},NOT_IN_ROOM:"User is not in room",NO_PEERS:"No peers in room"},LEAVE_ROOM:{ERROR:"Leave room error --\x3e",NO_PEERS:"No peers in room",DROPPING_HANGUP:"Dropping hang-up from remote peer",LEAVE_ALL_ROOMS:{SUCCESS:"Successfully left all rooms",ERROR:"Leave all rooms error --\x3e"},PEER_LEFT:{START:"Initiating peer left process",SUCCESS:"Successfully completed peer left process",ERROR:"Failed peer left process"},SENDING_BYE:"Sending bye message to all peers",DISCONNECT_SOCKET:{SUCCESS:"Successfully disconnected socket"},REMOVE_STATE:{SUCCESS:"Successfully removed room state"}}},ROOM_STATE:{NOT_FOUND:"Could not retrieve room state for room name/key",LEFT:"Peer left room",NO_ROOM_NAME:"No room name specified"},PEER_INFORMATIONS:{NO_PEER_INFO:"Not able to retrieve Peer Information for peerId:",UPDATE_USER_DATA:"Peer updated userData: ",OUTDATED_MSG:"Dropping outdated status ->",USER_DATA_NOT_JSON:"UserData is not JSON",SET_PEER_PRIORITY_WEIGHT:"Setting peerPriorityWeight with tiebreaker value from inRoom signalling message"},PEER_CONNECTION:{NOT_INITIALISED:"Peer Connection not initialised",CREATE_NEW:"Creating new Peer Connection",NO_PEER_CONNECTION:"No Peer Connection detected",PEER_ID_NOT_FOUND:"Peer Id not found",STATE_CHANGE:"Peer connection state changed ->",STATS_API_UNAVAILABLE:"getStats() API is not available",MCU:"MCU connected",FAILED_STATE:"Peer Connection state: failed",ADD_TRANSCEIVER:"Adding empty transceiver",ERRORS:{REMOVE_TRACK:"Error removing track from peer connection",NOT_FOUND:"Peer Connection not found"},REFRESH_CONNECTION:{START:"Refreshing peer connections",SUCCESS:"Peer Connection refreshed successfully",FAILED:"Peer Connection failed to refresh",COMPLETED:"All Peer Connections refreshed with resolve or errors",RESTART_ICE_UNAVAILABLE:"Dropping iceRestart option as it is not available on the peer connection",NOT_SUPPORTED:"Refresh connection not supported by browser",SEND_RESTART_OFFER:"Sending restart offer message to signaling server",NO_LOCAL_DESCRIPTION:"No localDescription set to connection. There could be a handshaking step error."}},PEER_PRIVILEGED:{not_privileged:"Please upgrade your key to privileged to use this function",no_appkey:"App key is not defined - Please authenticate again",getPeerListFromServer:"Enquired server for peers within the App space"},ICE_CONNECTION:{END_OF_CANDIDATES_SUCCESS:"Signaling of end-of-candidates remote ICE gathering",END_OF_CANDIDATES_FAILURE:"Failed signaling of end-of-candidates remote ICE gathering",ICE_GATHERING_STARTED:"ICE gathering has started",ICE_GATHERING_COMPLETED:"ICE gathering has completed",DROP_EOC:"Dropping of sending ICE candidate end-of-candidates signal or unused ICE candidates ->",STATE_CHANGE:"Ice connection state changed ->"},ICE_CANDIDATE:{DROPPING_CANDIDATE:"Dropping ICE candidate",INVALID_CANDIDATE:"Received invalid ICE candidate message ->",VALID_CANDIDATE:"Received ICE candidate ->",FILTERED_CANDIDATE:"Dropping received ICE candidate as it matches ICE candidate filtering flag ->",FILTERING_FLAG_NOT_HONOURED:"Not dropping received ICE candidate as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->",CANDIDATE_ADDED:"Added ICE candidate successfully",ADDING_CANDIDATE:"Adding ICE Candidate",FAILED_ADDING_CANDIDATE:"Failed adding ICE candidate ->",ADD_BUFFERED_CANDIDATE:"Adding buffered ICE candidate",ADD_CANDIDATE_TO_BUFFER:"Adding ICE candidate to buffer",CANDIDATE_GENERATED:"Generated ICE candidate ->",SENDING_CANDIDATE:"Sending ICE candidate ->"},SESSION_DESCRIPTION:{parsing_media_ssrc:"Parsing session description media SSRCs ->"},DATA_CHANNEL:{reviving_dataChannel:"Reviving Datachannel connection",refresh_error:"Not a valid Datachannel connection",CLOSING:"Closing DataChannel",closed:"Datachannel has closed",onclose_error:"Error in data-channel onclose callback",NO_REMOTE_DATA_CHANNEL:"Remote peer does not have data channel",ERRORS:{FAILED_CLOSING:"Failed closing DataChannels --\x3e ",NO_SESSIONS:"Peer Connection does not have DataChannel sessions"}},NEGOTIATION_PROGRESS:{SET_LOCAL_DESCRIPTION:"Successfully set local description --\x3e",SET_REMOTE_DESCRIPTION:"Successfully set remote description --\x3e",APPLYING_BUFFERED_REMOTE_OFFER:"Applying buffered remote offer",ERRORS:{FAILED_SET_LOCAL_DESCRIPTION:"Failed setting local description --\x3e",FAILED_SET_REMOTE_DESCRIPTION:"Failed setting remote description",FAILED_SET_REMOTE_ANSWER:"Peer failed to set remote answer.",FAILED_RENEGOTIATION:"Failed renegotiation after answerAck",NOT_STABLE:"Dropping of message as signaling state is not stable",PROCESSING_EXISTING_SDP:"Dropping message as there is another sessionDescription being processed --\x3e",OFFER_TIEBREAKER:"Dropping the received offer: self weight is greater than incoming offer weight --\x3e",NO_LOCAL_BUFFERED_OFFER:"FATAL: No buffered local offer found - Unable to setLocalDescription",ADDING_REMOTE_OFFER_TO_BUFFER:"Adding remote offer received to buffer as current negotiation has not completed"}},SIGNALING:{MESSAGE_ADDED_TO_BUFFER:"Message buffered as enter message has not been sent",ENTER_LISTENER:"Enter listener initialized",BUFFERED_MESSAGES_SENT:"Buffered messages sent",BUFFERED_MESSAGES_DROPPED:"Buffered messages dropped - no mid",OUTDATED_MSG:"Dropping outdated status ->",DROPPING_MUTE_EVENT:"Dropping mute audio / video event message as it is processed by mediaInfoEvent",BUFFER_NOT_NEEDED:"Enter message sent. Messages do not need to be buffered",ABORTING_OFFER:"Aborting offer as current negotiation has not completed"},MESSAGING:{PRIVATE_MESSAGE:"Sending private message to Peer",BROADCAST_MESSAGE:"Broadcasting message to Peers",RECEIVED_MESSAGE:"Received message from Peer",PERSISTENCE:{SEND_MESSAGE:"Sending persisted message",NOT_PERSISTED:"Message will not be persisted as persistent flag is set to false",STORED_MESSAGES:"Received stored messages for room",IS_PERSISTENT_CONFIG:"Persistent message flag is set to",ERRORS:{FAILED_SETTING_PERSISTENCE:"Failed setting persistent message flag",INVALID_TYPE:"Persistent message flag must be of type boolean",PRIVATE_MESSAGE:"Cannot persist private messages",PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED:"Persistent Message feature is not enabled. Enable this feature on the key under 'Advanced Settings' in the Temasys Console"}},ENCRYPTION:{SEND_MESSAGE:"Sending encrypted message",DELETE_ALL:"Deleting all stored secrets",ERRORS:{FAILED_DECRYPTING_MESSAGE:"Failed decrypting message",ENCRYPT_SECRET:"Incorrect secret provided",INVALID_SECRETS:"No or invalid secret and secret id provided",SET_SELECTED_SECRET:"Failed setting selected secret",DELETE_ENCRYPT_SECRETS:"Failed deleting secret",SET_ENCRYPT_SECRET:"Failed setting secret",SECRET_ID_NOT_FOUND:"Secret id not found",NO_SECRET_OR_SECRET_ID:"Secret and / or secret id not provided",INVALID_TYPE:"Secret and secret id must be of type string and not empty",SECRET_ID_NOT_UNIQUE:"Secret id provided is not unique",SECRET_ID_NOT_SELECTED:"Secret id not selected",SECRET_ID_NOT_PROVIDED:"Secret id not provided",SECRETS_NOT_PROVIDED:"Secrets not provided"}},ERRORS:{DROPPING_MESSAGE:"Dropping message",FAILED_SENDING_MESSAGE:"Failed to send user message"}},MEDIA_INFO:{UPDATE_SUCCESS:"Successfully updated media info",ERRORS:{NO_ASSOCIATED_STREAM_ID:"There is no streamId associated with the mediaId and transceiverMid pair",FAILED_PROCESSING_MEDIA_INFO_EVENT:"Failed to process mediaInfoEvent message",FAILED_UPDATING:"Failed to update media info",FAILED_PROCESSING_PEER_MEDIA:"Failed to process media info",FAILED_UPDATING_TRANSCEIVER_MID:"Failed updating media info transceiverMid after setLocalDescription",FAILED_SETTING_PEER_MEDIA_INFO:"Failed setting peer media at offer / answer",STREAM_ID_NOT_MATCHED:"There is no mediaInfo associated with the streamId"},WARN:{READ_ONLY_VALUE:"Attempting to change media info read only value: ",INVALID_MEDIA_TYPE:"Invalid media info media type: "},VIDEO_STATE_CHANGE:"Peers's video state changed to ->",AUDIO_STATE_CHANGE:"Peers's audio state changed to ->",VIDEO_SCREEN_STATE_CHANGE:"Peers's video screen state changed to ->"},MEDIA_STREAM:{STOP_SETTINGS:"Stopped streams with settings:",STOP_SUCCESS:"Successfully stopped stream",REMOTE_TRACK_REMOVED:"Remote MediaStreamTrack removed",START_FALLBACK:"Fall back to retrieve audio only stream",NO_OPTIONS:"No user media options provided",DEFAULT_OPTIONS:"Using default options",FALLBACK_SUCCESS:"Successfully retrieved audio fallback stream",START_SCREEN_SUCCESS:"Successfully retrieved screen share stream",STOP_SCREEN_SUCCESS:"Successfully stopped screen share stream",UPDATE_MUTED_SETTINGS:"Updated stream muted setting",UPDATE_MEDIA_STATUS:"Updated stream media status",AUDIO_MUTED:"Peers's audio muted: ",VIDEO_MUTED:"Peers's video muted: ",ERRORS:{STOP_SCREEN:"Error stopping screen share stream",START_SCREEN:"Error starting screen share stream",STOP_ADDED_STREAM:"Error stopping added stream",STOP_USER_MEDIA:"Error stopping user media",STOP_AUDIO_TRACK:"Error stopping audio tracks in stream",STOP_VIDEO_TRACK:"Error stopping video tracks in stream",STOP_MEDIA_TRACK:"Error stopping MediaTrack",STOP_SCREEN_TRACK:"Error stopping screen track in stream",DROPPING_ONREMOVETRACK:"Dropping onremovetrack",NO_STREAM:"No stream to process",INVALID_STREAM_ID:"No stream detected with stream id",NO_USER_MEDIA_STREAMS:"No user media streams detected",INVALID_STREAM_ID_TYPE:"Stream id is not a string",NO_STREAM_ID:"No stream id provided",PEER_SCREEN_ACTIVE:"Peer has existing screen share",FALLBACK:"Error retrieving fallback audio stream",INVALID_GUM_OPTIONS:"Invalid user media options",INVALID_GDM_OPTIONS:"Invalid display media options",GET_USER_MEDIA:"Error retrieving stream from 'getUserMedia' method",INVALID_MUTE_OPTIONS:"Invalid muteStreams options provided",NO_STREAMS_MUTED:"No streams to mute",SEND_STREAM:"Error sending stream",INVALID_MEDIA_STREAM_ARRAY:"Array is not of type MediaStream",INACTIVE_MEDIA_STREAM:"One or more media streams is inactive",ACTIVE_STREAMS:"There are currently active streams being sent to remote peers. Please stop streams.",INVALID_PREFETCHED_STREAMS:"Invalid prefetched streams provided"}},STATS_MODULE:{NOT_INITIATED:"Stats Module is not initiated",STATS_DISCARDED:"Stats report discarded as peer has left the room",ERRORS:{RETRIEVE_STATS_FAILED:"Failed retrieving stats",POST_FAILED:"Failed posting to stats api",PARSE_FAILED:"Failed parsing stats report",STATS_IS_NULL:"Stats object is null",INVALID_TRACK_KIND:"Media kind is not audio or video"},HANDLE_ICE_GATHERING_STATS:{PROCESS_FAILED:"process_failed",PROCESS_SUCCESS:"process_success",PROCESSING:"processing",DROPPED:"dropped",BUFFERED:"buffered"},HANDLE_NEGOTIATION_STATS:{OFFER:{create:"create_offer",create_error:"error_create_offer",set:"set_offer",set_error:"error_set_offer",offer:"offer",dropped:"dropped_offer"},ANSWER:{create:"create_answer",create_error:"error_create_answer",set:"set_answer",set_error:"error_set_ANSWER",answer:"answer",dropped:"dropped_answer"}},HANDLE_DATA_CHANNEL_STATS:{open:"open",closed:"closed",reconnecting:"reconnecting"},HANDLE_CONNECTION_STATS:{},HANDLE_BANDWIDTH_STATS:{RETRIEVE_FAILED:"Failed posting bandwidth stats: ",NO_STATE:"No room state"},HANDLE_ICE_CONNECTION_STATS:{RETRIEVE_FAILED:"Failed retrieving stats: ",SEND_FAILED:"Failed sending ice connection stats: "},HANDLE_RECORDING_STATS:{START:"start",STOP:"stop",REQUEST_START:"request-start",REQUEST_STOP:"request-stop",ERROR_NO_MCU_START:"error-no-mcu-start",ERROR_NO_MCU_STOP:"error-no-mcu-stop",ERROR_START_ACTIVE:"error-start-when-active",ERROR_STOP_ACTIVE:"error-stop-when-active",ERROR_MIN_STOP:"error-min-stop",MCU_RECORDING_ERROR:"mcu-recording-error"}},RECORDING:{START_SUCCESS:"Started recording",STOP_SUCCESS:"Stopped recording",START_FAILED:"Failed to start recording",STOP_FAILED:"Failed to stop recording",MIN_RECORDING_TIME_REACHED:"4 seconds has been recorded - Recording can be stopped now",ERRORS:{MCU_NOT_CONNECTED:"MCU is not connected",EXISTING_RECORDING_IN_PROGRESS:"There is an existing recording in-progress",NO_RECORDING_IN_PROGRESS:"There is no existing recording in-progress",MIN_RECORDING_TIME:"4 seconds has not been recorded yet",STOP_ABRUPT:"Recording stopped abruptly before 4 seconds",SESSION_EMPTY:'Received request of "off" but the session is empty',MCU_RECORDING_ERROR:"Recording error received from MCU"}},RTMP:{start_no_mcu:"Unable to start RTMP session as MCU is not connected",stop_no_mcu:"Unable to stop RTMP as MCU is not connected",start_no_stream_id:"Unable to start RTMP Session stream id is missing",start_no_endpoint:"Unable to start RTMP Session as Endpoint is missing",starting_rtmp:"Starting RTMP Session",stopping_rtmp:"Stopping RTMP Session",message_received_from_sig:"Received RTMP Session message ->",stop_session_empty:'Received request of "off" but the session is empty',stopped_success:"Stopped RTMP Session",started_success:"Started RTMP Session",error_session_empty:"Received error but the session is empty ->",error_session:"RTMP session failure ->",error_Session_abrupt:"Stopped RTMP session abruptly"},PERSISTENT_MESSAGE:{ERRORS:{NO_DEPENDENCY:"CryptoJS is not available"}},UTILS:{INVALID_BROWSER_AGENT:"Invalid browser agent"},LOGGER:{EVENT_DISPATCHED:"Event dispatched",EVENT_REGISTERED:"Event successfully registered",EVENT_UNREGISTERED:"Event successfully unregistered",EVENT_DISPATCH_ERROR:"Error dispatching event",EVENT_REGISTER_ERROR:"Error registering event",EVENT_UNREGISTER_ERROR:"Error unregistering event",LOGS_NOT_STORED:"Store logs feature is not enabled. Enable it via SkylinkLogger.setLevel(logLevel, storeLogs)",LOGS_CLEARED:"Stored logs cleared",INVALID_CB:"Dropping listener as it is not a function"},BROWSER_AGENT:{REACT_NATIVE:{ERRORS:{DROPPING_ONREMOVETRACK:"Dropping onremovetrack as trackInfo is malformed"}}}};const yt=new class{constructor(){this.events={},this.privateEvents={};}addPrivateEventListener(e,t){this.addListener(e,t,!0);}addEventListener(e,t){this.addListener(e,t,!1);}addListener(e,t,r){try{const n=r?"privateEvents":"events";if(!Ti(t))return void Ut.log.DEBUG([null,St.SKYLINK_EVENT,e,Dt.LOGGER.INVALID_CB]);this[n][e]||(this[n][e]={}),this[n][e].callbacks||(this[n][e].callbacks=[]),this[n][e].callbacks.push(t),r||Ut.log.DEBUG([null,St.SKYLINK_EVENT,e,Dt.LOGGER.EVENT_REGISTERED]);}catch(t){Ut.log.ERROR([null,St.SKYLINK_EVENT,e,Dt.LOGGER.EVENT_REGISTER_ERROR],t);}}dispatchEvent(e){if(e.name===vt.LOGGED_ON_CONSOLE)return;let t=[];if(this.events[e.name]){const r=this.events[e.name].callbacks;t=t.concat(r);}else Ut.log.DEBUG([null,St.SKYLINK_EVENT,e.name,Dt.LOGGER.EVENT_DISPATCHED]);if(this.privateEvents[e.name]){const r=this.privateEvents[e.name]?this.privateEvents[e.name].callbacks:[];t=t.concat(r);}t.forEach(t=>{try{t(e.detail);}catch(t){Ut.log.ERROR([null,St.SKYLINK_EVENT,e.name,Dt.LOGGER.EVENT_DISPATCH_ERROR],t);}});}removeEventListener(e,t){this.removeListener(e,t,!1);}removePrivateEventListener(e,t){this.removeListener(e,t,!0);}removeListener(e,t,r){const n=r?"privateEvents":"events";if(r||this.events[e]&&this.events[e].callbacks)try{this[n][e].callbacks.forEach((s,i)=>{s===t&&(delete this[n][e].callbacks[i],r||Ut.log.DEBUG([null,St.SKYLINK_EVENT,e,Dt.LOGGER.EVENT_UNREGISTERED]));});}catch(t){Ut.log.ERROR([null,St.SKYLINK_EVENT,e,Dt.LOGGER.EVENT_DISPATCH_ERROR],t);}else Ut.log.WARN([null,St.SKYLINK_EVENT,e,Dt.LOGGER.EVENT_UNREGISTERED]);}},Pt=yt.addPrivateEventListener.bind(yt),Mt=yt.removePrivateEventListener.bind(yt),kt=yt.dispatchEvent.bind(yt),wt=["trace","debug","info","warn","error"],bt=e=>{let t=!0;return ("undefined"==typeof console||void 0===console[e])&&(t=!1),t},Lt=(e,t,r,n=null)=>{const s=`[${(new Date).toISOString()}]`,i=e.level,{logLevels:o}=e;if(i<=t&&i!==o.SILENT){const e=wt[t];if(!bt(e))return;const i=(e=>{let t="SkylinkJS -";if(Array.isArray(e)){const[r,n,s,i]=e;if(t+=r?` [${r}]`:" -",t+=n?` <<${n}>>`:r?"":" <<Method>>",s)if(Array.isArray(s))for(let e=0;e<s.length;e+=1)t+=` (${s[e]})`;else t+=` (${s})`;t+=" "+i;}else t+=" "+e;return t})(r);if(bt(e)&&(console[e](s,i,n||""),kt(((e={})=>new pe("loggedOnConsole",{detail:e}))({level:e,message:i,debugObject:n}))),Ut.storeLogs){const t=[s,e.toUpperCase(),i];n&&t.push(n),Ut.storedLogs.push(t);}}};class Gt{constructor(){this.logLevels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},this.level=(e=>{const t=window.localStorage.getItem("loglevel:skylinkjs");return null===t||Number.isNaN(+t)?e.ERROR:+t})(this.logLevels),this.storeLogs=!1,this.storedLogs=[];}setLevel(e=this.levels.ERROR,t){fi(e)?(this.level=e,(e=>{window.localStorage.setItem("loglevel:skylinkjs",e);})(this.level)):this.level=this.levels.ERROR,t&&(this.storeLogs=t);}enableAll(){this.setLevel(this.logLevels.TRACE);}disableAll(){this.setLevel(this.logLevels.SILENT);}getLogs(){return this.storeLogs?this.storedLogs:(this.log.WARN(Dt.LOGGER.LOGS_NOT_STORED),null)}clearLogs(){this.log.INFO(Dt.LOGGER.LOGS_CLEARED),this.storedLogs=[];}}const Ut=new Gt;Gt.prototype.log={TRACE:(...e)=>{Lt(Ut,Ut.logLevels.TRACE,...e);},DEBUG:(...e)=>{Lt(Ut,Ut.logLevels.DEBUG,...e);},INFO:(...e)=>{Lt(Ut,Ut.logLevels.INFO,...e);},WARN:(...e)=>{Lt(Ut,Ut.logLevels.WARN,...e);},ERROR:(...e)=>{Lt(Ut,Ut.logLevels.ERROR,...e);}};var Ft=A((function(e){var t=function(){function e(e,t){return null!=t&&e instanceof t}var t,r,n;try{t=Map;}catch(e){t=function(){};}try{r=Set;}catch(e){r=function(){};}try{n=Promise;}catch(e){n=function(){};}function s(i,a,c,d,l){"object"==typeof a&&(c=a.depth,d=a.prototype,l=a.includeNonEnumerable,a=a.circular);var u=[],p=[],S="undefined"!=typeof Buffer;return void 0===a&&(a=!0),void 0===c&&(c=1/0),function i(c,E){if(null===c)return null;if(0===E)return c;var h,m;if("object"!=typeof c)return c;if(e(c,t))h=new t;else if(e(c,r))h=new r;else if(e(c,n))h=new n((function(e,t){c.then((function(t){e(i(t,E-1));}),(function(e){t(i(e,E-1));}));}));else if(s.__isArray(c))h=[];else if(s.__isRegExp(c))h=new RegExp(c.source,o(c)),c.lastIndex&&(h.lastIndex=c.lastIndex);else if(s.__isDate(c))h=new Date(c.getTime());else{if(S&&Buffer.isBuffer(c))return h=Buffer.allocUnsafe?Buffer.allocUnsafe(c.length):new Buffer(c.length),c.copy(h),h;e(c,Error)?h=Object.create(c):void 0===d?(m=Object.getPrototypeOf(c),h=Object.create(m)):(h=Object.create(d),m=d);}if(a){var g=u.indexOf(c);if(-1!=g)return p[g];u.push(c),p.push(h);}for(var R in e(c,t)&&c.forEach((function(e,t){var r=i(t,E-1),n=i(e,E-1);h.set(r,n);})),e(c,r)&&c.forEach((function(e){var t=i(e,E-1);h.add(t);})),c){var f;m&&(f=Object.getOwnPropertyDescriptor(m,R)),f&&null==f.set||(h[R]=i(c[R],E-1));}if(Object.getOwnPropertySymbols){var T=Object.getOwnPropertySymbols(c);for(R=0;R<T.length;R++){var _=T[R];(!(C=Object.getOwnPropertyDescriptor(c,_))||C.enumerable||l)&&(h[_]=i(c[_],E-1),C.enumerable||Object.defineProperty(h,_,{enumerable:!1}));}}if(l){var I=Object.getOwnPropertyNames(c);for(R=0;R<I.length;R++){var C,O=I[R];(C=Object.getOwnPropertyDescriptor(c,O))&&C.enumerable||(h[O]=i(c[O],E-1),Object.defineProperty(h,O,{enumerable:!1}));}}return h}(i,c)}function i(e){return Object.prototype.toString.call(e)}function o(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return s.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},s.__objToStr=i,s.__isDate=function(e){return "object"==typeof e&&"[object Date]"===i(e)},s.__isArray=function(e){return "object"==typeof e&&"[object Array]"===i(e)},s.__isRegExp=function(e){return "object"==typeof e&&"[object RegExp]"===i(e)},s.__getRegExpFlags=o,s}();e.exports&&(e.exports=t);}));const Bt={RECONNECTION_ATTEMPTS:{WEBSOCKET:10,POLLING:4},RECONNECTION_DELAY_MAX:5e3,RECONNECTION_DELAY:1e3},xt={SOCKET:e=>({forceNew:!0,reconnection:!1,timeout:e.socketTimeout,path:e.socketServerPath,reconnectionAttempts:Bt.RECONNECTION_ATTEMPTS.WEBSOCKET,reconnectionDelayMax:Bt.RECONNECTION_DELAY_MAX,reconnectionDelay:Bt.RECONNECTION_DELAY,transports:[Ot.WEBSOCKET.toLowerCase()],query:{Skylink_SDK_type:Tt.WEB,Skylink_SDK_version:ft,Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"},extraHeaders:{Skylink_SDK_type:Tt.WEB,Skylink_SDK_version:ft,Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"}}),PEER_CONNECTION:{bundlePolicy:$e.BALANCED,rtcpMuxPolicy:Ye.REQUIRE,iceTransportPolicy:"all",iceCandidatePoolSize:0}},Vt={SOCKET:Bt,MEDIA_OPTIONS:{AUDIO:{stereo:!1,echoCancellation:!0,exactConstraints:!1},VIDEO:{resolution:nt.VGA,frameRate:30,exactConstraints:!1},SCREENSHARE:{video:!0}}},Ht=(e,t)=>t?xt[e](t):xt[e],jt={defaultRoom:null,appKey:null,roomServer:"//api.temasys.io",enableDataChannel:!0,enableSTUNServer:!0,enableTURNServer:!0,socketServerPath:null,enableStatsGathering:!0,audioFallback:!0,socketTimeout:7e3,forceTURNSSL:!1,forceTURN:!1,forceSSL:!0,usePublicSTUN:!1,mcuUseRenegoRestart:!0,useEdgeWebRTC:!1,enableSimultaneousTransfers:!0,TURNServerTransport:He.ANY,credentials:null,iceServer:null,socketServer:null,audioCodec:rt.AUTO,videoCodec:tt.AUTO,codecParams:{audio:{opus:{stereo:null,"sprop-stereo":null,usedtx:null,useinbandfec:null,maxplaybackrate:null,minptime:null}},video:{h264:{profileLevelId:null,levelAsymmetryAllowed:null,packetizationMode:null},vp8:{maxFs:null,maxFr:null},vp9:{maxFs:null,maxFr:null}}},beSilentOnStatsLogs:!1,beSilentOnParseLogs:!1,statsInterval:20};class Wt{constructor(e){this.id=e.room_key,this.token=e.roomCred,this.startDateTime=e.start,this.duration=e.len,this.roomName=e.roomName,this.connection={peerConstraints:JSON.parse(e.pc_constraints),offerConstraints:JSON.parse(e.offer_constraints),sdpConstraints:{},peerConfig:{iceServers:[]},mediaConstraints:JSON.parse(e.media_constraints)},this.isLocked=!1;}}class Kt{constructor(e){this.uid=e.username,this.token=e.userCred,this.timeStamp=e.timeStamp,this.sid=null,this.bufferMessage=null;}}const $t={};class Yt{constructor(e,t){if(Ii(t)&&$t[t])return $t[t];const{offer_constraints:r,pc_constraints:n,cid:s,apiOwner:i,ipSigserver:o,isPrivileged:a,autoIntroduce:c,httpPortList:d,httpsPortList:l,hasMCU:u,ipSigserverPath:p,hasPersistentMessage:S,room_key:E,enable_stats_config:h}=e;r||n||Ut.log.ERROR(["API",null,"init","pc_constraints or offer_constraints are null"]),Ut.log.DEBUG(["API",null,"init","Parsed Peer Connection constraints:"],JSON.parse(n)),Ut.log.DEBUG(["API",null,"init","Parsed Offer constraints"],JSON.parse(r)),this.key=s,this.appKeyOwner=i,this.isPrivileged=a,this.autoIntroduce=c,this.room=new Wt(e),this.user=new Kt(e),this.hasMCU=u,this.socketServer=o,this.socketServerPath=p,this.socketPorts={"http:":Array.isArray(d)&&d.length>0?d:[80,3e3],"https:":Array.isArray(l)&&l.length>0?l:[443,3443]},this.hasPersistentMessage=S,this.enableStatsGathering=h,$t[E]=this;}deleteApiResponseInstance(e){delete $t[e];}}const zt={stats:{endPoints:{client:"/client",session:"/session",auth:"/auth",signaling:"/client/signaling",iceConnection:"/client/iceconnection",iceCandidate:"/client/icecandidate",iceGathering:"/client/icegathering",negotiation:"/client/negotiation",bandwidth:"/client/bandwidth",recording:"/client/recording",dataChannel:"/client/datachannel",userMedia:"/client/usermedia"}}};zt.stats.statsBase="/rest/stats";class Jt{constructor(){this.endpoints=zt.stats.endPoints,this.stats_buffer={},this.bufferTimeout=!1;}postStats(e,t){const{STATS_MODULE:r}=Dt,n=po.getInitOptions().beSilentOnStatsLogs;try{const r=this.processData(t);this.postStatObj(e,n,r);}catch(e){Ut.log.WARN(r.ERRORS.POST_FAILED,e);}}processData(e){return Array.isArray(e)?{client_id:e[0].client_id,data:e}:e}async postStatObj(e,t,r){const{roomServer:n}=po.getInitOptions(),{fetch:s}=window,i=await s(`https:${n}${zt.stats.statsBase}${e}`,{method:"POST",mode:"cors",headers:{"Content-type":"application/json"},body:JSON.stringify(r)});t||i.json().then(t=>{Ut.log.INFO([null,St.STATS,null,""+e],t);}).catch(t=>{Ut.log.INFO([null,St.STATS,null,""+e],t);});}addToStatsBuffer(e,t,r){this.stats_buffer[e]||(this.stats_buffer[e]={},this.stats_buffer[e].url=r,this.stats_buffer[e].data=[]);const n=Object.assign({},t);this.stats_buffer[e].data.push(n);}manageStatsBuffer(){this.bufferTimeout||(this.bufferTimeout=!0,setInterval(()=>{const e=Object.keys(this.stats_buffer);for(let t=0;t<e.length;t+=1)this.stats_buffer[e[t]].data.length>0&&(this.postStats(this.stats_buffer[e[t]].url,this.stats_buffer[e[t]].data),this.stats_buffer[e[t]].data=[]);},5e3));}}class Qt extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,state:null,http_status:null,http_error:null,api_url:null,api_result:null};}send(e,t,r,n){this.model.room_id=e,this.model.http_status=n?-1:r&&r.status?r.status:null,this.model.http_error=("string"==typeof n?n:n&&n.message)||null,this.model.api_url=r&&r.endpoint?r.endpoint:r.url,this.model.client_id=po.getInitOptions().clientId,this.model.app_key=po.getInitOptions().appKey,this.model.state=t,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.auth,this.model);}}const Xt=e=>{const{appKey:t}=e,r={isValid:!0,message:""};return Ut.log.INFO(["API",null,"init","API initialised with options:"],e),t||(r.isValid=!1,r.message=Dt.INIT.ERRORS.NO_APP_KEY,kt(Te({readyState:Xe.ERROR,error:{status:-2,content:new Error(Dt.INIT.ERRORS.NO_APP_KEY),errorCode:qe.NO_PATH},room:null}))),r.isValid||Ut.log.ERROR(["API",null,"init",r.message]),r},qt=e=>{const{ok:t}=e;return (e=>{const{status:t,ok:r}=e,n=r?"INFO":"ERROR";let s=Dt.INIT.INFO.API_SUCCESS;r||(s=Dt.INIT.ERRORS.AUTH_GENERAL,403===t&&(s=Dt.INIT.ERRORS.AUTH_CORS)),Ut.log[n](["API",null,"auth",s],e);})(e),t},Zt=e=>{const t=e;return !0===t.forceTURN&&(t.enableTURNServer=!0,t.enableSTUNServer=!1),t},er=async e=>{const{fetch:t}=window,r=(e=>{const{roomServer:t,appKey:r,defaultRoom:n,credentials:s,forceSSL:i}=e;let o=`${t}/api/${r}/${n}`,a="?";if(o=i?"https:"+o:`${window.location.protocol}${o}`,s){const{startDateTime:e,duration:t}=s;o+=`/${e}/${t}?cred=${s.credentials}`,a="&";}return o+=`${a}rand=${Date.now()}`,o})(e);(new Qt).send(e.defaultRoom,Fe.REQUEST,{endpoint:r});return {endpoint:r,response:await t(r,{headers:{Skylink_SDK_type:Tt.WEB,Skylink_SDK_version:ft,Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"}})}},tr=()=>{const e={ready:!0,message:""};return (()=>{try{const e=new window.RTCPeerConnection(null);return ["object","function"].indexOf(typeof e.createOffer)>-1&&null!==e.createOffer}catch(e){return !1}})()||(e.message="WebRTC not supported. Please upgrade your browser",e.ready=!1,kt(Te({readyState:Xe.ERROR,error:{status:-2,content:new Error(e.message),errorCode:qe.NO_WEBRTC_SUPPORT},room:null}))),e};let rr=null;class nr{constructor(){return rr||(rr=this),this.options={},rr}init(e=jt){e&&(e.socketServer&&!e.socketServerPath&&(e.socketServerPath=""),e.clientId=Di(),po.setUserInitOptions(e)),kt(Te({readyState:Xe.INIT,error:null,room:null}));const t=(()=>{const e={fulfilled:!0,message:""},{AdapterJS:t,io:r,fetch:n}=window,s="Validating Dependencies";return "function"!=typeof(t||window.AdapterJS||window.AdapterJS||{}).webRTCReady?(e.message=Dt.INIT.ERRORS.NO_ADAPTER,e.fulfilled=!1,e.readyStateChangeErrorCode=qe.ADAPTER_NO_LOADED):r||window.io?n&&window.fetch||(e.message=Dt.INIT.ERRORS.NO_FETCH_SUPPORT,e.fulfilled=!1,e.readyStateChangeErrorCode=qe.NO_XMLHTTPREQUEST_SUPPORT):(e.message=Dt.INIT.ERRORS.NO_SOCKET_IO,e.fulfilled=!1,e.readyStateChangeErrorCode=qe.NO_SOCKET_IO),bi(_t.FIREFOX)&&"moz"===t.webrtcDetectedType||bi(_t.SAFARI)||bi(_t.CHROME)&&"webkit"===t.webrtcDetectedType||bi(_t.REACT_NATIVE)||Ut.log.WARN([s,null,null,Dt.INIT.INCOMPATIBLE_BROWSER]),e.fulfilled||Ut.log.ERROR([s,null,null,e.message]),e})(),{AdapterJS:r}=window;if(!t.fulfilled)throw kt(Te({readyState:Xe.ERROR,error:{status:-2,content:new Error(t.message),errorCode:t.readyStateChangeErrorCode},room:null})),new Error(t.message);let n=Object.assign({},jt,e);const s=Xt(n);if(!s.isValid)throw new Error(s.message);return r.webRTCReady(()=>{const e=tr();if(!e.ready)throw new Error(e.message)}),n=Zt(n),n}createRoom(e){return new Promise((t,r)=>{const n=po.getInitOptions();n.defaultRoom=e,er(n).then(n=>{const{endpoint:s,response:i}=n;qt(i)?(kt(Te({readyState:Xe.COMPLETED,error:null,room:e})),i.json().then(e=>{(new Qt).send(e.room_key,Fe.SUCCESS,i),t({endpoint:s,response:e});})):(kt(Te({readyState:Xe.ERROR,error:{status:i.status,content:new Error(i.info||"XMLHttpRequest status not OK\nStatus was: "+i.status),errorCode:i.error||i.status},room:e})),i.json().then(t=>{(new Qt).send(e,Fe.ERROR,i,t.info),r(t);}));}).catch(t=>{kt(Te({readyState:Xe.ERROR,error:{status:t.status||-1,content:new Error(t.message||"Network error occurred"),errorCode:qe.XML_HTTP_REQUEST_ERROR},room:e}));});})}checkCodecSupport(e){return (e=>new Promise((t,r)=>{Bi.getCodecsSupport(e).then(n=>{const s=po.getSkylinkState(e),{room:i}=s;0===Object.keys(n.audio).length&&0===Object.keys(n.video).length?(Ut.log.ERROR(Dt.JOIN_ROOM.ERRORS.CODEC_SUPPORT),kt(Te({readyState:Xe.ERROR,error:{status:-2,content:new Error(Dt.JOIN_ROOM.ERRORS.CODEC_SUPPORT),errorCode:qe.PARSE_CODECS},room:Qs.getRoomInfo(i.id)})),r(new Error(Dt.JOIN_ROOM.ERRORS.CODEC_SUPPORT))):t(!0),s.currentCodecSupport=n,po.setSkylinkState(s);}).catch(t=>{const n=po.getSkylinkState(e),{room:s}=n;Ut.log.ERROR(t),kt(Te({readyState:Xe.ERROR,error:{status:-2,content:new Error(t.message||t.toString()),errorCode:qe.PARSE_CODECS},room:Qs.getRoomInfo(s.id)})),r(new Error(t.message||t.toString()));});}))(e)}static parseAPIResponseBody(e){return new Yt(e)}enforceUserInitOptions(e){return (e=>{const t=po.getUserInitOptions(),r=po.getInitOptions();let n=Object.assign(r,e,t);const s=Xt(n);if(!s.isValid)throw new Error(s.message);return n=Zt(n),po.setInitOptions(n),n})(e)}static getRoomNameFromParams(e){const t=po.getInitOptions(),{roomName:r}=e,{defaultRoom:n}=t;let s=null;return s=void 0!==r&&""!==r&&n!==r?r:n,s}static getStateByKey(e){return Ai(e)}}const sr=e=>{const t=po.getSkylinkState(e.roomKey),r=po.getInitOptions(),{config:n}=e,{socketServer:s,socketTimeout:i,socketServerPath:o}=r,{socketPorts:a}=new Yt(null,e.roomKey),c=Ht("SOCKET",{socketTimeout:i,socketServerPath:o});let d=[];s&&gi(s)&&Array.isArray(s.ports)&&s.ports.length?({ports:d}=s):d=a[n.signalingServerProtocol],(e=>!e.signalingServerPort)(n)?(n.signalingServerPort=d[0],n.fallbackType=et.NON_FALLBACK):((e,t)=>e.indexOf(t.signalingServerPort)===e.length-1)(d,n)||Ii(r.socketServer)?n.socketType===Ot.WEBSOCKET?(n.socketType=Ot.POLLING,n.signalingServerPort=d[0]):(n.socketSession.finalAttempts+=1,n.signalingServerPort=d[0]):n.signalingServerPort=d[d.indexOf(n.signalingServerPort)+1],n.socketType===Ot.POLLING&&(c.reconnectionDelayMax=Vt.SOCKET.RECONNECTION_DELAY_MAX,c.reconnectionAttempts=Vt.SOCKET.RECONNECTION_ATTEMPTS.POLLING,c.transports=[Ot.XHR_POLLING,Ot.JSONP_POLLING,Ot.POLLING.toLowerCase()]);const l=(e=>{const{signalingServerProtocol:t,signalingServer:r,signalingServerPort:n,socketServer:s}=e;let i="";return i=Ii(r)?`${t}//${r}`:r&&gi(r)&&r.protocol?`${r.protocol}//${s.url}:${n}?rand=${Date.now()}`:`${t}//${r}:${n}?rand=${Date.now()}`,i})({signalingServerProtocol:n.signalingServerProtocol,signalingServer:t.socketServer,signalingServerPort:n.signalingServerPort,socketServer:s});return n.socketServer=s,n.socketServerPath=o,t.socketSession=n,po.setSkylinkState(t,e.roomKey),window.io(l,c)},ir=(e,t,r)=>{const n=po.getSkylinkState(e)||Object.values(po.getSkylinkState())[0],{socketSession:s,room:i,user:o}=n;var a;Ut.log.INFO([null,"Socket",null,"Channel closed. Reason - "+r]),n.channelOpen=!1,po.setSkylinkState(n,e),kt((a={socketSession:Ft(s),reason:r,peerId:t},new pe("channelClose",{detail:a}))),i.inRoom&&o&&o.sid&&kt(((e={})=>new pe("sessionDisconnect",{detail:e}))({peerId:t,peerInfo:ei.getCurrentSessionInfo(i),reason:r}));};class or extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,signaling_url:null,signaling_transport:null,attempts:null,error:null};}send(e,t,r,n){const s=po.getSkylinkState(e),{socketSession:i}=s;this.model.room_id=e,this.model.user_id=r||null,this.model.client_id=s.clientId,this.model.state=t,this.model.signaling_url=s.socketSession.socketServer,this.model.signaling_transport=s.socketSession.socketType.toLowerCase(),this.model.attempts=0===i.socketSession.finalAttempts?i.socketSession.attempts:2*i.socketSession.finalAttempts+i.socketSession.attempts,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.attempts="number"==typeof n?n:null,this.model.error=("string"==typeof n?n:n&&n.message)||null,this.postStats(this.endpoints.signaling,this.model);}}const ar=(e,t,r)=>{const n=po.getSkylinkState(r),{socketSession:s,user:i}=n,o=e.socket.id||i.sid||null;var a;(new or).send(r,At.SIGNALING.CONNECT,o,null),n.channelOpen||(n.channelOpen=!0,po.setSkylinkState(n,r)),kt((a={socketSession:Ft(s),peerId:o},new pe("channelOpen",{detail:a}))),t();},cr=(e,t)=>{const r=po.getSkylinkState(e)||Object.values(po.getSkylinkState())[0],n=r.channelOpen,{room:s,user:i}=r;let o=null;const a=i.sid||null;"io client disconnect"!==t&&(o=t),(new or).send(s.id,At.SIGNALING.DISCONNECT,a,o),(n||!n&&e!==s.roomName)&&Er(s.id,a,t);},dr=(e,t,r)=>{const n=po.getSkylinkState(t),{socketSession:s,user:i}=n,o=e.socket.id||i.sid||null;var a;(new or).send(t,At.SIGNALING.ERROR,o,r),Ut.log.ERROR([null,"Socket",null,"Exception occurred ->"],r),kt((a={error:r,socketSession:Ft(s),peerId:o},new pe("channelError",{detail:a})));},lr=e=>_i(e)&&e,ur=(e,t)=>{const r=po.getSkylinkState(e),{detail:n}=t;if(n.state===ze.ENTER){const e=Ft(r.socketMessageQueue);r.user.bufferMessage=!1,r.socketMessageQueue=[],po.setSkylinkState(r,r.room.id),Ut.log.DEBUG([r.user.sid,St.SIG_SERVER,null,`${Dt.SIGNALING.BUFFERED_MESSAGES_SENT}: ${e.length}`]),((e,t)=>{const r=new xs;for(let n=t.length-1;n>=0;n-=1){const s=t[n];if(!s.mid){if(!e.user.sid)return void Ut.log.DEBUG([e.user.sid,St.SIG_SERVER,null,""+Dt.SIGNALING.BUFFERED_MESSAGES_DROPPED]);s.mid=e.user.sid;}r.sendMessage(s),t.splice(n,1);}})(r,e),yt.removeEventListener(vt.HANDSHAKE_PROGRESS,ur);}},pr=e=>{const{rid:t}=e,r=po.getSkylinkState(t),{user:n,room:s}=r;return !Ri(n.bufferMessage)&&!lr(n.bufferMessage)||(e=>{const{JOIN_ROOM:t,ENTER:r,WELCOME:n,OFFER:s,ANSWER:i,ANSWER_ACK:o,CANDIDATE:a,END_OF_CANDIDATES:c}=at;return [t,r,n,s,i,o,a,c].indexOf(e.type)>-1})(e)?(e.type===ze.ENTER&&Ri(n.bufferMessage)&&(Ut.log.DEBUG([n.sid,St.SIG_SERVER,null,Dt.SIGNALING.BUFFER_NOT_NEEDED]),r.user.bufferMessage=!1,r.socketMessageQueue=[],po.setSkylinkState(r,r.room.id)),!1):(Ut.log.DEBUG([n.sid,St.SIG_SERVER,null,Dt.SIGNALING.MESSAGE_ADDED_TO_BUFFER]),r.socketMessageQueue.unshift(e),lr(n.bufferMessage)||(r.user.bufferMessage=!0,Ut.log.DEBUG([n.sid,St.SIG_SERVER,null,Dt.SIGNALING.ENTER_LISTENER]),yt.addEventListener(vt.HANDSHAKE_PROGRESS,ur.bind(void 0,t))),po.setSkylinkState(r,s.id),!0)},Sr=(e,t)=>{((e,t)=>{const{type:r}=t;switch(Ut.log.INFO(["SIG SERVER",null,r,"received"]),r){case at.IN_ROOM:e.inRoomHandler(t);break;case at.ENTER:e.enterRoomHandler(t);break;case at.OFFER:e.offerHandler(t);break;case at.WELCOME:e.welcomeHandler(t);break;case at.ANSWER:e.answerHandler(t);break;case at.ANSWER_ACK:e.answerAckHandler(t);break;case at.CANDIDATE:e.candidateHandler(t);break;case at.PEER_LIST:e.getPeerListHandler(t);break;case at.INTRODUCE_ERROR:e.introduceError(t);break;case at.BYE:e.byeHandler(t);break;case at.STREAM:e.streamHandler(t);break;case at.RECORDING:e.recordingHandler(t);break;case at.REDIRECT:e.redirectHandler(t);break;case at.RTMP:e.rtmpHandler(t);break;case at.UPDATE_USER:e.setUserDataHandler(t);break;case at.MEDIA_INFO_EVENT:e.mediaInfoEventHandler(t);break;case at.MESSAGE:e.userMessageHandler(t,null);break;case at.STORED_MESSAGES:e.storedMessagesHandler(t);break;case at.ROOM_LOCK:e.roomLockHandler(t);break;case at.PUBLIC_MESSAGE:e.userMessageHandler(t,!0);break;case at.PRIVATE_MESSAGE:e.userMessageHandler(t,!1);}})(e,t);},Er=(e,t,r)=>{ir(e,t,r);},hr=(e,t,r)=>{((e,t,r)=>{t.socket.on(Ct.CONNECT,()=>ar(t,r,e)),t.socket.on(Ct.MESSAGE,t.onMessage.bind(t)),t.socket.on(Ct.DISCONNECT,t=>cr(e,t)),t.socket.on(Ct.ERROR,r=>dr(t,e,r));})(e,t,r);};var mr=A((function(e,t){var r;e.exports=(r=r||function(e,t){var r=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),n={},s=n.lib={},i=s.Base={extend:function(e){var t=r(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments);}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString);},clone:function(){return this.init.prototype.extend(this)}},o=s.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length;},toString:function(e){return (e||c).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,s=e.sigBytes;if(this.clamp(),n%4)for(var i=0;i<s;i++){var o=r[i>>>2]>>>24-i%4*8&255;t[n+i>>>2]|=o<<24-(n+i)%4*8;}else for(i=0;i<s;i+=4)t[n+i>>>2]=r[i>>>2];return this.sigBytes+=s,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4);},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r,n=[],s=function(t){t=t;var r=987654321,n=4294967295;return function(){var s=((r=36969*(65535&r)+(r>>16)&n)<<16)+(t=18e3*(65535&t)+(t>>16)&n)&n;return s/=4294967296,(s+=.5)*(e.random()>.5?1:-1)}},i=0;i<t;i+=4){var a=s(4294967296*(r||e.random()));r=987654071*a(),n.push(4294967296*a()|0);}return new o.init(n,t)}}),a=n.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s++){var i=t[s>>>2]>>>24-s%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16));}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new o.init(r,t/2)}},d=a.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s++){var i=t[s>>>2]>>>24-s%4*8&255;n.push(String.fromCharCode(i));}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new o.init(r,t)}},l=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},u=s.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new o.init,this._nDataBytes=0;},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes;},_process:function(t){var r=this._data,n=r.words,s=r.sigBytes,i=this.blockSize,a=s/(4*i),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*i,d=e.min(4*c,s);if(c){for(var l=0;l<c;l+=i)this._doProcessBlock(n,l);var u=n.splice(0,c);r.sigBytes-=d;}return new o.init(u,d)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),p=(s.Hasher=u.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset();},reset:function(){u.reset.call(this),this._doReset();},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new p.HMAC.init(e,r).finalize(t)}}}),n.algo={});return n}(Math),r);})),gr=(A((function(e,t){var r,n,s,i,o,a;e.exports=(n=(r=a=mr).lib,s=n.Base,i=n.WordArray,(o=r.x64={}).Word=s.extend({init:function(e,t){this.high=e,this.low=t;}}),o.WordArray=s.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:8*e.length;},toX32:function(){for(var e=this.words,t=e.length,r=[],n=0;n<t;n++){var s=e[n];r.push(s.high),r.push(s.low);}return i.create(r,this.sigBytes)},clone:function(){for(var e=s.clone.call(this),t=e.words=this.words.slice(0),r=t.length,n=0;n<r;n++)t[n]=t[n].clone();return e}}),a);})),A((function(e,t){var r;e.exports=(r=mr,function(){if("function"==typeof ArrayBuffer){var e=r.lib.WordArray,t=e.init;(e.init=function(e){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var r=e.byteLength,n=[],s=0;s<r;s++)n[s>>>2]|=e[s]<<24-s%4*8;t.call(this,n,r);}else t.apply(this,arguments);}).prototype=e;}}(),r.lib.WordArray);})),A((function(e,t){var r;e.exports=(r=mr,function(){var e=r,t=e.lib.WordArray,n=e.enc;function s(e){return e<<8&4278255360|e>>>8&16711935}n.Utf16=n.Utf16BE={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s+=2){var i=t[s>>>2]>>>16-s%4*8&65535;n.push(String.fromCharCode(i));}return n.join("")},parse:function(e){for(var r=e.length,n=[],s=0;s<r;s++)n[s>>>1]|=e.charCodeAt(s)<<16-s%2*16;return t.create(n,2*r)}},n.Utf16LE={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i+=2){var o=s(t[i>>>2]>>>16-i%4*8&65535);n.push(String.fromCharCode(o));}return n.join("")},parse:function(e){for(var r=e.length,n=[],i=0;i<r;i++)n[i>>>1]|=s(e.charCodeAt(i)<<16-i%2*16);return t.create(n,2*r)}};}(),r.enc.Utf16);})),A((function(e,t){var r,n,s;e.exports=(n=(r=s=mr).lib.WordArray,r.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var s=[],i=0;i<r;i+=3)for(var o=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,a=0;a<4&&i+.75*a<r;a++)s.push(n.charAt(o>>>6*(3-a)&63));var c=n.charAt(64);if(c)for(;s.length%4;)s.push(c);return s.join("")},parse:function(e){var t=e.length,r=this._map,s=this._reverseMap;if(!s){s=this._reverseMap=[];for(var i=0;i<r.length;i++)s[r.charCodeAt(i)]=i;}var o=r.charAt(64);if(o){var a=e.indexOf(o);-1!==a&&(t=a);}return function(e,t,r){for(var s=[],i=0,o=0;o<t;o++)if(o%4){var a=r[e.charCodeAt(o-1)]<<o%4*2,c=r[e.charCodeAt(o)]>>>6-o%4*2;s[i>>>2]|=(a|c)<<24-i%4*8,i++;}return n.create(s,i)}(e,t,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},s.enc.Base64);})),A((function(e,t){var r;e.exports=(r=mr,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0;}();var c=o.MD5=i.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878]);},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var n=t+r,s=e[n];e[n]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8);}var i=this._hash.words,o=e[t+0],c=e[t+1],S=e[t+2],E=e[t+3],h=e[t+4],m=e[t+5],g=e[t+6],R=e[t+7],f=e[t+8],T=e[t+9],_=e[t+10],I=e[t+11],C=e[t+12],O=e[t+13],A=e[t+14],v=e[t+15],N=i[0],D=i[1],y=i[2],P=i[3];N=d(N,D,y,P,o,7,a[0]),P=d(P,N,D,y,c,12,a[1]),y=d(y,P,N,D,S,17,a[2]),D=d(D,y,P,N,E,22,a[3]),N=d(N,D,y,P,h,7,a[4]),P=d(P,N,D,y,m,12,a[5]),y=d(y,P,N,D,g,17,a[6]),D=d(D,y,P,N,R,22,a[7]),N=d(N,D,y,P,f,7,a[8]),P=d(P,N,D,y,T,12,a[9]),y=d(y,P,N,D,_,17,a[10]),D=d(D,y,P,N,I,22,a[11]),N=d(N,D,y,P,C,7,a[12]),P=d(P,N,D,y,O,12,a[13]),y=d(y,P,N,D,A,17,a[14]),N=l(N,D=d(D,y,P,N,v,22,a[15]),y,P,c,5,a[16]),P=l(P,N,D,y,g,9,a[17]),y=l(y,P,N,D,I,14,a[18]),D=l(D,y,P,N,o,20,a[19]),N=l(N,D,y,P,m,5,a[20]),P=l(P,N,D,y,_,9,a[21]),y=l(y,P,N,D,v,14,a[22]),D=l(D,y,P,N,h,20,a[23]),N=l(N,D,y,P,T,5,a[24]),P=l(P,N,D,y,A,9,a[25]),y=l(y,P,N,D,E,14,a[26]),D=l(D,y,P,N,f,20,a[27]),N=l(N,D,y,P,O,5,a[28]),P=l(P,N,D,y,S,9,a[29]),y=l(y,P,N,D,R,14,a[30]),N=u(N,D=l(D,y,P,N,C,20,a[31]),y,P,m,4,a[32]),P=u(P,N,D,y,f,11,a[33]),y=u(y,P,N,D,I,16,a[34]),D=u(D,y,P,N,A,23,a[35]),N=u(N,D,y,P,c,4,a[36]),P=u(P,N,D,y,h,11,a[37]),y=u(y,P,N,D,R,16,a[38]),D=u(D,y,P,N,_,23,a[39]),N=u(N,D,y,P,O,4,a[40]),P=u(P,N,D,y,o,11,a[41]),y=u(y,P,N,D,E,16,a[42]),D=u(D,y,P,N,g,23,a[43]),N=u(N,D,y,P,T,4,a[44]),P=u(P,N,D,y,C,11,a[45]),y=u(y,P,N,D,v,16,a[46]),N=p(N,D=u(D,y,P,N,S,23,a[47]),y,P,o,6,a[48]),P=p(P,N,D,y,R,10,a[49]),y=p(y,P,N,D,A,15,a[50]),D=p(D,y,P,N,m,21,a[51]),N=p(N,D,y,P,C,6,a[52]),P=p(P,N,D,y,E,10,a[53]),y=p(y,P,N,D,_,15,a[54]),D=p(D,y,P,N,c,21,a[55]),N=p(N,D,y,P,f,6,a[56]),P=p(P,N,D,y,v,10,a[57]),y=p(y,P,N,D,g,15,a[58]),D=p(D,y,P,N,O,21,a[59]),N=p(N,D,y,P,h,6,a[60]),P=p(P,N,D,y,I,10,a[61]),y=p(y,P,N,D,S,15,a[62]),D=p(D,y,P,N,T,21,a[63]),i[0]=i[0]+N|0,i[1]=i[1]+D|0,i[2]=i[2]+y|0,i[3]=i[3]+P|0;},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,s=8*t.sigBytes;r[s>>>5]|=128<<24-s%32;var i=e.floor(n/4294967296),o=n;r[15+(s+64>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),r[14+(s+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(r.length+1),this._process();for(var a=this._hash,c=a.words,d=0;d<4;d++){var l=c[d];c[d]=16711935&(l<<8|l>>>24)|4278255360&(l<<24|l>>>8);}return a},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});function d(e,t,r,n,s,i,o){var a=e+(t&r|~t&n)+s+o;return (a<<i|a>>>32-i)+t}function l(e,t,r,n,s,i,o){var a=e+(t&n|r&~n)+s+o;return (a<<i|a>>>32-i)+t}function u(e,t,r,n,s,i,o){var a=e+(t^r^n)+s+o;return (a<<i|a>>>32-i)+t}function p(e,t,r,n,s,i,o){var a=e+(r^(t|~n))+s+o;return (a<<i|a>>>32-i)+t}t.MD5=i._createHelper(c),t.HmacMD5=i._createHmacHelper(c);}(Math),r.MD5);})),A((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=mr).lib,s=n.WordArray,i=n.Hasher,o=r.algo,a=[],c=o.SHA1=i.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],c=r[4],d=0;d<80;d++){if(d<16)a[d]=0|e[t+d];else{var l=a[d-3]^a[d-8]^a[d-14]^a[d-16];a[d]=l<<1|l>>>31;}var u=(n<<5|n>>>27)+c+a[d];u+=d<20?1518500249+(s&i|~s&o):d<40?1859775393+(s^i^o):d<60?(s&i|s&o|i&o)-1894007588:(s^i^o)-899497514,c=o,o=i,i=s<<30|s>>>2,s=n,n=u;}r[0]=r[0]+n|0,r[1]=r[1]+s|0,r[2]=r[2]+i|0,r[3]=r[3]+o|0,r[4]=r[4]+c|0;},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(n+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}}),r.SHA1=i._createHelper(c),r.HmacSHA1=i._createHmacHelper(c),d.SHA1);})),A((function(e,t){var r;e.exports=(r=mr,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=[],c=[];!function(){function t(t){for(var r=e.sqrt(t),n=2;n<=r;n++)if(!(t%n))return !1;return !0}function r(e){return 4294967296*(e-(0|e))|0}for(var n=2,s=0;s<64;)t(n)&&(s<8&&(a[s]=r(e.pow(n,.5))),c[s]=r(e.pow(n,1/3)),s++),n++;}();var d=[],l=o.SHA256=i.extend({_doReset:function(){this._hash=new s.init(a.slice(0));},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],a=r[4],l=r[5],u=r[6],p=r[7],S=0;S<64;S++){if(S<16)d[S]=0|e[t+S];else{var E=d[S-15],h=(E<<25|E>>>7)^(E<<14|E>>>18)^E>>>3,m=d[S-2],g=(m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10;d[S]=h+d[S-7]+g+d[S-16];}var R=n&s^n&i^s&i,f=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),T=p+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&l^~a&u)+c[S]+d[S];p=u,u=l,l=a,a=o+T|0,o=i,i=s,s=n,n=T+(f+R)|0;}r[0]=r[0]+n|0,r[1]=r[1]+s|0,r[2]=r[2]+i|0,r[3]=r[3]+o|0,r[4]=r[4]+a|0,r[5]=r[5]+l|0,r[6]=r[6]+u|0,r[7]=r[7]+p|0;},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,s=8*t.sigBytes;return r[s>>>5]|=128<<24-s%32,r[14+(s+64>>>9<<4)]=e.floor(n/4294967296),r[15+(s+64>>>9<<4)]=n,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=i._createHelper(l),t.HmacSHA256=i._createHmacHelper(l);}(Math),r.SHA256);})),A((function(e,t){var r,n,s,i,o,a;e.exports=(n=(r=a=mr).lib.WordArray,s=r.algo,i=s.SHA256,o=s.SHA224=i.extend({_doReset:function(){this._hash=new n.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]);},_doFinalize:function(){var e=i._doFinalize.call(this);return e.sigBytes-=4,e}}),r.SHA224=i._createHelper(o),r.HmacSHA224=i._createHmacHelper(o),a.SHA224);})),A((function(e,t){var r;e.exports=(r=mr,function(){var e=r,t=e.lib.Hasher,n=e.x64,s=n.Word,i=n.WordArray,o=e.algo;function a(){return s.create.apply(s,arguments)}var c=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],d=[];!function(){for(var e=0;e<80;e++)d[e]=a();}();var l=o.SHA512=t.extend({_doReset:function(){this._hash=new i.init([new s.init(1779033703,4089235720),new s.init(3144134277,2227873595),new s.init(1013904242,4271175723),new s.init(2773480762,1595750129),new s.init(1359893119,2917565137),new s.init(2600822924,725511199),new s.init(528734635,4215389547),new s.init(1541459225,327033209)]);},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],a=r[4],l=r[5],u=r[6],p=r[7],S=n.high,E=n.low,h=s.high,m=s.low,g=i.high,R=i.low,f=o.high,T=o.low,_=a.high,I=a.low,C=l.high,O=l.low,A=u.high,v=u.low,N=p.high,D=p.low,y=S,P=E,M=h,k=m,w=g,b=R,L=f,G=T,U=_,F=I,B=C,x=O,V=A,H=v,j=N,W=D,K=0;K<80;K++){var $=d[K];if(K<16)var Y=$.high=0|e[t+2*K],z=$.low=0|e[t+2*K+1];else{var J=d[K-15],Q=J.high,X=J.low,q=(Q>>>1|X<<31)^(Q>>>8|X<<24)^Q>>>7,Z=(X>>>1|Q<<31)^(X>>>8|Q<<24)^(X>>>7|Q<<25),ee=d[K-2],te=ee.high,re=ee.low,ne=(te>>>19|re<<13)^(te<<3|re>>>29)^te>>>6,se=(re>>>19|te<<13)^(re<<3|te>>>29)^(re>>>6|te<<26),ie=d[K-7],oe=ie.high,ae=ie.low,ce=d[K-16],de=ce.high,le=ce.low;Y=(Y=(Y=q+oe+((z=Z+ae)>>>0<Z>>>0?1:0))+ne+((z+=se)>>>0<se>>>0?1:0))+de+((z+=le)>>>0<le>>>0?1:0),$.high=Y,$.low=z;}var ue,pe=U&B^~U&V,Se=F&x^~F&H,Ee=y&M^y&w^M&w,he=P&k^P&b^k&b,me=(y>>>28|P<<4)^(y<<30|P>>>2)^(y<<25|P>>>7),ge=(P>>>28|y<<4)^(P<<30|y>>>2)^(P<<25|y>>>7),Re=(U>>>14|F<<18)^(U>>>18|F<<14)^(U<<23|F>>>9),fe=(F>>>14|U<<18)^(F>>>18|U<<14)^(F<<23|U>>>9),Te=c[K],_e=Te.high,Ie=Te.low,Ce=j+Re+((ue=W+fe)>>>0<W>>>0?1:0),Oe=ge+he;j=V,W=H,V=B,H=x,B=U,x=F,U=L+(Ce=(Ce=(Ce=Ce+pe+((ue+=Se)>>>0<Se>>>0?1:0))+_e+((ue+=Ie)>>>0<Ie>>>0?1:0))+Y+((ue+=z)>>>0<z>>>0?1:0))+((F=G+ue|0)>>>0<G>>>0?1:0)|0,L=w,G=b,w=M,b=k,M=y,k=P,y=Ce+(me+Ee+(Oe>>>0<ge>>>0?1:0))+((P=ue+Oe|0)>>>0<ue>>>0?1:0)|0;}E=n.low=E+P,n.high=S+y+(E>>>0<P>>>0?1:0),m=s.low=m+k,s.high=h+M+(m>>>0<k>>>0?1:0),R=i.low=R+b,i.high=g+w+(R>>>0<b>>>0?1:0),T=o.low=T+G,o.high=f+L+(T>>>0<G>>>0?1:0),I=a.low=I+F,a.high=_+U+(I>>>0<F>>>0?1:0),O=l.low=O+x,l.high=C+B+(O>>>0<x>>>0?1:0),v=u.low=v+H,u.high=A+V+(v>>>0<H>>>0?1:0),D=p.low=D+W,p.high=N+j+(D>>>0<W>>>0?1:0);},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(n+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=t.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32});e.SHA512=t._createHelper(l),e.HmacSHA512=t._createHmacHelper(l);}(),r.SHA512);})),A((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=mr).x64,s=n.Word,i=n.WordArray,o=r.algo,a=o.SHA512,c=o.SHA384=a.extend({_doReset:function(){this._hash=new i.init([new s.init(3418070365,3238371032),new s.init(1654270250,914150663),new s.init(2438529370,812702999),new s.init(355462360,4144912697),new s.init(1731405415,4290775857),new s.init(2394180231,1750603025),new s.init(3675008525,1694076839),new s.init(1203062813,3204075428)]);},_doFinalize:function(){var e=a._doFinalize.call(this);return e.sigBytes-=16,e}}),r.SHA384=a._createHelper(c),r.HmacSHA384=a._createHmacHelper(c),d.SHA384);})),A((function(e,t){var r;e.exports=(r=mr,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.x64.Word,a=t.algo,c=[],d=[],l=[];!function(){for(var e=1,t=0,r=0;r<24;r++){c[e+5*t]=(r+1)*(r+2)/2%64;var n=(2*e+3*t)%5;e=t%5,t=n;}for(e=0;e<5;e++)for(t=0;t<5;t++)d[e+5*t]=t+(2*e+3*t)%5*5;for(var s=1,i=0;i<24;i++){for(var a=0,u=0,p=0;p<7;p++){if(1&s){var S=(1<<p)-1;S<32?u^=1<<S:a^=1<<S-32;}128&s?s=s<<1^113:s<<=1;}l[i]=o.create(a,u);}}();var u=[];!function(){for(var e=0;e<25;e++)u[e]=o.create();}();var p=a.SHA3=i.extend({cfg:i.cfg.extend({outputLength:512}),_doReset:function(){for(var e=this._state=[],t=0;t<25;t++)e[t]=new o.init;this.blockSize=(1600-2*this.cfg.outputLength)/32;},_doProcessBlock:function(e,t){for(var r=this._state,n=this.blockSize/2,s=0;s<n;s++){var i=e[t+2*s],o=e[t+2*s+1];i=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),o=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),(D=r[s]).high^=o,D.low^=i;}for(var a=0;a<24;a++){for(var p=0;p<5;p++){for(var S=0,E=0,h=0;h<5;h++)S^=(D=r[p+5*h]).high,E^=D.low;var m=u[p];m.high=S,m.low=E;}for(p=0;p<5;p++){var g=u[(p+4)%5],R=u[(p+1)%5],f=R.high,T=R.low;for(S=g.high^(f<<1|T>>>31),E=g.low^(T<<1|f>>>31),h=0;h<5;h++)(D=r[p+5*h]).high^=S,D.low^=E;}for(var _=1;_<25;_++){var I=(D=r[_]).high,C=D.low,O=c[_];O<32?(S=I<<O|C>>>32-O,E=C<<O|I>>>32-O):(S=C<<O-32|I>>>64-O,E=I<<O-32|C>>>64-O);var A=u[d[_]];A.high=S,A.low=E;}var v=u[0],N=r[0];for(v.high=N.high,v.low=N.low,p=0;p<5;p++)for(h=0;h<5;h++){var D=r[_=p+5*h],y=u[_],P=u[(p+1)%5+5*h],M=u[(p+2)%5+5*h];D.high=y.high^~P.high&M.high,D.low=y.low^~P.low&M.low;}D=r[0];var k=l[a];D.high^=k.high,D.low^=k.low;}},_doFinalize:function(){var t=this._data,r=t.words,n=(this._nDataBytes,8*t.sigBytes),i=32*this.blockSize;r[n>>>5]|=1<<24-n%32,r[(e.ceil((n+1)/i)*i>>>5)-1]|=128,t.sigBytes=4*r.length,this._process();for(var o=this._state,a=this.cfg.outputLength/8,c=a/8,d=[],l=0;l<c;l++){var u=o[l],p=u.high,S=u.low;p=16711935&(p<<8|p>>>24)|4278255360&(p<<24|p>>>8),S=16711935&(S<<8|S>>>24)|4278255360&(S<<24|S>>>8),d.push(S),d.push(p);}return new s.init(d,a)},clone:function(){for(var e=i.clone.call(this),t=e._state=this._state.slice(0),r=0;r<25;r++)t[r]=t[r].clone();return e}});t.SHA3=i._createHelper(p),t.HmacSHA3=i._createHmacHelper(p);}(Math),r.SHA3);})),A((function(e,t){var r;e.exports=(r=mr,
  /** @preserve
    	(c) 2012 by Cdric Mesnil. All rights reserved.

    	Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

    	    - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
    	    - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

    	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
    	*/
  function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=s.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),c=s.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),d=s.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),l=s.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),u=s.create([0,1518500249,1859775393,2400959708,2840853838]),p=s.create([1352829926,1548603684,1836072691,2053994217,0]),S=o.RIPEMD160=i.extend({_doReset:function(){this._hash=s.create([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var n=t+r,s=e[n];e[n]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8);}var i,o,S,T,_,I,C,O,A,v,N,D=this._hash.words,y=u.words,P=p.words,M=a.words,k=c.words,w=d.words,b=l.words;for(I=i=D[0],C=o=D[1],O=S=D[2],A=T=D[3],v=_=D[4],r=0;r<80;r+=1)N=i+e[t+M[r]]|0,N+=r<16?E(o,S,T)+y[0]:r<32?h(o,S,T)+y[1]:r<48?m(o,S,T)+y[2]:r<64?g(o,S,T)+y[3]:R(o,S,T)+y[4],N=(N=f(N|=0,w[r]))+_|0,i=_,_=T,T=f(S,10),S=o,o=N,N=I+e[t+k[r]]|0,N+=r<16?R(C,O,A)+P[0]:r<32?g(C,O,A)+P[1]:r<48?m(C,O,A)+P[2]:r<64?h(C,O,A)+P[3]:E(C,O,A)+P[4],N=(N=f(N|=0,b[r]))+v|0,I=v,v=A,A=f(O,10),O=C,C=N;N=D[1]+S+A|0,D[1]=D[2]+T+v|0,D[2]=D[3]+_+I|0,D[3]=D[4]+i+C|0,D[4]=D[0]+o+O|0,D[0]=N;},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),e.sigBytes=4*(t.length+1),this._process();for(var s=this._hash,i=s.words,o=0;o<5;o++){var a=i[o];i[o]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8);}return s},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});function E(e,t,r){return e^t^r}function h(e,t,r){return e&t|~e&r}function m(e,t,r){return (e|~t)^r}function g(e,t,r){return e&r|t&~r}function R(e,t,r){return e^(t|~r)}function f(e,t){return e<<t|e>>>32-t}t.RIPEMD160=i._createHelper(S),t.HmacRIPEMD160=i._createHmacHelper(S);}(Math),r.RIPEMD160);})),A((function(e,t){var r,n,s;e.exports=(n=(r=mr).lib.Base,s=r.enc.Utf8,void(r.algo.HMAC=n.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=s.parse(t));var r=e.blockSize,n=4*r;t.sigBytes>n&&(t=e.finalize(t)),t.clamp();for(var i=this._oKey=t.clone(),o=this._iKey=t.clone(),a=i.words,c=o.words,d=0;d<r;d++)a[d]^=1549556828,c[d]^=909522486;i.sigBytes=o.sigBytes=n,this.reset();},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey);},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})));})),A((function(e,t){var r,n,s,i,o,a,c,d,l;e.exports=(n=(r=l=mr).lib,s=n.Base,i=n.WordArray,o=r.algo,a=o.SHA1,c=o.HMAC,d=o.PBKDF2=s.extend({cfg:s.extend({keySize:4,hasher:a,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e);},compute:function(e,t){for(var r=this.cfg,n=c.create(r.hasher,e),s=i.create(),o=i.create([1]),a=s.words,d=o.words,l=r.keySize,u=r.iterations;a.length<l;){var p=n.update(t).finalize(o);n.reset();for(var S=p.words,E=S.length,h=p,m=1;m<u;m++){h=n.finalize(h),n.reset();for(var g=h.words,R=0;R<E;R++)S[R]^=g[R];}s.concat(p),d[0]++;}return s.sigBytes=4*l,s}}),r.PBKDF2=function(e,t,r){return d.create(r).compute(e,t)},l.PBKDF2);})),A((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=mr).lib,s=n.Base,i=n.WordArray,o=r.algo,a=o.MD5,c=o.EvpKDF=s.extend({cfg:s.extend({keySize:4,hasher:a,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e);},compute:function(e,t){for(var r=this.cfg,n=r.hasher.create(),s=i.create(),o=s.words,a=r.keySize,c=r.iterations;o.length<a;){d&&n.update(d);var d=n.update(e).finalize(t);n.reset();for(var l=1;l<c;l++)d=n.finalize(d),n.reset();s.concat(d);}return s.sigBytes=4*a,s}}),r.EvpKDF=function(e,t,r){return c.create(r).compute(e,t)},d.EvpKDF);})),A((function(e,t){var r,n,s,i,o,a,c,d,l,u,p,S,E,h,m,g,R,f,T;e.exports=void((r=mr).lib.Cipher||(n=r,s=n.lib,i=s.Base,o=s.WordArray,a=s.BufferedBlockAlgorithm,c=n.enc,c.Utf8,d=c.Base64,l=n.algo.EvpKDF,u=s.Cipher=a.extend({cfg:i.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset();},reset:function(){a.reset.call(this),this._doReset();},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function e(e){return "string"==typeof e?T:R}return function(t){return {encrypt:function(r,n,s){return e(n).encrypt(t,r,n,s)},decrypt:function(r,n,s){return e(n).decrypt(t,r,n,s)}}}}()}),s.StreamCipher=u.extend({_doFinalize:function(){return this._process(!0)},blockSize:1}),p=n.mode={},S=s.BlockCipherMode=i.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t;}}),E=p.CBC=function(){var e=S.extend();function t(e,t,r){var n=this._iv;if(n){var s=n;this._iv=void 0;}else s=this._prevBlock;for(var i=0;i<r;i++)e[t+i]^=s[i];}return e.Encryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize;t.call(this,e,r,s),n.encryptBlock(e,r),this._prevBlock=e.slice(r,r+s);}}),e.Decryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize,i=e.slice(r,r+s);n.decryptBlock(e,r),t.call(this,e,r,s),this._prevBlock=i;}}),e}(),h=(n.pad={}).Pkcs7={pad:function(e,t){for(var r=4*t,n=r-e.sigBytes%r,s=n<<24|n<<16|n<<8|n,i=[],a=0;a<n;a+=4)i.push(s);var c=o.create(i,n);e.concat(c);},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},s.BlockCipher=u.extend({cfg:u.cfg.extend({mode:E,padding:h}),reset:function(){u.reset.call(this);var e=this.cfg,t=e.iv,r=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var n=r.createEncryptor;else n=r.createDecryptor,this._minBufferSize=1;this._mode&&this._mode.__creator==n?this._mode.init(this,t&&t.words):(this._mode=n.call(r,this,t&&t.words),this._mode.__creator=n);},_doProcessBlock:function(e,t){this._mode.processBlock(e,t);},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0);}else t=this._process(!0),e.unpad(t);return t},blockSize:4}),m=s.CipherParams=i.extend({init:function(e){this.mixIn(e);},toString:function(e){return (e||this.formatter).stringify(this)}}),g=(n.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,r=e.salt;if(r)var n=o.create([1398893684,1701076831]).concat(r).concat(t);else n=t;return n.toString(d)},parse:function(e){var t=d.parse(e),r=t.words;if(1398893684==r[0]&&1701076831==r[1]){var n=o.create(r.slice(2,4));r.splice(0,4),t.sigBytes-=16;}return m.create({ciphertext:t,salt:n})}},R=s.SerializableCipher=i.extend({cfg:i.extend({format:g}),encrypt:function(e,t,r,n){n=this.cfg.extend(n);var s=e.createEncryptor(r,n),i=s.finalize(t),o=s.cfg;return m.create({ciphertext:i,key:r,iv:o.iv,algorithm:e,mode:o.mode,padding:o.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(r,n).finalize(t.ciphertext)},_parse:function(e,t){return "string"==typeof e?t.parse(e,this):e}}),f=(n.kdf={}).OpenSSL={execute:function(e,t,r,n){n||(n=o.random(8));var s=l.create({keySize:t+r}).compute(e,n),i=o.create(s.words.slice(t),4*r);return s.sigBytes=4*t,m.create({key:s,iv:i,salt:n})}},T=s.PasswordBasedCipher=R.extend({cfg:R.cfg.extend({kdf:f}),encrypt:function(e,t,r,n){var s=(n=this.cfg.extend(n)).kdf.execute(r,e.keySize,e.ivSize);n.iv=s.iv;var i=R.encrypt.call(this,e,t,s.key,n);return i.mixIn(s),i},decrypt:function(e,t,r,n){n=this.cfg.extend(n),t=this._parse(t,n.format);var s=n.kdf.execute(r,e.keySize,e.ivSize,t.salt);return n.iv=s.iv,R.decrypt.call(this,e,t,s.key,n)}})));})),A((function(e,t){var r;e.exports=((r=mr).mode.CFB=function(){var e=r.lib.BlockCipherMode.extend();function t(e,t,r,n){var s=this._iv;if(s){var i=s.slice(0);this._iv=void 0;}else i=this._prevBlock;n.encryptBlock(i,0);for(var o=0;o<r;o++)e[t+o]^=i[o];}return e.Encryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize;t.call(this,e,r,s,n),this._prevBlock=e.slice(r,r+s);}}),e.Decryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize,i=e.slice(r,r+s);t.call(this,e,r,s,n),this._prevBlock=i;}}),e}(),r.mode.CFB);})),A((function(e,t){var r,n,s;e.exports=((s=mr).mode.CTR=(r=s.lib.BlockCipherMode.extend(),n=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,s=this._iv,i=this._counter;s&&(i=this._counter=s.slice(0),this._iv=void 0);var o=i.slice(0);r.encryptBlock(o,0),i[n-1]=i[n-1]+1|0;for(var a=0;a<n;a++)e[t+a]^=o[a];}}),r.Decryptor=n,r),s.mode.CTR);})),A((function(e,t){var r;e.exports=(
  /** @preserve
    	 * Counter block mode compatible with  Dr Brian Gladman fileenc.c
    	 * derived from CryptoJS.mode.CTR
    	 * Jan Hruby jhruby.web@gmail.com
    	 */
  (r=mr).mode.CTRGladman=function(){var e=r.lib.BlockCipherMode.extend();function t(e){if(255==(e>>24&255)){var t=e>>16&255,r=e>>8&255,n=255&e;255===t?(t=0,255===r?(r=0,255===n?n=0:++n):++r):++t,e=0,e+=t<<16,e+=r<<8,e+=n;}else e+=1<<24;return e}var n=e.Encryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize,i=this._iv,o=this._counter;i&&(o=this._counter=i.slice(0),this._iv=void 0),function(e){0===(e[0]=t(e[0]))&&(e[1]=t(e[1]));}(o);var a=o.slice(0);n.encryptBlock(a,0);for(var c=0;c<s;c++)e[r+c]^=a[c];}});return e.Decryptor=n,e}(),r.mode.CTRGladman);})),A((function(e,t){var r,n,s;e.exports=((s=mr).mode.OFB=(r=s.lib.BlockCipherMode.extend(),n=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,s=this._iv,i=this._keystream;s&&(i=this._keystream=s.slice(0),this._iv=void 0),r.encryptBlock(i,0);for(var o=0;o<n;o++)e[t+o]^=i[o];}}),r.Decryptor=n,r),s.mode.OFB);})),A((function(e,t){var r,n;e.exports=((n=mr).mode.ECB=((r=n.lib.BlockCipherMode.extend()).Encryptor=r.extend({processBlock:function(e,t){this._cipher.encryptBlock(e,t);}}),r.Decryptor=r.extend({processBlock:function(e,t){this._cipher.decryptBlock(e,t);}}),r),n.mode.ECB);})),A((function(e,t){var r;e.exports=((r=mr).pad.AnsiX923={pad:function(e,t){var r=e.sigBytes,n=4*t,s=n-r%n,i=r+s-1;e.clamp(),e.words[i>>>2]|=s<<24-i%4*8,e.sigBytes+=s;},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},r.pad.Ansix923);})),A((function(e,t){var r;e.exports=((r=mr).pad.Iso10126={pad:function(e,t){var n=4*t,s=n-e.sigBytes%n;e.concat(r.lib.WordArray.random(s-1)).concat(r.lib.WordArray.create([s<<24],1));},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},r.pad.Iso10126);})),A((function(e,t){var r;e.exports=((r=mr).pad.Iso97971={pad:function(e,t){e.concat(r.lib.WordArray.create([2147483648],1)),r.pad.ZeroPadding.pad(e,t);},unpad:function(e){r.pad.ZeroPadding.unpad(e),e.sigBytes--;}},r.pad.Iso97971);})),A((function(e,t){var r;e.exports=((r=mr).pad.ZeroPadding={pad:function(e,t){var r=4*t;e.clamp(),e.sigBytes+=r-(e.sigBytes%r||r);},unpad:function(e){for(var t=e.words,r=e.sigBytes-1;!(t[r>>>2]>>>24-r%4*8&255);)r--;e.sigBytes=r+1;}},r.pad.ZeroPadding);})),A((function(e,t){var r;e.exports=((r=mr).pad.NoPadding={pad:function(){},unpad:function(){}},r.pad.NoPadding);})),A((function(e,t){var r,n,s,i;e.exports=(n=(r=i=mr).lib.CipherParams,s=r.enc.Hex,r.format.Hex={stringify:function(e){return e.ciphertext.toString(s)},parse:function(e){var t=s.parse(e);return n.create({ciphertext:t})}},i.format.Hex);})),A((function(e,t){var r;e.exports=(r=mr,function(){var e=r,t=e.lib.BlockCipher,n=e.algo,s=[],i=[],o=[],a=[],c=[],d=[],l=[],u=[],p=[],S=[];!function(){for(var e=[],t=0;t<256;t++)e[t]=t<128?t<<1:t<<1^283;var r=0,n=0;for(t=0;t<256;t++){var E=n^n<<1^n<<2^n<<3^n<<4;E=E>>>8^255&E^99,s[r]=E,i[E]=r;var h=e[r],m=e[h],g=e[m],R=257*e[E]^16843008*E;o[r]=R<<24|R>>>8,a[r]=R<<16|R>>>16,c[r]=R<<8|R>>>24,d[r]=R,R=16843009*g^65537*m^257*h^16843008*r,l[E]=R<<24|R>>>8,u[E]=R<<16|R>>>16,p[E]=R<<8|R>>>24,S[E]=R,r?(r=h^e[e[e[g^h]]],n^=e[e[n]]):r=n=1;}}();var E=[0,1,2,4,8,16,32,64,128,27,54],h=n.AES=t.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var e=this._keyPriorReset=this._key,t=e.words,r=e.sigBytes/4,n=4*((this._nRounds=r+6)+1),i=this._keySchedule=[],o=0;o<n;o++)if(o<r)i[o]=t[o];else{var a=i[o-1];o%r?r>6&&o%r==4&&(a=s[a>>>24]<<24|s[a>>>16&255]<<16|s[a>>>8&255]<<8|s[255&a]):(a=s[(a=a<<8|a>>>24)>>>24]<<24|s[a>>>16&255]<<16|s[a>>>8&255]<<8|s[255&a],a^=E[o/r|0]<<24),i[o]=i[o-r]^a;}for(var c=this._invKeySchedule=[],d=0;d<n;d++)o=n-d,a=d%4?i[o]:i[o-4],c[d]=d<4||o<=4?a:l[s[a>>>24]]^u[s[a>>>16&255]]^p[s[a>>>8&255]]^S[s[255&a]];}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,o,a,c,d,s);},decryptBlock:function(e,t){var r=e[t+1];e[t+1]=e[t+3],e[t+3]=r,this._doCryptBlock(e,t,this._invKeySchedule,l,u,p,S,i),r=e[t+1],e[t+1]=e[t+3],e[t+3]=r;},_doCryptBlock:function(e,t,r,n,s,i,o,a){for(var c=this._nRounds,d=e[t]^r[0],l=e[t+1]^r[1],u=e[t+2]^r[2],p=e[t+3]^r[3],S=4,E=1;E<c;E++){var h=n[d>>>24]^s[l>>>16&255]^i[u>>>8&255]^o[255&p]^r[S++],m=n[l>>>24]^s[u>>>16&255]^i[p>>>8&255]^o[255&d]^r[S++],g=n[u>>>24]^s[p>>>16&255]^i[d>>>8&255]^o[255&l]^r[S++],R=n[p>>>24]^s[d>>>16&255]^i[l>>>8&255]^o[255&u]^r[S++];d=h,l=m,u=g,p=R;}h=(a[d>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&p])^r[S++],m=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[p>>>8&255]<<8|a[255&d])^r[S++],g=(a[u>>>24]<<24|a[p>>>16&255]<<16|a[d>>>8&255]<<8|a[255&l])^r[S++],R=(a[p>>>24]<<24|a[d>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^r[S++],e[t]=h,e[t+1]=m,e[t+2]=g,e[t+3]=R;},keySize:8});e.AES=t._createHelper(h);}(),r.AES);})),A((function(e,t){var r;e.exports=(r=mr,function(){var e=r,t=e.lib,n=t.WordArray,s=t.BlockCipher,i=e.algo,o=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],d=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],l=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],u=i.DES=s.extend({_doReset:function(){for(var e=this._key.words,t=[],r=0;r<56;r++){var n=o[r]-1;t[r]=e[n>>>5]>>>31-n%32&1;}for(var s=this._subKeys=[],i=0;i<16;i++){var d=s[i]=[],l=c[i];for(r=0;r<24;r++)d[r/6|0]|=t[(a[r]-1+l)%28]<<31-r%6,d[4+(r/6|0)]|=t[28+(a[r+24]-1+l)%28]<<31-r%6;for(d[0]=d[0]<<1|d[0]>>>31,r=1;r<7;r++)d[r]=d[r]>>>4*(r-1)+3;d[7]=d[7]<<5|d[7]>>>27;}var u=this._invSubKeys=[];for(r=0;r<16;r++)u[r]=s[15-r];},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys);},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys);},_doCryptBlock:function(e,t,r){this._lBlock=e[t],this._rBlock=e[t+1],p.call(this,4,252645135),p.call(this,16,65535),S.call(this,2,858993459),S.call(this,8,16711935),p.call(this,1,1431655765);for(var n=0;n<16;n++){for(var s=r[n],i=this._lBlock,o=this._rBlock,a=0,c=0;c<8;c++)a|=d[c][((o^s[c])&l[c])>>>0];this._lBlock=o,this._rBlock=i^a;}var u=this._lBlock;this._lBlock=this._rBlock,this._rBlock=u,p.call(this,1,1431655765),S.call(this,8,16711935),S.call(this,2,858993459),p.call(this,16,65535),p.call(this,4,252645135),e[t]=this._lBlock,e[t+1]=this._rBlock;},keySize:2,ivSize:2,blockSize:2});function p(e,t){var r=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=r,this._lBlock^=r<<e;}function S(e,t){var r=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=r,this._rBlock^=r<<e;}e.DES=s._createHelper(u);var E=i.TripleDES=s.extend({_doReset:function(){var e=this._key.words;this._des1=u.createEncryptor(n.create(e.slice(0,2))),this._des2=u.createEncryptor(n.create(e.slice(2,4))),this._des3=u.createEncryptor(n.create(e.slice(4,6)));},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t);},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t);},keySize:6,ivSize:2,blockSize:2});e.TripleDES=s._createHelper(E);}(),r.TripleDES);})),A((function(e,t){var r;e.exports=(r=mr,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=n.RC4=t.extend({_doReset:function(){for(var e=this._key,t=e.words,r=e.sigBytes,n=this._S=[],s=0;s<256;s++)n[s]=s;s=0;for(var i=0;s<256;s++){var o=s%r,a=t[o>>>2]>>>24-o%4*8&255;i=(i+n[s]+a)%256;var c=n[s];n[s]=n[i],n[i]=c;}this._i=this._j=0;},_doProcessBlock:function(e,t){e[t]^=i.call(this);},keySize:8,ivSize:0});function i(){for(var e=this._S,t=this._i,r=this._j,n=0,s=0;s<4;s++){r=(r+e[t=(t+1)%256])%256;var i=e[t];e[t]=e[r],e[r]=i,n|=e[(e[t]+e[r])%256]<<24-8*s;}return this._i=t,this._j=r,n}e.RC4=t._createHelper(s);var o=n.RC4Drop=s.extend({cfg:s.cfg.extend({drop:192}),_doReset:function(){s._doReset.call(this);for(var e=this.cfg.drop;e>0;e--)i.call(this);}});e.RC4Drop=t._createHelper(o);}(),r.RC4);})),A((function(e,t){var r;e.exports=(r=mr,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=[],i=[],o=[],a=n.Rabbit=t.extend({_doReset:function(){for(var e=this._key.words,t=this.cfg.iv,r=0;r<4;r++)e[r]=16711935&(e[r]<<8|e[r]>>>24)|4278255360&(e[r]<<24|e[r]>>>8);var n=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],s=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];for(this._b=0,r=0;r<4;r++)c.call(this);for(r=0;r<8;r++)s[r]^=n[r+4&7];if(t){var i=t.words,o=i[0],a=i[1],d=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),l=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),u=d>>>16|4294901760&l,p=l<<16|65535&d;for(s[0]^=d,s[1]^=u,s[2]^=l,s[3]^=p,s[4]^=d,s[5]^=u,s[6]^=l,s[7]^=p,r=0;r<4;r++)c.call(this);}},_doProcessBlock:function(e,t){var r=this._X;c.call(this),s[0]=r[0]^r[5]>>>16^r[3]<<16,s[1]=r[2]^r[7]>>>16^r[5]<<16,s[2]=r[4]^r[1]>>>16^r[7]<<16,s[3]=r[6]^r[3]>>>16^r[1]<<16;for(var n=0;n<4;n++)s[n]=16711935&(s[n]<<8|s[n]>>>24)|4278255360&(s[n]<<24|s[n]>>>8),e[t+n]^=s[n];},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,r=0;r<8;r++)i[r]=t[r];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<i[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<i[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<i[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<i[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<i[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<i[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<i[6]>>>0?1:0)|0,this._b=t[7]>>>0<i[7]>>>0?1:0,r=0;r<8;r++){var n=e[r]+t[r],s=65535&n,a=n>>>16,c=((s*s>>>17)+s*a>>>15)+a*a,d=((4294901760&n)*n|0)+((65535&n)*n|0);o[r]=c^d;}e[0]=o[0]+(o[7]<<16|o[7]>>>16)+(o[6]<<16|o[6]>>>16)|0,e[1]=o[1]+(o[0]<<8|o[0]>>>24)+o[7]|0,e[2]=o[2]+(o[1]<<16|o[1]>>>16)+(o[0]<<16|o[0]>>>16)|0,e[3]=o[3]+(o[2]<<8|o[2]>>>24)+o[1]|0,e[4]=o[4]+(o[3]<<16|o[3]>>>16)+(o[2]<<16|o[2]>>>16)|0,e[5]=o[5]+(o[4]<<8|o[4]>>>24)+o[3]|0,e[6]=o[6]+(o[5]<<16|o[5]>>>16)+(o[4]<<16|o[4]>>>16)|0,e[7]=o[7]+(o[6]<<8|o[6]>>>24)+o[5]|0;}e.Rabbit=t._createHelper(a);}(),r.Rabbit);})),A((function(e,t){var r;e.exports=(r=mr,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=[],i=[],o=[],a=n.RabbitLegacy=t.extend({_doReset:function(){var e=this._key.words,t=this.cfg.iv,r=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],n=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];this._b=0;for(var s=0;s<4;s++)c.call(this);for(s=0;s<8;s++)n[s]^=r[s+4&7];if(t){var i=t.words,o=i[0],a=i[1],d=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),l=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),u=d>>>16|4294901760&l,p=l<<16|65535&d;for(n[0]^=d,n[1]^=u,n[2]^=l,n[3]^=p,n[4]^=d,n[5]^=u,n[6]^=l,n[7]^=p,s=0;s<4;s++)c.call(this);}},_doProcessBlock:function(e,t){var r=this._X;c.call(this),s[0]=r[0]^r[5]>>>16^r[3]<<16,s[1]=r[2]^r[7]>>>16^r[5]<<16,s[2]=r[4]^r[1]>>>16^r[7]<<16,s[3]=r[6]^r[3]>>>16^r[1]<<16;for(var n=0;n<4;n++)s[n]=16711935&(s[n]<<8|s[n]>>>24)|4278255360&(s[n]<<24|s[n]>>>8),e[t+n]^=s[n];},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,r=0;r<8;r++)i[r]=t[r];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<i[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<i[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<i[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<i[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<i[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<i[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<i[6]>>>0?1:0)|0,this._b=t[7]>>>0<i[7]>>>0?1:0,r=0;r<8;r++){var n=e[r]+t[r],s=65535&n,a=n>>>16,c=((s*s>>>17)+s*a>>>15)+a*a,d=((4294901760&n)*n|0)+((65535&n)*n|0);o[r]=c^d;}e[0]=o[0]+(o[7]<<16|o[7]>>>16)+(o[6]<<16|o[6]>>>16)|0,e[1]=o[1]+(o[0]<<8|o[0]>>>24)+o[7]|0,e[2]=o[2]+(o[1]<<16|o[1]>>>16)+(o[0]<<16|o[0]>>>16)|0,e[3]=o[3]+(o[2]<<8|o[2]>>>24)+o[1]|0,e[4]=o[4]+(o[3]<<16|o[3]>>>16)+(o[2]<<16|o[2]>>>16)|0,e[5]=o[5]+(o[4]<<8|o[4]>>>24)+o[3]|0,e[6]=o[6]+(o[5]<<16|o[5]>>>16)+(o[4]<<16|o[4]>>>16)|0,e[7]=o[7]+(o[6]<<8|o[6]>>>24)+o[5]|0;}e.RabbitLegacy=t._createHelper(a);}(),r.RabbitLegacy);})),A((function(e,t){e.exports=mr;})));const Rr={isExisting:(e,t)=>Object.keys(t).filter(t=>t===e).length>0,isValidString:e=>{if(!Ii(e)||!Ii(e)||mi(e))throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return !0},hasCrypto:()=>gr||(Ut.log.ERROR([null,St.ASYNC_MESSAGING,null,Dt.PERSISTENT_MESSAGE.ERRORS.NO_DEPENDENCY]),!1),canEncrypt:(e,t)=>{if(Ei(t)&&mi(e))throw new Error(`${Dt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED}, ${Dt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_PROVIDED}`);if(mi(e))throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_SELECTED);if(Ei(t))throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return !0},canDecrypt:e=>{if(Ei(e))throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return !0}};class fr{static throwError(e="",t=""){throw Ut.log.ERROR([null,St.SKYLINK_ERROR,null,`${e}${t?" - "+t:""}`]),new Error(`${e}${t?" - "+t:""}`)}}const Tr={getMessageConfig:(e,t)=>{const{peerInformations:r,room:n,user:s}=e;let i,o=!1;if(!n.inRoom||!s)throw Error(Dt.ROOM.ERRORS.NOT_IN_ROOM);return Array.isArray(t)&&!hi(t)?(i=t,o=!0):t&&Ii(t)?(i=[t],o=!0):i=Object.keys(r),i.forEach((e,t)=>{r[e]?e===It.MCU&&i.splice(t,1):(Ut.log.WARN([e,St.MESSAGING,null,`${Dt.MESSAGING.ERRORS.DROPPING_MESSAGE} - ${Dt.PEER_CONNECTION.NO_PEER_CONNECTION}`]),i.splice(t,1));}),0===i.length&&Ut.log.WARN([null,St.MESSAGING,null,Dt.PEER_CONNECTION.NO_PEER_CONNECTION]),{listOfPeers:i,isPrivate:o}},sendMessageToSig:(e,t,r,n="",s)=>{(new xs).sendUserMessage(e,t,n||r),Tr.dispatchOnIncomingMessage(e,t,r,!0,s);},dispatchOnIncomingMessage:(e,t,r,n,s)=>{const{room:i,user:o}=e;Ut.log.DEBUG([n?null:s,St.MESSAGING,null,`${Dt.MESSAGING.RECEIVED_MESSAGE} - isPrivate: ${t.isPrivate}`]);const a={targetPeerId:n?t.isPrivate?s:null:o.sid,content:r,senderPeerId:n?o.sid:s,isDataChannel:!1,isPrivate:t.isPrivate,timeStamp:Gi()};n&&(a.listOfPeers=t.listOfPeers),kt(Re({room:Qs.getRoomInfo(i.id),message:a,isSelf:n,peerId:n?o.sid:s,peerInfo:n?ei.getCurrentSessionInfo(i):ei.getPeerInfo(s,i)}));},trySendMessage:(e,t,r)=>{try{const n=Tr.getMessageConfig(e,r);Tr.sendMessageToSig(e,n,t,null,r);}catch(e){fr.throwError(Dt.MESSAGING.ERRORS.FAILED_SENDING_MESSAGE);}}},_r={deleteEncryptSecrets:(e,t,r)=>{const n={encryptSecrets:e,selectedSecretId:t};if(r){if(!n.encryptSecrets[r])throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);n.selectedSecretId===r&&(n.selectedSecretId=_r.setSelectedSecretId()),delete n.encryptSecrets[r];}else Ut.log.DEBUG([null,St.ENCRYPTED_MESSAGING,null,""+Dt.MESSAGING.ENCRYPTION.DELETE_ALL]),n.selectedSecretId=_r.setSelectedSecretId(),n.encryptSecrets={};return n},setEncryptSecret:(e,t,r)=>{const n=e;if((e=>{if(!e)throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!_r.utils.isValidString(e))throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return !0})(t)&&((e,t)=>{if(!e)throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!_r.utils.isValidString(e))throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);if(_r.utils.isExisting(e,t))throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_UNIQUE);return !0})(r,n))return n[r]=t,n},setSelectedSecretId:(e,t)=>{if(!t)return "";if(_r.utils.isValidString(t),!e[t])throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return t},utils:Rr,getMessageConfig:(e,t,r,n,s)=>{const i=Tr.getMessageConfig(e,t);return _r.utils.hasCrypto()&&_r.utils.canEncrypt(n,r)&&(i.secretId=n),s&&(i.isPersistent=s),i},encryptMessage:(e,t,r=!1)=>{if(r)try{return gr.AES.decrypt(e,t).toString(gr.enc.Utf8)}catch(e){throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET)}return gr.AES.encrypt(e,t).toString()},tryDecryptMessage:(e,t,r)=>{const n=_r.encryptMessage(e,r[t],!0);if(mi(n))throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET);return n}},Ir=e=>{const t=Zs.getCurrentSessionInfo(e);return delete t.room,t},Cr={};class Or{constructor(e){const{room:t,user:r}=e;return Cr[t.id]||(Cr[t.id]=this),this.room=t,this.peerId=r.sid,this.encryptSecrets={},this.selectedSecretId="",Cr[t.id]}setEncryptSecret(e,t){try{this.encryptSecrets=_r.setEncryptSecret(this.encryptSecrets,e,t),this.dispatchEncryptSecretEvent();}catch(e){fr.throwError(Dt.MESSAGING.ENCRYPTION.ERRORS.SET_ENCRYPT_SECRET,e.message);}}getEncryptSecrets(){return this.encryptSecrets}deleteEncryptSecrets(e){try{const t=_r.deleteEncryptSecrets(this.encryptSecrets,this.selectedSecretId,e);this.encryptSecrets=t.encryptSecrets,this.selectedSecretId=t.selectedSecretId,this.dispatchEncryptSecretEvent();}catch(e){fr.throwError(Dt.MESSAGING.ENCRYPTION.ERRORS.DELETE_ENCRYPT_SECRETS,e.message);}}setSelectedSecretId(e){try{this.selectedSecretId=_r.setSelectedSecretId(this.encryptSecrets,e),this.dispatchEncryptSecretEvent();}catch(e){fr.throwError(Dt.MESSAGING.ENCRYPTION.ERRORS.SET_SELECTED_SECRET,e.message);}}getSelectedSecretId(){return this.selectedSecretId}dispatchEncryptSecretEvent(){kt(((e={})=>new pe("encryptSecretsUpdated",{detail:e}))({room:Qs.getRoomInfo(this.room.id),encryptSecrets:this.encryptSecrets,selectedSecretId:this.selectedSecretId,peerInfo:Ir(this.room),peerId:this.peerId}));}canEncrypt(e){try{return !!_r.utils.canEncrypt(this.selectedSecretId,this.encryptSecrets)&&(_r.utils.isValidString(this.selectedSecretId)&&_r.utils.isValidString(this.encryptSecrets[this.selectedSecretId]))}catch(t){if(e)throw new Error(t.message);return !1}}decryptStoredMessages(e,t){if(_r.utils.canEncrypt(t,this.encryptSecrets)&&!Object.keys(this.encryptSecrets).filter(e=>e===t).length)throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return this.decryptMessage(e,t)}decryptMessage(e,t=""){if(t&&_r.utils.canDecrypt(this.encryptSecrets))return _r.tryDecryptMessage(e,t,this.encryptSecrets);throw new Error(Dt.MESSAGING.ENCRYPTION.ERRORS.INVALID_SECRETS)}sendMessage(e,t,r,n=!1){const s=vi(e);if(Ci(t,"message","sendMessage")&&s)try{Ut.log.DEBUG([null,St.ASYNC_MESSAGING,null,Dt.MESSAGING.ENCRYPTION.SEND_MESSAGE]);const e=_r.getMessageConfig(s,r,this.encryptSecrets,this.selectedSecretId,n),i=_r.encryptMessage(t,this.encryptSecrets[this.selectedSecretId]);Tr.sendMessageToSig(s,e,t,i,r);}catch(e){fr.throwError(Dt.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message);}}static deleteEncryptedInstance(e){delete Cr[e.id];}}const Ar=(e,t)=>({targetPeerId:t,senderPeerId:e.mid,content:e.data,timeStamp:Li(e.timeStamp),isPrivate:!1,isDataChannel:!1}),vr={};class Nr{constructor(e){const{user:t,room:r,hasPersistentMessage:n}=e;return vr[r.id]||(vr[r.id]=this),this.room=r,this.peerId=t.sid,this.isPersistent=n,this.hasPersistentMessage=n,vr[r.id]}setMessagePersistence(e){if(!_i(e))throw fr.throwError(Dt.MESSAGING.PERSISTENCE.ERRORS.FAILED_SETTING_PERSISTENCE,Dt.MESSAGING.PERSISTENCE.ERRORS.INVALID_TYPE);if(!this.hasPersistentMessage)throw this.isPersistent=e,fr.throwError(Dt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);this.isPersistent=e,kt(((e={})=>new pe("persistentMessageState",{detail:e}))({room:Qs.getRoomInfo(this.room.id),isPersistent:this.isPersistent,peerInfo:Ir(this.room),peerId:this.peerId}));}getMessagePersistence(){return this.isPersistent}sendMessage(e,t,r){const n=vi(e),s=!r||Array.isArray(r)&&hi(r);if(Ci(t,"message","sendMessage")&&n)try{Ut.log.DEBUG([null,St.ASYNC_MESSAGING,null,Dt.MESSAGING.PERSISTENCE.SEND_MESSAGE]);const i=new Or(n);if(!s)throw new Error(Dt.MESSAGING.PERSISTENCE.ERRORS.PRIVATE_MESSAGE);i.canEncrypt(!0)&&i.sendMessage(e,t,r,this.isPersistent);}catch(e){fr.throwError(Dt.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message);}}getStoredMessages(){const e=po.getSkylinkState(this.room.id);this.hasPersistentMessage?(new xs).getStoredMessages(e):Ut.log.WARN([this.peerId,St.ASYNC_MESSAGING,null,""+Dt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED]);}canPersist(){if(this.hasPersistentMessage)return !!this.isPersistent||(Ut.log.DEBUG([null,St.ASYNC_MESSAGING,null,Dt.MESSAGING.PERSISTENCE.NOT_PERSISTED]),!1);if(this.isPersistent)throw Ut.log.DEBUG([null,St.ASYNC_MESSAGING,null,`${Dt.MESSAGING.PERSISTENCE.IS_PERSISTENT_CONFIG} ${this.isPersistent}`]),new Error(Dt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);return !1}static processStoredMessages(e){const t=po.getSkylinkState(e.rid),{room:r}=t,n=e.mid,s=JSON.parse(e.data),i=new Or(t),o=[];Ut.log.DEBUG([n,St.ASYNC_MESSAGING,null,Dt.MESSAGING.PERSISTENCE.STORED_MESSAGES],s);try{for(let e=0;e<s.length;e+=1)s[e].data=i.decryptStoredMessages(s[e].data,s[e].secretId),o.push(Ar(s[e],n));}catch(e){throw fr.throwError(Dt.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}kt(((e={})=>new pe("storedMessages",{detail:e}))({room:Qs.getRoomInfo(r.id),storedMessages:o,isSelf:!1,peerId:n,peerInfo:ei.getPeerInfo(n,r)}));}static deleteAsyncInstance(e){delete vr[e.id];}}class Dr{static sendMessage(e,t,r){const n=vi(e);if(Ci(t,"message","sendMessage")&&n){const s=new Or(n),i=new Nr(n);i.canPersist()?i.sendMessage(e,t,r):s.canEncrypt()?s.sendMessage(e,t,r):Tr.trySendMessage(n,t,r);}}static sendP2PMessage(e,t,r){const n=vi(e);Ci(t,"message","sendP2PMessage")&&n&&ji.sendP2PMessage(e,t,r);}static processMessage(e,t){const{mid:r,target:n,rid:s,secretId:i,data:o}=e,a=po.getSkylinkState(s),c=r;let d=o;if(i)try{d=new Or(a).decryptMessage(o,i);}catch(e){fr.throwError(Dt.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message);}Tr.dispatchOnIncomingMessage(a,{isPrivate:_i(t)?!t:!!n},d,!1,c);}}const yr={udp:[3478,19302,19303,19304],tcp:[80,443],both:[19305,19306,19307,19308]},Pr={STUN:"stun",TURN:"turn",TEMASYS:"temasys",DEFAULT_TURN_SERVER:"turn.temasys.io",TCP:"TCP",UDP:"UDP"},Mr=(e,t)=>{const{urls:r}=e;return [{urls:r,username:t.iceServers[1].username||null,credential:t.iceServers[1].credential||null}]};class kr extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:!1,candidate_id:null,candidate_sdp_mid:null,candidate_sdp_mindex:null,candidate_candidate:null,error:null};}send(e,t,r,n,s,i){const o=po.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=r,this.model.client_id=o.clientId,this.model.state=t,this.model.is_remote=!!n,this.model.candidate_id=n||null,this.model.candidate_sdp_mid=s.sdpMid,this.model.candidate_sdp_mindex=s.sdpMLineIndex,this.model.candidate_candidate=s.candidate,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.error=("string"==typeof i?i:i&&i.message)||null,this.addToStatsBuffer("iceCandidate",this.model,this.endpoints.iceCandidate),this.manageStatsBuffer();}}const wr=new kr,br=(e,t,r,n,s,i)=>{const{STATS_MODULE:o,ICE_CANDIDATE:a}=Dt,{CANDIDATE_PROCESSING_STATE:c,TAGS:d}=Nt;Ut.log.ERROR([t,d.CANDIDATE_HANDLER,`${r}:${n}`,a.FAILED_ADDING_CANDIDATE],i),kt(_e({room:Qs.getRoomInfo(e.id),state:c.PROCESS_ERROR,peerId:t,candidateId:r,candidateType:n,candidate:s,error:i})),wr.send(e.id,o.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,t,r,s,i);};const Lr=new class extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,bundlePolicy:null,rtcpMuxPolicy:null};}send(e,t,r,n){const s=po.getSkylinkState(e);this.model.client_id=s.clientId,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=r,this.model.state=t,this.model.is_remote=n,this.model.bundlePolicy=Ht("PEER_CONNECTION").bundlePolicy,this.model.rtcpMuxPolicy=Ht("PEER_CONNECTION").rtcpMuxPolicy,this.addToStatsBuffer("iceGathering",this.model,this.endpoints.iceGathering),this.manageStatsBuffer();}},Gr=e=>{const t=po.getInitOptions(),r={iceServerName:null,iceServerPorts:yr,iceServerProtocol:Pr.STUN,iceServers:[{urls:[]},{urls:[]}]},{iceServer:n,enableTURNServer:s,forceTURNSSL:i,TURNServerTransport:o,enableSTUNServer:a,usePublicSTUN:c}=t;if(e.forEach(e=>{if(0===e.url.indexOf(Pr.STUN+":"))e.url.indexOf(""+Pr.TEMASYS)>0?r.iceServerName=(e.url.split(":")[1]||"").split("?")[0]||null:r.iceServers[0].urls.push(e.url);else if(0===e.url.indexOf("turn:")&&e.url.indexOf("@")>0&&e.credential&&!r.iceServers[1].username&&!r.iceServers[1].credential){const t=(e.url.split(":")[1]||"").split("@");r.iceServerName=(t[1]||"").split("?")[0],r.iceServers[1].username=t[0],r.iceServers[1].credential=e.credential,r.iceServerProtocol=Pr.TURN;}}),n)return {iceServers:Mr(n,r)};if(r.iceServerName=r.iceServerName||Pr.DEFAULT_TURN_SERVER,r.iceServerProtocol!==Pr.TURN||s||i){const e=(e=>{const{forceTURNSSL:t,serverConfig:r}=e,n={tcp:r.iceServerPorts.tcp,udp:r.iceServerPorts.udp,both:r.iceServerPorts.both,iceServerProtocol:r.iceServerProtocol,iceServerPorts:r.iceServerPorts};return t?(n.iceServerPorts.udp=[],n.iceServerProtocol="turns"):bi(_t.FIREFOX)&&(n.udp=[3478],n.both=[]),n})({forceTURNSSL:i,enableTURNServer:s,CONSTANTS:Pr,serverConfig:r});r.iceServerPorts.tcp=e.tcp,r.iceServerPorts.udp=e.udp,r.iceServerPorts.both=e.both,r.iceServerProtocol=e.iceServerProtocol;}else r.iceServerProtocol=Pr.STUN;const d=(e=>{const{TURNServerTransport:t,forceTURNSSL:r,udp:n,tcp:s,both:i}=e,o={udp:[],tcp:[],both:[]};return t!==He.UDP||r?t===He.TCP?(o.tcp=s.concat(i),o.udp=[],o.both=[]):t===He.NONE?(o.tcp=[],o.udp=[]):(o.tcp=s,o.udp=n,o.both=i):(o.udp=n.concat(i),o.tcp=[],o.both=[]),o})({forceTURNSSL:i,TURNServerTransport:o,udp:r.iceServerPorts.udp,tcp:r.iceServerPorts.tcp,both:r.iceServerPorts.both});return r.iceServerPorts.tcp=d.tcp,r.iceServerPorts.udp=d.udp,r.iceServerPorts.both=d.both,r.iceServerProtocol===Pr.STUN&&(r.iceServerPorts.tcp=[]),r.iceServerProtocol!==Pr.STUN||a?(r.iceServerPorts.tcp.forEach(e=>{r.iceServers[1].urls.push(`${r.iceServerProtocol}:${r.iceServerName}:${e}?transport=tcp`);}),r.iceServerPorts.udp.forEach(e=>{r.iceServers[1].urls.push(`${r.iceServerProtocol}:${r.iceServerName}:${e}?transport=udp`);}),r.iceServerPorts.both.forEach(e=>{r.iceServers[1].urls.push(`${r.iceServerProtocol}:${r.iceServerName}:${e}`);}),c||r.iceServers.splice(0,1),{iceServers:r.iceServers}):(r.iceServers=[],null)},Ur=(e,t)=>{const r=po.getSkylinkState(t.id),n=r.peerCandidatesQueue[e]||[],s=r.peerConnections[e],{TAGS:i,PEER_CONNECTION_STATE:o}=Nt;for(let t=0;t<n.length;t+=1){const a=n[t];if(a){const t=a[1],n=a[0],s=t.candidate.split(" ")[7];Ut.log.DEBUG([e,i.CANDIDATE_HANDLER,`${n}:${s}`,Dt.ICE_CANDIDATE.ADD_BUFFERED_CANDIDATE]),Vr.addIceCandidate(e,n,s,t,r);}else if(s&&s.signalingState!==o.CLOSED)try{s.addIceCandidate(null),Ut.log.DEBUG([e,i.CANDIDATE_HANDLER,null,Dt.ICE_CANDIDATE.CANDIDATE_ADDED]);}catch(t){Ut.log.DEBUG([e,i.CANDIDATE_HANDLER,null,Dt.ICE_CANDIDATE.FAILED_ADDING_CANDIDATE]);}}delete r.peerCandidatesQueue[e],ji.signalingEndOfCandidates(e,r);},Fr=(e,t,r,n,s)=>{const i=po.getSkylinkState(s.room.id),{peerConnections:o,room:a}=i,c=o[e],d={candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex},{STATS_MODULE:l,ICE_CANDIDATE:u,PEER_CONNECTION:p}=Dt,{CANDIDATE_PROCESSING_STATE:S,PEER_CONNECTION_STATE:E,TAGS:h}=Nt;Ut.log.DEBUG([e,h.CANDIDATE_HANDLER,`${t}:${r}`,u.ADDING_CANDIDATE]),kt(_e({peerId:e,room:Qs.getRoomInfo(a.id),candidateType:r,candidate:d,candidateId:t,state:S.PROCESSING,error:null})),wr.send(a.id,l.HANDLE_ICE_GATHERING_STATS.PROCESSING,e,t,d),c&&c.signalingState!==E.CLOSED&&c.remoteDescription&&c.remoteDescription.sdp&&c.remoteDescription.sdp.indexOf(`\r\na=mid:${d.sdpMid}\r\n`)>-1||(Ut.log.WARN([e,h.CANDIDATE_HANDLER,`${t}:${r}`,`${u.DROPPING_CANDIDATE} - ${p.NO_PEER_CONNECTION}`]),kt(_e({peerId:e,room:Qs.getRoomInfo(a.id),candidateType:r,candidate:d,candidateId:t,state:xe.DROPPED,error:new Error(p.NO_PEER_CONNECTION)})),wr.send(a.id,l.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,e,t,d,p.NO_PEER_CONNECTION));try{c.addIceCandidate(d).then(()=>{((e,t,r,n,s)=>{const{STATS_MODULE:i,ICE_CANDIDATE:o}=Dt,{CANDIDATE_PROCESSING_STATE:a,TAGS:c}=Nt;Ut.log.INFO([t,c.CANDIDATE_HANDLER,`${r}:${n}`,o.CANDIDATE_ADDED]),kt(_e({room:Qs.getRoomInfo(e.id),state:a.PROCESS_SUCCESS,peerId:t,candidateId:r,candidateType:n,candidate:s,error:null})),wr.send(e.id,i.HANDLE_ICE_GATHERING_STATS.PROCESS_SUCCESS,t,r,s);})(a,e,t,r,d);}).catch(n=>{br(a,e,t,r,d,n);});}catch(n){br.bind(c,a,e,t,r,d,n);}},Br=(e,t,r)=>{const n=po.getSkylinkState(r.id),s=n.peerConnections[e],i=new xs;let o=n.gatheredCandidates[e];const{CANDIDATE_GENERATION_STATE:a,TAGS:c}=Nt;if(!s)return Ut.log.WARN([e,c.CANDIDATE_HANDLER,null,Dt.PEER_CONNECTION.NO_PEER_CONNECTION],t),null;if(t.candidate){s.gathering||(Ut.log.WARN([e,c.CANDIDATE_HANDLER,null,Dt.ICE_CONNECTION.ICE_GATHERING_STARTED],t),s.gathering=!0,s.gathered=!1,kt(Ie({room:Qs.getRoomInfo(r.id),peerId:e,state:Be.GATHERING})),Lr.send(r.id,a.GATHERING,e,!1));const d=t.candidate.split(" ")[7];if(Ut.log.DEBUG([e,c.CANDIDATE_HANDLER,d,Dt.ICE_CANDIDATE.CANDIDATE_GENERATED],t),"endOfCandidates"===d||!(s&&s.localDescription&&s.localDescription.sdp&&s.localDescription.sdp.indexOf(`\r\na=mid:${t.sdpMid}\r\n`)>-1))return Ut.log.WARN([e,c.CANDIDATE_HANDLER,d,Dt.ICE_CONNECTION.DROP_EOC],t),null;o||(o={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),o.sending[d].push({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),n.gatheredCandidates[e]=o,po.setSkylinkState(n,r.id),Ut.log.DEBUG([e,c.CANDIDATE_HANDLER,d,Dt.ICE_CANDIDATE.SENDING_CANDIDATE],t),i.sendCandidate(e,n,t);}else{if(Ut.log.INFO([e,c.CANDIDATE_HANDLER,null,Dt.ICE_CONNECTION.ICE_GATHERING_COMPLETED]),s.gathered)return null;if(s.gathering=!1,s.gathered=!0,kt(Ie({peerId:e,state:Be.COMPLETED,room:r})),Lr.send(r.id,a.COMPLETED,e,!1),n.gatheredCandidates[e]){setTimeout(()=>{if(!n.gatheredCandidates[e])return;po.getSkylinkState(r.id)?i.sendMessage({type:at.END_OF_CANDIDATES,noOfExpectedCandidates:n.gatheredCandidates[e].sending.srflx.length+n.gatheredCandidates[e].sending.host.length+n.gatheredCandidates[e].sending.relay.length,mid:n.user.sid,target:e,rid:r.id}):Ut.log.WARN([e,c.CANDIDATE_HANDLER,null,Dt.ICE_CONNECTION.DROP_EOC+" peer has left the room"]);},6e3);}}return null},xr=(e,t,r,n,s)=>{const{STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:i}}=Dt,o=s,{room:a}=o,c=new kr;Ut.log.DEBUG([e,St.CANDIDATE_HANDLER,`${t}:${r}`,Dt.ICE_CANDIDATE.ADD_CANDIDATE_TO_BUFFER]),c.send(a.id,i.BUFFERED,e,t,n),kt(_e({room:Qs.getRoomInfo(a.id),state:xe.BUFFERED,peerId:e,candidateId:t,candidateType:r,candidate:n.candidate,error:null})),o.peerCandidatesQueue[e]=o.peerCandidatesQueue[e]||[],o.peerCandidatesQueue[e].push([t,n]),po.setSkylinkState(o,a.id);};class Vr{static setIceServers(e){return Gr(e)}static addIceCandidateFromQueue(e,t){return Ur(e,t)}static addIceCandidateToQueue(e,t,r,n,s){return xr(e,t,r,n,s)}static addIceCandidate(e,t,r,n,s){return Fr(e,t,r,n,s)}static onIceCandidate(e,t,r){return Br(e,t,r)}}const Hr=(e,t)=>e.id===t.id;class jr extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,send_audio:null,recv_audio:null,send_video:null,recv_video:null,send_screen:null,recv_screen:null,mode:null};}getMediaCount(e,t,r){let n=0,s=0,i=0;const{peerMedias:o}=e;return Object.values(r).forEach(e=>{const r=e.getAudioTracks()[0],a=e.getVideoTracks()[0];if(r)n+=1;else if(a){!Ei(o)&&o[t]["VIDEO_"+e.id]&&o[t]["VIDEO_"+e.id].mediaType===Et.VIDEO_SCREEN?i+=1:s+=1;}}),{audioCount:n,videoCount:s,screenCount:i}}parseMediaStats(e){const{peerStreams:t,user:r,peerConnections:n}=e,s=t[r.sid]||[];let i=0,o=0,a=0;if(!Ei(n)){const t=this.getMediaCount(e,r.sid,s);i=t.audioCount,o=t.videoCount,a=t.screenCount;}let c=0,d=0,l=0;return Object.keys(t).filter(e=>e!==r.sid).forEach(r=>{const n=t[r],s=this.getMediaCount(e,r,n);c+=s.audioCount,d+=s.videoCount,l+=s.screenCount;}),{send_audio:i,send_video:o,send_screen:a,recv_audio:c,recv_video:d,recv_screen:l}}send(e){const t=po.getSkylinkState(e);this.model.client_id=t.clientId,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=t&&t.user&&t.user.sid||null,this.model.mode=t.hasMCU?"MCU":"P2P";const r=this.parseMediaStats(t);this.model.send_audio=r.send_audio,this.model.recv_audio=r.recv_audio,this.model.send_video=r.send_video,this.model.recv_video=r.recv_video,this.model.send_screen=r.send_screen,this.model.recv_screen=r.recv_screen,this.postStats(this.endpoints.userMedia,this.model);}}class Wr{static updatePeerStreamWithUserSid(e,t){const r=po.getSkylinkState(e.id);r.peerStreams.null&&(r.peerStreams[t]=Object.assign({},r.peerStreams.null),delete r.peerStreams.null,po.setSkylinkState(r,e.id));}static addStream(e,t=null,r){if(!t)return;const n=po.getSkylinkState(r),{peerStreams:s}=n;s[e]&&s[e][t.id]||(s[e]=s[e]||{},s[e][t.id]=t,po.setSkylinkState(n,r));}static deleteStream(e,t,r){const n=po.getSkylinkState(t.id),s=r;delete n.peerStreams[e][s],Ei(n.peerStreams[e])&&delete n.peerStreams[e],po.setSkylinkState(n,n.room.id),(new jr).send(t.id);}static dispatchStreamEvent(e,t){switch(e){case"onIncomingStream":kt(Se(t));break;case"onIncomingScreenStream":kt(Ee(t));break;case"streamEnded":kt(he(t));break;case"streamMuted":kt(me(t));}}}const Kr=(e,t)=>!(!e||!e[0])&&(e.forEach(e=>{try{e.stop();}catch(r){Ut.log.ERROR([t,St.MEDIA_STREAM,null,`${Dt.MEDIA_STREAM.ERRORS.STOP_MEDIA_TRACK} - track id: ${e.id}`],r);}}),!0),$r=(e,t,r)=>{const{room:n}=e,s=e;let i=-1;if(!s.currentRTCRTPSenders[t])return;const o=s.currentRTCRTPSenders[t];for(let e=0;e<o.length;e+=1)if(r===o[e]){i=e;break}-1!==i?(o.splice(i,1),s.currentRTCRTPSenders[t]=o,po.setSkylinkState(s,n.id)):Ut.log.WARN([t,null,null,"No matching sender was found for the peer."],r);},Yr={prepStopStreams:(e,t,r=!1)=>new Promise((n,s)=>{const i=po.getSkylinkState(e),{user:o,peerStreams:a}=i;i||s(new Error(`${Dt.ROOM_STATE.NOT_FOUND} - ${e}`)),(!a[o.sid]||t&&!a[o.sid][t])&&s(new Error(`${Dt.MEDIA_STREAM.ERRORS.NO_STREAM} - ${t}`)),r?Yr.prepStopScreenStream(i.room,t).then(()=>n()).catch(e=>s(e)):Yr.prepStopUserMediaStreams(i,t).then(()=>n()).catch(e=>s(e));}),prepStopUserMediaStreams:(e,t)=>new Promise((r,n)=>{const{user:s,peerStreams:i}=e,o=(e=>{const{peerStreams:t,user:r,room:n}=e;return Object.keys(t[r.sid]).map(e=>Bn.retrieveScreenMediaInfo(n,r.sid,{streamId:e})?null:t[r.sid][e]).filter(e=>null!==e)})(e);try{if(t){const r=i[s.sid][t];Yr.stopAddedStream(e,r,!1);}else Yr.stopAddedStreams(e,o,!1);return Yr.initRefreshConnectionAndResolve(e.room,r,n)}catch(e){Ut.log.DEBUG([s.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA],e),n(Dt.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA);}}),stopAddedStream:(e,t,r=!1)=>{const{room:n,user:s}=e;try{Yr.tryStopStream(t,s.sid),Yr.removeTracks(n,t),Bn.setMediaStateToUnavailable(n,s.sid,Bn.retrieveMediaId(t.getTracks()[0].kind,t.id)),Wr.deleteStream(s.sid,n,t.id),Yr.listenForEventAndDeleteMediaInfo(n,t),Yr.dispatchEvents(n,t,r),Yr.updateMediaStatusMutedSettings(n,t),r&&new Qi(e).deleteScreensharingInstance(n),Ut.log.INFO([s.sid,St.MEDIA_STREAM,null,`${Dt.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id} ${r?"(screenshare)":""}`]);}catch(e){Ut.log.ERROR([s.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.STOP_ADDED_STREAM],e);}},tryStopStream:(e,t)=>{if(e){try{Kr(e.getAudioTracks());}catch(r){Ut.log.ERROR([t,St.MEDIA_STREAM,null,`${Dt.MEDIA_STREAM.ERRORS.STOP_AUDIO_TRACK} - stream id: ${e.id}`],r);}try{Kr(e.getVideoTracks());}catch(r){Ut.log.ERROR([t,St.MEDIA_STREAM,null,`${Dt.MEDIA_STREAM.ERRORS.STOP_VIDEO_TRACK} - stream id: ${e.id}`],r);}}},removeTracks:(e,t)=>{const r=po.getSkylinkState(e.id),{peerConnections:n,user:s}=r,i=t.getTracks();try{i.forEach(e=>{((e,t,r)=>{const n=r.id,s=Object.keys(t);for(let r=0;r<s.length;r+=1)try{const i=s[r],o=t[i];if(o.connectionState===je.CLOSED)break;const a=o.getSenders();let c=null;for(let t=0;t<a.length;t+=1)a[t].track&&a[t].track.id===n&&(c=a[t],o.removeTrack(c),$r(e,i,c));}catch(e){Ut.log.ERROR([s[r],St.PEER_CONNECTION,null,Dt.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e);}})(r,n,e);});}catch(e){Ut.log.ERROR([s.sid,St.PEER_CONNECTION,null,Dt.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e);}},listenForEventAndDeleteMediaInfo:(e,t)=>{const r=po.getSkylinkState(e.id),n=n=>{const s=t,{user:i}=r,{detail:o}=n;if(o.state===ze.OFFER){const t=Bn.retrieveMediaId(ki(s)?mt.AUDIO:mt.VIDEO,s.id);Bn.deleteUnavailableMedia(e,i.sid,t);}},s=()=>{Mt(vt.HANDSHAKE_PROGRESS,n),Mt(vt.MEDIA_INFO_DELETED,s);};Pt(vt.HANDSHAKE_PROGRESS,n),Pt(vt.MEDIA_INFO_DELETED,s);},stopAddedStreams:(e,t,r)=>{t.forEach(t=>{Yr.stopAddedStream(e,t,r);});},updateMediaInfoMediaState:(e,t)=>{const r=po.getSkylinkState(e.id),{user:n}=r,s=t.id,i=Bn.retrieveMediaId(t.getTracks()[0].kind,s);Bn.setMediaStateToUnavailable(e,n.sid,i);},dispatchEvents:(e,t,r=!1)=>{const n=po.getSkylinkState(e.id),{MEDIA_STREAM:s}=Dt,{user:i}=n;Ut.log.INFO([i.sid,St.MEDIA_STREAM,null,s.STOP_SETTINGS],{peerId:i.sid,isSelf:!0,isScreensharing:r,stream:t}),Wr.dispatchStreamEvent("streamEnded",{room:Qs.getRoomInfo(e.id),peerId:i.sid,peerInfo:ei.getCurrentSessionInfo(e),isSelf:!0,isScreensharing:r,streamId:t.id,isVideo:wi(t),isAudio:ki(t)}),kt(((e={})=>new pe("mediaAccessStopped",{detail:e}))({isScreensharing:r,streamId:t.id})),kt(Ae({peerId:i.sid,peerInfo:Zs.getCurrentSessionInfo(e),isSelf:!0}));},prepStopScreenStream:(e,t)=>new Promise((r,n)=>{const s=po.getSkylinkState(e.id),{user:i,peerStreams:o}=s,a=o[i.sid][t];try{Yr.stopAddedStream(s,a,!0),Yr.initRefreshConnectionAndResolve(s.room,r,n);}catch(e){Ut.log.DEBUG([i.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e),n(new Error(Dt.MEDIA_STREAM.ERRORS.STOP_SCREEN));}}),initRefreshConnectionAndResolve:(e,t,r)=>{const n=po.getSkylinkState(e.id),{peerConnections:s}=n;try{if(hi(Object.keys(s)))return (e=>{const{room:t,user:r}=e;kt(Ae({peerId:r.sid,isSelf:!0,peerInfo:ei.getCurrentSessionInfo(t)}));})(n),Bn.deleteUnavailableMedia(n.room,n.user.sid),t();{const e=e=>{const{detail:r}=e;if(r.state===ze.ANSWER_ACK)return t()};Pt(vt.HANDSHAKE_PROGRESS,e),ji.refreshConnection(n);}}catch(e){r(e);}},updateMediaStatusMutedSettings:(e,t)=>{const r=po.getSkylinkState(e.id);delete r.streamsMediaStatus[t.id],delete r.streamsMutedSettings[t.id],delete r.streamsSettings[t.id],po.setSkylinkState(r,e.id);}};class zr{static getUserMedia(e,t={}){const{room:r}=e,n=Si.parseMediaOptions(t,e),{audio:s,video:i}=t,o=!!t.useExactConstraints;return po.setSkylinkState(n,r.id),Si.prepMediaAccessRequest({useExactConstraints:o,audio:s,video:i,roomKey:r.id})}static processUserMediaOptions(e,t=null){return new Promise((r,n)=>{let s={audio:!0,video:!0};t||Ut.log.WARN([e.user.sid,St.MEDIA_STREAM,null,`${Dt.MEDIA_STREAM.NO_OPTIONS} - ${Dt.MEDIA_STREAM.DEFAULT_OPTIONS}`],s),gi(t)||(Ut.log.ERROR([e.user.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS],t),n(new Error(Dt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),null)),s=t;zr.getUserMedia(e,s).then(e=>{r(e);}).catch(e=>{n(e);});})}static stopStreams(e,t){return Yr.prepStopStreams(e.room.id,t)}static addLocalMediaStreams(e,t){Si.addLocalMediaStreams(e,t);}static onRemoteTrackAdded(e,t,r,n,s,i){Si.onRemoteTrackAdded(e,t,r,n,s,i);}static muteStreams(e,t,r){return Si.muteStreams(e,t,r)}static sendStream(e,t){return Si.sendStream(e,t)}static getStreamSources(){return Si.getStreamSources()}static getStreams(e,t){return Si.getStreams(e,t)}static usePrefetchedStream(e,t){return new Promise(r=>{const n={audio:0!==t.getAudioTracks().length,video:0!==t.getVideoTracks().length},s=Si.parseStreamSettings(n,mt.AUDIO),i=Si.parseStreamSettings(n,mt.VIDEO);r(Si.onStreamAccessSuccess(e,t,s,i,!1,!1,!0));})}static processPrefetchedStreams(e,t,r=null){return new Promise((n,s)=>{const i=[];if(t&&r.id)return void s(Dt.MEDIA_STREAM.ERRORS.INVALID_PREFETCHED_STREAMS);if(t?Array.isArray(t)?t.forEach(e=>{e&&e.id&&e.active&&i.push(e);}):i.push(t):r.id&&r.active?i.push(r):Array.isArray(r)&&r.forEach(e=>{e&&e.id&&e.active&&i.push(e);}),hi(i))return void s(Dt.MEDIA_STREAM.ERRORS.INVALID_PREFETCHED_STREAMS);const o=[];i.forEach(t=>{o.push(zr.usePrefetchedStream(e,t));}),Promise.all(o).then(e=>n(e));})}static buildStreamSettings(e,t,r){return Si.buildStreamSettings(e,t,r)}}const Jr=new class extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,weight:null,sdp_type:null,sdp_sdp:null,error:null};}send(e,t,r,n,s,i){const o=po.getSkylinkState(e);this.model.client_id=o.clientId,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=r,this.model.state=t,this.model.is_remote=s,this.model.weight=n.weight||null,this.model.error=("string"==typeof i?i:i&&i.msg)||null,this.model.sdp_type=null,this.model.sdp_sdp=null,-1===["enter","welcome"].indexOf(this.model.state)&&(this.model.weight=this.model.is_remote&&ei.getPeerInfo(this.model.peer_id,o.room).config&&ei.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight?ei.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight:ei.getCurrentSessionInfo(o.room).config.priorityWeight,this.model.sdp_type=n&&n.type||null,this.model.sdp_sdp=n&&n.sdp||null),this.addToStatsBuffer("negotiation",this.model,this.endpoints.negotiation),this.manageStatsBuffer();}},Qr=(e,t,r,n,s)=>{const i=po.getSkylinkState(r.room.id),{peerConnections:o,bufferedLocalOffer:a,peerPriorityWeight:c,room:d}=i,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:l}}=Dt,u=o[t],p={type:n.type,sdp:n.sdp};if(u.processingLocalSDP=!0,Ut.log.INFO([t,"RTCSessionDescription",n.type,"Local session description updated ->"],p.sdp),n.type===ze.OFFER){Jr.send(d.id,l.OFFER.offer,t,n,!1),Ut.log.INFO([t,"RTCSessionDescription",n.type,"Local offer saved."]),a[t]=n;const o={type:p.type,sdp:p.sdp,mid:i.user.sid,target:t,rid:r.room.id,userInfo:ei.getUserInfo(r.room),weight:c,mediaInfoList:Bn.retrieveMediaInfoForOfferAnswer(d,p)};if(s&&Object.keys(s).length){const e=Object.keys(s),t=Object.keys(o);for(let r=0;r<e.length;r+=1){const n=e[r];-1===t.indexOf(n)&&(o[n]=s[n]);}}e(o);}else{Jr.send(d.id,l.ANSWER.answer,t,n,!1);e({type:p.type,sdp:p.sdp,mid:i.user.sid,target:t,rid:r.room.id,userInfo:ei.getUserInfo(r.room),mediaInfoList:Bn.retrieveMediaInfoForOfferAnswer(d,p)});}},{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:Xr}}=Dt,qr=e=>{let t=null;const{currentRoom:r,targetMid:n,cert:s,hasScreenShare:i}=e,o=po.getSkylinkState(r.id),{room:a}=o,c=Object.assign({iceServers:a.connection.peerConfig.iceServers},Ht("PEER_CONNECTION"));s&&(c.certificates=[s]),po.setSkylinkState(o,r.id);try{t=((e,t,r,n)=>{const s=po.getInitOptions(),i=po.getSkylinkState(n.id);Ut.log.DEBUG([e,St.PEER_CONNECTION,null,Dt.PEER_CONNECTION.CREATE_NEW],{constraints:t});const{RTCPeerConnection:o,msRTCPeerConnection:a}=window,c=new(s.useEdgeWebRTC&&a?window.msRTCPeerConnection:o)(t),d=[c,e,i];return c.setOffer="",c.setAnswer="",c.negotiating=!1,c.hasMainChannel=!1,c.processingLocalSDP=!1,c.processingRemoteSDP=!1,c.gathered=!1,c.gathering=!1,i.gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}},i.peerEndOfCandidatesCounter[e]=i.peerEndOfCandidatesCounter[e]||{},e===It.MCU&&(Ut.log.INFO("Creating an empty transceiver of kind video with MCU"),"function"==typeof c.addTransceiver&&c.addTransceiver("video")),c.restartIce&&(i.enableIceRestart=!0),po.setSkylinkState(i,n.id),c.ontrack=Un.ontrack.bind(c,...d),c.ondatachannel=Un.ondatachannel.bind(c,...d),c.onicecandidate=Un.onicecandidate.bind(c,...d),c.oniceconnectionstatechange=Un.oniceconnectionstatechange.bind(c,...d),c.onconnectionstatechange=Un.onconnectionstatechange.bind(c,...d),c.onsignalingstatechange=Un.onsignalingstatechange.bind(c,...d),c.onicegatheringstatechange=Un.onicegatheringstatechange.bind(c,...d),bi(_t.REACT_NATIVE)&&(c.onsenderadded=Un.onsenderadded.bind(c,...d),c.onremovetrack=Un.onremovetrack.bind(c,e,i.room,!1)),c})(n,c,0,r),t.constraints=c;}catch(e){Ut.log.ERROR([n,null,null,"Failed creating peer connection:"],e),t=null,kt(fe({state:ze.ERROR,peerId:n,error:e,room:Qs.getRoomInfo(a.id)}));}return t},{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:Zr}}=Dt,en=(e,t,r,n,s)=>{const i=po.getSkylinkState(e.room.id),o=i.peerConnections[t],a=i.dataChannels[t];let c=n;if(c&&c!==t||(c="main"),!("object"==typeof r&&r||r&&"string"==typeof r))return Ut.log.WARN([t,"RTCDataChannel",c,"Dropping invalid data ->"],r),null;if(!o||o.signalingState===je.CLOSED)return Ut.log.WARN([t,"RTCDataChannel",c,"Dropping for sending message as Peer connection does not exists or is closed ->"],r),null;if(!a||!a[c])return Ut.log.WARN([t,"RTCDataChannel",c,"Dropping for sending message as Datachannel connection does not exists ->"],r),null;const d=a[c].channelName,l=a[c].channelType,u=a[c].channel.readyState,p="object"==typeof r&&r.type===ot.MESSAGE?Ue.MESSAGE:Ue.TRANSFER;if(u!==Le.OPEN){const e=new Error("Failed sending message as Datachannel connection state is not opened. Current readyState is "+u);throw Ut.log.ERROR([t,"RTCDataChannel",c,e],r),kt(ge({peerId:t,channelName:d,channelType:l,messageType:p,error:e,state:Le.SEND_MESSAGE_ERROR,bufferAmount:ji.getDataChannelBuffer(a[c].channel)})),e}try{s||"object"!=typeof r?(Ut.log.DEBUG([t,"RTCDataChannel",c,"Sending data with size ->"],r.size||r.length||r.byteLength),a[c].channel.send(r)):(Ut.log.DEBUG([t,"RTCDataChannel",c,`Sending ${r.type} protocol message ->`],r),a[c].channel.send(JSON.stringify(r)));}catch(e){throw Ut.log.ERROR([t,"RTCDataChannel",c,"Failed sending data)"],{error:e,data:r}),kt(ge({peerId:t,channelName:d,channelType:l,messageType:p,error:e,state:Le.SEND_MESSAGE_ERROR,bufferAmount:ji.getDataChannelBuffer(a[c].channel)})),e}return null},tn=(e,t,r,n,s)=>{const i=po.getSkylinkState(e.room.id);let o=null,a=null,c=!1;const d=s===Ge.MESSAGING?"main":n,l=i.dataChannels[r]||{};if(!l.hasOwnProperty(d)||"object"!=typeof l[d])return null;if(o=l[d].transferId,a=l[d].streamId,a&&i.dataStreams&&i.dataStreams[a]&&(c="string"===i.dataStreams[a].sessionChunkType?"string"==typeof t:"object"==typeof t),!i.peerConnections[r])return Ut.log.WARN([r,"RTCDataChannel",d,"Dropping data received from Peer as connection is not present ->"],t),null;if(!i.dataChannels[r]||!i.dataChannels[r][d])return Ut.log.WARN([r,"RTCDataChannel",d,"Dropping data received from Peer as Datachannel connection is not present ->"],t),null;if("string"==typeof t)try{const n=JSON.parse(t);if(c=!1,Ut.log.DEBUG([r,"RTCDataChannel",d,`Received protocol ${n.type} message ->`],n),[ot.ACK,ot.ERROR,ot.CANCEL].indexOf(n.type)>-1&&!(o&&i.dataTransfers[o]&&i.dataTransfers[o].sessions[r]))return Ut.log.WARN([r,"RTCDataChannel",d,"Discarded protocol message as data transfer session is not present ->"],n),null;switch(n.type){case ot.WRQ:if(o&&i.dataTransfers[o]&&i.dataTransfers[o].sessions[r]){Ut.log.WARN([r,"RTCDataChannel",d,"Rejecting bidirectional data transfer request as it is currently not supported in the SDK ->"],n),en(e,r,{type:ot.ACK,ackN:-1,sender:i.user.sid},d);break}break;case ot.MESSAGE:((e,t,r,n)=>{const s=r.sender||t;Ut.log.INFO([s,"RTCDataChannel",n,"Received P2P message from peer:"],r),kt(Re({room:e.room,message:{targetPeerId:r.target,content:r.data,senderPeerId:s,isDataChannel:!0,isPrivate:r.isPrivate},isSelf:!1,peerId:s,peerInfo:ei.getPeerInfo(s,e.room)}));})(i,r,n,d);break;default:Ut.log.WARN([r,"RTCDataChannel",d,`Discarded unknown ${n.type} message ->`],n);}}catch(e){kt(ge({peerId:r,channelName:n,channelType:s,error:e,state:Le.ERROR,bufferAmount:ji.getDataChannelBuffer(i.dataChannels[r][d].channel)}));}return null};class rn extends Jt{constructor(){super();const{AdapterJS:e}=window;this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,channel_id:null,channel_label:null,channel_type:null,channel_binary_type:null,error:null,agent_name:e.webrtcDetectedBrowser,agent_type:e.webrtcDetectedType,agent_version:e.webrtcDetectedVersion};}send(e,t,r,n,s,i){const o=po.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.uid||null,this.model.peer_id=r,this.model.client_id=o.clientId,this.model.state=t,this.model.channel=n,this.model.channel_id=n.id,this.model.channel_label=n.label,this.model.channel_type="main"===s?"persistent":"temporal",this.model.channel_binary_type=n.binaryType,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.error=("string"==typeof i?i:i&&i.message)||null,"plugin"===this.model.agent_name&&(this.model.channel_binary_type="int8Array","IE"===this.model.agent_name&&this.model.agent_version<11&&(this.model.channel_binary_type="none")),this.postStats(this.endpoints.dataChannel,this.model);}}const nn={onopen:e=>{const{dataChannel:t,channelProp:r,channelName:n,channelType:s,peerId:i,roomState:o,bufferThreshold:a}=e,c=new rn,{room:d}=o,{STATS_MODULE:l}=Dt;Ut.log.DEBUG([i,"RTCDataChannel",r,"Datachannel has opened"]),t.bufferedAmountLowThreshold=a||0,c.send(d.id,l.HANDLE_DATA_CHANNEL_STATS.closed,i,t,r),kt(ge({state:Le.OPEN,peerId:i,channelName:n,channelType:s,bufferAmount:ji.getDataChannelBuffer(t)}));},onmessage:(e,t)=>{const{peerId:r,channelName:n,channelType:s,roomState:i}=e;tn(i,t.data,r,n,s);},onerror:(e,t)=>{const{dataChannel:r,peerId:n,channelName:s,channelProp:i,channelType:o,roomState:a}=e;if("NONE"===t.error.errorDetail||0===t.error.code)Ut.log.DEBUG([n,"RTCDataChannel",i,"Datachannel state ->"],t.error.message);else{const e=po.getSkylinkState(a.room.id);e||Ut.log.DEBUG([n,"RTCDataChannel",i,"No roomState for room "+a.room.id]);const c=new rn;Ut.log.ERROR([n,"RTCDataChannel",i,"Datachannel has an exception ->"],t),c.send(e?e.room.id:a.room.id,Le.ERROR,n,r,i,t),kt(ge({state:Le.ERROR,peerId:n,channelName:s,channelType:o,bufferAmount:ji.getDataChannelBuffer(r),error:t}));}},onbufferedamountlow:e=>{const{dataChannel:t,peerId:r,channelName:n,channelProp:s,channelType:i,roomState:o}=e,a=po.getSkylinkState(o.room.id),{room:c}=a;Ut.log.DEBUG([r,"RTCDataChannel",s,"Datachannel buffering data transfer low"]),kt(ge({state:Le.BUFFERED_AMOUNT_LOW,room:Qs.getRoomInfo(c.id),peerId:r,channelName:n,channelType:i,bufferAmount:ji.getDataChannelBuffer(t)}));},onclose:e=>{const{dataChannel:t,peerId:r,channelName:n,channelProp:s,channelType:i,roomState:o}=e,{DATA_CHANNEL:a,STATS_MODULE:c}=Dt,d=po.getSkylinkState(o.room.id)||Object.values(po.getSkylinkState())[0];if(!d)return;const{room:l,peerConnections:u}=d,p=new rn;Ut.log.DEBUG([r,"RTCDataChannel",s,a.closed]);try{if(p.send(l.id,c.HANDLE_DATA_CHANNEL_STATS.closed,r,t,s),kt(ge({state:Le.CLOSED,peerId:r,room:Qs.getRoomInfo(l.id),channelName:n,channelType:i,bufferAmount:ji.getDataChannelBuffer(t)})),u[r]&&u[r].remoteDescription&&u[r].remoteDescription.sdp&&(-1===u[r].remoteDescription.sdp.indexOf("m=application")||u[r].remoteDescription.sdp.indexOf("m=application 0")>0))return;i===Ge.MESSAGING&&setTimeout(()=>{u[r]&&u[r].signalingState!==je.CLOSED&&u[r].localDescription&&u[r].localDescription.type===ze.OFFER&&(Ut.log.DEBUG([r,"RTCDataChannel",s,a.reviving_dataChannel]),ji.createDataChannel({peerId:r,dataChannel:t,bufferThreshold:ji.getDataChannelBuffer(t),createAsMessagingChannel:!0,roomState:d}),p.send(l.id,c.HANDLE_DATA_CHANNEL_STATS.reconnecting,r,{label:n},"main"));},100);}catch(e){Ut.log.WARN([r,"RTCDataChannel",s,a.closed]);}}},sn=(e,t,r)=>{const n=po.getInitOptions(),{dataChannels:s,room:i,user:o,hasMCU:a}=e;let c=Object.keys(s),d=!1;if(Array.isArray(r)&&r.length?(c=r,d=!0):r&&"string"==typeof r&&(c=[r],d=!0),!i.inRoom||!o||!o.sid)return Ut.log.ERROR("Unable to send message as User is not in Room. ->",t),null;if(!n.enableDataChannel)return Ut.log.ERROR("Unable to send message as User does not have DataChannel enabled. ->",t),null;for(let n=0;n<c.length;n+=1){const i=c[n];s[i]||a?i===It.MCU?(c.splice(n,1),n-=1):a||(Ut.log.DEBUG([i,"RTCDataChannel",null,`Sending ${d?"private":""} P2P message to Peer.`]),en(e,i,{type:ot.MESSAGE,isPrivate:d,sender:o.sid,target:r?i:null,data:t},"main")):(Ut.log.ERROR([i,"RTCDataChannel",null,"Dropping of sending message to Peer as DataChannel connection does not exist."]),c.splice(n,1),n-=1);}return 0===c.length&&Ut.log.WARN("Currently there are no Peers to send P2P message to."),a&&(Ut.log.DEBUG([It.MCU,"RTCDataChannel",null,`Broadcasting ${d?"private":""} P2P message to Peers.`]),en(e,It.MCU,{type:ot.MESSAGE,isPrivate:d,sender:o.sid,target:c,data:t},"main")),!r&&a||kt(Re({room:Qs.getRoomInfo(e.room.id),message:{targetPeerId:r||null,content:t,senderPeerId:o.sid,isDataChannel:!0,isPrivate:d},isSelf:!0,peerId:o.sid,peerInfo:ei.getCurrentSessionInfo(e.room)})),null},on=(e,t,r)=>{const{dataChannels:n}=e,s=n[t][r],{channelName:i,channelType:o}=s.channelName;if(s.readyState!==Le.CLOSED){const{room:a}=e,c=new rn;Ut.log.DEBUG([t,St.DATA_CHANNEL,r,Dt.DATA_CHANNEL.CLOSING]),c.send(a.id,Le.CLOSING,t,s.channel,r),kt(ge({room:a,peerId:t,state:Le.CLOSING,channelName:i,channelType:o,bufferAmount:ji.getDataChannelBuffer(s.channel)})),s.channel.close(),delete n[t][r];}},an=(e,t,r)=>{const n={};return n.listOfPeers=e,n.refreshErrors=t,n.refreshSettings=r,n},cn=(e,t,r)=>{const n=[];return Object.keys(e).forEach(s=>{n.push(((e,t,r,n)=>{const s=po.getSkylinkState(t.id),{hasMCU:i,peerInformations:o,enableIceRestart:a}=s,c=ei.getPeersCustomSettings(s),d={};return d[e]={iceRestart:!i&&o[e]&&o[e].config&&o[e].config.enableIceRestart&&a&&r,customSettings:c[e]||{}},n&&(d.errors=n),d})(e[s],t,r));}),n},dn=(e,t)=>{const r={};return r[e]=t,r},ln=(e,t,r,n)=>new Promise((s,i)=>{e||i(new Error(Dt.ROOM_STATE.NO_ROOM_NAME));const{peerConnections:o,hasMCU:a,room:c}=e,d=po.getInitOptions(),{mcuUseRenegoRestart:l}=d,{PEER_CONNECTION:u}=Dt,p=((e,t,r,n)=>{let s=!1,i={},o=Object.keys(n);return Array.isArray(e)?o=e:Ii(e)?o=[e]:_i(e)?s=e:e&&gi(e)&&(i=e),_i(t)?s=t:t&&gi(t)&&(i=t),r&&gi(r)&&(i=r),{listOfPeers:o,doIceRestart:s,bwOptions:i}})(t,r,n,o),{listOfPeers:S,doIceRestart:E,bwOptions:h}=p;try{!hi(S)||a&&!l||(Ut.log.ERROR(u.NO_PEER_CONNECTION),i({refreshErrors:{self:u.NO_PEER_CONNECTION},listOfPeers:S})),Ut.log.INFO([null,St.PEER_CONNECTION,null,u.REFRESH_CONNECTION.START]);ji.refreshPeerConnection(S,e,E,h).then(e=>{const t=a?[e]:e,r=[];for(let e=0;e<t.length;e+=1)if(Array.isArray(t[e])){const n=t[e];r.push(dn(n[0],n[1])),Ut.log.WARN([S,St.PEER_CONNECTION,null,u.REFRESH_CONNECTION.FAILED],n[0]);}else Ii(t[e])&&Ut.log.INFO([S,St.PEER_CONNECTION,null,u.REFRESH_CONNECTION.SUCCESS],t[e]);r.length===S.length?i(an(S,r,cn(S,c,E))):s(an(S,r,cn(S,c,E)));}).catch(e=>Ut.log.ERROR([null,St.PEER_CONNECTION,null,u.REFRESH_CONNECTION.FAILED],e)).finally(()=>Ut.log.INFO(u.REFRESH_CONNECTION.COMPLETED));}catch(e){i(e);}}),un=(e,t,r)=>{const{room:n}=e,s=new xs;try{const e=s.messageBuilder.getRestartOfferMessage(n.id,t,r);return s.offer(n,t,r,e),t}catch(e){return [t,e]}},pn=(e,t,r)=>{const n=po.getSkylinkState(t.room.id),{peerConnections:s,streamsBandwidthSettings:i,peerEndOfCandidatesCounter:o,room:a,user:c}=n,{doIceRestart:d,bwOptions:l}=r,u=new xs,p=[];return new Promise(t=>{if(!s[e])return Ut.log.ERROR([e,null,null,Dt.PEER_CONNECTION.ERRORS.NOT_FOUND]),p.push(Dt.PEER_CONNECTION.ERRORS.NOT_FOUND),t([e,p]);const r=s[e];if(0!==p.length)return t([e,p]);if(r.signalingState===je.STABLE)return Ut.log.INFO([e,null,null,Dt.PEER_CONNECTION.REFRESH_CONNECTION.SEND_RESTART_OFFER],{iceRestart:d,options:l}),n.streamsBandwidthSettings.bAS=l.bandwidth||i.bAS,n.peerEndOfCandidatesCounter[e]=o[e]||{},n.peerEndOfCandidatesCounter[e].len=0,po.setSkylinkState(n,n.room.id),t(un(n,e,d));const S=r.localDescription&&r.localDescription.sdp;return r.signalingState===je.HAVE_LOCAL_OFFER&&S?(u.sendMessage({type:r.localDescription.type,sdp:r.localDescription.sdp,mid:c.sid,target:e,rid:a.id,restart:!0}),t(e)):(Ut.log.DEBUG([e,St.PEER_CONNECTION,null,Dt.PEER_CONNECTION.REFRESH_CONNECTION.NO_LOCAL_DESCRIPTION],{localDescription:r.localDescription,remoteDescription:r.remoteDescription,signalingState:r.signalingState}),p.push(Dt.PEER_CONNECTION.REFRESH_CONNECTION.NO_LOCAL_DESCRIPTION),t([e,p]),null)})},Sn=(e,t,r)=>pn(e,t,r),En=(e,t,r=!1,n)=>{const s=po.getSkylinkState(e.id),i=po.getInitOptions(),{enableDataChannel:o}=i,{peerConnections:a,hasMCU:c,enableIceRestart:d,peerInformations:l,voiceActivityDetection:u,dataChannels:p}=s,S=a[t],E={iceRestart:!!((l[t]||{}).config||{}).enableIceRestart&&r&&d,voiceActivityDetection:u};return c&&"function"!=typeof S.addTransceiver&&(E.offerToReceiveVideo=!0),c&&t!==It.MCU||zr.addLocalMediaStreams(t,s),o&&l[t].config.enableDataChannel&&(p[t]&&p[t].main||(ji.createDataChannel({peerId:t,roomState:s,createAsMessagingChannel:!0}),s.peerConnections[t].hasMainChannel=!0)),Ut.log.DEBUG([t,null,null,"Creating offer with config:"],E),S.endOfCandidates=!1,S.negotiating=!0,S.sdpConstraints=E,po.setSkylinkState(s,e.id),new Promise((e,r)=>{S.createOffer(E).then(r=>((e,t,r,n,s)=>{const{room:i}=r;Ut.log.DEBUG([t,null,null,"Created offer"],s),Jr.send(i.id,Xr.OFFER.create,t,s,!1),Qr(e,t,r,s,n);})(e,t,s,n,r)).catch(e=>((e,t,r,n)=>{const{room:s}=r;Ut.log.ERROR([t,null,null,"Failed creating an offer:"],n),Jr.send(s.id,Xr.OFFER.create_error,t,null,!1,n),kt(fe({state:ze.ERROR,peerId:t,error:n,room:Qs.getRoomInfo(r.room.id)})),e(n);})(r,t,s,e));})},hn=(e,t)=>{const r=po.getSkylinkState(e.room.id),{peerConnections:n,hasMCU:s,voiceActivityDetection:i}=r,o=n[t],a={voiceActivityDetection:i};return Ut.log.INFO([t,null,null,"Creating answer with config:"],a),s&&t!==It.MCU||zr.addLocalMediaStreams(t,e),new Promise((r,n)=>o.createAnswer(a).then(n=>((e,t,r,n)=>{const{room:s}=r;Ut.log.DEBUG([t,null,null,"Created answer"],n),Jr.send(s.id,Zr.ANSWER.create,t,n,!1),Qr(e,t,r,n);})(r,t,e,n)).catch(r=>((e,t,r,n)=>{const{room:s}=r;Ut.log.ERROR([t,null,null,"Failed creating an answer:"],n),Jr.send(s.id,Zr.ANSWER.create_error,t,null,!1,n),kt(fe({state:ze.ERROR,peerId:t,error:n,room:Qs.getRoomInfo(r.room.id)})),e(n);})(n,t,e,r)))},mn=e=>{let t=null;const{currentRoom:r,targetMid:n,peerBrowser:s,cert:i,hasScreenShare:o}=e,a=po.getInitOptions(),c=po.getSkylinkState(r.id),{peerConnections:d,room:l}=c;if(d[n])Ut.log.WARN([n,null,null,"Connection to peer has already been made."]);else{Ut.log.INFO([n,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:s,enableDataChannel:a.enableDataChannel}),t=qr({currentRoom:r,targetMid:n,hasScreenShare:o,cert:i,sdpSemantics:lt.UNIFIED});try{const e=t.getConfiguration();e.sdpSemantics===lt.UNIFIED?Ut.log.INFO([n,"SDP Semantics",null,"Peer Connection has Unified plan."]):e.sdpSemantics===lt.PLAN_B?Ut.log.INFO([n,"SDP Semantics",null,"Peer Connection has Plan-B."]):Ut.log.INFO([n,"SDP Semantics",null,"The sdpSemantics parameter is not supported by this browser version."]);}catch(e){Ut.log.INFO([n,"SDP Semantics",null,"getConfiguration() is not available in this browser version. Ex : "],e);}c.peerConnections[n]=t,po.setSkylinkState(c,r.id),Lr.send(l.id,"new",n,!1);}return t},gn=e=>{let{peerId:t,dataChannel:r,bufferThreshold:n,createAsMessagingChannel:s,roomState:i}=e;const o=po.getSkylinkState(i.room.id),{user:a,peerConnections:c,dataChannels:d}=o,l=c[t];let u="-_"+t,p=!0===s?Ge.MESSAGING:Ge.DATA,S=p===Ge.MESSAGING?"main":u;if(!a||!a.sid)return Ut.log.ERROR([t,"RTCDataChannel",S,"Aborting of creating or initializing DataChannel as User does not have Room session"]),null;if(u=`${a.sid}_${t}`,!l||l.signalingState===je.CLOSED)return Ut.log.ERROR([t,"RTCDataChannel",S,"Aborting of creating or initializing Datachannel as Peer connection does not exists"]),null;if(r&&"object"==typeof r?u=r.label:"string"==typeof r&&(u=r,r=null),d[t]?d[t].main&&d[t].main.channel.label===u&&(S="main",p=Ge.MESSAGING):(S="main",p=Ge.MESSAGING,d[t]={},Ut.log.DEBUG([t,"RTCDataChannel",S,"initializing main DataChannel"])),!r)try{r=l.createDataChannel(u,{reliable:!0,ordered:!0});}catch(e){Ut.log.ERROR([t,"RTCDataChannel",S,"Failed creating Datachannel ->"],e);const n=new rn,{room:s}=i;return n.send(s.id,Le.ERROR,t,{label:u},S,e),kt(ge({state:Le.CREATE_ERROR,peerId:t,error:e,channelName:u,channelType:p,buferAmount:ji.getDataChannelBuffer(r)})),null}const E={dataChannel:r,peerId:t,channelName:u,channelProp:S,channelType:p,roomState:i,bufferThreshold:n};r.onopen=nn.onopen.bind(r,E),r.onmessage=nn.onmessage.bind(r,E),r.onerror=nn.onerror.bind(r,E),r.onbufferedamountlow=nn.onbufferedamountlow.bind(r,E),r.onclose=nn.onclose.bind(r,E);const h=p===Ge.MESSAGING?"main":u;return o.dataChannels[t][h]={channelName:u,channelType:p,transferId:null,streamId:null,channel:r},po.setSkylinkState(o,i.room.id),null},Rn=(e,t,r)=>{const n=vi(e);if(n)sn(n,t,r);else{const e=po.getSkylinkState(),n=Object.keys(e);for(let s=0;s<n.length;s+=1){const i=e[n[s]];sn(i,t,r);}}},fn=e=>{const t=vi(e);if(t){const e={},r=Object.keys(t.peerInformations);for(let n=0;n<r.length;n+=1)r[n]!==It.MCU&&(e[r[n]]=Object.assign({},ei.getPeerInfo(r[n],t.room)),e[r[n]].isSelf=!1);return t.user&&t.user.sid&&(e[t.user.sid]=Object.assign({},ei.getCurrentSessionInfo(t.room)),e[t.user.sid].isSelf=!0),e}return null},Tn=(e,t)=>{const r=po.getSkylinkState(t.room.id),n=r.peerEndOfCandidatesCounter[e],s=r.peerConnections[e],i=r.peerCandidatesQueue[e],o=r.gatheredCandidates[e],{TAGS:a}=Nt,{ICE_CONNECTION:c}=Dt;if(!n)return null;if(s&&s.signalingState!==je.CLOSED&&s.remoteDescription&&s.remoteDescription.sdp&&"number"==typeof n.expectedLen&&n.len>=n.expectedLen&&(!i||0===i.length)&&!n.hasSet){Ut.log.DEBUG([e,a.PEER_CONNECTION,null,c.END_OF_CANDIDATES_SUCCESS]),n.hasSet=!0;try{if(o){const t={expected:n.expectedLen||0,received:n.len||0,processed:o.receiving.srflx.length+o.receiving.relay.length+o.receiving.host.length};kt((d={room:r.room,peerId:e,candidatesLength:t},new pe("candidatesGathered",{detail:d})));}r.peerEndOfCandidatesCounter[e]=n,po.setSkylinkState(r,t.room.id);}catch(t){Ut.log.ERROR([e,a.PEER_CONNECTION,null,c.END_OF_CANDIDATES_FAILURE],t);}}var d;return null},_n=e=>({bufferedAmountLow:parseInt(e.bufferedAmountLow,10)||0,bufferedAmountLowThreshold:parseInt(e.bufferedAmountLowThreshold,10)||0}),In=(e,t)=>{const{dataChannels:r,peerConnections:n}=e;if((e=>!Ei(e))(r)&&Object.hasOwnProperty.call(r,t)){if(Object.hasOwnProperty.call(r[t],"main")){const s=r[t].main,{channelName:i,channelType:o}=s,a=s.channel.bufferedAmountLowThreshold||0;o===Ge.MESSAGING&&setTimeout(()=>{Object.hasOwnProperty.call(n,t)&&n[t].signalingState!==je.CLOSED&&n[t].localDescription.type===ze.OFFER&&(ji.closeDataChannel(e,t),Ut.log.DEBUG([t,"RTCDataChannel","main",Dt.DATA_CHANNEL.reviving_dataChannel]),ji.createDataChannel({roomState:e,peerId:t,dataChannel:i,bufferThreshold:a,createAsMessagingChannel:!0}));},100);}}else Ut.log.DEBUG([t,"RTCDataChannel",Dt.DATA_CHANNEL.refresh_error]);},Cn=(e,t,r="main")=>{try{const n=po.getSkylinkState(e.room.id),{dataChannels:s,room:i}=n;if(!s[t]||!s[t][r])return void Ut.log.WARN([t,St.DATA_CHANNEL,r||null,Dt.DATA_CHANNEL.ERRORS.NO_SESSIONS]);if("main"===r)return void((e,t)=>{const{dataChannels:r}=e,n=Object.keys(r[t]);for(let s=0;s<n.length;s+=1)Object.hasOwnProperty.call(r[t],n[s])&&on(e,t,n[s]);delete r[t];})(n,t);on(n,t,r),po.setSkylinkState(n,i.id);}catch(e){Ut.log.ERROR([t,St.DATA_CHANNEL,r||null,Dt.DATA_CHANNEL.ERRORS.FAILED_CLOSING],e);}},On=ln,An=(e,t,r=!1,n={})=>{const s=po.getSkylinkState(t.room.id),{hasMCU:i}=s;try{if(!i){const t=[];for(let i=0;i<e.length;i+=1){const o=e[i],a=Sn(o,s,{doIceRestart:r,bwOptions:n});t.push(a);}return Promise.all(t)}return ((e,t,r)=>new Promise(n=>{const s=e,i=po.getInitOptions(),{mcuUseRenegoRestart:o}=i;try{s.streamsBandwidthSettings.bAS=r.bandwidth||s.streamsBandwidthSettings.bAS,o&&(s.peerEndOfCandidatesCounter.MCU=s.peerEndOfCandidatesCounter.MCU||{},s.peerEndOfCandidatesCounter.MCU.len=0,po.setSkylinkState(s),n(un(s,It.MCU,t)));}catch(e){n([It.MCU,e]);}}))(t,r,n)}catch(e){return Ut.log.ERROR([null,St.PEER_CONNECTION,null,Dt.PEER_CONNECTION.REFRESH_CONNECTION.FAILED],e),null}},vn=(e,t)=>{const r=e,n=r.sid;return r.room=t.room.roomName,r.settings.data=!!(t.dataChannels[n]&&t.dataChannels[n].main&&t.dataChannels[n].main.channel&&t.dataChannels[n].main.channel.readyState===Le.OPEN),r},Nn=(e,t=null)=>{const{ROOM_STATE:r}=Dt;if(!e)return Ut.log.WARN(r.NO_ROOM_NAME),Pi(r.NO_ROOM_NAME);const{room:n}=e,s=((e,t)=>{const{peerConnections:r,room:n}=e,{PEER_CONNECTION:s}=Dt;let i=null,o=null;return hi(Object.keys(r))?o=s.NOT_INITIALISED:Array.isArray(t)?(i=t,i.forEach(e=>{Mi(n,e)||(o=`${s.PEER_ID_NOT_FOUND} ${e}`);})):Ii(t)?(Mi(n,t)||(o=`${s.PEER_ID_NOT_FOUND} ${t}`),i=[t]):i=Object.keys(r),{peerIds:i,errorMsg:o}})(e,t);if(s.errorMsg)return Ut.log.WARN(s.errorMsg),Pi(s.errorMsg);const{peerIds:i}=s,o=[];for(let e=0;e<i.length;e+=1){const t=new Hi(n.id,i[e]);o.push(t.getConnectionStatus());}return Promise.all(o)},Dn=(e,t)=>{const r=po.getSkylinkState(e.room.id),{peerConnections:n,room:s}=r;n[t].close(),po.setSkylinkState(r,s.id);},yn=(e,t,r,n)=>{const s=po.getSkylinkState(e.id);s.peerInformations[t].mediaStatus=((e,t,r,n)=>{const{peerMedias:s,peerInformations:i}=e,o=s[t],a=i[t].mediaStatus||{};return Object.values(o).forEach(e=>{e.transceiverMid===r.mid&&(a[n.id]={audioMuted:ki(n)?e.mediaState===gt.MUTED?0:1:-1,videoMuted:wi(n)?e.mediaState===gt.MUTED?0:1:-1});}),delete a.audioMuted,delete a.videoMuted,a})(s,t,r,n),po.setSkylinkState(s,e.id);},Pn=(e,t,r)=>{const n=e;n.currentRTCRTPSenders[t]||(n.currentRTCRTPSenders[t]=[]),n.currentRTCRTPSenders[t].push(r),po.setSkylinkState(n,n.room.id);};class Mn extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,local_candidate:{},remote_candidate:{}};}send(e,t,r){try{const n=po.getSkylinkState(e);if(!n)return;this.model.room_id=e,this.model.user_id=n&&n.user&&n.user.sid||null,this.model.peer_id=r,this.model.client_id=n.clientId,this.model.state=t,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),ji.retrieveStatistics(e,r,po.getInitOptions().beSilentOnStatsLogs).then(e=>{e&&["local","remote"].forEach(t=>{const r=e.selectedCandidatePair[t];if(r){const e=this.model[t+"_candidate"];e.ip_address=r.ipAddress||null,e.port_number=r.portNumber||null,e.candidate_type=r.candidateType||null,e.protocol=r.transport||null,e.priority=r.priority||null,"local"===t&&(this.model.local_candidate.network_type=r.networkType||null);}}),this.postStats(this.endpoints.iceConnection,this.model);}).catch(e=>{Ut.log.DEBUG(Dt.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.RETRIEVE_FAILED,e);});}catch(e){Ut.log.DEBUG(Dt.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.SEND_FAILED,e);}}}const kn=(e,t,r,n)=>{const s=e[t]["send"===r?"sending":"receiving"][n];return ["number","string","boolean"].indexOf(typeof s)>-1?s:null};class wn extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,peer_id:null,audio_send:{tracks:[]},audio_recv:{},video_send:{tracks:[]},video_recv:{},error:null},this.stats=null;}gatherSendAudioPacketsStats(){this.model.audio_send.bytes=kn(this.stats,"audio","send","bytes"),this.model.audio_send.packets=kn(this.stats,"audio","send","packets"),this.model.audio_send.echo_return_loss=kn(this.stats,"audio","send","echoReturnLoss"),this.model.audio_send.echo_return_loss_enhancement=kn(this.stats,"audio","send","echoReturnLossEnhancement"),this.model.audio_send.round_trip_time=kn(this.stats,"audio","send","roundTripTime"),this.model.audio_send.audio_level=kn(this.stats,"audio","send","audioLevel"),this.model.audio_send.jitter=kn(this.stats,"audio","send","jitter");}gatherReceiveAudioPacketsStats(){this.model.audio_recv.bytes=kn(this.stats,"audio","recv","bytes"),this.model.audio_recv.packets=kn(this.stats,"audio","recv","packets"),this.model.audio_recv.packets_lost=kn(this.stats,"audio","recv","packetsLost"),this.model.audio_recv.jitter=kn(this.stats,"audio","recv","jitter"),this.model.audio_recv.audio_level=kn(this.stats,"audio","recv","audioLevel");}gatherSendVideoPacketsStats(){this.model.video_send.bytes=kn(this.stats,"video","send","bytes"),this.model.video_send.packets=kn(this.stats,"video","send","packets"),this.model.video_send.nack_count=kn(this.stats,"video","send","nacks"),this.model.video_send.firs_count=kn(this.stats,"video","send","firs"),this.model.video_send.plis_count=kn(this.stats,"video","send","plis"),this.model.video_send.frames_encoded=kn(this.stats,"video","send","framesEncoded"),this.model.video_send.frame_width=kn(this.stats,"video","send","frameWidth"),this.model.video_send.frame_height=kn(this.stats,"video","send","frameHeight"),this.model.video_send.round_trip_time=kn(this.stats,"video","send","roundTripTime"),this.model.video_send.qp_sum=kn(this.stats,"video","send","qpSum"),this.model.video_send.jitter=kn(this.stats,"video","send","jitter"),this.model.video_send.frames=kn(this.stats,"video","send","frames"),this.model.video_send.hugeFrames=kn(this.stats,"video","send","hugeFramesSent"),this.model.video_send.framesPerSecond=kn(this.stats,"video","send","framesPerSecond");}gatherReceiveVideoPacketsStats(){this.model.video_recv.bytes=kn(this.stats,"video","recv","bytes"),this.model.video_recv.packets=kn(this.stats,"video","recv","packets"),this.model.video_recv.packets_lost=kn(this.stats,"video","recv","packetsLost"),this.model.video_recv.nack_count=kn(this.stats,"video","recv","nacks"),this.model.video_recv.firs_count=kn(this.stats,"video","recv","firs"),this.model.video_recv.plis_count=kn(this.stats,"video","recv","plis"),this.model.video_recv.frames_decoded=kn(this.stats,"video","recv","framesDecoded"),this.model.video_recv.qp_sum=kn(this.stats,"video","recv","qpSum"),this.model.video_recv.frames_decoded=kn(this.stats,"video","recv","framesDecoded"),this.model.video_recv.frames_dropped=kn(this.stats,"video","recv","framesDropped"),this.model.video_recv.decoderImplementation=kn(this.stats,"video","recv","decoderImplementation");}buildTrackInfo(e){const t=po.getSkylinkState(e),{peerStreams:r,user:n,streamsSettings:s}=t;if(r[n.sid]){Object.values(r[n.sid]).forEach(e=>{if(e){const t=e,{settings:r}=s[e.id],n=t.getAudioTracks(),i=t.getVideoTracks();n.forEach(e=>{const r=((e,t)=>({stream_id:e.id,id:t.id,label:t.label,muted:!t.enabled}))(t,e);this.model.audio_send.tracks.push(r);}),i.forEach(e=>{const n=((e,t,r)=>({stream_id:e.id,id:t.id,label:t.label,height:r.video.resolution.height,width:r.video.resolution.width,muted:!t.enabled}))(t,e,r);this.model.video_send.tracks.push(n);});}});}}send(e,t,r){const{STATS_MODULE:n}=Dt,s=po.getSkylinkState(e);s?Ei(s.peerStreams)||(this.model.client_id=s.clientId,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=r,ji.retrieveStatistics(e,r,po.getInitOptions().beSilentOnStatsLogs).then(t=>{t&&(this.stats=t,this.gatherSendAudioPacketsStats(),this.gatherReceiveAudioPacketsStats(),this.gatherSendVideoPacketsStats(),this.gatherReceiveVideoPacketsStats(),this.buildTrackInfo(e),this.postStats(this.endpoints.bandwidth,this.model));}).catch(e=>{this.model.error=e?e.message:null,Ut.log.DEBUG(n.HANDLE_BANDWIDTH_STATS.RETRIEVE_FAILED,e);})):Ut.log.DEBUG([r,"Statistics","Bandwidth_Stats",n.HANDLE_BANDWIDTH_STATS.NO_STATE]);}}let bn={};class Ln{constructor(e){if(e.roomKey)return this.resetBandwidthAdjusterInstance(e.roomKey,e.peerId),null;const{peerConnection:t,state:r,targetMid:n}=e;if(bn[n])return bn[n];this.peerId=n,this.state=r,this.peerConnection=t,this.bandwidth=null,bn[this.peerId]=this;}static formatTotalFn(e){let t=0;for(let r=0;r<e.length;r+=1)t+=e[r];return t/e.length}setAdjustmentInterval(){const{bandwidthAdjuster:e,peerStats:t,room:r}=this.state,{PEER_CONNECTION_STATE:n}=Nt;if(this.bandwidth)return;const s={audio:{send:[],recv:[]},video:{send:[],recv:[]}};let i=0;const o=setInterval(()=>{this.peerConnection&&this.peerConnection.signalingState!==n.CLOSED&&e&&t[this.peerId]?ji.retrieveStatistics(r.id,this.peerId,po.getInitOptions().beSilentOnStatsLogs,!0).then(t=>{if(this.peerConnection&&this.peerConnection.signalingState!==n.CLOSED&&e||clearInterval(o),s.audio.send.push(t.audio.sending.bytes?8*t.audio.sending.bytes:0),s.audio.recv.push(t.audio.receiving.bytes?8*t.audio.receiving.bytes:0),s.video.send.push(t.video.sending.bytes?8*t.video.sending.bytes:0),s.video.recv.push(t.video.receiving.bytes?8*t.video.receiving.bytes:0),i+=1,i===e.interval){i=0;let t=Ln.formatTotalFn(s.audio.send),r=Ln.formatTotalFn(s.video.send);e.useUploadBwOnly||(t+=Ln.formatTotalFn(s.audio.recv),r+=Ln.formatTotalFn(s.video.recv),t/=2,r/=2),t=parseInt(t*(e.limitAtPercentage/100)/1e3,10),r=parseInt(r*(e.limitAtPercentage/100)/1e3,10),ji.refreshConnection(this.state,this.peerId,!1,{bandwidth:{audio:t,video:r}});}}).catch(()=>{s.audio.send.push(0),s.audio.recv.push(0),s.video.send.push(0),s.video.recv.push(0);}):clearInterval(o);},1e3);this.bandwidth=s;}resetBandwidthAdjusterInstance(e,t=null){const r=po.getSkylinkState(e);r.streamsBandwidthSettings.bAS={},po.setSkylinkState(r,e),t?delete bn[t]:bn={};}}const Gn=e=>{const{ICE_CONNECTION_STATE:t}=Nt;return [t.COMPLETED,t.CONNECTED].indexOf(e)>-1},Un={ontrack:(e,t,r,n)=>{const s=po.getSkylinkState(r.room.id),{peerConnections:i,room:o,hasMCU:a}=s,c=n.streams[0],{transceiver:d,track:l}=n;let u=t;if(!c)return Ut.log.WARN("ontrack stream is null"),null;if(null===d.mid&&Ut.log.WARN("Transceiver mid is null",d),!i[u])return null;a&&(u=((e,t)=>{const{peerMedias:r,user:n}=e,s=Object.keys(r);for(let e=0;e<s.length;e+=1)if(s[e]!==n.sid){const n=Object.values(r[s[e]]);for(let r=0;r<n.length;r+=1)if(n[r].transceiverMid===t.mid)return s[e]}return null})(s,d));const p=Bn.retrieveScreenMediaInfo(s.room,u,{transceiverMid:d.mid}),S=[u,o,p];return c.onremovetrack=Un.onremovetrack.bind(void 0,...S),Bn.updateStreamIdFromOntrack(s.room,u,d.mid,c.id),ji.updatePeerInformationsMediaStatus(s.room,u,d,c),Wr.addStream(u,c,o.id),(new jr).send(o.id),zr.onRemoteTrackAdded(c,r,u,p,l.kind===mt.VIDEO,l.kind===mt.AUDIO),null},ondatachannel:(e,t,r,n)=>{const s=n.channel||n,i=po.getInitOptions(),o=po.getSkylinkState(r.room.id),{peerInformations:a}=o,{enableDataChannel:c}=i;Ut.log.DEBUG([t,"RTCDataChannel",s.label,"Received datachannel ->"],s),c&&a[t].config.enableDataChannel?(e.hasMainChannel||(e.hasMainChannel=!0),gn({peerId:t,dataChannel:s,roomState:r})):Ut.log.WARN([t,"RTCDataChannel",s.label,"Not adding datachannel as enable datachannel is set to false"]);},onicecandidate:(e,t,r,n)=>{Vr.onIceCandidate(t,n.candidate||n,r.room);},oniceconnectionstatechange:(e,t,r)=>{const{ROOM_STATE:n,ICE_CONNECTION:s,PEER_CONNECTION:i}=Dt,{ICE_CONNECTION_STATE:o,PEER_CONNECTION_STATE:a,BROWSER_AGENT:c}=Nt,d=po.getSkylinkState(r.room.id),{peerStreams:l,user:u,enableStatsGathering:p}=d,S=po.getInitOptions();let E=null;const h=e.iceConnectionState;if(bi(c.REACT_NATIVE)&&!d&&h===o.CLOSED)return;if(!d)return void Ut.log.DEBUG([t,"RTCIceConnectionState",null,n.NOT_FOUND]);const{hasMCU:m,bandwidthAdjuster:g,peerStats:R,streamsBandwidthSettings:f}=d;if(h===o.FAILED&&bi(c.FIREFOX)&&!l[u.sid])return;Ut.log.DEBUG([t,"RTCIceConnectionState",null,s.STATE_CHANGE],h);const T=new Mn;T.send(r.room.id,e.iceConnectionState,t),kt(Ce({state:h,peerId:t})),!E&&Gn(h)&&!R[t]&&p&&(E=!0,R[t]={},Ut.log.DEBUG([t,"RTCStatsReport",null,"Retrieving first report to tabulate results"]),ji.getConnectionStatus(d,t).then(()=>{E=setInterval(()=>{const n=po.getSkylinkState(d.room.id);n&&n.room.inRoom?e.connectionState===a.CLOSED||e.iceConnectionState===o.CLOSED?(e.connectionState===a.CLOSED&&(Ut.log.DEBUG([t,"RTCPeerConnectionState",null,i.STATE_CHANGE],e.connectionState),kt(Pe({state:a.CLOSED,peerId:t}))),e.iceConnectionState===o.CLOSED&&(Ut.log.DEBUG([t,"RTCIceConnectionState",null,s.STATE_CHANGE],e.iceConnectionState),T.send(r.room.id,e.iceConnectionState,t),kt(Ce({state:o.CLOSED,peerId:t}))),clearInterval(E)):(new wn).send(d.room.id,e,t):clearInterval(E);},1e3*S.statsInterval);})),!m&&Gn(h)&&g&&Ei(f.bAS)&&new Ln({targetMid:t,state:d,peerConnection:e}).setAdjustmentInterval();},onicegatheringstatechange:(e,t,r)=>{const{ICE_CONNECTION:n}=Dt,{iceGatheringState:s}=e;Ut.log.INFO([t,"RTCIceGatheringState",null,n.STATE_CHANGE],s),kt(Ie({state:s,room:Qs.getRoomInfo(r.room.id),peerId:t}));},onsignalingstatechange:(e,t)=>{const{PEER_CONNECTION:r}=Dt;Ut.log.DEBUG([t,"RTCPeerConnectionSignalingState",null,r.STATE_CHANGE],e.signalingState),kt(Pe({state:e.signalingState,peerId:t}));},onremovetrack:(e,t,r,n)=>{const s=Ai(t.id),{peerInformations:i}=s,{MEDIA_STREAM:o,PEER_INFORMATIONS:a}=Dt,c=bi(_t.REACT_NATIVE)?n.stream:n.target;Ut.log.INFO([e,St.MEDIA_STREAM,null,o.REMOTE_TRACK_REMOVED],{peerId:e,isSelf:!1,isScreensharing:r,track:n.track}),i[e]?c?(((e,t,r)=>{const n=e;delete n.peerInformations[t].mediaStatus[r],Wr.deleteStream(t,n.room,r),po.setSkylinkState(n,n.room.id);})(s,e,c.id),((e,t,r,n,s)=>{Wr.dispatchStreamEvent("streamEnded",{room:e.room,peerId:t,peerInfo:ei.getPeerInfo(t,e.room),isSelf:!1,isScreensharing:r,streamId:s.id,isVideo:n.track.kind===mt.VIDEO,isAudio:n.track.kind===mt.AUDIO});})(s,e,r,n,c),((e,t)=>{kt(Ae({peerId:t,peerInfo:ei.getPeerInfo(t,e.room),isSelf:!1}));})(s,e)):Ut.log.DEBUG([e,St.MEDIA_STREAM,null,""+o.ERRORS.DROPPING_ONREMOVETRACK-(""+o.NO_STREAM)]):Ut.log.DEBUG([e,St.MEDIA_STREAM,null,""+o.ERRORS.DROPPING_ONREMOVETRACK-`${a.NO_PEER_INFO} ${e}`]);},onsenderadded:(e,t,r,n)=>{const s=po.getSkylinkState(r.room.id),{sender:i}=n;Pn(s,t,i);},onconnectionstatechange:(e,t,r)=>{const{room:n}=r,{connectionState:s,iceConnectionState:i}=e;(new Mn).send(n.id,s===je.FAILED?Ve.FAILED:i,t),Ut.log.DEBUG([t,"RTCPeerConnectionState",null,Dt.PEER_CONNECTION.STATE_CHANGE],e.connectionState),kt(Pe({state:s,peerId:t}));}},Fn={retrieveTransceiverMid:(e,t)=>{const r=po.getSkylinkState(e.id),{peerConnections:n}=r,s=Object.values(n);let i=null;for(let e=0;e<s.length;e+=1){const r=s[e].getTransceivers();for(let e=0;e<r.length;e+=1)if(r[e].sender.track&&r[e].sender.track.id===t.id){i=r[e].mid;break}}return i},retrieveMediaState:e=>e.readyState===ht.ENDED?gt.UNAVAILABLE:e.muted?gt.MUTED:gt.ACTIVE,retrieveMediaId:(e,t)=>`${e===mt.AUDIO?"AUDIO":"VIDEO"}_${t}`,buildPeerMediaInfo:(e,t,r,n,s)=>({publisherId:t,mediaId:Fn.retrieveMediaId(r.kind,n),mediaType:s,mediaState:Fn.retrieveMediaState(r),transceiverMid:Fn.retrieveTransceiverMid(e,r),streamId:n,trackId:r.id,mediaMetaData:"",simulcast:""}),retrieveStreamIdOfTrack:(e,t)=>{const r=po.getSkylinkState(e.id),{peerStreams:n,user:s}=r,i=Object.values(n[s.sid]);let o=null;for(let e=0;e<i.length;e+=1){const r=i[e].getTracks();for(let n=0;n<r.length;n+=1)if(Hr(r[n],t)){o=i[e].id;break}}return o},updatePeerMediaInfo:(e,t,r,n,s=!1,i=!1,o=!1)=>{try{((e,t,r,n,s=!1,i=!1,o=!1)=>{const a=po.getSkylinkState(e.id);!o&&s&&i?(a.peerMedias[t][n][s]=i,Ut.log.INFO([t,St.PEER_MEDIA,null,`${Dt.MEDIA_INFO.UPDATE_SUCCESS} -- ${n} - ${s}: ${i}`])):!o||s||i||(a.peerMedias[t]=a.peerMedias[t]||{},a.peerMedias[t][n]=o),po.setSkylinkState(a,e.id);})(e,t,0,n,s,i,o),((e,t,r,n)=>{const s=po.getSkylinkState(e.id);s.user.sid===t&&r&&Fn.sendMediaInfoMsg(e,s.peerMedias[t][n]);})(e,t,r,n);}catch(e){const r=o?JSON.stringify(o):`${n} - ${s}: ${i}`;Ut.log.ERROR([t,St.PEER_MEDIA,null,`${Dt.MEDIA_INFO.ERRORS.FAILED_UPDATING} -- ${r}`],e);}},sendMediaInfoMsg:(e,t)=>{const r=new xs,n=po.getSkylinkState(e.id),{user:s,hasMCU:i,peerConnections:o}=n;(i?[It.MCU]:Object.keys(o).filter(e=>e!==s.sid&&e!==It.MCU)).forEach(e=>{r.mediaInfoEvent(n,e,t);});},parseSDPForTransceiverMid:(e,t,r)=>{const n=po.getSkylinkState(e.id),{peerMedias:s}=n,{beSilentOnParseLogs:i}=po.getInitOptions(),o=Object.values(s[t]),a=Bi.getTransceiverMid(r,i),c=a.audio,d=a.video;for(let r=0;r<o.length;r+=1){const n=o[r];n.transceiverMid=n.mediaState===gt.UNAVAILABLE?n.transceiverMid:null;for(let r=0;r<c.length;r+=1)if(c[r].streamId===n.streamId&&("sendonly"===c[r].direction||"sendrecv"===c[r].direction)){Fn.updatePeerMediaInfo(e,t,!1,n.mediaId,Rt.TRANSCEIVER_MID,c[r].transceiverMid);break}for(let r=0;r<d.length;r+=1)if(d[r].streamId===n.streamId&&("sendonly"===d[r].direction||"sendrecv"===d[r].direction)){Fn.updatePeerMediaInfo(e,t,!1,n.mediaId,Rt.TRANSCEIVER_MID,d[r].transceiverMid);break}}},retrieveValueGivenTransceiverMid:(e,t,r,n)=>{const{peerMedias:s}=e,i=Object.values(s[t]);for(let e=0;e<i.length;e+=1)if(i[e].transceiverMid===r)return i[e][n];return null},retrieveFormattedMediaInfo:(e,t)=>{const r=po.getSkylinkState(e.id),{peerMedias:n}=r,s=Object.values(n[t]),i=[];for(let e=0;e<s.length;e+=1){const t=s[e],r=Ft(t);delete r.trackId,delete r.streamId,i.push(r);}return i},resetPeerMedia:(e,t)=>{const r=po.getSkylinkState(e.id);return r.peerMedias[t]&&(r.peerMedias[t]={}),r},populatePeerMediaInfo:(e,t,r)=>{const n=e.peerMedias[r.publisherId]||{};return n[r.mediaId]=r,((e,t)=>!Ei(e)&&e[t])(t,r.mediaId)&&(n[r.mediaId].streamId=r.transceiverMid===t[r.mediaId].transceiverMid?t[r.mediaId].streamId:""),n},processOnRemoveTrack:(e,t,r)=>{if(bi(_t.REACT_NATIVE)&&r){const{room:n}=e,s={track:{id:null,kind:null}},i={id:null};if(s.track.id=r.trackId,s.track.kind=r.mediaType===Et.AUDIO||r.mediaType===Et.AUDIO_MIC?mt.AUDIO:mt.VIDEO,i.id=r.streamId,s.stream=i,!(s.track.id||s.track.kind||i.id))return void Ut.log.DEBUG([t,St.MEDIA_STREAM,null,""+Dt.BROWSER_AGENT.REACT_NATIVE.ERRORS.DROPPING_ONREMOVETRACK],s);Un.onremovetrack(t,n,r.mediaType===Et.VIDEO_SCREEN,s);}}};class Bn{static updatePeerMediaWithUserSid(e,t){const r=po.getSkylinkState(e.id);r.peerMedias[t]=Object.assign({},r.peerMedias.null),delete r.peerMedias.null,po.setSkylinkState(r,e.id),Object.keys(r.peerMedias[t]).forEach(r=>{Fn.updatePeerMediaInfo(e,t,!1,r,Rt.PUBLISHER_ID,t);});}static updateStreamIdFromOntrack(e,t,r,n){const s=po.getSkylinkState(e.id),i=Fn.retrieveValueGivenTransceiverMid(s,t,r,Rt.MEDIA_ID);Fn.updatePeerMediaInfo(e,t,!1,i,Rt.STREAM_ID,n);}static isVideoScreenTrack(e,t,r){const{peerMedias:n}=e,s=Object.values(n[t]);for(let e=0;e<s.length;e+=1)if(s[e].transceiverMid===r)return s[e].mediaType===Et.VIDEO_SCREEN;return !1}static setMediaStateToUnavailable(e,t,r){Fn.updatePeerMediaInfo(e,t,!1,r,Rt.MEDIA_STATE,gt.UNAVAILABLE);}static deleteUnavailableMedia(e,t,r=null){const n=po.getSkylinkState(e.id);if(t===It.MCU||!n.peerMedias[t])return;let s;if(r)s=Ft(n.peerMedias[t][r]),delete n.peerMedias[t][r];else{const e=n.peerMedias[t];Object.values(e).forEach(e=>{e.mediaState===gt.UNAVAILABLE&&(s=Ft(e),delete n.peerMedias[t][e.mediaId]);});}po.setSkylinkState(n,e.id),Fn.processOnRemoveTrack(n,t,s),s&&kt(((e={})=>new pe("mediaInfoDeleted",{detail:e}))({mediaInfo:s}));}static updatePeerMediaInfo(e,t,r,n,s){Fn.updatePeerMediaInfo(e,t,!0,r,n,s);}static setPeerMediaInfo(e,t,r=[]){try{const n=po.getSkylinkState(e.id);if(t!==It.MCU||hi(r)){if(t!==It.MCU){const s=Ft(n.peerMedias[t])||{},i=Fn.resetPeerMedia(e,t);r.forEach(e=>{i.peerMedias[e.publisherId]=Fn.populatePeerMediaInfo(i,s,e);}),po.setSkylinkState(i,e.id);}}else{const t=[];r.forEach(e=>{-1===t.indexOf(e.publisherId)&&t.push(e.publisherId);}),t.forEach(t=>{const n=r.filter(e=>{if(e.publisherId===t)return e});this.setPeerMediaInfo(e,t,n);});}}catch(e){Ut.log.ERROR([t,St.PEER_MEDIA,null,Dt.MEDIA_INFO.ERRORS.FAILED_SETTING_PEER_MEDIA_INFO]);}}static retrieveStreamId(e,t,r){const n=po.getSkylinkState(e.id),{peerMedias:s}=n,i=s[t][r],{streamId:o}=i;return o||Ut.log.ERROR([t,St.PEER_MEDIA,null,Dt.MEDIA_INFO.ERRORS.NO_ASSOCIATED_STREAM_ID]),o}static retrieveMediaId(e,t){return Fn.retrieveMediaId(e,t)}static retrieveMediaInfoForOfferAnswer(e,t){const r=po.getSkylinkState(e.id).user.sid;return Fn.parseSDPForTransceiverMid(e,r,t),Fn.retrieveFormattedMediaInfo(e,r)}static processPeerMedia(e,t,r,n,s=!1){const i=po.getSkylinkState(e.id).peerMedias[t]||{},o=r.getTracks();let a=null;try{o.forEach(o=>{a=Fn.retrieveMediaId(o.kind,r.id),i[a]=Fn.buildPeerMediaInfo(e,t,o,r.id,o.kind===mt.AUDIO?Et.AUDIO_MIC:n?Et.VIDEO_SCREEN:Et.VIDEO_CAMERA),Fn.updatePeerMediaInfo(e,t,s,a,null,null,i[a]);});}catch(e){Ut.log.ERROR([t,St.MEDIA_INFO,Dt.MEDIA_INFO.ERRORS.FAILED_PROCESSING_PEER_MEDIA],e);}}static retrieveScreenMediaInfo(e,t,r){const n=po.getSkylinkState(e.id),{peerMedias:s}=n,i=Object.values(s[t]);for(let e=0;e<i.length;e+=1){if(r.streamId&&i[e].streamId===r.streamId)return i[e].mediaType===Et.VIDEO_SCREEN&&i[e];if(r.transceiverMid&&i[e].transceiverMid===r.transceiverMid)return i[e].mediaType===Et.VIDEO_SCREEN;if(!r)return i[e].mediaType===Et.VIDEO_SCREEN}return Ut.log.ERROR([t,St.PEER_MEDIA,null,Dt.MEDIA_INFO.ERRORS.STREAM_ID_NOT_MATCHED]),!1}}const xn={enterAndWelcome:e=>{const t=po.getSkylinkState(e.rid),r={},{hasMCU:n}=t,{rid:s,mid:i,enableIceRestart:o,enableDataChannel:a,weight:c,agent:d,os:l,temasysPluginVersion:u,SMProtocolVersion:p,DTProtocolVersion:S,version:E,publisherId:h}=e;return r.publisherId=h||null,r.rid=s,r.mid=i,r.agent=d&&Ii(d)?d:"other",r.version=(e=>{if(!e||"string"!=typeof e)return 0;if(e.indexOf(".")>-1){const t=e.split(".");if(t.length>2){const e=t[0]||"0";return t.splice(0,1),parseFloat(`${e}.${t.join("0")}`,10)}return parseFloat(e||"0",10)}return parseInt(e||"0",10)})(E),r.SMProtocolVersion=Ii(p)?p:"2.1.0",r.DTProtocolVersion=Ii(S)?S:n||i===It.MCU?"0.1.3":"0.1.0",r.weight=fi(c)?c:0,r.enableDataChannel=!_i(a)||a,r.enableIceRestart=!!_i(o)&&o,r.os=l&&Ii(l)?l:null,r.temasysPluginVersion=u&&Ii(u)?u:null,r.userInfo=xn.parseUserInfo(t,e,r),n&&(r.peersInRoom=e.peersInRoom),Ft(r)},parseUserInfo:(e,t,r)=>{const n=Object.assign({},t.userInfo);return n.config=n.config?n.config:{enableDataChannel:r.enableDataChannel,enableIceRestart:r.enableIceRestart,priorityWeight:r.weight},n.agent=n.agent?n.agent:{name:r.agent,version:r.version,os:r.os,pluginVersion:r.temasysPluginVersion,SMProtocolVersion:r.SMProtocolVersion,DTProtocolVersion:r.DTProtocolVersion},n.settings=n.settings?n.settings:{},n.mediaStatus=n.mediaStatus?n.mediaStatus:{},n}},Vn=(e,t,r)=>{const{room:n}=e;e.peerInformations[t]=ji.buildPeerInformations(r,e),po.setSkylinkState(e,n.id);},Hn=e=>{const{currentRoom:t,targetMid:r,cert:n,userInfo:s,message:i,caller:o}=e;let a=!1;const c=po.getSkylinkState(t.id),{hasMCU:d}=c,{peerInformations:l}=c;if(!l[r]&&!d||d&&r===It.MCU&&!l.MCU){const e=!!s.screenshare;a=!0,c.peerInformations[r]=ji.buildPeerInformations(i.userInfo,c);const o={agent:s.agent.name,version:s.agent.version,os:s.agent.os};po.setSkylinkState(c,t.id),ji.addPeer({currentRoom:t,targetMid:r,peerBrowser:o,cert:n,hasScreenshare:e}),r===It.MCU?(Ut.log.INFO([r,St.PEER_CONNECTION,null,Dt.PEER_CONNECTION.MCU]),c.hasMCU=!0,kt(((e={})=>new pe("serverPeerJoined",{detail:e}))({peerId:r,serverPeerType:Ke.MCU,room:Qs.getRoomInfo(t.id)}))):kt(ve({peerId:r,peerInfo:ei.getPeerInfo(r,t),isSelf:!1,room:Qs.getRoomInfo(t.id)}));}if(c.peerMessagesStamps[r]=c.peerMessagesStamps[r]||{userData:0,audioMuted:0,videoMuted:0},o===jn.WELCOME&&(c.peerMessagesStamps[r].hasWelcome=!1),o===jn.WELCOME&&d&&Array.isArray(i.peersInRoom)&&i.peersInRoom.length){const e=c.user.sid;for(let r=0;r<i.peersInRoom.length;r+=1){const n=i.peersInRoom[r].mid;if(n!==e){const e=xn.enterAndWelcome(i.peersInRoom[r]).userInfo;Vn(c,n,e),kt(ve({peerId:n,peerInfo:ei.getPeerInfo(n,t),isSelf:!1,room:Qs.getRoomInfo(t.id)}));}}}else d&&r!==c.user.sid&&r!==It.MCU&&(Vn(c,r,s),kt(ve({peerId:r,peerInfo:ei.getPeerInfo(r,t),isSelf:!1,room:Qs.getRoomInfo(t.id)})));po.setSkylinkState(c,t.id),a&&kt(fe({peerId:r,state:ze.WELCOME,error:null,room:Qs.getRoomInfo(t.id)}));},jn={ENTER:"enterHandler",WELCOME:"welcomeHander"},Wn=e=>{const{currentRoom:t,targetMid:r,message:n}=e,s=po.getSkylinkState(t.id),{peerConnections:i,hasMCU:o}=s,{STATS_MODULE:a,NEGOTIATION_PROGRESS:c,PEER_CONNECTION:d}=Dt,l=new xs,u=(e=>{let t="welcome";if(e.caller===jn.WELCOME){const r=po.getSkylinkState(e.currentRoom.id),{peerMessagesStamps:n,peerPriorityWeight:s,hasMCU:i}=r;(i||s>e.message.weight)&&(n[e.targetMid].hasWelcome?(t="noop",Ut.log.WARN([e.targetMid,St.PEER_CONNECTION,null,'Discarding extra "welcome" received.'])):(t="offer",r.peerMessagesStamps[e.targetMid].hasWelcome=!0,po.setSkylinkState(r,e.currentRoom.id)));}return t})(e);if("offer"===u){if(!i[r])return Ut.log.WARN([r,"RTCSessionDescription","offer",d.NO_PEER_CONNECTION]),Jr.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,r,n,!1,d.NO_PEER_CONNECTION),null;const{signalingState:s}=i[r];if(s!==je.STABLE)return Ut.log.WARN([r,"RTCSessionDescription","offer",c.ERRORS.NOT_STABLE],s),Jr.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,r,n,!1,c.ERRORS.NOT_STABLE),null;l[u](e.currentRoom,e.targetMid);}else o||l[u](e.currentRoom,e.targetMid);},Kn=(e,t)=>{const r=xn.enterAndWelcome(e),{rid:n,mid:s,userInfo:i,publisherId:o}=r,a=po.getSkylinkState(n),{hasMCU:c}=a,d=c&&o?o:s;((e,t,r,n)=>{const{room:s}=r;let i="enter";e===jn.WELCOME&&(i="welcome"),Ut.log.INFO([t,St.PEER_CONNECTION,null,`Peer ${i} received ->`],n),Jr.send(s.id,i,t,n,!0);})(t,d,a,r);const l={currentRoom:a.room,targetMid:d,userInfo:i,message:r,caller:t};Hn(l),Wn(l);},$n=(e,t,r,n)=>{const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:s}}=Dt,{peerConnections:i,bufferedLocalOffer:o,room:a}=e,c=i[t],d="offer"===r.type?"OFFER":"ANSWER";Jr.send(a.id,s[d].set,t,r,n),n&&kt(fe({state:ze[d],peerId:t,room:Qs.getRoomInfo(a.id)})),n?("offer"===r.type?c.setOffer="remote":c.setAnswer="remote",Vr.addIceCandidateFromQueue(t,a)):(o[t]=null,"offer"===r.type?c.setOffer="local":c.setAnswer="local"),po.setSkylinkState(e,a.id);},Yn=(e,t,r,n,s)=>{const{room:i,user:o}=e,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:a}}=Dt,c="offer"===r.type?"OFFER":"ANSWER";Jr.send(i.id,a[c].set_error,t,r,n,s),kt(fe({state:ze.ERROR,peerId:n?t:o.sid,error:s,room:Qs.getRoomInfo(i.id)}));},zn=(e,t,r)=>{const n=po.getSkylinkState(e.id),{peerConnections:s}=n,{type:i}=r,o=s[t],{STATS_MODULE:a}=Dt,c="offer"===i?"OFFER":"ANSWER";return o.processingLocalSDP=!0,Jr.send(e.id,a.HANDLE_NEGOTIATION_STATS[c][i],t,r,!1),o.setLocalDescription(r).then(()=>o)},Jn=(e,t,r,n)=>{const s=po.getSkylinkState(t.id),{peerConnections:i}=s,{NEGOTIATION_PROGRESS:o}=Dt,a=i[r]=e;Ut.log.DEBUG([r,St.SESSION_DESCRIPTION,n.type,o.SET_LOCAL_DESCRIPTION],n),a.processingLocalSDP=!1,$n(s,r,n,!1);},Qn=(e,t,r,n)=>{const s=po.getSkylinkState(e.id),{peerConnections:i}=s,o=i[t],{NEGOTIATION_PROGRESS:a}=Dt;Ut.log.ERROR([t,St.SESSION_DESCRIPTION,r.type,a.FAILED_SET_LOCAL_DESCRIPTION],n),o.processingLocalSDP=!1,o.negotiating=!1,Yn(s,t,r,!1,n);},Xn=(e,t,r)=>{const n=po.getSkylinkState(e.id),{peerConnections:s}=n,{type:i}=r,{STATS_MODULE:o}=Dt,a=s[t],c="offer"===i?"OFFER":"ANSWER";a.processingRemoteSDP=!0,Jr.send(e.id,o.HANDLE_NEGOTIATION_STATS[c][i],t,r,!0);const d=((e,t,r)=>{const n=t;return n.sdp=Bi.setSDPBitrate(e,n,r),n})(t,r,e.id);return a.setRemoteDescription(d).then(()=>a)},qn=(e,t,r)=>{const n=e;n.peerConnections[t].negotiating=!1,po.setSkylinkState(n,t);(new xs).answerAck(e,t,r);},Zn=(e,t,r,n)=>{const s=new xs,{type:i}=n,{NEGOTIATION_PROGRESS:o,DATA_CHANNEL:a}=Dt,c=po.getSkylinkState(t.id),{peerConnections:d}=c,l=d[r]=e;return Ut.log.DEBUG([r,St.SESSION_DESCRIPTION,i,o.SET_REMOTE_DESCRIPTION],n),l.processingRemoteSDP=!1,"offer"===i?($n(c,r,n,!0),s.answer(c,r)):(c.peerMessagesStamps[r]&&(c.peerMessagesStamps[r].hasRestart=!1),c.dataChannels[r]&&(-1===l.remoteDescription.sdp.indexOf("m=application")||l.remoteDescription.sdp.indexOf("m=application 0")>0)&&(Ut.log.WARN([r,St.PEER_CONNECTION,null,`${a.CLOSING} - ${a.NO_REMOTE_DATA_CHANNEL}`]),ji.closeDataChannel(c,r)),$n(c,r,n,!0),qn(c,r,!0),!0)},es=(e,t,r,n)=>{const s=po.getSkylinkState(e.id),{peerConnections:i}=s,o=i[t],{type:a}=r;Ut.log.ERROR([t,St.SESSION_DESCRIPTION,a,Dt.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_DESCRIPTION+" ->"],{error:n,state:o.signalingState,[a]:r}),o.processingRemoteSDP=!1,o.negotiating=!1,Yn(s,t,r,!0,n),"answer"===a&&qn(s,t,!1);},ts=e=>{const{rid:t,mid:r,type:n,sdp:s,mediaInfoList:i}=e,o=po.getSkylinkState(t),{hasMCU:a,room:c,bufferedLocalOffer:d}=o,l=r,u="offer"===n?"OFFER":"ANSWER",{NEGOTIATION_PROGRESS:p}=Dt;if(Ut.log.INFO([l,null,n,`Received ${n} from peer. ${u}:`],e),((e,t)=>{const{weight:r,type:n,mid:s,sdp:i,resend:o}=t,{peerPriorityWeight:a,bufferedLocalOffer:c,room:d,peerConnections:l}=e,{STATS_MODULE:u,NEGOTIATION_PROGRESS:p,PEER_CONNECTION:S}=Dt,E=s,h=l[E],m="offer"===n?"OFFER":"ANSWER";let g=null;if(!h)return Ut.log.ERROR([E,null,n,`${S.NO_PEER_CONNECTION}. Unable to set${"offer"===n?"Remote":"Local"}Offer.`]),g=S.NO_PEER_CONNECTION,Jr.send(d.id,u.HANDLE_NEGOTIATION_STATS[m].dropped,E,t,!0,g),!1;const{processingRemoteSDP:R,processingLocalSDP:f,negotiating:T}=h;if("offer"===n&&l[E].signalingState!==je.STABLE&&(Ut.log.WARN([E,null,n,p.ERRORS.NOT_STABLE],{signalingState:l[E].signalingState,isRestart:!!o}),g=`Peer connection state is ${l[E].signalingState}.`),"offer"===n&&c[E]&&a>r&&(Ut.log.WARN([E,null,n,p.ERRORS.OFFER_TIEBREAKER],{selfWeight:a,messageWeight:r}),g=p.ERRORS.OFFER_TIEBREAKER),R)Ut.log.WARN([E,St.SESSION_DESCRIPTION,n,p.ERRORS.PROCESSING_EXISTING_SDP],i),g=p.ERRORS.PROCESSING_EXISTING_SDP;else if(!f&&!R&&T&&"offer"===n){const r=e;Ut.log.DEBUG([E,St.SESSION_DESCRIPTION,n,p.ERRORS.ADDING_REMOTE_OFFER_TO_BUFFER],t),r.bufferedRemoteOffers[E]=r.bufferedRemoteOffers[E]?r.bufferedRemoteOffers[E]:[],r.bufferedRemoteOffers[E].push(t),po.setSkylinkState(r,d.id);}return g&&Jr.send(d.id,u.HANDLE_NEGOTIATION_STATS[m].dropped,E,t,!0,g),!g})(o,e))try{if(((e,t)=>{const r=e,{userInfo:n,rid:s,mid:i}=t,o=n,a=i;n&&"object"==typeof n&&(o.settings.data=!!(r.dataChannels[a]&&r.dataChannels[a].main&&r.dataChannels[a].main.channel&&r.dataChannels[a].main.channel.readyState===Le.OPEN),r.peerInformations[a].settings=o.settings||{},r.peerInformations[a].mediaStatus=o.mediaStatus||{},r.peerInformations[a].userData=o.userData),r.peerConnections[a].negotiating=!0,po.setSkylinkState(r,s);})(o,e),Bn.setPeerMediaInfo(c,l,i),Bn.deleteUnavailableMedia(c,l),"offer"===n){let e=null;const t={type:n,sdp:a?s.replace(/\r\n/g,"\n").split("\n").join("\r\n"):s};Xn(c,l,t).then(e=>Zn(e,c,l,t)).catch(e=>es(c,l,t,e)).then(t=>(e={type:t.type,sdp:t.sdp},zn(c,l,e))).then(t=>Jn(t,c,l,e)).catch(t=>Qn(c,l,e,t));}else if(d[l]){const e=d[l],t={type:n,sdp:a?s.replace(/\r\n/g,"\n").split("\n").join("\r\n"):s};zn(c,l,e).then(t=>Jn(t,c,l,e)).catch(t=>Qn(c,l,e,t)).then(()=>Xn(c,l,t)).then(e=>Zn(e,c,l,t)).catch(e=>es(c,l,t,e));}else Ut.log.ERROR([l,St.PEER_CONNECTION,null,p.ERRORS.NO_LOCAL_BUFFERED_OFFER]);}catch(e){Ut.log.ERROR([l,St.SESSION_DESCRIPTION,n,`Failed processing ${u} ->`],e);}return null};class rs extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,contents:null};}send(e,t){const r=po.getSkylinkState(e);this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.client_id=r.clientId,this.model.state=t.type,this.model.contents=t,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.session,this.model);}}const ns=(e,t)=>{po.getSkylinkState(e).peerConnections[t]&&((e,t)=>{const r=po.getSkylinkState(e);r.peerConnections[t].signalingState!==je.CLOSED&&r.peerConnections[t].close();})(e,t);},ss=(e,t)=>{const r=po.getSkylinkState(e);if(!((e,t)=>{const r=e;return !!r&&(!(!r.peerConnections[t]&&!r.peerInformations[t])||(Ut.log.DEBUG([t,St.PEER_CONNECTION,null,`${Dt.ROOM.LEAVE_ROOM.DROPPING_HANGUP} - ${Dt.PEER_CONNECTION.NO_PEER_CONNECTION}`]),!1))})(r,t))return;const{room:n}=r,s=ei.getPeerInfo(t,n);if(t===It.MCU){const e=r;return kt(De({peerId:t,serverPeerType:Ke.MCU,room:n})),e.hasMCU=!1,void po.setSkylinkState(e,n.id)}kt(Ne({peerId:t,peerInfo:s,isSelf:!1,room:n}));};class is extends Jt{constructor(){super(),this.model={client_id:null,app_key:null,timestamp:null,room_id:null,user_id:null,state:null,recording_id:null,recordings:null,error:null};}send(e,t,r,n,s){const i=po.getSkylinkState(e);this.model.client_id=i.clientId,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.state=t,this.model.recording_id=r,this.model.recordings=n,this.error=("string"==typeof s?s:s&&s.message)||null,this.postStats(this.endpoints.recording,this.model);}}const os=new is,as=(e,t,r)=>{const n={state:e,recordingId:t};r&&(n.error=r),kt(((e={})=>new pe("recordingState",{detail:e}))(n));},cs="startSuccess",ds="stopSuccess",ls=(e,t,r,n,s)=>{const i=ei.getPeerInfo(r,e.room);kt(me({isSelf:!1,peerId:r,peerInfo:i,streamId:t,isAudio:n===mt.AUDIO,isVideo:n===mt.VIDEO,isScreensharing:s})),kt(Ae({isSelf:!1,peerId:r,peerInfo:i}));},us=(e,t,r)=>{Ut.log.WARN([e,St.SIG_SERVER,`${Dt.MEDIA_INFO.WARN.READ_ONLY_VALUE} ${r}`],t);},ps=(e,t)=>{const{rid:r,mediaId:n,transceiverMid:s}=t,i=po.getSkylinkState(r);Bn.updatePeerMediaInfo(i.room,e,n,Rt.TRANSCEIVER_MID,s);},Ss=(e,t,r,n)=>{if(n.mediaState===gt.UNAVAILABLE)((e,t,r,n)=>{const{mediaId:s}=n;Bn.setMediaStateToUnavailable(e,r,s),Bn.deleteUnavailableMedia(e,r,s);})(e,0,r,n);else switch(t){case Et.VIDEO_SCREEN:case Et.VIDEO_CAMERA:case Et.VIDEO_OTHER:case Et.VIDEO:setTimeout(()=>{((e,t)=>{const{type:r,rid:n,mediaId:s,mediaState:i,mediaType:o}=t,a=po.getSkylinkState(n),{room:c}=a,d=Bn.retrieveStreamId(c,e,s),l=(new Date).toISOString();if(Ut.log.INFO([e,St.SIG_SERVER,r,Dt.MEDIA_INFO.VIDEO_STATE_CHANGE,i,d],t),a.peerInformations[e]){if(a.peerMessagesStamps[e]){if(l<a.peerMessagesStamps[e].videoMuted)return void Ut.log.WARN([e,St.SIG_SERVER,r,Dt.SIGNALING.OUTDATED_MSG],t);a.peerMessagesStamps[e].videoMuted=l;}a.peerInformations[e].mediaStatus[d]||(a.peerInformations[e].mediaStatus[d]={}),a.peerInformations[e].mediaStatus[d].videoMuted=i===gt.MUTED||i===gt.STOPPED?pt.MUTED:pt.ACTIVE,po.setSkylinkState(a,c.id),ls(a,d,e,mt.VIDEO,o===Et.VIDEO_SCREEN);}else Ut.log.WARN([e,St.PEER_INFORMATION,r,`${Dt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`]);})(r,n);},100);break;case Et.AUDIO_MIC:case Et.AUDIO:setTimeout(()=>{((e,t)=>{const{type:r,rid:n,mediaId:s,mediaState:i}=t,o=po.getSkylinkState(n),{room:a}=o,c=Bn.retrieveStreamId(a,e,s),d=(new Date).toISOString();if(Ut.log.INFO([e,St.SIG_SERVER,r,Dt.MEDIA_INFO.AUDIO_STATE_CHANGE,i,c],t),o.peerInformations[e]){if(o.peerMessagesStamps[e]){if(d<o.peerMessagesStamps[e].audioMuted)return void Ut.log.WARN([e,St.SIG_SERVER,r,Dt.SIGNALING.OUTDATED_MSG],t);o.peerMessagesStamps[e].audioMuted=d;}o.peerInformations[e].mediaStatus[c]||(o.peerInformations[e].mediaStatus[c]={}),o.peerInformations[e].mediaStatus[c].audioMuted=i===gt.MUTED||i===gt.STOPPED?pt.MUTED:pt.ACTIVE,po.setSkylinkState(o,a.id),ls(o,c,e,mt.AUDIO,!1);}else Ut.log.WARN([e,St.PEER_INFORMATION,r,`${Dt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`]);})(r,n);},100);break;default:Ut.log.ERROR([r,St.SIG_SERVER,`${Dt.MEDIA_INFO.WARN.INVALID_MEDIA_TYPE} ${t}`],n);}},Es=(e,t,r,n,s)=>{const i=po.getSkylinkState(e),{peerMedias:o}=i,a=o[t][r];return a[n]&&a[n]!==s},hs=(e,t)=>{Dr.processMessage(e,t);},ms=e=>{ts(e);},gs=e=>{const{mid:t,rid:r,success:n}=e,s=po.getSkylinkState(r),i=t;kt(fe({state:ze.ANSWER_ACK,peerId:i,room:s.room})),s.peerConnections[i].negotiating=!1,po.setSkylinkState(s,r),n?((e,t)=>{if(e.bufferedRemoteOffers[t]&&!hi(e.bufferedRemoteOffers[t])){const r=e.bufferedRemoteOffers[t].shift();return Ut.log.DEBUG([t,"RTCSessionDescription",r.type,Dt.NEGOTIATION_PROGRESS.APPLYING_BUFFERED_REMOTE_OFFER],r),ts(r),po.setSkylinkState(e,e.room.id),!0}return !1})(s,i)||((e,t)=>{const{peerConnections:r,currentRTCRTPSenders:n}=e;return new Promise(e=>{const s=r[t],i=s.getSenders()?s.getSenders():[],o=[],a=n[t]||[];let c=!1;i.forEach(e=>{o.push(e.getStats());});const d={};Promise.all(o).then(t=>{t.forEach((e,t)=>{e.forEach(e=>{e&&e.ssrc&&0!==e.bytesSent?d[e.ssrc]=i[t]:e&&"ssrc"===e.type&&e.id.indexOf("send")>1&&e.values.forEach(e=>{e.ssrc&&(d[e.ssrc]=i[t]);});});});const r=Object.keys(d);if(r.length!==a.length)c=!0;else{let e=0;for(let t=0;t<r.length;t+=1){const n=d[r[t]];for(let t=0;t<a.length;t+=1){if(n===a[t]){e+=1;break}}}c=e!==r.length;}e(c);});})})(s,i).then(e=>{e&&ln(s,i).catch(e=>{Ut.log.ERROR([t,St.SESSION_DESCRIPTION,ze.ANSWER_ACK,Dt.NEGOTIATION_PROGRESS.ERRORS.FAILED_RENEGOTIATION],e);});}):Ut.log.ERROR([i,St.SESSION_DESCRIPTION,ze.ANSWER,Dt.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_ANSWER]);},Rs=e=>{const{pc_config:{iceServers:t},sid:r,rid:n,tieBreaker:s}=e,i=po.getSkylinkState(n),o=new xs;i.room.connection.peerConfig=Vr.setIceServers(t),i.room.inRoom=!0,i.user.sid=r,Ut.log.INFO([null,St.SIG_SERVER,null,Dt.PEER_INFORMATIONS.SET_PEER_PRIORITY_WEIGHT+": "],s),i.peerPriorityWeight=s,Bn.updatePeerMediaWithUserSid(i.room,r),Wr.updatePeerStreamWithUserSid(i.room,r),po.setSkylinkState(i,n),kt(ve({peerId:i.user.sid,peerInfo:ei.getCurrentSessionInfo(i.room),isSelf:!0,room:i.room})),((e,t)=>{const r=po.getSkylinkState(e.id);r.peerStreams[t]&&Object.values(r.peerStreams[t]).forEach(r=>{Wr.dispatchStreamEvent("onIncomingStream",{stream:r,peerId:t,room:Qs.getRoomInfo(e.id),isSelf:!0,peerInfo:ei.getCurrentSessionInfo(e),streamId:r.id,isVideo:r.getVideoTracks().length>0,isAudio:r.getAudioTracks().length>0});});})(i.room,r),((e,t)=>{const r=po.getInitOptions();(new jr).send(e);const n=setInterval(()=>{const r=po.getSkylinkState(e),s=r?r.user.sid:null;r&&s===t?(new jr).send(r.room.id):clearInterval(n);},1e3*r.statsInterval);})(i.room.id,r),o.enterRoom(i);},fs=e=>{Kn(e,jn.ENTER);},Ts=e=>{ts(e);},_s=e=>{Kn(e,jn.WELCOME);},Is=e=>{const{candidate:t,mid:r,rid:n}=e,s=po.getSkylinkState(n),{room:i}=s,o=s.peerConnections[r],a=s.peerEndOfCandidatesCounter[r]||{},{RTCIceCandidate:c}=window,{ICE_CANDIDATE:d,PEER_CONNECTION:l,STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:u}}=Dt,p=new kr;if(!t&&!e.id)return Ut.log.WARN([r,St.CANDIDATE_HANDLER,null,d.INVALID_CANDIDATE],e),null;const S=new c({sdpMLineIndex:e.label,candidate:t,sdpMid:e.id}),E="can-"+S.foundation,h=S.candidate.split(" ")[7]||"";Ut.log.DEBUG([r,St.CANDIDATE_HANDLER,`${E}:${h}`,d.VALID_CANDIDATE],S),a.len=a.len||0,a.hasSet=!1,a.len+=1,po.setSkylinkState(s,n);const m={candidate:{candidate:S.candidate,sdpMid:S.sdpMid,sdpMLineIndex:S.sdpMLineIndex},error:null};if(kt(_e({room:i,state:xe.RECEIVED,peerId:r,candidateId:E,candidateType:h,candidate:m.candidate,error:m.error})),!o||o.signalingState===je.CLOSED)return Ut.log.WARN([r,St.CANDIDATE_HANDLER,`${E}:${h}`,l.NO_PEER_CONNECTION]),m.error=new Error(l.NO_PEER_CONNECTION),p.send(i.id,u.PROCESS_FAILED,r,E,m.candidate,m.error),kt(_e({room:i,state:xe.DROPPED,peerId:r,candidateId:E,candidateType:h,candidate:m.candidate,error:m.error})),ji.signalingEndOfCandidates(r,s),null;o.remoteDescription&&o.remoteDescription.sdp&&o.localDescription&&o.localDescription.sdp?Vr.addIceCandidate(r,E,h,S,s):Vr.addIceCandidateToQueue(r,E,h,S,s),ji.signalingEndOfCandidates(r,s);let g=s.gatheredCandidates[r];return g||(g={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),g.receiving[h].push({sdpMid:S.sdpMid,sdpMLineIndex:S.sdpMLineIndex,candidate:S.candidate}),s.gatheredCandidates[r]=g,po.setSkylinkState(s,n),null},Cs=e=>{const{result:t,type:r}=e,n=t;Ut.log.INFO(["Server",null,r,"Received list of peers"],n),kt(ye({state:Je.DISPATCHED,privilegePeerId:null,peerList:n}));},Os=e=>{const t=po.getSkylinkState(),{room:r,user:n}=t;Ut.log.WARN(["Server",null,e.type,"Introduce failed. Reason: "+e.reason]);(new rs).send(r.id,e),kt(((e={})=>new pe("introduceStateChange",{detail:e}))({state:"introduceStateChange".ERROR,privilegedPeerId:n.sid,receivingPeerId:e.receivingPeerId,sendingPeerId:e.sendingPeerId,reason:e.reason}));},As=e=>{const{mid:t,rid:r,status:n,streamId:s,settings:i}=e,o=Oi(r),{room:a,peerInformations:c}=o;return n===ct.ENDED&&(i.isScreensharing&&(c[t].screenshare=!1,po.setSkylinkState(o,a.id)),kt(he({room:a,peerId:t,peerInfo:ei.getPeerInfo(t,a),streamId:s,isSelf:!1,isScreensharing:i.isScreensharing,options:i,isVideo:!!i.audio,isAudio:!!i.video}))),null},vs=e=>{const{mid:t,rid:r,publisherId:n}=e,s=r;let i=t;po.getSkylinkState(s).hasMCU&&(i=n),Ut.log.INFO([i,St.PEER_CONNECTION,null,Dt.ROOM.LEAVE_ROOM.PEER_LEFT.START]);try{ss(s,i),ns(s,i),((e,t)=>{const r=po.getSkylinkState(e);setTimeout(()=>{const n=po.getSkylinkState(e);Ei(n)||(delete n.peerConnections[t],po.setSkylinkState(n,n.room.id)),r.hasMCU||(new jr).send(e),Ut.log.INFO([t,St.PEER_CONNECTION,null,Dt.ROOM.LEAVE_ROOM.PEER_LEFT.SUCCESS]);},500),r.bandwidthAdjuster&&!r.hasMCU&&new Ln({roomKey:r.room.id,peerId:t}),delete r.peerInformations[t],delete r.peerMedias[t],delete r.peerMessagesStamps[t],delete r.peerEndOfCandidatesCounter[t],delete r.peerCandidatesQueue[t],delete r.peerStats[t],delete r.gatheredCandidates[t],delete r.peerStreams[t],delete r.currentRTCRTPSenders[t],delete r.bufferedLocalOffer[t];})(s,i),((e,t)=>{const r=po.getSkylinkState(e);ji.closeDataChannel(r,t);})(s,i);}catch(e){Ut.log.DEBUG([i,St.ROOM,null,Dt.ROOM.LEAVE_ROOM.PEER_LEFT.ERROR],e);}},Ns=e=>{const{action:t,rid:r,recordingId:n,error:s}=e,i=Oi(r);"on"===t?((e,t)=>{const r=Object.assign({},e),{room:n}=r;Ut.log.DEBUG([It.MCU,St.RECORDING,t,Dt.RECORDING.START_SUCCESS]),os.send(n.id,Dt.STATS_MODULE.HANDLE_RECORDING_STATS.START,t,null,null),r.currentRecordingId=t,r.recordings[t]={active:!0,state:it.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,error:null},r.recordingStartInterval=setTimeout(()=>{Ut.log.INFO([It.MCU,St.RECORDING,t,Dt.RECORDING.MIN_RECORDING_TIME_REACHED]),r.recordingStartInterval=null;},4e3),po.setSkylinkState(r,n.id),as(it.START,t);})(i,n):"off"===t?((e,t)=>{const r=Object.assign({},e),{room:n,recordings:s}=r;os.send(n.id,Dt.STATS_MODULE.HANDLE_RECORDING_STATS.STOP,t,null,null),s[t]?(r.currentRecordingId=null,r.recordingStartInterval&&(clearTimeout(r.recordingStartInterval),Ut.log.WARN([It.MCU,St.RECORDING,t,Dt.RECORDING.ERRORS.STOP_ABRUPT]),r.recordingStartInterval=null),Ut.log.DEBUG([It.MCU,St.RECORDING,t,Dt.RECORDING.STOP_SUCCESS]),r.recordings[t].active=!1,r.recordings[t].state=it.STOP,r.recordings[t].endedDateTime=(new Date).toISOString(),po.setSkylinkState(r,n.id),as(it.STOP,t)):Ut.log.ERROR([It.MCU,St.RECORDING,t,Dt.RECORDING.ERRORS.SESSION_EMPTY]);})(i,n):"error"===t&&(as(null,n,s),Ut.log.ERROR([It.MCU,St.RECORDING,n,Dt.RECORDING.ERRORS.MCU_RECORDING_ERROR],s),os.send(i.room.id,Dt.STATS_MODULE.HANDLE_RECORDING_STATS.MCU_RECORDING_ERROR,n,null,s));},Ds=e=>{var t;Ut.log.INFO(["Server",null,e.type,"System action warning:"],e),Object.keys((new qi).getAllStates()).length>1&&e.action===Qe.REJECT&&Ni(),"toClose"===e.reason&&(e.reason="toclose"),po.removeSkylinkState(po.getSkylinkState(e.rid)),kt((t={action:e.action,info:e.info,reason:e.reason,rid:e.rid},new pe("systemAction",{detail:t})));},ys=e=>{const{action:t,rid:r}=e,n=Oi(r);Ut.log.DEBUG([It.MCU,"RTMP",null,Dt.RTMP.message_received_from_sig]),t===cs?((e,t)=>{const{rtmpSessions:r}=e,{rtmpId:n,peerId:s,streamId:i}=t;if(!r[n]){const t=Object.assign({},e);Ut.log.DEBUG([It.MCU,"RTMP",Dt.RTMP.started_success]),t.rtmpSessions[n]={active:!0,state:ut.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,peerId:s,streamId:i},kt(we({state:ut.START,rtmpId:n,error:null})),po.setSkylinkState(t,t.room.id);}})(n,e):t===ds?((e,t)=>{const{rtmpSessions:r}=e,{rtmpId:n}=t,s=Object.assign({},e);r[n]?(Ut.log.DEBUG([It.MCU,"RTMP",Dt.RTMP.stopped_success]),s.rtmpSessions[n].active=!1,s.rtmpSessions[n].state=ut.STOP,s.rtmpSessions[n].endedDateTime=(new Date).toISOString(),kt(we({state:ut.STOP,rtmpId:n,error:null})),po.setSkylinkState(s,s.room.id)):Ut.log.DEBUG([It.MCU,"RTMP",Dt.RTMP.stop_session_empty]);})(n,e):((e,t)=>{const{error:r,rtmpId:n}=t,{rtmpSessions:s}=e,i=new Error(r||"Unkown Error"),o=Object.assign({},e);s[n]?(Ut.log.DEBUG([It.MCU,"RTMP",Dt.RTMP.error_session]),o.rtmpSessions[n].state=ut.ERROR,o.rtmpSessions[n].error=i,s[n].active&&(Ut.log.DEBUG([It.MCU,"RTMP",Dt.RTMP.error_Session_abrupt]),o.rtmpSessions[n].active=!1),kt(we({state:ut.ERROR,rtmpId:n,error:i})),po.setSkylinkState(o,o.room.id)):Ut.log.DEBUG([It.MCU,"RTMP",Dt.RTMP.error_session_empty]);})(n,e);},Ps=e=>{const{type:t,mid:r,rid:n,userData:s,stamp:i}=e,o=po.getSkylinkState(n),{peerInformations:a,peerMessagesStamps:c}=o,d=r,{PEER_INFORMATIONS:l}=Dt;let u=s.replace(/&quot;/g,'"');try{u=JSON.parse(u);}catch(e){Ut.log.INFO([d,null,t,""+l.USER_DATA_NOT_JSON],u);}finally{Ut.log.INFO([d,null,t,""+l.UPDATE_USER_DATA],u);}if(a[d]){if(c[d]&&fi(i)){if(i<c[d].userData)return void Ut.log.WARN([d,null,t,""+l.OUTDATED_MSG],e);c[d].userData=i;}a[d].userData=u||{},kt(Ae({peerId:d,peerInfo:ei.getPeerInfo(d,o.room),isSelf:!1}));}else Ut.log.INFO([d,null,t,`${l.NO_PEER_INFO} ${d}`]);},Ms=e=>{const{mid:t,rid:r,mediaType:n,mediaId:s,publisherId:i}=e,o=po.getSkylinkState(r),{hasMCU:a,room:c}=o,d=a?i:t;try{if(!((e,t)=>{const r=e,{mediaId:n,publisherId:s}=t;return r.peerMedias[s]=r.peerMedias[s]||{},!r.peerMedias[s][n]&&(r.peerMedias[s][n]=t,po.setSkylinkState(r,r.room.id),!0)})(o,e)){const t=Object.values(Rt);for(let i=0;i<t.length;i+=1)if(Es(r,d,s,t[i],e[t[i]])){if(Bn.updatePeerMediaInfo(o.room,d,s,t[i],e[t[i]]),t[i]===Rt.MEDIA_STATE)return void Ss(c,n,d,e);if(t[i]===Rt.TRANSCEIVER_MID)return void ps(d,e);us(d,e,t[i]);}}}catch(e){Ut.log.ERROR([d,St.SIG_SERVER,Dt.MEDIA_INFO.FAILED_PROCESSING_MEDIA_INFO_EVENT],e);}},ks=e=>{Nr.processStoredMessages(e);},ws=e=>{const{rid:t,lock:r,mid:n}=e,s=po.getSkylinkState(t);s.room.isLocked=r,po.setSkylinkState(s,s.room.id),kt(Oe({isLocked:r,peerInfo:ei.getPeerInfo(n,s.room),peerId:n,isSelf:!1,room:Qs.getRoomInfo(t)}));};class bs{userMessageHandler(...e){hs(...e);}answerHandler(...e){ms(...e);}answerAckHandler(...e){gs(...e);}inRoomHandler(...e){Rs(...e);}enterRoomHandler(...e){fs(...e);}offerHandler(...e){Ts(...e);}welcomeHandler(...e){_s(...e);}candidateHandler(...e){Is(...e);}getPeerListHandler(...e){Cs(...e);}introduceErrorHandler(...e){Os(...e);}byeHandler(...e){vs(...e);}streamHandler(...e){As(...e);}recordingHandler(...e){Ns(...e);}redirectHandler(...e){Ds(...e);}rtmpHandler(...e){ys(...e);}setUserDataHandler(...e){Ps(...e);}mediaInfoEventHandler(...e){Ms(...e);}storedMessagesHandler(...e){ks(...e);}roomLockHandler(...e){ws(...e);}}const Ls={joinRoom:e=>{const{room:t,user:r}=e,n=po.getSkylinkState(t.id),s=po.getInitOptions(),i=new Yt(null,t.id);return {type:at.JOIN_ROOM,uid:n.user.uid,cid:i.key,rid:t.id,userCred:r.token,timeStamp:r.timeStamp,apiOwner:i.appKeyOwner,roomCred:t.token,start:t.startDateTime,len:t.duration,isPrivileged:i.isPrivileged,autoIntroduce:i.autoIntroduce,key:s.appKey}},enterRoom:e=>{const{room:t}=e,r=po.getSkylinkState(t.id),n=po.getInitOptions(),{user:s,peerPriorityWeight:i,enableIceRestart:o,hasMCU:a}=r,{enableDataChannel:c}=n,{AdapterJS:d,navigator:l}=window,u=ei.getUserInfo(t),p={type:at.ENTER,mid:s.sid,rid:t.id,agent:d.webrtcDetectedBrowser,version:(d.webrtcDetectedVersion||0).toString(),os:l.platform,userInfo:u,weight:i,temasysPluginVersion:null,enableDataChannel:c,enableIceRestart:o,SMProtocolVersion:"2.1.0",DTProtocolVersion:"0.1.3"};return a&&(p.target=It.MCU,p.publisherId=s.sid),p},welcome:(e,t)=>{const r=po.getSkylinkState(e.id),n=po.getInitOptions(),{user:s,peerPriorityWeight:i,enableIceRestart:o,room:a}=r,{enableDataChannel:c}=n,{AdapterJS:d}=window,l=ei.getUserInfo(a);return {type:at.WELCOME,mid:s.sid,rid:a.id,agent:d.webrtcDetectedBrowser,version:(d.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,weight:i,temasysPluginVersion:null,enableDataChannel:c,enableIceRestart:o,SMProtocolVersion:"2.1.0",DTProtocolVersion:"0.1.3",target:t}},offer:(...e)=>ji.createOffer(...e),answer:(...e)=>ji.createAnswer(...e),answerAck:(e,t,r)=>{const{room:n,user:s}=e;return {type:at.ANSWER_ACK,rid:n.id,mid:s.sid,target:t,success:r}},candidate:(e,t,r)=>{const n=t.room.id,s=po.getSkylinkState(n);return {type:at.CANDIDATE,label:r.sdpMLineIndex,id:r.sdpMid,candidate:r.candidate,mid:s.user.sid,target:e,rid:n}},setUserData:e=>({type:at.UPDATE_USER,mid:e.user.sid,rid:e.room.id,userData:Ii(e.user.userData)?e.user.userData:JSON.stringify(e.user.userData),stamp:(new Date).getTime()}),getPeerList:e=>({type:at.GET_PEERS,showAll:e}),restartOffer:(e,t,r)=>{const n=po.getSkylinkState(e),{AdapterJS:s}=window,i=po.getInitOptions(),{user:o,room:a,enableIceRestart:c,peerInformations:d,peerPriorityWeight:l}=n;return {type:at.RESTART,mid:o.sid,rid:a.id,agent:s.webrtcDetectedBrowser,version:(s.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:ei.getUserInfo(a),target:t,weight:l,enableDataChannel:i.enableDataChannel,enableIceRestart:c,doIceRestart:!0===r&&c&&d[t]&&d[t].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:null,SMProtocolVersion:"2.1.0",DTProtocolVersion:"0.1.3"}},stream:(e,t,r,n,s)=>({type:at.STREAM,mid:t.sid,rid:e,status:n,streamId:r.id,settings:s}),recording:(e,t)=>({type:t,rid:e,target:It.MCU}),rtmp:(e,t,r,n,s=null,i=null)=>{const o={type:e,rid:t,rtmpId:n,streamId:s,endpoint:i,mid:r,target:It.MCU};return e===at.STOP_RTMP&&(delete o.endpoint,delete o.streamId),o},bye:(e,t)=>{const{room:r,user:n,hasMCU:s}=e,i={type:at.BYE,rid:r.id,mid:n.sid,target:t};return s&&(i.publisherId=n.sid),i},roomLock:e=>{const{user:t,room:r}=e;return {type:at.ROOM_LOCK,mid:t.sid,rid:r.id,lock:r.isLocked}},mediaInfoEvent:(e,t,r)=>({type:at.MEDIA_INFO_EVENT,rid:e.room.id,mid:r.publisherId,target:t,publisherId:r.publisherId,mediaId:r.mediaId,mediaType:r.mediaType,mediaState:r.mediaState}),getStoredMessages:e=>{const{user:t,room:r}=e;return {mid:t.sid,rid:r.id,target:t.sid,type:at.GET_STORED_MESSAGES}},userMessages:(e,t,r)=>{const n=[],{user:s,room:i}=e,{listOfPeers:o,isPrivate:a,isPersistent:c,secretId:d}=t,l={data:r,mid:s.sid,rid:i.id,msgId:Di(),type:at.MESSAGE};if(d&&(l.secretId=d),a)for(let e=0;e<o.length;e+=1){const t=o[e],s=Object.assign({},l);s.target=t,n.push(s),Ut.log.DEBUG([t,St.MESSAGING,null,Dt.MESSAGING.PRIVATE_MESSAGE],{message:r});}else c&&(l.isPersistent=c),n.push(l),Ut.log.DEBUG([null,St.MESSAGING,null,Dt.MESSAGING.BROADCAST_MESSAGE],{message:r});return n}};class Gs{constructor(){this.messageBuilders=Ls;}getJoinRoomMessage(...e){return this.messageBuilders.joinRoom(...e)}getWelcomeMessage(...e){return this.messageBuilders.welcome(...e)}getEnterRoomMessage(...e){return this.messageBuilders.enterRoom(...e)}getAnswerMessage(...e){return this.messageBuilders.answer(...e)}getAnswerAckMessage(...e){return this.messageBuilders.answerAck(...e)}getOfferMessage(...e){return this.messageBuilders.offer(...e)}getCandidateMessage(...e){return this.messageBuilders.candidate(...e)}getSetUserDataMessage(e){return this.messageBuilders.setUserData(e)}getPeerListMessage(...e){return this.messageBuilders.getPeerList(...e)}getRestartOfferMessage(...e){return this.messageBuilders.restartOffer(...e)}getStreamMessage(...e){return this.messageBuilders.stream(...e)}getRecordingMessage(...e){return this.messageBuilders.recording(...e)}getPeerMessagesForSignaling(...e){return this.messageBuilders.signalingMessages(...e)}getRTMPMessage(...e){return this.messageBuilders.rtmp(...e)}getByeMessage(...e){return this.messageBuilders.bye(...e)}getRoomLockMessage(...e){return this.messageBuilders.roomLock(...e)}getMediaInfoEventMessage(...e){return this.messageBuilders.mediaInfoEvent(...e)}getGetStoredMessagesMessage(...e){return this.messageBuilders.getStoredMessages(...e)}getUserMessages(...e){return this.messageBuilders.userMessages(...e)}}const Us="Polling",Fs="WebSocket";let Bs=null;class xs{constructor(){return Bs||(Bs=this),this.socket=null,this.attempts=0,this.timestamp=(new Date).valueOf(),this.messageHandler=new bs,this.messageBuilder=new Gs,this.config=null,Bs}resetSocketConfig(e){return {protocol:e,socketType:window.WebSocket?Fs:Us,signalingServerProtocol:e,socketSession:{finalAttempts:0,attempts:0},fallbackType:null,signalingServerPort:null,socketTimeout:!1}}createSocket(e){const t=po.getSkylinkState(e);return t.socketSession=this.resetSocketConfig(t.signalingServerProtocol),po.setSkylinkState(t,e),new Promise((t,r)=>{try{null!==this.socket&&this.socket instanceof window.io.Socket&&this.socket.connected?t():this.tryCreateSocket(e,t,r);}catch(n){this.handleCreateSocketFailure(e,t,r,n);}})}tryCreateSocket(e,t,r){try{const r=po.getSkylinkState(e),{socketSession:n}=r;this.socket=sr({config:n,roomKey:e}),hr(e,this,t);}catch(e){r(e);}}handleCreateSocketFailure(e,t,r,n){const s=po.getSkylinkState(e),{socketSession:i}=s;var o;Ut.log.ERROR(Dt.INIT.SOCKET_CREATE_FAILED,n),kt((o={session:Ft(i),errorCode:Ze.CONNECTION_FAILED,type:i.fallbackType,error:n},new pe("socketError",{detail:o}))),r(n);}dispatchHandshakeProgress(e,t){kt(fe({peerId:e.user.sid,state:ze[t],error:null,room:Qs.getRoomInfo(e.room.id)}));}answer(...e){return this.messageBuilder.getAnswerMessage(...e).then(t=>{const r=e[0];return this.sendMessage(t),this.dispatchHandshakeProgress(r,"ANSWER"),t})}answerAck(...e){const t=this.messageBuilder.getAnswerAckMessage(...e),r=e[0];this.sendMessage(t),this.dispatchHandshakeProgress(r,"ANSWER_ACK");}enterRoom(...e){const t=this.messageBuilder.getEnterRoomMessage(...e);this.sendMessage(t),this.dispatchHandshakeProgress(...e,"ENTER");}joinRoom(...e){const t=this.messageBuilder.getJoinRoomMessage(...e);this.sendMessage(t);}offer(...e){const t=e[0],r=e[1],n=po.getSkylinkState(t.id);n.peerConnections[r].negotiating?Ut.log.DEBUG([r,St.SIG_SERVER,null,""+Dt.SIGNALING.ABORTING_OFFER]):this.messageBuilder.getOfferMessage(...e).then(e=>{this.sendMessage(e),this.dispatchHandshakeProgress(n,"OFFER");});}welcome(...e){const t=this.messageBuilder.getWelcomeMessage(...e);this.sendMessage(t);}noop(){return null}sendCandidate(...e){const t=this.messageBuilder.getCandidateMessage(...e);t&&this.sendMessage(t);}setUserData(e){const t=this.messageBuilder.getSetUserDataMessage(e);t&&this.sendMessage(t);}getPeerList(e){const t=this.messageBuilder.getPeerListMessage(e);t&&this.sendMessage(t);}stream(...e){const t=this.messageBuilder.getStreamMessage(...e);t&&this.sendMessage(t);}recording(...e){const t=this.messageBuilder.getRecordingMessage(...e);this.sendMessage(t);}rtmp(...e){const t=this.messageBuilder.getRTMPMessage(...e);this.sendMessage(t);}roomLock(e){const t=this.messageBuilder.getRoomLockMessage(e);t&&this.sendMessage(t);}bye(...e){const t=this.messageBuilder.getByeMessage(...e);this.sendMessage(t);}mediaInfoEvent(e,t,r){const n=this.messageBuilder.getMediaInfoEventMessage(e,t,r);n&&this.sendMessage(n);}getStoredMessages(e){const t=this.messageBuilder.getGetStoredMessagesMessage(e);t&&this.sendMessage(t);}onMessage(e){const t=po.getSkylinkState(JSON.parse(e).rid);if(!t)return;const{socketSession:r}=t;var n;kt((n={message:e,socketSession:Ft(r)},new pe("channelMessage",{detail:n}))),Sr(this.messageHandler,JSON.parse(e));}sendMessage(e){(e=>pr(e))(e)||(Ut.log.INFO(["SIG SERVER",null,e.type,"sent"]),((e,t)=>{e.send(JSON.stringify(t));})(this.socket,e));}sendUserMessage(e,t,r){const n=this.messageBuilder.getUserMessages(e,t,r);Array.isArray(n)&&n.length&&n.map(e=>(this.sendMessage(e),null));}updateAttempts(e,t,r){this.attempts=r;const n=po.getSkylinkState(e),{socketSession:s}=n;s.socketSession[t]=r,po.setSkylinkState(n,e);}getAttempts(){return this.attempts}}const Vs=e=>new Promise(t=>{const r=po.getSkylinkState(e.room.id),{room:n,peerConnections:s}=r,{ROOM:{LEAVE_ROOM:i}}=Dt,o=new xs,a=Object.keys(po.getSkylinkState()).length>1;if(n.inRoom=!1,po.setSkylinkState(r,n.id),a)Ut.log.INFO([n.roomName,null,null,i.SENDING_BYE]),Object.keys(s).forEach(e=>{o.bye(r,e);}),t(r);else{o.config=o.resetSocketConfig(window.location.protocol);const e=()=>{Ut.log.INFO([n.roomName,null,null,i.DISCONNECT_SOCKET.SUCCESS]),Mt(vt.CHANNEL_CLOSE,e),t(r);};Pt(vt.CHANNEL_CLOSE,e),o.socket.connected?o.socket.disconnect():t(r);}}),Hs=e=>{po.clearRoomStateFromSingletons(e),po.removeSkylinkState(e);},js=e=>{const t=po.getSkylinkState(e);t.bandwidthAdjuster&&!t.hasMCU&&new Ln({roomKey:e});},Ws=e=>new Promise((t,r)=>{const{peerConnections:n,peerInformations:s,room:i,hasMCU:o,user:a}=e,{ROOM:{LEAVE_ROOM:c}}=Dt;try{const r=o?n.MCU?[It.MCU]:[]:Array.from(new Set([...Object.keys(n),...Object.keys(s)]));if(hi(r))Ut.log.DEBUG([i.roomName,null,null,c.NO_PEERS]),Vs(e).then(e=>{Ut.log.INFO([i.roomName,null,null,c.REMOVE_STATE.SUCCESS]),kt(Ne({peerId:a.sid,peerInfo:ei.getCurrentSessionInfo(i),isSelf:!0,room:Qs.getRoomInfo(i.id)})),js(e.room.id),Hs(e.room.id),t(e.room.roomName);});else{const n=[];r.forEach(t=>{n.push(((e,t)=>new Promise(r=>{const{room:n,peerConnections:s}=e,{ROOM:{LEAVE_ROOM:i}}=Dt,{enableDataChannel:o}=po.getInitOptions();if(Ut.log.INFO([t,n.roomName,null,i.PEER_LEFT.START]),t===It.MCU&&kt(De({peerId:t,serverPeerType:Ke.MCU,room:Qs.getRoomInfo(n.id)})),s[t]&&s[t].signalingState!==je.CLOSED&&ji.closePeerConnection(e,t),o){const s=e=>{const{detail:t}=e;t.state!==Le.CLOSED&&t.state!==Le.CLOSING||(Ut.log.INFO([t.peerId,n.roomName,null,i.PEER_LEFT.SUCCESS]),Mt(vt.DATA_CHANNEL_STATE,s),r(t.peerId));};Pt(vt.DATA_CHANNEL_STATE,s),ji.closeDataChannel(e,t);}else r(t);}))(e,t));}),Promise.all(n).then(()=>Vs(e)).then(e=>{Ut.log.INFO([i.roomName,null,null,c.REMOVE_STATE.SUCCESS]),kt(Ne({peerId:a.sid,peerInfo:ei.getCurrentSessionInfo(i),isSelf:!0,room:Qs.getRoomInfo(i.id)})),js(e.room.id),Hs(e.room.id),t(e.room.roomName);});}}catch(e){Ut.log.ERROR([i.roomName,null,null,c.ERROR],e),r(e);}}),Ks=(e=[],t=[])=>new Promise((r,n)=>{const{ROOM:{LEAVE_ROOM:s}}=Dt;try{const n=po.getSkylinkState(),i=Object.values(n);i[0]?Ws(i[0]).then(n=>{e.push(n),t.push(r),Ks(e,t);}):(Ut.log.INFO([e,"Room",null,s.LEAVE_ALL_ROOMS.SUCCESS]),t.forEach(t=>t(e)));}catch(e){Ut.log.ERROR([null,"Room",null,s.LEAVE_ALL_ROOMS.ERROR],e),n(e);}});class $s extends Jt{constructor(){super();const{AdapterJS:e,navigator:t}=window;this.model={client_id:null,app_key:null,timestamp:null,username:null,sdk_name:Tt.WEB,sdk_version:null,agent_name:e.webrtcDetectedBrowser,agent_version:e.webrtcDetectedVersion,agent_platform:t.platform,agent_plugin_version:null,device_version:null,enumerated_devices:null,device_muted:null,network_type:t.connection?t.connection.type:"-",language:t.language};}send(e){const t=po.getSkylinkState(e);this.model.username=t.user&&t.user.uid||null,this.model.sdk_version=t.VERSION,this.model.client_id=t.clientId,this.model.app_key=po.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.client,this.model);}}class Ys{constructor(e){this.apiResponse={},this.dataChannels={},this.peerCandidatesQueue={},this.peerEndOfCandidatesCounter={},this.gatheredCandidates={},this.retryCounters={},this.peerConnections={},this.peerStats={},this.peerInformations={},this.user=e.user,this.peerPriorityWeight=0,this.isPrivileged=e.isPrivileged,this.socketSession={},this.socketMessageQueue=[],this.channelOpen=!1,this.socketServer=e.socketServer,this.signalingServerProtocol=e.forceSSL?"https:":window.location.protocol,this.enableIceRestart=!1,this.hasMCU=e.hasMCU,this.room=e.room,this.peerMessagesStamps={},this.streamsMutedSettings={},this.streamsBandwidthSettings={bAS:{}},this.recordings={},this.currentRecordingId=!1,this.recordingStartInterval=null,this.currentCodecSupport=null,this.voiceActivityDetection=!0,this.bandwidthAdjuster=null,this.rtmpSessions={},this.bufferedLocalOffer={},this.bufferedRemoteOffers={},this.currentRTCRTPSenders={},this.clientId=e.clientId,this.streamsMediaStatus={},this.peerMedias={},this.hasPersistentMessage=e.hasPersistentMessage,this.peerStreams={},this.streamsSettings={},this.enableStatsGathering=e.enableStatsGathering;}}const zs=(e,t)=>{const r=new nr,n=new Yt(e),s=r.enforceUserInitOptions(n),i=new Ys(s);return i.user.userData=t.userData,i.apiResponse=Object.freeze((e=>{const t=Ft(e);return delete t.room,delete t.user,t})(n)),po.setSkylinkState(i,e.roomName),i},Js=(e,t=!0)=>{const r=e,{room:n,user:s}=r,i=new xs;r.room.isLocked=t,po.setSkylinkState(r,n.id),i.roomLock(r),kt(Oe({isLocked:r.room.isLocked,peerInfo:ei.getCurrentSessionInfo(n),peerId:s.sid,isSelf:!0,room:Qs.getRoomInfo(n.id)}));};class Qs{static leaveRoom(...e){return Ws(...e)}static leaveAllRooms(){return Ks()}static lockRoom(e){return (e=>Js(e,!0))(e)}static unlockRoom(e){return (e=>Js(e,!1))(e)}static joinRoom(...e){return ((e={},t=null)=>new Promise((r,n)=>{const s=e||{},{navigator:i}=window,o=new nr,a=new xs,c=po.getInitOptions(),d=new $s,l=nr.getRoomNameFromParams(s)?nr.getRoomNameFromParams(s):c.defaultRoom;l?(kt(Te({readyState:Xe.LOADING,error:null,room:{roomName:l}})),o.createRoom(l).then(e=>{const{response:c}=e;c.roomName=l;const u=zs(c,s);o.checkCodecSupport(u.room.id).then(()=>(d.send(u.room.id),a.createSocket(c.room_key).then(()=>{const e=nr.getStateByKey(c.room_key),o=Object.assign({},s);if(o.room=e,t||s.id&&s.active||Array.isArray(s))zr.processPrefetchedStreams(c.room_key,t,s).then(()=>{a.joinRoom(e),r(null);}).catch(e=>{n(e);});else if(s.audio||s.video)zr.getUserMedia(u,o).then(t=>{a.joinRoom(e),r(t);}).catch(e=>{n(e);});else{const t=Si.parseMediaOptions(s,u);po.setSkylinkState(t,e.id),bi(_t.SAFARI)?i.mediaDevices.getUserMedia({audio:!0}).then(()=>a.joinRoom(e)):a.joinRoom(e),r(null);}}))).catch(e=>{n(e);});}).catch(e=>{n(e);})):n(Dt.ROOM_STATE.NO_ROOM_NAME);}))(...e)}static getRoomInfo(e){return (e=>{const t=po.getSkylinkState(e),{room:r}=t,n=Object.assign({},r);return delete n.connection,delete n.token,delete n.startDateTime,n})(e)}}const Xs=e=>!Ei(e),qs=(e,t)=>{const r=e.hasMCU?It.MCU:t;let n={};if(e.peerConnections[r].connectionState!==je.CLOSED){const r=ei.getPeerInfo(t,e.room);n=Ft(r.settings);}else Ut.log.WARN([t,St.PEER_CONNECTION,null,Dt.PEER_CONNECTION.NO_PEER_CONNECTION]);return n},Zs={getPeerInfo:(e,t)=>{let r=null;if(!e)return null;const n=po.getSkylinkState(t.id);return n?((e,t)=>{const{user:r}=t;return e===r.sid})(e,n)?ei.getCurrentSessionInfo(t):(r=Ft(n.peerInformations[e]),r?(r.room=t.roomName,r.settings.data=!!(n.dataChannels[e]&&n.dataChannels[e].main&&n.dataChannels[e].main.channel&&n.dataChannels[e].main.channel.readyState===Le.OPEN),r):(Ut.log.ERROR(`${Dt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`),r)):(Ut.log.ERROR(`${Dt.ROOM_STATE.NOT_FOUND} ${t.id}`),r)},getCurrentSessionInfo:e=>{const t=po.getSkylinkState(e.id),r=po.getInitOptions(),{AdapterJS:n,navigator:s}=window,{enableDataChannel:i}=r,{streamsMediaStatus:o,peerPriorityWeight:a,enableIceRestart:c,peerStreams:d,streamsBandwidthSettings:l,streamsSettings:u,user:p}=t,S={userData:"",settings:{audio:!1,video:!1},mediaStatus:{},agent:{name:n.webrtcDetectedBrowser,version:n.webrtcDetectedVersion,os:s.platform,pluginVersion:null,SMProtocolVersion:"2.1.0",DTProtocolVersion:"0.1.3",SDKVersion:ft},room:Qs.getRoomInfo(e.id),config:{enableDataChannel:i,enableIceRestart:c,priorityWeight:a},sid:p.sid};if(d[p.sid]){Object.keys(d[p.sid]).forEach(e=>{u[e].settings.audio?(S.settings.audio=S.settings.audio||{},S.settings.audio[e]=Ft(u[e].settings.audio)):u[e].settings.video&&(S.settings.video=S.settings.video||{},S.settings.video[e]=Ft(u[e].settings.video));});}return S.mediaStatus=o,S.userData=p.userData||null,S.settings.maxBandwidth=Ft(l.bAS),S.settings.data=i,Ft(S)},getUserInfo:Ir,getUserData:(e,t)=>{if(t&&e.peerInformations[t]){let r=e.peerInformations[t].userData;return r||(r=""),r}return e.user.userData},setUserData:(e,t)=>{const r=po.getSkylinkState(e.id),{PEER_INFORMATIONS:{UPDATE_USER_DATA:n}}=Dt,s=t||"";r.user.userData=s,po.setSkylinkState(r,r.room.id),(new xs).setUserData(r),kt(Ae({peerId:r.user.sid,peerInfo:Zs.getCurrentSessionInfo(e),isSelf:!0})),Ut.log.INFO(n,s);},getPeersDataChannels:e=>{const{dataChannels:t}=e,r={},n=Object.keys(t);for(let e=0;e<n.length;e+=1){const s=n[e];if(r[s]={},Xs(t)){const e=Object.keys(t[s]);for(let n=0;n<e.length;n+=1){const i=t[s][e[n]],{channelName:o,channelType:a,transferId:c,streamId:d}=i;let l=null;l=ji.getDataChannelBuffer(i),l.channelProp=e[n],l.channelName=o,l.channelType=a,l.currentTransferId=c,l.currentStreamId=d,l.readyState=i.channel?i.channel.readyState:Le.CREATE_ERROR,r[s][o]=l;}}}return r},getPeersCustomSettings:e=>{const{peerInformations:t}=e,r={};if((e=>!Ei(e))(t)){const n=Object.keys(t);for(let t=0;t<n.length;t+=1)n[t]!==It.MCU&&(r[n[t]]=qs(e,n[t]));return r}return r}};class ei{static getPeerInfo(e,t){return Zs.getPeerInfo(e,t)}static getCurrentSessionInfo(e){return Zs.getCurrentSessionInfo(e)}static getUserInfo(e){return Zs.getUserInfo(e)}static getUserData(e,t){return Zs.getUserData(e,t)}static setUserData(e,t){Zs.setUserData(e,t);}static getPeersStreams(e,t){return Zs.getPeersStreams(e,t)}static getPeersDataChannels(e){return Zs.getPeersDataChannels(e)}static getPeersCustomSettings(e){return Zs.getPeersCustomSettings(e)}}const ti=(e,t,r,n,s=!1)=>{const i=po.getSkylinkState(n);return (wi(r)&&e||ki(r)&&t)&&kt(((e={})=>new pe("localMediaMuted",{detail:e}))({streamId:r.id,isScreensharing:s,mediaStatus:i.streamsMediaStatus[r.id]})),!0},ri=(e,t,r,n)=>{const s=po.getSkylinkState(r.id),i=n,{streamsMutedSettings:o}=s;if(e){const e=Bn.retrieveMediaId(mt.VIDEO,i);Bn.updatePeerMediaInfo(r,s.user.sid,e,Rt.MEDIA_STATE,o[i].videoMuted?gt.MUTED:gt.ACTIVE);}if(t){const t=Bn.retrieveMediaId(mt.AUDIO,i);setTimeout(()=>Bn.updatePeerMediaInfo(r,s.user.sid,t,Rt.MEDIA_STATE,o[i].audioMuted?gt.MUTED:gt.ACTIVE),e?1050:0);}},ni=(e,t,r)=>{const{peerStreams:n,streamsMutedSettings:s,user:i}=e;let o=!1,a=!1;return n[i.sid]&&n[i.sid][r]&&(ki(n[i.sid][r])&&s[r].audioMuted!==t.audioMuted&&(o=!0),wi(n[i.sid][r])&&s[r].videoMuted!==t.videoMuted&&(a=!0)),{hasToggledAudio:o,hasToggledVideo:a}},si=(e,t,r)=>{const n=po.getSkylinkState(e),{room:s,peerConnections:i,peerInformations:o,peerStreams:a,user:c}=n,d=ni(n,r,t),{hasToggledAudio:l,hasToggledVideo:u}=d;let p=null;a[c.sid]&&a[c.sid][t]&&(p=a[c.sid][t]);const S=!!Bn.retrieveScreenMediaInfo(s,c.sid,{streamId:t});if(p)if(((e,t,r)=>{const n=e,{room:s}=n;t.hasToggledAudio&&(n.streamsMutedSettings[r].audioMuted=!n.streamsMutedSettings[r].audioMuted),t.hasToggledVideo&&(n.streamsMutedSettings[r].videoMuted=!n.streamsMutedSettings[r].videoMuted),Ut.log.DEBUG(Dt.MEDIA_STREAM.UPDATE_MUTED_SETTINGS,n.streamsMutedSettings,r),po.setSkylinkState(n,s.id);})(n,d,t),((e,t)=>{const r=t,{room:n}=r,s=(e=>e.getAudioTracks())(e),i=(e=>e.getVideoTracks())(e);r.streamsMediaStatus[e.id].audioMuted=pt.UNAVAILABLE,r.streamsMediaStatus[e.id].videoMuted=pt.UNAVAILABLE,s.forEach(t=>{t.enabled=!r.streamsMutedSettings[e.id].audioMuted,r.streamsMediaStatus[e.id].audioMuted=r.streamsMutedSettings[e.id].audioMuted?pt.MUTED:pt.ACTIVE;}),i.forEach(t=>{t.enabled=!r.streamsMutedSettings[e.id].videoMuted,r.streamsMediaStatus[e.id].videoMuted=r.streamsMutedSettings[e.id].videoMuted?pt.MUTED:pt.ACTIVE;}),po.setSkylinkState(r,n.id),Ut.log.DEBUG(Dt.MEDIA_STREAM.UPDATE_MEDIA_STATUS,r.streamsMediaStatus,e.id);})(p,n),ti(u,l,p,s.id,S),(e=>{const t=po.getSkylinkState(e.id).user.sid,r=ei.getCurrentSessionInfo(e);kt(Ae({isSelf:!0,peerId:t,peerInfo:r}));})(s),((e,t,r)=>{const n=po.getSkylinkState(e.id);Wr.dispatchStreamEvent("streamMuted",{isSelf:!0,peerId:n.user.sid,peerInfo:ei.getUserInfo(e),streamId:t.id,isScreensharing:r,isAudio:ki(t),isVideo:wi(t)});})(s,p,S),!i[It.MCU]&&hi(Object.keys(i))||i[It.MCU]&&hi(Object.keys(o))){const e=r=>{const{state:n}=r.detail;n===ze.ANSWER_ACK&&(ri(u,l,s,t),Mt(vt.HANDSHAKE_PROGRESS,e));};Pt(vt.HANDSHAKE_PROGRESS,e);}else setTimeout(()=>{ri(u,l,s,t);},500);},ii=e=>{switch(e){case 1:return !1;case 0:default:return !0}},oi=(e,t,r=null)=>{const{peerStreams:n,room:s,user:i}=e;if(!gi(t))return void Ut.log.ERROR(Dt.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);if(!n[i.sid])return void Ut.log.WARN(Dt.MEDIA_STREAM.ERRORS.NO_STREAM);if(r&&!n[i.sid][r])return void Ut.log.ERROR(Dt.MEDIA_STREAM.ERRORS.INVALID_STREAM_ID,r);const o={audioMuted:_i(t.audioMuted)?t.audioMuted:!fi(t.audioMuted)||ii(t.audioMuted),videoMuted:_i(t.videoMuted)?t.videoMuted:!fi(t.videoMuted)||ii(t.videoMuted)},a=r?[r]:n[i.sid]&&Object.keys(n[i.sid])||[];if(hi(a))return void Ut.log.ERROR(Dt.MEDIA_STREAM.ERRORS.NO_STREAMS_MUTED,t);Object.values(a).filter(t=>ni(e,o,t).hasToggledAudio||ni(e,o,t).hasToggledVideo).forEach(e=>{si(s.id,e,o);});},ai=(e,t)=>{for(let r=0;r<t.length;r+=1)if(e.id===t[r].id)return !0;return !1},ci=(e,t)=>{const r=e.getTransceivers?e.getTransceivers():[],n=t.getTracks();if(hi(r))return !1;for(let e=0;e<r.length;e+=1)if(r[e].sender.track&&ai(r[e].sender.track,n))return !0;return !1},di=(e,t,r,n)=>{const s=e,i=r.getTracks();for(let e=0;e<i.length;e+=1){const o=n.addTrack(i[e],r);o&&Pn(s,t,o);}po.setSkylinkState(s,s.room.id);},li=(e,t,r,n)=>{const{peerConnections:s,hasMCU:i}=e;try{if((e=>{const{user:t,room:r}=e,n=t.sid,s=ei.getCurrentSessionInfo(r);kt(Ae({isSelf:!0,peerId:n,peerInfo:s}));})(e),Object.keys(s).length>0||i){ji.refreshPeerConnection(Object.keys(s),e,!1,{}).then(()=>{r(t);}).catch(e=>{Ut.log.ERROR(Dt.PEER_CONNECTION.REFRESH_CONNECTION.FAILED),n(e);});}else Ut.log.WARN(Dt.ROOM.ERRORS.NO_PEERS),r(t);}catch(e){Ut.log.ERROR(e);}},ui=e=>{const t={audio:{input:[],output:[]},video:{input:[]}};return e.forEach(e=>{const r={deviceId:e.deviceId||e.sourceId||"default",label:e.label,groupId:e.groupId||null};r.label=r.label||"Source for "+r.deviceId,["audio","audioinput"].indexOf(e.kind)>-1?t.audio.input.push(r):["video","videoinput"].indexOf(e.kind)>-1?t.video.input.push(r):"audiooutput"===e.kind&&t.audio.output.push(r);}),t},pi=(e,t,r)=>{const n={streams:{video:null,audio:null,screenShare:null}};return Object.keys(r[t]).forEach(s=>{ki(r[t][s])?(n.streams.audio=n.streams.audio||{},n.streams.audio[s]=r[t][s]):wi(r[t][s])&&Bn.retrieveScreenMediaInfo(e.room,t,{streamId:s})?(n.streams.screenShare=n.streams.screenShare||{},n.streams.screenShare[s]=r[t][s]):(n.streams.video=n.streams.video||{},n.streams.video[s]=r[t][s]);}),n},Si={parseMediaOptions:(e,t)=>{const r=po.getSkylinkState(t.room.id),n=e||{};return r.voiceActivityDetection="boolean"!=typeof n.voiceActivityDetection||n.voiceActivityDetection,n.bandwidth&&("number"==typeof n.bandwidth.audio&&(r.streamsBandwidthSettings.bAS.audio=n.bandwidth.audio),"number"==typeof n.bandwidth.video&&(r.streamsBandwidthSettings.bAS.video=n.bandwidth.video),"number"==typeof n.bandwidth.data&&(r.streamsBandwidthSettings.bAS.data=n.bandwidth.data)),n.autoBandwidthAdjustment&&(r.bandwidthAdjuster={interval:10,limitAtPercentage:100,useUploadBwOnly:!1},"object"==typeof n.autoBandwidthAdjustment&&("number"==typeof n.autoBandwidthAdjustment.interval&&n.autoBandwidthAdjustment.interval>=10&&(r.bandwidthAdjuster.interval=n.autoBandwidthAdjustment.interval),"number"==typeof n.autoBandwidthAdjustment.limitAtPercentage&&n.autoBandwidthAdjustment.limitAtPercentage>=0&&n.autoBandwidthAdjustment.limitAtPercentage<=100&&(r.bandwidthAdjuster.limitAtPercentage=n.autoBandwidthAdjustment.limitAtPercentage),"boolean"==typeof n.autoBandwidthAdjustment.useUploadBwOnly&&(r.bandwidthAdjuster.useUploadBwOnly=n.autoBandwidthAdjustment.useUploadBwOnly))),r},parseStreamSettings:(e,t="")=>{const r=((e,t="")=>{const r={audio:!1,video:!1};return (e.audio&&!t||e.audio&&t===mt.AUDIO)&&(r.audio=Ft(Vt.MEDIA_OPTIONS.AUDIO),gi(e.audio)&&(_i(e.audio.stereo)&&(r.audio.stereo=e.audio.stereo),_i(e.audio.echoCancellation)&&(r.audio.echoCancellation=e.audio.echoCancellation),bi(_t.FIREFOX)||e.audio.deviceId&&Ii(e.audio.deviceId)&&(r.audio.deviceId=e.audio.deviceId),e.useExactConstraints&&_i(e.useExactConstraints)&&(r.audio.exactConstraints=e.useExactConstraints))),(e.video&&!t||e.video&&t===mt.VIDEO)&&(r.video=Ft(Vt.MEDIA_OPTIONS.VIDEO),gi(e.video)&&(e.video.deviceId&&Ii(e.video.deviceId)&&(r.video.deviceId=e.video.deviceId),e.video.resolution&&gi(e.video.resolution)&&((e.video.resolution.width&&Ii(e.video.resolution.width)||fi(e.video.resolution.width))&&(r.video.resolution.width=e.video.resolution.width),(e.video.resolution.height&&Ii(e.video.resolution.height)||fi(e.video.resolution.height))&&(r.video.resolution.height=e.video.resolution.height)),(e.video.frameRate&&Ii(e.video.frameRate)||fi(e.video.frameRate))&&(r.video.frameRate=e.video.frameRate),e.useExactConstraints&&_i(e.useExactConstraints)&&(r.video.exactConstraints=e.useExactConstraints))),r})(e,t);return {settings:r,mutedSettings:{shouldAudioMuted:!(!e.audio||!_i(e.audio.mute))&&e.audio.mute,shouldVideoMuted:!(!e.video||!_i(e.video.mute))&&e.video.mute},getUserMediaSettings:((e,t)=>{const r={audio:!1,video:!1};return (e.audio&&!t||e.audio&&t===mt.AUDIO)&&e.audio&&gi(e.audio)&&(r.audio={},r.audio.echoCancellation=!0,_i(e.audio.echoCancellation)&&(r.audio.echoCancellation=e.audio.echoCancellation),bi(_t.FIREFOX)||e.audio.deviceId&&Ii(e.audio.deviceId)&&(r.audio.deviceId=e.audio.exactConstraints?{exact:e.audio.deviceId}:{ideal:e.audio.deviceId})),(e.video&&!t||e.video&&t===mt.VIDEO)&&(e.video&&gi(e.video)?(r.video={},e.video.deviceId&&Ii(e.video.deviceId)&&(r.video.deviceId=e.video.exactConstraints?{exact:e.video.deviceId}:{ideal:e.video.deviceId}),r.video.width=gi(e.video.resolution.width)?e.video.resolution.width:e.video.exactConstraints?{exact:e.video.resolution.width}:{max:e.video.resolution.width},r.video.height=gi(e.video.resolution.height)?e.video.resolution.height:e.video.exactConstraints?{exact:e.video.resolution.height}:{max:e.video.resolution.height},(e.video.frameRate&&gi(e.video.frameRate)||fi(e.video.frameRate))&&(r.video.frameRate=gi(e.video.frameRate)?e.video.frameRate:e.video.exactConstraints?{exact:e.video.frameRate}:{max:e.video.frameRate})):e.video&&(r.video={width:e.video.exactConstraints?{exact:e.video.resolution.width}:{max:e.video.resolution.width},height:e.video.exactConstraints?{exact:e.video.resolution.height}:{max:e.video.resolution.height}})),r})(r,t)}},prepMediaAccessRequest:e=>new Promise((t,r)=>{const{roomKey:n,...s}=e,i=Si.parseStreamSettings(s,mt.AUDIO),o=Si.parseStreamSettings(s,mt.VIDEO),{AdapterJS:a}=window;i.getUserMediaSettings.audio||o.getUserMediaSettings.video||r(Dt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),a.webRTCReady(()=>{window.navigator.mediaDevices.getUserMedia({audio:i.getUserMediaSettings.audio,video:o.getUserMediaSettings.video}).then(e=>{const r=Si.onStreamAccessSuccess(n,e,i,o,!1),s=po.getSkylinkState(n);r[0]&&i.mutedSettings.shouldAudioMuted&&oi(s,{audioMuted:i.mutedSettings.shouldAudioMuted,videoMuted:o.mutedSettings.shouldVideoMuted},r[0].id),r[1]&&o.mutedSettings.shouldVideoMuted&&oi(s,{audioMuted:i.mutedSettings.shouldAudioMuted,videoMuted:o.mutedSettings.shouldVideoMuted},r[1].id),t(r);}).catch(e=>Si.onStreamAccessError(e,r,t,n,i,o));});}),addLocalMediaStreams:(e,t)=>{const r=po.getSkylinkState(t.room.id),{peerConnections:n,user:s,peerStreams:i}=r,o=n[e];i[s.sid]&&!Ei(i[s.sid])&&((e,t,r,n)=>{const s=Object.values(r);for(let r=0;r<s.length;r+=1)ci(n,s[r])||di(e,t,s[r],n);})(r,e,i[s.sid],o);},onRemoteTrackAdded:(e,t,r,n,s,i)=>{const{user:o,hasMCU:a,room:c}=t,d={dispatchOnIncomingStream:e=>{kt(Se(e));},dispatchOnIncomingScreenStream:e=>{kt(Ee(e));}},l=n?"dispatchOnIncomingScreenStream":"dispatchOnIncomingStream",u={stream:e,peerId:r,room:Qs.getRoomInfo(c.id),isSelf:a&&r===o.sid||!1,peerInfo:ei.getPeerInfo(r,c),streamId:e.id,isVideo:s,isAudio:i};d[l](u),kt(Ae({peerId:r,peerInfo:ei.getPeerInfo(r,c),isSelf:a&&r===o.sid||!1,room:c}));},onStreamAccessError:(e,t,r,n,s,i)=>{const o=po.getInitOptions(),a=po.getSkylinkState(n),{audioFallback:c}=o;if(s.settings.audio&&i.settings.video&&c){const o=!0;return Ut.log.DEBUG([a.user.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.START_FALLBACK]),kt(ke({error:e,state:st.FALLBACKING,isAudioFallback:o})),window.navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>{const t=Si.onStreamAccessSuccess(n,e,s,i,o);r(t);}).catch(r=>{Ut.log.ERROR([a.user.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.FALLBACK,r]),kt(be({error:r,isAudioFallbackError:!0})),kt(ke({error:e,state:st.ERROR,isAudioFallback:o})),t(r);})}Ut.log.ERROR([a.user.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.GET_USER_MEDIA],e),kt(be({error:e,isAudioFallbackError:!1})),t(e);},muteStreams:oi,sendStream:(e,t=null)=>new Promise((r,n)=>{if(!e)return n(new Error(Dt.ROOM_STATE.NO_ROOM_NAME));const{room:s}=e,i=!gi(t)||null===t;if(!s.inRoom)return Ut.log.WARN(Dt.ROOM.ERRORS.NOT_IN_ROOM),n(new Error(""+Dt.ROOM.ERRORS.NOT_IN_ROOM));if(i)return n(new Error(`${Dt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${t}`));let o=!1;try{if(Array.isArray(t)){let s=!0;if(t.forEach(e=>{Ti(e.getAudioTracks)&&Ti(e.getVideoTracks)||(s=!1);}),!s)return n(new Error(Dt.MEDIA_STREAM.ERRORS.INVALID_MEDIA_STREAM_ARRAY));let i=!0;return t.forEach(e=>{e.active||(i=!1);}),i?((e,t,r,n)=>{const s=[];return t.forEach(t=>{s.push(zr.usePrefetchedStream(e.room.id,t));}),Promise.all(s).then(t=>{li(e,t,r,n);}).catch(e=>{n(e);})})(e,t,r,n):n(new Error(Dt.MEDIA_STREAM.ERRORS.INACTIVE_MEDIA_STREAM))}return o=!!t&&(Ti(t.getAudioTracks)||Ti(t.getVideoTracks)),o?((e,t,r,n)=>zr.usePrefetchedStream(e.room.id,t).then(t=>{li(e,t,r,n);}).catch(e=>{n(e);}))(e,t,r,n):((e,t,r,n)=>zr.getUserMedia(e,t).then(t=>{li(e,t,r,n);}).catch(e=>{n(e);}))(e,t,r,n)}catch(e){Ut.log.ERROR(Dt.MEDIA_STREAM.ERRORS.SEND_STREAM,e);}}),getStreamSources:()=>{const{navigator:e}=window;return new Promise((t,r)=>{e.mediaDevices&&Ti(e.mediaDevices.enumerateDevices)?e.mediaDevices.enumerateDevices().then(e=>{t(ui(e));}):r(ui([]));})},getStreams:(e,t=!0)=>{const r=po.getSkylinkState(e.room.id),{peerStreams:n,user:s}=r,i={},o=Object.keys(n);for(let e=0;e<o.length;e+=1){const a=o[e];t&&a===s.sid?(i[a]=pi(r,a,n),i[a].isSelf=!0):a!==s.sid&&(i[a]=pi(r,a,n));}return i},updateStreamsMediaStatus:(e,t,r)=>{const n=po.getSkylinkState(e),{room:s,streamsMediaStatus:i}=n,{mutedSettings:{shouldAudioMuted:o,shouldVideoMuted:a},settings:{audio:c,video:d}}=t;i[r.id]={},i[r.id].audioMuted=c?o?pt.MUTED:pt.ACTIVE:pt.UNAVAILABLE,i[r.id].videoMuted=d?a?pt.MUTED:pt.ACTIVE:pt.UNAVAILABLE,po.setSkylinkState(n,s.id);},splitAudioAndVideoStream:e=>{const{MediaStream:t}=window,r=[],n=e.getAudioTracks(),s=e.getVideoTracks();return ki(e)?r.push(new t(n)):r.push(null),wi(e)?r.push(new t(s)):r.push(null),r},updateStreamsMutedSettings:(e,t,r)=>{const n=po.getSkylinkState(e),{room:s,streamsMutedSettings:i}=n,{audio:o,video:a}=t.settings;i[r.id]={},i[r.id].audioMuted=!o,i[r.id].videoMuted=!a,po.setSkylinkState(n,s.id);},onStreamAccessSuccess:(e,t,r,n,s,i=!1,o)=>{const a=i?[t]:Si.splitAudioAndVideoStream(t),c=po.getSkylinkState(e),{room:d,user:l}=c;return a.forEach(t=>{t&&(Wr.addStream(l.sid,t,e),zr.buildStreamSettings(d,t,ki(t)?r:n),Si.updateStreamsMutedSettings(d.id,ki(t)?r:n,t),Si.updateStreamsMediaStatus(d.id,ki(t)?r:n,t),Bn.processPeerMedia(d,l.sid,t,i),null!==l.sid&&(new jr).send(d.id),s&&Ut.log.DEBUG([l.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.FALLBACK_SUCCESS]),i?(Ut.log.DEBUG([l.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.START_SCREEN_SUCCESS]),Wr.dispatchStreamEvent("onIncomingScreenStream",{stream:t,peerId:l.sid,room:Qs.getRoomInfo(d.id),isSelf:!0,peerInfo:ei.getCurrentSessionInfo(d),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0})):l.sid&&Wr.dispatchStreamEvent("onIncomingStream",{stream:t,peerId:l.sid,room:Qs.getRoomInfo(d.id),isSelf:!0,peerInfo:ei.getCurrentSessionInfo(d),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0}),o||kt(((e={})=>new pe("mediaAccessSuccess",{detail:e}))({stream:t,isScreensharing:i,isAudioFallback:s,streamId:t.id,isAudio:ki(t),isVideo:wi(t)})));}),a},buildStreamSettings:(e,t,r)=>{const n=po.getSkylinkState(e.id);n.streamsSettings[t.id]={settings:r.settings,constraints:r.getUserMediaSettings},po.setSkylinkState(n,e.id);}},Ei=e=>0===Object.keys(e).length,hi=e=>0===e.length,mi=e=>""===e,gi=e=>"object"==typeof e&&null!==e,Ri=e=>"object"==typeof e&&null==e,fi=e=>"number"==typeof e,Ti=e=>"function"==typeof e,_i=e=>void 0!==e&&"boolean"==typeof e,Ii=e=>"string"==typeof e,Ci=(e,t,r)=>{let n=!0;return null!=e&&Ii(e)||(Ut.log.ERROR(`${r}: ${t} is null, undefined or not a string.`),n=!1),n},Oi=e=>{if(Ci(e,"roomId","getStateByRid")){const t=po.getSkylinkState(),r=Object.keys(t);let n=null;for(let s=0;s<r.length;s+=1){const i=r[s];if(i===e){n=t[i];break}}return n}return Ut.log.ERROR(`getRoomStateByRid: ${Dt.ROOM_STATE.NOT_FOUND} - ${e}`),null},Ai=e=>Oi(e),vi=e=>{let t=null;if(Ci(e,"roomName","getRoomStateByName")){const r=po.getSkylinkState(),n=Object.keys(r);for(let s=0;s<n.length;s+=1){const i=r[n[s]];if(i.room.roomName.toLowerCase()===e.toLowerCase()){t=i;break}}}return t||Ut.log.ERROR(`getRoomStateByName: ${Dt.ROOM_STATE.NOT_FOUND} - ${e}`),t},Ni=()=>{try{(new xs).socket.disconnect();}catch(e){Ut.log.ERROR(e);}},Di=()=>{let e=(new Date).getTime();return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?r:r&&15).toString(16)})},yi=e=>new Promise((t,r)=>{const{navigator:n}=window;e&&gi(e)||r(new Error(`${Dt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${e}`)),n.mediaDevices.getUserMedia(e).then(e=>{const r=Si.splitAudioAndVideoStream(e);t(r);}).catch(e=>{r(e);});}),Pi=e=>new Promise((t,r)=>{r(new Error(e));}),Mi=(e,t)=>{const r=po.getSkylinkState(e.id),{peerConnections:n}=r,s=Object.keys(n);let i=!1;return s.forEach(e=>{e===t&&(i=!0);}),i},ki=e=>e.getAudioTracks().length>0,wi=e=>e.getVideoTracks().length>0,bi=e=>{const{AdapterJS:t}=window;switch(e){case _t.CHROME:return t.webrtcDetectedBrowser===_t.CHROME;case _t.SAFARI:return t.webrtcDetectedBrowser===_t.SAFARI;case _t.FIREFOX:return t.webrtcDetectedBrowser===_t.FIREFOX;case _t.REACT_NATIVE:return t.webrtcDetectedBrowser===_t.REACT_NATIVE;default:return Ut.log.DEBUG(Dt.UTILS.INVALID_BROWSER_AGENT),!1}},Li=e=>new Date(e).toISOString(),Gi=()=>(new Date).toISOString(),Ui=(e,t,r,n,s)=>{const i="data"===n?"application":n;let o=-1,a=-1;for(let e=0;e<t.length;e+=1)if(0===t[e].indexOf("m="+i))o=e;else if(o>0){if(0===t[e].indexOf("m="))break;0===t[e].indexOf("c=")?a=e:0!==t[e].indexOf("b=AS:")&&0!==t[e].indexOf("b:TIAS:")||(t.splice(e,1),e-=1);}"number"==typeof s&&s>0?-1!==o&&-1!==a?(Ut.log.INFO([e,"RTCSessionDesription",r,`Limiting maximum sending ${n} bandwidth ->`],s),t.splice(a+1,0,"firefox"===window.webrtcDetectedBrowser?"b=TIAS:"+(1e3*s).toFixed(0):"b=AS:"+s)):Ut.log.WARN([e,"RTCSessionDesription",r,`Not limiting ${n} bandwidth as ${n} is not being sent`]):Ut.log.WARN([e,"RTCSessionDesription",r,`Not limiting ${n} bandwidth`]);},Fi={getSDPCommonSupports:(e,t=null,r)=>{const n=po.getSkylinkState(r),s={audio:!1,video:!1},{currentCodecSupport:i,peerInformations:o}=n,{beSilentOnParseLogs:a}=po.getInitOptions();if(!e||!t||!t.sdp){if(s.video=!(!i.video.h264&&!i.video.vp8),s.audio=!!i.audio.opus,e){const t=((o[e]||{}).agent||{}).name||"";bi(t)&&(s.video=Object.keys(i.video).length>0,s.audio=Object.keys(i.audio).length>0);}return s}const c=Fi.getSDPCodecsSupport(e,t,a),d=i;for(const e in d.audio)if(d.audio.hasOwnProperty(e)&&d.audio[e]&&c.audio[e]){s.audio=!0;break}for(const e in d.video)if(d.video.hasOwnProperty(e)&&d.video[e]&&c.video[e]){s.video=!0;break}return s},getSDPCodecsSupport:(e,t,r)=>{const n={audio:{},video:{}};if(!t||!t.sdp)return n;const s=t.sdp.split("\r\n");let i="";for(let e=0;e<s.length;e+=1)if(0!==s[e].indexOf("m=")){if(0===s[e].indexOf("a=rtpmap:")){const t=(s[e].split(" ")[1]||"").split("/"),r=(t[0]||"").toLowerCase(),o=t[1]+(t[2]?"/"+t[2]:"");if(["ulpfec","red","telephone-event","cn","rtx"].indexOf(r)>-1)continue;n[i][r]=n[i][r]||[],-1===n[i][r].indexOf(o)&&n[i][r].push(o);}}else i=(s[e].split("m=")[1]||"").split(" ")[0];return r||Ut.log.INFO([e||null,"RTCSessionDescription",t.type,"Parsed codecs support ->"],n),n},getCodecsSupport:e=>new Promise((t,r)=>{const n=po.getSkylinkState(e),{beSilentOnParseLogs:s}=po.getInitOptions(),i=n,{RTCPeerConnection:o}=window;n.currentCodecSupport&&t(n.currentCodecSupport),i.currentCodecSupport={audio:{},video:{}},bi(_t.SAFARI)&&(i.currentCodecSupport.audio={opus:["48000/2"]},i.currentCodecSupport.video={h264:["48000"]},t(i.currentCodecSupport));try{const e=new o(null);let n={};e.addTransceiver?(e.addTransceiver(mt.VIDEO),e.addTransceiver(mt.AUDIO)):n={mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}},e.createOffer(n).then(e=>{i.currentCodecSupport=Bi.getSDPCodecsSupport(null,e,s),t(i.currentCodecSupport);}).catch(e=>{r(e);});}catch(e){r(e);}}),setSDPBitrate:(e,t,r)=>{const n=po.getSkylinkState(r),s=t.sdp.split("\r\n"),i=t.type;let o,a,c;const d=ei.getPeersCustomSettings(n);return n.streamsBandwidthSettings.bAS?(o=n.streamsBandwidthSettings.bAS.audio,a=n.streamsBandwidthSettings.bAS.video,c=n.streamsBandwidthSettings.bAS.data):d[e]&&d[e].maxBandwidth&&"object"==typeof d[e].maxBandwidth&&("number"==typeof d[e].maxBandwidth.audio&&(o=d[e].maxBandwidth.audio),"number"==typeof d[e].maxBandwidth.video&&(a=d[e].maxBandwidth.video),"number"==typeof d[e].maxBandwidth.data&&(c=d[e].maxBandwidth.data)),Ui(e,s,i,"audio",o),Ui(e,s,i,"video",a),Ui(e,s,i,"data",c),s.join("\r\n")},getSDPICECandidates:(e,t,r)=>{const{RTCIceCandidate:n}=window,s={host:[],srflx:[],relay:[]};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t)return;const r=((e.match(/a=mid:.*\r\n/gi)||[])[0]||"").replace(/a=mid:/gi,"").replace(/\r\n/,""),i=t-1;(e.match(/a=candidate:.*\r\n/gi)||[]).forEach(e=>{const t=(e.split(" ")[7]||"host").replace(/\r\n/g,"");s[t]=s[t]||[],s[t].push(new n({sdpMid:r,sdpMLineIndex:i,candidate:(e.split("a=")[1]||"").replace(/\r\n/g,"")}));});}),r||Ut.log.INFO([e,"RTCSessionDesription",t.type,"Parsing session description ICE candidates ->"],s),s):s},getSDPSelectedCodec:(e,t,r,n)=>{const s={name:null,implementation:null,clockRate:null,channels:null,payloadType:null,params:null};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t||0!==e.indexOf(r+" "))return;const n=(e.split("\r\n")[0]||"").split(" ");n.splice(0,3);for(let t=0;t<n.length;t+=1){const r=e.match(new RegExp(`a=rtpmap:${n[t]}.*\r\n`,"gi"));if(!r)continue;const i=((r[0]||"").replace(/\r\n/g,"").split(" ")[1]||"").split("/");if(["red","ulpfec","telephone-event","cn","rtx"].indexOf(i[0].toLowerCase())>-1)continue;s.name=i[0],s.clockRate=parseInt(i[1],10)||0,s.channels=parseInt(i[2]||"1",10)||1,s.payloadType=parseInt(n[t],10),s.params="";(e.match(new RegExp(`a=fmtp:${n[t]}.*\r\n`,"gi"))||[]).forEach(e=>{s.params+=e.replace(new RegExp("a=fmtp:"+n[t],"gi"),"").replace(/ /g,"").replace(/\r\n/g,"");});break}}),n||Ut.log.INFO([e,"RTCSessionDesription",t.type,`Parsing session description "${r}" codecs ->`],s),s):s},getTransceiverMid:(e,t)=>{const r={audio:[],video:[]};return e.sdp.split("m=").forEach((e,t)=>{const n=e.split(/\n/),s=n[0].split(" ")[0];if("application"===s||0===t)return;let i={};for(let e=0;e<n.length;e+=1){if(n[e].match(/a=recvonly|a=sendonly|a=sendrecv|a=inactive/)){const t=n[e].split("=");i.direction=t[1].trim();}if(n[e].match(/a=mid:*/)&&(i.transceiverMid=n[e].split(/:/)[1].trim()),n[e].match(/a=msid:([\w|-|{]+)/)){const t=n[e].split(" "),r=t[0].split(/:/)[1].trim();i.streamId="-"===r?"":r,i.trackId=t[1].trim();}i.transceiverMid&&i.streamId&&i.trackId&&(r[s].push(i),i={});}}),t||Ut.log.INFO([null,"RTCSessionDesription",e.type,`Parsing session description "${e.type}" transceivers ->`],r),r}};class Bi{static getSDPCommonSupports(...e){return Fi.getSDPCommonSupports(...e)}static getCodecsSupport(...e){return Fi.getCodecsSupport(...e)}static setSDPBitrate(...e){return Fi.setSDPBitrate(...e)}static getSDPCodecsSupport(...e){return Fi.getSDPCodecsSupport(...e)}static getSDPICECandidates(...e){return Fi.getSDPICECandidates(...e)}static getSDPSelectedCodec(...e){return Fi.getSDPSelectedCodec(...e)}static getTransceiverMid(...e){return Fi.getTransceiverMid(...e)}}const xi=e=>"relay"===e?"relayed":"host"===e||e.indexOf("host")>-1?"local":"srflx"===e?"serverreflexive":"prflx"===e?"peerreflexive":e,Vi={parseSelectedCandidatePair:(e,t,r,n,s,i)=>{const{peerStats:o}=e,{raw:a,selectedCandidatePair:c}=t,d=Object.keys(t.raw);let l=null,u=null,p=null;if(bi(_t.CHROME))for(let e=0;e<d.length;e+=1)"transport"===a[d[e]].type&&(l=a[d[e]]);else bi(_t.FIREFOX)&&(l={});if(l)for(let e=0;e<d.length;e+=1){const t=a[d[e]];if("candidate-pair"===t.type&&t.id===l.selectedCandidatePairId||"candidate-pair"===t.type&&t.selected){const e=t;u=e.localCandidateId,p=e.remoteCandidateId,c.id=e.id,c.writable=e.writable,c.priority=e.priority,c.nominated=e.nominated;const r=o[i][t.id],n=parseInt(t.totalRoundTripTime||"0",10);c.totalRoundTripTime=n,c.roundTripTime=Vi.tabulateStats(r,t,"totalRoundTripTime");const s=parseInt(t.consentRequestsSent||"0",10);c.consentRequests.totalSent=s,c.consentRequests.sent=Vi.tabulateStats(r,t,"consentRequestsSent");const a=parseInt(t.requestsReceived||"0",10);c.requests.totalReceived=a,c.requests.received=Vi.tabulateStats(r,t,"requestsReceived");const d=parseInt(t.requestsSent||"0",10);c.requests.totalSent=d,c.requests.sent=Vi.tabulateStats(r,t,"requestsSent");const l=parseInt(t.responsesSent||"0",10);c.responses.totalSent=l,c.responses.sent=Vi.tabulateStats(r,t,"responsesSent");const S=parseInt(t.responsesReceived||"0",10);c.responses.totalReceived=S,c.responses.received=Vi.tabulateStats(r,t,"responsesReceived");}}if(u&&p){if("remote-candidate"===r){const e=n;e.id===p&&(c.remote.ipAddress=e.ip?e.ip:e.address,c.remote.portNumber=e.port,c.remote.transport=e.protocol,c.remote.priority=e.priority,c.remote.candidateType=xi(e.candidateType));}if("local-candidate"===r){const e=n;e.id===u&&(c.local.ipAddress=e.ip?e.ip:e.address,c.local.portNumber=e.port,c.local.transport=e.protocol,c.local.priority=e.priority,c.local.networkType=e.networkType,c.local.candidateType=xi(e.candidateType));}}},parseCertificates:(e,t)=>{const{certificate:r,raw:n}=e,s=Object.keys(e.raw);let i=null;for(let e=0;e<s.length;e+=1)"transport"===n[s[e]].type&&(i=n[s[e]]);if(i){r.srtpCipher=i.srtpCipher,r.dtlsCipher=i.dtlsCipher,r.tlsVersion=i.tlsVersion;const{localCertificateId:e,remoteCertificateId:n}=i;t.id===e?(r.local={},r.local.base64Certificate=t.base64Certificate,r.local.fingerprintAlgorithm=t.fingerprintAlgorithm):t.id===n&&(r.remote={},r.remote.base64Certificate=t.base64Certificate,r.remote.fingerprintAlgorithm=t.fingerprintAlgorithm);}},tabulateStats:(e=null,t,r)=>{const n=t.timestamp,s=e&&e.timestamp||new Date(t.timestamp).getTime()-2e4,i=parseFloat(t[r]||"0",10);let o=parseFloat(e&&e[r]||"0",10);return i<o&&(o=0),new Date(n).getTime()===new Date(s).getTime()?i:parseFloat(((i-o)/(n-s)*1e3).toFixed(3)||"0",10)},parseAudio:(e,t,r,n,s,i)=>{const{peerStats:o}=e,a=o[s][n.id];switch(i){case"receiving":((e,t,r)=>{const n=e.audio.receiving;if(n.bytes=n.bytes||0,t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);n.totalBytes=e,n.bytes+=Vi.tabulateStats(r,t,"bytesReceived");}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);n.totalPackets=e,n.packets=Vi.tabulateStats(r,t,"packetsReceived");}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);n.totalPacketsLost=e,n.packetsLost=Vi.tabulateStats(r,t,"packetsLost");}n.jitter=parseInt(t.jitter||"0",10),n.ssrc=t.ssrc;const{trackId:s}=t,i=e.raw[s];i&&(n.audioLevel=i.audioLevel?parseFloat(i.audioLevel).toFixed(5):"0",n.totalSamplesReceived=parseInt(i.totalSamplesReceived||"0",10),n.totalSamplesDuration=parseInt(i.totalSamplesDuration||"0",10));})(t,n,a);break;case"sending":((e,t,r)=>{const n=e.audio.sending;if(n.bytes=n.bytes||0,t.bytesSent){n.bytes=n.bytes?n.bytes:0;const e=parseInt(t.bytesSent||"0",10);n.totalBytes=e,n.bytes+=Vi.tabulateStats(r,t,"bytesSent");}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);n.totalPackets=e,n.packets=Vi.tabulateStats(r,t,"packetsSent");}if(t.retransmittedBytesSent||fi(t.retransmittedBytesSent)){const e=parseInt(t.retransmittedBytesSent||"0",10);n.totalRetransmittedBytesSent=e,n.retransmittedBytesSent=Vi.tabulateStats(r,t,"retransmittedBytesSent");}if(t.retransmittedPacketsSent||fi(t.retransmittedPacketsSent)){const e=parseInt(t.retransmittedPacketsSent||"0",10);n.totalRetransmittedPacketsSent=e,n.retransmittedPacketsSent=Vi.tabulateStats(r,t,"retransmittedPacketsSent");}n.ssrc=t.ssrc,t.jitter&&(n.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(n.roundTripTime=parseInt(t.roundTripTime||"0",10));const{trackId:s,mediaSourceId:i}=t,o=e.raw[s];o&&(n.echoReturnLoss=parseInt(o.echoReturnLoss||"0",10),n.echoReturnLossEnhancement=parseInt(o.echoReturnLossEnhancement||"0",10));const a=e.raw[i];a&&(n.audioLevel=a.audioLevel?parseFloat(a.audioLevel).toFixed(5):"0",n.totalSamplesDuration=parseInt(a.totalSamplesDuration||"0",10));})(t,n,a);break;default:Ut.log.DEBUG([s,St.STATS_MODULE,null,Dt.STATS_MODULE.ERRORS.PARSE_FAILED]);}},parseVideo:(e,t,r,n,s,i)=>{const{peerStats:o}=e,a=o[s][n.id];switch(i){case"receiving":((e,t,r)=>{const n=e.video.receiving;if(n.bytes=n.bytes||0,t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);n.totalBytes=e,n.bytes+=Vi.tabulateStats(r,t,"bytesReceived");}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);n.totalPackets=e,n.packets=Vi.tabulateStats(r,t,"packetsReceived");}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);n.totalPacketsLost=e,n.packetsLost=Vi.tabulateStats(r,t,"packetsLost");}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);n.totalFirs=e,n.firs=Vi.tabulateStats(r,t,"firCount");}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);n.totalNacks=e,n.nacks=Vi.tabulateStats(r,t,"nackCount");}if(t.pliCount||Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);n.totalPlis=e,n.plis=Vi.tabulateStats(r,t,"pliCount");}n.ssrc=t.ssrc,n.qpSum=parseInt(t.qpSum||"0",10),n.decoderImplementation=t.decoderImplementation;const{trackId:s}=t,i=e.raw[s];i&&(n.framesDropped=parseFloat(i.framesDropped||"0"),n.frames=parseInt(i.framesReceived||"0",10),n.framesDecoded=parseInt(i.framesDecoded||"0",10),n.frameWidth=parseInt(i.frameWidth||"0",10),n.frameHeight=parseInt(i.frameHeight||"0",10));})(t,n,a);break;case"sending":((e,t,r)=>{const n=e.video.sending;if(n.bytes=n.bytes||0,t.bytesSent){const e=parseInt(t.bytesSent||"0",10);n.totalBytes=e,n.bytes+=Vi.tabulateStats(r,t,"bytesSent");}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);n.totalPackets=e,n.packets=Vi.tabulateStats(r,t,"packetsSent");}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);n.totalFirs=e,n.firs=Vi.tabulateStats(r,t,"firCount");}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);n.totalNacks=e,n.nacks=Vi.tabulateStats(r,t,"nackCount");}if(Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);n.totalPlis=e,n.plis=Vi.tabulateStats(r,t,"pliCount");}t.jitter&&(n.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(n.roundTripTime=parseInt(t.roundTripTime||"0",10)),Number.isInteger(t.framesEncoded)&&(n.framesEncoded=parseInt(t.framesEncoded||"0",10)),n.ssrc=t.ssrc,n.qpSum=parseInt(t.qpSum||"0",10);const{trackId:s,mediaSourceId:i}=t,o=e.raw[s];o&&(n.frameWidth=parseInt(o.frameWidth||"0",10),n.frameHeight=parseInt(o.frameHeight||"0",10),n.frames=parseInt(o.framesSent||"0",10),n.hugeFramesSent=parseInt(o.hugeFramesSent||"0",10));const a=e.raw[i];a&&(n.framesPerSecond=parseInt(a.framesPerSecond||"0",10));})(t,n,a);break;default:Ut.log.DEBUG([s,St.STATS_MODULE,null,Dt.STATS_MODULE.ERRORS.PARSE_FAILED]);}},parseMedia:(e,t,r,n,s,i,o)=>{const a=n.kind||n.mediaType;a===mt.AUDIO?Vi.parseAudio(e,t,r,n,i,o):a===mt.VIDEO?Vi.parseVideo(e,t,r,n,i,o):Ut.log.DEBUG([i,St.STATS_MODULE,null,Dt.STATS_MODULE.INVALID_TRACK_KIND],n);}};class Hi{constructor(e,t){this.roomState=po.getSkylinkState(e),this.peerConnection=this.roomState.peerConnections[t]||null,this.dataChannel=this.roomState.dataChannels[t]||null,this.peerId=t,this.roomKey=e,this.output={peerId:t,raw:{},connection:{},audio:{sending:{},receiving:{}},video:{sending:{},receiving:{}},selectedCandidatePair:{id:null,local:{},remote:{},consentRequests:{},responses:{},requests:{}},certificate:{}},this.beSilentOnLogs=po.getInitOptions().beSilentOnStatsLogs,this.beSilentOnParseLogs=po.getInitOptions().beSilentOnParseLogs,this.bandwidth=null;}getConnectionStatus(){return this.getStatistics(!1,!1)}getStatsSuccess(e,t,r){if(!r&&bi(_t.REACT_NATIVE))return void e(this.output);const{peerStats:n,room:s}=this.roomState;"function"==typeof r.forEach?r.forEach((e,t)=>{this.output.raw[t]=e;}):this.output.raw=r;try{if(Ei(n))return void Ut.log.DEBUG([this.peerId,St.STATS_MODULE,null,Dt.STATS_MODULE.STATS_DISCARDED]);Object.entries(this.output.raw).forEach(e=>{const t=e[0],r=e[1],{type:i}=r;switch(i){case"remote-inbound-rtp":case"outbound-rtp":case"inbound-rtp":"inbound-rtp"===i?Vi.parseMedia(this.roomState,this.output,i,r,this.peerConnection,this.peerId,"receiving"):Vi.parseMedia(this.roomState,this.output,i,r,this.peerConnection,this.peerId,"sending");break;case"certificate":Vi.parseCertificates(this.output,r);break;case"local-candidate":case"remote-candidate":case"media-source":Vi.parseSelectedCandidatePair(this.roomState,this.output,i,r,this.peerConnection,this.peerId);}n[this.peerId][t]=this.output.raw[t],po.setSkylinkState(this.roomState,s.id);});}catch(e){this.getStatsFailure(t,Dt.STATS_MODULE.ERRORS.PARSE_FAILED,e);}this.beSilentOnLogs||kt(Me({state:We.RETRIEVE_SUCCESS,peerId:this.peerId,stats:this.output})),e(this.output);}getStatsFailure(e,t,r){const n=t||Dt.STATS_MODULE.RETRIEVE_STATS_FAILED;this.beSilentOnLogs||(Ut.log.ERROR([this.peerId,St.STATS_MODULE,null,n],r),kt(Me({state:We.RETRIEVE_ERROR,peerId:this.peerId,error:r}))),e(r);}getStatistics(e=!1,t=!1){const{STATS_MODULE:r}=Dt;return new Promise((n,s)=>{if(this.roomState.peerStats[this.peerId]||t){this.beSilentOnLogs=e,this.isAutoBwStats=t;try{this.gatherRTCPeerConnectionDetails(),this.gatherSDPIceCandidates(),this.gatherSDPCodecs(),this.gatherRTCDataChannelDetails();}catch(e){Ut.log.WARN([this.peerId,St.STATS_MODULE,null,Dt.STATS_MODULE.ERRORS.PARSE_FAILED],e);}"function"!=typeof this.peerConnection.getStats&&this.getStatsFailure(s,Dt.PEER_CONNECTION.STATS_API_UNAVAILABLE),this.beSilentOnLogs||kt(Me({state:We.RETRIEVING,peerId:this.peerId})),this.peerConnection.getStats().then(e=>{this.getStatsSuccess(n,s,e);}).catch(e=>{e.message!==Dt.STATS_MODULE.ERRORS.STATS_IS_NULL?this.getStatsFailure(s,null,e):Ut.log.WARN([this.peerId,St.STATS_MODULE,null,Dt.STATS_MODULE.ERRORS.RETRIEVE_STATS_FAILED],e.message);});}else Ut.log.WARN(r.NOT_INITIATED),n(null);})}gatherRTCPeerConnectionDetails(){const{peerConnection:e}=this;this.output.connection.iceConnectionState=e.iceConnectionState,this.output.connection.iceGatheringState=e.iceGatheringState,this.output.connection.signalingState=e.signalingState,this.output.connection.remoteDescription={type:e.remoteDescription&&e.remoteDescription.type||"",sdp:e.remoteDescription&&e.remoteDescription.sdp||""},this.output.connection.localDescription={type:e.localDescription&&e.localDescription.type||"",sdp:e.localDescription&&e.localDescription.sdp||""},this.output.connection.constraints=this.peerConnection.constraints?this.peerConnection.constraints:null,this.output.connection.sdpConstraints=this.peerConnection.sdpConstraints?this.peerConnection.sdpConstraints:null;}gatherSDPIceCandidates(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.connection.candidates={sending:Bi.getSDPICECandidates(this.peerId,e.localDescription,t),receiving:Bi.getSDPICECandidates(this.peerId,e.remoteDescription,t)};}gatherSDPCodecs(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.audio.sending.codec=Bi.getSDPSelectedCodec(this.peerId,e.remoteDescription,"audio",t),this.output.video.sending.codec=Bi.getSDPSelectedCodec(this.peerId,e.remoteDescription,"video",t),this.output.audio.receiving.codec=Bi.getSDPSelectedCodec(this.peerId,e.localDescription,"audio",t),this.output.video.receiving.codec=Bi.getSDPSelectedCodec(this.peerId,e.localDescription,"video",t);}gatherRTCDataChannelDetails(){const{dataChannel:e}=this;if(e){const t=Object.keys(e);this.output.connection.dataChannels={},t.forEach(t=>{const r=e[t];this.output.connection.dataChannels[r.channel.label]={label:r.channel.label,readyState:r.channel.readyState,channelType:Ge["main"===t?"MESSAGING":"DATA"],currentTransferId:r.transferId||null,currentStreamId:r.streamId||null};});}}}class ji{static addPeer(e){mn(e);}static createOffer(...e){return En(...e)}static createAnswer(...e){return hn(...e)}static createDataChannel(...e){return gn(...e)}static sendP2PMessage(...e){return Rn(...e)}static getPeersInRoom(...e){return fn(...e)}static retrieveStatistics(e,t,r,n){return new Hi(e,t).getStatistics(r,n)}static signalingEndOfCandidates(...e){return Tn(...e)}static getConnectionStatus(e,t){return Nn(e,t)}static getDataChannelBuffer(e){return _n(e)}static refreshDataChannel(e,t){return In(e,t)}static closeDataChannel(e,t){return Cn(e,t)}static refreshConnection(e,t,r,n,s){return On(e,t,r,n,s)}static refreshPeerConnection(e,t,r,n){return An(e,t,r,n)}static buildPeerInformations(...e){return vn(...e)}static closePeerConnection(e,t){return Dn(e,t)}static updatePeerInformationsMediaStatus(e,t,r,n){return yn(e,t,r,n)}}const Wi=(e,t,r)=>{Yr.prepStopStreams(e.id,t.id,!0).then(()=>Ut.log.DEBUG([r,St.MEDIA_STREAM,null,""+Dt.MEDIA_STREAM.STOP_SCREEN_SUCCESS])).catch(e=>Ut.log.DEBUG([r,St.MEDIA_STREAM,null,""+Dt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e));},Ki=(e,t)=>{t.getTracks().forEach(r=>{r.onended=()=>Wi(e.room,t,e.user.sid);});},$i=e=>{const{peerMedias:t,user:r}=e,n={},s=Object.keys(t).filter(e=>e!==r.sid);for(let e=0;e<s.length;e+=1){const r=s[e];Object.values(t[r]).forEach(e=>{e.mediaType===Et.VIDEO_SCREEN&&(n[r]=e.streamId);});}return n},Yi=Wi,zi=(e,t,r,n,s,i)=>{Si.onStreamAccessSuccess(e,t,r,n,s,i);},Ji={};class Qi{constructor(e){const{room:t}=e;if(Ji[t.id])return Ji[t.id];this.roomState=e,this.stream=null,this.signaling=new xs,this.streamId=null,this.settings=null,Ji[t.id]=this;}streamExists(){const e=Si.getStreams(this.roomState,this.roomState.room.name),t=Object.keys(e.userMedia);for(let e=0;e<t.length;e+=1)if(t[e]===this.streamId)return !0;return !1}async start(e=null,t){this.streamId=e,this.settings=this.isValidOptions(t)?Si.parseStreamSettings(t):Si.parseStreamSettings(Vt.MEDIA_OPTIONS.SCREENSHARE),t&&t.video&&t.video.resolution||(delete this.settings.getUserMediaSettings.video.width,delete this.settings.settings.video.width,delete this.settings.getUserMediaSettings.video.height,delete this.settings.settings.video.height);try{if(this.checkForExistingScreenStreams(),this.stream=await this.startScreenCapture(t),!this.stream)return this.deleteScreensharingInstance(this.roomState.room),null;zi(this.roomState.room.id,this.stream,null,this.settings,!1,!0),Ki(this.roomState,this.stream),this.addScreenshareStream();}catch(e){Ut.log.ERROR([this.roomState.user.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.START_SCREEN],e);}return this.stream}stop(){if(!this.stream)return Ut.log.DEBUG([this.roomState.user.sid,St.MEDIA_STREAM,null,`${Dt.MEDIA_STREAM.ERRORS.STOP_SCREEN} - ${Dt.MEDIA_STREAM.ERRORS.NO_STREAM}`]),null;try{Yi(this.roomState.room,this.stream,this.roomState.user.sid),this.streamId=null,this.stream=null;}catch(e){Ut.log.ERROR([this.roomState.user.sid,St.MEDIA_STREAM,null,""+Dt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e);}return null}startScreenCapture(){const{navigator:e}=window,t=this.settings.getUserMediaSettings;return e.mediaDevices.getDisplayMedia?e.mediaDevices.getDisplayMedia(t).then(e=>e).catch(e=>("NotAllowedError"===e.name?Ut.log.WARN(e):Ut.log.ERROR(e),null)):(t.video.mediaSource="screen",e.mediaDevices.getUserMedia(t).then(e=>e).catch(e=>(Ut.log.ERROR(e),null)))}isValidOptions(e){return !!(e&&gi(e)&&e.video)||(e&&Ut.log.WARN([this.roomState.user.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.INVALID_GDM_OPTIONS],e),!1)}checkForExistingScreenStreams(){const e=$i(this.roomState);Ei(e)||Ut.log.WARN([this.roomState.user.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.PEER_SCREEN_ACTIVE]);}addScreenshareStream(){const{peerConnections:e}=this.roomState;Ei(e)||ji.refreshConnection(this.roomState).catch(e=>Ut.log.ERROR([this.roomState.user.sid,St.MEDIA_STREAM,null,Dt.MEDIA_STREAM.ERRORS.START_SCREEN],e));}deleteScreensharingInstance(e){delete Ji[e.id];}}let Xi=null;class qi{constructor(){return Xi||(Xi=this),this.states={},Xi}setState(e){this.states[e.room.id]=e;}getAllStates(){return this.states}getState(e){return this.states[e]}removeStateByRoomId(e){return delete this.states[e]}clearRoomStateFromSingletons(e){const t=this.getState(e);new Qi(t).deleteScreensharingInstance(t.room),Nr.deleteAsyncInstance(t.room),Or.deleteEncryptedInstance(t.room),new Yt(null,e).deleteApiResponseInstance(e);}}const Zi=(e,t,r,n=null,s=null)=>{const i=new is;return Ut.log.ERROR(t),i.send(e.room.id,r,n,s,t),new Error(t)},eo=(e,t)=>new Promise((r,n)=>{const{hasMCU:s,currentRecordingId:i,recordingStartInterval:o}=e;let a=t?Dt.RECORDING.START_FAILED:Dt.RECORDING.STOP_FAILED;if(!s){a=`${a} - ${Dt.RECORDING.ERRORS.MCU_NOT_CONNECTED}`;const r=t?Dt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_START:Dt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_STOP;n(Zi(e,a,r,null,null));}if(t&&i){n(Zi(e,`${a} - ${Dt.RECORDING.ERRORS.EXISTING_RECORDING_IN_PROGRESS}`,Dt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_START_ACTIVE,i,null));}if(!t&&!i){n(Zi(e,`${a} - ${Dt.RECORDING.ERRORS.NO_RECORDING_IN_PROGRESS}`,Dt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_STOP_ACTIVE,i,null));}if(!t&&o){n(Zi(e,`${a} - ${Dt.RECORDING.ERRORS.MIN_RECORDING_TIME}`,Dt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_MIN_STOP,i,null));}((e,t)=>{const r=n=>{const s=n.detail,i=t?it.START:it.STOP;s.state===i&&(Mt(vt.RECORDING_STATE,r),e(s.recordingId));};Pt(vt.RECORDING_STATE,r);})(r,t),((e,t,r=null)=>{const n=new xs,s=new is;n.recording(e.room.id,t?at.START_RECORDING:at.STOP_RECORDING),s.send(e.room.id,t?Dt.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_START:Dt.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_STOP,r,null,null);})(e,t,i);});class to{static start(...e){return (e=>eo(e,!0))(...e)}static stop(...e){return (e=>eo(e,!1))(...e)}static getRecordings(e){const{recordings:t}=e;return Object.assign({},t)}}var ro=(e,t,r=null,n=null)=>{const s={shouldProceed:!0,errorMessage:""},{hasMCU:i}=t;return i?e&&!r?(s.errorMessage=Dt.RTMP.start_no_stream_id,s.shouldProceed=!1,s):e&&!n?(s.errorMessage=Dt.RTMP.start_no_endpoint,s.shouldProceed=!1,s):s:(s.errorMessage=e?Dt.RTMP.start_no_mcu:Dt.RTMP.stop_no_mcu,s.shouldProceed=!1,s)},no=(e,t)=>{const r=n=>{const s=n.detail,i=e?ut.START:ut.STOP;s.state===i&&(Mt(vt.RTMP_STATE,r),t(s.rtmpId));};Pt(vt.RTMP_STATE,r);},so=(e,t,r,n=null,s=null)=>{const{room:i,user:o}=e,a=new xs,c=t?at.START_RTMP:at.STOP_RTMP;a.rtmp(c,i.id,o.sid,r,n,s);};class oo{static startSession(e,t,r){return this.commonRTMPOperations(e,t,null,r,!0,Dt.RTMP.starting_rtmp)}static stopSession(e,t){return this.commonRTMPOperations(e,null,t,null,!1,Dt.RTMP.stopping_rtmp)}static logErrorAndReject(e,t){Ut.log.ERROR(e),t(e);}static commonRTMPOperations(e,t,r,n,s,i){return new Promise((o,a)=>{try{const c=ro(s,e,t,n),d=r||Di();c.shouldProceed?(no(s,o),so(e,s,d,t,n),Ut.log.INFO([It.MCU,"RTMP",i])):this.logErrorAndReject(new Error(c.errorMessage),a);}catch(e){this.logErrorAndReject(e,a);}})}}window.AdapterJS=le,window.io=io;const ao=new qi;let co={},lo={};const uo=vt;class po extends class{async joinRoom(e={},t){return Qs.joinRoom(e,t)}sendP2PMessage(e="",t="",r=""){ji.sendP2PMessage(e,t,r);}sendMessage(e="",t="",r=""){Dr.sendMessage(e,t,r);}getStoredMessages(e){const t=vi(e);t&&new Nr(t).getStoredMessages();}getPeersInRoom(e){return Ci(e,"roomName","getPeersInRoom")?ji.getPeersInRoom(e):null}getPeerInfo(e,t=null){const r=vi(e);return t&&r?ei.getPeerInfo(t,r.room):!t&&r?ei.getCurrentSessionInfo(r.room):null}getUserData(e,t){const r=vi(e);return r&&r.room?ei.getUserData(r,t):null}setUserData(e,t){const r=vi(e);return r&&r.room?ei.setUserData(r.room,t):null}getConnectionStatus(e,t){const r=vi(e);return ji.getConnectionStatus(r,t)}getPeers(e,t=!1){const r=vi(e);return r?class{static shouldProceed(e,t,r){let n=null;return e.isPrivileged||(n=Dt.PEER_PRIVILEGED.not_privileged),t||(n=Dt.PEER_PRIVILEGED.no_appkey),n&&(Ut.log.DEBUG(n),r(new Error(n))),!n}static getPeerList(e,t){return new Promise((r,n)=>{try{const s=po.getSkylinkState(e.id),i=po.getInitOptions(),o=t||!1,a=e=>{const t=e.detail;t.state===Je.DISPATCHED&&(Mt(vt.GET_PEERS_STATE_CHANGE,a),kt(ye({state:Je.RECEIVED,privilegePeerId:s.user.sid,peerList:t.peerList})),r(t.peerList));};this.shouldProceed(s,i.appKey,n)&&((new xs).getPeerList(o),kt(ye({state:Je.ENQUIRED,privilegePeerId:s.user.sid,peerList:null})),Ut.log.INFO(Dt.PEER_PRIVILEGED.getPeerListFromServer),Pt(vt.GET_PEERS_STATE_CHANGE,a));}catch(e){Ut.log.ERROR(e),n(e);}})}}.getPeerList(r.room,t):null}getPeersDataChannels(e){const t=vi(e);return t?ei.getPeersDataChannels(t):null}getPeersCustomSettings(e){const t=vi(e);return t?ei.getPeersCustomSettings(t):null}refreshDatachannel(e,t){const r=vi(e);return r?ji.refreshDataChannel(r,t):null}refreshConnection(e,t,r,n){const s=vi(e);return ji.refreshConnection(s,t,r,n)}shareScreen(e,t){const r=vi(e);if(r){return new Qi(r).start(null,t)}return null}getUserMedia(e=null,t){if(!e)return yi(t);if(Ii(e)){const r=vi(e);if(r)return zr.processUserMediaOptions(r,t)}else if(gi(e))return yi(e)}stopPrefetchedStream(e){return e&&(e.getTracks().forEach(e=>{e.stop();}),kt(he({room:null,peerId:null,peerInfo:null,isSelf:!0,isScreensharing:!1,streamId:e.id}))),null}stopScreen(e){const t=vi(e);if(t){new Qi(t).stop();}return null}stopStreams(e,t){const r=vi(e);return r?zr.stopStreams(r,t):null}leaveRoom(e){const t=vi(e);return t?Qs.leaveRoom(t):null}leaveAllRooms(){return Qs.leaveAllRooms()}startRecording(e){const t=vi(e);return t?to.start(t):null}stopRecording(e){const t=vi(e);return t?to.stop(t):null}lockRoom(e){const t=vi(e);return t?Qs.lockRoom(t):null}unlockRoom(e){const t=vi(e);return t?Qs.unlockRoom(t):null}getRecordings(e){const t=vi(e);return t?to.getRecordings(t):null}muteStreams(e,t={audioMuted:!0,videoMuted:!0},r){const n=vi(e);return n?zr.muteStreams(n,t,r):null}startRTMPSession(e,t,r){const n=vi(e);return n?oo.startSession(n,t,r):null}stopRTMPSession(e,t){const r=vi(e);return r?oo.stopSession(r,t):null}getStreamSources(){return zr.getStreamSources()}sendStream(e,t){const r=vi(e);return zr.sendStream(r,t)}getStreams(e,t=!0){const r=vi(e);return r?zr.getStreams(r,t):null}generateUUID(){return Di()}setEncryptSecret(e="",t="",r=""){const n=vi(e);return new Or(n).setEncryptSecret(t,r)}getEncryptSecrets(e=""){const t=vi(e);return new Or(t).getEncryptSecrets()}deleteEncryptSecrets(e="",t=""){const r=vi(e);return new Or(r).deleteEncryptSecrets(t)}setSelectedSecret(e="",t=""){const r=vi(e);new Or(r).setSelectedSecretId(t);}getSelectedSecret(e,t){const r=vi(e);return new Or(r).getSelectedSecretId(t)}setMessagePersistence(e,t){const r=vi(e);return new Nr(r).setMessagePersistence(t)}getMessagePersistence(e){const t=vi(e);return new Nr(t).getMessagePersistence()}getSdkVersion(){return ft}}{constructor(e){super();const t=(new nr).init(e);po.setInitOptions(t);}static getSkylinkState(e=null){return e?ao.getState(e):ao.getAllStates()}static setSkylinkState(e,t){t&&ao.setState(e);}static removeSkylinkState(e){if(e)return ao.removeStateByRoomId(e)}static clearRoomStateFromSingletons(e){if(e)return ao.clearRoomStateFromSingletons(e)}static getInitOptions(){return co}static setInitOptions(e){co=e;}static setUserInitOptions(e){lo=e;}static getUserInitOptions(){return lo}}e.default=po,e.SkylinkLogger=Ut,e.SkylinkEventManager=yt,e.SkylinkEvents=uo,e.SkylinkConstants=Nt,Object.defineProperty(e,"__esModule",{value:!0});}));

}));
