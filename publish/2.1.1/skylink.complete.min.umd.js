(function (factory) {
	typeof define === 'function' && define.amd ? define(factory) :
	factory();
}(function () { 'use strict';

	!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Skylink={});}(undefined,(function(e){var t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}function r(e,t){return e(t={exports:{}},t.exports),t.exports}var i=r((function(e,r){var i=i||window.AdapterJS||{};if(i.options=i.options||{},i.options.getAllCams=!!i.options.getAllCams,i.options.hidePluginInstallPrompt=!!i.options.hidePluginInstallPrompt,i.options.forceSafariPlugin=!!i.options.forceSafariPlugin,i.VERSION="0.15.4",i.onwebrtcready=i.onwebrtcready||function(e){},i._onwebrtcreadies=[],i.webRTCReady=function(e){if("function"!=typeof e)throw new Error("Callback provided is not a function");var t=function(){"function"==typeof window.require&&"function"==typeof i._defineMediaSourcePolyfill&&i._defineMediaSourcePolyfill(),e(null!==i.WebRTCPlugin.plugin);};!0===i.onwebrtcreadyDone?t():i._onwebrtcreadies.push(t);},i.WebRTCPlugin=i.WebRTCPlugin||{},i.WebRTCPlugin.pluginInfo=i.WebRTCPlugin.pluginInfo||{prefix:"Tem",plugName:"TemWebRTCPlugin",pluginId:"plugin0",type:"application/x-temwebrtcplugin",onload:"__TemWebRTCReady0",portalLink:"https://skylink.io/plugin/",downloadLink:null,companyName:"Temasys",downloadLinks:{mac:"https://bit.ly/webrtcpluginpkg",win:"https://bit.ly/webrtcpluginmsi"}},void 0!==i.WebRTCPlugin.pluginInfo.downloadLinks&&null!==i.WebRTCPlugin.pluginInfo.downloadLinks&&(navigator.platform.match(/^Mac/i)?i.WebRTCPlugin.pluginInfo.downloadLink=i.WebRTCPlugin.pluginInfo.downloadLinks.mac:navigator.platform.match(/^Win/i)&&(i.WebRTCPlugin.pluginInfo.downloadLink=i.WebRTCPlugin.pluginInfo.downloadLinks.win)),i.WebRTCPlugin.TAGS={NONE:"none",AUDIO:"audio",VIDEO:"video"},i.WebRTCPlugin.pageId=Math.random().toString(36).slice(2),i.WebRTCPlugin.plugin=null,i.WebRTCPlugin.setLogLevel=null,i.WebRTCPlugin.defineWebRTCInterface=null,i.WebRTCPlugin.isPluginInstalled=null,i.WebRTCPlugin.pluginInjectionInterval=null,i.WebRTCPlugin.injectPlugin=null,i.WebRTCPlugin.PLUGIN_STATES={NONE:0,INITIALIZING:1,INJECTING:2,INJECTED:3,READY:4},i.WebRTCPlugin.pluginState=i.WebRTCPlugin.PLUGIN_STATES.NONE,i.onwebrtcreadyDone=!1,i.WebRTCPlugin.PLUGIN_LOG_LEVELS={NONE:"NONE",ERROR:"ERROR",WARNING:"WARNING",INFO:"INFO",VERBOSE:"VERBOSE",SENSITIVE:"SENSITIVE"},i.WebRTCPlugin.WaitForPluginReady=null,i.WebRTCPlugin.callWhenPluginReady=null,i.documentReady=function(){return "interactive"===document.readyState&&!!document.body||"complete"===document.readyState},window.__TemWebRTCReady0=function(){i.documentReady()?(i.WebRTCPlugin.pluginState=i.WebRTCPlugin.PLUGIN_STATES.READY,i.maybeThroughWebRTCReady()):setTimeout(__TemWebRTCReady0,100);},i.maybeThroughWebRTCReady=function(){i.onwebrtcreadyDone||(i.onwebrtcreadyDone=!0,i._onwebrtcreadies.length?i._onwebrtcreadies.forEach((function(e){"function"==typeof e&&e(null!==i.WebRTCPlugin.plugin);})):"function"==typeof i.onwebrtcready&&i.onwebrtcready(null!==i.WebRTCPlugin.plugin));},i.TEXT={PLUGIN:{REQUIRE_INSTALLATION:"This website requires you to install a WebRTC-enabling plugin to work on this browser.",REQUIRE_RESTART:"Your plugin is being downloaded. Please run the installer, and restart your browser to begin using it.",NOT_SUPPORTED:"Your browser does not support WebRTC.",BUTTON:"Install Now"},REFRESH:{REQUIRE_REFRESH:"Please refresh page",BUTTON:"Refresh Page"}},i._iceConnectionStates={starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"},i._iceConnectionFiredStates=[],i.isDefined=null,window.webrtcDetectedType=null,window.MediaStream="function"==typeof MediaStream?MediaStream:null,window.RTCPeerConnection="function"==typeof RTCPeerConnection?RTCPeerConnection:null,window.RTCSessionDescription="function"==typeof RTCSessionDescription?RTCSessionDescription:null,window.RTCIceCandidate="function"==typeof RTCIceCandidate?RTCIceCandidate:null,window.getUserMedia="function"==typeof getUserMedia?getUserMedia:null,window.attachMediaStream=null,window.reattachMediaStream=null,window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,window.webrtcMinimumVersion=null,window.webrtcDetectedDCSupport=null,i.parseWebrtcDetectedBrowser=function(){var e=null;if(window.opr&&opr.addons||window.opera||navigator.userAgent.indexOf(" OPR/")>=0)e=navigator.userAgent.match(/OPR\/(\d+)/i)||[],window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=26,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport="SCTP";else if(navigator.userAgent.match(/Bowser\/[0-9.]*/g)){e=navigator.userAgent.match(/Bowser\/[0-9.]*/g)||[];var t=parseInt((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[])[2]||"0",10);window.webrtcDetectedBrowser="bowser",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=0,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=t>30?"SCTP":"RTP";}else if(navigator.userAgent.indexOf("OPiOS")>0)e=navigator.userAgent.match(/OPiOS\/([0-9]+)\./),window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("CriOS")>0)e=navigator.userAgent.match(/CriOS\/([0-9]+)\./)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedBrowser="chrome",window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("FxiOS")>0)e=navigator.userAgent.match(/FxiOS\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(document.documentMode)e=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedBrowser="IE",window.webrtcDetectedVersion=parseInt(e[1],10),window.webrtcMinimumVersion=9,window.webrtcDetectedType="plugin",window.webrtcDetectedDCSupport="SCTP",webrtcDetectedVersion||(e=/\bMSIE[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10));else if(window.StyleMedia||navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e=navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||[],window.webrtcDetectedBrowser="edge",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=13.10547,window.webrtcDetectedType="ms",window.webrtcDetectedDCSupport=null;else if("undefined"!=typeof InstallTrigger||navigator.userAgent.indexOf("irefox")>0)e=navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=33,window.webrtcDetectedType="moz",window.webrtcDetectedDCSupport="SCTP";else if(window.chrome&&window.chrome.webstore||navigator.userAgent.indexOf("Chrom")>0)e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[],window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(e[2]||"0",10),window.webrtcMinimumVersion=38,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=window.webrtcDetectedVersion>30?"SCTP":"RTP";else if(/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()||navigator.userAgent.match(/AppleWebKit\/(\d+)\./)||navigator.userAgent.match(/Version\/(\d+).(\d+)/)){e=navigator.userAgent.match(/version\/(\d+)\.(\d+)/i)||[];var n=navigator.userAgent.match(/AppleWebKit\/(\d+)/i)||[],r=navigator.userAgent.match(/(iPhone|iPad)/gi),s=n.length>=1&&n[1]>=604;if(window.webrtcDetectedBrowser="safari",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=7,r)window.webrtcDetectedType=s?"AppleWebKit":null;else{var o=window.webrtcDetectedVersion,a=parseInt(e[2]||"0",10),c=11==o&&a<2;window.webrtcDetectedType=!s||i.options.forceSafariPlugin&&c?"plugin":"AppleWebKit";}window.webrtcDetectedDCSupport="SCTP";}i.webrtcDetectedBrowser=window.webrtcDetectedBrowser,i.webrtcDetectedVersion=window.webrtcDetectedVersion,i.webrtcMinimumVersion=window.webrtcMinimumVersion,i.webrtcDetectedType=window.webrtcDetectedType,i.webrtcDetectedDCSupport=window.webrtcDetectedDCSupport;},i.addEvent=function(e,t,n){e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent?e.attachEvent("on"+t,n):e[t]=n;},i.renderNotificationBar=function(e,t,n){if(i.documentReady()){var r=window,s=document.createElement("iframe");s.name="adapterjs-alert",s.style.position="fixed",s.style.top="-41px",s.style.left=0,s.style.right=0,s.style.width="100%",s.style.height="40px",s.style.backgroundColor="#ffffe1",s.style.border="none",s.style.borderBottom="1px solid #888888",s.style.zIndex="9999999","string"==typeof s.style.webkitTransition?s.style.webkitTransition="all .5s ease-out":"string"==typeof s.style.transition&&(s.style.transition="all .5s ease-out"),document.body.appendChild(s);var o=s.contentWindow?s.contentWindow:s.contentDocument.document?s.contentDocument.document:s.contentDocument;o.document.open(),o.document.write('<span style="display: inline-block; font-family: Helvetica, Arial,sans-serif; font-size: .9rem; padding: 4px; vertical-align: middle; cursor: default;">'+e+"</span>"),t&&"function"==typeof n?(o.document.write('<button id="okay">'+t+'</button><button id="cancel">Cancel</button>'),o.document.close(),i.addEvent(o.document.getElementById("okay"),"click",(function(e){e.preventDefault();try{e.cancelBubble=!0;}catch(e){}n(e);})),i.addEvent(o.document.getElementById("cancel"),"click",(function(e){r.document.body.removeChild(s);}))):o.document.close(),setTimeout((function(){"string"==typeof s.style.webkitTransform?s.style.webkitTransform="translateY(40px)":"string"==typeof s.style.transform?s.style.transform="translateY(40px)":s.style.top="0px";}),300);}},window.requestUserMedia="function"==typeof requestUserMedia?requestUserMedia:null,i.parseWebrtcDetectedBrowser(),["webkit","moz","ms","AppleWebKit"].indexOf(i.webrtcDetectedType)>-1){navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)&&window.RTCPeerConnection&&(window.msRTCPeerConnection=window.RTCPeerConnection),e.exports=function e(t,r,i){function s(a,c){if(!r[a]){if(!t[a]){if(!c&&n)return n();if(o)return o(a,!0);var d=new Error("Cannot find module '"+a+"'");throw d.code="MODULE_NOT_FOUND",d}var l=r[a]={exports:{}};t[a][0].call(l.exports,(function(e){return s(t[a][1][e]||e)}),l,l.exports,e,t,r,i);}return r[a].exports}for(var o=n,a=0;a<i.length;a++)s(i[a]);return s}({1:[function(e,t,n){function r(e,t,n,r,i){var s=c.writeRtpDescription(e.kind,t);if(s+=c.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=c.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":i||"active"),s+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var a="msid:"+(r?r.id:"-")+" "+o+"\r\n";s+="a="+a,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n");}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+c.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+c.localCName+"\r\n"),s}function i(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var n=0;n<t.length;n++)if(t[n].payloadType===e||t[n].preferredPayloadType===e)return t[n]},i=function(e,t,n,i){var s=r(e.parameters.apt,n),o=r(t.parameters.apt,i);return s&&o&&s.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach((function(r){for(var s=0;s<t.codecs.length;s++){var o=t.codecs[s];if(r.name.toLowerCase()===o.name.toLowerCase()&&r.clockRate===o.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&o.parameters.apt&&!i(r,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(r.numChannels,o.numChannels),n.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter((function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return !0;return !1}));break}}})),e.headerExtensions.forEach((function(e){for(var r=0;r<t.headerExtensions.length;r++){var i=t.headerExtensions[r];if(e.uri===i.uri){n.headerExtensions.push(i);break}}})),n}function s(e,t,n){return -1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(n)}function o(e,t){var n=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return n||e.addRemoteCandidate(t),!n}function a(e,t){var n=new Error(t);return n.name=e,n.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],n}var c=e("sdp");t.exports=function(e,t){function n(t,n){n.addTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}));}function d(t,n,r,i){var s=new Event("track");s.track=n,s.receiver=r,s.transceiver={receiver:r},s.streams=i,e.setTimeout((function(){t._dispatchEvent("track",s);}));}var l=function(n){var r=this,i=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){r[e]=i[e].bind(i);})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",n=JSON.parse(JSON.stringify(n||{})),this.usingBundle="max-bundle"===n.bundlePolicy,"negotiate"===n.rtcpMuxPolicy)throw a("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(n.rtcpMuxPolicy||(n.rtcpMuxPolicy="require"),n.iceTransportPolicy){case"all":case"relay":break;default:n.iceTransportPolicy="all";}switch(n.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:n.bundlePolicy="balanced";}if(n.iceServers=function(e,t){var n=!1;return (e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&e.urls;var i="string"==typeof r;return i&&(r=[r]),r=r.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||n?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(n=!0,!0)})),delete e.url,e.urls=i?r[0]:r,!!r.length}}))}(n.iceServers||[],t),this._iceGatherers=[],n.iceCandidatePoolSize)for(var s=n.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:n.iceServers,gatherPolicy:n.iceTransportPolicy}));else n.iceCandidatePoolSize=0;this._config=n,this.transceivers=[],this._sdpSessionId=c.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1;};Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t));},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e);},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e,t){var n=this.transceivers.length>0,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&n)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this._createIceAndDtlsTransports();r.iceTransport=i.iceTransport,r.dtlsTransport=i.dtlsTransport;}return t||this.transceivers.push(r),r},l.prototype.addTrack=function(t,n){if(this._isClosed)throw a("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");if(this.transceivers.find((function(e){return e.track===t})))throw a("InvalidAccessError","Track already exists.");for(var r,i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(r=this.transceivers[i]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(n)&&this.localStreams.push(n),r.track=t,r.stream=n,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},l.prototype.addStream=function(e){var n=this;if(t>=15025)e.getTracks().forEach((function(t){n.addTrack(t,e);}));else{var r=e.clone();e.getTracks().forEach((function(e,t){var n=r.getTracks()[t];e.addEventListener("enabled",(function(e){n.enabled=e.enabled;}));})),r.getTracks().forEach((function(e){n.addTrack(e,r);}));}},l.prototype.removeTrack=function(t){if(this._isClosed)throw a("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var n=this.transceivers.find((function(e){return e.rtpSender===t}));if(!n)throw a("InvalidAccessError","Sender was not created by this connection.");var r=n.stream;n.rtpSender.stop(),n.rtpSender=null,n.track=null,n.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(r)&&this.localStreams.indexOf(r)>-1&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded();},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var n=t.getSenders().find((function(t){return t.track===e}));n&&t.removeTrack(n);}));},l.prototype.getSenders=function(){return this.transceivers.filter((function(e){return !!e.rtpSender})).map((function(e){return e.rtpSender}))},l.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return !!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},l.prototype._createIceGatherer=function(t,n){var r=this;if(n&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var n=!e.candidate||0===Object.keys(e.candidate).length;i.state=n?"completed":"gathering",null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e);},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},l.prototype._gather=function(t,n){var r=this,i=this.transceivers[n].iceGatherer;if(!i.onlocalcandidate){var s=this.transceivers[n].bufferedCandidateEvents;this.transceivers[n].bufferedCandidateEvents=null,i.removeEventListener("localcandidate",this.transceivers[n].bufferCandidates),i.onlocalcandidate=function(e){if(!(r.usingBundle&&n>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:n};var o=e.candidate,a=!o||0===Object.keys(o).length;if(a)"new"!==i.state&&"gathering"!==i.state||(i.state="completed");else{"new"===i.state&&(i.state="gathering"),o.component=1,o.ufrag=i.getLocalParameters().usernameFragment;var d=c.writeCandidate(o);s.candidate=Object.assign(s.candidate,c.parseCandidate(d)),s.candidate.candidate=d,s.candidate.toJSON=function(){return {candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}};}var l=c.getMediaSections(r._localDescription.sdp);l[s.candidate.sdpMLineIndex]+=a?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",r._localDescription.sdp=c.getDescription(r._localDescription.sdp)+l.join("");var u=r.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==r.iceGatheringState&&(r.iceGatheringState="gathering",r._emitGatheringStateChange()),a||r._dispatchEvent("icecandidate",s),u&&(r._dispatchEvent("icecandidate",new Event("icecandidate")),r.iceGatheringState="complete",r._emitGatheringStateChange());}},e.setTimeout((function(){s.forEach((function(e){i.onlocalcandidate(e);}));}),0);}},l.prototype._createIceAndDtlsTransports=function(){var t=this,n=new e.RTCIceTransport(null);n.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState();};var r=new e.RTCDtlsTransport(n);return r.ondtlsstatechange=function(){t._updateConnectionState();},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t._updateConnectionState();},{iceTransport:n,dtlsTransport:r}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var n=this.transceivers[e].iceTransport;n&&(delete n.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport);},l.prototype._transceive=function(e,n,r){var s=i(e.localCapabilities,e.remoteCapabilities);n&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:c.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),r&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx;})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s));},l.prototype.setLocalDescription=function(e){var t,n,r=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(a("TypeError",'Unsupported type "'+e.type+'"'));if(!s("setLocalDescription",e.type,r.signalingState)||r._isClosed)return Promise.reject(a("InvalidStateError","Can not set local "+e.type+" in state "+r.signalingState));if("offer"===e.type)t=c.splitSections(e.sdp),n=t.shift(),t.forEach((function(e,t){var n=c.parseRtpParameters(e);r.transceivers[t].localCapabilities=n;})),r.transceivers.forEach((function(e,t){r._gather(e.mid,t);}));else if("answer"===e.type){t=c.splitSections(r._remoteDescription.sdp),n=t.shift();var o=c.matchPrefix(n,"a=ice-lite").length>0;t.forEach((function(e,t){var s=r.transceivers[t],a=s.iceGatherer,d=s.iceTransport,l=s.dtlsTransport,u=s.localCapabilities,p=s.remoteCapabilities;if(!(c.isRejected(e)&&0===c.matchPrefix(e,"a=bundle-only").length||s.rejected)){var S=c.getIceParameters(e,n),E=c.getDtlsParameters(e,n);o&&(E.role="server"),r.usingBundle&&0!==t||(r._gather(s.mid,t),"new"===d.state&&d.start(a,S,o?"controlling":"controlled"),"new"===l.state&&l.start(E));var g=i(u,p);r._transceive(s,g.codecs.length>0,!1);}}));}return r._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?r._updateSignalingState("have-local-offer"):r._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(r){var i=this;if(-1===["offer","answer"].indexOf(r.type))return Promise.reject(a("TypeError",'Unsupported type "'+r.type+'"'));if(!s("setRemoteDescription",r.type,i.signalingState)||i._isClosed)return Promise.reject(a("InvalidStateError","Can not set remote "+r.type+" in state "+i.signalingState));var l={};i.remoteStreams.forEach((function(e){l[e.id]=e;}));var u=[],p=c.splitSections(r.sdp),S=p.shift(),E=c.matchPrefix(S,"a=ice-lite").length>0,g=c.matchPrefix(S,"a=group:BUNDLE ").length>0;i.usingBundle=g;var m=c.matchPrefix(S,"a=ice-options:")[0];return i.canTrickleIceCandidates=!!m&&m.substr(14).split(" ").indexOf("trickle")>=0,p.forEach((function(s,a){var d=c.splitLines(s),p=c.getKind(s),m=c.isRejected(s)&&0===c.matchPrefix(s,"a=bundle-only").length,f=d[0].substr(2).split(" ")[2],h=c.getDirection(s,S),R=c.parseMsid(s),T=c.getMid(s)||c.generateIdentifier();if(m||"application"===p&&("DTLS/SCTP"===f||"UDP/DTLS/SCTP"===f))i.transceivers[a]={mid:T,kind:p,protocol:f,rejected:!0};else{!m&&i.transceivers[a]&&i.transceivers[a].rejected&&(i.transceivers[a]=i._createTransceiver(p,!0));var C,I,_,v,O,A,y,D,N,P,M,w=c.parseRtpParameters(s);m||(P=c.getIceParameters(s,S),(M=c.getDtlsParameters(s,S)).role="client"),y=c.parseRtpEncodingParameters(s);var b=c.parseRtcpParameters(s),k=c.matchPrefix(s,"a=end-of-candidates",S).length>0,L=c.matchPrefix(s,"a=candidate:").map((function(e){return c.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===r.type||"answer"===r.type)&&!m&&g&&a>0&&i.transceivers[a]&&(i._disposeIceAndDtlsTransports(a),i.transceivers[a].iceGatherer=i.transceivers[0].iceGatherer,i.transceivers[a].iceTransport=i.transceivers[0].iceTransport,i.transceivers[a].dtlsTransport=i.transceivers[0].dtlsTransport,i.transceivers[a].rtpSender&&i.transceivers[a].rtpSender.setTransport(i.transceivers[0].dtlsTransport),i.transceivers[a].rtpReceiver&&i.transceivers[a].rtpReceiver.setTransport(i.transceivers[0].dtlsTransport)),"offer"!==r.type||m)"answer"!==r.type||m||(I=(C=i.transceivers[a]).iceGatherer,_=C.iceTransport,v=C.dtlsTransport,O=C.rtpReceiver,A=C.sendEncodingParameters,D=C.localCapabilities,i.transceivers[a].recvEncodingParameters=y,i.transceivers[a].remoteCapabilities=w,i.transceivers[a].rtcpParameters=b,L.length&&"new"===_.state&&(!E&&!k||g&&0!==a?L.forEach((function(e){o(C.iceTransport,e);})):_.setRemoteCandidates(L)),g&&0!==a||("new"===_.state&&_.start(I,P,"controlling"),"new"===v.state&&v.start(M)),i._transceive(C,"sendrecv"===h||"recvonly"===h,"sendrecv"===h||"sendonly"===h),!O||"sendrecv"!==h&&"sendonly"!==h?delete C.rtpReceiver:(N=O.track,R?(l[R.stream]||(l[R.stream]=new e.MediaStream),n(N,l[R.stream]),u.push([N,O,l[R.stream]])):(l.default||(l.default=new e.MediaStream),n(N,l.default),u.push([N,O,l.default]))));else{(C=i.transceivers[a]||i._createTransceiver(p)).mid=T,C.iceGatherer||(C.iceGatherer=i._createIceGatherer(a,g)),L.length&&"new"===C.iceTransport.state&&(!k||g&&0!==a?L.forEach((function(e){o(C.iceTransport,e);})):C.iceTransport.setRemoteCandidates(L)),D=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(D.codecs=D.codecs.filter((function(e){return "rtx"!==e.name}))),A=C.sendEncodingParameters||[{ssrc:1001*(2*a+2)}];var U,G=!1;"sendrecv"===h||"sendonly"===h?(G=!C.rtpReceiver,O=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,p),G&&(N=O.track,R&&"-"===R.stream||(R?(l[R.stream]||(l[R.stream]=new e.MediaStream,Object.defineProperty(l[R.stream],"id",{get:function(){return R.stream}})),Object.defineProperty(N,"id",{get:function(){return R.track}}),U=l[R.stream]):(l.default||(l.default=new e.MediaStream),U=l.default)),U&&(n(N,U),C.associatedRemoteMediaStreams.push(U)),u.push([N,O,U]))):C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach((function(t){var n=t.getTracks().find((function(e){return e.id===C.rtpReceiver.track.id}));n&&function(t,n){n.removeTrack(t),n.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}));}(n,t);})),C.associatedRemoteMediaStreams=[]),C.localCapabilities=D,C.remoteCapabilities=w,C.rtpReceiver=O,C.rtcpParameters=b,C.sendEncodingParameters=A,C.recvEncodingParameters=y,i._transceive(i.transceivers[a],!1,G);}}})),void 0===i._dtlsRole&&(i._dtlsRole="offer"===r.type?"active":"passive"),i._remoteDescription={type:r.type,sdp:r.sdp},"offer"===r.type?i._updateSignalingState("have-remote-offer"):i._updateSignalingState("stable"),Object.keys(l).forEach((function(t){var n=l[t];if(n.getTracks().length){if(-1===i.remoteStreams.indexOf(n)){i.remoteStreams.push(n);var r=new Event("addstream");r.stream=n,e.setTimeout((function(){i._dispatchEvent("addstream",r);}));}u.forEach((function(e){var t=e[0],r=e[1];n.id===e[2].id&&d(i,t,r,[n]);}));}})),u.forEach((function(e){e[2]||d(i,e[0],e[1],[]);})),e.setTimeout((function(){i&&i.transceivers&&i.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&e.iceTransport.addRemoteCandidate({});}));}),4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop();})),this._isClosed=!0,this._updateSignalingState("closed");},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t);},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e);}}),0));},l.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){t[e.iceTransport.state]++;})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var n=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",n);}},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){t[e.iceTransport.state]++,t[e.dtlsTransport.state]++;})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var n=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",n);}},l.prototype.createOffer=function(){var n=this;if(n._isClosed)return Promise.reject(a("InvalidStateError","Can not call createOffer after close"));var i=n.transceivers.filter((function(e){return "audio"===e.kind})).length,s=n.transceivers.filter((function(e){return "video"===e.kind})).length,o=arguments[0];if(o){if(o.mandatory||o.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==o.offerToReceiveAudio&&(i=!0===o.offerToReceiveAudio?1:!1===o.offerToReceiveAudio?0:o.offerToReceiveAudio),void 0!==o.offerToReceiveVideo&&(s=!0===o.offerToReceiveVideo?1:!1===o.offerToReceiveVideo?0:o.offerToReceiveVideo);}for(n.transceivers.forEach((function(e){"audio"===e.kind?--i<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1);}));i>0||s>0;)i>0&&(n._createTransceiver("audio"),i--),s>0&&(n._createTransceiver("video"),s--);var d=c.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.transceivers.forEach((function(r,i){var s=r.track,o=r.kind,a=r.mid||c.generateIdentifier();r.mid=a,r.iceGatherer||(r.iceGatherer=n._createIceGatherer(i,n.usingBundle));var d=e.RTCRtpSender.getCapabilities(o);t<15019&&(d.codecs=d.codecs.filter((function(e){return "rtx"!==e.name}))),d.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),r.remoteCapabilities&&r.remoteCapabilities.codecs&&r.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType);}));})),d.headerExtensions.forEach((function(e){(r.remoteCapabilities&&r.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id);}));}));var l=r.sendEncodingParameters||[{ssrc:1001*(2*i+1)}];s&&t>=15019&&"video"===o&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),r.wantReceive&&(r.rtpReceiver=new e.RTCRtpReceiver(r.dtlsTransport,o)),r.localCapabilities=d,r.sendEncodingParameters=l;})),"max-compat"!==n._config.bundlePolicy&&(d+="a=group:BUNDLE "+n.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n",n.transceivers.forEach((function(e,t){d+=r(e,e.localCapabilities,"offer",e.stream,n._dtlsRole),d+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===n.iceGatheringState||0!==t&&n.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,d+="a="+c.writeCandidate(e)+"\r\n";})),"completed"===e.iceGatherer.state&&(d+="a=end-of-candidates\r\n"));}));var l=new e.RTCSessionDescription({type:"offer",sdp:d});return Promise.resolve(l)},l.prototype.createAnswer=function(){var n=this;if(n._isClosed)return Promise.reject(a("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==n.signalingState&&"have-local-pranswer"!==n.signalingState)return Promise.reject(a("InvalidStateError","Can not call createAnswer in signalingState "+n.signalingState));var s=c.writeSessionBoilerplate(n._sdpSessionId,n._sdpSessionVersion++);n.usingBundle&&(s+="a=group:BUNDLE "+n.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n");var o=c.getMediaSections(n._remoteDescription.sdp).length;n.transceivers.forEach((function(e,a){if(!(a+1>o)){if(e.rejected)return "application"===e.kind?"DTLS/SCTP"===e.protocol?s+="m=application 0 DTLS/SCTP 5000\r\n":s+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var d=i(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter((function(e){return "rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=r(e,d,"answer",e.stream,n._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n");}}));var d=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(d)},l.prototype.addIceCandidate=function(e){var t,n=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(r,i){if(!n._remoteDescription)return i(a("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var d=0;d<n.transceivers.length;d++)if(n.transceivers[d].mid===e.sdpMid){s=d;break}var l=n.transceivers[s];if(!l)return i(a("OperationError","Can not add ICE candidate"));if(l.rejected)return r();var u=Object.keys(e.candidate).length>0?c.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return r();if(u.component&&1!==u.component)return r();if((0===s||s>0&&l.iceTransport!==n.transceivers[0].iceTransport)&&!o(l.iceTransport,u))return i(a("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();0===p.indexOf("a=")&&(p=p.substr(2)),(t=c.getMediaSections(n._remoteDescription.sdp))[s]+="a="+(u.type?p:"end-of-candidates")+"\r\n",n._remoteDescription.sdp=c.getDescription(n._remoteDescription.sdp)+t.join("");}else for(var S=0;S<n.transceivers.length&&(n.transceivers[S].rejected||(n.transceivers[S].iceTransport.addRemoteCandidate({}),(t=c.getMediaSections(n._remoteDescription.sdp))[S]+="a=end-of-candidates\r\n",n._remoteDescription.sdp=c.getDescription(n._remoteDescription.sdp)+t.join(""),!n.usingBundle));S++);r();}))},l.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var n=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?n=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(n=e.rtpReceiver);})),!n)throw a("InvalidAccessError","Invalid selector.");return n.getStats()}var r=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&r.push(e[t].getStats());}));})),Promise.all(r).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e);}));})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var n=e[t];if(n&&n.prototype&&n.prototype.getStats){var r=n.prototype.getStats;n.prototype.getStats=function(){return r.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(n){var r;e[n].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(r=e[n]).type]||r.type,t.set(n,e[n]);})),t}))};}}));var u=["createOffer","createAnswer"];return u.forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return "function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t]);}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t]);})):t.apply(this,arguments)};})),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return "function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null);}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t]);})):t.apply(this,arguments)};})),["getStats"].forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return "function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null);})):t.apply(this,arguments)};})),l};},{sdp:2}],2:[function(e,t,n){var r={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};r.localCName=r.generateIdentifier(),r.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},r.splitSections=function(e){return e.split("\nm=").map((function(e,t){return (t>0?"m="+e:e).trim()+"\r\n"}))},r.getDescription=function(e){var t=r.splitSections(e);return t&&t[0]},r.getMediaSections=function(e){var t=r.splitSections(e);return t.shift(),t},r.matchPrefix=function(e,t){return r.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},r.parseCandidate=function(e){for(var t,n={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":n.relatedAddress=t[r+1];break;case"rport":n.relatedPort=parseInt(t[r+1],10);break;case"tcptype":n.tcpType=t[r+1];break;case"ufrag":n.ufrag=t[r+1],n.usernameFragment=t[r+1];break;default:n[t[r]]=t[r+1];}return n},r.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},r.parseIceOptions=function(e){return e.substr(14).split(" ")},r.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.channels=3===t.length?parseInt(t[2],10):1,n.numChannels=n.channels,n},r.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var n=e.channels||e.numChannels||1;return "a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==n?"/"+n:"")+"\r\n"},r.parseExtmap=function(e){var t=e.substr(9).split(" ");return {id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},r.writeExtmap=function(e){return "a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},r.parseFmtp=function(e){for(var t,n={},r=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<r.length;i++)n[(t=r[i].trim().split("="))[0].trim()]=t[1];return n},r.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t);})),t+="a=fmtp:"+n+" "+r.join(";")+"\r\n";}return t},r.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return {type:t.shift(),parameter:t.join(" ")}},r.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n";})),t},r.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(n.attribute=e.substr(t+1,r-t-1),n.value=e.substr(r+1)):n.attribute=e.substr(t+1),n},r.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return {semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},r.getMid=function(e){var t=r.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},r.parseFingerprint=function(e){var t=e.substr(14).split(" ");return {algorithm:t[0].toLowerCase(),value:t[1]}},r.getDtlsParameters=function(e,t){return {role:"auto",fingerprints:r.matchPrefix(e+t,"a=fingerprint:").map(r.parseFingerprint)}},r.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n";})),n},r.getIceParameters=function(e,t){var n=r.splitLines(e);return {usernameFragment:(n=n.concat(r.splitLines(t))).filter((function(e){return 0===e.indexOf("a=ice-ufrag:")}))[0].substr(12),password:n.filter((function(e){return 0===e.indexOf("a=ice-pwd:")}))[0].substr(10)}},r.writeIceParameters=function(e){return "a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},r.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=r.splitLines(e)[0].split(" "),i=3;i<n.length;i++){var s=n[i],o=r.matchPrefix(e,"a=rtpmap:"+s+" ")[0];if(o){var a=r.parseRtpMap(o),c=r.matchPrefix(e,"a=fmtp:"+s+" ");switch(a.parameters=c.length?r.parseFmtp(c[0]):{},a.rtcpFeedback=r.matchPrefix(e,"a=rtcp-fb:"+s+" ").map(r.parseRtcpFb),t.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(a.name.toUpperCase());}}}return r.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(r.parseExtmap(e));})),t},r.writeRtpDescription=function(e,t){var n="";n+="m="+e+" ",n+=t.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){n+=r.writeRtpMap(e),n+=r.writeFmtp(e),n+=r.writeRtcpFb(e);}));var i=0;return t.codecs.forEach((function(e){e.maxptime>i&&(i=e.maxptime);})),i>0&&(n+="a=maxptime:"+i+"\r\n"),n+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach((function(e){n+=r.writeExtmap(e);})),n},r.parseRtpEncodingParameters=function(e){var t,n=[],i=r.parseRtpParameters(e),s=-1!==i.fecMechanisms.indexOf("RED"),o=-1!==i.fecMechanisms.indexOf("ULPFEC"),a=r.matchPrefix(e,"a=ssrc:").map((function(e){return r.parseSsrcMedia(e)})).filter((function(e){return "cname"===e.attribute})),c=a.length>0&&a[0].ssrc,d=r.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(t=d[0][1]),i.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var r={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(r.rtx={ssrc:t}),n.push(r),s&&((r=JSON.parse(JSON.stringify(r))).fec={ssrc:t,mechanism:o?"red+ulpfec":"red"},n.push(r));}})),0===n.length&&c&&n.push({ssrc:c});var l=r.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,n.forEach((function(e){e.maxBitrate=l;}))),n},r.parseRtcpParameters=function(e){var t={},n=r.matchPrefix(e,"a=ssrc:").map((function(e){return r.parseSsrcMedia(e)})).filter((function(e){return "cname"===e.attribute}))[0];n&&(t.cname=n.value,t.ssrc=n.ssrc);var i=r.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0,t.compound=0===i.length;var s=r.matchPrefix(e,"a=rtcp-mux");return t.mux=s.length>0,t},r.parseMsid=function(e){var t,n=r.matchPrefix(e,"a=msid:");if(1===n.length)return {stream:(t=n[0].substr(7).split(" "))[0],track:t[1]};var i=r.matchPrefix(e,"a=ssrc:").map((function(e){return r.parseSsrcMedia(e)})).filter((function(e){return "msid"===e.attribute}));return i.length>0?{stream:(t=i[0].value.split(" "))[0],track:t[1]}:void 0},r.generateSessionId=function(){return Math.random().toString().substr(2,21)},r.writeSessionBoilerplate=function(e,t){var n=void 0!==t?t:2;return "v=0\r\no=thisisadapterortc "+(e||r.generateSessionId())+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},r.writeMediaSection=function(e,t,n,i){var s=r.writeRtpDescription(e.kind,t);if(s+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),s+="a=mid:"+e.mid+"\r\n",e.direction?s+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";s+="a="+o,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n");}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),s},r.getDirection=function(e,t){for(var n=r.splitLines(e),i=0;i<n.length;i++)switch(n[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[i].substr(2)}return t?r.getDirection(t):"sendrecv"},r.getKind=function(e){return r.splitLines(e)[0].split(" ")[0].substr(2)},r.isRejected=function(e){return "0"===e.split(" ",2)[1]},r.parseMLine=function(e){var t=r.splitLines(e)[0].substr(2).split(" ");return {kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},r.parseOLine=function(e){var t=r.matchPrefix(e,"o=")[0].substr(2).split(" ");return {username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},r.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return !1;for(var t=r.splitLines(e),n=0;n<t.length;n++)if(t[n].length<2||"="!==t[n].charAt(1))return !1;return !0},"object"==typeof t&&(t.exports=r);},{}],3:[function(e,n,r){(function(t){var r=e("./adapter_factory.js");n.exports=r({window:t.window});}).call(this,void 0!==t?t:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});},{"./adapter_factory.js":4}],4:[function(e,t,n){var r=e("./utils");t.exports=function(t,n){var i=t&&t.window,s={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0};for(var o in n)hasOwnProperty.call(n,o)&&(s[o]=n[o]);var a=r.log,c=r.detectBrowser(i),d=e("./chrome/chrome_shim")||null,l=e("./edge/edge_shim")||null,u=e("./firefox/firefox_shim")||null,p=e("./safari/safari_shim")||null,S=e("./common_shim")||null,E={browserDetails:c,commonShim:S,extractVersion:r.extractVersion,disableLog:r.disableLog,disableWarnings:r.disableWarnings};switch(c.browser){case"chrome":if(!d||!d.shimPeerConnection||!s.shimChrome)return a("Chrome shim is not included in this adapter release."),E;a("adapter.js shimming chrome."),E.browserShim=d,S.shimCreateObjectURL(i),d.shimGetUserMedia(i),d.shimMediaStream(i),d.shimSourceObject(i),d.shimPeerConnection(i),d.shimOnTrack(i),d.shimAddTrackRemoveTrack(i),d.shimGetSendersWithDtmf(i),d.shimSenderReceiverGetStats(i),d.fixNegotiationNeeded(i),S.shimRTCIceCandidate(i),S.shimMaxMessageSize(i),S.shimSendThrowTypeError(i);break;case"firefox":if(!u||!u.shimPeerConnection||!s.shimFirefox)return a("Firefox shim is not included in this adapter release."),E;a("adapter.js shimming firefox."),E.browserShim=u,S.shimCreateObjectURL(i),u.shimGetUserMedia(i),u.shimSourceObject(i),u.shimPeerConnection(i),u.shimOnTrack(i),u.shimRemoveStream(i),u.shimSenderGetStats(i),u.shimReceiverGetStats(i),u.shimRTCDataChannel(i),S.shimRTCIceCandidate(i),S.shimMaxMessageSize(i),S.shimSendThrowTypeError(i);break;case"edge":if(!l||!l.shimPeerConnection||!s.shimEdge)return a("MS edge shim is not included in this adapter release."),E;a("adapter.js shimming edge."),E.browserShim=l,S.shimCreateObjectURL(i),l.shimGetUserMedia(i),l.shimPeerConnection(i),l.shimReplaceTrack(i),S.shimMaxMessageSize(i),S.shimSendThrowTypeError(i);break;case"safari":if(!p||!s.shimSafari)return a("Safari shim is not included in this adapter release."),E;a("adapter.js shimming safari."),E.browserShim=p,S.shimCreateObjectURL(i),p.shimRTCIceServerUrls(i),p.shimCreateOfferLegacy(i),p.shimCallbacksAPI(i),p.shimLocalStreamsAPI(i),p.shimRemoteStreamsAPI(i),p.shimTrackEventTransceiver(i),p.shimGetUserMedia(i),S.shimRTCIceCandidate(i),S.shimMaxMessageSize(i),S.shimSendThrowTypeError(i);break;default:a("Unsupported browser!");}return E};},{"./chrome/chrome_shim":5,"./common_shim":7,"./edge/edge_shim":8,"./firefox/firefox_shim":11,"./safari/safari_shim":13,"./utils":14}],5:[function(e,t,n){function r(e,t,n){var r=n?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;var s=[];return e.forEach((function(e){"track"===e.type&&e.trackIdentifier===t.id&&s.push(e);})),s.forEach((function(t){e.forEach((function(n){n.type===r&&n.trackId===t.id&&function e(t,n,r){n&&!r.has(n.id)&&(r.set(n.id,n),Object.keys(n).forEach((function(i){i.endsWith("Id")?e(t,t.get(n[i]),r):i.endsWith("Ids")&&n[i].forEach((function(n){e(t,t.get(n),r);}));})));}(e,n,i);}));})),i}var i=e("../utils.js"),s=i.log;t.exports={shimGetUserMedia:e("./getusermedia"),shimMediaStream:function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream;},shimOnTrack:function(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)"RTCRtpTransceiver"in e||i.wrapPeerConnectionEvent(e,"track",(function(e){return e.transceiver||(e.transceiver={receiver:e.receiver}),e}));else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e);},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var n=this;return n._ontrackpoly||(n._ontrackpoly=function(t){t.stream.addEventListener("addtrack",(function(r){var i;i=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find((function(e){return e.track&&e.track.id===r.track.id})):{track:r.track};var s=new Event("track");s.track=r.track,s.receiver=i,s.transceiver={receiver:i},s.streams=[t.stream],n.dispatchEvent(s);})),t.stream.getTracks().forEach((function(r){var i;i=e.RTCPeerConnection.prototype.getReceivers?n.getReceivers().find((function(e){return e.track&&e.track.id===r.id})):{track:r};var s=new Event("track");s.track=r,s.receiver=i,s.transceiver={receiver:i},s.streams=[t.stream],n.dispatchEvent(s);}));},n.addEventListener("addstream",n._ontrackpoly)),t.apply(n,arguments)};}},shimGetSendersWithDtmf:function(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return {track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var n=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){var i=this,s=n.apply(i,arguments);return s||(s=t(i,e),i._senders.push(s)),s};var r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;r.apply(t,arguments);var n=t._senders.indexOf(e);-1!==n&&t._senders.splice(n,1);};}var i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var n=this;n._senders=n._senders||[],i.apply(n,[e]),e.getTracks().forEach((function(e){n._senders.push(t(n,e));}));};var s=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._senders=t._senders||[],s.apply(t,[e]),e.getTracks().forEach((function(e){var n=t._senders.find((function(t){return t.track===e}));n&&t._senders.splice(t._senders.indexOf(n),1);}));};}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var o=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=o.apply(e,[]);return t.forEach((function(t){t._pc=e;})),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}});}},shimSenderReceiverGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,n=t.apply(e,[]);return n.forEach((function(t){t._pc=e;})),n});var n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return r(t,e.track,!0)}))};}if(!("getStats"in e.RTCRtpReceiver.prototype)){var s=e.RTCPeerConnection.prototype.getReceivers;s&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=s.apply(e,[]);return t.forEach((function(t){t._pc=e;})),t}),i.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return r(t,e.track,!1)}))};}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var t=this;if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var n,r,i,s=arguments[0];return t.getSenders().forEach((function(e){e.track===s&&(n?i=!0:n=e);})),t.getReceivers().forEach((function(e){return e.track===s&&(r?i=!0:r=e),e.track===s})),i||n&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return o.apply(t,arguments)};}}},shimSourceObject:function(e){var t=e&&e.URL;"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var n=this;this._srcObject=e,this.src&&t.revokeObjectURL(this.src),e?(this.src=t.createObjectURL(e),e.addEventListener("addtrack",(function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e);})),e.addEventListener("removetrack",(function(){n.src&&t.revokeObjectURL(n.src),n.src=t.createObjectURL(e);}))):this.src="";}}));},shimAddTrackRemoveTrackWithNative:function(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((function(t){return e._shimmedLocalStreams[t][0]}))};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){if(!n)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var r=t.apply(this,arguments);return this._shimmedLocalStreams[n.id]?-1===this._shimmedLocalStreams[n.id].indexOf(r)&&this._shimmedLocalStreams[n.id].push(r):this._shimmedLocalStreams[n.id]=[n,r],r};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((function(e){if(t.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")}));var r=t.getSenders();n.apply(this,arguments);var i=t.getSenders().filter((function(e){return -1===r.indexOf(e)}));this._shimmedLocalStreams[e.id]=[e].concat(i);};var r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((function(n){var r=t._shimmedLocalStreams[n].indexOf(e);-1!==r&&t._shimmedLocalStreams[n].splice(r,1),1===t._shimmedLocalStreams[n].length&&delete t._shimmedLocalStreams[n];})),i.apply(this,arguments)};},shimAddTrackRemoveTrack:function(e){function t(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(i.id,"g"),r.id);})),new RTCSessionDescription({type:t.type,sdp:n})}function n(e,t){var n=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var r=e._reverseStreams[t],i=e._streams[r.id];n=n.replace(new RegExp(r.id,"g"),i.id);})),new RTCSessionDescription({type:t.type,sdp:n})}var r=i.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&r.version>=65)return this.shimAddTrackRemoveTrackWithNative(e);var s=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=s.apply(this);return e._reverseStreams=e._reverseStreams||{},t.map((function(t){return e._reverseStreams[t.id]}))};var o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var n=this;if(n._streams=n._streams||{},n._reverseStreams=n._reverseStreams||{},t.getTracks().forEach((function(e){if(n.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")})),!n._reverseStreams[t.id]){var r=new e.MediaStream(t.getTracks());n._streams[t.id]=r,n._reverseStreams[r.id]=t,t=r;}o.apply(n,[t]);};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;t._streams=t._streams||{},t._reverseStreams=t._reverseStreams||{},a.apply(t,[t._streams[e.id]||e]),delete t._reverseStreams[t._streams[e.id]?t._streams[e.id].id:e.id],delete t._streams[e.id];},e.RTCPeerConnection.prototype.addTrack=function(t,n){var r=this;if("closed"===r.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((function(e){return e===t})))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(r.getSenders().find((function(e){return e.track===t})))throw new DOMException("Track already exists.","InvalidAccessError");r._streams=r._streams||{},r._reverseStreams=r._reverseStreams||{};var s=r._streams[n.id];if(s)s.addTrack(t),Promise.resolve().then((function(){r.dispatchEvent(new Event("negotiationneeded"));}));else{var o=new e.MediaStream([t]);r._streams[n.id]=o,r._reverseStreams[o.id]=n,r.addStream(o);}return r.getSenders().find((function(e){return e.track===t}))},["createOffer","createAnswer"].forEach((function(n){var r=e.RTCPeerConnection.prototype[n];e.RTCPeerConnection.prototype[n]=function(){var e=this,n=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(e,[function(r){var i=t(e,r);n[0].apply(null,[i]);},function(e){n[1]&&n[1].apply(null,e);},arguments[2]]):r.apply(e,arguments).then((function(n){return t(e,n)}))};}));var c=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){var e=this;return arguments.length&&arguments[0].type?(arguments[0]=n(e,arguments[0]),c.apply(e,arguments)):c.apply(e,arguments)};var d=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=d.get.apply(this);return ""===e.type?e:t(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t,n=this;if("closed"===n.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==n)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");n._streams=n._streams||{},Object.keys(n._streams).forEach((function(r){n._streams[r].getTracks().find((function(t){return e.track===t}))&&(t=n._streams[r]);})),t&&(1===t.getTracks().length?n.removeStream(n._reverseStreams[t.id]):t.removeTrack(e.track),n.dispatchEvent(new Event("negotiationneeded")));};},shimPeerConnection:function(e){var t=i.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection)e.RTCPeerConnection=function(t,n){return s("PeerConnection"),t&&t.iceTransportPolicy&&(t.iceTransports=t.iceTransportPolicy),new e.webkitRTCPeerConnection(t,n)},e.RTCPeerConnection.prototype=e.webkitRTCPeerConnection.prototype,e.webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.webkitRTCPeerConnection.generateCertificate}});else{var n=e.RTCPeerConnection;e.RTCPeerConnection=function(e,t){if(e&&e.iceServers){for(var r=[],s=0;s<e.iceServers.length;s++){var o=e.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(i.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,r.push(o)):r.push(e.iceServers[s]);}e.iceServers=r;}return new n(e,t)},e.RTCPeerConnection.prototype=n.prototype,Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return n.generateCertificate}});}var r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,t,n){var i=this,s=arguments;if(arguments.length>0&&"function"==typeof e)return r.apply(this,arguments);if(0===r.length&&(0===arguments.length||"function"!=typeof e))return r.apply(this,[]);var o=function(e){var t={};return e.result().forEach((function(e){var n={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((function(t){n[t]=e.stat(t);})),t[n.id]=n;})),t},a=function(e){return new Map(Object.keys(e).map((function(t){return [t,e[t]]})))};if(arguments.length>=2){var c=function(e){s[1](a(o(e)));};return r.apply(this,[c,e])}return new Promise((function(e,t){r.apply(i,[function(t){e(a(o(t)));},t]);})).then(t,n)},t.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=arguments,t=this,r=new Promise((function(r,i){n.apply(t,[e[0],r,i]);}));return e.length<2?r:r.then((function(){e[1].apply(null,[]);}),(function(t){e.length>=3&&e[2].apply(null,[t]);}))};})),t.version<52&&["createOffer","createAnswer"].forEach((function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var t=1===arguments.length?arguments[0]:void 0;return new Promise((function(r,i){n.apply(e,[r,i,t]);}))}return n.apply(this,arguments)};})),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)};}));var o=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?o.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};},fixNegotiationNeeded:function(e){i.wrapPeerConnectionEvent(e,"negotiationneeded",(function(e){if("stable"===e.target.signalingState)return e}));},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||"function"==typeof t&&(navigator.getDisplayMedia=function(e){return t(e).then((function(t){return e.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:e.video.frameRate||3}},navigator.mediaDevices.getUserMedia(e)}))});}};},{"../utils.js":14,"./getusermedia":6}],6:[function(e,t,n){var r=e("../utils.js"),i=r.log;t.exports=function(e){var t=r.detectBrowser(e),n=e&&e.navigator,s=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];var s={};"number"==typeof r.ideal?(s[i("min",n)]=r.ideal,t.optional.push(s),(s={})[i("max",n)]=r.ideal,t.optional.push(s)):(s[i("",n)]=r.ideal,t.optional.push(s));}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach((function(e){void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e]);}));}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},o=function(e,r){if(t.version>=61)return r(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){var o=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t]);};o((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),o(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=s(e.audio);}if(e&&"object"==typeof e.video){var a=e.video.facingMode;a=a&&("object"==typeof a?a:{ideal:a});var c,d=t.version<66;if(a&&("user"===a.exact||"environment"===a.exact||"user"===a.ideal||"environment"===a.ideal)&&(!n.mediaDevices.getSupportedConstraints||!n.mediaDevices.getSupportedConstraints().facingMode||d)&&(delete e.video.facingMode,"environment"===a.exact||"environment"===a.ideal?c=["back","rear"]:"user"!==a.exact&&"user"!==a.ideal||(c=["front"]),c))return n.mediaDevices.enumerateDevices().then((function(t){var n=(t=t.filter((function(e){return "videoinput"===e.kind}))).find((function(e){return c.some((function(t){return -1!==e.label.toLowerCase().indexOf(t)}))}));return !n&&t.length&&-1!==c.indexOf("back")&&(n=t[t.length-1]),n&&(e.video.deviceId=a.exact?{exact:n.deviceId}:{ideal:n.deviceId}),e.video=s(e.video),i("chrome: "+JSON.stringify(e)),r(e)}));e.video=s(e.video);}return i("chrome: "+JSON.stringify(e)),r(e)},a=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};n.getUserMedia=function(e,t,r){o(e,(function(e){n.webkitGetUserMedia(e,t,(function(e){r&&r(a(e));}));}));};var c=function(e){return new Promise((function(t,r){n.getUserMedia(e,t,r);}))};if(n.mediaDevices||(n.mediaDevices={getUserMedia:c,enumerateDevices:function(){return new Promise((function(t){var n={audio:"audioinput",video:"videoinput"};return e.MediaStreamTrack.getSources((function(e){t(e.map((function(e){return {label:e.label,kind:n[e.kind],deviceId:e.id,groupId:""}})));}))}))},getSupportedConstraints:function(){return {deviceId:!0,echoCancellation:!0,facingMode:!0,frameRate:!0,height:!0,width:!0}}}),n.mediaDevices.getUserMedia){var d=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(e){return o(e,(function(e){return d(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop();})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(a(e))}))}))};}else n.mediaDevices.getUserMedia=function(e){return c(e)};void 0===n.mediaDevices.addEventListener&&(n.mediaDevices.addEventListener=function(){i("Dummy mediaDevices.addEventListener called.");}),void 0===n.mediaDevices.removeEventListener&&(n.mediaDevices.removeEventListener=function(){i("Dummy mediaDevices.removeEventListener called.");});};},{"../utils.js":14}],7:[function(e,t,n){var r=e("sdp"),i=e("./utils");t.exports={shimRTCIceCandidate:function(e){if(e.RTCIceCandidate&&!(e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var n=new t(e),i=r.parseCandidate(e.candidate),s=Object.assign(n,i);return s.toJSON=function(){return {candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,i.wrapPeerConnectionEvent(e,"icecandidate",(function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t}));}},shimCreateObjectURL:function(e){var t=e&&e.URL;if("object"==typeof e&&e.HTMLMediaElement&&"srcObject"in e.HTMLMediaElement.prototype&&t.createObjectURL&&t.revokeObjectURL){var n=t.createObjectURL.bind(t),r=t.revokeObjectURL.bind(t),s=new Map,o=0;t.createObjectURL=function(e){if("getTracks"in e){var t="polyblob:"+ ++o;return s.set(t,e),i.deprecated("URL.createObjectURL(stream)","elem.srcObject = stream"),t}return n(e)},t.revokeObjectURL=function(e){r(e),s.delete(e);};var a=Object.getOwnPropertyDescriptor(e.HTMLMediaElement.prototype,"src");Object.defineProperty(e.HTMLMediaElement.prototype,"src",{get:function(){return a.get.apply(this)},set:function(e){return this.srcObject=s.get(e)||null,a.set.apply(this,[e])}});var c=e.HTMLMediaElement.prototype.setAttribute;e.HTMLMediaElement.prototype.setAttribute=function(){return 2===arguments.length&&"src"===(""+arguments[0]).toLowerCase()&&(this.srcObject=s.get(arguments[1])||null),c.apply(this,arguments)};}},shimMaxMessageSize:function(e){if(!e.RTCSctpTransport&&e.RTCPeerConnection){var t=i.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var n=function(e){var t=r.splitSections(e.sdp);return t.shift(),t.some((function(e){var t=r.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},s=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return -1;var n=parseInt(t[1],10);return n!=n?-1:n},o=function(e){var n=65536;return "firefox"===t.browser&&(n=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),n},a=function(e,n){var i=65536;"firefox"===t.browser&&57===t.version&&(i=65535);var s=r.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?i=parseInt(s[0].substr(19),10):"firefox"===t.browser&&-1!==n&&(i=2147483637),i},c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;if(e._sctp=null,n(arguments[0])){var t,r=s(arguments[0]),i=o(r),d=a(arguments[0],r);t=0===i&&0===d?Number.POSITIVE_INFINITY:0===i||0===d?Math.max(i,d):Math.min(i,d);var l={};Object.defineProperty(l,"maxMessageSize",{get:function(){return t}}),e._sctp=l;}return c.apply(e,arguments)};}},shimSendThrowTypeError:function(e){function t(e,t){var n=e.send;e.send=function(){var r=arguments[0],i=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return n.apply(e,arguments)};}if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var n=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=this,r=n.apply(e,arguments);return t(r,e),r},i.wrapPeerConnectionEvent(e,"datachannel",(function(e){return t(e.channel,e.target),e}));}}};},{"./utils":14,sdp:2}],8:[function(e,t,n){var r=e("../utils"),i=e("./filtericeservers"),s=e("rtcpeerconnection-shim");t.exports={shimGetUserMedia:e("./getusermedia"),shimPeerConnection:function(e){var t=r.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var n=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){n.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t);}});}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var o=s(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=i(e.iceServers)),new o(e)},e.RTCPeerConnection.prototype=o.prototype;},shimReplaceTrack:function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack);}};},{"../utils":14,"./filtericeservers":9,"./getusermedia":10,"rtcpeerconnection-shim":1}],9:[function(e,t,n){var r=e("../utils");t.exports=function(e,t){var n=!1;return (e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var i=e.urls||e.url;e.url&&!e.urls&&r.deprecated("RTCIceServer.url","RTCIceServer.urls");var s="string"==typeof i;return s&&(i=[i]),i=i.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||n?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(n=!0,!0)})),delete e.url,e.urls=s?i[0]:i,!!i.length}}))};},{"../utils":14}],10:[function(e,t,n){t.exports=function(e){var t=e&&e.navigator,n=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return n(e).catch((function(e){return Promise.reject(function(e){return {name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))}))};};},{}],11:[function(e,t,n){var r=e("../utils");t.exports={shimGetUserMedia:e("./getusermedia"),shimOnTrack:function(e){"object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.transceiver={receiver:n.receiver},n.streams=[e.stream],this.dispatchEvent(n);}.bind(this));}.bind(this));},enumerable:!0,configurable:!0}),"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return {receiver:this.receiver}}});},shimSourceObject:function(e){"object"==typeof e&&(!e.HTMLMediaElement||"srcObject"in e.HTMLMediaElement.prototype||Object.defineProperty(e.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e;}}));},shimPeerConnection:function(e){var t=r.detectBrowser(e);if("object"==typeof e&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){e.RTCPeerConnection||(e.RTCPeerConnection=function(n,r){if(t.version<38&&n&&n.iceServers){for(var i=[],s=0;s<n.iceServers.length;s++){var o=n.iceServers[s];if(o.hasOwnProperty("urls"))for(var a=0;a<o.urls.length;a++){var c={url:o.urls[a]};0===o.urls[a].indexOf("turn")&&(c.username=o.username,c.credential=o.credential),i.push(c);}else i.push(n.iceServers[s]);}n.iceServers=i;}return new e.mozRTCPeerConnection(n,r)},e.RTCPeerConnection.prototype=e.mozRTCPeerConnection.prototype,e.mozRTCPeerConnection.generateCertificate&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return e.mozRTCPeerConnection.generateCertificate}}),e.RTCSessionDescription=e.mozRTCSessionDescription,e.RTCIceCandidate=e.mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var n=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]=function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)};}));var n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};var i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(e,n,r){return s.apply(this,[e||null]).then((function(e){if(t.version<48&&(e=function(e){var t=new Map;return Object.keys(e).forEach((function(n){t.set(n,e[n]),t[n]=e[n];})),t}(e)),t.version<53&&!n)try{e.forEach((function(e){e.type=i[e.type]||e.type;}));}catch(t){if("TypeError"!==t.name)throw t;e.forEach((function(t,n){e.set(n,Object.assign({},t,{type:i[t.type]||t.type}));}));}return e})).then(n,r)};}},shimSenderGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,n=t.apply(e,[]);return n.forEach((function(t){t._pc=e;})),n});var n=e.RTCPeerConnection.prototype.addTrack;n&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=n.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)};}},shimReceiverGetStats:function(e){if("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&!(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,n=t.apply(e,[]);return n.forEach((function(t){t._pc=e;})),n}),r.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)};}},shimRemoveStream:function(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;r.deprecated("removeStream","removeTrack"),this.getSenders().forEach((function(n){n.track&&-1!==e.getTracks().indexOf(n.track)&&t.removeTrack(n);}));});},shimRTCDataChannel:function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel);},shimGetDisplayMedia:function(e,t){"getDisplayMedia"in e.navigator||(navigator.getDisplayMedia=function(e){if(!e||!e.video){var n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return !0===e.video?e.video={mediaSource:t}:e.video.mediaSource=t,navigator.mediaDevices.getUserMedia(e)});}};},{"../utils":14,"./getusermedia":12}],12:[function(e,t,n){var r=e("../utils"),i=r.log;t.exports=function(e){var t=r.detectBrowser(e),n=e&&e.navigator,s=e&&e.MediaStreamTrack,o=function(e){return {name:{InternalError:"NotReadableError",NotSupportedError:"TypeError",PermissionDeniedError:"NotAllowedError",SecurityError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},a=function(e,r,s){var a=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach((function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var r=e[n]="object"==typeof e[n]?e[n]:{ideal:e[n]};if(void 0===r.min&&void 0===r.max&&void 0===r.exact||t.push(n),void 0!==r.exact&&("number"==typeof r.exact?r.min=r.max=r.exact:e[n]=r.exact,delete r.exact),void 0!==r.ideal){e.advanced=e.advanced||[];var i={};"number"==typeof r.ideal?i[n]={min:r.ideal,max:r.ideal}:i[n]=r.ideal,e.advanced.push(i),delete r.ideal,Object.keys(r).length||delete e[n];}}})),t.length&&(e.require=t),e};return e=JSON.parse(JSON.stringify(e)),t.version<38&&(i("spec: "+JSON.stringify(e)),e.audio&&(e.audio=a(e.audio)),e.video&&(e.video=a(e.video)),i("ff37: "+JSON.stringify(e))),n.mozGetUserMedia(e,r,(function(e){s(o(e));}))};if(n.mediaDevices||(n.mediaDevices={getUserMedia:function(e){return new Promise((function(t,n){a(e,t,n);}))},addEventListener:function(){},removeEventListener:function(){}}),n.mediaDevices.enumerateDevices=n.mediaDevices.enumerateDevices||function(){return new Promise((function(e){e([{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}]);}))},t.version<41){var c=n.mediaDevices.enumerateDevices.bind(n.mediaDevices);n.mediaDevices.enumerateDevices=function(){return c().then(void 0,(function(e){if("NotFoundError"===e.name)return [];throw e}))};}if(t.version<49){var d=n.mediaDevices.getUserMedia.bind(n.mediaDevices);n.mediaDevices.getUserMedia=function(e){return d(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop();})),new DOMException("The object can not be found here.","NotFoundError");return t}),(function(e){return Promise.reject(o(e))}))};}if(!(t.version>55&&"autoGainControl"in n.mediaDevices.getSupportedConstraints())){var l=function(e,t,n){t in e&&!(n in e)&&(e[n]=e[t],delete e[t]);},u=n.mediaDevices.getUserMedia.bind(n.mediaDevices);if(n.mediaDevices.getUserMedia=function(e){return "object"==typeof e&&"object"==typeof e.audio&&(e=JSON.parse(JSON.stringify(e)),l(e.audio,"autoGainControl","mozAutoGainControl"),l(e.audio,"noiseSuppression","mozNoiseSuppression")),u(e)},s&&s.prototype.getSettings){var p=s.prototype.getSettings;s.prototype.getSettings=function(){var e=p.apply(this,arguments);return l(e,"mozAutoGainControl","autoGainControl"),l(e,"mozNoiseSuppression","noiseSuppression"),e};}if(s&&s.prototype.applyConstraints){var S=s.prototype.applyConstraints;s.prototype.applyConstraints=function(e){return "audio"===this.kind&&"object"==typeof e&&(e=JSON.parse(JSON.stringify(e)),l(e,"autoGainControl","mozAutoGainControl"),l(e,"noiseSuppression","mozNoiseSuppression")),S.apply(this,[e])};}}n.getUserMedia=function(e,i,s){if(t.version<44)return a(e,i,s);r.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),n.mediaDevices.getUserMedia(e).then(i,s);};};},{"../utils":14}],13:[function(e,t,n){var r=e("../utils");t.exports={shimLocalStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),"getStreamById"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getStreamById=function(e){var t=null;return this._localStreams&&this._localStreams.forEach((function(n){n.id===e&&(t=n);})),this._remoteStreams&&this._remoteStreams.forEach((function(n){n.id===e&&(t=n);})),t}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),-1===this._localStreams.indexOf(e)&&this._localStreams.push(e);var n=this;e.getTracks().forEach((function(r){t.call(n,r,e);}));},e.RTCPeerConnection.prototype.addTrack=function(e,n){return n&&(this._localStreams?-1===this._localStreams.indexOf(n)&&this._localStreams.push(n):this._localStreams=[n]),t.call(this,e,n)};}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);var t=this._localStreams.indexOf(e);if(-1!==t){this._localStreams.splice(t,1);var n=this,r=e.getTracks();this.getSenders().forEach((function(e){-1!==r.indexOf(e.track)&&n.removeTrack(e);}));}});}},shimRemoteStreamsAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){this._onaddstream&&this.removeEventListener("addstream",this._onaddstream),this.addEventListener("addstream",this._onaddstream=e);}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var n=new Event("addstream");n.stream=t,e.dispatchEvent(n);}}));}),t.apply(e,arguments)};}},shimCallbacksAPI:function(e){if("object"==typeof e&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,n=t.createOffer,r=t.createAnswer,i=t.setLocalDescription,s=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){var r=arguments.length>=2?arguments[2]:e,i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var n=arguments.length>=2?arguments[2]:e,i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i};var a=function(e,t,n){var r=i.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r};t.setLocalDescription=a,a=function(e,t,n){var r=s.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.setRemoteDescription=a,a=function(e,t,n){var r=o.apply(this,[e]);return n?(r.then(t,n),Promise.resolve()):r},t.addIceCandidate=a;}},shimGetUserMedia:function(e){var t=e&&e.navigator;t.getUserMedia||(t.webkitGetUserMedia?t.getUserMedia=t.webkitGetUserMedia.bind(t):t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,n,r){t.mediaDevices.getUserMedia(e).then(n,r);}.bind(t)));},shimRTCIceServerUrls:function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,n){if(e&&e.iceServers){for(var i=[],s=0;s<e.iceServers.length;s++){var o=e.iceServers[s];!o.hasOwnProperty("urls")&&o.hasOwnProperty("url")?(r.deprecated("RTCIceServer.url","RTCIceServer.urls"),(o=JSON.parse(JSON.stringify(o))).urls=o.url,delete o.url,i.push(o)):i.push(e.iceServers[s]);}e.iceServers=i;}return new t(e,n)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}});},shimTrackEventTransceiver:function(e){"object"==typeof e&&e.RTCPeerConnection&&"receiver"in e.RTCTrackEvent.prototype&&!e.RTCTransceiver&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return {receiver:this.receiver}}});},shimCreateOfferLegacy:function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){var n=this;if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=n.getTransceivers().find((function(e){return e.sender.track&&"audio"===e.sender.track.kind}));!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveAudio||r||n.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var i=n.getTransceivers().find((function(e){return e.sender.track&&"video"===e.sender.track.kind}));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection("sendonly"):"recvonly"===i.direction&&i.setDirection("inactive"):!0!==e.offerToReceiveVideo||i||n.addTransceiver("video");}return t.apply(n,arguments)};}};},{"../utils":14}],14:[function(e,t,n){function r(e,t,n){var r=e.match(t);return r&&r.length>=n&&parseInt(r[n],10)}var i=!0;t.exports={extractVersion:r,wrapPeerConnectionEvent:function(e,t,n){if(e.RTCPeerConnection){var r=e.RTCPeerConnection.prototype,i=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return i.apply(this,arguments);var s=function(e){var t=n(e);t&&r(t);};return this._eventMap=this._eventMap||{},this._eventMap[r]=s,i.apply(this,[e,s])};var s=r.removeEventListener;r.removeEventListener=function(e,n){if(e!==t||!this._eventMap||!this._eventMap[n])return s.apply(this,arguments);var r=this._eventMap[n];return delete this._eventMap[n],s.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e);},enumerable:!0,configurable:!0});}},disableLog:function(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(i=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},disableWarnings:function(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):"adapter.js deprecation warnings "+(e?"disabled":"enabled")},log:function(){if("object"==typeof window){if(i)return;"undefined"!=typeof console&&console.log;}},deprecated:function(e,t){},detectBrowser:function(e){var t=e&&e.navigator,n={browser:null,version:null};if(void 0===e||!e.navigator)return n.browser="Not a browser.",n;if(t.mozGetUserMedia)n.browser="firefox",n.version=r(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia)n.browser="chrome",n.version=r(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))n.browser="edge",n.version=r(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return n.browser="Not a supported browser.",n;n.browser="safari",n.version=r(t.userAgent,/AppleWebKit\/(\d+)\./,1);}return n}};},{}]},{},[3])(3),navigator.mozGetUserMedia?(MediaStreamTrack.getSources=function(e){setTimeout((function(){e([{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}]);}),0);},attachMediaStream=function(e,t){return e.srcObject=t,e},reattachMediaStream=function(e,t){return e.srcObject=t.srcObject,e}):navigator.webkitGetUserMedia?(attachMediaStream=function(e,t){return i.webrtcDetectedVersion>=43?e.srcObject=t:void 0!==e.src&&(e.src=URL.createObjectURL(t)),e},reattachMediaStream=function(e,t){return i.webrtcDetectedVersion>=43?e.srcObject=t.srcObject:e.src=t.src,e}):"AppleWebKit"===i.webrtcDetectedType?(attachMediaStream=function(e,t){return e.srcObject=t,e},reattachMediaStream=function(e,t){return e.srcObject=t.srcObject,e},navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&(navigator.getUserMedia=getUserMedia=function(e,t,n){navigator.mediaDevices.getUserMedia(e).then(t).catch(n);})):navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)&&(attachMediaStream=function(e,t){return e.srcObject=t,e},reattachMediaStream=function(e,t){return e.srcObject=t.srcObject,e});var s=attachMediaStream;"opera"===i.webrtcDetectedBrowser&&(s=function(e,t){i.webrtcDetectedVersion>38?e.srcObject=t:void 0!==e.src&&(e.src=URL.createObjectURL(t));}),attachMediaStream=function(e,t){return "chrome"!==i.webrtcDetectedBrowser&&"opera"!==i.webrtcDetectedBrowser||t?s(e,t):e.src="",e};var o=reattachMediaStream;reattachMediaStream=function(e,t){return o(e,t),e},window.attachMediaStream=attachMediaStream,window.reattachMediaStream=reattachMediaStream,window.getUserMedia=function(e,t,n){navigator.getUserMedia(e,t,n);},i.attachMediaStream=attachMediaStream,i.reattachMediaStream=reattachMediaStream,i.getUserMedia=getUserMedia,"undefined"==typeof Promise&&(requestUserMedia=null),i.maybeThroughWebRTCReady();}else"object"==typeof console&&"function"==typeof console.log||(console={}||console,console.log=function(e){},console.info=function(e){},console.error=function(e){},console.dir=function(e){},console.exception=function(e){},console.trace=function(e){},console.warn=function(e){},console.count=function(e){},console.debug=function(e){},console.count=function(e){},console.time=function(e){},console.timeEnd=function(e){},console.group=function(e){},console.groupCollapsed=function(e){},console.groupEnd=function(e){}),i.WebRTCPlugin.WaitForPluginReady=function(){for(;i.WebRTCPlugin.pluginState!==i.WebRTCPlugin.PLUGIN_STATES.READY;);},i.WebRTCPlugin.callWhenPluginReady=function(e){if(i.WebRTCPlugin.pluginState===i.WebRTCPlugin.PLUGIN_STATES.READY)e();else var t=setInterval((function(){i.WebRTCPlugin.pluginState===i.WebRTCPlugin.PLUGIN_STATES.READY&&(clearInterval(t),e());}),100);},i.WebRTCPlugin.setLogLevel=function(e){i.WebRTCPlugin.callWhenPluginReady((function(){i.WebRTCPlugin.plugin.setLogLevel(e);}));},i.WebRTCPlugin.injectPlugin=function(){if(i.documentReady()&&i.WebRTCPlugin.pluginState===i.WebRTCPlugin.PLUGIN_STATES.INITIALIZING){i.WebRTCPlugin.pluginState=i.WebRTCPlugin.PLUGIN_STATES.INJECTING;var e=document.getElementById(i.WebRTCPlugin.pluginInfo.pluginId);if(e)if(i.WebRTCPlugin.plugin=e,i.WebRTCPlugin.pluginState=i.WebRTCPlugin.PLUGIN_STATES.INJECTED,i.WebRTCPlugin.plugin.valid)window[i.WebRTCPlugin.pluginInfo.onload]();else var t=setInterval((function(){i.WebRTCPlugin.plugin.valid&&(clearInterval(t),window[i.WebRTCPlugin.pluginInfo.onload]());}),100);else{if("IE"===i.webrtcDetectedBrowser&&i.webrtcDetectedVersion<=10){var n=document.createDocumentFragment();for(i.WebRTCPlugin.plugin=document.createElement("div"),i.WebRTCPlugin.plugin.innerHTML='<object id="'+i.WebRTCPlugin.pluginInfo.pluginId+'" type="'+i.WebRTCPlugin.pluginInfo.type+'" width="1" height="1"><param name="pluginId" value="'+i.WebRTCPlugin.pluginInfo.pluginId+'" /> <param name="windowless" value="false" /> <param name="pageId" value="'+i.WebRTCPlugin.pageId+'" /> <param name="onload" value="'+i.WebRTCPlugin.pluginInfo.onload+'" /><param name="tag" value="'+i.WebRTCPlugin.TAGS.NONE+'" />'+(i.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+"</object>";i.WebRTCPlugin.plugin.firstChild;)n.appendChild(i.WebRTCPlugin.plugin.firstChild);document.body.appendChild(n),i.WebRTCPlugin.plugin=document.getElementById(i.WebRTCPlugin.pluginInfo.pluginId);}else i.WebRTCPlugin.plugin=document.createElement("object"),i.WebRTCPlugin.plugin.id=i.WebRTCPlugin.pluginInfo.pluginId,"IE"===i.webrtcDetectedBrowser?(i.WebRTCPlugin.plugin.width="1px",i.WebRTCPlugin.plugin.height="1px"):(i.WebRTCPlugin.plugin.width="0px",i.WebRTCPlugin.plugin.height="0px"),i.WebRTCPlugin.plugin.type=i.WebRTCPlugin.pluginInfo.type,i.WebRTCPlugin.plugin.innerHTML='<param name="onload" value="'+i.WebRTCPlugin.pluginInfo.onload+'"><param name="pluginId" value="'+i.WebRTCPlugin.pluginInfo.pluginId+'"><param name="windowless" value="false" /> '+(i.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+'<param name="pageId" value="'+i.WebRTCPlugin.pageId+'"><param name="tag" value="'+i.WebRTCPlugin.TAGS.NONE+'" />',document.body.appendChild(i.WebRTCPlugin.plugin);i.WebRTCPlugin.pluginState=i.WebRTCPlugin.PLUGIN_STATES.INJECTED;}}},i.WebRTCPlugin.isPluginInstalled=function(e,t,n,r,s){if("IE"!==i.webrtcDetectedBrowser){var o=navigator.mimeTypes;if(void 0!==o){for(var a=0;a<o.length;a++)if(o[a].type.indexOf(n)>=0)return void r();s();}else i.renderNotificationBar(i.TEXT.PLUGIN.NOT_SUPPORTED);}else{try{new ActiveXObject(e+"."+t);}catch(e){return void s()}r();}},i.WebRTCPlugin.defineWebRTCInterface=function(){if(i.WebRTCPlugin.pluginState!==i.WebRTCPlugin.PLUGIN_STATES.READY){i.WebRTCPlugin.pluginState=i.WebRTCPlugin.PLUGIN_STATES.INITIALIZING,i.isDefined=function(e){return null!=e},RTCSessionDescription=function(e){return i.WebRTCPlugin.WaitForPluginReady(),i.WebRTCPlugin.plugin.ConstructSessionDescription(e.type,e.sdp)},MediaStream=function(e){return i.WebRTCPlugin.WaitForPluginReady(),i.WebRTCPlugin.plugin.MediaStream(e)},RTCPeerConnection=function(e,t){if(null!=e&&!Array.isArray(e.iceServers))throw new Error("Failed to construct 'RTCPeerConnection': Malformed RTCConfiguration");if(null!=t){var n=!1;if(n|="object"!=typeof t,n|=t.hasOwnProperty("mandatory")&&void 0!==t.mandatory&&null!==t.mandatory&&t.mandatory.constructor!==Object,n|=t.hasOwnProperty("optional")&&void 0!==t.optional&&null!==t.optional&&!Array.isArray(t.optional))throw new Error("Failed to construct 'RTCPeerConnection': Malformed constraints object")}i.WebRTCPlugin.WaitForPluginReady();var r=null;if(e&&Array.isArray(e.iceServers)){r=e.iceServers;for(var s=0;s<r.length;s++)r[s].urls&&!r[s].url&&(r[s].url=r[s].urls),r[s].hasCredentials=i.isDefined(r[s].username)&&i.isDefined(r[s].credential);}if(i.WebRTCPlugin.plugin.PEER_CONNECTION_VERSION&&i.WebRTCPlugin.plugin.PEER_CONNECTION_VERSION>1)return r&&(e.iceServers=r),i.WebRTCPlugin.plugin.PeerConnection(e);var o=t&&t.mandatory?t.mandatory:null,a=t&&t.optional?t.optional:null;return i.WebRTCPlugin.plugin.PeerConnection(i.WebRTCPlugin.pageId,r,o,a)};var e=function(){};e.getSources=function(e){i.WebRTCPlugin.callWhenPluginReady((function(){i.WebRTCPlugin.plugin.GetSources(e);}));};var t=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(n){if("require"!==n&&"advanced"!==n){if("string"==typeof e[n])return void(t[n]=e[n]);var r="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);var i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if("sourceId"===i("",n)&&void 0!==r.exact&&(r.ideal=r.exact,r.exact=void 0),void 0!==r.ideal){t.optional=t.optional||[];var s={};"number"==typeof r.ideal?(s[i("min",n)]=r.ideal,t.optional.push(s),(s={})[i("max",n)]=r.ideal,t.optional.push(s)):(s[i("",n)]=r.ideal,t.optional.push(s));}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",n)]=r.exact):["min","max"].forEach((function(e){void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,n)]=r[e]);}));}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t};getUserMedia=function(e,n,r){var s={};s.audio=!!e.audio&&t(e.audio),s.video=!!e.video&&t(e.video),i.WebRTCPlugin.callWhenPluginReady((function(){i.WebRTCPlugin.plugin.getUserMedia(s,n,r);}));},window.navigator.getUserMedia=getUserMedia,"undefined"!=typeof Promise&&(requestUserMedia=function(e){return new Promise((function(t,n){try{getUserMedia(e,t,n);}catch(e){n(e);}}))},void 0===navigator.mediaDevices&&(navigator.mediaDevices={}),navigator.mediaDevices.getUserMedia=requestUserMedia,navigator.mediaDevices.enumerateDevices=function(){return new Promise((function(t){var n={audio:"audioinput",video:"videoinput"};return e.getSources((function(e){t(e.map((function(e){return {label:e.label,kind:n[e.kind],id:e.id,deviceId:e.id,groupId:""}})));}))}))}),attachMediaStream=function(e,t){if(e&&e.parentNode){var n;null===t?n="":(void 0!==t.enableSoundTracks&&t.enableSoundTracks(!0),n=t.id);var r=0===e.id.length?Math.random().toString(36).slice(2):e.id,s=e.nodeName.toLowerCase();if("object"!==s){var o;switch(s){case"audio":o=i.WebRTCPlugin.TAGS.AUDIO;break;case"video":o=i.WebRTCPlugin.TAGS.VIDEO;break;default:o=i.WebRTCPlugin.TAGS.NONE;}var a=document.createDocumentFragment(),c=document.createElement("div"),d="";for(e.className?d='class="'+e.className+'" ':e.attributes&&e.attributes.class&&(d='class="'+e.attributes.class.value+'" '),c.innerHTML='<object id="'+r+'" '+d+'type="'+i.WebRTCPlugin.pluginInfo.type+'"><param name="pluginId" value="'+r+'" /> <param name="pageId" value="'+i.WebRTCPlugin.pageId+'" /> <param name="windowless" value="true" /> <param name="streamId" value="'+n+'" /> <param name="tag" value="'+o+'" /> </object>';c.firstChild;)a.appendChild(c.firstChild);var l="",u="";e.clientWidth||e.clientHeight?(u=e.clientWidth,l=e.clientHeight):(e.width||e.height)&&(u=e.width,l=e.height),e.parentNode.insertBefore(a,e),(a=document.getElementById(r)).width=u,a.height=l,e.parentNode.removeChild(e);}else{for(var p=e.children,S=0;S!==p.length;++S)if("streamId"===p[S].name){p[S].value=n;break}e.setStreamId(n);}var E=document.getElementById(r);return i.forwardEventHandlers(E,e,Object.getPrototypeOf(e)),E}},reattachMediaStream=function(e,t){for(var n=null,r=t.children,s=0;s!==r.length;++s)if("streamId"===r[s].name){i.WebRTCPlugin.WaitForPluginReady(),n=i.WebRTCPlugin.plugin.getStreamWithId(i.WebRTCPlugin.pageId,r[s].value);break}if(null!==n)return attachMediaStream(e,n)},window.attachMediaStream=attachMediaStream,window.reattachMediaStream=reattachMediaStream,window.getUserMedia=getUserMedia,i.attachMediaStream=attachMediaStream,i.reattachMediaStream=reattachMediaStream,i.getUserMedia=getUserMedia,i.forwardEventHandlers=function(e,t,n){var r=Object.getOwnPropertyNames(n);for(var s in r)if(s){var o=r[s];"function"==typeof o.slice&&"on"===o.slice(0,2)&&"function"==typeof t[o]&&i.addEvent(e,o.slice(2),t[o]);}var a=Object.getPrototypeOf(n);a&&i.forwardEventHandlers(e,t,a);},RTCIceCandidate=function(e){return e.sdpMid||(e.sdpMid=""),i.WebRTCPlugin.WaitForPluginReady(),i.WebRTCPlugin.plugin.ConstructIceCandidate(e.sdpMid,e.sdpMLineIndex,e.candidate)},i.addEvent(document,"readystatechange",i.WebRTCPlugin.injectPlugin),i.WebRTCPlugin.injectPlugin();}},i.WebRTCPlugin.pluginNeededButNotInstalledCb=i.WebRTCPlugin.pluginNeededButNotInstalledCb||function(){i.addEvent(document,"readystatechange",i.WebRTCPlugin.pluginNeededButNotInstalledCbPriv),i.WebRTCPlugin.pluginNeededButNotInstalledCbPriv();},i.WebRTCPlugin.pluginNeededButNotInstalledCbPriv=function(){if(i.documentReady()&&(document.removeEventListener("readystatechange",i.WebRTCPlugin.pluginNeededButNotInstalledCbPriv),!i.options.hidePluginInstallPrompt)){var e,t=i.WebRTCPlugin.pluginInfo.downloadLink;if(t)i.WebRTCPlugin.pluginInfo.companyName?(e="This website requires you to install the ",i.WebRTCPlugin.pluginInfo.portalLink?e+=' <a href="'+i.WebRTCPlugin.pluginInfo.portalLink+'" target="_blank">'+i.WebRTCPlugin.pluginInfo.companyName+" WebRTC Plugin</a>":e+=i.WebRTCPlugin.pluginInfo.companyName+" WebRTC Plugin",e+=" to work on this browser."):e=i.TEXT.PLUGIN.REQUIRE_INSTALLATION,i.renderNotificationBar(e,i.TEXT.PLUGIN.BUTTON,(function(){if(window.open(t,"_top"),"safari"===webrtcDetectedBrowser&&11==webrtcDetectedVersion)i.renderNotificationBar(i.TEXT.PLUGIN.REQUIRE_RESTART);else var e=setInterval((function(){"IE"!==i.webrtcDetectedBrowser&&navigator.plugins.refresh(!1),i.WebRTCPlugin.isPluginInstalled(i.WebRTCPlugin.pluginInfo.prefix,i.WebRTCPlugin.pluginInfo.plugName,i.WebRTCPlugin.pluginInfo.type,(function(){clearInterval(e),i.WebRTCPlugin.defineWebRTCInterface();}),(function(){}));}),500);}));else i.renderNotificationBar(i.TEXT.PLUGIN.NOT_SUPPORTED);}},i.WebRTCPlugin.isPluginInstalled(i.WebRTCPlugin.pluginInfo.prefix,i.WebRTCPlugin.pluginInfo.plugName,i.WebRTCPlugin.pluginInfo.type,i.WebRTCPlugin.defineWebRTCInterface,i.WebRTCPlugin.pluginNeededButNotInstalledCb);e.exports=i;}));i.AdapterJS;class s{constructor(e,t){this.name=e,this.detail=t;}}const o=(e={})=>new s("onIncomingStream",{detail:e}),a=(e={})=>new s("onIncomingScreenStream",{detail:e}),c=(e={})=>new s("streamEnded",{detail:e}),d=(e={})=>new s("streamMuted",{detail:e}),l=(e={})=>new s("dataChannelState",{detail:e}),u=(e={})=>new s("onIncomingMessage",{detail:e}),p=(e={})=>new s("storedMessages",{detail:e}),S=(e={})=>new s("encryptSecretsUpdated",{detail:e}),E=(e={})=>new s("persistentMessageState",{detail:e}),g=(e={})=>new s("handshakeProgress",{detail:e}),m=(e={})=>new s("readyStateChange",{detail:e}),f=e=>new s("candidateProcessingState",{detail:e}),h=e=>new s("candidateGenerationState",{detail:e}),R=e=>new s("iceConnectionState",{detail:e}),T=(e={})=>new s("peerUpdated",{detail:e}),C=(e={})=>new s("peerJoined",{detail:e}),I=(e={})=>new s("peerLeft",{detail:e}),_=(e={})=>new s("serverPeerLeft",{detail:e}),v=(e={})=>new s("getPeersStateChange",{detail:e}),O=(e={})=>new s("peerConnectionState",{detail:e}),A=(e={})=>new s("getConnectionStatusStateChange",{detail:e}),y=e=>new s("channelMessage",{detail:e}),D=e=>new s("socketError",{detail:e}),N=(e={})=>new s("mediaAccessFallback",{detail:e}),P=(e={})=>new s("rtmpState",{detail:e}),M=(e={})=>new s("mediaAccessError",{detail:e}),w=(e={})=>new s("mediaInfoDeleted",{detail:e}),b={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error",CREATE_ERROR:"createError",BUFFERED_AMOUNT_LOW:"bufferedAmountLow",SEND_MESSAGE_ERROR:"sendMessageError"},k={MESSAGING:"messaging",DATA:"data"},L={MESSAGE:"message",TRANSFER:"transfer"},U={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob",STRING:"string"},G="0.1.3",x={NEW:"new",GATHERING:"gathering",COMPLETED:"complete"},B={RECEIVED:"received",DROPPED:"dropped",BUFFERED:"buffered",PROCESSING:"processing",PROCESS_SUCCESS:"processSuccess",PROCESS_ERROR:"processError"},F={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",TRICKLE_FAILED:"trickleFailed",DISCONNECTED:"disconnected"},V={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},j={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed"},W={RETRIEVING:0,RETRIEVE_SUCCESS:1,RETRIEVE_ERROR:-1},H={MCU:"mcu"},K={MAX_COMPAT:"max-compat",BALANCED:"balanced",MAX_BUNDLE:"max-bundle",NONE:"none"},$={REQUIRE:"require",NEGOTIATE:"negotiate"},Y={RSA:"RSA",ECDSA:"ECDSA",AUTO:"AUTO"},z={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",ERROR:"error"},J={ENQUIRED:"enquired",DISPATCHED:"dispatched",RECEIVED:"received"},X={WARNING:"warning",REJECT:"reject",LOCKED:"locked"},q={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},Q={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,API_OVER_SEAT_LIMIT:4020,API_RETRIEVAL_FAILED:4021,API_WRONG_ACCESS_DOMAIN:5005,XML_HTTP_REQUEST_ERROR:-1,XML_HTTP_NO_REPONSE_ERROR:-2,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,ADAPTER_NO_LOADED:7,PARSE_CODECS:8},Z={ENFORCE_OFFERER:"enforceOfferer",ENFORCE_ANSWERER:"enforceAnswerer",AUTO:"auto"},ee={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},te={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},ne="2.1.0",re={AUTO:"auto",VP8:"VP8",H264:"H264",VP9:"VP9"},ie={AUTO:"auto",ISAC:"ISAC",OPUS:"opus",ILBC:"ILBC",G722:"G722",PCMU:"PCMU",PCMA:"PCMA"},se={QQVGA:{width:160,height:120},HQVGA:{width:240,height:160},QVGA:{width:320,height:240},WQVGA:{width:384,height:240},HVGA:{width:480,height:320},VGA:{width:640,height:480},WVGA:{width:768,height:480},FWVGA:{width:854,height:480},SVGA:{width:800,height:600},DVGA:{width:960,height:640},WSVGA:{width:1024,height:576},HD:{width:1280,height:720},HDPLUS:{width:1600,height:900},FHD:{width:1920,height:1080},QHD:{width:2560,height:1440},WQXGAPLUS:{width:3200,height:1800},UHD:{width:3840,height:2160},UHDPLUS:{width:5120,height:2880},FUHD:{width:7680,height:4320},QUHD:{width:15360,height:8640}},oe={FALLBACKING:0,FALLBACKED:1,ERROR:-1},ae={START:0,STOP:1,LINK:2,ERROR:-1},ce={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},de={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach",START_RECORDING:"startRecordingRoom",STOP_RECORDING:"stopRecordingRoom",RECORDING:"recordingEvent",END_OF_CANDIDATES:"endOfCandidates",START_SCREENSHARE:"startScreenshare",START_RTMP:"startRTMP",STOP_RTMP:"stopRTMP",RTMP:"rtmpEvent",MEDIA_INFO_EVENT:"mediaInfoEvent",MUTE_VIDEO_EVENT:"muteVideoEvent",MUTE_AUDIO_EVENT:"muteAudioEvent",MESSAGE:"message",GET_STORED_MESSAGES:"getStoredMessages",STORED_MESSAGES:"storedMessages"},le={ENDED:"ended",REPLACED_STREAM_ENDED:"replacedStreamEnded",SCREENSHARE_REPLACE_START:"screenshareStart",USER_MEDIA_REPLACE_START:"userMediaReplaceStart"},ue=[de.STREAM,de.UPDATE_USER,de.MUTE_AUDIO_EVENT,de.MUTE_VIDEO_EVENT,de.PUBLIC_MESSAGE],pe={PLAN_B:"plan-b",UNIFIED:"unified-plan"},Se={START:0,STOP:1,ERROR:-1},Ee={MUTED:0,ACTIVE:1,UNAVAILABLE:-1},ge={SKYLINK_EVENT:"SKYLINK EVENT",SKYLINK_ERROR:"SKYLINK ERROR",STATS_MODULE:"RTCStatsReport",SESSION_DESCRIPTION:"RTCSessionDescription",PEER_CONNECTION:"RTCPeerConnection",CANDIDATE_HANDLER:"RTCIceCandidate",DATA_CHANNEL:"RTCDataChannel",SIG_SERVER:"SIG SERVER",PEER_MEDIA:"PEER MEDIA",PEER_INFORMATION:"PEER INFORMATION",ROOM:"ROOM",RECORDING:"RECORDING",MEDIA_STREAM:"MEDIA STREAM",MESSAGING:"MESSAGING",ASYNC_MESSAGING:"ASYNC MESSAGING",ENCRYPTED_MESSAGING:"ENCRYPTED MESSAGING"},me={AUDIO_MIC:"audioMic",VIDEO_CAMERA:"videoCamera",VIDEO_SCREEN:"videoScreen",VIDEO_OTHER:"videoOther",AUDIO:"audio",VIDEO:"video"},fe={LIVE:"live",ENDED:"ended"},he={AUDIO:"audio",VIDEO:"video"},Re={MUTED:"muted",ACTIVE:"active",STOPPED:"stopped",UNAVAILABLE:"unavailable"},Te={PUBLISHER_ID:"publisherId",MEDIA_ID:"mediaId",MEDIA_TYPE:"mediaType",MEDIA_STATE:"mediaState",TRANSCEIVER_MID:"transceiverMid",MEDIA_META_DATA:"mediaMetaData",SIMULCAST:"simulcast",STREAM_ID:"streamId"},Ce={WEB:"Web SDK",ANDROID:"Android SDK",IOS:"iOS SDK",CPP:"C++ SDK"},Ie={CHROME:"chrome",FIREFOX:"firefox",SAFARI:"safari",REACT_NATIVE:"react-native"},_e={MCU:"MCU"},ve={CONNECT:"connect",DISCONNECT:"disconnect",RECONNECT_ATTEMPT:"reconnect_attempt",RECONNECT_SUCCESS:"reconnect_success",RECONNECT_FAILED:"reconnect_failed",RECONNECT_ERROR:"reconnect_error",MESSAGE:"message",ERROR:"error"},Oe={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"},Ae={SIGNALING:ve},ye=Object.freeze({ON_INCOMING_STREAM:"onIncomingStream",ON_INCOMING_SCREEN_STREAM:"onIncomingScreenStream",STREAM_ENDED:"streamEnded",PEER_UPDATED:"peerUpdated",PEER_JOINED:"peerJoined",PEER_LEFT:"peerLeft",PEER_CONNECTION_STATE:"peerConnectionState",DATA_CHANNEL_STATE:"dataChannelState",ON_INCOMING_MESSAGE:"onIncomingMessage",HANDSHAKE_PROGRESS:"handshakeProgress",SERVER_PEER_JOINED:"serverPeerJoined",SERVER_PEER_LEFT:"serverPeerLeft",CANDIDATE_PROCESSING_STATE:"candidateProcessingState",CANDIDATE_GENERATION_STATE:"candidateGenerationState",CANDIDATES_GATHERED:"candidatesGathered",DATA_STREAM_STATE:"dataStreamState",DATA_TRANSFER_STATE:"dataTransferState",ON_INCOMING_DATA:"onIncomingData",ON_INCOMING_DATA_REQUEST:"onIncomingDataRequest",ON_INCOMING_DATA_STREAM:"onIncomingDataStream",ON_INCOMING_DATA_STREAM_STARTED:"onIncomingDataStreamStarted",ON_INCOMING_DATA_STREAM_STOPPED:"onIncomingDataStreamStopped",GET_PEERS_STATE_CHANGE:"getPeersStateChange",SESSION_DISCONNECT:"sessionDisconnect",STREAM_MUTED:"streamMuted",CHANNEL_OPEN:"channelOpen",CHANNEL_REOPEN:"channelReopen",CHANNEL_CLOSE:"channelClose",CHANNEL_MESSAGE:"channelMessage",CHANNEL_ERROR:"channelError",CHANNEL_RETRY:"channelRetry",SOCKET_ERROR:"socketError",SYSTEM_ACTION:"systemAction",MEDIA_ACCESS_FALLBACK:"mediaAccessFallback",MEDIA_ACCESS_REQUIRED:"mediaAccessRequired",MEDIA_ACCESS_STOPPED:"mediaAccessStopped",MEDIA_ACCESS_SUCCESS:"mediaAccessSuccess",RECORDING_STATE:"recordingState",LOCAL_MEDIA_MUTED:"localMediaMuted",MEDIA_ACCESS_ERROR:"mediaAccessError",GET_CONNECTION_STATUS_STATE_CHANGE:"getConnectionStatusStateChange",READY_STATE_CHANGE:"readyStateChange",ROOM_LOCK:"roomLock",INTRODUCE_STATE_CHANGE:"introduceStateChange",ICE_CONNECTION_STATE:"iceConnectionState",BYE:"bye",RTMP_STATE:"rtmpState",LOGGED_ON_CONSOLE:"loggedOnConsole",MEDIA_INFO_DELETED:"mediaInfoDeleted",STORED_MESSAGES:"storedMessages",ENCRYPT_SECRETS_UPDATED:"encryptSecretsUpdated",PERSISTENT_MESSAGE_STATE:"persistentMessageState"});var De=Object.freeze({DATA_CHANNEL_STATE:b,DATA_CHANNEL_TYPE:k,DATA_CHANNEL_MESSAGE_ERROR:L,DATA_TRANSFER_DATA_TYPE:U,DT_PROTOCOL_VERSION:G,DATA_TRANSFER_TYPE:{UPLOAD:"upload",DOWNLOAD:"download"},DATA_TRANSFER_SESSION_TYPE:{BLOB:"blob",DATA_URL:"dataURL"},DATA_TRANSFER_STATE:{UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted",USER_REJECTED:"userRejected",USER_UPLOAD_REQUEST:"userRequest",START_ERROR:"startError"},DATA_STREAM_STATE:{SENDING_STARTED:"sendStart",SENDING_STOPPED:"sendStop",RECEIVING_STARTED:"receiveStart",RECEIVING_STOPPED:"receiveStop",RECEIVED:"received",SENT:"sent",ERROR:"error",START_ERROR:"startError"},CANDIDATE_GENERATION_STATE:x,CANDIDATE_PROCESSING_STATE:B,ICE_CONNECTION_STATE:F,TURN_TRANSPORT:V,PEER_CONNECTION_STATE:j,GET_CONNECTION_STATUS_STATE:W,SERVER_PEER_TYPE:H,BUNDLE_POLICY:K,RTCP_MUX_POLICY:$,PEER_CERTIFICATE:Y,HANDSHAKE_PROGRESS:z,GET_PEERS_STATE:J,INTRODUCE_STATE:{INTRODUCING:"introducing",ERROR:"error"},SYSTEM_ACTION:X,SYSTEM_ACTION_REASON:{CREDENTIALS_EXPIRED:"oldTimeStamp",CREDENTIALS_ERROR:"credentialError",DUPLICATED_LOGIN:"duplicatedLogin",ROOM_NOT_STARTED:"notStart",EXPIRED:"expired",ROOM_LOCKED:"locked",FAST_MESSAGE:"fastmsg",ROOM_CLOSING:"toclose",ROOM_CLOSED:"roomclose",SERVER_ERROR:"serverError",KEY_ERROR:"keyFailed"},READY_STATE_CHANGE:q,READY_STATE_CHANGE_ERROR:Q,REGIONAL_SERVER:{APAC1:"",US1:""},PRIORITY_WEIGHT_SCHEME:Z,LOG_LEVEL:{DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0,NONE:-1},SOCKET_ERROR:ee,SOCKET_FALLBACK:te,SM_PROTOCOL_VERSION:ne,VIDEO_CODEC:re,AUDIO_CODEC:ie,MEDIA_SOURCE:{SCREEN:"screen",WINDOW:"window",TAB:"tab",TAB_AUDIO:"audio",APPLICATION:"application",BROWSER:"browser",CAMERA:"camera"},VIDEO_RESOLUTION:se,MEDIA_ACCESS_FALLBACK_STATE:oe,RECORDING_STATE:ae,CHUNK_FILE_SIZE:49152,MOZ_CHUNK_FILE_SIZE:12288,BINARY_FILE_SIZE:65456,MOZ_BINARY_FILE_SIZE:16384,CHUNK_DATAURL_SIZE:1212,DC_PROTOCOL_TYPE:ce,SIG_MESSAGE_TYPE:de,STREAM_STATUS:le,GROUP_MESSAGE_LIST:ue,VIDEO_QUALITY:{HD:{video:3200,audio:150},HQ:{video:1200,audio:80},SQ:{video:800,audio:30},LQ:{video:400,audio:20}},SDP_SEMANTICS:pe,RTMP_STATE:Se,MEDIA_STATUS:Ee,TAGS:ge,MEDIA_TYPE:me,TRACK_READY_STATE:fe,TRACK_KIND:he,MEDIA_STATE:Re,MEDIA_INFO:Te,SDK_VERSION:"2.0.0",SDK_NAME:Ce,API_VERSION:"9.0.0",SIGNALING_VERSION:"sig-v2",BROWSER_AGENT:Ie,PEER_TYPE:_e,SOCKET_EVENTS:ve,SOCKET_TYPE:Oe,STATES:Ae,EVENTS:ye});const Ne={INIT:{ERRORS:{NO_ADAPTER:"AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used",NO_SOCKET_IO:"Socket.io not loaded - Please load socket.io",NO_FETCH_SUPPORT:"Fetch API is not supported in your browser. Please make sure you are using a modern browser: https://caniuse.com/#search=fetch",NO_APP_KEY:"Please provide an App Key - Get one at console.temasys.io!",AUTH_CORS:"Promise rejected due to CORS forbidden request - Please visit: http://support.temasys.com.sg/support/solutions/articles/12000006761-i-get-a-403-forbidden-access-is-denied-when-i-load-the-application-why-",AUTH_GENERAL:"Promise rejected due to network issue",SOCKET_CREATE_FAILED:"Failed creating socket connection object ->",SOCKET_ERROR_ABORT:"Reconnection aborted as the connection timed out or there no more available ports, transports and final attempts left"},INFO:{API_SUCCESS:"Promise resolved: APP Authenticated Successfully!"}},JOIN_ROOM:{ERRORS:{CODEC_SUPPORT:"No audio/video codecs available to start connection"}},ROOM:{ERRORS:{STOP:{SCREEN_SHARE:"Error stopping screenshare"},NOT_IN_ROOM:"User is not in room",NO_PEERS:"No peers in room"},LEAVE_ROOM:{ERROR:"Leave room error --\x3e",NO_PEERS:"No peers in room",DROPPING_HANGUP:"Dropping hang-up from remote peer",LEAVE_ALL_ROOMS:{SUCCESS:"Successfully left all rooms",ERROR:"Leave all rooms error --\x3e"},PEER_LEFT:{START:"Initiating peer left process",SUCCESS:"Successfully completed peer left process",ERROR:"Failed peer left process"},SENDING_BYE:"Sending bye message to all peers",DISCONNECT_SOCKET:{SUCCESS:"Successfully disconnected socket"},REMOVE_STATE:{SUCCESS:"Successfully removed room state"}}},ROOM_STATE:{NOT_FOUND:"Could not retrieve room state for room name/key",LEFT:"Peer left room",NO_ROOM_NAME:"No room name specified"},PEER_INFORMATIONS:{NO_PEER_INFO:"Not able to retrieve Peer Information for peerId:",UPDATE_USER_DATA:"Peer updated userData: ",OUTDATED_MSG:"Dropping outdated status ->",USER_DATA_NOT_JSON:"UserData is not JSON"},PEER_CONNECTION:{NO_PEER_CONNECTION:"No Peer Connection detected",ERRORS:{REMOVE_TRACK:"Error removing track from peer connection",REPLACE_TRACK:"Error replacing track in peer connection",REFRESH:"Error refreshing peer connection"},end_of_candidates:"Signaling of end-of-candidates remote ICE gathering",end_of_candidate_failure:"Failed signaling end-of-candidates ->",not_initialised:"Peer connection is not initialised",getstats_api_not_available:"getStats() API is not available",connection_status_no_pc:"There is currently no peer connections to retrieve connection status",ice_connection_state:"Ice connection state changed ->",peer_connection_state:"Peer connection state changed ->",ice_gathering_state:"Ice gathering state changed ->",refresh_start:"START: Refreshing peer connections",refresh_failed:"FAILED: Refreshing peer connections",refresh_completed:"All peer connections refreshed with resolve or errors",refresh_peer_failed:"Peer connection failed to refresh: ",refresh_peer_success:"Peer connection refreshed successfully: ",refresh_no_peer_connection:"There is currently no peer connections to restart",refresh_peerId_no_match:"PeerId does not match existing peer connections",refresh_no_edge_support:"Edge browser currently does not support renegotiation",refresh_not_supported:"Failed restarting with other agents connecting from other SDKs as re-negotiation is not supported by other SDKs",peerId_does_not_exist:"Peer Id does not exist ->"},PEER_PRIVILEGED:{not_privileged:"Please upgrade your key to privileged to use this function",no_appkey:"App key is not defined - Please authenticate again",getPeerListFromServer:"Enquired server for peers within the App space"},ICE_CANDIDATE:{CANDIDATE_HANDLER:{DROPPING_CANDIDATE:"Dropping ICE candidate",INVALID_CANDIDATE:"Received invalid ICE candidate message ->",VALID_CANDIDATE:"Received ICE candidate ->",FILTERED_CANDIDATE:"Dropping received ICE candidate as it matches ICE candidate filtering flag ->",FILTERING_FLAG_NOT_HONOURED:"Not dropping received ICE candidate as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->",CANDIDATE_ADDED:"Added ICE candidate successfully",ADDING_CANDIDATE:"Adding ICE Candidate",FAILED_ADDING_CANDIDATE:"Failed adding ICE candidate ->",ADD_BUFFERED_CANDIDATE:"Adding buffered ICE candidate",ADD_CANDIDATE_TO_BUFFER:"Adding ICE candidate to buffer",END_OF_CANDIDATES_SUCCESS:"Signaling of end-of-candidates remote ICE gathering",END_OF_CANDIDATES_FAILURE:"Failed signaling of end-of-candidates remote ICE gathering",ICE_GATHERING_STARTED:"ICE gathering has started",ICE_GATHERING_COMPLETED:"ICE gathering has completed",CANDIDATE_GENERATED:"Generated ICE candidate ->",DROP_EOC:"Dropping of sending ICE candidate end-of-candidates signal or unused ICE candidates to prevent errors ->",ICE_TRICKLE_DISABLED:"Dropping of sending ICE candidate as trickle ICE is disabled ->",SENDING_CANDIDATE:"Sending ICE candidate ->",NO_SDP:"Not sending any session description after ICE gathering completed as it is not present"}},SESSION_DESCRIPTION:{parsing_media_ssrc:"Parsing session description media SSRCs ->"},DATA_CHANNEL:{reviving_dataChannel:"Reviving Datachannel connection",refresh_error:"Not a valid Datachannel connection",CLOSING:"Closing DataChannel",closed:"Datachannel has closed",onclose_error:"Error in data-channel onclose callback",NO_REMOTE_DATA_CHANNEL:"Remote peer does not have data channel",ERRORS:{FAILED_CLOSING:"Failed closing DataChannels --\x3e ",NO_SESSIONS:"Peer Connection does not have DataChannel sessions"}},NEGOTIATION_PROGRESS:{SET_LOCAL_DESCRIPTION:"Successfully set local description --\x3e",SET_REMOTE_DESCRIPTION:"Successfully set remote description --\x3e",APPLYING_BUFFERED_REMOTE_OFFER:"Applying buffered remote offer",ERRORS:{FAILED_SET_LOCAL_DESCRIPTION:"Failed setting local description --\x3e",FAILED_SET_REMOTE_DESCRIPTION:"Failed setting remote description --\x3e",FAILED_SET_REMOTE_ANSWER:"Peer failed to set remote answer.",FAILED_RENEGOTIATION:"Failed renegotiation after answerAck",NOT_STABLE:"Dropping of message as signaling state is not stable",PROCESSING_EXISTING_SDP:"Dropping message as there is another sessionDescription being processed --\x3e",OFFER_TIEBREAKER:"Dropping the received offer: self weight is greater than incoming offer weight --\x3e",NO_LOCAL_BUFFERED_OFFER:"FATAL: No buffered local offer found - Unable to setLocalDescription",ADDING_REMOTE_OFFER_TO_BUFFER:"Adding remote offer received to buffer as current negotiation has not completed"}},SIGNALING:{MESSAGE_ADDED_TO_BUFFER:"Message buffered as enter message has not been sent",ENTER_LISTENER:"Enter listener initialized",BUFFERED_MESSAGES_SENT:"Buffered messages sent",BUFFERED_MESSAGES_DROPPED:"Buffered messages dropped - no mid",OUTDATED_MSG:"Dropping outdated status ->",DROPPING_MUTE_EVENT:"Dropping mute audio / video event message as it is processed by mediaInfoEvent",BUFFER_NOT_NEEDED:"Enter message sent. Messages do not need to be buffered",ABORTING_OFFER:"Aborting offer as current negotiation has not completed"},MESSAGING:{PRIVATE_MESSAGE:"Sending private message to Peer",BROADCAST_MESSAGE:"Broadcasting message to Peers",RECEIVED_MESSAGE:"Received message from Peer",PERSISTENCE:{SEND_MESSAGE:"Sending persisted message",NOT_PERSISTED:"Message will not be persisted as persistent flag is set to false",STORED_MESSAGES:"Received stored messages for room",IS_PERSISTENT_CONFIG:"Persistent message flag is set to",ERRORS:{FAILED_SETTING_PERSISTENCE:"Failed setting persistent message flag",INVALID_TYPE:"Persistent message flag must be of type boolean",PRIVATE_MESSAGE:"Cannot persist private messages",PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED:"Persistent Message feature is not enabled. Enable this feature on the key under 'Advanced Settings' in the Temasys Console"}},ENCRYPTION:{SEND_MESSAGE:"Sending encrypted message",DELETE_ALL:"Deleting all stored secrets",ERRORS:{FAILED_DECRYPTING_MESSAGE:"Failed decrypting message",ENCRYPT_SECRET:"Incorrect secret provided",INVALID_SECRETS:"No or invalid secret and secret id provided",SET_SELECTED_SECRET:"Failed setting selected secret",DELETE_ENCRYPT_SECRETS:"Failed deleting secret",SET_ENCRYPT_SECRET:"Failed setting secret",SECRET_ID_NOT_FOUND:"Secret id not found",NO_SECRET_OR_SECRET_ID:"Secret and / or secret id not provided",INVALID_TYPE:"Secret and secret id must be of type string and not empty",SECRET_ID_NOT_UNIQUE:"Secret id provided is not unique",SECRET_ID_NOT_SELECTED:"Secret id not selected",SECRET_ID_NOT_PROVIDED:"Secret id not provided",SECRETS_NOT_PROVIDED:"Secrets not provided"}},ERRORS:{DROPPING_MESSAGE:"Dropping message",FAILED_SENDING_MESSAGE:"Failed to send user message"}},MEDIA_INFO:{UPDATE_SUCCESS:"Successfully updated media info",ERRORS:{NO_ASSOCIATED_STREAM_ID:"There is no streamId associated with the mediaId and transceiverMid pair",FAILED_PROCESSING_MEDIA_INFO_EVENT:"Failed to process mediaInfoEvent message",FAILED_UPDATING:"Failed to update media info",FAILED_PROCESSING_PEER_MEDIA:"Failed to process media info",FAILED_UPDATING_TRANSCEIVER_MID:"Failed updating media info transceiverMid after setLocalDescription",FAILED_SETTING_PEER_MEDIA_INFO:"Failed setting peer media at offer / answer"},WARN:{READ_ONLY_VALUE:"Attempting to change media info read only value: ",INVALID_MEDIA_TYPE:"Invalid media info media type: "},VIDEO_STATE_CHANGE:"Peers's video state changed to ->",AUDIO_STATE_CHANGE:"Peers's audio state changed to ->",VIDEO_SCREEN_STATE_CHANGE:"Peers's video screen state changed to ->"},MEDIA_STREAM:{STOP_SETTINGS:"Stopped streams with settings:",STOP_SUCCESS:"Successfully stopped and removed stream from state",REMOTE_TRACK_REMOVED:"Remote MediaStreamTrack removed",START_FALLBACK:"Fall back to retrieve audio only stream",NO_OPTIONS:"No user media options provided",DEFAULT_OPTIONS:"Using default options",FALLBACK_SUCCESS:"Successfully retrieved audio fallback stream",START_SCREEN_SUCCESS:"Successfully retrieved screen share stream",STOP_SCREEN_SUCCESS:"Successfully stopped screen share stream",UPDATE_MUTED_SETTINGS:"Updated stream muted setting",UPDATE_MEDIA_STATUS:"Updated stream media status",AUDIO_MUTED:"Peers's audio muted: ",VIDEO_MUTED:"Peers's video muted: ",ERRORS:{STOP_SCREEN:"Error stopping screen share stream",START_SCREEN:"Error starting screen share stream",STOP_ADDED_STREAM:"Error stopping added stream",STOP_REPLACED_STREAM:"Error stopping replaced stream",STOP_USER_MEDIA:"Error stopping user media",STOP_AUDIO_TRACK:"Error stopping audio tracks in stream",STOP_VIDEO_TRACK:"Error stopping video tracks in stream",STOP_MEDIA_TRACK:"Error stopping MediaTrack",STOP_SCREEN_TRACK:"Error stopping screen track in stream",DROPPING_ONREMOVETRACK:"Dropping onremovetrack",NO_STREAM:"No stream to process",INVALID_STREAM_ID:"No stream detected with stream id",NO_USER_MEDIA_STREAMS:"No user media streams detected",INVALID_STREAM_ID_TYPE:"Stream id is not a string",NO_STREAM_ID:"No stream id provided",PEER_SCREEN_ACTIVE:"Peer has existing screen share",REPLACE_SCREEN:"Error replacing user media stream with screenshare stream",FALLBACK:"Error retrieving fallback audio stream",INVALID_GUM_OPTIONS:"Invalid user media options",GET_USER_MEDIA:"Error retrieving stream from 'getUserMedia' method",INVALID_MUTE_OPTIONS:"Invalid muteStreams options provided",NO_STREAMS_MUTED:"No streams to mute",SEND_STREAM:"Error sending stream",INVALID_MEDIA_STREAM_ARRAY:"Array is not of type MediaStream",ACTIVE_STREAMS:"There are currently active streams being sent to remote peers. Please stop streams."}},STATS_MODULE:{NOT_INITIATED:"Stats Module is not initiated",STATS_DISCARDED:"Stats report discarded as peer has left the room",ERRORS:{RETRIEVE_STATS_FAILED:"Failed retrieving stats",POST_FAILED:"Failed posting to stats api",PARSE_FAILED:"Failed parsing stats report",STATS_IS_NULL:"Stats object is null",INVALID_TRACK_KIND:"Media kind is not audio or video"},HANDLE_ICE_GATHERING_STATS:{PROCESS_FAILED:"process_failed",PROCESS_SUCCESS:"process_success",PROCESSING:"processing",DROPPED:"dropped",BUFFERED:"buffered"},HANDLE_NEGOTIATION_STATS:{OFFER:{create:"create_offer",create_error:"error_create_offer",set:"set_offer",set_error:"error_set_offer",offer:"offer",dropped:"dropped_offer"},ANSWER:{create:"create_answer",create_error:"error_create_answer",set:"set_answer",set_error:"error_set_ANSWER",answer:"answer",dropped:"dropped_answer"}},HANDLE_DATA_CHANNEL_STATS:{open:"open",closed:"closed",reconnecting:"reconnecting"},HANDLE_CONNECTION_STATS:{},HANDLE_BANDWIDTH_STATS:{RETRIEVE_FAILED:"Failed posting bandwidth stats: ",NO_STATE:"No room state"},HANDLE_ICE_CONNECTION_STATS:{RETRIEVE_FAILED:"Failed retrieving stats: ",SEND_FAILED:"Failed sending ice connection stats: "},HANDLE_RECORDING_STATS:{START:"start",STOP:"stop",REQUEST_START:"request-start",REQUEST_STOP:"request-stop",ERROR_NO_MCU_START:"error-no-mcu-start",ERROR_NO_MCU_STOP:"error-no-mcu-stop",ERROR_START_ACTIVE:"error-start-when-active",ERROR_STOP_ACTIVE:"error-stop-when-active",ERROR_MIN_STOP:"error-min-stop",MCU_RECORDING_ERROR:"mcu-recording-error"}},RECORDING:{START_SUCCESS:"Started recording",STOP_SUCCESS:"Stopped recording",START_FAILED:"Failed to start recording",STOP_FAILED:"Failed to stop recording",MIN_RECORDING_TIME_REACHED:"4 seconds has been recorded - Recording can be stopped now",ERRORS:{MCU_NOT_CONNECTED:"MCU is not connected",EXISTING_RECORDING_IN_PROGRESS:"There is an existing recording in-progress",NO_RECORDING_IN_PROGRESS:"There is no existing recording in-progress",MIN_RECORDING_TIME:"4 seconds has not been recorded yet",STOP_ABRUPT:"Recording stopped abruptly before 4 seconds",SESSION_EMPTY:'Received request of "off" but the session is empty',MCU_RECORDING_ERROR:"Recording error received from MCU"}},RTMP:{start_no_mcu:"Unable to start RTMP session as MCU is not connected",stop_no_mcu:"Unable to stop RTMP as MCU is not connected",start_no_stream_id:"Unable to start RTMP Session stream id is missing",start_no_endpoint:"Unable to start RTMP Session as Endpoint is missing",starting_rtmp:"Starting RTMP Session",stopping_rtmp:"Stopping RTMP Session",message_received_from_sig:"Received RTMP Session message ->",stop_session_empty:'Received request of "off" but the session is empty',stopped_success:"Stopped RTMP Session",started_success:"Started RTMP Session",error_session_empty:"Received error but the session is empty ->",error_session:"RTMP session failure ->",error_Session_abrupt:"Stopped RTMP session abruptly"},PERSISTENT_MESSAGE:{ERRORS:{NO_DEPENDENCY:"CryptoJS is not available"}},UTILS:{INVALID_BROWSER_AGENT:"Invalid browser agent"},LOGGER:{EVENT_DISPATCHED:"Event dispatched",EVENT_REGISTERED:"Event successfully registered",EVENT_UNREGISTERED:"Event successfully unregistered",EVENT_DISPATCH_ERROR:"Error dispatching event",EVENT_REGISTER_ERROR:"Error registering event",EVENT_UNREGISTER_ERROR:"Error unregistering event",LOGS_NOT_STORED:"Store logs feature is not enabled. Enable it via SkylinkLogger.setLevel(logLevel, storeLogs)",LOGS_CLEARED:"Stored logs cleared",INVALID_CB:"Dropping listener as it is not a function"},BROWSER_AGENT:{REACT_NATIVE:{ERRORS:{DROPPING_ONREMOVETRACK:"Dropping onremovetrack as trackInfo is malformed"}}}};var Pe=r((function(e){var t=function(){function e(e,t){return null!=t&&e instanceof t}var t,n,r;try{t=Map;}catch(e){t=function(){};}try{n=Set;}catch(e){n=function(){};}try{r=Promise;}catch(e){r=function(){};}function i(s,a,c,d,l){"object"==typeof a&&(c=a.depth,d=a.prototype,l=a.includeNonEnumerable,a=a.circular);var u=[],p=[],S="undefined"!=typeof Buffer;return void 0===a&&(a=!0),void 0===c&&(c=1/0),function s(c,E){if(null===c)return null;if(0===E)return c;var g,m;if("object"!=typeof c)return c;if(e(c,t))g=new t;else if(e(c,n))g=new n;else if(e(c,r))g=new r((function(e,t){c.then((function(t){e(s(t,E-1));}),(function(e){t(s(e,E-1));}));}));else if(i.__isArray(c))g=[];else if(i.__isRegExp(c))g=new RegExp(c.source,o(c)),c.lastIndex&&(g.lastIndex=c.lastIndex);else if(i.__isDate(c))g=new Date(c.getTime());else{if(S&&Buffer.isBuffer(c))return g=Buffer.allocUnsafe?Buffer.allocUnsafe(c.length):new Buffer(c.length),c.copy(g),g;e(c,Error)?g=Object.create(c):void 0===d?(m=Object.getPrototypeOf(c),g=Object.create(m)):(g=Object.create(d),m=d);}if(a){var f=u.indexOf(c);if(-1!=f)return p[f];u.push(c),p.push(g);}for(var h in e(c,t)&&c.forEach((function(e,t){var n=s(t,E-1),r=s(e,E-1);g.set(n,r);})),e(c,n)&&c.forEach((function(e){var t=s(e,E-1);g.add(t);})),c){var R;m&&(R=Object.getOwnPropertyDescriptor(m,h)),R&&null==R.set||(g[h]=s(c[h],E-1));}if(Object.getOwnPropertySymbols){var T=Object.getOwnPropertySymbols(c);for(h=0;h<T.length;h++){var C=T[h];(!(_=Object.getOwnPropertyDescriptor(c,C))||_.enumerable||l)&&(g[C]=s(c[C],E-1),_.enumerable||Object.defineProperty(g,C,{enumerable:!1}));}}if(l){var I=Object.getOwnPropertyNames(c);for(h=0;h<I.length;h++){var _,v=I[h];(_=Object.getOwnPropertyDescriptor(c,v))&&_.enumerable||(g[v]=s(c[v],E-1),Object.defineProperty(g,v,{enumerable:!1}));}}return g}(s,c)}function s(e){return Object.prototype.toString.call(e)}function o(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return i.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},i.__objToStr=s,i.__isDate=function(e){return "object"==typeof e&&"[object Date]"===s(e)},i.__isArray=function(e){return "object"==typeof e&&"[object Array]"===s(e)},i.__isRegExp=function(e){return "object"==typeof e&&"[object RegExp]"===s(e)},i.__getRegExpFlags=o,i}();e.exports&&(e.exports=t);}));const Me=(e,t)=>e.id===t.id,we={RECONNECTION_ATTEMPTS:{WEBSOCKET:5,POLLING:4},RECONNECTION_DELAY_MAX:5e3,RECONNECTION_DELAY:1e3,RECONNECTION_FINAL_ATTEMPTS:10},be={SOCKET:e=>({forceNew:!0,reconnection:!0,timeout:e.socketTimeout,path:e.socketServerPath,reconnectionAttempts:we.RECONNECTION_ATTEMPTS.WEBSOCKET,reconnectionDelayMax:we.RECONNECTION_DELAY_MAX,reconnectionDelay:we.RECONNECTION_DELAY,transports:[Oe.WEBSOCKET.toLowerCase()],query:{Skylink_SDK_type:Ce.WEB,Skylink_SDK_version:"2.0.0",Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"},extraHeaders:{Skylink_SDK_type:Ce.WEB,Skylink_SDK_version:"2.0.0",Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"}})},ke=we,Le=e=>{const t=Hi.getSkylinkState(e.roomKey),n=Hi.getInitOptions(),{config:r}=e,{socketServer:i,socketTimeout:s,socketServerPath:o}=n,{socketPorts:a}=t,c=((e,t)=>be[e](t))("SOCKET",{socketTimeout:s,socketServerPath:o});let d=[];i&&dr(i)&&Array.isArray(i.ports)&&i.ports.length?({ports:d}=i):d=a[r.signalingServerProtocol],(e=>!e.signalingServerPort)(r)?(r.signalingServerPort=d[0],r.fallbackType=te.NON_FALLBACK):((e,t)=>e.indexOf(t.signalingServerPort)===e.length-1)(d,r)||Er(n.socketServer)?r.socketType===Oe.WEBSOCKET?(r.socketType=Oe.POLLING,r.signalingServerPort=d[0]):(r.socketSession.finalAttempts+=1,r.signalingServerPort=d[0]):r.signalingServerPort=d[d.indexOf(r.signalingServerPort)+1],r.socketType===Oe.POLLING&&(c.reconnectionDelayMax=ke.RECONNECTION_DELAY_MAX,c.reconnectionAttempts=ke.RECONNECTION_ATTEMPTS.POLLING,c.transports=[Oe.XHR_POLLING,Oe.JSONP_POLLING,Oe.POLLING.toLowerCase()]);const l=(e=>{const{signalingServerProtocol:t,signalingServer:n,signalingServerPort:r,socketServer:i}=e;let s="";return s=Er(n)?`${t}//${n}`:n&&dr(n)&&n.protocol?`${n.protocol}//${i.url}:${r}?rand=${Date.now()}`:`${t}//${n}:${r}?rand=${Date.now()}`})({signalingServerProtocol:r.signalingServerProtocol,signalingServer:t.socketServer,signalingServerPort:r.signalingServerPort,socketServer:i});return r.socketServer=i,r.socketServerPath=o,t.socketSession=r,Hi.setSkylinkState(t,e.roomKey),window.io(l,c)},Ue=e=>{const t=He.getCurrentSessionInfo(e);return delete t.room,t},Ge=(e,t)=>{const{streams:n}=e;return !!n.userMedia&&Object.values(n.userMedia).some(e=>e.isReplaced&&e.id===t.id)},xe=(e,t)=>!(!e||!e[0])&&(e.forEach(e=>{try{e.stop();}catch(n){jr.log.ERROR([t,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.ERRORS.STOP_MEDIA_TRACK} - track id: ${e.id}`],n);}}),!0),Be=(e,t,n)=>{const{room:r}=e,i=e;let s=-1;if(!i.currentRTCRTPSenders[t])return;const o=i.currentRTCRTPSenders[t];for(let e=0;e<o.length;e+=1)if(n===o[e]){s=e;break}-1!==s?(o.splice(s,1),i.currentRTCRTPSenders[t]=o,Hi.setSkylinkState(i,r.id)):jr.log.WARN([t,null,null,"No matching sender was found for the peer."],n);},Fe={prepStopStreams:(e,t,n=!1,r=!1)=>new Promise((i,s)=>{const o=Hi.getSkylinkState(e),{streams:a}=o;o&&a||s(new Error(`${Ne.ROOM_STATE.NOT_FOUND} - ${e}`)),(!a||!r&&!a.userMedia||r&&!a.screenshare||r&&a.screenshare&&a.screenshare.id!==t)&&s(new Error(`${Ne.MEDIA_STREAM.ERRORS.NO_STREAM} - ${t}`)),r?Fe.prepStopScreenStream(o.room,t,n).then(()=>i()).catch(e=>s(e)):Fe.prepStopUserMediaStreams(o,t,n).then(()=>i()).catch(e=>s(e));}),prepStopUserMediaStreams:(e,t,n)=>new Promise((r,i)=>{const{user:s}=e,o=(e=>{const{streams:t}=e,n={replacedStreams:[],addedStreams:[]};return Object.keys(t.userMedia).forEach(r=>{Ge(e,t.userMedia[r].stream)?n.replacedStreams.push(t.userMedia[r].stream):n.addedStreams.push(t.userMedia[r].stream);}),n})(e);try{if(t){const{stream:r}=e.streams.userMedia[t];Ge(e,r)?Fe.stopReplacedStream(e,r,n):Fe.stopAddedStream(e,r,!1,n);}else Fe.stopAddedStreams(e,o.addedStreams,!1,n),Fe.stopReplacedStreams(e,o.replacedStreams,!1,n);return Fe.initRefreshConnectionAndResolve(e.room,n,r,i)}catch(e){jr.log.DEBUG([s.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA],e),i(Ne.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA);}}),stopAddedStream:(e,t,n=!1,r=!1)=>{const{room:i,user:s}=e;try{Fe.tryStopStream(t,s.sid),r||(Fe.removeTracks(i,t),Fe.updateMediaInfoMediaState(i,t),Fe.deleteStreamFromState(i,t,n),Fe.listenForEventAndDeleteMediaInfo(i,t),Fe.dispatchOnLocalStreamEnded(i,t,n),n&&new ni(e).deleteScreensharingInstance(i));}catch(e){jr.log.ERROR([s.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.STOP_ADDED_STREAM],e);}},tryStopStream:(e,t)=>{if(e){try{xe(e.getAudioTracks());}catch(n){jr.log.ERROR([t,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.ERRORS.STOP_AUDIO_TRACK} - stream id: ${e.id}`],n);}try{xe(e.getVideoTracks());}catch(n){jr.log.ERROR([t,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.ERRORS.STOP_VIDEO_TRACK} - stream id: ${e.id}`],n);}}},removeTracks:(e,t)=>{const n=Hi.getSkylinkState(e.id),{peerConnections:r,user:i}=n,s=t.getTracks();try{s.forEach(e=>{((e,t,n)=>{const r=n.id,i=Object.keys(t);for(let n=0;n<i.length;n+=1)try{const s=i[n],o=t[s];if(o.connectionState===j.CLOSED)break;const a=o.getSenders();let c=null;for(let t=0;t<a.length;t+=1)a[t].track&&a[t].track.id===r&&(c=a[t],o.removeTrack(c),Be(e,s,c));}catch(e){jr.log.ERROR([i[n],ge.PEER_CONNECTION,null,Ne.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e);}})(n,r,e);});}catch(e){jr.log.ERROR([i.sid,ge.PEER_CONNECTION,null,Ne.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e);}},listenForEventAndDeleteMediaInfo:(e,t)=>{const n=Hi.getSkylinkState(e.id),r=r=>{const i=t,{user:s}=n,{detail:o}=r;if(o.state===z.OFFER){const t=Wn.retrieveMediaId(Ar(i)?he.AUDIO:he.VIDEO,i.id);Wn.deleteUnavailableMedia(e,s.sid,t);}},i=()=>{kr(ye.HANDSHAKE_PROGRESS,r),kr(ye.MEDIA_INFO_DELETED,i);};br(ye.HANDSHAKE_PROGRESS,r),br(ye.MEDIA_INFO_DELETED,i);},stopAddedStreams:(e,t,n,r)=>{t.forEach(t=>{Fe.stopAddedStream(e,t,n,r);});},updateMediaInfoMediaState:(e,t)=>{const n=Hi.getSkylinkState(e.id),{user:r}=n,i=t.id,s=Wn.retrieveMediaId(t.getTracks()[0].kind,i);Wn.setMediaStateToUnavailable(e,r.sid,s);},deleteStreamFromState:(e,t,n=null)=>{const r=Hi.getSkylinkState(e.id),{user:i}=r,s=t.id;n?(delete r.streams.screenshare,delete r.streamsMediaStatus[t.id],delete r.streamsMutedSettings[t.id],r.streams.screenshare=null,jr.log.INFO([i.sid,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id} (screenshare)`])):(delete r.streams.userMedia[s],delete r.streamsMediaStatus[t.id],delete r.streamsMutedSettings[t.id],or(r.streams.userMedia)&&(r.streams.userMedia=null),jr.log.INFO([i.sid,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id}`])),Hi.setSkylinkState(r,r.room.id);},dispatchOnLocalStreamEnded:(e,t,n=!1)=>{const r=Hi.getSkylinkState(e.id),{MEDIA_STREAM:i}=Ne,{user:o}=r;jr.log.INFO([o.sid,ge.MEDIA_STREAM,null,i.STOP_SETTINGS],{peerId:o.sid,isSelf:!0,isScreensharing:n,stream:t}),Lr(c({room:e,peerId:o.sid,peerInfo:Ke.getCurrentSessionInfo(e),isSelf:!0,isScreensharing:n,streamId:t.id,isVideo:yr(t),isAudio:Ar(t)})),Lr(((e={})=>new s("mediaAccessStopped",{detail:e}))({isScreensharing:n,streamId:t.id})),Lr(T({peerId:o.sid,peerInfo:He.getCurrentSessionInfo(e),isSelf:!0}));},prepStopScreenStream:(e,t,n=!1)=>new Promise((t,r)=>{const i=Hi.getSkylinkState(e.id),{user:s,streams:o}=i,a=o.screenshare.stream;try{((e,t)=>{const{streams:n}=e;return !!n.userMedia&&Object.values(n.userMedia).some(e=>e.isReplaced&&e.id===t.id)})(i,a)?Fe.stopReplacedStream(i,a,!0,n):Fe.stopAddedStream(i,a,!0,n),Fe.initRefreshConnectionAndResolve(i.room,n,t,r);}catch(e){jr.log.DEBUG([s.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.STOP_SCREEN],e),r(new Error(Ne.MEDIA_STREAM.ERRORS.STOP_SCREEN));}}),initRefreshConnectionAndResolve:(e,t,n,r)=>{const i=Hi.getSkylinkState(e.id),{peerConnections:s}=i;try{if(!t){if(ar(Object.keys(s)))return (e=>{const{room:t,user:n}=e;Lr(T({peerId:n.sid,isSelf:!0,peerInfo:Ke.getCurrentSessionInfo(t)}));})(i),Wn.deleteUnavailableMedia(i.room,i.user.sid),n();{const e=e=>{const{detail:t}=e;if(t.state===z.ANSWER_ACK)return n()};br(ye.HANDSHAKE_PROGRESS,e),ei.refreshConnection(i);}}}catch(e){r(e);}},stopReplacedStream:(e,t,n,r)=>{const{user:i,room:s}=e;try{Fe.tryStopStream(t),r||(((e,t)=>{const{room:n,user:r}=e;(new Vn).stream(n.id,r,t,le.REPLACED_STREAM_ENDED,null);})(e,t),Fe.deleteStreamFromState(s,t,n),Fe.dispatchOnLocalStreamEnded(s,t));}catch(e){jr.log.ERROR([i.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.STOP_REPLACED_STREAM],e);}},stopReplacedStreams:(e,t,n,r)=>{t.forEach(t=>{Fe.stopReplacedStream(e,t,n,r);});}};class Ve{static getUserMedia(e,t={}){const{room:n}=e,r=sr.parseMediaOptions(t,e),{audio:i,video:s}=t,o=!!t.useExactConstraints;return Hi.setSkylinkState(r,n.id),sr.prepMediaAccessRequest({useExactConstraints:o,audio:i,video:s,roomKey:n.id})}static getUserMediaLayer(e,t=null){return new Promise((n,r)=>{let i={audio:!0,video:!0};t||jr.log.WARN([e.user.sid,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.NO_OPTIONS} - ${Ne.MEDIA_STREAM.DEFAULT_OPTIONS}`],i),dr(t)||(jr.log.ERROR([e.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS],t),r(new Error(Ne.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),null)),i=t,Ve.getUserMedia(e,i).then(e=>{n(e);}).catch(e=>{r(e);});})}static stopStreams(e,t){return Fe.prepStopStreams(e.room.id,t)}static addLocalMediaStreams(e,t){sr.addLocalMediaStreams(e,t);}static onRemoteTrackAdded(e,t,n,r,i,s){sr.onRemoteTrackAdded(e,t,n,r,i,s);}static muteStreams(e,t,n){return sr.muteStreams(e,t,n)}static sendStream(e,t){return sr.sendStream(e,t)}static getStreamSources(){return sr.getStreamSources()}static getScreenSources(){return sr.getScreenSources()}static updateRemoteStreams(e,t,n){return sr.updateRemoteStreams(e,t,n)}static getStreams(e){return sr.getStreams(e)}static usePrefetchedStream(e,t,n=null){return new Promise(r=>{!t&&n.id&&n.active&&(t=n);const i={audio:0!==t.getAudioTracks().length,video:0!==t.getVideoTracks().length},s=sr.parseStreamSettings(i,he.AUDIO),o=sr.parseStreamSettings(i,he.VIDEO);return sr.onStreamAccessSuccess(e,t,s,o,!1,r)})}}const je=e=>!or(e),We=(e,t)=>{const{streams:n}=e,r={};r.settings={audio:!1,video:!1,data:!1,bandwidth:Pe(e.streamsBandwidthSettings.bAS),googleXBandwidth:Pe(e.streamsBandwidthSettings.googleX)};const i=e.hasMCU?_e.MCU:t;if(e.peerConnections[i].signalingState!==j.CLOSED){const t=Hi.getInitOptions(),s=Ke.getPeerInfo(i,e.room);r.settings=Pe(s.settings),r.settings.data=t.enableDataChannel&&e.peerInformations[i].config.enableDataChannel,n.userMedia||n.screenshare;}if(e.peerCustomConfigs[i]){if(Object.hasOwnProperty.call(e.peerCustomConfigs[i],"bandwidth")){const t=e.peerCustomConfigs[i].bandwidth;dr(t)&&(ur(t.audio)&&(r.settings.bandwidth.audio=t.audio),ur(t.video)&&(r.settings.bandwidth.video=t.video),ur(t.data)&&(r.settings.bandwidth.data=t.data));}if(Object.hasOwnProperty.call(e.peerCustomConfigs[i],"googleXBandwidth")){const t=e.peerCustomConfigs[i].googleXBandwidth;dr(t)&&(ur(t.min)&&(r.settings.googleXBandwidth.min=t.min),ur(t.max)&&(r.settings.googleXBandwidth.max=t.max));}}return r},He={getPeerInfo:(e,t)=>{let n=null;if(!e)return null;const r=Hi.getSkylinkState(t.id);return r?((e,t)=>{const{user:n}=t;return e===n.sid})(e,r)?Ke.getCurrentSessionInfo(t):(n=Pe(r.peerInformations[e]))?(n.room=Pe(t.roomName),n.settings.data=!!(r.dataChannels[e]&&r.dataChannels[e].main&&r.dataChannels[e].main.channel&&r.dataChannels[e].main.channel.readyState===b.OPEN),n.connected=r.peerConnStatus[e]&&!!r.peerConnStatus[e].connected,n.init=r.peerConnStatus[e]&&!!r.peerConnStatus[e].init,e===_e.MCU?(n.config.receiveOnly=!0,n.config.publishOnly=!1):r.hasMCU&&(n.config.receiveOnly=!1,n.config.publishOnly=!0),n.settings.audio||n.settings.video||(n.config.receiveOnly=!0,n.config.publishOnly=!1),n):(jr.log.ERROR(`${Ne.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`),n):(Hi.logNoRoomState(t.id),n)},getCurrentSessionInfo:e=>{const t=Hi.getSkylinkState(e.id),n=Hi.getInitOptions(),{AdapterJS:r}=window,{enableDataChannel:i,codecParams:s}=n,{roomName:o}=e,{streamsMediaStatus:a,userData:c,peerPriorityWeight:d,enableIceRestart:l,publishOnly:u,SMProtocolVersion:p,DTProtocolVersion:S,streams:E,streamsBandwidthSettings:g,sdpSettings:m,user:f}=t,h={userData:c,settings:{audio:!1,video:!1},mediaStatus:{},agent:{name:r.webrtcDetectedBrowser,version:r.webrtcDetectedVersion,os:window.navigator.platform,pluginVersion:r.WebRTCPlugin.plugin?r.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:p,DTProtocolVersion:S,SDKVersion:"2.0.0"},room:o,config:{enableDataChannel:i,enableIceRestart:l,priorityWeight:d,receiveOnly:!1,publishOnly:u},sid:f.sid,screenshare:!1};if(E&&E.userMedia){const e=Object.keys(E.userMedia);E.userMedia[e[0]]&&(h.settings=Pe(E.userMedia[e[0]].settings));}return h.mediaStatus=a,h.userData=c||null,h.config.receiveOnly=!h.settings.video&&!h.settings.audio,E.screenshare&&(h.screenshare=!0),h.settings.maxBandwidth=Pe(g.bAS),h.settings.googleXBandwidth=Pe(g.googleX),h.settings.bandwidth&&(h.settings.maxBandwidth=Pe(h.settings.bandwidth),delete h.settings.bandwidth),h.settings.data=i&&m.connection.data,h.settings.audio&&dr(h.settings.audio)&&(Sr(typeof s.audio.opus.stereo)&&(h.settings.audio.stereo=s.audio.opus.stereo),Sr(s.audio.opus.usedtx)&&(h.settings.audio.usedtx=s.audio.opus.usedtx),ur(s.audio.opus.maxplaybackrate)&&(h.settings.audio.maxplaybackrate=s.audio.opus.maxplaybackrate),Sr(s.audio.opus.useinbandfec)&&(h.settings.audio.useinbandfec=s.audio.opus.useinbandfec)),h.settings.video&&dr(h.settings.video)&&(h.settings.video.customSettings={},h.settings.video.frameRate&&dr(h.settings.video.frameRate)&&(h.settings.video.customSettings.frameRate=Pe(h.settings.video.frameRate),h.settings.video.frameRate=-1),h.settings.video.facingMode&&dr(h.settings.video.facingMode)&&(h.settings.video.customSettings.facingMode=Pe(h.settings.video.facingMode),h.settings.video.facingMode="-1"),h.settings.video.resolution&&dr(h.settings.video.resolution)&&(h.settings.video.resolution.width&&dr(h.settings.video.resolution.width)&&(h.settings.video.customSettings.width=Pe(h.settings.video.width),h.settings.video.resolution.width=-1),h.settings.video.resolution.height&&dr(h.settings.video.resolution.height)&&(h.settings.video.customSettings.height=Pe(h.settings.video.height),h.settings.video.resolution.height=-1))),h.settings.audio||h.settings.video||(h.config.receiveOnly=!0,h.config.publishOnly=!1),Pe(h)},getUserInfo:Ue,getUserData:(e,t)=>{if(t&&e.peerInformations[t]){let n=e.peerInformations[t].userData;return n||(n=""),n}return e.userData},setUserData:(e,t)=>{const n=Hi.getSkylinkState(e.id),{PEER_INFORMATIONS:{UPDATE_USER_DATA:r}}=Ne,i=t||"";n.userData=i,Hi.setSkylinkState(n,n.room.id),(new Vn).setUserData(n),Lr(T({peerId:n.user.sid,peerInfo:He.getCurrentSessionInfo(e),isSelf:!0})),jr.log.INFO(r,i);},getPeersStreams:(e,t=!0)=>{const n={},{peerConnections:r,user:i,streams:s,hasMCU:o}=e;if(i&&i.sid&&t){const e=(e=>e.userMedia?e.userMedia:null)(s),t=(e=>e.screenshare?e.screenshare:null)(s);n[i.sid]=e||t?{}:null,e&&Object.keys(e).forEach(t=>{n[i.sid].isSelf=!0,n[i.sid][t]=e[t].stream;}),t&&(n[i.sid].isSelf=!0,n[i.sid][t.id]=t);}if(((e,t)=>t?!!e.MCU.maps:!or(e))(r,o)){const t=o?Object.keys(r.MCU.maps):Object.keys(r);for(let r=0;r<t.length;r+=1){n[t[r]]={},Ve.retrieveRemoteStreams(e,t[r]).forEach(e=>{n[t[r]][e.id]=e;});}}return or(n)?null:n},getPeersDataChannels:e=>{const{dataChannels:t}=e,n={},r=Object.keys(t);for(let e=0;e<r.length;e+=1){const i=r[e];if(n[i]={},je(t)){const e=Object.keys(t[i]);for(let r=0;r<e.length;r+=1){const s=t[i][e[r]],{channelName:o,channelType:a,transferId:c,streamId:d}=s;let l=null;(l=ei.getDataChannelBuffer(s)).channelProp=e[r],l.channelName=o,l.channelType=a,l.currentTransferId=c,l.currentStreamId=d,l.readyState=s.channel?s.channel.readyState:b.CREATE_ERROR,n[i][o]=l;}}}return n},getPeersCustomSettings:e=>{const{peerInformations:t}=e,n={};if((e=>!or(e))(t)){const r=Object.keys(t);for(let t=0;t<r.length;t+=1)n[r[t]]=We(e,r[t]);return n}return n},setGreatestPeerPriorityWeight:e=>{const t=Hi.getSkylinkState(e.room.id),{peerInformations:n}=t,r=Object.entries(n);let i=t.peerPriorityWeight;for(let e=0;e<r.length;e+=1){const n=r[e][1],{config:{priorityWeight:s}}=n;s>i&&(i=s,t.peerPriorityWeight=i+1);}Hi.setSkylinkState(t,t.room.id),jr.log.DEBUG(`User's priorityWeight is set to ${i}`);}};class Ke{static getPeerInfo(e,t){return He.getPeerInfo(e,t)}static getCurrentSessionInfo(e){return He.getCurrentSessionInfo(e)}static getUserInfo(e){return He.getUserInfo(e)}static getUserData(e,t){return He.getUserData(e,t)}static setUserData(e,t){He.setUserData(e,t);}static getPeersStreams(e,t){return He.getPeersStreams(e,t)}static getPeersDataChannels(e){return He.getPeersDataChannels(e)}static getPeersCustomSettings(e){return He.getPeersCustomSettings(e)}static setGreatestPeerPriorityWeight(e){return He.setGreatestPeerPriorityWeight(e)}}const $e=(e,t)=>{const n=Hi.getSkylinkState(e)||Object.values(Hi.getSkylinkState())[0],{socketSession:r,inRoom:i,room:o,user:a}=n;jr.log.INFO([null,"Socket",null,`Channel closed. Reason - ${t}`]),n.channelOpen=!1,Hi.setSkylinkState(n,e),Lr((e=>new s("channelClose",{detail:e}))({socketSession:Pe(r)})),i&&a&&a.sid&&Lr(((e={})=>new s("sessionDisconnect",{detail:e}))({peerId:a.sid,peerInfo:Ke.getCurrentSessionInfo(o)}));},Ye={apiBase:"https://api.temasys.io",stats:{endPoints:{client:"/client",session:"/session",auth:"/auth",signaling:"/signaling",iceConnection:"/client/iceconnection",iceCandidate:"/client/icecandidate",iceGathering:"/client/icegathering",negotiation:"/client/negotiation",bandwidth:"/client/bandwidth",recording:"/client/recording",dataChannel:"/client/datachannel"}}};Ye.stats.statsBase=`${Ye.apiBase}/rest/stats`;class ze{constructor(){this.endpoints=Ye.stats.endPoints,this.stats_buffer={},this.bufferTimeout=!1;}postStats(e,t){const{STATS_MODULE:n}=Ne,{fetch:r}=window;try{if(!t.client_id)return;const n=Hi.getInitOptions(),{enableStatsGathering:i}=n;i&&r(`${Ye.stats.statsBase}${e}`,{method:"POST",mode:"cors",headers:{"Content-type":"application/json"},body:JSON.stringify(t)});}catch(e){jr.log.WARN(n.ERRORS.POST_FAILED,e);}}addToStatsBuffer(e,t,n){this.stats_buffer[e]||(this.stats_buffer[e]={},this.stats_buffer[e].url=n,this.stats_buffer[e].data=[]);const r=Object.assign({},t);this.stats_buffer[e].data.push(r);}manageStatsBuffer(){this.bufferTimeout||(this.bufferTimeout=!0,setInterval(()=>{const e=Object.keys(this.stats_buffer);for(let t=0;t<e.length;t+=1)this.stats_buffer[e[t]].data.length>0&&(this.postStats(this.stats_buffer[e[t]].url,this.stats_buffer[e[t]].data),this.stats_buffer[e[t]].data=[]);},5e3));}}class Je extends ze{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,signaling_url:null,signaling_transport:null,attempts:null,error:null};}send(e,t,n){const r=Hi.getSkylinkState(e),{socketSession:i}=r;this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.client_id=r.clientId,this.model.state=t,this.model.signaling_url=r.socketSession.socketServer,this.model.signaling_transport=r.socketSession.socketType.toLowerCase(),this.model.attempts=0===i.socketSession.finalAttempts?i.socketSession.attempts:2*i.socketSession.finalAttempts+i.socketSession.attempts,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.attempts="number"==typeof n?n:null,this.model.error=("string"==typeof n?n:n&&n.message)||null,this.postStats(this.endpoints.signaling,this.model);}}const Xe={onConnection:(e,t)=>{const n=Hi.getSkylinkState(t),{socketSession:r}=n;(new Je).send(t,Ae.SIGNALING.CONNECT,null),n.channelOpen||(n.channelOpen=!0,Hi.setSkylinkState(n,t)),0!==r.socketSession.finalAttempts||0!==r.socketSession.attempts?(Lr((e=>new s("channelReopen",{detail:e}))({socketSession:Pe(r)})),(new Je).send(t,Ae.SIGNALING.RECONNECT_SUCCESS)):Lr((e=>new s("channelOpen",{detail:e}))({socketSession:Pe(r)})),e();},onDisconnect:(e,t)=>{const n=Hi.getSkylinkState(e)||Object.values(Hi.getSkylinkState())[0],r=n.channelOpen,{room:i}=n;(new Je).send(i.id,Ae.SIGNALING.DISCONNECT,null),(r||!r&&e!==i.roomName)&&rt(i.id,t);},onError:(e,t)=>{const n=Hi.getSkylinkState(e),{socketSession:r}=n;(new Je).send(e,Ae.SIGNALING.ERROR,t),jr.log.ERROR([null,"Socket",null,"Exception occurred ->"],t),Lr((e=>new s("channelError",{detail:e}))({error:t,socketSession:Pe(r)}));},onReconnectAttempt:(e,t)=>{const n=Hi.getSkylinkState(e),{socketSession:r}=n;let i=0;(new Vn).updateAttempts(e,"attempts",t),i=0===r.socketSession.finalAttempts?t:2*r.socketSession.finalAttempts+r.socketSession.attempts,(new Je).send(e,Ae.SIGNALING.RECONNECT_ATTEMPT,i),Lr((e=>new s("channelRetry",{detail:e}))({fallbackType:r.fallbackType,currentAttempt:i,session:Pe(Hi.getSkylinkState(e).socketSession)}));},onReconnectFailed:(e,t,n)=>{const r=Hi.getSkylinkState(n),{socketSession:i}=r,s=new Vn;i.socketSession.attempts===ke.RECONNECTION_ATTEMPTS.WEBSOCKET&&i.socketSession.finalAttempts<ke.RECONNECTION_FINAL_ATTEMPTS&&!i.socketTimeout?(s.socket.connect(),s.updateAttempts(n,"attempts",i.socketSession.attempts===ke.RECONNECTION_ATTEMPTS.WEBSOCKET?0:i.socketSession.attempts+=1),s.updateAttempts(n,"finalAttempts",i.socketSession.finalAttempts+=1)):((new Je).send(n,Ae.SIGNALING.RECONNECT_FAILED,Ne.INIT.ERRORS.SOCKET_ERROR_ABORT),Lr(D({session:Pe(i),errorCode:ee.RECONNECTION_ABORTED,type:i.fallbackType,error:new Error(Ne.INIT.ERRORS.SOCKET_ERROR_ABORT)})),t(new Error(Ne.INIT.ERRORS.SOCKET_ERROR_ABORT)));},onReconnectError:(e,t)=>{const n=Hi.getSkylinkState(e),{socketSession:r}=n;(new Je).send(e,Ae.SIGNALING.RECONNECT_ERROR,t),!r.socketTimeout&&t&&"timeout"===t&&(jr.log.ERROR([null,"Socket",null,`${r.socketType} connection timed out.`]),r.socketTimeout=!0,Hi.setSkylinkState(n,e));}},qe=e=>Sr(e)&&e,Qe=(e,t)=>{const n=Hi.getSkylinkState(e),{detail:r}=t;if(r.state===z.ENTER){const e=Pe(n.socketMessageQueue);n.user.bufferMessage=!1,n.socketMessageQueue=[],Hi.setSkylinkState(n,n.room.id),jr.log.DEBUG([n.user.sid,ge.SIG_SERVER,null,`${Ne.SIGNALING.BUFFERED_MESSAGES_SENT}: ${e.length}`]),((e,t)=>{const n=new Vn;for(let r=t.length-1;r>=0;r-=1){const i=t[r];if(!i.mid){if(!e.user.sid)return void jr.log.DEBUG([e.user.sid,ge.SIG_SERVER,null,`${Ne.SIGNALING.BUFFERED_MESSAGES_DROPPED}`]);i.mid=e.user.sid;}n.sendMessage(i),t.splice(r,1);}})(n,e),wr.removeEventListener(ye.HANDSHAKE_PROGRESS,Qe);}},Ze=e=>{const{rid:t}=e,n=Hi.getSkylinkState(t),{user:r,room:i}=n;return !lr(r.bufferMessage)&&!qe(r.bufferMessage)||(e=>{const{JOIN_ROOM:t,ENTER:n,WELCOME:r,OFFER:i,ANSWER:s,ANSWER_ACK:o,CANDIDATE:a,END_OF_CANDIDATES:c}=de;return [t,n,r,i,s,o,a,c].indexOf(e.type)>-1})(e)?(e.type===z.ENTER&&lr(r.bufferMessage)&&(jr.log.DEBUG([r.sid,ge.SIG_SERVER,null,Ne.SIGNALING.BUFFER_NOT_NEEDED]),n.user.bufferMessage=!1,n.socketMessageQueue=[],Hi.setSkylinkState(n,n.room.id)),!1):(jr.log.DEBUG([r.sid,ge.SIG_SERVER,null,Ne.SIGNALING.MESSAGE_ADDED_TO_BUFFER]),n.socketMessageQueue.unshift(e),qe(r.bufferMessage)||(n.user.bufferMessage=!0,jr.log.DEBUG([r.sid,ge.SIG_SERVER,null,Ne.SIGNALING.ENTER_LISTENER]),wr.addEventListener(ye.HANDSHAKE_PROGRESS,Qe.bind(void 0,t))),Hi.setSkylinkState(n,i.id),!0)},et=e=>Le(e),tt=(...e)=>{((e,t)=>{const{type:n}=t;switch(jr.log.INFO(["SIG SERVER",null,n,"received"]),n){case de.IN_ROOM:e.inRoomHandler(t);break;case de.ENTER:e.enterRoomHandler(t);break;case de.OFFER:e.offerHandler(t);break;case de.WELCOME:e.welcomeHandler(t);break;case de.ANSWER:e.answerHandler(t);break;case de.ANSWER_ACK:e.answerAckHandler(t);break;case de.CANDIDATE:e.candidateHandler(t);break;case de.PEER_LIST:e.getPeerListHandler(t);break;case de.INTRODUCE_ERROR:e.introduceError(t);break;case de.BYE:e.byeHandler(t);break;case de.STREAM:e.streamHandler(t);break;case de.RECORDING:e.recordingHandler(t);break;case de.REDIRECT:e.redirectHandler(t);break;case de.RTMP:e.rtmpHandler(t);break;case de.UPDATE_USER:e.setUserDataHandler(t);break;case de.MEDIA_INFO_EVENT:e.mediaInfoEventHandler(t);break;case de.MESSAGE:e.userMessageHandler(t,null);break;case de.STORED_MESSAGES:e.storedMessagesHandler(t);break;case de.MUTE_AUDIO_EVENT:e.muteAudioEventHandler(t);break;case de.MUTE_VIDEO_EVENT:e.muteVideoEventHandler(t);break;case de.PUBLIC_MESSAGE:e.userMessageHandler(t,!0);break;case de.PRIVATE_MESSAGE:e.userMessageHandler(t,!1);}})(...e);},nt=(e,t)=>{e.send(JSON.stringify(t));},rt=(...e)=>{$e(...e);},it=(...e)=>{((e,t,n,r)=>{t.socket.on(ve.CONNECT,Xe.onConnection.bind(t,n,e)),t.socket.on(ve.MESSAGE,t.onMessage.bind(t)),t.socket.on(ve.DISCONNECT,Xe.onDisconnect.bind(t,e)),t.socket.on(ve.ERROR,Xe.onError.bind(t,e)),t.socket.on(ve.RECONNECT_ATTEMPT,Xe.onReconnectAttempt.bind(t,e)),t.socket.on(ve.RECONNECT_ERROR,Xe.onReconnectError.bind(t,e)),t.socket.on(ve.RECONNECT_FAILED,Xe.onReconnectFailed.bind(t,n,r,e));})(...e);},st=(...e)=>Ze(...e);var ot=r((function(e,t){var n;e.exports=(n=n||function(e,t){var n=Object.create||function(){function e(){}return function(t){var n;return e.prototype=t,n=new e,e.prototype=null,n}}(),r={},i=r.lib={},s=i.Base={extend:function(e){var t=n(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments);}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString);},clone:function(){return this.init.prototype.extend(this)}},o=i.WordArray=s.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length;},toString:function(e){return (e||c).stringify(this)},concat:function(e){var t=this.words,n=e.words,r=this.sigBytes,i=e.sigBytes;if(this.clamp(),r%4)for(var s=0;s<i;s++){var o=n[s>>>2]>>>24-s%4*8&255;t[r+s>>>2]|=o<<24-(r+s)%4*8;}else for(s=0;s<i;s+=4)t[r+s>>>2]=n[s>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,n=this.sigBytes;t[n>>>2]&=4294967295<<32-n%4*8,t.length=e.ceil(n/4);},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var n,r=[],i=function(t){t=t;var n=987654321,r=4294967295;return function(){var i=((n=36969*(65535&n)+(n>>16)&r)<<16)+(t=18e3*(65535&t)+(t>>16)&r)&r;return i/=4294967296,(i+=.5)*(e.random()>.5?1:-1)}},s=0;s<t;s+=4){var a=i(4294967296*(n||e.random()));n=987654071*a(),r.push(4294967296*a()|0);}return new o.init(r,t)}}),a=r.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i++){var s=t[i>>>2]>>>24-i%4*8&255;r.push((s>>>4).toString(16)),r.push((15&s).toString(16));}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r+=2)n[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new o.init(n,t/2)}},d=a.Latin1={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i++){var s=t[i>>>2]>>>24-i%4*8&255;r.push(String.fromCharCode(s));}return r.join("")},parse:function(e){for(var t=e.length,n=[],r=0;r<t;r++)n[r>>>2]|=(255&e.charCodeAt(r))<<24-r%4*8;return new o.init(n,t)}},l=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},u=i.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new o.init,this._nDataBytes=0;},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes;},_process:function(t){var n=this._data,r=n.words,i=n.sigBytes,s=this.blockSize,a=i/(4*s),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*s,d=e.min(4*c,i);if(c){for(var l=0;l<c;l+=s)this._doProcessBlock(r,l);var u=r.splice(0,c);n.sigBytes-=d;}return new o.init(u,d)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),p=(i.Hasher=u.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset();},reset:function(){u.reset.call(this),this._doReset();},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,n){return new e.init(n).finalize(t)}},_createHmacHelper:function(e){return function(t,n){return new p.HMAC.init(e,n).finalize(t)}}}),r.algo={});return r}(Math),n);})),at=(r((function(e,t){var n,r,i,s,o,a;e.exports=(r=(n=a=ot).lib,i=r.Base,s=r.WordArray,(o=n.x64={}).Word=i.extend({init:function(e,t){this.high=e,this.low=t;}}),o.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:8*e.length;},toX32:function(){for(var e=this.words,t=e.length,n=[],r=0;r<t;r++){var i=e[r];n.push(i.high),n.push(i.low);}return s.create(n,this.sigBytes)},clone:function(){for(var e=i.clone.call(this),t=e.words=this.words.slice(0),n=t.length,r=0;r<n;r++)t[r]=t[r].clone();return e}}),a);})),r((function(e,t){var n;e.exports=(n=ot,function(){if("function"==typeof ArrayBuffer){var e=n.lib.WordArray,t=e.init;(e.init=function(e){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var n=e.byteLength,r=[],i=0;i<n;i++)r[i>>>2]|=e[i]<<24-i%4*8;t.call(this,r,n);}else t.apply(this,arguments);}).prototype=e;}}(),n.lib.WordArray);})),r((function(e,t){var n;e.exports=(n=ot,function(){var e=n,t=e.lib.WordArray,r=e.enc;function i(e){return e<<8&4278255360|e>>>8&16711935}r.Utf16=r.Utf16BE={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],i=0;i<n;i+=2){var s=t[i>>>2]>>>16-i%4*8&65535;r.push(String.fromCharCode(s));}return r.join("")},parse:function(e){for(var n=e.length,r=[],i=0;i<n;i++)r[i>>>1]|=e.charCodeAt(i)<<16-i%2*16;return t.create(r,2*n)}},r.Utf16LE={stringify:function(e){for(var t=e.words,n=e.sigBytes,r=[],s=0;s<n;s+=2){var o=i(t[s>>>2]>>>16-s%4*8&65535);r.push(String.fromCharCode(o));}return r.join("")},parse:function(e){for(var n=e.length,r=[],s=0;s<n;s++)r[s>>>1]|=i(e.charCodeAt(s)<<16-s%2*16);return t.create(r,2*n)}};}(),n.enc.Utf16);})),r((function(e,t){var n,r,i;e.exports=(r=(n=i=ot).lib.WordArray,n.enc.Base64={stringify:function(e){var t=e.words,n=e.sigBytes,r=this._map;e.clamp();for(var i=[],s=0;s<n;s+=3)for(var o=(t[s>>>2]>>>24-s%4*8&255)<<16|(t[s+1>>>2]>>>24-(s+1)%4*8&255)<<8|t[s+2>>>2]>>>24-(s+2)%4*8&255,a=0;a<4&&s+.75*a<n;a++)i.push(r.charAt(o>>>6*(3-a)&63));var c=r.charAt(64);if(c)for(;i.length%4;)i.push(c);return i.join("")},parse:function(e){var t=e.length,n=this._map,i=this._reverseMap;if(!i){i=this._reverseMap=[];for(var s=0;s<n.length;s++)i[n.charCodeAt(s)]=s;}var o=n.charAt(64);if(o){var a=e.indexOf(o);-1!==a&&(t=a);}return function(e,t,n){for(var i=[],s=0,o=0;o<t;o++)if(o%4){var a=n[e.charCodeAt(o-1)]<<o%4*2,c=n[e.charCodeAt(o)]>>>6-o%4*2;i[s>>>2]|=(a|c)<<24-s%4*8,s++;}return r.create(i,s)}(e,t,i)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},i.enc.Base64);})),r((function(e,t){var n;e.exports=(n=ot,function(e){var t=n,r=t.lib,i=r.WordArray,s=r.Hasher,o=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0;}();var c=o.MD5=s.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878]);},_doProcessBlock:function(e,t){for(var n=0;n<16;n++){var r=t+n,i=e[r];e[r]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);}var s=this._hash.words,o=e[t+0],c=e[t+1],S=e[t+2],E=e[t+3],g=e[t+4],m=e[t+5],f=e[t+6],h=e[t+7],R=e[t+8],T=e[t+9],C=e[t+10],I=e[t+11],_=e[t+12],v=e[t+13],O=e[t+14],A=e[t+15],y=s[0],D=s[1],N=s[2],P=s[3];y=d(y,D,N,P,o,7,a[0]),P=d(P,y,D,N,c,12,a[1]),N=d(N,P,y,D,S,17,a[2]),D=d(D,N,P,y,E,22,a[3]),y=d(y,D,N,P,g,7,a[4]),P=d(P,y,D,N,m,12,a[5]),N=d(N,P,y,D,f,17,a[6]),D=d(D,N,P,y,h,22,a[7]),y=d(y,D,N,P,R,7,a[8]),P=d(P,y,D,N,T,12,a[9]),N=d(N,P,y,D,C,17,a[10]),D=d(D,N,P,y,I,22,a[11]),y=d(y,D,N,P,_,7,a[12]),P=d(P,y,D,N,v,12,a[13]),N=d(N,P,y,D,O,17,a[14]),y=l(y,D=d(D,N,P,y,A,22,a[15]),N,P,c,5,a[16]),P=l(P,y,D,N,f,9,a[17]),N=l(N,P,y,D,I,14,a[18]),D=l(D,N,P,y,o,20,a[19]),y=l(y,D,N,P,m,5,a[20]),P=l(P,y,D,N,C,9,a[21]),N=l(N,P,y,D,A,14,a[22]),D=l(D,N,P,y,g,20,a[23]),y=l(y,D,N,P,T,5,a[24]),P=l(P,y,D,N,O,9,a[25]),N=l(N,P,y,D,E,14,a[26]),D=l(D,N,P,y,R,20,a[27]),y=l(y,D,N,P,v,5,a[28]),P=l(P,y,D,N,S,9,a[29]),N=l(N,P,y,D,h,14,a[30]),y=u(y,D=l(D,N,P,y,_,20,a[31]),N,P,m,4,a[32]),P=u(P,y,D,N,R,11,a[33]),N=u(N,P,y,D,I,16,a[34]),D=u(D,N,P,y,O,23,a[35]),y=u(y,D,N,P,c,4,a[36]),P=u(P,y,D,N,g,11,a[37]),N=u(N,P,y,D,h,16,a[38]),D=u(D,N,P,y,C,23,a[39]),y=u(y,D,N,P,v,4,a[40]),P=u(P,y,D,N,o,11,a[41]),N=u(N,P,y,D,E,16,a[42]),D=u(D,N,P,y,f,23,a[43]),y=u(y,D,N,P,T,4,a[44]),P=u(P,y,D,N,_,11,a[45]),N=u(N,P,y,D,A,16,a[46]),y=p(y,D=u(D,N,P,y,S,23,a[47]),N,P,o,6,a[48]),P=p(P,y,D,N,h,10,a[49]),N=p(N,P,y,D,O,15,a[50]),D=p(D,N,P,y,m,21,a[51]),y=p(y,D,N,P,_,6,a[52]),P=p(P,y,D,N,E,10,a[53]),N=p(N,P,y,D,C,15,a[54]),D=p(D,N,P,y,c,21,a[55]),y=p(y,D,N,P,R,6,a[56]),P=p(P,y,D,N,A,10,a[57]),N=p(N,P,y,D,f,15,a[58]),D=p(D,N,P,y,v,21,a[59]),y=p(y,D,N,P,g,6,a[60]),P=p(P,y,D,N,I,10,a[61]),N=p(N,P,y,D,S,15,a[62]),D=p(D,N,P,y,T,21,a[63]),s[0]=s[0]+y|0,s[1]=s[1]+D|0,s[2]=s[2]+N|0,s[3]=s[3]+P|0;},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;n[i>>>5]|=128<<24-i%32;var s=e.floor(r/4294967296),o=r;n[15+(i+64>>>9<<4)]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),n[14+(i+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(n.length+1),this._process();for(var a=this._hash,c=a.words,d=0;d<4;d++){var l=c[d];c[d]=16711935&(l<<8|l>>>24)|4278255360&(l<<24|l>>>8);}return a},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});function d(e,t,n,r,i,s,o){var a=e+(t&n|~t&r)+i+o;return (a<<s|a>>>32-s)+t}function l(e,t,n,r,i,s,o){var a=e+(t&r|n&~r)+i+o;return (a<<s|a>>>32-s)+t}function u(e,t,n,r,i,s,o){var a=e+(t^n^r)+i+o;return (a<<s|a>>>32-s)+t}function p(e,t,n,r,i,s,o){var a=e+(n^(t|~r))+i+o;return (a<<s|a>>>32-s)+t}t.MD5=s._createHelper(c),t.HmacMD5=s._createHmacHelper(c);}(Math),n.MD5);})),r((function(e,t){var n,r,i,s,o,a,c,d;e.exports=(r=(n=d=ot).lib,i=r.WordArray,s=r.Hasher,o=n.algo,a=[],c=o.SHA1=s.extend({_doReset:function(){this._hash=new i.init([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],o=n[3],c=n[4],d=0;d<80;d++){if(d<16)a[d]=0|e[t+d];else{var l=a[d-3]^a[d-8]^a[d-14]^a[d-16];a[d]=l<<1|l>>>31;}var u=(r<<5|r>>>27)+c+a[d];u+=d<20?1518500249+(i&s|~i&o):d<40?1859775393+(i^s^o):d<60?(i&s|i&o|s&o)-1894007588:(i^s^o)-899497514,c=o,o=s,s=i<<30|i>>>2,i=r,r=u;}n[0]=n[0]+r|0,n[1]=n[1]+i|0,n[2]=n[2]+s|0,n[3]=n[3]+o|0,n[4]=n[4]+c|0;},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=Math.floor(n/4294967296),t[15+(r+64>>>9<<4)]=n,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}}),n.SHA1=s._createHelper(c),n.HmacSHA1=s._createHmacHelper(c),d.SHA1);})),r((function(e,t){var n;e.exports=(n=ot,function(e){var t=n,r=t.lib,i=r.WordArray,s=r.Hasher,o=t.algo,a=[],c=[];!function(){function t(t){for(var n=e.sqrt(t),r=2;r<=n;r++)if(!(t%r))return !1;return !0}function n(e){return 4294967296*(e-(0|e))|0}for(var r=2,i=0;i<64;)t(r)&&(i<8&&(a[i]=n(e.pow(r,.5))),c[i]=n(e.pow(r,1/3)),i++),r++;}();var d=[],l=o.SHA256=s.extend({_doReset:function(){this._hash=new i.init(a.slice(0));},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],o=n[3],a=n[4],l=n[5],u=n[6],p=n[7],S=0;S<64;S++){if(S<16)d[S]=0|e[t+S];else{var E=d[S-15],g=(E<<25|E>>>7)^(E<<14|E>>>18)^E>>>3,m=d[S-2],f=(m<<15|m>>>17)^(m<<13|m>>>19)^m>>>10;d[S]=g+d[S-7]+f+d[S-16];}var h=r&i^r&s^i&s,R=(r<<30|r>>>2)^(r<<19|r>>>13)^(r<<10|r>>>22),T=p+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&l^~a&u)+c[S]+d[S];p=u,u=l,l=a,a=o+T|0,o=s,s=i,i=r,r=T+(R+h)|0;}n[0]=n[0]+r|0,n[1]=n[1]+i|0,n[2]=n[2]+s|0,n[3]=n[3]+o|0,n[4]=n[4]+a|0,n[5]=n[5]+l|0,n[6]=n[6]+u|0,n[7]=n[7]+p|0;},_doFinalize:function(){var t=this._data,n=t.words,r=8*this._nDataBytes,i=8*t.sigBytes;return n[i>>>5]|=128<<24-i%32,n[14+(i+64>>>9<<4)]=e.floor(r/4294967296),n[15+(i+64>>>9<<4)]=r,t.sigBytes=4*n.length,this._process(),this._hash},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=s._createHelper(l),t.HmacSHA256=s._createHmacHelper(l);}(Math),n.SHA256);})),r((function(e,t){var n,r,i,s,o,a;e.exports=(r=(n=a=ot).lib.WordArray,i=n.algo,s=i.SHA256,o=i.SHA224=s.extend({_doReset:function(){this._hash=new r.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]);},_doFinalize:function(){var e=s._doFinalize.call(this);return e.sigBytes-=4,e}}),n.SHA224=s._createHelper(o),n.HmacSHA224=s._createHmacHelper(o),a.SHA224);})),r((function(e,t){var n;e.exports=(n=ot,function(){var e=n,t=e.lib.Hasher,r=e.x64,i=r.Word,s=r.WordArray,o=e.algo;function a(){return i.create.apply(i,arguments)}var c=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],d=[];!function(){for(var e=0;e<80;e++)d[e]=a();}();var l=o.SHA512=t.extend({_doReset:function(){this._hash=new s.init([new i.init(1779033703,4089235720),new i.init(3144134277,2227873595),new i.init(1013904242,4271175723),new i.init(2773480762,1595750129),new i.init(1359893119,2917565137),new i.init(2600822924,725511199),new i.init(528734635,4215389547),new i.init(1541459225,327033209)]);},_doProcessBlock:function(e,t){for(var n=this._hash.words,r=n[0],i=n[1],s=n[2],o=n[3],a=n[4],l=n[5],u=n[6],p=n[7],S=r.high,E=r.low,g=i.high,m=i.low,f=s.high,h=s.low,R=o.high,T=o.low,C=a.high,I=a.low,_=l.high,v=l.low,O=u.high,A=u.low,y=p.high,D=p.low,N=S,P=E,M=g,w=m,b=f,k=h,L=R,U=T,G=C,x=I,B=_,F=v,V=O,j=A,W=y,H=D,K=0;K<80;K++){var $=d[K];if(K<16)var Y=$.high=0|e[t+2*K],z=$.low=0|e[t+2*K+1];else{var J=d[K-15],X=J.high,q=J.low,Q=(X>>>1|q<<31)^(X>>>8|q<<24)^X>>>7,Z=(q>>>1|X<<31)^(q>>>8|X<<24)^(q>>>7|X<<25),ee=d[K-2],te=ee.high,ne=ee.low,re=(te>>>19|ne<<13)^(te<<3|ne>>>29)^te>>>6,ie=(ne>>>19|te<<13)^(ne<<3|te>>>29)^(ne>>>6|te<<26),se=d[K-7],oe=se.high,ae=se.low,ce=d[K-16],de=ce.high,le=ce.low;Y=(Y=(Y=Q+oe+((z=Z+ae)>>>0<Z>>>0?1:0))+re+((z+=ie)>>>0<ie>>>0?1:0))+de+((z+=le)>>>0<le>>>0?1:0),$.high=Y,$.low=z;}var ue,pe=G&B^~G&V,Se=x&F^~x&j,Ee=N&M^N&b^M&b,ge=P&w^P&k^w&k,me=(N>>>28|P<<4)^(N<<30|P>>>2)^(N<<25|P>>>7),fe=(P>>>28|N<<4)^(P<<30|N>>>2)^(P<<25|N>>>7),he=(G>>>14|x<<18)^(G>>>18|x<<14)^(G<<23|x>>>9),Re=(x>>>14|G<<18)^(x>>>18|G<<14)^(x<<23|G>>>9),Te=c[K],Ce=Te.high,Ie=Te.low,_e=W+he+((ue=H+Re)>>>0<H>>>0?1:0),ve=fe+ge;W=V,H=j,V=B,j=F,B=G,F=x,G=L+(_e=(_e=(_e=_e+pe+((ue+=Se)>>>0<Se>>>0?1:0))+Ce+((ue+=Ie)>>>0<Ie>>>0?1:0))+Y+((ue+=z)>>>0<z>>>0?1:0))+((x=U+ue|0)>>>0<U>>>0?1:0)|0,L=b,U=k,b=M,k=w,M=N,w=P,N=_e+(me+Ee+(ve>>>0<fe>>>0?1:0))+((P=ue+ve|0)>>>0<ue>>>0?1:0)|0;}E=r.low=E+P,r.high=S+N+(E>>>0<P>>>0?1:0),m=i.low=m+w,i.high=g+M+(m>>>0<w>>>0?1:0),h=s.low=h+k,s.high=f+b+(h>>>0<k>>>0?1:0),T=o.low=T+U,o.high=R+L+(T>>>0<U>>>0?1:0),I=a.low=I+x,a.high=C+G+(I>>>0<x>>>0?1:0),v=l.low=v+F,l.high=_+B+(v>>>0<F>>>0?1:0),A=u.low=A+j,u.high=O+V+(A>>>0<j>>>0?1:0),D=p.low=D+H,p.high=y+W+(D>>>0<H>>>0?1:0);},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;return t[r>>>5]|=128<<24-r%32,t[30+(r+128>>>10<<5)]=Math.floor(n/4294967296),t[31+(r+128>>>10<<5)]=n,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=t.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32});e.SHA512=t._createHelper(l),e.HmacSHA512=t._createHmacHelper(l);}(),n.SHA512);})),r((function(e,t){var n,r,i,s,o,a,c,d;e.exports=(r=(n=d=ot).x64,i=r.Word,s=r.WordArray,o=n.algo,a=o.SHA512,c=o.SHA384=a.extend({_doReset:function(){this._hash=new s.init([new i.init(3418070365,3238371032),new i.init(1654270250,914150663),new i.init(2438529370,812702999),new i.init(355462360,4144912697),new i.init(1731405415,4290775857),new i.init(2394180231,1750603025),new i.init(3675008525,1694076839),new i.init(1203062813,3204075428)]);},_doFinalize:function(){var e=a._doFinalize.call(this);return e.sigBytes-=16,e}}),n.SHA384=a._createHelper(c),n.HmacSHA384=a._createHmacHelper(c),d.SHA384);})),r((function(e,t){var n;e.exports=(n=ot,function(e){var t=n,r=t.lib,i=r.WordArray,s=r.Hasher,o=t.x64.Word,a=t.algo,c=[],d=[],l=[];!function(){for(var e=1,t=0,n=0;n<24;n++){c[e+5*t]=(n+1)*(n+2)/2%64;var r=(2*e+3*t)%5;e=t%5,t=r;}for(e=0;e<5;e++)for(t=0;t<5;t++)d[e+5*t]=t+(2*e+3*t)%5*5;for(var i=1,s=0;s<24;s++){for(var a=0,u=0,p=0;p<7;p++){if(1&i){var S=(1<<p)-1;S<32?u^=1<<S:a^=1<<S-32;}128&i?i=i<<1^113:i<<=1;}l[s]=o.create(a,u);}}();var u=[];!function(){for(var e=0;e<25;e++)u[e]=o.create();}();var p=a.SHA3=s.extend({cfg:s.cfg.extend({outputLength:512}),_doReset:function(){for(var e=this._state=[],t=0;t<25;t++)e[t]=new o.init;this.blockSize=(1600-2*this.cfg.outputLength)/32;},_doProcessBlock:function(e,t){for(var n=this._state,r=this.blockSize/2,i=0;i<r;i++){var s=e[t+2*i],o=e[t+2*i+1];s=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8),o=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),(D=n[i]).high^=o,D.low^=s;}for(var a=0;a<24;a++){for(var p=0;p<5;p++){for(var S=0,E=0,g=0;g<5;g++)S^=(D=n[p+5*g]).high,E^=D.low;var m=u[p];m.high=S,m.low=E;}for(p=0;p<5;p++){var f=u[(p+4)%5],h=u[(p+1)%5],R=h.high,T=h.low;for(S=f.high^(R<<1|T>>>31),E=f.low^(T<<1|R>>>31),g=0;g<5;g++)(D=n[p+5*g]).high^=S,D.low^=E;}for(var C=1;C<25;C++){var I=(D=n[C]).high,_=D.low,v=c[C];v<32?(S=I<<v|_>>>32-v,E=_<<v|I>>>32-v):(S=_<<v-32|I>>>64-v,E=I<<v-32|_>>>64-v);var O=u[d[C]];O.high=S,O.low=E;}var A=u[0],y=n[0];for(A.high=y.high,A.low=y.low,p=0;p<5;p++)for(g=0;g<5;g++){var D=n[C=p+5*g],N=u[C],P=u[(p+1)%5+5*g],M=u[(p+2)%5+5*g];D.high=N.high^~P.high&M.high,D.low=N.low^~P.low&M.low;}D=n[0];var w=l[a];D.high^=w.high,D.low^=w.low;}},_doFinalize:function(){var t=this._data,n=t.words,r=(this._nDataBytes,8*t.sigBytes),s=32*this.blockSize;n[r>>>5]|=1<<24-r%32,n[(e.ceil((r+1)/s)*s>>>5)-1]|=128,t.sigBytes=4*n.length,this._process();for(var o=this._state,a=this.cfg.outputLength/8,c=a/8,d=[],l=0;l<c;l++){var u=o[l],p=u.high,S=u.low;p=16711935&(p<<8|p>>>24)|4278255360&(p<<24|p>>>8),S=16711935&(S<<8|S>>>24)|4278255360&(S<<24|S>>>8),d.push(S),d.push(p);}return new i.init(d,a)},clone:function(){for(var e=s.clone.call(this),t=e._state=this._state.slice(0),n=0;n<25;n++)t[n]=t[n].clone();return e}});t.SHA3=s._createHelper(p),t.HmacSHA3=s._createHmacHelper(p);}(Math),n.SHA3);})),r((function(e,t){var n;e.exports=(n=ot,
	/** @preserve
			(c) 2012 by Cédric Mesnil. All rights reserved.

			Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

			    - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
			    - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

			THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
			*/
	function(e){var t=n,r=t.lib,i=r.WordArray,s=r.Hasher,o=t.algo,a=i.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),c=i.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),d=i.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),l=i.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),u=i.create([0,1518500249,1859775393,2400959708,2840853838]),p=i.create([1352829926,1548603684,1836072691,2053994217,0]),S=o.RIPEMD160=s.extend({_doReset:function(){this._hash=i.create([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(e,t){for(var n=0;n<16;n++){var r=t+n,i=e[r];e[r]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8);}var s,o,S,T,C,I,_,v,O,A,y,D=this._hash.words,N=u.words,P=p.words,M=a.words,w=c.words,b=d.words,k=l.words;for(I=s=D[0],_=o=D[1],v=S=D[2],O=T=D[3],A=C=D[4],n=0;n<80;n+=1)y=s+e[t+M[n]]|0,y+=n<16?E(o,S,T)+N[0]:n<32?g(o,S,T)+N[1]:n<48?m(o,S,T)+N[2]:n<64?f(o,S,T)+N[3]:h(o,S,T)+N[4],y=(y=R(y|=0,b[n]))+C|0,s=C,C=T,T=R(S,10),S=o,o=y,y=I+e[t+w[n]]|0,y+=n<16?h(_,v,O)+P[0]:n<32?f(_,v,O)+P[1]:n<48?m(_,v,O)+P[2]:n<64?g(_,v,O)+P[3]:E(_,v,O)+P[4],y=(y=R(y|=0,k[n]))+A|0,I=A,A=O,O=R(v,10),v=_,_=y;y=D[1]+S+O|0,D[1]=D[2]+T+A|0,D[2]=D[3]+C+I|0,D[3]=D[4]+s+_|0,D[4]=D[0]+o+v|0,D[0]=y;},_doFinalize:function(){var e=this._data,t=e.words,n=8*this._nDataBytes,r=8*e.sigBytes;t[r>>>5]|=128<<24-r%32,t[14+(r+64>>>9<<4)]=16711935&(n<<8|n>>>24)|4278255360&(n<<24|n>>>8),e.sigBytes=4*(t.length+1),this._process();for(var i=this._hash,s=i.words,o=0;o<5;o++){var a=s[o];s[o]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8);}return i},clone:function(){var e=s.clone.call(this);return e._hash=this._hash.clone(),e}});function E(e,t,n){return e^t^n}function g(e,t,n){return e&t|~e&n}function m(e,t,n){return (e|~t)^n}function f(e,t,n){return e&n|t&~n}function h(e,t,n){return e^(t|~n)}function R(e,t){return e<<t|e>>>32-t}t.RIPEMD160=s._createHelper(S),t.HmacRIPEMD160=s._createHmacHelper(S);}(Math),n.RIPEMD160);})),r((function(e,t){var n,r,i;e.exports=(r=(n=ot).lib.Base,i=n.enc.Utf8,void(n.algo.HMAC=r.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=i.parse(t));var n=e.blockSize,r=4*n;t.sigBytes>r&&(t=e.finalize(t)),t.clamp();for(var s=this._oKey=t.clone(),o=this._iKey=t.clone(),a=s.words,c=o.words,d=0;d<n;d++)a[d]^=1549556828,c[d]^=909522486;s.sigBytes=o.sigBytes=r,this.reset();},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey);},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,n=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(n))}})));})),r((function(e,t){var n,r,i,s,o,a,c,d,l;e.exports=(r=(n=l=ot).lib,i=r.Base,s=r.WordArray,o=n.algo,a=o.SHA1,c=o.HMAC,d=o.PBKDF2=i.extend({cfg:i.extend({keySize:4,hasher:a,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e);},compute:function(e,t){for(var n=this.cfg,r=c.create(n.hasher,e),i=s.create(),o=s.create([1]),a=i.words,d=o.words,l=n.keySize,u=n.iterations;a.length<l;){var p=r.update(t).finalize(o);r.reset();for(var S=p.words,E=S.length,g=p,m=1;m<u;m++){g=r.finalize(g),r.reset();for(var f=g.words,h=0;h<E;h++)S[h]^=f[h];}i.concat(p),d[0]++;}return i.sigBytes=4*l,i}}),n.PBKDF2=function(e,t,n){return d.create(n).compute(e,t)},l.PBKDF2);})),r((function(e,t){var n,r,i,s,o,a,c,d;e.exports=(r=(n=d=ot).lib,i=r.Base,s=r.WordArray,o=n.algo,a=o.MD5,c=o.EvpKDF=i.extend({cfg:i.extend({keySize:4,hasher:a,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e);},compute:function(e,t){for(var n=this.cfg,r=n.hasher.create(),i=s.create(),o=i.words,a=n.keySize,c=n.iterations;o.length<a;){d&&r.update(d);var d=r.update(e).finalize(t);r.reset();for(var l=1;l<c;l++)d=r.finalize(d),r.reset();i.concat(d);}return i.sigBytes=4*a,i}}),n.EvpKDF=function(e,t,n){return c.create(n).compute(e,t)},d.EvpKDF);})),r((function(e,t){var n,r,i,s,o,a,c,d,l,u,p,S,E,g,m,f,h,R,T,C;e.exports=void((n=ot).lib.Cipher||(i=n,s=i.lib,o=s.Base,a=s.WordArray,c=s.BufferedBlockAlgorithm,d=i.enc,d.Utf8,l=d.Base64,u=i.algo.EvpKDF,p=s.Cipher=c.extend({cfg:o.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,n){this.cfg=this.cfg.extend(n),this._xformMode=e,this._key=t,this.reset();},reset:function(){c.reset.call(this),this._doReset();},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function e(e){return "string"==typeof e?C:R}return function(t){return {encrypt:function(n,r,i){return e(r).encrypt(t,n,r,i)},decrypt:function(n,r,i){return e(r).decrypt(t,n,r,i)}}}}()}),s.StreamCipher=p.extend({_doFinalize:function(){return this._process(!0)},blockSize:1}),S=i.mode={},E=s.BlockCipherMode=o.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t;}}),g=S.CBC=function(){var e=E.extend();function t(e,t,n){var i=this._iv;if(i){var s=i;this._iv=r;}else s=this._prevBlock;for(var o=0;o<n;o++)e[t+o]^=s[o];}return e.Encryptor=e.extend({processBlock:function(e,n){var r=this._cipher,i=r.blockSize;t.call(this,e,n,i),r.encryptBlock(e,n),this._prevBlock=e.slice(n,n+i);}}),e.Decryptor=e.extend({processBlock:function(e,n){var r=this._cipher,i=r.blockSize,s=e.slice(n,n+i);r.decryptBlock(e,n),t.call(this,e,n,i),this._prevBlock=s;}}),e}(),m=(i.pad={}).Pkcs7={pad:function(e,t){for(var n=4*t,r=n-e.sigBytes%n,i=r<<24|r<<16|r<<8|r,s=[],o=0;o<r;o+=4)s.push(i);var c=a.create(s,r);e.concat(c);},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},s.BlockCipher=p.extend({cfg:p.cfg.extend({mode:g,padding:m}),reset:function(){p.reset.call(this);var e=this.cfg,t=e.iv,n=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var r=n.createEncryptor;else r=n.createDecryptor,this._minBufferSize=1;this._mode&&this._mode.__creator==r?this._mode.init(this,t&&t.words):(this._mode=r.call(n,this,t&&t.words),this._mode.__creator=r);},_doProcessBlock:function(e,t){this._mode.processBlock(e,t);},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0);}else t=this._process(!0),e.unpad(t);return t},blockSize:4}),f=s.CipherParams=o.extend({init:function(e){this.mixIn(e);},toString:function(e){return (e||this.formatter).stringify(this)}}),h=(i.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,n=e.salt;if(n)var r=a.create([1398893684,1701076831]).concat(n).concat(t);else r=t;return r.toString(l)},parse:function(e){var t=l.parse(e),n=t.words;if(1398893684==n[0]&&1701076831==n[1]){var r=a.create(n.slice(2,4));n.splice(0,4),t.sigBytes-=16;}return f.create({ciphertext:t,salt:r})}},R=s.SerializableCipher=o.extend({cfg:o.extend({format:h}),encrypt:function(e,t,n,r){r=this.cfg.extend(r);var i=e.createEncryptor(n,r),s=i.finalize(t),o=i.cfg;return f.create({ciphertext:s,key:n,iv:o.iv,algorithm:e,mode:o.mode,padding:o.padding,blockSize:e.blockSize,formatter:r.format})},decrypt:function(e,t,n,r){return r=this.cfg.extend(r),t=this._parse(t,r.format),e.createDecryptor(n,r).finalize(t.ciphertext)},_parse:function(e,t){return "string"==typeof e?t.parse(e,this):e}}),T=(i.kdf={}).OpenSSL={execute:function(e,t,n,r){r||(r=a.random(8));var i=u.create({keySize:t+n}).compute(e,r),s=a.create(i.words.slice(t),4*n);return i.sigBytes=4*t,f.create({key:i,iv:s,salt:r})}},C=s.PasswordBasedCipher=R.extend({cfg:R.cfg.extend({kdf:T}),encrypt:function(e,t,n,r){var i=(r=this.cfg.extend(r)).kdf.execute(n,e.keySize,e.ivSize);r.iv=i.iv;var s=R.encrypt.call(this,e,t,i.key,r);return s.mixIn(i),s},decrypt:function(e,t,n,r){r=this.cfg.extend(r),t=this._parse(t,r.format);var i=r.kdf.execute(n,e.keySize,e.ivSize,t.salt);return r.iv=i.iv,R.decrypt.call(this,e,t,i.key,r)}})));})),r((function(e,t){var n;e.exports=((n=ot).mode.CFB=function(){var e=n.lib.BlockCipherMode.extend();function t(e,t,n,r){var i=this._iv;if(i){var s=i.slice(0);this._iv=void 0;}else s=this._prevBlock;r.encryptBlock(s,0);for(var o=0;o<n;o++)e[t+o]^=s[o];}return e.Encryptor=e.extend({processBlock:function(e,n){var r=this._cipher,i=r.blockSize;t.call(this,e,n,i,r),this._prevBlock=e.slice(n,n+i);}}),e.Decryptor=e.extend({processBlock:function(e,n){var r=this._cipher,i=r.blockSize,s=e.slice(n,n+i);t.call(this,e,n,i,r),this._prevBlock=s;}}),e}(),n.mode.CFB);})),r((function(e,t){var n,r,i;e.exports=((i=ot).mode.CTR=(n=i.lib.BlockCipherMode.extend(),r=n.Encryptor=n.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize,i=this._iv,s=this._counter;i&&(s=this._counter=i.slice(0),this._iv=void 0);var o=s.slice(0);n.encryptBlock(o,0),s[r-1]=s[r-1]+1|0;for(var a=0;a<r;a++)e[t+a]^=o[a];}}),n.Decryptor=r,n),i.mode.CTR);})),r((function(e,t){var n;e.exports=(
	/** @preserve
			 * Counter block mode compatible with  Dr Brian Gladman fileenc.c
			 * derived from CryptoJS.mode.CTR
			 * Jan Hruby jhruby.web@gmail.com
			 */
	(n=ot).mode.CTRGladman=function(){var e=n.lib.BlockCipherMode.extend();function t(e){if(255==(e>>24&255)){var t=e>>16&255,n=e>>8&255,r=255&e;255===t?(t=0,255===n?(n=0,255===r?r=0:++r):++n):++t,e=0,e+=t<<16,e+=n<<8,e+=r;}else e+=1<<24;return e}var r=e.Encryptor=e.extend({processBlock:function(e,n){var r=this._cipher,i=r.blockSize,s=this._iv,o=this._counter;s&&(o=this._counter=s.slice(0),this._iv=void 0),function(e){0===(e[0]=t(e[0]))&&(e[1]=t(e[1]));}(o);var a=o.slice(0);r.encryptBlock(a,0);for(var c=0;c<i;c++)e[n+c]^=a[c];}});return e.Decryptor=r,e}(),n.mode.CTRGladman);})),r((function(e,t){var n,r,i;e.exports=((i=ot).mode.OFB=(n=i.lib.BlockCipherMode.extend(),r=n.Encryptor=n.extend({processBlock:function(e,t){var n=this._cipher,r=n.blockSize,i=this._iv,s=this._keystream;i&&(s=this._keystream=i.slice(0),this._iv=void 0),n.encryptBlock(s,0);for(var o=0;o<r;o++)e[t+o]^=s[o];}}),n.Decryptor=r,n),i.mode.OFB);})),r((function(e,t){var n,r;e.exports=((r=ot).mode.ECB=((n=r.lib.BlockCipherMode.extend()).Encryptor=n.extend({processBlock:function(e,t){this._cipher.encryptBlock(e,t);}}),n.Decryptor=n.extend({processBlock:function(e,t){this._cipher.decryptBlock(e,t);}}),n),r.mode.ECB);})),r((function(e,t){var n;e.exports=((n=ot).pad.AnsiX923={pad:function(e,t){var n=e.sigBytes,r=4*t,i=r-n%r,s=n+i-1;e.clamp(),e.words[s>>>2]|=i<<24-s%4*8,e.sigBytes+=i;},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},n.pad.Ansix923);})),r((function(e,t){var n;e.exports=((n=ot).pad.Iso10126={pad:function(e,t){var r=4*t,i=r-e.sigBytes%r;e.concat(n.lib.WordArray.random(i-1)).concat(n.lib.WordArray.create([i<<24],1));},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},n.pad.Iso10126);})),r((function(e,t){var n;e.exports=((n=ot).pad.Iso97971={pad:function(e,t){e.concat(n.lib.WordArray.create([2147483648],1)),n.pad.ZeroPadding.pad(e,t);},unpad:function(e){n.pad.ZeroPadding.unpad(e),e.sigBytes--;}},n.pad.Iso97971);})),r((function(e,t){var n;e.exports=((n=ot).pad.ZeroPadding={pad:function(e,t){var n=4*t;e.clamp(),e.sigBytes+=n-(e.sigBytes%n||n);},unpad:function(e){for(var t=e.words,n=e.sigBytes-1;!(t[n>>>2]>>>24-n%4*8&255);)n--;e.sigBytes=n+1;}},n.pad.ZeroPadding);})),r((function(e,t){var n;e.exports=((n=ot).pad.NoPadding={pad:function(){},unpad:function(){}},n.pad.NoPadding);})),r((function(e,t){var n,r,i,s;e.exports=(r=(n=s=ot).lib.CipherParams,i=n.enc.Hex,n.format.Hex={stringify:function(e){return e.ciphertext.toString(i)},parse:function(e){var t=i.parse(e);return r.create({ciphertext:t})}},s.format.Hex);})),r((function(e,t){var n;e.exports=(n=ot,function(){var e=n,t=e.lib.BlockCipher,r=e.algo,i=[],s=[],o=[],a=[],c=[],d=[],l=[],u=[],p=[],S=[];!function(){for(var e=[],t=0;t<256;t++)e[t]=t<128?t<<1:t<<1^283;var n=0,r=0;for(t=0;t<256;t++){var E=r^r<<1^r<<2^r<<3^r<<4;E=E>>>8^255&E^99,i[n]=E,s[E]=n;var g=e[n],m=e[g],f=e[m],h=257*e[E]^16843008*E;o[n]=h<<24|h>>>8,a[n]=h<<16|h>>>16,c[n]=h<<8|h>>>24,d[n]=h,h=16843009*f^65537*m^257*g^16843008*n,l[E]=h<<24|h>>>8,u[E]=h<<16|h>>>16,p[E]=h<<8|h>>>24,S[E]=h,n?(n=g^e[e[e[f^g]]],r^=e[e[r]]):n=r=1;}}();var E=[0,1,2,4,8,16,32,64,128,27,54],g=r.AES=t.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var e=this._keyPriorReset=this._key,t=e.words,n=e.sigBytes/4,r=4*((this._nRounds=n+6)+1),s=this._keySchedule=[],o=0;o<r;o++)if(o<n)s[o]=t[o];else{var a=s[o-1];o%n?n>6&&o%n==4&&(a=i[a>>>24]<<24|i[a>>>16&255]<<16|i[a>>>8&255]<<8|i[255&a]):(a=i[(a=a<<8|a>>>24)>>>24]<<24|i[a>>>16&255]<<16|i[a>>>8&255]<<8|i[255&a],a^=E[o/n|0]<<24),s[o]=s[o-n]^a;}for(var c=this._invKeySchedule=[],d=0;d<r;d++)o=r-d,a=d%4?s[o]:s[o-4],c[d]=d<4||o<=4?a:l[i[a>>>24]]^u[i[a>>>16&255]]^p[i[a>>>8&255]]^S[i[255&a]];}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,o,a,c,d,i);},decryptBlock:function(e,t){var n=e[t+1];e[t+1]=e[t+3],e[t+3]=n,this._doCryptBlock(e,t,this._invKeySchedule,l,u,p,S,s),n=e[t+1],e[t+1]=e[t+3],e[t+3]=n;},_doCryptBlock:function(e,t,n,r,i,s,o,a){for(var c=this._nRounds,d=e[t]^n[0],l=e[t+1]^n[1],u=e[t+2]^n[2],p=e[t+3]^n[3],S=4,E=1;E<c;E++){var g=r[d>>>24]^i[l>>>16&255]^s[u>>>8&255]^o[255&p]^n[S++],m=r[l>>>24]^i[u>>>16&255]^s[p>>>8&255]^o[255&d]^n[S++],f=r[u>>>24]^i[p>>>16&255]^s[d>>>8&255]^o[255&l]^n[S++],h=r[p>>>24]^i[d>>>16&255]^s[l>>>8&255]^o[255&u]^n[S++];d=g,l=m,u=f,p=h;}g=(a[d>>>24]<<24|a[l>>>16&255]<<16|a[u>>>8&255]<<8|a[255&p])^n[S++],m=(a[l>>>24]<<24|a[u>>>16&255]<<16|a[p>>>8&255]<<8|a[255&d])^n[S++],f=(a[u>>>24]<<24|a[p>>>16&255]<<16|a[d>>>8&255]<<8|a[255&l])^n[S++],h=(a[p>>>24]<<24|a[d>>>16&255]<<16|a[l>>>8&255]<<8|a[255&u])^n[S++],e[t]=g,e[t+1]=m,e[t+2]=f,e[t+3]=h;},keySize:8});e.AES=t._createHelper(g);}(),n.AES);})),r((function(e,t){var n;e.exports=(n=ot,function(){var e=n,t=e.lib,r=t.WordArray,i=t.BlockCipher,s=e.algo,o=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],d=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],l=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],u=s.DES=i.extend({_doReset:function(){for(var e=this._key.words,t=[],n=0;n<56;n++){var r=o[n]-1;t[n]=e[r>>>5]>>>31-r%32&1;}for(var i=this._subKeys=[],s=0;s<16;s++){var d=i[s]=[],l=c[s];for(n=0;n<24;n++)d[n/6|0]|=t[(a[n]-1+l)%28]<<31-n%6,d[4+(n/6|0)]|=t[28+(a[n+24]-1+l)%28]<<31-n%6;for(d[0]=d[0]<<1|d[0]>>>31,n=1;n<7;n++)d[n]=d[n]>>>4*(n-1)+3;d[7]=d[7]<<5|d[7]>>>27;}var u=this._invSubKeys=[];for(n=0;n<16;n++)u[n]=i[15-n];},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys);},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys);},_doCryptBlock:function(e,t,n){this._lBlock=e[t],this._rBlock=e[t+1],p.call(this,4,252645135),p.call(this,16,65535),S.call(this,2,858993459),S.call(this,8,16711935),p.call(this,1,1431655765);for(var r=0;r<16;r++){for(var i=n[r],s=this._lBlock,o=this._rBlock,a=0,c=0;c<8;c++)a|=d[c][((o^i[c])&l[c])>>>0];this._lBlock=o,this._rBlock=s^a;}var u=this._lBlock;this._lBlock=this._rBlock,this._rBlock=u,p.call(this,1,1431655765),S.call(this,8,16711935),S.call(this,2,858993459),p.call(this,16,65535),p.call(this,4,252645135),e[t]=this._lBlock,e[t+1]=this._rBlock;},keySize:2,ivSize:2,blockSize:2});function p(e,t){var n=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=n,this._lBlock^=n<<e;}function S(e,t){var n=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=n,this._rBlock^=n<<e;}e.DES=i._createHelper(u);var E=s.TripleDES=i.extend({_doReset:function(){var e=this._key.words;this._des1=u.createEncryptor(r.create(e.slice(0,2))),this._des2=u.createEncryptor(r.create(e.slice(2,4))),this._des3=u.createEncryptor(r.create(e.slice(4,6)));},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t);},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t);},keySize:6,ivSize:2,blockSize:2});e.TripleDES=i._createHelper(E);}(),n.TripleDES);})),r((function(e,t){var n;e.exports=(n=ot,function(){var e=n,t=e.lib.StreamCipher,r=e.algo,i=r.RC4=t.extend({_doReset:function(){for(var e=this._key,t=e.words,n=e.sigBytes,r=this._S=[],i=0;i<256;i++)r[i]=i;i=0;for(var s=0;i<256;i++){var o=i%n,a=t[o>>>2]>>>24-o%4*8&255;s=(s+r[i]+a)%256;var c=r[i];r[i]=r[s],r[s]=c;}this._i=this._j=0;},_doProcessBlock:function(e,t){e[t]^=s.call(this);},keySize:8,ivSize:0});function s(){for(var e=this._S,t=this._i,n=this._j,r=0,i=0;i<4;i++){n=(n+e[t=(t+1)%256])%256;var s=e[t];e[t]=e[n],e[n]=s,r|=e[(e[t]+e[n])%256]<<24-8*i;}return this._i=t,this._j=n,r}e.RC4=t._createHelper(i);var o=r.RC4Drop=i.extend({cfg:i.cfg.extend({drop:192}),_doReset:function(){i._doReset.call(this);for(var e=this.cfg.drop;e>0;e--)s.call(this);}});e.RC4Drop=t._createHelper(o);}(),n.RC4);})),r((function(e,t){var n;e.exports=(n=ot,function(){var e=n,t=e.lib.StreamCipher,r=e.algo,i=[],s=[],o=[],a=r.Rabbit=t.extend({_doReset:function(){for(var e=this._key.words,t=this.cfg.iv,n=0;n<4;n++)e[n]=16711935&(e[n]<<8|e[n]>>>24)|4278255360&(e[n]<<24|e[n]>>>8);var r=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],i=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];for(this._b=0,n=0;n<4;n++)c.call(this);for(n=0;n<8;n++)i[n]^=r[n+4&7];if(t){var s=t.words,o=s[0],a=s[1],d=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),l=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),u=d>>>16|4294901760&l,p=l<<16|65535&d;for(i[0]^=d,i[1]^=u,i[2]^=l,i[3]^=p,i[4]^=d,i[5]^=u,i[6]^=l,i[7]^=p,n=0;n<4;n++)c.call(this);}},_doProcessBlock:function(e,t){var n=this._X;c.call(this),i[0]=n[0]^n[5]>>>16^n[3]<<16,i[1]=n[2]^n[7]>>>16^n[5]<<16,i[2]=n[4]^n[1]>>>16^n[7]<<16,i[3]=n[6]^n[3]>>>16^n[1]<<16;for(var r=0;r<4;r++)i[r]=16711935&(i[r]<<8|i[r]>>>24)|4278255360&(i[r]<<24|i[r]>>>8),e[t+r]^=i[r];},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,n=0;n<8;n++)s[n]=t[n];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<s[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<s[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<s[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<s[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<s[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<s[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<s[6]>>>0?1:0)|0,this._b=t[7]>>>0<s[7]>>>0?1:0,n=0;n<8;n++){var r=e[n]+t[n],i=65535&r,a=r>>>16,c=((i*i>>>17)+i*a>>>15)+a*a,d=((4294901760&r)*r|0)+((65535&r)*r|0);o[n]=c^d;}e[0]=o[0]+(o[7]<<16|o[7]>>>16)+(o[6]<<16|o[6]>>>16)|0,e[1]=o[1]+(o[0]<<8|o[0]>>>24)+o[7]|0,e[2]=o[2]+(o[1]<<16|o[1]>>>16)+(o[0]<<16|o[0]>>>16)|0,e[3]=o[3]+(o[2]<<8|o[2]>>>24)+o[1]|0,e[4]=o[4]+(o[3]<<16|o[3]>>>16)+(o[2]<<16|o[2]>>>16)|0,e[5]=o[5]+(o[4]<<8|o[4]>>>24)+o[3]|0,e[6]=o[6]+(o[5]<<16|o[5]>>>16)+(o[4]<<16|o[4]>>>16)|0,e[7]=o[7]+(o[6]<<8|o[6]>>>24)+o[5]|0;}e.Rabbit=t._createHelper(a);}(),n.Rabbit);})),r((function(e,t){var n;e.exports=(n=ot,function(){var e=n,t=e.lib.StreamCipher,r=e.algo,i=[],s=[],o=[],a=r.RabbitLegacy=t.extend({_doReset:function(){var e=this._key.words,t=this.cfg.iv,n=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],r=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];this._b=0;for(var i=0;i<4;i++)c.call(this);for(i=0;i<8;i++)r[i]^=n[i+4&7];if(t){var s=t.words,o=s[0],a=s[1],d=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),l=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),u=d>>>16|4294901760&l,p=l<<16|65535&d;for(r[0]^=d,r[1]^=u,r[2]^=l,r[3]^=p,r[4]^=d,r[5]^=u,r[6]^=l,r[7]^=p,i=0;i<4;i++)c.call(this);}},_doProcessBlock:function(e,t){var n=this._X;c.call(this),i[0]=n[0]^n[5]>>>16^n[3]<<16,i[1]=n[2]^n[7]>>>16^n[5]<<16,i[2]=n[4]^n[1]>>>16^n[7]<<16,i[3]=n[6]^n[3]>>>16^n[1]<<16;for(var r=0;r<4;r++)i[r]=16711935&(i[r]<<8|i[r]>>>24)|4278255360&(i[r]<<24|i[r]>>>8),e[t+r]^=i[r];},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,n=0;n<8;n++)s[n]=t[n];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<s[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<s[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<s[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<s[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<s[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<s[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<s[6]>>>0?1:0)|0,this._b=t[7]>>>0<s[7]>>>0?1:0,n=0;n<8;n++){var r=e[n]+t[n],i=65535&r,a=r>>>16,c=((i*i>>>17)+i*a>>>15)+a*a,d=((4294901760&r)*r|0)+((65535&r)*r|0);o[n]=c^d;}e[0]=o[0]+(o[7]<<16|o[7]>>>16)+(o[6]<<16|o[6]>>>16)|0,e[1]=o[1]+(o[0]<<8|o[0]>>>24)+o[7]|0,e[2]=o[2]+(o[1]<<16|o[1]>>>16)+(o[0]<<16|o[0]>>>16)|0,e[3]=o[3]+(o[2]<<8|o[2]>>>24)+o[1]|0,e[4]=o[4]+(o[3]<<16|o[3]>>>16)+(o[2]<<16|o[2]>>>16)|0,e[5]=o[5]+(o[4]<<8|o[4]>>>24)+o[3]|0,e[6]=o[6]+(o[5]<<16|o[5]>>>16)+(o[4]<<16|o[4]>>>16)|0,e[7]=o[7]+(o[6]<<8|o[6]>>>24)+o[5]|0;}e.RabbitLegacy=t._createHelper(a);}(),n.RabbitLegacy);})),r((function(e,t){e.exports=ot;})));class ct{static throwError(e="",t=""){throw jr.log.ERROR([null,ge.SKYLINK_ERROR,null,`${e}${t?` - ${t}`:""}`]),new Error(`${e}${t?` - ${t}`:""}`)}}const dt={getMessageConfig:(e,t)=>{const{peerInformations:n,inRoom:r,user:i}=e;let s,o=!1;if(!r||!i)throw Error(Ne.ROOM.ERRORS.NOT_IN_ROOM);return Array.isArray(t)&&!ar(t)?(s=t,o=!0):t&&Er(t)?(s=[t],o=!0):s=Object.keys(n),s.forEach((e,t)=>{n[e]?e===_e.MCU&&s.splice(t,1):(jr.log.WARN([e,ge.MESSAGING,null,`${Ne.MESSAGING.ERRORS.DROPPING_MESSAGE} - ${Ne.PEER_CONNECTION.NO_PEER_CONNECTION}`]),s.splice(t,1));}),0===s.length&&jr.log.WARN([null,ge.MESSAGING,null,Ne.PEER_CONNECTION.NO_PEER_CONNECTION]),{listOfPeers:s,isPrivate:o}},sendMessageToSig:(e,t,n,r="",i)=>{(new Vn).sendUserMessage(e,t,r||n),dt.dispatchOnIncomingMessage(e,t,n,!0,i);},dispatchOnIncomingMessage:(e,t,n,r,i)=>{const{room:s,user:o}=e;jr.log.DEBUG([r?null:i,ge.MESSAGING,null,`${Ne.MESSAGING.RECEIVED_MESSAGE} - isPrivate: ${t.isPrivate}`]);const a={targetPeerId:r?t.isPrivate?i:null:o.sid,content:n,senderPeerId:r?o.sid:i,isDataChannel:!1,isPrivate:t.isPrivate,timeStamp:Mr()};r&&(a.listOfPeers=t.listOfPeers),Lr(u({room:s,message:a,isSelf:r,peerId:r?o.sid:i,peerInfo:r?Ke.getCurrentSessionInfo(s):Ke.getPeerInfo(i,s)}));},trySendMessage:(e,t,n)=>{try{const r=dt.getMessageConfig(e,n);dt.sendMessageToSig(e,r,t,null,n);}catch(e){ct.throwError(Ne.MESSAGING.ERRORS.FAILED_SENDING_MESSAGE);}}},lt={deleteEncryptSecrets:(e,t,n)=>{const r={encryptSecrets:e,selectedSecretId:t};if(n){if(!r.encryptSecrets[n])throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);r.selectedSecretId===n&&(r.selectedSecretId=lt.setSelectedSecretId()),delete r.encryptSecrets[n];}else jr.log.DEBUG([null,ge.ENCRYPTED_MESSAGING,null,`${Ne.MESSAGING.ENCRYPTION.DELETE_ALL}`]),r.selectedSecretId=lt.setSelectedSecretId(),r.encryptSecrets={};return r},setEncryptSecret:(e,t,n)=>{const r=e;if((e=>{if(!e)throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!lt.utils.isValidString(e));return !0})(t)&&((e,t)=>{if(!e)throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!lt.utils.isValidString(e));if(lt.utils.isExisting(e,t))throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_UNIQUE);return !0})(n,r))return r[n]=t,r},setSelectedSecretId:(e,t)=>{if(!t)return "";if(lt.utils.isValidString(t),!e[t])throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return t},utils:{isExisting:(e,t)=>{return Object.keys(t).filter(t=>t===e).length>0},isValidString:e=>{if(!Er(e)||!Er(e)||cr(e))throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return !0},hasCrypto:()=>at||(jr.log.ERROR([null,ge.ASYNC_MESSAGING,null,Ne.PERSISTENT_MESSAGE.ERRORS.NO_DEPENDENCY]),!1),canEncrypt:(e,t)=>{if(or(t)&&cr(e))throw new Error(`${Ne.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED}, ${Ne.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_PROVIDED}`);if(cr(e))throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_SELECTED);if(or(t))throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return !0},canDecrypt:e=>{if(or(e))throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return !0}},getMessageConfig:(e,t,n,r,i)=>{const s=dt.getMessageConfig(e,t);return lt.utils.hasCrypto()&&lt.utils.canEncrypt(r,n)&&(s.secretId=r),i&&(s.isPersistent=i),s},encryptMessage:(e,t,n=!1)=>{if(n)try{return at.AES.decrypt(e,t).toString(at.enc.Utf8)}catch(e){throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET)}return at.AES.encrypt(e,t).toString()},tryDecryptMessage:(e,t,n)=>{const r=lt.encryptMessage(e,n[t],!0);if(cr(r))throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET);return r}},ut={};class pt{constructor(e){const{room:t,user:n}=e;return ut[t.id]||(ut[t.id]=this),this.room=t,this.peerId=n.sid,this.encryptSecrets={},this.selectedSecretId="",ut[t.id]}setEncryptSecret(e,t){try{this.encryptSecrets=lt.setEncryptSecret(this.encryptSecrets,e,t),this.dispatchEncryptSecretEvent();}catch(e){ct.throwError(Ne.MESSAGING.ENCRYPTION.ERRORS.SET_ENCRYPT_SECRET,e.message);}}getEncryptSecrets(){return this.encryptSecrets}deleteEncryptSecrets(e){try{const t=lt.deleteEncryptSecrets(this.encryptSecrets,this.selectedSecretId,e);this.encryptSecrets=t.encryptSecrets,this.selectedSecretId=t.selectedSecretId,this.dispatchEncryptSecretEvent();}catch(e){ct.throwError(Ne.MESSAGING.ENCRYPTION.ERRORS.DELETE_ENCRYPT_SECRETS,e.message);}}setSelectedSecretId(e){try{this.selectedSecretId=lt.setSelectedSecretId(this.encryptSecrets,e),this.dispatchEncryptSecretEvent();}catch(e){ct.throwError(Ne.MESSAGING.ENCRYPTION.ERRORS.SET_SELECTED_SECRET,e.message);}}getSelectedSecretId(){return this.selectedSecretId}dispatchEncryptSecretEvent(){Lr(S({room:this.room,encryptSecrets:this.encryptSecrets,selectedSecretId:this.selectedSecretId,peerInfo:Ue(this.room),peerId:this.peerId}));}canEncrypt(e){try{return !!lt.utils.canEncrypt(this.selectedSecretId,this.encryptSecrets)&&(lt.utils.isValidString(this.selectedSecretId)&&lt.utils.isValidString(this.encryptSecrets[this.selectedSecretId]))}catch(t){if(e)throw new Error(t.message);return !1}}decryptStoredMessages(e,t){if(lt.utils.canEncrypt(t,this.encryptSecrets)&&!Object.keys(this.encryptSecrets).filter(e=>e===t).length)throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return this.decryptMessage(e,t)}decryptMessage(e,t=""){if(t&&lt.utils.canDecrypt(this.encryptSecrets))return lt.tryDecryptMessage(e,t,this.encryptSecrets);throw new Error(Ne.MESSAGING.ENCRYPTION.ERRORS.INVALID_SECRETS)}sendMessage(e,t,n,r=!1){const i=hr(e);if(gr(t,"message","sendMessage")&&i)try{jr.log.DEBUG([null,ge.ASYNC_MESSAGING,null,Ne.MESSAGING.ENCRYPTION.SEND_MESSAGE]);const e=lt.getMessageConfig(i,n,this.encryptSecrets,this.selectedSecretId,r),s=lt.encryptMessage(t,this.encryptSecrets[this.selectedSecretId]);dt.sendMessageToSig(i,e,t,s,n);}catch(e){ct.throwError(Ne.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message);}}static deleteEncryptedInstance(e){delete ut[e.id];}}const St={getMessageConfig:(e,t)=>{const n=lt.getMessageConfig(e,t);return n.isPersistent=!0,n},parseDecryptedMessageData:(e,t)=>({targetPeerId:t,senderPeerId:e.mid,content:e.data,timeStamp:Pr(e.timeStamp),isPrivate:!1,isDataChannel:!1})},Et={};class gt{constructor(e){const{user:t,room:n,hasPersistentMessage:r}=e;return Et[n.id]||(Et[n.id]=this),this.room=n,this.peerId=t.sid,this.isPersistent=r,this.hasPersistentMessage=r,Et[n.id]}setMessagePersistence(e){if(!Sr(e))throw ct.throwError(Ne.MESSAGING.PERSISTENCE.ERRORS.FAILED_SETTING_PERSISTENCE,Ne.MESSAGING.PERSISTENCE.ERRORS.INVALID_TYPE);if(!this.hasPersistentMessage)throw this.isPersistent=e,ct.throwError(Ne.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);this.isPersistent=e,Lr(E({room:this.room,isPersistent:this.isPersistent,peerInfo:Ue(this.room),peerId:this.peerId}));}getMessagePersistence(){return this.isPersistent}sendMessage(e,t,n){const r=hr(e),i=!n||Array.isArray(n)&&ar(n);if(gr(t,"message","sendMessage")&&r)try{jr.log.DEBUG([null,ge.ASYNC_MESSAGING,null,Ne.MESSAGING.PERSISTENCE.SEND_MESSAGE]);const s=new pt(r);if(!i)throw new Error(Ne.MESSAGING.PERSISTENCE.ERRORS.PRIVATE_MESSAGE);s.canEncrypt(!0)&&s.sendMessage(e,t,n,this.isPersistent);}catch(e){ct.throwError(Ne.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message);}}getStoredMessages(){const e=Hi.getSkylinkState(this.room.id);this.hasPersistentMessage?(new Vn).getStoredMessages(e):jr.log.WARN([this.peerId,ge.ASYNC_MESSAGING,null,`${Ne.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED}`]);}canPersist(){if(this.hasPersistentMessage)return !!this.isPersistent||(jr.log.DEBUG([null,ge.ASYNC_MESSAGING,null,Ne.MESSAGING.PERSISTENCE.NOT_PERSISTED]),!1);if(this.isPersistent)throw jr.log.DEBUG([null,ge.ASYNC_MESSAGING,null,`${Ne.MESSAGING.PERSISTENCE.IS_PERSISTENT_CONFIG} ${this.isPersistent}`]),new Error(Ne.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);return !1}static processStoredMessages(e){const t=Hi.getSkylinkState(e.rid),{room:n}=t,r=e.mid,i=JSON.parse(e.data),s=new pt(t),o=[];jr.log.DEBUG([r,ge.ASYNC_MESSAGING,null,Ne.MESSAGING.PERSISTENCE.STORED_MESSAGES],i);try{for(let e=0;e<i.length;e+=1)i[e].data=s.decryptStoredMessages(i[e].data,i[e].secretId),o.push(St.parseDecryptedMessageData(i[e],r));}catch(e){throw ct.throwError(Ne.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}Lr(p({room:n,storedMessages:o,isSelf:!1,peerId:r,peerInfo:Ke.getPeerInfo(r,n)}));}static deleteAsyncInstance(e){delete Et[e.id];}}class mt{static sendMessage(e,t,n){const r=hr(e);if(gr(t,"message","sendMessage")&&r){const i=new pt(r),s=new gt(r);s.canPersist()?s.sendMessage(e,t,n):i.canEncrypt()?i.sendMessage(e,t,n):dt.trySendMessage(r,t,n);}}static sendP2PMessage(e,t,n){const r=hr(e);gr(t,"message","sendP2PMessage")&&r&&ei.sendP2PMessage(e,t,n);}static processMessage(e,t){const{mid:n,target:r,rid:i,secretId:s,data:o}=e,a=Hi.getSkylinkState(i),c=n;let d=o;if(s)try{d=new pt(a).decryptMessage(o,s);}catch(e){ct.throwError(Ne.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message);}dt.dispatchOnIncomingMessage(a,{isPrivate:Sr(t)?!t:!!r},d,!1,c);}}const ft=()=>{const e={fulfilled:!0,message:""},{AdapterJS:t,io:n,fetch:r}=window;return "function"!=typeof(t||window.AdapterJS||window.AdapterJS||{}).webRTCReady?(e.message=Ne.INIT.ERRORS.NO_ADAPTER,e.fulfilled=!1,e.readyStateChangeErrorCode=Q.ADAPTER_NO_LOADED):n||window.io?r&&window.fetch||(e.message=Ne.INIT.ERRORS.NO_FETCH_SUPPORT,e.fulfilled=!1,e.readyStateChangeErrorCode=Q.NO_XMLHTTPREQUEST_SUPPORT):(e.message=Ne.INIT.ERRORS.NO_SOCKET_IO,e.fulfilled=!1,e.readyStateChangeErrorCode=Q.NO_SOCKET_IO),e.fulfilled||jr.log.ERROR(["Validating Dependencies",null,null,e.message]),e},ht={udp:[3478,19302,19303,19304],tcp:[80,443],both:[19305,19306,19307,19308]},Rt={STUN:"stun",TURN:"turn",TEMASYS:"temasys",DEFAULT_TURN_SERVER:"turn.temasys.io",TCP:"TCP",UDP:"UDP"},Tt=(e,t)=>{const{urls:n}=e;return [{urls:n,username:t.iceServers[1].username||null,credential:t.iceServers[1].credential||null}]},Ct=()=>ht;class It extends ze{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:!1,candidate_id:null,candidate_sdp_mid:null,candidate_sdp_mindex:null,candidate_candidate:null,error:null};}send(e,t,n,r,i,s){const o=Hi.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=n,this.model.client_id=o.clientId,this.model.state=t,this.model.is_remote=!!r,this.model.candidate_id=r||null,this.model.candidate_sdp_mid=i.sdpMid,this.model.candidate_sdp_mindex=i.sdpMLineIndex,this.model.candidate_candidate=i.candidate,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.error=("string"==typeof s?s:s&&s.message)||null,this.addToStatsBuffer("iceCandidate",this.model,this.endpoints.iceCandidate),this.manageStatsBuffer();}}const _t=new It,vt=(e,t,n,r,i,s)=>{const{STATS_MODULE:o,ICE_CANDIDATE:a}=Ne,{CANDIDATE_PROCESSING_STATE:c,TAGS:d}=De;jr.log.ERROR([t,d.CANDIDATE_HANDLER,`${n}:${r}`,a.CANDIDATE_HANDLER.FAILED_ADDING_CANDIDATE],s),Lr(f({room:e,state:c.PROCESS_ERROR,peerId:t,candidateId:n,candidateType:r,candidate:i,error:s})),_t.send(e.id,o.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,t,n,i,s);};const Ot=new class extends ze{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,bundlePolicy:null,rtcpMuxPolicy:null};}send(e,t,n,r){const i=Hi.getSkylinkState(e);this.model.client_id=i.clientId,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.peer_id=n,this.model.state=t,this.model.is_remote=r,this.model.bundlePolicy=i.peerConnectionConfig.bundlePolicy,this.model.rtcpMuxPolicy=i.peerConnectionConfig.rtcpMuxPolicy,this.addToStatsBuffer("iceGathering",this.model,this.endpoints.iceGathering),this.manageStatsBuffer();}},At={setIceServers:e=>{const t=Hi.getInitOptions(),n={iceServerName:null,iceServerPorts:Ct(),iceServerProtocol:Rt.STUN,iceServers:[{urls:[]},{urls:[]}]},{iceServer:r,enableTURNServer:i,forceTURNSSL:s,TURNServerTransport:o,enableSTUNServer:a,usePublicSTUN:c}=t;if(e.forEach(e=>{if(0===e.url.indexOf(`${Rt.STUN}:`))e.url.indexOf(`${Rt.TEMASYS}`)>0?n.iceServerName=(e.url.split(":")[1]||"").split("?")[0]||null:n.iceServers[0].urls.push(e.url);else if(0===e.url.indexOf("turn:")&&e.url.indexOf("@")>0&&e.credential&&!n.iceServers[1].username&&!n.iceServers[1].credential){const t=(e.url.split(":")[1]||"").split("@");n.iceServerName=(t[1]||"").split("?")[0],n.iceServers[1].username=t[0],n.iceServers[1].credential=e.credential,n.iceServerProtocol=Rt.TURN;}}),r)return {iceServers:Tt(r,n)};if(n.iceServerName=n.iceServerName||Rt.DEFAULT_TURN_SERVER,n.iceServerProtocol!==Rt.TURN||i||s){const e=(e=>{const{forceTURNSSL:t,CONSTANTS:n,serverConfig:r}=e,{AdapterJS:i}=window,s={tcp:r.iceServerPorts.tcp,udp:r.iceServerPorts.udp,both:r.iceServerPorts.both,iceServerProtocol:r.iceServerProtocol,iceServerPorts:r.iceServerPorts};return "edge"===i.webrtcDetectedBrowser?(s.tcp=[],s.udp=[3478],s.iceServerPorts.both=[],s.iceServerProtocol=n.TURN):t?"firefox"===i.webrtcDetectedBrowser&&i.webrtcDetectedVersion<53?(s.udp=[],s.tcp=[443],s.both=[],s.iceServerProtocol=n.TURN):(s.iceServerPorts.udp=[],s.iceServerProtocol="turns"):"firefox"===i.webrtcDetectedBrowser&&(s.udp=[3478],s.tcp=[443,80],s.both=[]),s})({forceTURNSSL:s,enableTURNServer:i,CONSTANTS:Rt,serverConfig:n});n.iceServerPorts.tcp=e.tcp,n.iceServerPorts.udp=e.udp,n.iceServerPorts.both=e.both,n.iceServerProtocol=e.iceServerProtocol;}else n.iceServerProtocol=Rt.STUN;const d=(e=>{const{TURNServerTransport:t,forceTURNSSL:n,udp:r,tcp:i,both:s}=e,o={udp:[],tcp:[],both:[]};return t!==V.UDP||n?t===V.TCP?(o.tcp=i.concat(s),o.udp=[],o.both=[]):t===V.NONE?(o.tcp=[],o.udp=[]):(o.tcp=i,o.udp=r,o.both=s):(o.udp=r.concat(s),o.tcp=[],o.both=[]),o})({forceTURNSSL:s,TURNServerTransport:o,udp:n.iceServerPorts.udp,tcp:n.iceServerPorts.tcp,both:n.iceServerPorts.both});return n.iceServerPorts.tcp=d.tcp,n.iceServerPorts.udp=d.udp,n.iceServerPorts.both=d.both,n.iceServerProtocol===Rt.STUN&&(n.iceServerPorts.tcp=[]),n.iceServerProtocol!==Rt.STUN||a?(n.iceServerPorts.tcp.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}?transport=tcp`);}),n.iceServerPorts.udp.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}?transport=udp`);}),n.iceServerPorts.both.forEach(e=>{n.iceServers[1].urls.push(`${n.iceServerProtocol}:${n.iceServerName}:${e}`);}),c||n.iceServers.splice(0,1),{iceServers:n.iceServers}):(n.iceServers=[],null)},addIceCandidateFromQueue:(e,t)=>{const n=Hi.getSkylinkState(t.id),r=n.peerCandidatesQueue[e]||[],i=n.peerConnections[e],{AdapterJS:s}=window,{TAGS:o,PEER_CONNECTION_STATE:a}=De;for(let t=0;t<r.length;t+=1){const c=r[t];if(c){const t=c[1],r=c[0],i=t.candidate.split(" ")[7];jr.log.DEBUG([e,o.CANDIDATE_HANDLER,`${r}:${i}`,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.ADD_BUFFERED_CANDIDATE]),yt.addIceCandidate(e,r,i,t,n);}else if(i&&i.signalingState!==a.CLOSED&&s&&Rr(s.VERSION,"0.14.0"))try{i.addIceCandidate(null),jr.log.DEBUG([e,o.CANDIDATE_HANDLER,null,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.END_OF_CANDIDATES_SUCCESS]);}catch(t){jr.log.DEBUG([e,o.CANDIDATE_HANDLER,null,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.END_OF_CANDIDATES_FAILURE]);}}delete n.peerCandidatesQueue[e],ei.signalingEndOfCandidates(e,n);},addIceCandidate:(e,t,n,r,i)=>{const s=Hi.getSkylinkState(i.room.id),{peerConnections:o,room:a}=s,c=o[e],d={candidate:r.candidate,sdpMid:r.sdpMid,sdpMLineIndex:r.sdpMLineIndex},{STATS_MODULE:l,ICE_CANDIDATE:u,PEER_CONNECTION:p}=Ne,{CANDIDATE_PROCESSING_STATE:S,PEER_CONNECTION_STATE:E,TAGS:g}=De;jr.log.DEBUG([e,g.CANDIDATE_HANDLER,`${t}:${n}`,u.CANDIDATE_HANDLER.ADDING_CANDIDATE]),Lr(f({peerId:e,room:a,candidateType:n,candidate:d,candidateId:t,state:S.PROCESSING,error:null})),_t.send(a.id,l.HANDLE_ICE_GATHERING_STATS.PROCESSING,e,t,d),c&&c.signalingState!==E.CLOSED&&c.remoteDescription&&c.remoteDescription.sdp&&c.remoteDescription.sdp.indexOf(`\r\na=mid:${d.sdpMid}\r\n`)>-1||(jr.log.WARN([e,g.CANDIDATE_HANDLER,`${t}:${n}`,`${u.CANDIDATE_HANDLER.DROPPING_CANDIDATE} - ${p.NO_PEER_CONNECTION}`]),Lr(f({peerId:e,room:i.room,candidateType:n,candidate:d,candidateId:t,state:B.DROPPED,error:new Error(p.NO_PEER_CONNECTION)})),_t.send(a.id,l.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,e,t,d,p.NO_PEER_CONNECTION));try{c.addIceCandidate(d).then(()=>{((e,t,n,r,i)=>{const{STATS_MODULE:s,ICE_CANDIDATE:o}=Ne,{CANDIDATE_PROCESSING_STATE:a,TAGS:c}=De;jr.log.INFO([t,c.CANDIDATE_HANDLER,`${n}:${r}`,o.CANDIDATE_HANDLER.CANDIDATE_ADDED]),Lr(f({room:e,state:a.PROCESS_SUCCESS,peerId:t,candidateId:n,candidateType:r,candidate:i,error:null})),_t.send(e.id,s.HANDLE_ICE_GATHERING_STATS.PROCESS_SUCCESS,t,n,i);})(a,e,t,n,d);}).catch(r=>{vt(a,e,t,n,d,r);});}catch(r){vt.bind(c,a,e,t,n,d,r);}},onIceCandidate:(e,t,n)=>{const r=Hi.getSkylinkState(n.id),i=Hi.getInitOptions(),s=r.peerConnections[e],o=new Vn;let a=r.gatheredCandidates[e];const{CANDIDATE_GENERATION_STATE:c,TAGS:d}=De;if(!s)return jr.log.WARN([e,d.CANDIDATE_HANDLER,null,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.no_peer_connection],t),null;if(t.candidate){s.gathering||(jr.log.WARN([e,d.CANDIDATE_HANDLER,null,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.ICE_GATHERING_STARTED],t),s.gathering=!0,s.gathered=!1,Lr(h({room:n,peerId:e,state:x.GATHERING})),Ot.send(n.id,c.GATHERING,e,!1));const l=t.candidate.split(" ")[7];if(jr.log.DEBUG([e,d.CANDIDATE_HANDLER,l,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.CANDIDATE_GENERATED],t),"endOfCandidates"===l||!(s&&s.localDescription&&s.localDescription.sdp&&s.localDescription.sdp.indexOf(`\r\na=mid:${t.sdpMid}\r\n`)>-1))return jr.log.WARN([e,d.CANDIDATE_HANDLER,l,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.DROP_EOC],t),null;if(i.filterCandidatesType[l]){if(!r.hasMCU||!i.forceTURN)return jr.log.WARN([e,d.CANDIDATE_HANDLER,l,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.FILTERED_CANDIDATE],t),null;jr.log.WARN([e,d.CANDIDATE_HANDLER,l,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.FILTERING_FLAG_NOT_HONOURED],t);}a||(a={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),a.sending[l].push({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),r.gatheredCandidates[e]=a,Hi.setSkylinkState(r,n.id),jr.log.DEBUG([e,d.CANDIDATE_HANDLER,l,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.SENDING_CANDIDATE],t),o.sendCandidate(e,r,t);}else{if(jr.log.INFO([e,d.CANDIDATE_HANDLER,null,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.ICE_GATHERING_COMPLETED]),s.gathered)return null;if(s.gathering=!1,s.gathered=!0,Lr(h({peerId:e,state:x.COMPLETED,room:n})),Ot.send(n.id,c.COMPLETED,e,!1),r.gatheredCandidates[e]){setTimeout(()=>{r.gatheredCandidates[e]&&o.sendMessage({type:de.END_OF_CANDIDATES,noOfExpectedCandidates:r.gatheredCandidates[e].sending.srflx.length+r.gatheredCandidates[e].sending.host.length+r.gatheredCandidates[e].sending.relay.length,mid:r.user.sid,target:e,rid:n.id});},6e3);}}return null},addIceCandidateToQueue:(e,t,n,r,i)=>{const{STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:s}}=Ne,o=i,{room:a}=o,c=new It;jr.log.DEBUG([e,ge.CANDIDATE_HANDLER,`${t}:${n}`,Ne.ICE_CANDIDATE.CANDIDATE_HANDLER.ADD_CANDIDATE_TO_BUFFER]),c.send(a.id,s.BUFFERED,e,t,r),Lr(f({room:a,state:B.BUFFERED,peerId:e,candidateId:t,candidateType:n,candidate:r.candidate,error:null})),o.peerCandidatesQueue[e]=o.peerCandidatesQueue[e]||[],o.peerCandidatesQueue[e].push([t,r]),Hi.setSkylinkState(o,a.id);}};class yt{static setIceServers(e){return At.setIceServers(e)}static addIceCandidateFromQueue(e,t){return At.addIceCandidateFromQueue(e,t)}static addIceCandidateToQueue(e,t,n,r,i){return At.addIceCandidateToQueue(e,t,n,r,i)}static addIceCandidate(e,t,n,r,i){return At.addIceCandidate(e,t,n,r,i)}static onIceCandidate(e,t,n){return At.onIceCandidate(e,t,n)}}const Dt={enterAndWelcome:e=>{const t=Hi.getSkylinkState(e.rid),n={},{hasMCU:r}=t,{rid:i,mid:s,enableIceRestart:o,enableDataChannel:a,weight:c,receiveOnly:d,publishOnly:l,agent:u,os:p,temasysPluginVersion:S,SMProtocolVersion:E,DTProtocolVersion:g,version:m,parentId:f,publisherId:h}=e;return n.publisherId=h||null,n.rid=i,n.mid=s,n.agent=u&&Er(u)?u:"other",n.version=(e=>{if(!e||"string"!=typeof e)return 0;if(e.indexOf(".")>-1){const t=e.split(".");if(t.length>2){const e=t[0]||"0";return t.splice(0,1),parseFloat(`${e}.${t.join("0")}`,10)}return parseFloat(e||"0",10)}return parseInt(e||"0",10)})(m),n.SMProtocolVersion=Er(E)?E:ne,n.DTProtocolVersion=Er(g)?g:r||s===_e.MCU?G:"0.1.0",n.weight=ur(c)?c:0,n.receiveOnly=d&&!1!==d,n.enableDataChannel=!Sr(a)||a,n.enableIceRestart=!!Sr(o)&&o,n.os=p&&Er(p)?p:null,n.temasysPluginVersion=S&&Er(S)?S:null,n.publishOnly=!!l,n.parentId=l&&f&&Er(f)?f:null,n.userInfo=Dt.parseUserInfo(t,e,n),r&&(n.peersInRoom=e.peersInRoom),Pe(n)},parseUserInfo:(e,t,n)=>{const r=Object.assign({},t.userInfo);return r.config=r.config?r.config:{enableDataChannel:n.enableDataChannel,enableIceRestart:n.enableIceRestart,priorityWeight:n.weight,receiveOnly:n.receiveOnly,publishOnly:n.publishOnly},r.agent=r.agent?r.agent:{name:n.agent,version:n.version,os:n.os,pluginVersion:n.temasysPluginVersion,SMProtocolVersion:n.SMProtocolVersion,DTProtocolVersion:n.DTProtocolVersion},r.settings=r.settings?r.settings:{},r.mediaStatus=r.mediaStatus?r.mediaStatus:{},r}},Nt=(e,t,n)=>{const{room:r}=e;e.peerInformations[t]=ei.buildPeerInformations(n,e),Hi.setSkylinkState(e,r.id);},Pt=e=>{const{currentRoom:t,targetMid:n,cert:r,userInfo:i,message:o,caller:a}=e;let c=!1;const d=Hi.getSkylinkState(t.id),{hasMCU:l}=d,{peerInformations:u}=d;if(!u[n]&&!l||l&&n===_e.MCU&&!u.MCU){const e=!!i.screenshare;c=!0,d.peerInformations[n]=ei.buildPeerInformations(o.userInfo,d);const a={agent:i.agent.name,version:i.agent.version,os:i.agent.os};Hi.setSkylinkState(d,t.id),ei.addPeer({currentRoom:t,targetMid:n,peerBrowser:a,cert:r,receiveOnly:o.receiveOnly,hasScreenshare:e}),n===_e.MCU?(jr.log.INFO([n,"RTCPeerConnection",null,"MCU feature has been enabled"]),d.hasMCU=!0,Lr(((e={})=>new s("serverPeerJoined",{detail:e}))({peerId:n,serverPeerType:H.MCU,room:t}))):Lr(C({peerId:n,peerInfo:Ke.getPeerInfo(n,t),isSelf:!1,room:t}));}if(d.peerMessagesStamps[n]=d.peerMessagesStamps[n]||{userData:0,audioMuted:0,videoMuted:0},a===wt.WELCOME&&(d.peerMessagesStamps[n].hasWelcome=!1),a===wt.WELCOME&&l&&Array.isArray(o.peersInRoom)&&o.peersInRoom.length){const e=d.user.sid;for(let n=0;n<o.peersInRoom.length;n+=1){const r=o.peersInRoom[n].mid;if(r!==e){const e=Dt.enterAndWelcome(o.peersInRoom[n]).userInfo;Nt(d,r,e),Lr(C({peerId:r,peerInfo:Ke.getPeerInfo(r,t),isSelf:!1,room:t}));}}}else l&&n!==d.user.sid&&n!==_e.MCU&&(Nt(d,n,i),Lr(C({peerId:n,peerInfo:Ke.getPeerInfo(n,t),isSelf:!1,room:t})));Hi.setSkylinkState(d,t.id),c&&Lr(g({peerId:n,state:z.WELCOME,error:null,room:t}));};const Mt=new class extends ze{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,weight:null,sdp_type:null,sdp_sdp:null,error:null};}send(e,t,n,r,i,s){const o=Hi.getSkylinkState(e);this.model.client_id=o.clientId,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=n,this.model.state=t,this.model.is_remote=i,this.model.weight=r.weight||null,this.model.error=("string"==typeof s?s:s&&s.msg)||null,this.model.sdp_type=null,this.model.sdp_sdp=null,-1===["enter","welcome"].indexOf(this.model.state)&&(this.model.weight=this.model.is_remote&&Ke.getPeerInfo(this.model.peer_id,o.room).config&&Ke.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight?Ke.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight:Ke.getCurrentSessionInfo(o.room).config.priorityWeight,this.model.sdp_type=r&&r.type||null,this.model.sdp_sdp=r&&r.sdp||null),this.addToStatsBuffer("negotiation",this.model,this.endpoints.negotiation),this.manageStatsBuffer();}},wt={ENTER:"enterHandler",WELCOME:"welcomeHander"},bt=e=>{const{currentRoom:t,targetMid:n,message:r}=e,i=Hi.getSkylinkState(t.id),{peerConnections:s,hasMCU:o}=i,{STATS_MODULE:a,NEGOTIATION_PROGRESS:c}=Ne,d=new Vn,l=(e=>{let t="welcome";if(e.caller===wt.WELCOME){const n=Hi.getSkylinkState(e.currentRoom.id),{peerMessagesStamps:r,peerPriorityWeight:i,hasMCU:s}=n;(s||i>e.message.weight)&&(r[e.targetMid].hasWelcome?(t="noop",jr.log.WARN([e.targetMid,"RTCPeerConnection",null,'Discarding extra "welcome" received.'])):(t="offer",n.peerMessagesStamps[e.targetMid].hasWelcome=!0,Hi.setSkylinkState(n,e.currentRoom.id)));}return t})(e);if("offer"===l){if(!s[n])return jr.log.WARN([n,"RTCSessionDescription","offer",c.ERRORS.no_peer_connection]),Mt.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,n,r,!1,c.ERRORS.no_peer_connection),null;const{signalingState:i}=s[n];if(i!==j.STABLE)return jr.log.WARN([n,"RTCSessionDescription","offer",c.ERRORS.NOT_STABLE],i),Mt.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,n,r,!1,c.ERRORS.NOT_STABLE),null;d[l](e.currentRoom,e.targetMid);}else o||d[l](e.currentRoom,e.targetMid);},kt=(e,t)=>{const n=Dt.enterAndWelcome(e),{rid:r,mid:i,userInfo:s,publisherId:o}=n,a=Hi.getSkylinkState(r),{hasMCU:c}=a,d=c&&o?o:i,{RTCPeerConnection:l}=window;((e,t,n,r)=>{const{room:i}=n;let s="enter";e===wt.WELCOME&&(s="welcome"),jr.log.INFO([t,"RTCPeerConnection",null,`Peer ${s} received ->`],r),Mt.send(i.id,s,t,r,!0);})(t,d,a,n);let u="enter";if(t===wt.WELCOME&&(u="welcome"),d!==_e.MCU&&c&&a.publishOnly)return void jr.log.WARN([d,"RTCPeerConnection",null,`Discarding ${u} for publishOnly case -> `],e);const p={currentRoom:a.room,targetMid:d,userInfo:s,message:n,caller:t};if(a.peerConnectionConfig.certificate!==Y.AUTO&&"function"==typeof l.generateCertificate){let e={};e=a.peerConnectionConfig.certificate===Y.ECDSA?{name:"ECDSA",namedCurve:"P-256"}:{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},l.generateCertificate(e).then(e=>{p.cert=e,Pt(p),bt(p);});}else Pt(p),bt(p);},Lt=(e,t,n,r)=>{const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:i}}=Ne,{peerConnections:s,bufferedLocalOffer:o,room:a}=e,c=s[t],d="offer"===n.type?"OFFER":"ANSWER";Mt.send(a.id,i[d].set,t,n,r),r&&Lr(g({state:z[d],peerId:t,room:a})),r?("offer"===n.type?c.setOffer="remote":c.setAnswer="remote",yt.addIceCandidateFromQueue(t,a)):(o[t]=null,"offer"===n.type?c.setOffer="local":c.setAnswer="local"),Hi.setSkylinkState(e,a.id);},Ut=(e,t,n,r,i)=>{const{room:s,user:o}=e,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:a}}=Ne,c="offer"===n.type?"OFFER":"ANSWER";Mt.send(s.id,a[c].set_error,t,n,r,i),Lr(g({state:z.ERROR,peerId:r?t:o.sid,error:i,room:s}));},Gt=(e,t,n)=>{const r=Hi.getSkylinkState(e.id),{peerConnections:i}=r,{type:s}=n,o=i[t],{STATS_MODULE:a}=Ne,c="offer"===s?"OFFER":"ANSWER";return o.processingLocalSDP=!0,Mt.send(e.id,a.HANDLE_NEGOTIATION_STATS[c][s],t,n,!1),o.setLocalDescription(n).then(()=>o)},xt=(e,t,n,r)=>{const i=Hi.getSkylinkState(t.id),{peerConnections:s}=i,{NEGOTIATION_PROGRESS:o}=Ne,a=s[n]=e;jr.log.DEBUG([n,ge.SESSION_DESCRIPTION,r.type,o.SET_LOCAL_DESCRIPTION],r),a.processingLocalSDP=!1,Lt(i,n,r,!1);},Bt=(e,t,n,r)=>{const i=Hi.getSkylinkState(e.id),{peerConnections:s}=i,o=s[t],{NEGOTIATION_PROGRESS:a}=Ne;jr.log.ERROR([t,ge.SESSION_DESCRIPTION,n.type,a.FAILED_SET_LOCAL_DESCRIPTION],r),o.processingLocalSDP=!1,o.negotiating=!1,Ut(i,t,n,!1,r);},Ft=(e,t,n)=>{const r=Hi.getSkylinkState(e.id),{peerConnections:i}=r,{type:s}=n,{STATS_MODULE:o,NEGOTIATION_PROGRESS:a}=Ne,c=i[t],d="offer"===s?"OFFER":"ANSWER";c.processingRemoteSDP=!0,Mt.send(e.id,o.HANDLE_NEGOTIATION_STATS[d][s],t,n,!0);const l=((e,t,n)=>{const r=t;return r.sdp=Yr.setSDPBitrate(e,r,n),r})(t,n,e.id);return c.setRemoteDescription(l).then(()=>c)},Vt=(e,t,n)=>{const r=e;r.peerConnections[t].negotiating=!1,Hi.setSkylinkState(r,t),(new Vn).answerAck(e,t,n);},jt=(e,t,n,r)=>{const i=new Vn,{type:s}=r,{NEGOTIATION_PROGRESS:o,DATA_CHANNEL:a}=Ne,c=Hi.getSkylinkState(t.id),{peerConnections:d}=c,l=d[n]=e;return jr.log.DEBUG([n,ge.SESSION_DESCRIPTION,s,o.SET_REMOTE_DESCRIPTION],r),l.processingRemoteSDP=!1,"offer"===s?(Lt(c,n,r,!0),i.answer(c,n)):(c.peerMessagesStamps[n]&&(c.peerMessagesStamps[n].hasRestart=!1),c.dataChannels[n]&&(-1===l.remoteDescription.sdp.indexOf("m=application")||l.remoteDescription.sdp.indexOf("m=application 0")>0)&&(jr.log.WARN([n,ge.PEER_CONNECTION,null,`${a.CLOSING} - ${a.NO_REMOTE_DATA_CHANNEL}`]),ei.closeDataChannel(c,n)),Lt(c,n,r,!0),Vt(c,n,!0),!0)},Wt=(e,t,n,r)=>{const i=Hi.getSkylinkState(e.id),{peerConnections:s}=i,o=s[t],{type:a}=n;jr.log.ERROR([t,ge.SESSION_DESCRIPTION,a,`${Ne.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_DESCRIPTION} ->`],{error:r,state:o.signalingState,[a]:n}),o.processingRemoteSDP=!1,o.negotiating=!1,Ut(i,t,n,!0,r),"answer"===a&&Vt(i,t,!1);},Ht=e=>{const{rid:t,mid:n,type:r,sdp:i,mediaInfoList:s}=e,o=Hi.getSkylinkState(t),{hasMCU:a,room:c,bufferedLocalOffer:d}=o,l=n,u="offer"===r?"OFFER":"ANSWER",{NEGOTIATION_PROGRESS:p}=Ne;if(jr.log.INFO([l,null,r,`Received ${r} from peer. ${u}:`],e),((e,t)=>{const{weight:n,type:r,mid:i,sdp:s,resend:o}=t,{peerPriorityWeight:a,bufferedLocalOffer:c,room:d,peerConnections:l}=e,u=i,{processingRemoteSDP:p,processingLocalSDP:S,negotiating:E}=l[u],{STATS_MODULE:g,NEGOTIATION_PROGRESS:m,NO_PEER_CONNECTION:f}=Ne,h="offer"===r?"OFFER":"ANSWER";let R=null;if(l[u]||(jr.log.ERROR([u,null,r,`${f.NO_PEER_CONNECTION}. Unable to set${"offer"===r?"Remote":"Local"}Offer.`]),R=f.NO_PEER_CONNECTION),"offer"===r&&l[u].signalingState!==j.STABLE&&(jr.log.WARN([u,null,r,m.ERRORS.NOT_STABLE],{signalingState:l[u].signalingState,isRestart:!!o}),R=`Peer connection state is ${l[u].signalingState}.`),"offer"===r&&c[u]&&a>n&&(jr.log.WARN([u,null,r,m.ERRORS.OFFER_TIEBREAKER],{selfWeight:a,messageWeight:n}),R=m.ERRORS.OFFER_TIEBREAKER),p)jr.log.WARN([u,ge.SESSION_DESCRIPTION,r,m.ERRORS.PROCESSING_EXISTING_SDP],s),R=m.ERRORS.PROCESSING_EXISTING_SDP;else if(!S&&!p&&E&&"offer"===r){const n=e;jr.log.DEBUG([u,ge.SESSION_DESCRIPTION,r,m.ERRORS.ADDING_REMOTE_OFFER_TO_BUFFER],t),n.bufferedRemoteOffers[u]=n.bufferedRemoteOffers[u]?n.bufferedRemoteOffers[u]:[],n.bufferedRemoteOffers[u].push(t),Hi.setSkylinkState(n,d.id);}return R&&Mt.send(d.id,g.HANDLE_NEGOTIATION_STATS[h].dropped,u,t,!0,R),!R})(o,e))try{if(((e,t)=>{const n=e,{userInfo:r,rid:i,mid:s}=t,o=r,a=s;r&&"object"==typeof r&&(o.settings.data=!!(n.dataChannels[a]&&n.dataChannels[a].main&&n.dataChannels[a].main.channel&&n.dataChannels[a].main.channel.readyState===b.OPEN),n.peerInformations[a].settings=o.settings||{},n.peerInformations[a].mediaStatus=o.mediaStatus||{},n.peerInformations[a].userData=o.userData),n.peerConnections[a].negotiating=!0,Hi.setSkylinkState(n,i);})(o,e),Wn.setPeerMediaInfo(c,l,s),Wn.deleteUnavailableMedia(c,l),"offer"===r){let e=null;const t={type:r,sdp:a?i.replace(/\r\n/g,"\n").split("\n").join("\r\n"):i};Ft(c,l,t).then(e=>jt(e,c,l,t)).catch(e=>Wt(c,l,t,e)).then(t=>(e={type:t.type,sdp:t.sdp},Gt(c,l,e))).then(t=>xt(t,c,l,e)).catch(t=>Bt(c,l,e,t));}else if(d[l]){const e=d[l],t={type:r,sdp:a?i.replace(/\r\n/g,"\n").split("\n").join("\r\n"):i};Gt(c,l,e).then(t=>xt(t,c,l,e)).catch(t=>Bt(c,l,e,t)).then(()=>Ft(c,l,t)).then(e=>jt(e,c,l,t)).catch(e=>Wt(c,l,t,e));}else jr.log.ERROR([l,ge.PEER_CONNECTION,null,p.ERRORS.NO_LOCAL_BUFFERED_OFFER]);}catch(e){jr.log.ERROR([l,ge.SESSION_DESCRIPTION,r,`Failed processing ${u} ->`],e);}return null},Kt=(e,t,n)=>{const r={};return r.listOfPeers=e,r.refreshErrors=t,r.refreshSettings=n,r},$t=(e,t,n)=>{const r=[];return Object.keys(e).forEach(i=>{r.push(((e,t,n,r)=>{const i=Hi.getSkylinkState(t.id),{hasMCU:s,peerInformations:o,enableIceRestart:a}=i,c=Ke.getPeersCustomSettings(i),d={};return d[e]={iceRestart:!s&&o[e]&&o[e].config&&o[e].config.enableIceRestart&&a&&n,customSettings:c[e]||{}},r&&(d.errors=r),d})(e[i],t,n));}),r},Yt=(e,t)=>{const n={};return n[e]=t,n},zt=(e,t,n,r)=>new Promise((i,s)=>{e||s(new Error(Ne.ROOM_STATE.NO_ROOM_NAME));const{peerConnections:o,hasMCU:a,room:c}=e,d=Hi.getInitOptions(),{mcuUseRenegoRestart:l}=d,{PEER_CONNECTION:u}=Ne,p=((e,t,n,r)=>{let i=!1,s={},o=Object.keys(r);return Array.isArray(e)?o=e:Er(e)?o=[e]:Sr(e)?i=e:e&&dr(e)&&(s=e),Sr(t)?i=t:t&&dr(t)&&(s=t),n&&dr(n)&&(s=n),{listOfPeers:o,doIceRestart:i,bwOptions:s}})(t,n,r,o),{listOfPeers:S,doIceRestart:E,bwOptions:g}=p;try{!ar(S)||a&&!l||(jr.log.ERROR(u.refresh_no_peer_connection),s({refreshErrors:{self:u.refresh_no_peer_connection},listOfPeers:S})),jr.log.INFO([null,"PeerConnection",null,u.refresh_start]),ei.refreshPeerConnection(S,e,E,g).then(e=>{const t=a?[e]:e,n=[];for(let e=0;e<t.length;e+=1)if(Array.isArray(t[e])){const r=t[e];n.push(Yt(r[0],r[1])),jr.log.WARN([S,"PeerConnection",null,u.refresh_peer_failed],r[0]);}else"string"==typeof t[e]&&jr.log.INFO([S,"PeerConnection",null,u.refresh_peer_success],t[e]);n.length===S.length?s(Kt(S,n,$t(S,c,E))):i(Kt(S,n,$t(S,c,E)));}).catch(e=>jr.log.ERROR([null,"RTCPeerConnection",null,u.refresh_failed],e)).finally(()=>jr.log.INFO(u.refresh_completed));}catch(e){s(e);}});class Jt extends ze{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,contents:null};}send(e,t){const n=Hi.getSkylinkState(e);this.model.room_id=e,this.model.user_id=n&&n.user&&n.user.sid||null,this.model.client_id=n.clientId,this.model.state=t.type,this.model.contents=t,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.session,this.model);}}class Xt extends ze{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,local_candidate:{},remote_candidate:{}};}send(e,t,n){try{const r=Hi.getSkylinkState(e);if(!r)return;this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.peer_id=n,this.model.client_id=r.clientId,this.model.state=t,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),ei.retrieveStatistics(e,n,Hi.getInitOptions().beSilentOnStatsLogs).then(e=>{e&&["local","remote"].forEach(t=>{const n=e.selectedCandidatePair[t];if(n){const e=this.model[`${t}_candidate`];e.ip_address=n.ipAddress||null,e.port_number=n.portNumber||null,e.candidate_type=n.candidateType||null,e.protocol=n.transport||null,e.priority=n.priority||null,"local"===t&&(this.model.local_candidate.network_type=n.networkType||null);}}),this.postStats(this.endpoints.iceConnection,this.model);}).catch(e=>{jr.log.DEBUG(Ne.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.RETRIEVE_FAILED,e);});}catch(e){jr.log.DEBUG(Ne.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.SEND_FAILED,e);}}}const qt=(e,t)=>{const n=Hi.getSkylinkState(e);n.peerConnections[t].signalingState!==j.CLOSED&&(n.peerConnections[t].close(),Dr(Ie.SAFARI)&&Nr(11)&&(((e,t)=>{const n=e;n.peerConnections[t].signalingStateClosed||(n.peerConnections[t].signalingStateClosed=!0,Lr(O({peerId:t,state:j.CLOSED})));})(n,t),((e,t)=>{const n=e;n.peerConnections[t].iceConnectionStateClosed||(n.peerConnections[t].iceConnectionStateClosed=!0,(new Xt).send(n.room.id,t,e),Lr(R({peerId:t,state:F.CLOSED})));})(n,t)));},Qt=(e,t)=>{const n=Hi.getSkylinkState(e);if(!((e,t)=>{const n=e;return !!n&&(!(!n.peerConnections[t]&&!n.peerInformations[t])||(jr.log.DEBUG([t,ge.PEER_CONNECTION,null,`${Ne.ROOM.LEAVE_ROOM.DROPPING_HANGUP} - ${Ne.PEER_CONNECTION.NO_PEER_CONNECTION}`]),!1))})(n,t))return;const{room:r}=n,i=Ke.getPeerInfo(t,r);if(t===_e.MCU){const e=n;return Lr(_({peerId:t,serverPeerType:H.MCU,room:r})),e.hasMCU=!1,void Hi.setSkylinkState(e,r.id)}Lr(I({peerId:t,peerInfo:i,isSelf:!1,room:r}));},Zt=(e,t,n,r,i)=>{const s=Hi.getSkylinkState(n.room.id),{peerConnections:o,peerConnectionConfig:a,bufferedLocalOffer:c,peerPriorityWeight:d,room:l}=s,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:u}}=Ne,{AdapterJS:p}=window,S=o[t],E={type:r.type,sdp:r.sdp};if(S.processingLocalSDP=!0,"firefox"===p.webrtcDetectedBrowser&&(Yr.setOriginalDTLSRole(s,E,!1),E.sdp=Yr.modifyDTLSRole(s,r)),a.disableBundle&&(E.sdp=E.sdp.replace(/a=group:BUNDLE.*\r\n/gi,"")),jr.log.INFO([t,"RTCSessionDescription",r.type,"Local session description updated ->"],E.sdp),r.type===z.OFFER){Mt.send(l.id,u.OFFER.offer,t,r,!1),jr.log.INFO([t,"RTCSessionDescription",r.type,"Local offer saved."]),c[t]=r;const o={type:E.type,sdp:E.sdp,mid:s.user.sid,target:t,rid:n.room.id,userInfo:Ke.getUserInfo(n.room),weight:d,mediaInfoList:Wn.retrieveMediaInfoForOfferAnswer(l,E)};if(i&&Object.keys(i).length){const e=Object.keys(i),t=Object.keys(o);for(let n=0;n<e.length;n+=1){const r=e[n];-1===t.indexOf(r)&&(o[r]=i[r]);}}e(o);}else{Mt.send(l.id,u.ANSWER.answer,t,r,!1),e({type:E.type,sdp:E.sdp,mid:s.user.sid,target:t,rid:n.room.id,userInfo:Ke.getUserInfo(n.room),mediaInfoList:Wn.retrieveMediaInfoForOfferAnswer(l,E)});}},{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:en}}=Ne,tn=e=>{let t=null;const{currentRoom:n,targetMid:r,cert:i,hasScreenShare:s}=e,o=Hi.getInitOptions(),{filterCandidatesType:a}=o,c=Hi.getSkylinkState(n.id),{peerConnectionConfig:d,room:l}=c,u={iceServers:c.room.connection.peerConfig.iceServers,iceTransportPolicy:a.host&&a.srflx&&!a.relay?"relay":"all",bundlePolicy:d.bundlePolicy===K.NONE?K.BALANCED:d.bundlePolicy,rtcpMuxPolicy:d.rtcpMuxPolicy,iceCandidatePoolSize:d.iceCandidatePoolSize},p={optional:[{DtlsSrtpKeyAgreement:!0},{googIPv6:!0}]};i&&(u.certificates=[i]),c.peerConnStatus[r]&&(c.peerConnStatus[r].constraints=u,c.peerConnStatus[r].optional=p),Hi.setSkylinkState(c,n.id);try{t=((e,t,n,r,i)=>{const s=Hi.getInitOptions(),o=Hi.getSkylinkState(i.id),{AdapterJS:a}=window;jr.log.DEBUG([e,"RTCPeerConnection",null,"Creating peer connection ->"],{constraints:t,optional:n});const{RTCPeerConnection:c,msRTCPeerConnection:d}=window,l=new(s.useEdgeWebRTC&&d?window.msRTCPeerConnection:c)(t,n),u=[l,e,o];return l.setOffer="",l.setAnswer="",l.negotiating=!1,l.hasStream=!1,l.hasMainChannel=!1,l.firefoxStreamId="",l.processingLocalSDP=!1,l.processingRemoteSDP=!1,l.gathered=!1,l.gathering=!1,l.localStream=null,l.localStreamId=null,l.iceConnectionStateClosed=!1,l.signalingStateClosed=!1,o.gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}},o.peerEndOfCandidatesCounter[e]=o.peerEndOfCandidatesCounter[e]||{},o.sdpSessions[e]={local:{},remote:{}},o.peerBandwidth[e]={},e===_e.MCU&&(jr.log.INFO("Creating an empty transceiver of kind video with MCU"),"function"==typeof l.addTransceiver&&l.addTransceiver("video")),Hi.setSkylinkState(o,i.id),"firefox"===a.webrtcDetectedBrowser&&(l.removeStream=(e=>{const{getSenders:t,removeTrack:n}=e;return e=>{const{getTracks:r}=e,i=t();for(let e=0;e<i.length;e+=1){const t=r();for(let r=0;r<t.length;r+=1)t[r]===i[e].track&&n(i[e]);}}})(l)),l.ontrack=Cn.ontrack.bind(l,...u),l.ondatachannel=Cn.ondatachannel.bind(l,...u),l.onicecandidate=Cn.onicecandidate.bind(l,...u),l.oniceconnectionstatechange=Cn.oniceconnectionstatechange.bind(l,...u),l.onsignalingstatechange=Cn.onsignalingstatechange.bind(l,...u),l.onicegatheringstatechange=Cn.onicegatheringstatechange.bind(l,...u),a.webrtcDetectedBrowser===Ie.REACT_NATIVE&&(l.onsenderadded=Cn.onsenderadded.bind(l,...u),l.onremovetrack=Cn.onremovetrack.bind(l,e,o.room,!1)),l})(r,u,p,0,n);}catch(e){jr.log.ERROR([r,null,null,"Failed creating peer connection:"],e),t=null,Lr(g({state:z.ERROR,peerId:r,error:e,room:l}));}return t},{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:nn}}=Ne,rn=(e,t,n,r,i)=>{const s=Hi.getSkylinkState(e.room.id),o=s.peerConnections[t],a=s.dataChannels[t];let c=r;if(c&&c!==t||(c="main"),!("object"==typeof n&&n||n&&"string"==typeof n))return jr.log.WARN([t,"RTCDataChannel",c,"Dropping invalid data ->"],n),null;if(!o||o.signalingState===j.CLOSED)return jr.log.WARN([t,"RTCDataChannel",c,"Dropping for sending message as Peer connection does not exists or is closed ->"],n),null;if(!a||!a[c])return jr.log.WARN([t,"RTCDataChannel",c,"Dropping for sending message as Datachannel connection does not exists ->"],n),null;const d=a[c].channelName,u=a[c].channelType,p=a[c].channel.readyState,S="object"==typeof n&&n.type===ce.MESSAGE?L.MESSAGE:L.TRANSFER;if(p!==b.OPEN){const e=new Error(`Failed sending message as Datachannel connection state is not opened. Current readyState is ${p}`);throw jr.log.ERROR([t,"RTCDataChannel",c,e],n),Lr(l({peerId:t,channelName:d,channelType:u,messageType:S,error:e,state:b.SEND_MESSAGE_ERROR,bufferAmount:ei.getDataChannelBuffer(a[c].channel)})),e}try{i||"object"!=typeof n?(jr.log.DEBUG([t,"RTCDataChannel",c,"Sending data with size ->"],n.size||n.length||n.byteLength),a[c].channel.send(n)):(jr.log.DEBUG([t,"RTCDataChannel",c,`Sending ${n.type} protocol message ->`],n),a[c].channel.send(JSON.stringify(n)));}catch(e){throw jr.log.ERROR([t,"RTCDataChannel",c,"Failed sending data)"],{error:e,data:n}),Lr(l({peerId:t,channelName:d,channelType:u,messageType:S,error:e,state:b.SEND_MESSAGE_ERROR,bufferAmount:ei.getDataChannelBuffer(a[c].channel)})),e}return null},sn=(e,t,n,r,i)=>{const s=Hi.getSkylinkState(e.room.id);let o=null,a=null,c=!1;const d=i===k.MESSAGING?"main":r,p=s.dataChannels[n]||{};if(!p.hasOwnProperty(d)||"object"!=typeof p[d])return null;if(o=p[d].transferId,(a=p[d].streamId)&&s.dataStreams[a]&&(c="string"===s.dataStreams[a].sessionChunkType?"string"==typeof t:"object"==typeof t),!s.peerConnections[n])return jr.log.WARN([n,"RTCDataChannel",d,"Dropping data received from Peer as connection is not present ->"],t),null;if(!s.dataChannels[n]||!s.dataChannels[n][d])return jr.log.WARN([n,"RTCDataChannel",d,"Dropping data received from Peer as Datachannel connection is not present ->"],t),null;if("string"==typeof t)try{const r=JSON.parse(t);if(c=!1,jr.log.DEBUG([n,"RTCDataChannel",d,`Received protocol ${r.type} message ->`],r),[ce.ACK,ce.ERROR,ce.CANCEL].indexOf(r.type)>-1&&!(o&&s.dataTransfers[o]&&s.dataTransfers[o].sessions[n]))return jr.log.WARN([n,"RTCDataChannel",d,"Discarded protocol message as data transfer session is not present ->"],r),null;switch(r.type){case ce.WRQ:if(o&&s.dataTransfers[o]&&s.dataTransfers[o].sessions[n]){jr.log.WARN([n,"RTCDataChannel",d,"Rejecting bidirectional data transfer request as it is currently not supported in the SDK ->"],r),rn(e,n,{type:ce.ACK,ackN:-1,sender:s.user.sid},d);break}break;case ce.MESSAGE:((e,t,n,r)=>{const i=n.sender||t;jr.log.INFO([i,"RTCDataChannel",r,"Received P2P message from peer:"],n),Lr(u({room:e.room,message:{targetPeerId:n.target,content:n.data,senderPeerId:i,isDataChannel:!0,isPrivate:n.isPrivate},isSelf:!1,peerId:i,peerInfo:Ke.getPeerInfo(i,e.room)}));})(s,n,r,d);break;default:jr.log.WARN([n,"RTCDataChannel",d,`Discarded unknown ${r.type} message ->`],r);}}catch(e){console.log(c),Lr(l({peerId:n,channelName:r,channelType:i,error:e,state:b.ERROR,bufferAmount:ei.getDataChannelBuffer(s.dataChannels[n][d].channel)}));}return null};class on extends ze{constructor(){super();const{AdapterJS:e}=window;this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,channel_id:null,channel_label:null,channel_type:null,channel_binary_type:null,error:null,agent_name:e.webrtcDetectedBrowser,agent_type:e.webrtcDetectedType,agent_version:e.webrtcDetectedVersion};}send(e,t,n,r,i,s){const o=Hi.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.uid||null,this.model.peer_id=n,this.model.client_id=o.clientId,this.model.state=t,this.model.channel=r,this.model.channel_id=r.id,this.model.channel_label=r.label,this.model.channel_type="main"===i?"persistent":"temporal",this.model.channel_binary_type=r.binaryType,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.error=("string"==typeof s?s:s&&s.message)||null,"plugin"===this.model.agent_name&&(this.model.channel_binary_type="int8Array","IE"===this.model.agent_name&&this.model.agent_version<11&&(this.model.channel_binary_type="none")),this.postStats(this.endpoints.dataChannel,this.model);}}const an={onopen:e=>{const{dataChannel:t,channelProp:n,channelName:r,channelType:i,peerId:s,roomState:o,bufferThreshold:a}=e,c=new on,{room:d}=o,{STATS_MODULE:u}=Ne;jr.log.DEBUG([s,"RTCDataChannel",n,"Datachannel has opened"]),t.bufferedAmountLowThreshold=a||0,c.send(d.id,u.HANDLE_DATA_CHANNEL_STATS.closed,s,t,n),Lr(l({state:b.OPEN,peerId:s,channelName:r,channelType:i,bufferAmount:ei.getDataChannelBuffer(t)}));},onmessage:(e,t)=>{const{peerId:n,channelName:r,channelType:i,roomState:s}=e;sn(s,t.data,n,r,i);},onerror:(e,t)=>{const{dataChannel:n,peerId:r,channelName:i,channelProp:s,channelType:o,roomState:a}=e;if("NONE"!==t.error.errorDetail){const e=Hi.getSkylinkState(a.room.id),{room:c}=e,d=new on;jr.log.ERROR([r,"RTCDataChannel",s,"Datachannel has an exception ->"],t),d.send(c.id,b.ERROR,r,n,s,t),Lr(l({state:b.ERROR,room:c,peerId:r,channelName:i,channelType:o,bufferAmount:ei.getDataChannelBuffer(n),error:t}));}else jr.log.DEBUG([r,"RTCDataChannel",s,"Datachannel state ->"],t.error.message);},onbufferedamountlow:e=>{const{dataChannel:t,peerId:n,channelName:r,channelProp:i,channelType:s,roomState:o}=e,a=Hi.getSkylinkState(o.room.id),{room:c}=a;jr.log.DEBUG([n,"RTCDataChannel",i,"Datachannel buffering data transfer low"]),Lr(l({state:b.BUFFERED_AMOUNT_LOW,room:c,peerId:n,channelName:r,channelType:s,bufferAmount:ei.getDataChannelBuffer(t)}));},onclose:e=>{const{dataChannel:t,peerId:n,channelName:r,channelProp:i,channelType:o,roomState:a}=e,{DATA_CHANNEL:c,STATS_MODULE:d}=Ne,u=Hi.getSkylinkState(a.room.id)||Object.values(Hi.getSkylinkState())[0];if(!u)return;const{room:p,peerConnections:S}=u,E=((e,t)=>{const{dataTransfers:n}=t,r=Object.keys(n);for(let t=0;t<r.length;t+=1)if(-1!==r[t].indexOf(e))return r[t];return null})(n,u),g=new on;jr.log.DEBUG([n,"RTCDataChannel",i,c.closed]);try{if(g.send(p.id,d.HANDLE_DATA_CHANNEL_STATS.closed,n,t,i),Lr(l({state:b.CLOSED,peerId:n,room:p,channelName:r,channelType:o,bufferAmount:ei.getDataChannelBuffer(t)})),E&&Lr((e=>new s("dataTransferState",{detail:e}))({state:b.ERROR,transferId:E,peerId:n,transferInfo:null,error:new Error(c.closed)})),S[n]&&S[n].remoteDescription&&S[n].remoteDescription.sdp&&(-1===S[n].remoteDescription.sdp.indexOf("m=application")||S[n].remoteDescription.sdp.indexOf("m=application 0")>0))return;o===k.MESSAGING&&setTimeout(()=>{S[n]&&S[n].signalingState!==j.CLOSED&&S[n].localDescription&&S[n].localDescription.type===z.OFFER&&(jr.log.DEBUG([n,"RTCDataChannel",i,c.reviving_dataChannel]),ei.createDataChannel({peerId:n,dataChannel:t,bufferThreshold:ei.getDataChannelBuffer(t),createAsMessagingChannel:!0,roomState:u}),g.send(p.id,d.HANDLE_DATA_CHANNEL_STATS.reconnecting,n,{label:r},"main"));},100);}catch(e){jr.log.WARN([n,"RTCDataChannel",i,c.closed]);}}},cn=(e,t,n)=>{const r=Hi.getInitOptions(),{dataChannels:i,inRoom:s,user:o,hasMCU:a}=e;let c=Object.keys(i),d=!1;if(Array.isArray(n)&&n.length?(c=n,d=!0):n&&"string"==typeof n&&(c=[n],d=!0),!s||!o||!o.sid)return jr.log.ERROR("Unable to send message as User is not in Room. ->",t),null;if(!r.enableDataChannel)return jr.log.ERROR("Unable to send message as User does not have DataChannel enabled. ->",t),null;for(let r=0;r<c.length;r+=1){const s=c[r];i[s]||a?s===_e.MCU?(c.splice(r,1),r-=1):a||(jr.log.DEBUG([s,"RTCDataChannel",null,`Sending ${d?"private":""} P2P message to Peer.`]),rn(e,s,{type:ce.MESSAGE,isPrivate:d,sender:o.sid,target:n?s:null,data:t},"main")):(jr.log.ERROR([s,"RTCDataChannel",null,"Dropping of sending message to Peer as DataChannel connection does not exist."]),c.splice(r,1),r-=1);}return 0===c.length&&jr.log.WARN("Currently there are no Peers to send P2P message to."),a&&(jr.log.DEBUG([_e.MCU,"RTCDataChannel",null,`Broadcasting ${d?"private":""} P2P message to Peers.`]),rn(e,_e.MCU,{type:ce.MESSAGE,isPrivate:d,sender:o.sid,target:c,data:t},"main")),!n&&a||Lr(u({room:e.room,message:{targetPeerId:n||null,content:t,senderPeerId:o.sid,isDataChannel:!0,isPrivate:d},isSelf:!0,peerId:o.sid,peerInfo:Ke.getCurrentSessionInfo(e.room)})),null},dn=(e,t,n)=>{const{dataChannels:r}=e,i=r[t][n],{channelName:s,channelType:o}=i.channelName;if(i.readyState!==b.CLOSED){const{room:a}=e,c=new on;jr.log.DEBUG([t,ge.DATA_CHANNEL,n,Ne.DATA_CHANNEL.CLOSING]),c.send(a.id,b.CLOSING,t,i.channel,n),Lr(l({room:a,peerId:t,state:b.CLOSING,channelName:s,channelType:o,bufferAmount:ei.getDataChannelBuffer(i.channel)})),i.channel.close(),delete r[t][n];}},ln=(e,t,n)=>{const{room:r}=e,i=new Vn;try{const e=i.messageBuilder.getRestartOfferMessage(r.id,t,n);return i.offer(r,t,n,e),t}catch(e){return [t,e]}},un=(e,t,n)=>{const r=Hi.getSkylinkState(t.room.id),{AdapterJS:i}=window,{peerConnections:s,peerCustomConfigs:o,peerEndOfCandidatesCounter:a,room:c,user:d}=r,{doIceRestart:l,bwOptions:u}=n,p=new Vn,{PEER_CONNECTION:S}=Ne,E=[];return new Promise(t=>{if(!s[e])return jr.log.ERROR([e,null,null,S.refresh_peerId_no_match]),E.push(S.refresh_peerId_no_match),t([e,E]);const n=s[e];if("edge"===i.webrtcDetectedBrowser&&(jr.log.WARN([e,"RTCPeerConnection",null,S.refresh_not_supported]),E.push(S.refresh_no_edge_support)),0!==E.length)return t([e,E]);if(n.signalingState===j.STABLE)return jr.log.INFO([e,null,null,"Sending restart message to signaling server ->"],{iceRestart:l,options:u}),o[e]=o[e]||{},o[e].bandwidth=o[e].bandwidth||{},o[e].googleXBandwidth=o[e].googleXBandwidth||{},u.bandwidth&&"object"==typeof u.bandwidth&&("number"==typeof u.bandwidth.audio&&(o[e].bandwidth.audio=u.bandwidth.audio),"number"==typeof u.bandwidth.video&&(o[e].bandwidth.video=u.bandwidth.video),"number"==typeof u.bandwidth.data&&(o[e].bandwidth.data=u.bandwidth.data)),u.googleXBandwidth&&"object"==typeof u.googleXBandwidth&&("number"==typeof u.googleXBandwidth.min&&(o[e].googleXBandwidth.min=u.googleXBandwidth.min),"number"==typeof u.googleXBandwidth.max&&(o[e].googleXBandwidth.max=u.googleXBandwidth.max)),a[e]=a[e]||{},a[e].len=0,t(ln(r,e,l));const g=n.localDescription&&n.localDescription.sdp;if(n.signalingState===j.HAVE_LOCAL_OFFER&&g)return p.sendMessage({type:n.localDescription.type,sdp:n.localDescription.sdp,mid:d.sid,target:e,rid:c.id,restart:!0}),t(e);const m=`Failed restarting as peer connection state is ${n.signalingState} and there is no localDescription set to connection. There could be a handshaking step error.`;return jr.log.DEBUG([e,"RTCPeerConnection",null,m],{localDescription:n.localDescription,remoteDescription:n.remoteDescription}),E.push(m),t([e,E]),null})},pn=(e,t,n)=>(jr.log.INFO([e,"PeerConnection",null,"Restarting peer connection."]),un(e,t,n)),Sn={createOffer:(e,t,n=!1,r)=>{const i=Hi.getSkylinkState(e.id),s=Hi.getInitOptions(),{enableDataChannel:o}=s,{peerConnections:a,hasMCU:c,enableIceRestart:d,peerInformations:l,voiceActivityDetection:u,peerConnStatus:p,dataChannels:S}=i,{AdapterJS:E}=window,m=a[t],f={offerToReceiveAudio:!(!i.sdpSettings.connection.audio&&t!==_e.MCU)&&Yr.getSDPCommonSupports(t,null,e.id).video,offerToReceiveVideo:!(!i.sdpSettings.connection.video&&t!==_e.MCU)&&Yr.getSDPCommonSupports(t,null,e.id).audio,iceRestart:!!((l[t]||{}).config||{}).enableIceRestart&&n&&d,voiceActivityDetection:u};return c&&"function"!=typeof m.addTransceiver&&(f.offerToReceiveVideo=!0),c&&t!==_e.MCU||Ve.addLocalMediaStreams(t,i),o&&l[t].config.enableDataChannel&&(S[t]&&S[t].main||(ei.createDataChannel({peerId:t,roomState:i,createAsMessagingChannel:!0}),i.peerConnections[t].hasMainChannel=!0)),jr.log.DEBUG([t,null,null,"Creating offer with config:"],f),m.endOfCandidates=!1,m.negotiating=!0,p[t]&&(i.peerConnStatus[t].sdpConstraints=f),Hi.setSkylinkState(i,e.id),new Promise((e,n)=>{m.createOffer("plugin"===E.webrtcDetectedType?{mandatory:{OfferToReceiveAudio:f.offerToReceiveAudio,OfferToReceiveVideo:f.offerToReceiveVideo,iceRestart:f.iceRestart,voiceActivityDetection:f.voiceActivityDetection}}:f).then(n=>((e,t,n,r,i)=>{const{room:s}=n;jr.log.DEBUG([t,null,null,"Created offer"],i),Mt.send(s.id,en.OFFER.create,t,i,!1),Zt(e,t,n,i,r);})(e,t,i,r,n)).catch(e=>((e,t,n,r)=>{const{room:i}=n;jr.log.ERROR([t,null,null,"Failed creating an offer:"],r),Mt.send(i.id,en.OFFER.create_error,t,null,!1,r),Lr(g({state:z.ERROR,peerId:t,error:r,room:n.room})),e(r);})(n,t,i,e));})},createAnswer:(e,t)=>{const n=Hi.getSkylinkState(e.room.id),{peerConnections:r,hasMCU:i,peerConnStatus:s,voiceActivityDetection:o}=n,a=r[t],{AdapterJS:c}=window;jr.log.INFO([t,null,null,"Creating answer with config:"],e.room.connection.sdpConstraints);const d="edge"===c.webrtcDetectedBrowser?{offerToReceiveVideo:!(!n.sdpSettings.connection.audio&&t!==_e.MCU)&&Yr.getSDPCommonSupports(t,a.remoteDescription,e.room.id).video,offerToReceiveAudio:!(!n.sdpSettings.connection.video&&t!==_e.MCU)&&Yr.getSDPCommonSupports(t,a.remoteDescription,e.room.id).audio,voiceActivityDetection:o}:void 0;return i&&t!==_e.MCU||Ve.addLocalMediaStreams(t,e),s[t]&&(n.peerConnStatus[t].sdpConstraints=d),new Promise((n,r)=>a.createAnswer(d).then(r=>((e,t,n,r)=>{const{room:i}=n;jr.log.DEBUG([t,null,null,"Created answer"],r),Mt.send(i.id,nn.ANSWER.create,t,r,!1),Zt(e,t,n,r);})(n,t,e,r)).catch(n=>((e,t,n,r)=>{const{room:i}=n;jr.log.ERROR([t,null,null,"Failed creating an answer:"],r),Mt.send(i.id,nn.ANSWER.create_error,t,null,!1,r),Lr(g({state:z.ERROR,peerId:t,error:r,room:n.room})),e(r);})(r,t,e,n)))},addPeer:e=>{let t=null;const{currentRoom:n,targetMid:r,peerBrowser:i,cert:s,receiveOnly:o,hasScreenShare:a}=e,c=Hi.getInitOptions(),d=Hi.getSkylinkState(n.id),{peerConnections:l,room:u}=d,p=new Xt;if(l[r])jr.log.WARN([r,null,null,"Connection to peer has already been made."]);else{d.peerConnStatus[r]={connected:!1,init:!1},jr.log.INFO([r,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:i,receiveOnly:o,enableDataChannel:c.enableDataChannel}),t=tn({currentRoom:n,targetMid:r,hasScreenShare:a,cert:s,sdpSemantics:pe.UNIFIED});try{const e=t.getConfiguration();e.sdpSemantics===pe.UNIFIED?jr.log.INFO([r,"SDP Semantics",null,"Peer Connection has Unified plan."]):e.sdpSemantics===pe.PLAN_B?jr.log.INFO([r,"SDP Semantics",null,"Peer Connection has Plan-B."]):jr.log.INFO([r,"SDP Semantics",null,"The sdpSemantics parameter is not supported by this browser version."]);}catch(e){jr.log.INFO([r,"SDP Semantics",null,"getConfiguration() is not available in this browser version. Ex : "],e);}d.peerConnections[r]=t,Hi.setSkylinkState(d,n.id),p.send(u.id,t.iceConnectionState,r),Ot.send(u.id,"new",r,!1);}return t},createDataChannel:e=>{let{peerId:t,dataChannel:n,bufferThreshold:r,createAsMessagingChannel:i,roomState:s}=e;const o=Hi.getSkylinkState(s.room.id),{user:a,peerConnections:c,dataChannels:d}=o,u=c[t];let p=`-_${t}`,S=!0===i?k.MESSAGING:k.DATA,E=S===k.MESSAGING?"main":p;if(!a||!a.sid)return jr.log.ERROR([t,"RTCDataChannel",E,"Aborting of creating or initializing DataChannel as User does not have Room session"]),null;if(p=`${a.sid}_${t}`,!u||u.signalingState===j.CLOSED)return jr.log.ERROR([t,"RTCDataChannel",E,"Aborting of creating or initializing Datachannel as Peer connection does not exists"]),null;if(n&&"object"==typeof n?p=n.label:"string"==typeof n&&(p=n,n=null),d[t]?d[t].main&&d[t].main.channel.label===p&&(E="main",S=k.MESSAGING):(E="main",S=k.MESSAGING,d[t]={},jr.log.DEBUG([t,"RTCDataChannel",E,"initializing main DataChannel"])),!n)try{n=u.createDataChannel(p,{reliable:!0,ordered:!0});}catch(e){jr.log.ERROR([t,"RTCDataChannel",E,"Failed creating Datachannel ->"],e);const r=new on,{room:i}=s;return r.send(i.id,b.ERROR,t,{label:p},E,e),Lr(l({state:b.CREATE_ERROR,peerId:t,error:e,channelName:p,channelType:S,buferAmount:ei.getDataChannelBuffer(n)})),null}const g={dataChannel:n,peerId:t,channelName:p,channelProp:E,channelType:S,roomState:s,bufferThreshold:r};n.onopen=an.onopen.bind(n,g),n.onmessage=an.onmessage.bind(n,g),n.onerror=an.onerror.bind(n,g),n.onbufferedamountlow=an.onbufferedamountlow.bind(n,g),n.onclose=an.onclose.bind(n,g);const m=S===k.MESSAGING?"main":p;return o.dataChannels[t][m]={channelName:p,channelType:S,transferId:null,streamId:null,channel:n},Hi.setSkylinkState(o,s.room.id),null},sendP2PMessage:(e,t,n)=>{const r=hr(e);if(r)cn(r,t,n);else{const e=Hi.getSkylinkState(),r=Object.keys(e);for(let i=0;i<r.length;i+=1){const s=e[r[i]];cn(s,t,n);}}},getPeersInRoom:e=>{const t=hr(e);if(t){const e={},n=Object.keys(t.peerInformations);for(let r=0;r<n.length;r+=1)e[n[r]]=Object.assign({},Ke.getPeerInfo(n[r],t.room)),e[n[r]].isSelf=!1;return t.user&&t.user.sid&&(e[t.user.sid]=Object.assign({},Ke.getCurrentSessionInfo(t.room)),e[t.user.sid].isSelf=!0),e}return null},signalingEndOfCandidates:(e,t)=>{const n=Hi.getSkylinkState(t.room.id),r=n.peerEndOfCandidatesCounter[e],i=n.peerConnections[e],o=n.peerCandidatesQueue[e],a=n.peerConnectionConfig[e],c=n.gatheredCandidates[e],{AdapterJS:d,RTCIceCandidate:l}=window,{TAGS:u}=De,{PEER_CONNECTION:p}=Ne;if(!r)return null;if(i&&i.signalingState!==j.CLOSED&&i.remoteDescription&&i.remoteDescription.sdp&&"number"==typeof r.expectedLen&&r.len>=r.expectedLen&&(!o||0===o.length)&&!r.hasSet){jr.log.DEBUG([e,u.PEER_CONNECTION,null,p.end_of_candidates]),r.hasSet=!0;try{if("edge"===d.webrtcDetectedBrowser){let t=-1;const r=[],s=i.remoteDescription.sdp.split("\r\n");let o=!1;for(let i=0;i<s.length;i+=1)if(0===s[i].indexOf("m="))o="0"===s[i].split(" ")[1],t+=1;else if(0===s[i].indexOf("a=mid:")&&!o){const o=s[i].split("a=mid:")[1]||"";if(o&&-1===r.indexOf(o)&&(r.push(o),yt.addIceCandidate(e,`endofcan-${(new Date).getTime()}`,"endOfCandidates",new l({sdpMid:o,sdpMLineIndex:t,candidate:"candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"}),n),a.bundlePolicy===K.MAX_BUNDLE))break}}else d&&!Rr(d.VERSION,"0.14.0")&&i.addIceCandidate(null);if(c){const t={expected:r.expectedLen||0,received:r.len||0,processed:c.receiving.srflx.length+c.receiving.relay.length+c.receiving.host.length};Lr((e=>new s("candidatesGathered",{detail:e}))({room:n.room,peerId:e,candidatesLength:t}));}n.peerEndOfCandidatesCounter[e]=r,Hi.setSkylinkState(n,t.room.id);}catch(t){jr.log.ERROR([e,u.PEER_CONNECTION,null,p.end_of_candidate_failure],t);}}return null},getDataChannelBuffer:e=>({bufferedAmountLow:parseInt(e.bufferedAmountLow,10)||0,bufferedAmountLowThreshold:parseInt(e.bufferedAmountLowThreshold,10)||0}),refreshDataChannel:(e,t)=>{const{dataChannels:n,peerConnections:r}=e;if((e=>!or(e))(n)&&Object.hasOwnProperty.call(n,t)){if(Object.hasOwnProperty.call(n[t],"main")){const i=n[t].main,{channelName:s,channelType:o}=i,a=i.channel.bufferedAmountLowThreshold||0;o===k.MESSAGING&&setTimeout(()=>{Object.hasOwnProperty.call(r,t)&&r[t].signalingState!==j.CLOSED&&r[t].localDescription.type===z.OFFER&&(ei.closeDataChannel(e,t),jr.log.DEBUG([t,"RTCDataChannel","main",Ne.DATA_CHANNEL.reviving_dataChannel]),ei.createDataChannel({roomState:e,peerId:t,dataChannel:s,bufferThreshold:a,createAsMessagingChannel:!0}));},100);}}else jr.log.DEBUG([t,"RTCDataChannel",Ne.DATA_CHANNEL.refresh_error]);},closeDataChannel:(e,t,n="main")=>{try{const r=Hi.getSkylinkState(e.room.id),{dataChannels:i,room:s}=r;if(!i[t]||!i[t][n])return void jr.log.WARN([t,ge.DATA_CHANNEL,n||null,Ne.DATA_CHANNEL.ERRORS.NO_SESSIONS]);if("main"===n)return void((e,t)=>{const{dataChannels:n}=e,r=Object.keys(n[t]);for(let i=0;i<r.length;i+=1)Object.hasOwnProperty.call(n[t],r[i])&&dn(e,t,r[i]);delete n[t];})(r,t);dn(r,t,n),Hi.setSkylinkState(r,s.id);}catch(e){jr.log.ERROR([t,ge.DATA_CHANNEL,n||null,Ne.DATA_CHANNEL.ERRORS.FAILED_CLOSING],e);}},refreshConnection:zt,refreshPeerConnection:(e,t,n=!1,r={})=>{const i=Hi.getSkylinkState(t.room.id),{hasMCU:s}=i;try{if(!s){const t=[];for(let s=0;s<e.length;s+=1){const o=e[s],a=pn(o,i,{doIceRestart:n,bwOptions:r});t.push(a);}return Promise.all(t)}return ((e,t,n)=>new Promise(r=>{const i=e,s=Hi.getInitOptions(),{mcuUseRenegoRestart:o}=s;try{n.bandwidth&&"object"==typeof n.bandwidth&&("number"==typeof n.bandwidth.audio&&(i.streamsBandwidthSettings.bAS.audio=n.bandwidth.audio),"number"==typeof n.bandwidth.video&&(i.streamsBandwidthSettings.bAS.video=n.bandwidth.video),"number"==typeof n.bandwidth.data&&(i.streamsBandwidthSettings.bAS.data=n.bandwidth.data)),n.googleXBandwidth&&"object"==typeof n.googleXBandwidth&&("number"==typeof n.googleXBandwidth.min&&(i.streamsBandwidthSettings.googleX.min=n.googleXBandwidth.min),"number"==typeof n.googleXBandwidth.max&&(i.streamsBandwidthSettings.googleX.max=n.googleXBandwidth.max)),o&&(i.peerEndOfCandidatesCounter.MCU=i.peerEndOfCandidatesCounter.MCU||{},i.peerEndOfCandidatesCounter.MCU.len=0,Hi.setSkylinkState(i),r(ln(i,_e.MCU,t)));}catch(e){r([_e.MCU,e]);}}))(t,n,r)}catch(e){return jr.log.ERROR([null,"RTCPeerConnection",null,"Failed restarting."],e),null}},restartPeerConnection:un,buildPeerInformations:(e,t)=>{const n=e,r=n.sid;return n.room=t.room.roomName,n.settings.data=!!(t.dataChannels[r]&&t.dataChannels[r].main&&t.dataChannels[r].main.channel&&t.dataChannels[r].main.channel.readyState===b.OPEN),delete n.publishOnly,n},getConnectionStatus:(e,t=null)=>{const{ROOM_STATE:n}=Ne;if(!e)return jr.log.WARN(n.NO_ROOM_NAME),_r(n.NO_ROOM_NAME);const{room:r}=e,i=((e,t)=>{const{peerConnections:n,room:r}=e,{PEER_CONNECTION:i}=Ne;let s=null,o=null;return ar(Object.keys(n))?o=i.not_initialised:Array.isArray(t)?(s=t).forEach(e=>{Or(r,e)||(o=`${i.peerId_does_not_exist} ${e}`);}):Er(t)?(Or(r,t)||(o=`${i.peerId_does_not_exist} ${t}`),s=[t]):s=Object.keys(n),{peerIds:s,errorMsg:o}})(e,t);if(i.errorMsg)return jr.log.WARN(i.errorMsg),_r(i.errorMsg);const{peerIds:s}=i,o=[];for(let e=0;e<s.length;e+=1){const t=new Xr(r.id,s[e]);o.push(t.getConnectionStatus());}return Promise.all(o)},closePeerConnection:(e,t)=>{const n=Hi.getSkylinkState(e.room.id),{peerConnections:r,room:i}=n,{AdapterJS:s}=window;r[t].close(),"AppleWebKit"===s.webrtcDetectedType&&(n.peerConnections[t].signalingStateClosed||(n.peerConnections[t].signalingStateClosed=!0),n.peerConnections[t].iceConnectionStateClosed||(n.peerConnections[t].iceConnectionStateClosed=!0)),Hi.setSkylinkState(n,i.id);},updatePeerInformationsMediaStatus:(e,t,n,r)=>{const i=Hi.getSkylinkState(e.id);i.peerInformations[t].mediaStatus=((e,t,n,r)=>{const{peerMedias:i,peerInformations:s}=e,o=i[t],a=s[t].mediaStatus||{};return Object.values(o).forEach(e=>{e.transceiverMid===n.mid&&(a[r.id]={audioMuted:Ar(r)?e.mediaState===Re.MUTED?0:1:-1,videoMuted:yr(r)?e.mediaState===Re.MUTED?0:1:-1});}),delete a.audioMuted,delete a.videoMuted,a})(i,t,n,r),Hi.setSkylinkState(i,e.id);},processNewSender:(e,t,n)=>{const r=e;r.currentRTCRTPSenders[t]||(r.currentRTCRTPSenders[t]=[]),r.currentRTCRTPSenders[t].push(n),Hi.setSkylinkState(r,r.room.id);}},En=(e,t,n,r)=>{const i=e[t]["send"===n?"sending":"receiving"][r];return ["number","string","boolean"].indexOf(typeof i)>-1?i:null},gn=(e,t)=>({stream_id:e.id,id:t.id,label:t.label,muted:!t.enabled}),mn=(e,t,n)=>({stream_id:e.id,id:t.id,label:t.label,height:n.video.resolution.height,width:n.video.resolution.width,muted:!t.enabled});class fn extends ze{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,audio_send:{tracks:[]},audio_recv:{},video_send:{tracks:[]},video_recv:{},error:null},this.stats=null;}gatherSendAudioPacketsStats(){this.model.audio_send.bytes=En(this.stats,"audio","send","bytes"),this.model.audio_send.packets=En(this.stats,"audio","send","packets"),this.model.audio_send.echo_return_loss=En(this.stats,"audio","send","echoReturnLoss"),this.model.audio_send.echo_return_loss_enhancement=En(this.stats,"audio","send","echoReturnLossEnhancement"),this.model.audio_send.round_trip_time=En(this.stats,"audio","send","roundTripTime"),this.model.audio_send.audio_level=En(this.stats,"audio","send","audioLevel"),this.model.audio_send.jitter=En(this.stats,"audio","send","jitter");}gatherReceiveAudioPacketsStats(){this.model.audio_recv.bytes=En(this.stats,"audio","recv","bytes"),this.model.audio_recv.packets=En(this.stats,"audio","recv","packets"),this.model.audio_recv.packets_lost=En(this.stats,"audio","recv","packetsLost"),this.model.audio_recv.jitter=En(this.stats,"audio","recv","jitter"),this.model.audio_recv.audio_level=En(this.stats,"audio","recv","audioLevel");}gatherSendVideoPacketsStats(){this.model.video_send.bytes=En(this.stats,"video","send","bytes"),this.model.video_send.packets=En(this.stats,"video","send","packets"),this.model.video_send.nack_count=En(this.stats,"video","send","nacks"),this.model.video_send.firs_count=En(this.stats,"video","send","firs"),this.model.video_send.plis_count=En(this.stats,"video","send","plis"),this.model.video_send.frames_encoded=En(this.stats,"video","send","framesEncoded"),this.model.video_send.frame_width=En(this.stats,"video","send","frameWidth"),this.model.video_send.frame_height=En(this.stats,"video","send","frameHeight"),this.model.video_send.round_trip_time=En(this.stats,"video","send","roundTripTime"),this.model.video_send.qp_sum=En(this.stats,"video","send","qpSum"),this.model.video_send.jitter=En(this.stats,"video","send","jitter"),this.model.video_send.frames=En(this.stats,"video","send","frames"),this.model.video_send.hugeFrames=En(this.stats,"video","send","hugeFramesSent"),this.model.video_send.framesPerSecond=En(this.stats,"video","send","framesPerSecond");}gatherReceiveVideoPacketsStats(){this.model.video_recv.bytes=En(this.stats,"video","recv","bytes"),this.model.video_recv.packets=En(this.stats,"video","recv","packets"),this.model.video_recv.packets_lost=En(this.stats,"video","recv","packetsLost"),this.model.video_recv.nack_count=En(this.stats,"video","recv","nacks"),this.model.video_recv.firs_count=En(this.stats,"video","recv","firs"),this.model.video_recv.plis_count=En(this.stats,"video","recv","plis"),this.model.video_recv.frames_decoded=En(this.stats,"video","recv","framesDecoded"),this.model.video_recv.qp_sum=En(this.stats,"video","recv","qpSum"),this.model.video_recv.frames_decoded=En(this.stats,"video","recv","framesDecoded"),this.model.video_recv.frames_dropped=En(this.stats,"video","recv","framesDropped"),this.model.video_recv.decoderImplementation=En(this.stats,"video","recv","decoderImplementation");}buildTrackInfo(e){const t=Hi.getSkylinkState(e),{streams:n}=t;let r=[];n.userMedia&&(r=Object.values(Object.values(n.userMedia))),n.screenshare&&r.push(n.screenshare),r.forEach(e=>{if(e){const t=e.stream?e.stream:e[Object.keys(e)[0]].stream,n=e.settings?e.settings:e[Object.keys(e)[0]].settings,r=t.getAudioTracks(),i=t.getVideoTracks();r.forEach(e=>{const n=gn(t,e);this.model.audio_send.tracks.push(n);}),i.forEach(e=>{const r=mn(t,e,n);this.model.video_send.tracks.push(r);});}});}send(e,t,n){const{STATS_MODULE:r}=Ne,i=Hi.getSkylinkState(e);i?(i.streams.userMedia||i.streams.screenshare)&&(this.model.client_id=i.clientId,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.peer_id=n,ei.retrieveStatistics(e,n,Hi.getInitOptions().beSilentOnStatsLogs).then(t=>{t&&(this.stats=t,this.gatherSendAudioPacketsStats(),this.gatherReceiveAudioPacketsStats(),this.gatherSendVideoPacketsStats(),this.gatherReceiveVideoPacketsStats(),this.buildTrackInfo(e),this.postStats(this.endpoints.bandwidth,this.model));}).catch(e=>{this.model.error=e?e.message:null,jr.log.DEBUG(r.HANDLE_BANDWIDTH_STATS.RETRIEVE_FAILED,e);})):jr.log.DEBUG([n,"Statistics","Bandwidth_Stats",r.HANDLE_BANDWIDTH_STATS.NO_STATE]);}}const hn={};class Rn{constructor(e){const{peerConnection:t,state:n,targetMid:r}=e;if(hn[r])return hn[r];this.peerId=r,this.state=n,this.peerConnection=t,this.bandwidth=null,hn[this.peerId]=this;}static formatTotalFn(e){let t=0;for(let n=0;n<e.length;n+=1)t+=e[n];return t/e.length}setAdjustmentInterval(){const{bandwidthAdjuster:e,peerBandwidth:t,room:n}=this.state,{PEER_CONNECTION_STATE:r}=De;if(this.bandwidth)return;const i={audio:{send:[],recv:[]},video:{send:[],recv:[]}};let s=0;const o=setInterval(()=>{this.peerConnection&&this.peerConnection.signalingState!==r.CLOSED&&e&&t[this.peerId]?ei.retrieveStatistics(n.id,this.peerId,Hi.getIniOptions().beSilentOnStatsLogs,!0).then(t=>{if(this.peerConnection&&this.peerConnection.signalingState!==r.CLOSED&&e||clearInterval(o),i.audio.send.push(8*t.audio.sending.bytes),i.audio.recv.push(8*t.audio.receiving.bytes),i.video.send.push(8*t.video.sending.bytes),i.video.recv.push(8*t.video.receiving.bytes),(s+=1)===e.interval){s=0;let t=Rn.formatTotalFn(i.audio.send),n=Rn.formatTotalFn(i.video.send);e.useUploadBwOnly||(t+=Rn.formatTotalFn(i.audio.recv),n+=Rn.formatTotalFn(i.video.recv),t/=2,n/=2),t=parseInt(t*(e.limitAtPercentage/100)/1e3,10),n=parseInt(n*(e.limitAtPercentage/100)/1e3,10),ei.refreshConnection(this.state,this.peerId,!1,{bandwidth:{audio:t,video:n}});}}).catch(()=>{i.audio.send.push(0),i.audio.recv.push(0),i.video.send.push(0),i.video.recv.push(0);}):clearInterval(o);},1e3);this.bandwidth=i;}}const Tn=e=>{const{ICE_CONNECTION_STATE:t}=De;return [t.COMPLETED,t.CONNECTED].indexOf(e)>-1},Cn={ontrack:(e,t,n,r)=>{const i=Hi.getSkylinkState(n.room.id),{peerConnections:s,room:o,hasMCU:a}=i,{receiver:c}=r,{AdapterJS:d}=window,l=r.streams[0];let{transceiver:u,track:p}=r,S=t;if("safari"===d.webrtcDetectedBrowser){s[t].getTransceivers().forEach(e=>{e.receiver.track.id===c.track.id&&(u=e);});}if(null===u.mid&&jr.log.WARN("Transceiver mid is null",u),!s[S])return null;a&&(S=((e,t)=>{const{peerMedias:n,user:r}=e,i=Object.keys(n);for(let e=0;e<i.length;e+=1)if(i[e]!==r.sid){const r=Object.values(n[i[e]]);for(let n=0;n<r.length;n+=1)if(r[n].transceiverMid===t.mid)return i[e]}return null})(i,u));const E=Wn.isVideoScreenTrack(i,S,u.mid),g=[S,o,E];return l.onremovetrack=Cn.onremovetrack.bind(void 0,...g),Wn.updateStreamIdFromOntrack(i.room,S,u.mid,l.id),ei.updatePeerInformationsMediaStatus(i.room,S,u,l),Ve.updateRemoteStreams(i.room,S,l),Ve.onRemoteTrackAdded(l,n,S,E,p.kind===he.VIDEO,p.kind===he.AUDIO),null},ondatachannel:(e,t,n,r)=>{const i=r.channel||r,s=Hi.getInitOptions(),o=Hi.getSkylinkState(n.room.id),{peerInformations:a}=o,{enableDataChannel:c}=s;jr.log.DEBUG([t,"RTCDataChannel",i.label,"Received datachannel ->"],i),c&&a[t].config.enableDataChannel?(e.hasMainChannel||(e.hasMainChannel=!0),Sn.createDataChannel({peerId:t,dataChannel:i,roomState:n})):jr.log.WARN([t,"RTCDataChannel",i.label,"Not adding datachannel as enable datachannel is set to false"]);},onicecandidate:(e,t,n,r)=>{yt.onIceCandidate(t,r.candidate||r,n.room);},oniceconnectionstatechange:(e,t,n)=>{const{PEER_CONNECTION:r}=Ne,{ICE_CONNECTION_STATE:i,PEER_CONNECTION_STATE:s}=De,{AdapterJS:o}=window,{webrtcDetectedBrowser:a,webrtcDetectedType:c}=o,d=Hi.getSkylinkState(n.room.id);if(!d)return void jr.log.DEBUG([t,"RTCIceConnectionState",null,r.no_room_state]);const{hasMCU:l,bandwidthAdjuster:u,peerInformations:p,peerConnStatus:S,peerStats:E}=d,g=new Xt;let m=null,f=e.iceConnectionState;jr.log.DEBUG([t,"RTCIceConnectionState",null,r.ice_connection_state],f),"edge"===a&&("connecting"===f?f=i.CHECKING:"new"===f&&(f=i.FAILED)),"AppleWebKit"!==c||f!==i.CLOSED?(d&&e.iceConnectionState!==i.CONNECTED&&g.send(n.room.id,e.iceConnectionState,t),Lr(R({state:f,peerId:t})),f===i.FAILED&&Lr(R({state:i.TRICKLE_FAILED,peerId:t})),S&&S[t]&&(S[t].connected=Tn(f)),m||!Tn(f)||E[t]||(m=!0,E[t]={},jr.log.DEBUG([t,"RTCStatsReport",null,"Retrieving first report to tabulate results"]),ei.getConnectionStatus(d,t).then(()=>{g.send(n.room.id,e.iceConnectionState,t),m=setInterval(()=>{e.signalingState===s.CLOSED||e.iceConnectionState===s.CLOSED?clearInterval(m):(new fn).send(d.room.id,e,t);},2e4);})),!l&&Tn(f)&&u&&"edge"!==o.webrtcDetectedBrowser&&"edge"!==(((p[t]||{}).agent||{}).name||"edge")&&new Rn({targetMid:t,state:d,peerConnection:e}).setAdjustmentInterval()):setTimeout(()=>{e.iceConnectionStateClosed||(g.send(n.room.id,i.CLOSED,t),Lr(R({state:i.CLOSED,peerId:t})));},10);},onicegatheringstatechange:(e,t,n)=>{const{PEER_CONNECTION:r}=Ne,{iceGatheringState:i}=e;jr.log.INFO([t,"RTCIceGatheringState",null,r.ice_gathering_state],i),Lr(h({state:i,room:n.room,peerId:t}));},onsignalingstatechange:(e,t)=>{const{AdapterJS:n}=window,{PEER_CONNECTION:r}=Ne,{PEER_CONNECTION_STATE:i}=De,{signalingState:s,signalingStateClosed:o}=e;jr.log.DEBUG([t,"RTCSignalingState",null,r.peer_connection_state],s),"AppleWebKit"!==n.webrtcDetectedType||s!==i.CLOSED?Lr(O({state:s,peerId:t})):setTimeout(()=>{o||Lr(O({state:i.CLOSED,peerId:t}));},10);},onremovetrack:(e,t,n,r)=>{const{AdapterJS:i}=window,s=fr(t.id),{peerInformations:a}=s,{MEDIA_STREAM:d,PEER_INFORMATIONS:l}=Ne,u=i.webrtcDetectedBrowser===Ie.REACT_NATIVE?r.stream:r.target;jr.log.INFO([e,ge.MEDIA_STREAM,null,d.REMOTE_TRACK_REMOVED],{peerId:e,isSelf:!1,isScreensharing:n,track:r.track}),a[e]?u?(((e,t,n)=>{const r=e;delete r.peerInformations[t].mediaStatus[n],Hi.setSkylinkState(r,r.room.id);})(s,e,u.id),((e,t,n,r,i)=>{Lr(c({room:e.room,peerId:t,peerInfo:Ke.getPeerInfo(t,e.room),isSelf:!1,isScreensharing:n,streamId:i.id,isVideo:r.track.kind===he.VIDEO,isAudio:r.track.kind===he.AUDIO}));})(s,e,n,r,u),n&&(e=>{const{streams:t,room:n,user:r}=e;(t.userMedia?Object.values(t.userMedia):[]).forEach(e=>{yr(e.stream)&&Lr(o({stream:e.stream,streamId:e.id,peerId:r.sid,room:n,isSelf:!0,peerInfo:Ke.getCurrentSessionInfo(n),isVideo:!0,isAudio:!1}));});})(s),((e,t)=>{Lr(T({peerId:t,peerInfo:Ke.getPeerInfo(t,e.room),isSelf:!1}));})(s,e)):jr.log.DEBUG([e,ge.MEDIA_STREAM,null,`${d.ERRORS.DROPPING_ONREMOVETRACK}`-`${d.NO_STREAM}`]):jr.log.DEBUG([e,ge.MEDIA_STREAM,null,`${d.ERRORS.DROPPING_ONREMOVETRACK}`-`${l.NO_PEER_INFO} ${e}`]);},onsenderadded:(e,t,n,r)=>{const i=Hi.getSkylinkState(n.room.id),{sender:s}=r;Sn.processNewSender(i,t,s);}};class In extends ze{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,recording_id:null,recordings:null,error:null};}send(e,t,n,r,i){const s=Hi.getSkylinkState(e);this.model.client_id=s.clientId,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.state=t,this.model.recording_id=n,this.model.recordings=r,this.error=("string"==typeof i?i:i&&i.message)||null,this.postStats(this.endpoints.recording,this.model);}}const _n=new In,vn=(e,t,n)=>{const r={state:e,recordingId:t};n&&(r.error=n),Lr(((e={})=>new s("recordingState",{detail:e}))(r));},On="startSuccess",An="stopSuccess",yn=(e,t,n,r,i)=>{const s=Ke.getPeerInfo(n,e.room);Lr(d({isSelf:!1,peerId:n,peerInfo:s,streamId:t,isAudio:r===he.AUDIO,isVideo:r===he.VIDEO,isScreensharing:i})),Lr(T({isSelf:!1,peerId:n,peerInfo:s}));},Dn=yn,Nn=(e,t,n)=>{jr.log.WARN([e,ge.SIG_SERVER,`${Ne.MEDIA_INFO.WARN.READ_ONLY_VALUE} ${n}`],t);},Pn=(e,t)=>{const{rid:n,mediaId:r,transceiverMid:i}=t,s=Hi.getSkylinkState(n);Wn.updatePeerMediaInfo(s.room,e,r,Te.TRANSCEIVER_MID,i);},Mn=(e,t,n,r)=>{if(r.mediaState===Re.UNAVAILABLE)((e,t,n,r)=>{const{mediaId:i}=r;Wn.setMediaStateToUnavailable(e,n,i),Wn.deleteUnavailableMedia(e,n,i);})(e,0,n,r);else switch(t){case me.VIDEO_SCREEN:case me.VIDEO_CAMERA:case me.VIDEO_OTHER:case me.VIDEO:((e,t)=>{const{type:n,rid:r,mediaId:i,mediaState:s,transceiverMid:o,mediaType:a}=t,c=Hi.getSkylinkState(r),{room:d}=c,l=Wn.retrieveStreamId(d,e,i,o),u=(new Date).toISOString();if(jr.log.INFO([e,ge.SIG_SERVER,n,Ne.MEDIA_INFO.VIDEO_STATE_CHANGE,s,l],t),c.peerInformations[e]){if(c.peerMessagesStamps[e]){if(u<c.peerMessagesStamps[e].videoMuted)return void jr.log.WARN([e,ge.SIG_SERVER,n,Ne.SIGNALING.OUTDATED_MSG],t);c.peerMessagesStamps[e].videoMuted=u;}c.peerInformations[e].mediaStatus[l]||(c.peerInformations[e].mediaStatus[l]={}),c.peerInformations[e].mediaStatus[l].videoMuted=s===Re.MUTED||s===Re.STOPPED?Ee.MUTED:Ee.ACTIVE,Hi.setSkylinkState(c,d.id),Dn(c,l,e,he.VIDEO,a===me.VIDEO_SCREEN);}else jr.log.WARN([e,ge.PEER_INFORMATION,n,`${Ne.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`]);})(n,r);break;case me.AUDIO_MIC:case me.AUDIO:((e,t)=>{const{type:n,rid:r,mediaId:i,mediaState:s,transceiverMid:o}=t,a=Hi.getSkylinkState(r),{room:c}=a,d=Wn.retrieveStreamId(c,e,i,o),l=(new Date).toISOString();if(jr.log.INFO([e,ge.SIG_SERVER,n,Ne.MEDIA_INFO.AUDIO_STATE_CHANGE,s,d],t),a.peerInformations[e]){if(a.peerMessagesStamps[e]){if(l<a.peerMessagesStamps[e].audioMuted)return void jr.log.WARN([e,ge.SIG_SERVER,n,Ne.SIGNALING.OUTDATED_MSG],t);a.peerMessagesStamps[e].audioMuted=l;}a.peerInformations[e].mediaStatus[d]||(a.peerInformations[e].mediaStatus[d]={}),a.peerInformations[e].mediaStatus[d].audioMuted=s===Re.MUTED||s===Re.STOPPED?Ee.MUTED:Ee.ACTIVE,Hi.setSkylinkState(a,c.id),Dn(a,d,e,he.AUDIO,!1);}else jr.log.WARN([e,ge.PEER_INFORMATION,n,`${Ne.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`]);})(n,r);break;default:jr.log.ERROR([n,ge.SIG_SERVER,`${Ne.MEDIA_INFO.WARN.INVALID_MEDIA_TYPE} ${t}`],r);}},wn=(e,t,n,r,i)=>{const s=Hi.getSkylinkState(e),{peerMedias:o}=s,a=o[t][n];return a[r]&&a[r]!==i},bn=yn,kn=(e,t)=>{const n=Ke.getPeerInfo(t,e.room);return !(!n.agent.SDKVersion||"2.0.0"!==n.agent.SDKVersion)&&(jr.log.INFO([t,ge.SIG_SERVER,null,Ne.SIGNALING.DROPPING_MUTE_EVENT]),!0)},Ln={userMessageHandler:(e,t)=>{mt.processMessage(e,t);},answer:e=>{Ht(e);},answerAck:e=>{const{mid:t,rid:n,success:r}=e,i=Hi.getSkylinkState(n),s=t;Lr(g({state:z.ANSWER_ACK,peerId:s,room:i.room})),i.peerConnections[s].negotiating=!1,Hi.setSkylinkState(i,n),r?((e,t)=>{if(e.bufferedRemoteOffers[t]&&!ar(e.bufferedRemoteOffers[t])){const n=e.bufferedRemoteOffers[t].shift();return jr.log.DEBUG([t,"RTCSessionDescription",n.type,Ne.NEGOTIATION_PROGRESS.APPLYING_BUFFERED_REMOTE_OFFER],n),Ht(n),Hi.setSkylinkState(e,e.room.id),!0}return !1})(i,s)||((e,t)=>{const{peerConnections:n,currentRTCRTPSenders:r}=e;return new Promise(e=>{const i=n[t],s=i.getSenders()?i.getSenders():[],o=[],a=r[t]||[];let c=!1;s.forEach(e=>{o.push(e.getStats());});const d={};Promise.all(o).then(t=>{t.forEach((e,t)=>{e.forEach(e=>{e&&e.ssrc?d[e.ssrc]=s[t]:e&&"ssrc"===e.type&&e.id.indexOf("send")>1&&e.values.forEach(e=>{e.ssrc&&(d[e.ssrc]=s[t]);});});});const n=Object.keys(d);if(n.length!==a.length)c=!0;else{let e=0;for(let t=0;t<n.length;t+=1){const r=d[n[t]];for(let t=0;t<a.length;t+=1){if(r===a[t]){e+=1;break}}}c=e!==n.length;}e(c);});})})(i,s).then(e=>{e&&zt(i,s).catch(e=>{jr.log.ERROR([t,ge.SESSION_DESCRIPTION,z.ANSWER_ACK,Ne.NEGOTIATION_PROGRESS.ERRORS.FAILED_RENEGOTIATION],e);});}):jr.log.ERROR([s,ge.SESSION_DESCRIPTION,z.ANSWER,Ne.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_ANSWER]);},inRoom:e=>{const{pc_config:{iceServers:t},sid:n,rid:r,tieBreaker:i}=e,s=Hi.getSkylinkState(r),a=Hi.getInitOptions(),{priorityWeightScheme:c}=a,d=new Vn;let l=0;if(s.room.connection.peerConfig=yt.setIceServers(t),s.room.inRoom=!0,l=c===Z.AUTO?0:c===Z.ENFORCE_OFFERER?2e15:-2e15,s.peerPriorityWeight=i+l,s.user.sid=n,s.inRoom=!0,Wn.updatePeerMediaWithUserSid(s.room,n),Hi.setSkylinkState(s,r),Lr(C({peerId:s.user.sid,peerInfo:Ke.getCurrentSessionInfo(s.room),isSelf:!0,room:s.room})),s.streams.userMedia){Object.keys(s.streams.userMedia).forEach(e=>{const t=s.streams.userMedia[e].stream;Lr(o({stream:t,streamId:t.id,peerId:s.user.sid,room:s.room,isSelf:!0,peerInfo:Ke.getCurrentSessionInfo(s.room),isVideo:yr(t),isAudio:Ar(t)}));});}d.enterRoom(s);},enter:e=>{kt(e,wt.ENTER);},offer:e=>{Ht(e);},welcome:e=>{kt(e,wt.WELCOME);},candidate:e=>{const{candidate:t,mid:n,rid:r}=e,i=Hi.getSkylinkState(r),{room:s}=i,o=Hi.getInitOptions(),a=i.peerConnections[n],c=i.peerEndOfCandidatesCounter[n]||{},{RTCIceCandidate:d}=window,{ICE_CANDIDATE:{CANDIDATE_HANDLER:l},PEER_CONNECTION:u,STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:p}}=Ne,S=new It;if(!t&&!e.id)return jr.log.WARN([n,l.tag,null,l.INVALID_CANDIDATE],e),null;const E=new d({sdpMLineIndex:e.label,candidate:t,sdpMid:e.id}),g=`can-${E.foundation}`,m=E.candidate.split(" ")[7]||"";jr.log.DEBUG([n,l.tag,`${g}:${m}`,l.VALID_CANDIDATE],E),c.len=c.len||0,c.hasSet=!1,c.len+=1,Hi.setSkylinkState(i,r);const h={candidate:{candidate:E.candidate,sdpMid:E.sdpMid,sdpMLineIndex:E.sdpMLineIndex},error:null};if(Lr(f({room:s,state:B.RECEIVED,peerId:n,candidateId:g,candidateType:m,candidate:h.candidate,error:h.error})),!a||a.signalingState===j.CLOSED)return jr.log.WARN([n,l.tag,`${g}:${m}`,u.NO_PEER_CONNECTION]),h.error=new Error(u.NO_PEER_CONNECTION),S.send(s.id,p.PROCESS_FAILED,n,g,h.candidate,h.error),Lr(f({room:s,state:B.DROPPED,peerId:n,candidateId:g,candidateType:m,candidate:h.candidate,error:h.error})),ei.signalingEndOfCandidates(n,i),null;if(o.filterCandidatesType[m]){if(!i.hasMCU||!o.forceTURN)return jr.log.WARN([n,l.tag,`${g}:${m}`,l.FILTERED_CANDIDATE],E),h.error=new Error(l.FILTERED_CANDIDATE),S.send(s.id,p.DROPPED,n,g,h.candidate,h.error),Lr(f({room:s,state:B.DROPPED,peerId:n,candidateId:g,candidateType:m,candidate:h.candidate,error:h.error})),ei.signalingEndOfCandidates(n,i),null;jr.log.WARN([n,l.tag,`${g}:${m}`,l.FILTERING_FLAG_NOT_HONOURED],E);}a.remoteDescription&&a.remoteDescription.sdp&&a.localDescription&&a.localDescription.sdp?yt.addIceCandidate(n,g,m,E,i):yt.addIceCandidateToQueue(n,g,m,E,i),ei.signalingEndOfCandidates(n,i);let R=i.gatheredCandidates[n];return R||(R={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),R.receiving[m].push({sdpMid:E.sdpMid,sdpMLineIndex:E.sdpMLineIndex,candidate:E.candidate}),i.gatheredCandidates[n]=R,Hi.setSkylinkState(i,r),null},getPeerList:e=>{const{result:t,type:n}=e,r=t;jr.log.INFO(["Server",null,n,"Received list of peers"],r),Lr(v({state:J.DISPATCHED,privilegePeerId:null,peerList:r}));},introduceError:e=>{const t=Hi.getSkylinkState(),{room:n,user:r}=t;jr.log.WARN(["Server",null,e.type,`Introduce failed. Reason: ${e.reason}`]),(new Jt).send(n.id,e),Lr(((e={})=>new s("introduceStateChange",{detail:e}))({state:"introduceStateChange".ERROR,privilegedPeerId:r.sid,receivingPeerId:e.receivingPeerId,sendingPeerId:e.sendingPeerId,reason:e.reason}));},stream:e=>{const{mid:t,rid:n,status:r,streamId:i,settings:s}=e,d=mr(n),{room:l,peerInformations:u}=d;if(r===le.SCREENSHARE_REPLACE_START&&(u[t].screenshare=!0,Hi.setSkylinkState(d,l.id),Lr(a({room:l,peerId:t,isSelf:!1,peerInfo:Ke.getPeerInfo(t,l),stream:null,isReplace:!0,streamId:i,isVideo:!!s.audio,isAudio:!!s.video}))),r===le.USER_MEDIA_REPLACE_START&&Lr(o({room:l,peerId:t,isSelf:!1,peerInfo:Ke.getPeerInfo(t,l),stream:null,streamId:i,isReplace:!0,replacedStreamId:s.replacedStreamId,isVideo:!!s.audio,isAudio:!!s.video})),r===le.ENDED&&(s.isScreensharing&&(u[t].screenshare=!1,Hi.setSkylinkState(d,l.id)),Lr(c({room:l,peerId:t,peerInfo:Ke.getPeerInfo(t,l),streamId:i,isSelf:!1,isScreensharing:s.isScreensharing,options:s,isVideo:!!s.audio,isAudio:!!s.video}))),r===le.REPLACED_STREAM_ENDED){const e=Ve.retrieveRemoteStreams(d,t);if(!e)return null;const n=Object.values(e);let r=null;for(let t=0;t<n.length;t+=1)if(e[t].id===i){r=n[t];break}if(!r)return null;r.getTracks().forEach(e=>{Cn.onremovetrack(t,l,i,e,!1);});}return null},bye:e=>{const{mid:t,rid:n,publisherId:r}=e,i=n;let s=t;Hi.getSkylinkState(i).hasMCU&&(s=r),jr.log.INFO([s,ge.PEER_CONNECTION,null,Ne.ROOM.LEAVE_ROOM.PEER_LEFT.START]);try{Qt(i,s),((e,t)=>{Hi.getSkylinkState(e).peerConnections[t]&&qt(e,t);})(i,s),((e,t)=>{const n=Hi.getSkylinkState(e);setTimeout(()=>{delete n.peerConnections[t],Hi.setSkylinkState(n,n.room.id),jr.log.INFO([t,ge.PEER_CONNECTION,null,Ne.ROOM.LEAVE_ROOM.PEER_LEFT.SUCCESS]);},500),delete n.peerInformations[t],delete n.peerMedias[t],delete n.remoteStreams[t],delete n.peerMessagesStamps[t],delete n.peerEndOfCandidatesCounter[t],delete n.peerCandidatesQueue[t],delete n.sdpSessions[t],delete n.peerStats[t],delete n.peerBandwidth[t],delete n.gatheredCandidates[t],delete n.peerCustomConfigs[t],delete n.peerConnStatus[t];})(i,s),((e,t)=>{const n=Hi.getSkylinkState(e);ei.closeDataChannel(n,t);})(i,s);}catch(e){jr.log.DEBUG([s,ge.ROOM,null,Ne.ROOM.LEAVE_ROOM.PEER_LEFT.ERROR],e);}},recording:e=>{const{action:t,rid:n,recordingId:r,error:i}=e,s=mr(n);"on"===t?((e,t)=>{const n=Object.assign({},e),{room:r}=n;jr.log.DEBUG([_e.MCU,ge.RECORDING,t,Ne.RECORDING.START_SUCCESS]),_n.send(r.id,Ne.STATS_MODULE.HANDLE_RECORDING_STATS.START,t,null,null),n.currentRecordingId=t,n.recordings[t]={active:!0,state:ae.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,error:null},n.recordingStartInterval=setTimeout(()=>{jr.log.INFO([_e.MCU,ge.RECORDING,t,Ne.RECORDING.MIN_RECORDING_TIME_REACHED]),n.recordingStartInterval=null;},4e3),Hi.setSkylinkState(n,r.id),vn(ae.START,t);})(s,r):"off"===t?((e,t)=>{const n=Object.assign({},e),{room:r,recordings:i}=n;_n.send(r.id,Ne.STATS_MODULE.HANDLE_RECORDING_STATS.STOP,t,null,null),i[t]?(n.currentRecordingId=null,n.recordingStartInterval&&(clearTimeout(n.recordingStartInterval),jr.log.WARN([_e.MCU,ge.RECORDING,t,Ne.RECORDING.ERRORS.STOP_ABRUPT]),n.recordingStartInterval=null),jr.log.DEBUG([_e.MCU,ge.RECORDING,t,Ne.RECORDING.STOP_SUCCESS]),n.recordings[t].active=!1,n.recordings[t].state=ae.STOP,n.recordings[t].endedDateTime=(new Date).toISOString(),Hi.setSkylinkState(n,r.id),vn(ae.STOP,t)):jr.log.ERROR([_e.MCU,ge.RECORDING,t,Ne.RECORDING.ERRORS.SESSION_EMPTY]);})(s,r):"error"===t&&(vn(null,r,i),jr.log.ERROR([_e.MCU,ge.RECORDING,r,Ne.RECORDING.ERRORS.MCU_RECORDING_ERROR],i),_n.send(s.room.id,Ne.STATS_MODULE.HANDLE_RECORDING_STATS.MCU_RECORDING_ERROR,r,null,i));},redirect:e=>{jr.log.INFO(["Server",null,e.type,"System action warning:"],e),Object.keys((new ii).getAllStates()).length>1&&e.action===X.REJECT&&Tr(),"toClose"===e.reason&&(e.reason="toclose"),Hi.removeSkylinkState(Hi.getSkylinkState(e.rid)),Lr((e=>new s("systemAction",{detail:e}))({action:e.action,info:e.info,reason:e.reason,rid:e.rid}));},rtmp:e=>{const{action:t,rid:n}=e,r=mr(n);jr.log.DEBUG([_e.MCU,"RTMP",null,Ne.RTMP.message_received_from_sig]),t===On?((e,t)=>{const{rtmpSessions:n}=e,{rtmpId:r,peerId:i,streamId:s}=t;if(!n[r]){const t=Object.assign({},e);jr.log.DEBUG([_e.MCU,"RTMP",Ne.RTMP.started_success]),t.rtmpSessions[r]={active:!0,state:Se.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,peerId:i,streamId:s},Lr(P({state:Se.START,rtmpId:r,error:null})),Hi.setSkylinkState(t,t.room.id);}})(r,e):t===An?((e,t)=>{const{rtmpSessions:n}=e,{rtmpId:r}=t,i=Object.assign({},e);n[r]?(jr.log.DEBUG([_e.MCU,"RTMP",Ne.RTMP.stopped_success]),i.rtmpSessions[r].active=!1,i.rtmpSessions[r].state=Se.STOP,i.rtmpSessions[r].endedDateTime=(new Date).toISOString(),Lr(P({state:Se.STOP,rtmpId:r,error:null})),Hi.setSkylinkState(i,i.room.id)):jr.log.DEBUG([_e.MCU,"RTMP",Ne.RTMP.stop_session_empty]);})(r,e):((e,t)=>{const{error:n,rtmpId:r}=t,{rtmpSessions:i}=e,s=new Error(n||"Unkown Error"),o=Object.assign({},e);i[r]?(jr.log.DEBUG([_e.MCU,"RTMP",Ne.RTMP.error_session]),o.rtmpSessions[r].state=Se.ERROR,o.rtmpSessions[r].error=s,i[r].active&&(jr.log.DEBUG([_e.MCU,"RTMP",Ne.RTMP.error_Session_abrupt]),o.rtmpSessions[r].active=!1),Lr(P({state:Se.ERROR,rtmpId:r,error:s})),Hi.setSkylinkState(o,o.room.id)):jr.log.DEBUG([_e.MCU,"RTMP",Ne.RTMP.error_session_empty]);})(r,e);},muteVideoEvent:e=>{const{type:t,mid:n,muted:r,rid:i,stamp:s,streamId:o}=e,a=n,c=Hi.getSkylinkState(i),{room:d}=c;if(!kn(c,a))if(jr.log.INFO([a,null,t,Ne.MEDIA_STREAM.VIDEO_MUTED,r,o],e),c.peerInformations[a]){if(c.peerMessagesStamps[a]){if(s<c.peerMessagesStamps[a].videoMuted)return void jr.log.WARN([a,ge.SIG_SERVER,t,Ne.SIGNALING.OUTDATED_MSG],e);c.peerMessagesStamps[a].videoMuted=s;}c.peerInformations[a].mediaStatus[o]||(c.peerInformations[a].mediaStatus[o]={}),c.peerInformations[a].mediaStatus[o].videoMuted=r?Ee.MUTED:Ee.ACTIVE,Hi.setSkylinkState(c,d.id),bn(c,o,a);}else jr.log.WARN([a,ge.PEER_INFORMATION,t,`${Ne.PEER_INFORMATIONS.NO_PEER_INFO} ${a}`]);},muteAudioEvent:e=>{const{type:t,mid:n,rid:r,muted:i,stamp:s,streamId:o}=e,a=n,c=Hi.getSkylinkState(r),{room:d}=c;if(!kn(c,a))if(jr.log.INFO([a,ge.SIG_SERVER,t,Ne.MEDIA_STREAM.AUDIO_MUTED,i,o],e),c.peerInformations[a]){if(c.peerMessagesStamps[a]){if(s<c.peerMessagesStamps[a].audioMuted)return void jr.log.WARN([a,ge.SIG_SERVER,t,Ne.SIGNALING.OUTDATED_MSG],e);c.peerMessagesStamps[a].audioMuted=s;}c.peerInformations[a].mediaStatus[o]||(c.peerInformations[a].mediaStatus[o]={}),c.peerInformations[a].mediaStatus[o].audioMuted=i?Ee.MUTED:Ee.ACTIVE,Hi.setSkylinkState(c,d.id),bn(c,o,a);}else jr.log.WARN([a,ge.PEER_INFORMATION,t,`${Ne.PEER_INFORMATIONS.NO_PEER_INFO} ${a}`]);},setUserData:e=>{const{type:t,mid:n,rid:r,userData:i,stamp:s}=e,o=Hi.getSkylinkState(r),{peerInformations:a,peerMessagesStamps:c}=o,d=n,{PEER_INFORMATIONS:l}=Ne;let u=i.replace(/&quot;/g,'"');try{u=JSON.parse(u);}catch(e){jr.log.INFO([d,null,t,`${l.USER_DATA_NOT_JSON}`],u);}finally{jr.log.INFO([d,null,t,`${l.UPDATE_USER_DATA}`],u);}if(a[d]){if(c[d]&&ur(s)){if(s<c[d].userData)return void jr.log.WARN([d,null,t,`${l.OUTDATED_MSG}`],e);c[d].userData=s;}a[d].userData=u||{},Lr(T({peerId:d,peerInfo:Ke.getPeerInfo(d,o.room),isSelf:!1}));}else jr.log.INFO([d,null,t,`${l.NO_PEER_INFO} ${d}`]);},mediaInfoEvent:e=>{const{mid:t,rid:n,mediaType:r,mediaId:i,publisherId:s}=e,o=Hi.getSkylinkState(n),{hasMCU:a,room:c}=o,d=a?s:t;try{if(!((e,t)=>{const n=e,{mediaId:r,publisherId:i}=t;return n.peerMedias[i]=n.peerMedias[i]||{},!n.peerMedias[i][r]&&(n.peerMedias[i][r]=t,Hi.setSkylinkState(n,n.room.id),!0)})(o,e)){const t=Object.values(Te);for(let s=0;s<t.length;s+=1)if(wn(n,d,i,t[s],e[t[s]])){if(Wn.updatePeerMediaInfo(o.room,d,i,t[s],e[t[s]]),t[s]===Te.MEDIA_STATE)return void Mn(c,r,d,e);if(t[s]===Te.TRANSCEIVER_MID)return void Pn(d,e);Nn(d,e,t[s]);}}}catch(e){jr.log.ERROR([d,ge.SIG_SERVER,Ne.MEDIA_INFO.FAILED_PROCESSING_MEDIA_INFO_EVENT],e);}},storedMessages:e=>{gt.processStoredMessages(e);}};class Un{userMessageHandler(...e){Ln.userMessageHandler(...e);}answerHandler(...e){Ln.answer(...e);}answerAckHandler(...e){Ln.answerAck(...e);}inRoomHandler(...e){Ln.inRoom(...e);}enterRoomHandler(...e){Ln.enter(...e);}offerHandler(...e){Ln.offer(...e);}welcomeHandler(...e){Ln.welcome(...e);}candidateHandler(...e){Ln.candidate(...e);}getPeerListHandler(...e){Ln.getPeerList(...e);}introduceErrorHandler(...e){Ln.introduceError(...e);}byeHandler(...e){Ln.bye(...e);}streamHandler(...e){Ln.stream(...e);}recordingHandler(...e){Ln.recording(...e);}redirectHandler(...e){Ln.redirect(...e);}rtmpHandler(...e){Ln.rtmp(...e);}setUserDataHandler(...e){Ln.setUserData(...e);}mediaInfoEventHandler(...e){Ln.mediaInfoEvent(...e);}muteAudioEventHandler(...e){Ln.muteAudioEvent(...e);}muteVideoEventHandler(...e){Ln.muteVideoEvent(...e);}storedMessagesHandler(...e){Ln.storedMessages(...e);}}const Gn={joinRoom:e=>{const{room:t}=e,n=Hi.getSkylinkState(t.id),r=Hi.getInitOptions();return {type:de.JOIN_ROOM,uid:n.user.uid,cid:n.key,rid:t.id,userCred:n.user.token,timeStamp:n.user.timeStamp,apiOwner:n.appKeyOwner,roomCred:t.token,start:t.startDateTime,len:t.duration,isPrivileged:n.isPrivileged,autoIntroduce:n.autoIntroduce,key:r.appKey}},enterRoom:e=>{const{room:t}=e,n=Hi.getSkylinkState(t.id),r=Hi.getInitOptions(),{user:i,peerPriorityWeight:s,enableIceRestart:o,hasMCU:a}=n,{enableDataChannel:c}=r,{AdapterJS:d}=window,l=Ke.getUserInfo(t),u={type:de.ENTER,mid:i.sid,rid:t.id,agent:d.webrtcDetectedBrowser,version:(d.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,receiveOnly:Ke.getCurrentSessionInfo(t).config.receiveOnly,weight:s,temasysPluginVersion:d.WebRTCPlugin.plugin?d.WebRTCPlugin.plugin.VERSION:null,enableDataChannel:c,enableIceRestart:o,SMProtocolVersion:ne,DTProtocolVersion:G};return a&&(u.target=_e.MCU,u.publisherId=i.sid),u},welcome:(e,t)=>{const n=Hi.getSkylinkState(e.id),r=Hi.getInitOptions(),{user:i,peerPriorityWeight:s,enableIceRestart:o,room:a}=n,{enableDataChannel:c}=r,{AdapterJS:d}=window,l=Ke.getUserInfo(a);return {type:de.WELCOME,mid:i.sid,rid:a.id,agent:d.webrtcDetectedBrowser,version:(d.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,receiveOnly:Ke.getCurrentSessionInfo(a).config.receiveOnly,weight:s,temasysPluginVersion:d.WebRTCPlugin.plugin?d.WebRTCPlugin.plugin.VERSION:null,enableDataChannel:c,enableIceRestart:o,SMProtocolVersion:ne,DTProtocolVersion:G,target:t}},offer:(...e)=>ei.createOffer(...e),answer:(...e)=>ei.createAnswer(...e),answerAck:(e,t,n)=>{const{room:r,user:i}=e;return {type:de.ANSWER_ACK,rid:r.id,mid:i.sid,target:t,success:n}},candidate:(e,t,n)=>{const r=t.room.id,i=Hi.getSkylinkState(r);return {type:de.CANDIDATE,label:n.sdpMLineIndex,id:n.sdpMid,candidate:n.candidate,mid:i.user.sid,target:e,rid:r}},setUserData:e=>({type:de.UPDATE_USER,mid:e.user.sid,rid:e.room.id,userData:Er(e.userData)?e.userData:JSON.stringify(e.userData),stamp:(new Date).getTime()}),getPeerList:e=>({type:de.GET_PEERS,showAll:e}),restartOffer:(e,t,n)=>{const r=Hi.getSkylinkState(e),{AdapterJS:i}=window,s=Hi.getInitOptions(),{user:o,room:a,enableIceRestart:c,peerInformations:d,peerPriorityWeight:l}=r;return {type:de.RESTART,mid:o.sid,rid:a.id,agent:i.webrtcDetectedBrowser,version:(i.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:Ke.getUserInfo(a),target:t,weight:l,receiveOnly:Ke.getCurrentSessionInfo(a).config.receiveOnly,publishOnly:Ke.getCurrentSessionInfo(a).config.publishOnly,enableDataChannel:s.enableDataChannel,enableIceRestart:c,doIceRestart:!0===n&&c&&d[t]&&d[t].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:i.WebRTCPlugin.plugin?i.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:ne,DTProtocolVersion:G}},stream:(e,t,n,r,i)=>({type:de.STREAM,mid:t.sid,rid:e,status:r,streamId:n.id,settings:i}),recording:(e,t)=>({type:t,rid:e,target:_e.MCU}),rtmp:(e,t,n,r,i=null,s=null)=>{const o={type:e,rid:t,rtmpId:r,streamId:i,endpoint:s,mid:n,target:_e.MCU};return e===de.STOP_RTMP&&(delete o.endpoint,delete o.streamId),o},bye:(e,t)=>{const{room:n,user:r,hasMCU:i}=e,s={type:de.BYE,rid:n.id,mid:r.sid,target:t};return i&&(s.publisherId=r.sid),s},roomLock:e=>{const{user:t,room:n,roomLocked:r}=e;return {type:de.ROOM_LOCK,mid:t.sid,rid:n.id,lock:r}},mediaInfoEvent:(e,t,n)=>({type:de.MEDIA_INFO_EVENT,rid:e.room.id,mid:n.publisherId,target:t,publisherId:n.publisherId,mediaId:n.mediaId,mediaType:n.mediaType,mediaState:n.mediaState,transceiverMid:n.transceiverMid}),muteAudioEvent:(e,t)=>{const n=Hi.getSkylinkState(e.id),{user:r,streamsMutedSettings:i}=n;return {type:de.MUTE_AUDIO_EVENT,mid:r.sid,rid:e.id,muted:i[t].audioMuted,stamp:(new Date).getTime(),streamId:t}},muteVideoEvent:(e,t)=>{const n=Hi.getSkylinkState(e.id),{user:r,streamsMutedSettings:i}=n;return {type:de.MUTE_VIDEO_EVENT,mid:r.sid,rid:e.id,muted:i[t].videoMuted,stamp:(new Date).getTime(),streamId:t}},getStoredMessages:e=>{const{user:t,room:n}=e;return {mid:t.sid,rid:n.id,target:t.sid,type:de.GET_STORED_MESSAGES}},userMessages:(e,t,n)=>{const r=[],{user:i,room:s}=e,{listOfPeers:o,isPrivate:a,isPersistent:c,secretId:d}=t,l={data:n,mid:i.sid,rid:s.id,msgId:Cr(),type:de.MESSAGE};if(d&&(l.secretId=d),a)for(let e=0;e<o.length;e+=1){const t=o[e],i=Object.assign({},l);i.target=t,r.push(i),jr.log.DEBUG([t,ge.MESSAGING,null,Ne.MESSAGING.PRIVATE_MESSAGE],{message:n});}else c&&(l.isPersistent=c),r.push(l),jr.log.DEBUG([null,ge.MESSAGING,null,Ne.MESSAGING.BROADCAST_MESSAGE],{message:n});return r}};class xn{constructor(){this.messageBuilders=Gn;}getJoinRoomMessage(...e){return this.messageBuilders.joinRoom(...e)}getWelcomeMessage(...e){return this.messageBuilders.welcome(...e)}getEnterRoomMessage(...e){return this.messageBuilders.enterRoom(...e)}getAnswerMessage(...e){return this.messageBuilders.answer(...e)}getAnswerAckMessage(...e){return this.messageBuilders.answerAck(...e)}getOfferMessage(...e){return this.messageBuilders.offer(...e)}getCandidateMessage(...e){return this.messageBuilders.candidate(...e)}getSetUserDataMessage(e){return this.messageBuilders.setUserData(e)}getPeerListMessage(...e){return this.messageBuilders.getPeerList(...e)}getRestartOfferMessage(...e){return this.messageBuilders.restartOffer(...e)}getStreamMessage(...e){return this.messageBuilders.stream(...e)}getRecordingMessage(...e){return this.messageBuilders.recording(...e)}getPeerMessagesForSignaling(...e){return this.messageBuilders.signalingMessages(...e)}getMuteAudioMessage(...e){return this.messageBuilders.muteAudioEvent(...e)}getMuteVideoMessage(...e){return this.messageBuilders.muteVideoEvent(...e)}getRTMPMessage(...e){return this.messageBuilders.rtmp(...e)}getByeMessage(...e){return this.messageBuilders.bye(...e)}getRoomLockMessage(...e){return this.messageBuilders.roomLock(...e)}getMediaInfoEventMessage(...e){return this.messageBuilders.mediaInfoEvent(...e)}getGetStoredMessagesMessage(...e){return this.messageBuilders.getStoredMessages(...e)}getUserMessages(...e){return this.messageBuilders.userMessages(...e)}}const Bn={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"};let Fn=null;class Vn{constructor(){return Fn||(Fn=this),this.socket=null,this.attempts=0,this.timestamp=(new Date).valueOf(),this.messageHandler=new Un,this.messageBuilder=new xn,this.config=null,Fn}resetSocketConfig(e){return {protocol:e,socketType:window.WebSocket?Bn.WEBSOCKET:Bn.POLLING,signalingServerProtocol:e,socketSession:{finalAttempts:0,attempts:0},fallbackType:null,signalingServerPort:null,socketTimeout:!1}}createSocket(e){const t=Hi.getSkylinkState(e);return t.socketSession=this.resetSocketConfig(t.signalingServerProtocol),Hi.setSkylinkState(t,e),new Promise((t,n)=>{try{null!==this.socket&&this.socket instanceof window.io.Socket&&this.socket.connected?t():this.tryCreateSocket(e,t,n);}catch(r){this.handleCreateSocketFailure(e,t,n,r);}})}tryCreateSocket(e,t,n){const r=Hi.getSkylinkState(e),{socketSession:i}=r;this.socket=et({config:i,roomKey:e}),it(e,this,t,n);}handleCreateSocketFailure(e,t,n,r){const i=Hi.getSkylinkState(e),{socketSession:s}=i;jr.log.ERROR(Ne.INIT.SOCKET_CREATE_FAILED,r),Lr(D({session:Pe(s),errorCode:ee.CONNECTION_FAILED,type:s.fallbackType,error:r})),n(r);}dispatchHandshakeProgress(e,t){Lr(g({peerId:e.user.sid,state:z[t],error:null,room:e.room}));}answer(...e){return this.messageBuilder.getAnswerMessage(...e).then(t=>{const n=e[0];return this.sendMessage(t),this.dispatchHandshakeProgress(n,"ANSWER"),t})}answerAck(...e){const t=this.messageBuilder.getAnswerAckMessage(...e),n=e[0];this.sendMessage(t),this.dispatchHandshakeProgress(n,"ANSWER_ACK");}enterRoom(...e){const t=this.messageBuilder.getEnterRoomMessage(...e);this.sendMessage(t),this.dispatchHandshakeProgress(...e,"ENTER");}joinRoom(...e){const t=this.messageBuilder.getJoinRoomMessage(...e);this.sendMessage(t);}offer(...e){const t=e[0],n=e[1],r=Hi.getSkylinkState(t.id);r.peerConnections[n].negotiating?jr.log.DEBUG([n,ge.SIG_SERVER,null,`${Ne.SIGNALING.ABORTING_OFFER}`]):this.messageBuilder.getOfferMessage(...e).then(e=>{this.sendMessage(e),this.dispatchHandshakeProgress(r,"OFFER");});}welcome(...e){const t=this.messageBuilder.getWelcomeMessage(...e);this.sendMessage(t);}noop(){return null}sendCandidate(...e){const t=this.messageBuilder.getCandidateMessage(...e);t&&this.sendMessage(t);}setUserData(e){const t=this.messageBuilder.getSetUserDataMessage(e);t&&this.sendMessage(t);}getPeerList(e){const t=this.messageBuilder.getPeerListMessage(e);t&&this.sendMessage(t);}stream(...e){const t=this.messageBuilder.getStreamMessage(...e);t&&this.sendMessage(t);}recording(...e){const t=this.messageBuilder.getRecordingMessage(...e);this.sendMessage(t);}rtmp(...e){const t=this.messageBuilder.getRTMPMessage(...e);this.sendMessage(t);}muteAudioEvent(e,t){const n=this.messageBuilder.getMuteAudioMessage(e,t);n&&this.sendMessage(n);}muteVideoEvent(e,t){const n=this.messageBuilder.getMuteVideoMessage(e,t);n&&this.sendMessage(n);}roomLock(e){const t=this.messageBuilder.getRoomLockMessage(e);t&&this.sendMessage(t);}bye(...e){const t=this.messageBuilder.getByeMessage(...e);this.sendMessage(t);}mediaInfoEvent(e,t,n){const r=this.messageBuilder.getMediaInfoEventMessage(e,t,n);r&&this.sendMessage(r);}getStoredMessages(e){const t=this.messageBuilder.getGetStoredMessagesMessage(e);t&&this.sendMessage(t);}onMessage(e){const t=Hi.getSkylinkState(JSON.parse(e).rid);if(!t)return;const{socketSession:n}=t;Lr(y({message:e,socketSession:Pe(n)})),tt(this.messageHandler,JSON.parse(e));}sendMessage(e){st(e)||(jr.log.INFO(["SIG SERVER",null,e.type,"sent"]),nt(this.socket,e));}sendUserMessage(e,t,n){const r=this.messageBuilder.getUserMessages(e,t,n);Array.isArray(r)&&r.length&&r.map(e=>(this.sendMessage(e),null));}updateAttempts(e,t,n){this.attempts=n;const r=Hi.getSkylinkState(e),{socketSession:i}=r;i.socketSession[t]=n,Hi.setSkylinkState(r,e);}getAttempts(){return this.attempts}}const jn={retrieveTransceiverMid:(e,t)=>{const n=Hi.getSkylinkState(e.id),{peerConnections:r}=n,i=Object.values(r);let s=null;for(let e=0;e<i.length;e+=1){const n=i[e].getTransceivers();for(let e=0;e<n.length;e+=1)if(n[e].sender.track&&n[e].sender.track.id===t.id){s=n[e].mid;break}}return s},retrieveMediaState:e=>e.readyState===fe.ENDED?Re.UNAVAILABLE:e.muted?Re.MUTED:Re.ACTIVE,retrieveMediaId:(e,t)=>{return `${e===he.AUDIO?"AUDIO":"VIDEO"}_${t}`},buildPeerMediaInfo:(e,t,n,r,i)=>({publisherId:t,mediaId:jn.retrieveMediaId(n.kind,r),mediaType:i,mediaState:jn.retrieveMediaState(n),transceiverMid:jn.retrieveTransceiverMid(e,n),streamId:r,trackId:n.id,mediaMetaData:"",simulcast:""}),retrieveStreamIdOfTrack:(e,t)=>{const n=Hi.getSkylinkState(e.id),{streams:r}=n,i=Object.values(r.userMedia);let s=null;for(let e=0;e<i.length;e+=1){const n=i[e].stream.getTracks();for(let r=0;r<n.length;r+=1)if(Me(n[r],t)){s=i[e].id;break}}return s},retrieveTracks:e=>{const t=Hi.getSkylinkState(e.id),{streams:n}=t,r=[];return Object.values(n.userMedia).map(e=>e.stream).forEach(e=>{e.getTracks().forEach(e=>{r.push(e);});}),r},updatePeerMediaInfo:(e,t,n,r,i=!1,s=!1,o=!1)=>{try{((e,t,n,r,i=!1,s=!1,o=!1)=>{const a=Hi.getSkylinkState(e.id);!o&&i&&s?(a.peerMedias[t][r][i]=s,jr.log.INFO([t,ge.PEER_MEDIA,null,`${Ne.MEDIA_INFO.UPDATE_SUCCESS} -- ${r} - ${i}: ${s}`])):!o||i||s||(a.peerMedias[t]=a.peerMedias[t]||{},a.peerMedias[t][r]=o),Hi.setSkylinkState(a,e.id);})(e,t,0,r,i,s,o),((e,t,n,r)=>{const i=Hi.getSkylinkState(e.id);i.user.sid===t&&n&&jn.sendMediaInfoMsg(e,i.peerMedias[t][r]);})(e,t,n,r);}catch(e){const n=o?JSON.stringify(o):`${r} - ${i}: ${s}`;jr.log.ERROR([t,ge.PEER_MEDIA,null,`${Ne.MEDIA_INFO.ERRORS.FAILED_UPDATING} -- ${n}`],e);}},sendMediaInfoMsg:(e,t)=>{const n=new Vn,r=Hi.getSkylinkState(e.id),{user:i,hasMCU:s,peerConnections:o}=r;(s?[_e.MCU]:Object.keys(o).filter(e=>e!==i.sid&&e!==_e.MCU)).forEach(e=>{n.mediaInfoEvent(r,e,t);});},parseSDPForTransceiverMid:(e,t,n)=>{const r=Hi.getSkylinkState(e.id),{peerMedias:i}=r,s=Object.values(i[t]),o=Yr.getTransceiverMid(n),a=o.audio,c=o.video;for(let n=0;n<s.length;n+=1){const r=s[n];r.transceiverMid=r.mediaState===Re.UNAVAILABLE?r.transceiverMid:null;for(let n=0;n<a.length;n+=1)if(a[n].streamId===r.streamId&&("sendonly"===a[n].direction||"sendrecv"===a[n].direction)){jn.updatePeerMediaInfo(e,t,!1,r.mediaId,Te.TRANSCEIVER_MID,a[n].transceiverMid);break}for(let n=0;n<c.length;n+=1)if(c[n].streamId===r.streamId&&("sendonly"===c[n].direction||"sendrecv"===c[n].direction)){jn.updatePeerMediaInfo(e,t,!1,r.mediaId,Te.TRANSCEIVER_MID,c[n].transceiverMid);break}}},retrieveValueGivenTransceiverMid:(e,t,n,r)=>{const{peerMedias:i}=e,s=Object.values(i[t]);for(let e=0;e<s.length;e+=1)if(s[e].transceiverMid===n)return s[e][r];return null},retrieveFormattedMediaInfo:(e,t)=>{const n=Hi.getSkylinkState(e.id),{peerMedias:r}=n,i=Object.values(r[t]),s=[];for(let e=0;e<i.length;e+=1){const t=i[e],n=Pe(t);delete n.trackId,delete n.streamId,s.push(n);}return s},resetPeerMedia:(e,t)=>{const n=Hi.getSkylinkState(e.id);return n.peerMedias[t]&&(n.peerMedias[t]={}),n},populatePeerMediaInfo:(e,t,n)=>{const r=e.peerMedias[n.publisherId]||{};return r[n.mediaId]=n,((e,t)=>!or(e)&&e[t])(t,n.mediaId)&&(r[n.mediaId].streamId=n.transceiverMid===t[n.mediaId].transceiverMid?t[n.mediaId].streamId:""),r},processOnRemoveTrack:(e,t,n)=>{const{AdapterJS:r}=window;if(r.webrtcDetectedBrowser===Ie.REACT_NATIVE&&n){const{room:r}=e,i={track:{id:null,kind:null}},s={id:null};if(i.track.id=n.trackId,i.track.kind=n.mediaType===me.AUDIO||n.mediaType===me.AUDIO_MIC?he.AUDIO:he.VIDEO,s.id=n.streamId,i.stream=s,!(i.track.id||i.track.kind||s.id))return void jr.log.DEBUG([t,ge.MEDIA_STREAM,null,`${Ne.BROWSER_AGENT.REACT_NATIVE.ERRORS.DROPPING_ONREMOVETRACK}`],i);Cn.onremovetrack(t,r,n.mediaType===me.VIDEO_SCREEN,i);}}};class Wn{static updatePeerMediaWithUserSid(e,t){const n=Hi.getSkylinkState(e.id);n.peerMedias[t]=Object.assign({},n.peerMedias.null),delete n.peerMedias.null,Hi.setSkylinkState(n,e.id),Object.keys(n.peerMedias[t]).forEach(n=>{jn.updatePeerMediaInfo(e,t,!1,n,Te.PUBLISHER_ID,t);});}static updateStreamIdFromOntrack(e,t,n,r){const i=Hi.getSkylinkState(e.id),s=jn.retrieveValueGivenTransceiverMid(i,t,n,Te.MEDIA_ID);jn.updatePeerMediaInfo(e,t,!1,s,Te.STREAM_ID,r);}static isVideoScreenTrack(e,t,n){const{peerMedias:r}=e,i=Object.values(r[t]);for(let e=0;e<i.length;e+=1)if(i[e].transceiverMid===n)return i[e].mediaType===me.VIDEO_SCREEN;return !1}static setMediaStateToUnavailable(e,t,n){jn.updatePeerMediaInfo(e,t,!1,n,Te.MEDIA_STATE,Re.UNAVAILABLE);}static deleteUnavailableMedia(e,t,n=null){const r=Hi.getSkylinkState(e.id);if(t===_e.MCU||!r.peerMedias[t])return;let i;if(n)i=Pe(r.peerMedias[t][n]),delete r.peerMedias[t][n];else{const e=r.peerMedias[t];Object.values(e).forEach(e=>{e.mediaState===Re.UNAVAILABLE&&(i=Pe(e),delete r.peerMedias[t][e.mediaId]);});}Hi.setSkylinkState(r,e.id),jn.processOnRemoveTrack(r,t,i),i&&Lr(w({mediaInfo:i}));}static updatePeerMediaInfo(e,t,n,r,i){jn.updatePeerMediaInfo(e,t,!0,n,r,i);}static updateTransceiverMid(e,t){try{jn.retrieveTracks(e).forEach(n=>{const r=jn.retrieveTransceiverMid(e,n),i=jn.retrieveStreamIdOfTrack(e,n),s=jn.retrieveMediaId(n.kind,i);jn.updatePeerMediaInfo(e,t,!1,s,Te.TRANSCEIVER_MID,r);});}catch(e){jr.log.ERROR([t,ge.PEER_MEDIA,null,Ne.MEDIA_INFO.ERRORS.FAILED_UPDATING_TRANSCEIVER_MID],e);}}static setPeerMediaInfo(e,t,n=[]){try{const r=Hi.getSkylinkState(e.id),i=Pe(r.peerMedias[t])||{},s=jn.resetPeerMedia(e,t);n.forEach(e=>{s.peerMedias[e.publisherId]=jn.populatePeerMediaInfo(s,i,e);}),Hi.setSkylinkState(s,e.id);}catch(e){jr.log.ERROR([t,ge.PEER_MEDIA,null,Ne.MEDIA_INFO.ERRORS.FAILED_SETTING_PEER_MEDIA_INFO]);}}static retrieveStreamId(e,t,n,r){const i=Hi.getSkylinkState(e.id),{peerMedias:s}=i,o=s[t][n],a=o.transceiverMid===r?o.streamId:null;return a||jr.log.ERROR([t,ge.PEER_MEDIA,null,Ne.MEDIA_INFO.ERRORS.NO_ASSOCIATED_STREAM_ID]),a}static retrieveMediaId(e,t){return jn.retrieveMediaId(e,t)}static retrieveMediaInfoForOfferAnswer(e,t){const n=Hi.getSkylinkState(e.id).user.sid;return jn.parseSDPForTransceiverMid(e,n,t),jn.retrieveFormattedMediaInfo(e,n)}static processPeerMedia(e,t,n,r,i=!1){const s=Hi.getSkylinkState(e.id).peerMedias[t]||{},o=n.getTracks();let a=null;try{o.forEach(o=>{a=jn.retrieveMediaId(o.kind,n.id),s[a]=jn.buildPeerMediaInfo(e,t,o,n.id,o.kind===he.AUDIO?me.AUDIO_MIC:r?me.VIDEO_SCREEN:me.VIDEO_CAMERA),jn.updatePeerMediaInfo(e,t,i,a,null,null,s[a]);});}catch(e){jr.log.ERROR([t,ge.MEDIA_INFO,Ne.MEDIA_INFO.ERRORS.FAILED_PROCESSING_PEER_MEDIA],e);}}}const Hn=(e,t,n,r,i=!1)=>{const o=Hi.getSkylinkState(r);return (yr(n)&&e||Ar(n)&&t)&&Lr(((e={})=>new s("localMediaMuted",{detail:e}))({streamId:n.id,isScreensharing:i,mediaStatus:o.streamsMediaStatus[n.id]})),!0},Kn=(e,t,n)=>{let r=t;const{streams:{userMedia:i}}=e,s=n||Object.keys(i).filter(e=>i[e].isReplaced);if(0===s.length)return r;if(s.indexOf(r)>-1&&s.splice(s.indexOf(r),1),s.length>1)for(let t=0;t<s.length;t+=1)if(i[s[t]].newStream&&i[s[t]].newStream.id===r){r=s[t],Kn(e,r,s);break}return s[0]},$n=(e,t,n,r)=>{const i=Hi.getSkylinkState(n.id),s=Kn(i,r),{streamsMutedSettings:o}=i;if(e){const e=Wn.retrieveMediaId(he.VIDEO,s);Wn.updatePeerMediaInfo(n,i.user.sid,e,Te.MEDIA_STATE,o[s].videoMuted?Re.MUTED:Re.ACTIVE);}if(t){const t=Wn.retrieveMediaId(he.AUDIO,s);setTimeout(()=>Wn.updatePeerMediaInfo(n,i.user.sid,t,Te.MEDIA_STATE,o[s].audioMuted?Re.MUTED:Re.ACTIVE),e?1050:0);}},Yn=(e,t,n)=>{const{streams:r,streamsMutedSettings:i}=e;let s=!1,o=!1;return r.screenshare&&r.screenshare.id===n&&i[n].videoMuted!==t.videoMuted?o=!0:r.userMedia&&r.userMedia[n]&&(Ar(r.userMedia[n].stream)&&i[n].audioMuted!==t.audioMuted&&(s=!0),yr(r.userMedia[n].stream)&&i[n].videoMuted!==t.videoMuted&&(o=!0)),{hasToggledAudio:s,hasToggledVideo:o}},zn=(e,t,n)=>{const r=Hi.getSkylinkState(e),{streams:i,room:s,peerConnections:o}=r,a=Yn(r,n,t),{hasToggledAudio:c,hasToggledVideo:l}=a;let u=null,p=!1;if(i.userMedia&&i.userMedia[t]?u=i.userMedia[t].stream:i.screenshare&&i.screenshare.id===t&&(u=i.screenshare.stream,p=!0),u)if(((e,t,n)=>{const r=e,{room:i}=r;t.hasToggledAudio&&(r.streamsMutedSettings[n].audioMuted=!r.streamsMutedSettings[n].audioMuted),t.hasToggledVideo&&(r.streamsMutedSettings[n].videoMuted=!r.streamsMutedSettings[n].videoMuted),jr.log.DEBUG(Ne.MEDIA_STREAM.UPDATE_MUTED_SETTINGS,r.streamsMutedSettings,n),Hi.setSkylinkState(r,i.id);})(r,a,t),((e,t)=>{const n=t,{room:r}=n,i=(e=>e.getAudioTracks())(e),s=(e=>e.getVideoTracks())(e);n.streamsMediaStatus[e.id].audioMuted=Ee.UNAVAILABLE,n.streamsMediaStatus[e.id].videoMuted=Ee.UNAVAILABLE,i.forEach(t=>{t.enabled=!n.streamsMutedSettings[e.id].audioMuted,n.streamsMediaStatus[e.id].audioMuted=n.streamsMutedSettings[e.id].audioMuted?Ee.MUTED:Ee.ACTIVE;}),s.forEach(t=>{t.enabled=!n.streamsMutedSettings[e.id].videoMuted,n.streamsMediaStatus[e.id].videoMuted=n.streamsMutedSettings[e.id].videoMuted?Ee.MUTED:Ee.ACTIVE;}),Hi.setSkylinkState(n,r.id),jr.log.DEBUG(Ne.MEDIA_STREAM.UPDATE_MEDIA_STATUS,n.streamsMediaStatus,e.id);})(u,r),Hn(l,c,u,s.id,p),(e=>{const t=Hi.getSkylinkState(e.id).user.sid,n=Ke.getCurrentSessionInfo(e);Lr(T({isSelf:!0,peerId:t,peerInfo:n}));})(s),((e,t,n)=>{const r=Hi.getSkylinkState(e.id);Lr(d({isSelf:!0,peerId:r.user.sid,peerInfo:Ke.getUserInfo(e),streamId:t.id,isScreensharing:n,isAudio:Ar(t),isVideo:yr(t)}));})(s,u,p),ar(Object.keys(o).filter(e=>e!==_e.MCU))){const e=n=>{const{state:r}=n.detail;r===z.ANSWER_ACK&&($n(l,c,s,t),kr(ye.HANDSHAKE_PROGRESS,e));};br(ye.HANDSHAKE_PROGRESS,e);}else setTimeout(()=>{$n(l,c,s,t);},500);},Jn=e=>{switch(e){case 1:return !1;case 0:default:return !0}},Xn=(e,t,n=null)=>{const{streams:r,room:i}=e;if(!dr(t))return void jr.log.ERROR(Ne.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);if(!r.userMedia&&!r.screenshare)return void jr.log.WARN(Ne.MEDIA_STREAM.ERRORS.NO_STREAM);if(n&&!((e,t)=>{const{streams:n}=t;let r=!1;return Object.keys(n.userMedia).forEach(t=>{t===e&&(r=!0);}),n.screenshare&&n.screenshare.id===e&&(r=!0),r})(n,e))return void jr.log.ERROR(Ne.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);const s={audioMuted:Sr(t.audioMuted)?t.audioMuted:!ur(t.audioMuted)||Jn(t.audioMuted),videoMuted:Sr(t.videoMuted)?t.videoMuted:!ur(t.videoMuted)||Jn(t.videoMuted)};let o=[];if(n&&(r.userMedia[n]&&!r.userMedia[n].isReplaced||r.screenshare.id===n&&!r.screenshare.isReplaced)?o.push(n):(o=Object.keys(r.userMedia).filter(e=>!r.userMedia[e].isReplaced),r.screenshare&&!r.screenshare.isReplaced&&o.push(r.screenshare.id)),ar(o))return void jr.log.ERROR(Ne.MEDIA_STREAM.ERRORS.NO_STREAMS_MUTED,t);Object.values(o).filter(t=>Yn(e,s,t).hasToggledAudio||Yn(e,s,t).hasToggledVideo).forEach((e,t)=>{setTimeout(()=>zn(i.id,e,s),0===t?0:1050);});},qn=(e,t)=>{for(let n=0;n<t.length;n+=1)if(e.id===t[n].id)return !0;return !1},Qn=(e,t)=>{const n=e.getTransceivers?e.getTransceivers():[],r=t.getTracks();if(ar(n))return !1;for(let e=0;e<n.length;e+=1)if(n[e].sender.track&&qn(n[e].sender.track,r))return !0;return !1},Zn=(e,t,n,r)=>{const i=e,s=n.getTracks();for(let e=0;e<s.length;e+=1){const o=r.addTrack(s[e],n);o&&Sn.processNewSender(i,t,o);}Hi.setSkylinkState(i,i.room.id);},er=(e,t,n,r)=>{const{peerConnections:i}=e,s=i[t].getSenders();let o=null;return n?(s.forEach(e=>{e.track&&e.track.id===n&&e.track.kind===r&&(o=e);}),o):o},tr=(e,t)=>{const{user:n,room:r}=e,i=n.sid,s=Ke.getCurrentSessionInfo(r);Lr(o({room:r,stream:t,streamId:t.id,isSelf:!0,peerId:i,peerInfo:s,isScreensharing:!1,isVideo:yr(t),isAudio:Ar(t)})),Lr(T({isSelf:!0,peerId:i,peerInfo:s}));},nr=(e,t,n,r)=>{const{AdapterJS:i}=window,{peerConnections:s,hasMCU:o}=e;"edge"===i.webrtcDetectedBrowser&&r(new Error(Ne.PEER_CONNECTION.refresh_no_edge_support));try{if(((e,t)=>{for(let n=0;n<t.length;n+=1)if(t[n])if(Array.isArray(t[n]))for(let r=0;r<t[n].length;r+=1)t[n][r]&&tr(e,t[n][r]);else tr(e,t[n]);})(e,t),Object.keys(s).length>0||o){ei.refreshPeerConnection(Object.keys(s),e,!1,{}).then(()=>{n(t);}).catch(e=>{jr.log.ERROR(Ne.PEER_CONNECTION.ERRORS.REFRESH),r(e);});}else jr.log.WARN(Ne.ROOM.ERRORS.NO_PEERS),n(t);}catch(e){jr.log.ERROR(e);}},rr=e=>{const t={audio:{input:[],output:[]},video:{input:[]}};return e.forEach(e=>{const n={deviceId:e.deviceId||e.sourceId||"default",label:e.label,groupId:e.groupId||null};n.label=n.label||`Source for ${n.deviceId}`,["audio","audioinput"].indexOf(e.kind)>-1?t.audio.input.push(n):["video","videoinput"].indexOf(e.kind)>-1?t.video.input.push(n):"audiooutput"===e.kind&&t.audio.output.push(n);}),t},ir=(e,t,n,r)=>({id:n.id,stream:n,isReplaced:!1,settings:r.settings,constraints:r.getUserMediaSettings}),sr={parseMediaOptions:(e,t)=>{const n=Hi.getSkylinkState(t.room.id),r=e||{};if(n.userData=r.userData||n.userData||"",n.streamsBandwidthSettings={googleX:{},bAS:{}},n.publishOnly=!1,n.sdpSettings={connection:{audio:!0,video:!0,data:!0},direction:{audio:{send:!0,receive:!0},video:{send:!0,receive:!0}}},n.voiceActivityDetection="boolean"!=typeof r.voiceActivityDetection||r.voiceActivityDetection,n.peerConnectionConfig={bundlePolicy:K.BALANCED,rtcpMuxPolicy:$.REQUIRE,iceCandidatePoolSize:0,certificate:Y.AUTO,disableBundle:!1},n.bandwidthAdjuster=null,r.bandwidth&&("number"==typeof r.bandwidth.audio&&(n.streamsBandwidthSettings.bAS.audio=r.bandwidth.audio),"number"==typeof r.bandwidth.video&&(n.streamsBandwidthSettings.bAS.video=r.bandwidth.video),"number"==typeof r.bandwidth.data&&(n.streamsBandwidthSettings.bAS.data=r.bandwidth.data)),r.googleXBandwidth&&("number"==typeof r.googleXBandwidth.min&&(n.streamsBandwidthSettings.googleX.min=r.googleXBandwidth.min),"number"==typeof r.googleXBandwidth.max&&(n.streamsBandwidthSettings.googleX.max=r.googleXBandwidth.max)),r.sdpSettings&&(r.sdpSettings.direction&&(r.sdpSettings.direction.audio&&(n.sdpSettings.direction.audio.receive="boolean"!=typeof r.sdpSettings.direction.audio.receive||r.sdpSettings.direction.audio.receive,n.sdpSettings.direction.audio.send="boolean"!=typeof r.sdpSettings.direction.audio.send||r.sdpSettings.direction.audio.send),r.sdpSettings.direction.video&&(n.sdpSettings.direction.video.receive="boolean"!=typeof r.sdpSettings.direction.video.receive||r.sdpSettings.direction.video.receive,n.sdpSettings.direction.video.send="boolean"!=typeof r.sdpSettings.direction.video.send||r.sdpSettings.direction.video.send)),r.sdpSettings.connection&&(n.sdpSettings.connection.audio="boolean"!=typeof r.sdpSettings.connection.audio||r.sdpSettings.connection.audio,n.sdpSettings.connection.video="boolean"!=typeof r.sdpSettings.connection.video||r.sdpSettings.connection.video,n.sdpSettings.connection.data="boolean"!=typeof r.sdpSettings.connection.data||r.sdpSettings.connection.data)),r.publishOnly&&(n.sdpSettings.direction.audio.send=!0,n.sdpSettings.direction.audio.receive=!1,n.sdpSettings.direction.video.send=!0,n.sdpSettings.direction.video.receive=!1,n.publishOnly=!0),r.peerConnection&&"object"==typeof r.peerConnection){if("string"==typeof r.peerConnection.bundlePolicy)for(const e in K)K.hasOwnProperty(e)&&K[e]===r.peerConnection.bundlePolicy&&(n.peerConnectionConfig.bundlePolicy=r.peerConnection.bundlePolicy);if("string"==typeof r.peerConnection.rtcpMuxPolicy)for(const e in $)$.hasOwnProperty(e)&&$[e]===r.peerConnection.rtcpMuxPolicy&&(n.peerConnectionConfig.rtcpMuxPolicy=r.peerConnection.rtcpMuxPolicy);if("number"==typeof r.peerConnection.iceCandidatePoolSize&&r.peerConnection.iceCandidatePoolSize>0&&(n.peerConnectionConfig.iceCandidatePoolSize=r.peerConnection.iceCandidatePoolSize),"string"==typeof r.peerConnection.certificate)for(const e in Y)Y.hasOwnProperty(e)&&Y[e]===r.peerConnection.certificate&&(n.peerConnectionConfig.certificate=r.peerConnection.certificate);n.peerConnectionConfig.disableBundle=!0===r.peerConnection.disableBundle;}return r.autoBandwidthAdjustment&&(n.bandwidthAdjuster={interval:10,limitAtPercentage:100,useUploadBwOnly:!1},"object"==typeof r.autoBandwidthAdjustment&&("number"==typeof r.autoBandwidthAdjustment.interval&&r.autoBandwidthAdjustment.interval>=10&&(n.bandwidthAdjuster.interval=r.autoBandwidthAdjustment.interval),"number"==typeof r.autoBandwidthAdjustment.limitAtPercentage&&r.autoBandwidthAdjustment.limitAtPercentage>=0&&r.autoBandwidthAdjustment.limitAtPercentage<=100&&(n.bandwidthAdjuster.limitAtPercentage=r.autoBandwidthAdjustment.limitAtPercentage),"boolean"==typeof r.autoBandwidthAdjustment.useUploadBwOnly&&(n.bandwidthAdjuster.useUploadBwOnly=r.autoBandwidthAdjustment.useUploadBwOnly))),n},processStreamInState:(e=null,t={},n,r=!1,i=!1)=>{if(!e)return;const o=Hi.getSkylinkState(n);((e,t)=>{const{streams:n}=e;return !(!n.userMedia&&!n.screenshare)&&(!!(n.userMedia?Object.values(n.userMedia):[]).some(e=>e.id===t.id)||n.screenshare&&n.screenshare.id===t.id)})(o,e)||(sr.processNewStream(o.room,e,t,r),Wn.processPeerMedia(o.room,o.user.sid,e,r),i&&jr.log.DEBUG([o.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.FALLBACK_SUCCESS]),r&&jr.log.DEBUG([o.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.START_SCREEN_SUCCESS]),Lr(((e={})=>new s("mediaAccessSuccess",{detail:e}))({stream:e,isScreensharing:r,isAudioFallback:i,streamId:e.id,isAudio:Ar(e),isVideo:yr(e)})));},parseStreamSettings:(e,t=null)=>{const{AdapterJS:n}=window,r={settings:{audio:!1,video:!1},mutedSettings:{shouldAudioMuted:!1,shouldVideoMuted:!1},getUserMediaSettings:{audio:!1,video:!1}};return (e.audio&&!t||e.audio&&t===he.AUDIO)&&(r.settings.audio={stereo:!1,exactConstraints:!!e.useExactConstraints,echoCancellation:!0},r.getUserMediaSettings.audio={echoCancellation:!0},"object"==typeof e.audio&&("boolean"==typeof e.audio.stereo&&(r.settings.audio.stereo=e.audio.stereo),"boolean"==typeof e.audio.useinbandfec&&(r.settings.audio.useinbandfec=e.audio.useinbandfec),"boolean"==typeof e.audio.usedtx&&(r.settings.audio.usedtx=e.audio.usedtx),"number"==typeof e.audio.maxplaybackrate&&e.audio.maxplaybackrate>=8e3&&e.audio.maxplaybackrate<=48e3&&(r.settings.audio.maxplaybackrate=e.audio.maxplaybackrate),"boolean"==typeof e.audio.mute&&(r.mutedSettings.shouldAudioMuted=e.audio.mute),"edge"!==n.webrtcDetectedBrowser&&("boolean"==typeof e.audio.echoCancellation&&(r.settings.audio.echoCancellation=e.audio.echoCancellation,r.getUserMediaSettings.audio.echoCancellation=e.audio.echoCancellation),Array.isArray(e.audio.optional)&&(r.settings.audio.optional=Pe(e.audio.optional),r.getUserMediaSettings.audio.optional=Pe(e.audio.optional)),e.audio.deviceId&&"string"==typeof e.audio.deviceId&&"firefox"!==n.webrtcDetectedBrowser&&(r.settings.audio.deviceId=e.audio.deviceId,r.getUserMediaSettings.audio.deviceId=e.useExactConstraints?{exact:e.audio.deviceId}:{ideal:e.audio.deviceId}))),"edge"===n.webrtcDetectedBrowser&&(r.getUserMediaSettings.audio=!0)),(e.video&&!t||e.video&&t===he.VIDEO)&&(r.settings.video={resolution:Pe(se.VGA),exactConstraints:!!e.useExactConstraints},r.getUserMediaSettings.video={},"object"==typeof e.video?("boolean"==typeof e.video.mute&&(r.mutedSettings.shouldVideoMuted=e.video.mute),Array.isArray(e.video.optional)&&(r.settings.video.optional=Pe(e.video.optional),r.getUserMediaSettings.video.optional=Pe(e.video.optional)),e.video.deviceId&&"string"==typeof e.video.deviceId&&(r.settings.video.deviceId=e.video.deviceId,r.getUserMediaSettings.video.deviceId=e.useExactConstraints?{exact:e.video.deviceId}:{ideal:e.video.deviceId}),e.video.resolution&&"object"==typeof e.video.resolution&&((e.video.resolution.width&&"object"==typeof e.video.resolution.width||"number"==typeof e.video.resolution.width)&&(r.settings.video.resolution.width=e.video.resolution.width),(e.video.resolution.height&&"object"==typeof e.video.resolution.height||"number"==typeof e.video.resolution.height)&&(r.settings.video.resolution.height=e.video.resolution.height)),r.getUserMediaSettings.video.width="object"==typeof r.settings.video.resolution.width?r.settings.video.resolution.width:e.useExactConstraints?{exact:r.settings.video.resolution.width}:{max:r.settings.video.resolution.width},r.getUserMediaSettings.video.height="object"==typeof r.settings.video.resolution.height?r.settings.video.resolution.height:e.useExactConstraints?{exact:r.settings.video.resolution.height}:{max:r.settings.video.resolution.height},(e.video.frameRate&&"object"==typeof e.video.frameRate||"number"==typeof e.video.frameRate&&"plugin"!==n.webrtcDetectedType)&&(r.settings.video.frameRate=e.video.frameRate,r.getUserMediaSettings.video.frameRate="object"==typeof r.settings.video.frameRate?r.settings.video.frameRate:e.useExactConstraints?{exact:r.settings.video.frameRate}:{max:r.settings.video.frameRate}),e.video.facingMode&&["string","object"].indexOf(typeof e.video.facingMode)>-1&&"plugin"===n.webrtcDetectedType&&(r.settings.video.facingMode=e.video.facingMode,r.getUserMediaSettings.video.facingMode="object"==typeof r.settings.video.facingMode?r.settings.video.facingMode:e.useExactConstraints?{exact:r.settings.video.facingMode}:{max:r.settings.video.facingMode})):r.getUserMediaSettings.video={width:e.useExactConstraints?{exact:r.settings.video.resolution.width}:{max:r.settings.video.resolution.width},height:e.useExactConstraints?{exact:r.settings.video.resolution.height}:{max:r.settings.video.resolution.height}},"edge"===n.webrtcDetectedBrowser&&(r.settings.video={exactConstraints:!!e.useExactConstraints},r.getUserMediaSettings.video=!0)),r},prepMediaAccessRequest:e=>new Promise((t,n)=>{const{roomKey:r,...i}=e,s=sr.parseStreamSettings(i,he.AUDIO),o=sr.parseStreamSettings(i,he.VIDEO),{AdapterJS:a}=window;s.getUserMediaSettings.audio||o.getUserMediaSettings.video||n(Ne.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),a.webRTCReady(()=>{window.navigator.mediaDevices.getUserMedia({audio:s.getUserMediaSettings.audio,video:o.getUserMediaSettings.video}).then(e=>{const n=sr.onStreamAccessSuccess(r,e,s,o,!1),i=Hi.getSkylinkState(r);n[0]&&s.mutedSettings.shouldAudioMuted&&Xn(i,{audioMuted:s.mutedSettings.shouldAudioMuted,videoMuted:o.mutedSettings.shouldVideoMuted},n[0].id),n[1]&&o.mutedSettings.shouldVideoMuted&&Xn(i,{audioMuted:s.mutedSettings.shouldAudioMuted,videoMuted:o.mutedSettings.shouldVideoMuted},n[1].id),t(n);}).catch(e=>sr.onStreamAccessError(e,n,t,r,s,o));});}),addLocalMediaStreams:(e,t)=>{const n=Hi.getSkylinkState(t.room.id),{peerConnections:r,streams:i}=n,s=r[e];i.userMedia&&((e,t,n,r)=>{const i=Object.keys(n);for(let s=0;s<i.length;s+=1){const{stream:o}=n[i[s]];Qn(r,o)||Zn(e,t,o,r);}})(n,e,i.userMedia,s),i.screenshare&&((e,t,n,r)=>{const{stream:i}=n;Qn(r,i)||Zn(e,t,i,r);})(n,e,i.screenshare,s);},onRemoteTrackAdded:(e,t,n,r,i,s)=>{const{user:c,hasMCU:d,room:l}=t,u={dispatchOnIncomingStream:e=>{Lr(o(e));},dispatchOnIncomingScreenStream:e=>{e.isReplace=!1,Lr(a(e));}},p=r?"dispatchOnIncomingScreenStream":"dispatchOnIncomingStream",S={stream:e,peerId:n,room:l,isSelf:d&&n===c.sid||!1,peerInfo:Ke.getPeerInfo(n,l),streamId:e.id,isVideo:i,isAudio:s};u[p](S),Lr(T({peerId:n,peerInfo:Ke.getPeerInfo(n,l),isSelf:d&&n===c.sid||!1,room:l}));},onStreamAccessError:(e,t,n,r,i,s)=>{const o=Hi.getInitOptions(),a=Hi.getSkylinkState(r),{audioFallback:c}=o;if(i.settings.audio&&s.settings.video&&c){const o=!0;return jr.log.DEBUG([a.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.START_FALLBACK]),Lr(N({error:e,state:oe.FALLBACKING,isAudioFallback:o})),window.navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>sr.onStreamAccessSuccess(r,e,i,s,o,n)).catch(n=>{jr.log.ERROR([a.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.FALLBACK,n]),Lr(M({error:n,isAudioFallbackError:!0})),Lr(N({error:e,state:oe.ERROR,isAudioFallback:o})),t(n);})}jr.log.ERROR([a.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.GET_USER_MEDIA],e),Lr(M({error:e,isAudioFallbackError:!1})),t(e);},replaceTrack:(e,t,n,r)=>{const i=e.getVideoTracks()[0],s=e.getAudioTracks()[0],o=er(r,n,i?i.id:null,"video"),a=er(r,n,s?s.id:null,"audio"),c=t.getVideoTracks()[0],d=t.getAudioTracks()[0];try{i&&c&&o&&o.replaceTrack(c),s&&d&&a&&a.replaceTrack(d);}catch(e){jr.log.ERROR([n,ge.PEER_CONNECTION,null,Ne.PEER_CONNECTION.ERRORS.REPLACE_TRACK],e);}},muteStreams:Xn,sendStream:(e,t=null)=>new Promise((n,r)=>{if(!e)return r(new Error(Ne.ROOM_STATE.NO_ROOM_NAME));const{inRoom:i}=e,{AdapterJS:s}=window,o=!(dr(t)&&null!==t||s&&s.WebRTCPlugin&&s.WebRTCPlugin.plugin);if(!i)return jr.log.WARN(Ne.ROOM.ERRORS.NOT_IN_ROOM),r(new Error(`${Ne.ROOM.ERRORS.NOT_IN_ROOM}`));if(o)return r(new Error(`${Ne.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${t}`));let a=!1;try{if(Array.isArray(t)){let i=!0;return t.forEach(e=>{pr(e.getAudioTracks)&&pr(e.getVideoTracks)||(i=!1);}),i?((e,t,n,r)=>{const i=[];return t.forEach(t=>{i.push(Ve.usePrefetchedStream(e.room.id,t));}),Promise.all(i).then(t=>{nr(e,t,n,r);}).catch(e=>{r(e);})})(e,t,n,r):r(new Error(Ne.MEDIA_STREAM.ERRORS.INVALID_MEDIA_STREAM_ARRAY))}return (a=!!t&&(pr(t.getAudioTracks)||pr(t.getVideoTracks)))?((e,t,n,r)=>{return Ve.usePrefetchedStream(e.room.id,t).then(t=>{nr(e,t,n,r);}).catch(e=>{r(e);})})(e,t,n,r):((e,t,n,r)=>{return Ve.getUserMedia(e,t).then(t=>{nr(e,t,n,r);}).catch(e=>{r(e);})})(e,t,n,r)}catch(e){jr.log.ERROR(Ne.MEDIA_STREAM.ERRORS.SEND_STREAM,e);}}),getStreamSources:()=>{const{navigator:e}=window;return new Promise((t,n)=>{e.mediaDevices&&pr(e.mediaDevices.enumerateDevices)?e.mediaDevices.enumerateDevices().then(e=>{t(rr(e));}):n(rr([]));})},getStreams:e=>{const{streams:{userMedia:t,screenshare:n}}=e,r={userMedia:null,screenshare:null};if(!t&&!n)return r;if(t){const e=Object.keys(t);r.userMedia={},e.forEach(e=>{r.userMedia[e]=t[e].stream;});}return n&&(r.screenshare=n.stream),r},getScreenSources:()=>new Promise(e=>{const{navigator:t,AdapterJS:n}=window,r={mediaSource:[],mediaSourceInput:[]};return t.userAgent.toLowerCase().indexOf("android")>-1?("chrome"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=59&&(r.mediaSource=["screen"]),e(r),null):(("chrome"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=34||"firefox"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=38||"opera"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=21)&&("opera"!==n.webrtcDetectedBrowser||n.extensionInfo&&n.extensionInfo.opera&&n.extensionInfo.opera.extensionId||jr.log.WARN("Please ensure that your application allows Opera screensharing!"),r.mediaSource=["window","screen"],"chrome"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=52||"opera"===n.webrtcDetectedBrowser&&n.webrtcDetectedVersion>=39?r.mediaSource.push("tab","audio"):"firefox"===n.webrtcDetectedBrowser&&r.mediaSource.push("browser","camera","application")),e(r),null)}),updateStreamsMediaStatus:(e,t,n)=>{const r=Hi.getSkylinkState(e),{room:i,streamsMediaStatus:s}=r,{mutedSettings:{shouldAudioMuted:o},settings:{audio:a,video:c}}=t;s[n.id]={},s[n.id].audioMuted=a?o?Ee.MUTED:Ee.ACTIVE:Ee.UNAVAILABLE,s[n.id].videoMuted=c?o?Ee.MUTED:Ee.ACTIVE:Ee.UNAVAILABLE,Hi.setSkylinkState(r,i.id);},updateRemoteStreams:(e,t,n)=>{const r=Hi.getSkylinkState(e.id);r.remoteStreams[t]=r.remoteStreams[t]||{},r.remoteStreams[t][n.id]=n,Hi.setSkylinkState(r,e.id);},retrieveVideoStreams:e=>{const t=Hi.getSkylinkState(e.id),{streams:n}=t,r=[];return Object.values(n.userMedia).forEach(e=>{e.stream.getVideoTracks().length>0&&r.push(e.stream);}),r},splitAudioAndVideoStream:e=>{const{MediaStream:t}=window,n=[],r=e.getAudioTracks(),i=e.getVideoTracks();return Ar(e)?n.push(new t(r)):n.push(null),yr(e)?n.push(new t(i)):n.push(null),n},processNewStream:(e,t,n,r)=>{((e,t,n,r)=>{const i=Hi.getSkylinkState(e.id),s=r?"screenshare":"userMedia";r?i.streams[s]=ir(i.room,i.user,t,n):(i.streams[s]=i.streams[s]?i.streams[s]:{},i.streams[s][t.id]=ir(i.room,i.user,t,n)),Hi.setSkylinkState(i,e.id);})(e,t,n,r),sr.updateStreamsMutedSettings(e.id,n,t),sr.updateStreamsMediaStatus(e.id,n,t);},updateStreamsMutedSettings:(e,t,n)=>{const r=Hi.getSkylinkState(e),{room:i,streamsMutedSettings:s}=r,{audio:o,video:a}=t.settings;s[n.id]={},s[n.id].audioMuted=!o,s[n.id].videoMuted=!a,Hi.setSkylinkState(r,i.id);},onStreamAccessSuccess:(e,t,n,r,i)=>{const s=sr.splitAudioAndVideoStream(t);return s.forEach(t=>{t&&sr.processStreamInState(t,Ar(t)?n:r,e,!1,i);}),s}},or=e=>{return 0===Object.keys(e).length},ar=e=>0===e.length,cr=e=>""===e,dr=e=>"object"==typeof e&&null!==e,lr=e=>"object"==typeof e&&null==e,ur=e=>"number"==typeof e,pr=e=>"function"==typeof e,Sr=e=>void 0!==e&&"boolean"==typeof e,Er=e=>"string"==typeof e,gr=(e,t,n)=>{let r=!0;return null!=e&&Er(e)||(jr.log.ERROR(`${n}: ${t} is null, undefined or not a string.`),r=!1),r},mr=e=>{if(gr(e,"roomId","getStateByRid")){const t=Hi.getSkylinkState(),n=Object.keys(t);let r=null;for(let i=0;i<n.length;i+=1){const s=n[i];if(s===e){r=t[s];break}}return r}return jr.log.ERROR(`getRoomStateByRid: ${Ne.ROOM_STATE.NOT_FOUND} - ${e}`),null},fr=e=>mr(e),hr=e=>{let t=null;if(gr(e,"roomName","getRoomStateByName")){const n=Hi.getSkylinkState(),r=Object.keys(n);for(let i=0;i<r.length;i+=1){const s=n[r[i]];if(s.room.roomName.toLowerCase()===e.toLowerCase()){t=s;break}}}return t||jr.log.ERROR(`getRoomStateByName: ${Ne.ROOM_STATE.NOT_FOUND} - ${e}`),t},Rr=(e,t)=>{const n=(e||"").split("."),r=(t||"").split(".");for(let e=0;e<r.length;e+=1)if((n[e]||"0")<(r[e]||"0"))return !0;return !1},Tr=()=>{try{(new Vn).socket.disconnect();}catch(e){jr.log.ERROR(e);}},Cr=()=>{let e=(new Date).getTime();return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const n=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?n:n&&15).toString(16)})},Ir=e=>new Promise((t,n)=>{const{navigator:r}=window;e&&dr(e)||n(new Error(`${Ne.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${e}`)),r.mediaDevices.getUserMedia(e).then(e=>{const n=sr.splitAudioAndVideoStream(e);t(n);}).catch(e=>{n(e);});}),_r=e=>new Promise((t,n)=>{n(new Error(e));}),vr=(e,t,n,r)=>{const{streams:i,room:s}=n,o=Object.values(i.userMedia);for(let n=0;n<o.length;n+=1)o[n].id===e.id&&(o[n].isReplaced=r,o[n].newStream=t);Hi.setSkylinkState(n,s.id);},Or=(e,t)=>{const n=Hi.getSkylinkState(e.id),{peerConnections:r}=n,i=Object.keys(r);let s=!1;return i.forEach(e=>{e===t&&(s=!0);}),s},Ar=e=>e.getAudioTracks().length>0,yr=e=>e.getVideoTracks().length>0,Dr=e=>{const{AdapterJS:t}=window;switch(e){case Ie.CHROME:return t.webrtcDetectedBrowser===Ie.CHROME;case Ie.SAFARI:return t.webrtcDetectedBrowser===Ie.SAFARI;case Ie.FIREFOX:return t.webrtcDetectedBrowser===Ie.FIREFOX;default:return jr.log.DEBUG(Ne.UTILS.INVALID_BROWSER_AGENT),!1}},Nr=e=>{const{AdapterJS:t}=window;return t.webrtcDetectedVersion===e},Pr=e=>new Date(e).toISOString(),Mr=()=>(new Date).toISOString();const wr=new class{constructor(){this.events={},this.privateEvents={};}addPrivateEventListener(e,t){this.addListener(e,t,!0);}addEventListener(e,t){this.addListener(e,t,!1);}addListener(e,t,n){try{const r=n?"privateEvents":"events";if(!pr(t))return void jr.log.DEBUG([null,ge.SKYLINK_EVENT,e,Ne.LOGGER.INVALID_CB]);this[r][e]||(this[r][e]={}),this[r][e].callbacks||(this[r][e].callbacks=[]),this[r][e].callbacks.push(t),n||jr.log.DEBUG([null,ge.SKYLINK_EVENT,e,Ne.LOGGER.EVENT_REGISTERED]);}catch(t){jr.log.ERROR([null,ge.SKYLINK_EVENT,e,Ne.LOGGER.EVENT_REGISTER_ERROR],t);}}dispatchEvent(e){if(e.name===ye.LOGGED_ON_CONSOLE)return;let t=[];if(this.events[e.name]){const n=this.events[e.name].callbacks;t=t.concat(n);}else jr.log.DEBUG([null,ge.SKYLINK_EVENT,e.name,Ne.LOGGER.EVENT_DISPATCHED]);if(this.privateEvents[e.name]){const n=this.privateEvents[e.name]?this.privateEvents[e.name].callbacks:[];t=t.concat(n);}t.forEach(t=>{try{t(e.detail);}catch(t){jr.log.ERROR([null,ge.SKYLINK_EVENT,e.name,Ne.LOGGER.EVENT_DISPATCH_ERROR],t);}});}removeEventListener(e,t){this.removeListener(e,t,!1);}removePrivateEventListener(e,t){this.removeListener(e,t,!0);}removeListener(e,t,n){const r=n?"privateEvents":"events";if(n||this.events[e]&&this.events[e].callbacks)try{this[r][e].callbacks.forEach((i,s)=>{i===t&&(delete this[r][e].callbacks[s],n||jr.log.DEBUG([null,ge.SKYLINK_EVENT,e,Ne.LOGGER.EVENT_UNREGISTERED]));});}catch(t){jr.log.ERROR([null,ge.SKYLINK_EVENT,e,Ne.LOGGER.EVENT_DISPATCH_ERROR],t);}else jr.log.WARN([null,ge.SKYLINK_EVENT,e,Ne.LOGGER.EVENT_UNREGISTERED]);}},br=wr.addPrivateEventListener.bind(wr),kr=wr.removePrivateEventListener.bind(wr),Lr=wr.dispatchEvent.bind(wr),Ur=["trace","debug","info","warn","error"],Gr=e=>{let t=!0;return "undefined"==typeof console?t=!1:void 0===console[e]&&(t=!1),t},xr=(e,t,n,r=null)=>{const i=`[${(new Date).toISOString()}]`,o=e.level,{logLevels:a}=e;if(o<=t&&o!==a.SILENT){const e=Ur[t];if(!Gr(e))return;const o=(e=>{let t="SkylinkJS -";if(Array.isArray(e)){const[n,r,i,s]=e;if(t+=n?` [${n}]`:" -",t+=r?` <<${r}>>`:n?"":" <<Method>>",i)if(Array.isArray(i))for(let e=0;e<i.length;e+=1)t+=` (${i[e]})`;else t+=` (${i})`;t+=` ${s}`;}else t+=` ${e}`;return t})(n);if(Gr(e)&&(console[e](i,o,r||""),Lr(((e={})=>new s("loggedOnConsole",{detail:e}))({level:e,message:o,debugObject:r}))),jr.storeLogs){const t=[i,e.toUpperCase(),o];r&&t.push(r),jr.storedLogs.push(t);}}},Br=e=>{window.localStorage.setItem("loglevel:skylinkjs",e);},Fr=e=>{const t=window.localStorage.getItem("loglevel:skylinkjs");return null===t||Number.isNaN(+t)?e.ERROR:+t};class Vr{constructor(){this.logLevels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},this.level=Fr(this.logLevels),this.storeLogs=!1,this.storedLogs=[];}setLevel(e=this.levels.ERROR,t){"number"==typeof e?(this.level=e,Br(this.level)):this.level=this.levels.ERROR,t&&(this.storeLogs=t);}enableAll(){this.setLevel(this.logLevels.TRACE);}disableAll(){this.setLevel(this.logLevels.SILENT);}getLogs(){return this.storeLogs?this.storedLogs:(this.log.WARN(Ne.LOGGER.LOGS_NOT_STORED),null)}clearLogs(){this.log.INFO(Ne.LOGGER.LOGS_CLEARED),this.storedLogs=[];}}const jr=new Vr;Vr.prototype.log={TRACE:(...e)=>{xr(jr,jr.logLevels.TRACE,...e);},DEBUG:(...e)=>{xr(jr,jr.logLevels.DEBUG,...e);},INFO:(...e)=>{xr(jr,jr.logLevels.INFO,...e);},WARN:(...e)=>{xr(jr,jr.logLevels.WARN,...e);},ERROR:(...e)=>{xr(jr,jr.logLevels.ERROR,...e);}};const Wr=(e,t,n,r,i)=>{const s=e.sdp.match(new RegExp("m="+t+" .*\r\n","gi"));if(Array.isArray(s)&&s.length>0){const s=e.sdp.match(new RegExp("a=rtpmap:.* "+n+"/"+(r?r+("audio"===t?"[/]*.*":".*"):".*")+"\r\n","gi"));if(Array.isArray(s)&&s.length>0)for(let t=0;t<s.length;t+=1){const n=(s[t].split("a=rtpmap:")[1]||"").split(" ")[0];if(!n)continue;const r=e.sdp.match(new RegExp("a=fmtp:"+n+" .*\r\n","gi"));let o="a=fmtp:"+n+" ";const a=[];if(Array.isArray(r)&&r.length>0){const t=(r[0].split("a=fmtp:"+n+" ")[1]||"").replace(/ /g,"").replace(/\r\n/g,"").split(";");for(let e=0;e<t.length;e+=1){if(!t[e])continue;const n=t[e].split("=");i.hasOwnProperty(n[0])?o+="boolean"==typeof i[n[0]]?i[n[0]]?n[0]+"=1;":"":n[0]+"="+i[n[0]]+";":o+=t[e]+";",a.push(n[0]);}e.sdp=e.sdp.replace(r[0],"");}for(const e in i)i.hasOwnProperty(e)&&-1===a.indexOf(e)&&(o+="boolean"==typeof i[e]?i[e]?e+"=1;":"":e+"="+i[e]+";",a.push(e));o!=="a=fmtp:"+n+" "&&(e.sdp=e.sdp.replace(s[t],s[t]+o+"\r\n"));}}},Hr=e=>((e.match(/a=rtpmap:.*\ rtx\/.*\r\n/gi)||[]).forEach(t=>{const n=(t.split("a=rtpmap:")[1]||"").split(" ")[0]||"",r=(e.match(new RegExp("a=fmtp:"+n+" .*\r\n","gi"))||[])[0];if(!r)return void(e=e.replace(new RegExp(t,"g"),""));const i=(r.split(" apt=")[1]||"").replace(/\r\n/gi,"");e.match(new RegExp("a=rtpmap:"+i+" .*\r\n","gi"))||(e=(e=e.replace(new RegExp(t,"g"),"")).replace(new RegExp(r,"g"),""));}),e),Kr=e=>((e.match(/a=(fmtp|rtcp-fb):.*\ rtx\/.*\r\n/gi)||[]).forEach(t=>{const n=(t.split("a="+(t.indexOf("rtcp")>0?"rtcp-fb":"fmtp"))[1]||"").split(" ")[0]||"";e.match(new RegExp("a=rtpmap:"+n+" .*\r\n","gi"))||(e=e.replace(new RegExp(t,"g"),""));}),e),$r={getSDPCommonSupports:(e,t=null,n)=>{const r=Hi.getSkylinkState(n),i={audio:!1,video:!1},{AdapterJS:s}=window,{currentCodecSupport:o,peerInformations:a}=r;if(!e||!t||!t.sdp){if(i.video=!(!o.video.h264&&!o.video.vp8),i.audio=!!o.audio.opus,e){const t=((a[e]||{}).agent||{}).name||"";s.webrtcDetectedBrowser===t&&(i.video=Object.keys(o.video).length>0,i.audio=Object.keys(o.audio).length>0);}return i}const c=$r.getSDPCodecsSupport(e,t),d=o;for(const e in d.audio)if(d.audio.hasOwnProperty(e)&&d.audio[e]&&c.audio[e]){i.audio=!0;break}for(const e in d.video)if(d.video.hasOwnProperty(e)&&d.video[e]&&c.video[e]){i.video=!0;break}return i},getSDPCodecsSupport:(e,t)=>{const n={audio:{},video:{}};if(!t||!t.sdp)return n;const r=t.sdp.split("\r\n");let i="";for(let e=0;e<r.length;e+=1)if(0!==r[e].indexOf("m=")){if(0===r[e].indexOf("a=rtpmap:")){const t=(r[e].split(" ")[1]||"").split("/"),s=(t[0]||"").toLowerCase(),o=t[1]+(t[2]?`/${t[2]}`:"");if(["ulpfec","red","telephone-event","cn","rtx"].indexOf(s)>-1)continue;n[i][s]=n[i][s]||[],-1===n[i][s].indexOf(o)&&n[i][s].push(o);}}else i=(r[e].split("m=")[1]||"").split(" ")[0];return jr.log.INFO([e||null,"RTCSessionDescription",t.type,"Parsed codecs support ->"],n),n},getCodecsSupport:e=>new Promise((t,n)=>{const r=Hi.getSkylinkState(e),i=r,{AdapterJS:s,RTCRtpSender:o,RTCPeerConnection:a}=window;r.currentCodecSupport&&t(r.currentCodecSupport),i.currentCodecSupport={audio:{},video:{}},"AppleWebKit"===s.webrtcDetectedType&&(i.currentCodecSupport.audio={opus:["48000/2"]},i.currentCodecSupport.video={h264:["48000"]},t(i.currentCodecSupport));try{if("edge"===window.webrtcDetectedBrowser){const{codecs:e}=o.getCapabilities();for(let t=0;t<e.length;t+=1)if(["audio","video"].indexOf(e[t].kind)>-1&&e[t].name){const n=e[t].name.toLowerCase();i.currentCodecSupport[e[t].kind][n]=e[t].clockRate+(e[t].numChannels>1?`/${e[t].numChannels}`:"");}t(i.currentCodecSupport);}else{const o=new a(null),c="plugin"!==s.webrtcDetectedType?{offerToReceiveAudio:!0,offerToReceiveVideo:!0}:{mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}};try{const e=o.createDataChannel("test");i.binaryChunkType=e.binaryType||r.binaryChunkType,i.binaryChunkType=r.binaryChunkType.toLowerCase().indexOf("array")>-1?U.ARRAY_BUFFER:r.binaryChunkType;const t=Object.keys(U);for(let e=0;e<t.length;e+=1)if(U.hasOwnProperty(t)&&r.binaryChunkType.toLowerCase()===U[t].toLowerCase()){i.binaryChunkType=U[t];break}}catch(e){}o.createOffer(c).then(n=>{i.currentCodecSupport=Yr.getSDPCodecsSupport(null,n,e),t(i.currentCodecSupport);}).catch(e=>{n(e);});}}catch(e){n(e);}}),setSDPCodecParams:(e,t,n)=>{const r=Hi.getSkylinkState(n),i=Hi.getInitOptions();return Wr(t,"audio",ie.OPUS,48e3,(()=>{const e={},t=Object.keys(r.streams.userMedia);let n=r.streams.userMedia?r.streams.userMedia[t[0]].settings.audio:{};return n=n&&"object"==typeof n?n:{},"boolean"==typeof i.codecParams.audio.opus.stereo?e.stereo=i.codecParams.audio.opus.stereo:"boolean"==typeof n.stereo&&(e.stereo=n.stereo),"boolean"==typeof i.codecParams.audio.opus["sprop-stereo"]?e["sprop-stereo"]=i.codecParams.audio.opus["sprop-stereo"]:"boolean"==typeof n.stereo&&(e["sprop-stereo"]=n.stereo),"boolean"==typeof i.codecParams.audio.opus.usedtx?e.usedtx=i.codecParams.audio.opus.usedtx:"boolean"==typeof n.usedtx&&(e.usedtx=n.usedtx),"boolean"==typeof i.codecParams.audio.opus.useinbandfec?e.useinbandfec=i.codecParams.audio.opus.useinbandfec:"boolean"==typeof n.useinbandfec&&(e.useinbandfec=n.useinbandfec),"number"==typeof i.codecParams.audio.opus.maxplaybackrate?e.maxplaybackrate=i.codecParams.audio.opus.maxplaybackrate:"number"==typeof n.maxplaybackrate&&(e.maxplaybackrate=n.maxplaybackrate),"number"==typeof i.codecParams.audio.opus.minptime?e.minptime=i.codecParams.audio.opus.minptime:"number"==typeof n.minptime&&(e.minptime=n.minptime),e})()),Wr(t,"video",re.VP8,null,(()=>{const e={};return "number"==typeof i.codecParams.video.vp8.maxFr&&(e["max-fr"]=i.codecParams.video.vp8.maxFr),"number"==typeof i.codecParams.video.vp8.maxFs&&(e["max-fs"]=i.codecParams.video.vp8.maxFs),e})()),Wr(t,"video",re.VP9,null,(()=>{const e={};return "number"==typeof i.codecParams.video.vp9.maxFr&&(e["max-fr"]=i.codecParams.video.vp9.maxFr),"number"==typeof i.codecParams.video.vp9.maxFs&&(e["max-fs"]=i.codecParams.video.vp9.maxFs),e})()),Wr(t,"video",re.H264,null,(()=>{const e={};return "string"==typeof i.codecParams.video.h264.levelAsymmetryAllowed&&(e["profile-level-id"]=i.codecParams.video.h264.profileLevelId),"boolean"==typeof i.codecParams.video.h264.levelAsymmetryAllowed&&(e["level-asymmetry-allowed"]=i.codecParams.video.h264.levelAsymmetryAllowed),"boolean"==typeof i.codecParams.video.h264.packetizationMode&&(e["packetization-mode"]=i.codecParams.video.h264.packetizationMode),e})()),t.sdp},removeSDPFilteredCandidates:(e,t,n)=>{const r=Hi.getInitOptions(),i=Hi.getSkylinkState(n);return e===_e.MCU&&t.type===z.ANSWER&&"firefox"===window.webrtcDetectedBrowser&&(t.sdp=t.sdp.replace(/ generation 0/g,""),t.sdp=t.sdp.replace(/ udp /g," UDP ")),r.forceTURN&&i.hasMCU?(jr.log.WARN([e,"RTCSessionDesription",t.type,"Not filtering ICE candidates as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured"]),t.sdp):(r.filterCandidatesType.host&&(jr.log.INFO([e,"RTCSessionDesription",t.type,'Removing "host" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*host.*\r\n/g,"")),r.filterCandidatesType.srflx&&(jr.log.INFO([e,"RTCSessionDesription",t.type,'Removing "srflx" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*srflx.*\r\n/g,"")),r.filterCandidatesType.relay&&(jr.log.INFO([e,"RTCSessionDesription",t.type,'Removing "relay" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*relay.*\r\n/g,"")),t.sdp)},setSDPCodec:(e,t,n,r)=>{const i=Hi.getInitOptions(n),s=(n,r)=>{const i="object"==typeof r?r.codec:r;let s="object"==typeof r?r.samplingRate:null,o="object"==typeof r?r.channels:null;if(i===De["audio"===n?"AUDIO_CODEC":"VIDEO_CODEC"].AUTO)return void jr.log.WARN([e,"RTCSessionDesription",t.type,`Not preferring any codec for ${n} streaming. Using browser selection.`]);const a=t.sdp.match(new RegExp("m="+n+" .*\r\n","gi"));if(!(Array.isArray(a)&&a.length>0))return void jr.log.ERROR([e,"RTCSessionDesription",t.type,`Not preferring any codec for ${n} streaming as m= line is not found.`]);const c=(r,c,d)=>{if(Array.isArray(r)&&r.length>0){c||(s=null),d||(o=null),jr.log.INFO([e,"RTCSessionDesription",t.type,'Preferring "'+i+'" (samplingRate: '+(s||"n/a")+", channels: "+(o||"n/a")+') for "'+n+'" streaming.']);let l=a[0];const u=l.replace("\r\n","").split(" ");l=u[0]+" "+u[1]+" "+u[2]+" ",u.splice(0,3);for(let e=0;e<r.length;e+=1){const t=(r[e].split("a=rtpmap:")[1]||"").split(" ");t.length<2||(l+=t[0]+" ");}for(let e=0;e<u.length;e+=1)l.indexOf(" "+u[e])>0?(u.splice(e,1),e-=1):t.sdp.match(new RegExp("a=rtpmap:"+u[e]+" "+i+"/.*\r\n","gi"))&&(l+=u[e]+" ",u.splice(e,1),e-=1);return l+=u.join(" ")+"\r\n",t.sdp=t.sdp.replace(a[0],l),!0}};if(s){if("audio"===n&&o&&c(t.sdp.match(new RegExp("a=rtpmap:.* "+i+"/"+s+(1===o?"[/1]*":"/"+o)+"\r\n","gi")),!0,!0))return;if(c(t.sdp.match(new RegExp("a=rtpmap:.* "+i+"/"+s+"[/]*.*\r\n","gi")),!0))return}"audio"===n&&o&&c(t.sdp.match(new RegExp("a=rtpmap:.* "+i+"/.*/"+o+"\r\n","gi")),!1,!0)||c(t.sdp.match(new RegExp("a=rtpmap:.* "+i+"/.*\r\n","gi")));};return s("audio",r?r.audio:i.audioCodec),s("video",r?r.video:i.videoCodec),t.sdp},setSDPBitrate:(e,t,n)=>{const r=Hi.getSkylinkState(n),i=t.sdp.split("\r\n"),s=function(n,r){let s=n,o=-1,a=-1;"data"===n&&(s="application");for(let e=0;e<i.length;e+=1)if(0===i[e].indexOf("m="+s))o=e;else if(o>0){if(0===i[e].indexOf("m="))break;0===i[e].indexOf("c=")?a=e:0!==i[e].indexOf("b=AS:")&&0!==i[e].indexOf("b:TIAS:")||(i.splice(e,1),e-=1);}"number"==typeof r&&r>0?-1!==a?(jr.log.INFO([e,"RTCSessionDesription",t.type,`Limiting maximum sending ${n} bandwidth ->`],r),i.splice(a+1,0,"firefox"===window.webrtcDetectedBrowser?"b=TIAS:"+(1e3*r*(window.webrtcDetectedVersion>52&&window.webrtcDetectedVersion<55?1e3:1)).toFixed(0):"b=AS:"+r)):jr.log.ERROR([e,"RTCSessionDesription",t.type,`Failed setting ${n} bandwidth as c-line is missing.`]):jr.log.WARN([e,"RTCSessionDesription",t.type,`Not limiting ${n} bandwidth`]);};let o=r.streamsBandwidthSettings.bAS.audio,a=r.streamsBandwidthSettings.bAS.video,c=r.streamsBandwidthSettings.bAS.data,d=r.streamsBandwidthSettings.googleX.min,l=r.streamsBandwidthSettings.googleX.max;if(r.peerCustomConfigs[e]&&(r.peerCustomConfigs[e].bandwidth&&"object"==typeof r.peerCustomConfigs[e].bandwidth&&("number"==typeof r.peerCustomConfigs[e].bandwidth.audio&&(o=r.peerCustomConfigs[e].bandwidth.audio),"number"==typeof r.peerCustomConfigs[e].bandwidth.video&&(a=r.peerCustomConfigs[e].bandwidth.video),"number"==typeof r.peerCustomConfigs[e].bandwidth.data&&(c=r.peerCustomConfigs[e].bandwidth.data)),r.peerCustomConfigs[e].googleXBandwidth&&"object"==typeof r.peerCustomConfigs[e].googleXBandwidth&&("number"==typeof r.peerCustomConfigs[e].googleXBandwidth.min&&(d=r.peerCustomConfigs[e].googleXBandwidth.min),"number"==typeof r.peerCustomConfigs[e].googleXBandwidth.max&&(l=r.peerCustomConfigs[e].googleXBandwidth.max))),s("audio",o),s("video",a),s("data",c),"number"==typeof d||"number"==typeof l){let n=null,r=-1,s=-1;for(let e=0;e<i.length;e+=1)if(0===i[e].indexOf("m=video"))n=i[e].split(" ")[3];else if(n){if(0===i[e].indexOf("m="))break;if(0===i[e].indexOf("a=rtpmap:"+n+" "))r=e;else if(0===i[e].indexOf("a=fmtp:"+n+" ")){i[e]=i[e].replace(/x-google-(min|max)-bitrate=[0-9]*[;]*/gi,""),s=e;break}}if(r>-1){let o="";"number"==typeof d&&(o+="x-google-min-bitrate="+d+";"),"number"==typeof l&&(o+="x-google-max-bitrate="+l+";"),jr.log.INFO([e,"RTCSessionDesription",t.type,"Limiting x-google-bitrate ->"],o),s>-1?i[s]+=(i[s].split(" ")[1]?";":"")+o:i.splice(r+1,0,"a=fmtp:"+n+" "+o);}}return i.join("\r\n")},removeSDPCodecs:(e,t,n)=>{const r=Hi.getSkylinkState(n),i=Ke.getCurrentSessionInfo(r.room).settings.audio,s=Hi.getInitOptions(),o=(n,r)=>{const i=t.sdp.match(new RegExp("a=rtpmap:(\\d*)\\ "+r+".*","gi"));if(Array.isArray(i)&&i.length>0)for(let s=0;s<i.length;s+=1){const o=i[s].split(" ")[0].split(":")[1];jr.log.INFO([e,"RTCSessionDesription",t.type,'Removing "'+r+'" payload ->'],o),t.sdp=t.sdp.replace(new RegExp("a=rtpmap:"+o+"\\ .*\\r\\n","g"),""),t.sdp=t.sdp.replace(new RegExp("a=fmtp:"+o+"\\ .*\\r\\n","g"),""),t.sdp=t.sdp.replace(new RegExp("a=rtpmap:\\d+ rtx\\/\\d+\\r\\na=fmtp:\\d+ apt="+o+"\\r\\n","g"),"");const a=t.sdp.split("\r\n");for(let e=0;e<a.length;e+=1)if(0===a[e].indexOf("m="+n)){const t=a[e].split(" ");t.indexOf(o)>=3&&t.splice(t.indexOf(o),1),a[e]=t.join(" ");break}t.sdp=a.join("\r\n");}else jr.log.WARN([e,"RTCSessionDesription",t.type,`Not removing ${r} as it does not exists.`]);};return s.disableVideoFecCodecs&&(r.hasMCU?jr.log.WARN([e,"RTCSessionDesription",t.type,'Not removing "ulpfec" or "red" codecs as connected to MCU to prevent connectivity issues.']):(o("video","red"),o("video","ulpfec"))),s.disableComfortNoiseCodec&&i&&"object"==typeof i&&i.stereo&&o("audio","CN"),"edge"===window.webrtcDetectedBrowser&&"edge"!==(((r.peerInformations[e]||{}).agent||{}).name||"unknown").name&&(t.sdp=t.sdp.replace(/a=rtcp-fb:.*\ x-message\ .*\r\n/gi,"")),t.sdp},removeSDPREMBPackets:(e,t)=>{return Hi.getInitOptions().disableREMB?(jr.log.INFO([e,"RTCSessionDesription",t.type,"Removing REMB packets."]),t.sdp.replace(/a=rtcp-fb:\d+ goog-remb\r\n/g,"")):t.sdp},handleSDPConnectionSettings:(e,t,n,r)=>{const i=Hi.getSkylinkState(n);if(!i.sdpSessions[e])return t.sdp;const s=t.sdp.split("\r\n"),o=((i.peerInformations[e]||{}).agent||{}).name||"",a=[],c=Pe(i.sdpSettings);let d="",l=-1,u=-1;if(e===_e.MCU&&(c.connection.audio=!0,c.connection.video=!0,c.connection.data=!0),i.hasMCU){const t=Pe(Ke.getPeerInfo(e,i.room)).settings||{};c.direction.audio.receive=e===_e.MCU||!!t.audio,c.direction.audio.send=e===_e.MCU,c.direction.video.receive=e===_e.MCU||!!t.video,c.direction.video.send=e===_e.MCU;}if("remote"===r){const r=Yr.getSDPCommonSupports(e,t,n);r.audio||(c.connection.audio=!1),r.video||(c.connection.video=!1);}i.sdpSessions[e][r].mLines=[],i.sdpSessions[e][r].bundleLine="",i.sdpSessions[e][r].connection={audio:null,video:null,data:null};for(let n=0;n<s.length;n+=1){if(0===s[n].indexOf("a=group:BUNDLE"))i.sdpSessions[e][r].bundleLine=s[n],l=n;else if(0===s[n].indexOf("m=")&&(d="application"===(d=(s[n].split("m=")[1]||"").split(" ")[0]||"")?"data":d,u+=1,i.sdpSessions[e][r].mLines[u]=s[n],!c.connection[d])){if(jr.log.INFO([e,"RTCSessionDesription",t.type,`Removing rejected m=${d} line ->`],s[n]),i.peerConnectionConfig.bundlePolicy===K.MAX_BUNDLE&&l>-1&&0===u&&("remote"===r?t.type===z.OFFER:t.type===z.ANSWER)){jr.log.WARN([e,"RTCSessionDesription",t.type,`Not removing rejected m='${d} line ->`],s[n]),c.connection[d]=!0,["audio","video"].indexOf(d)>-1&&(c.direction[d].send=!1,c.direction[d].receive=!1);continue}if("edge"===window.webrtcDetectedBrowser){s.splice(n,1),n-=1;continue}if("remote"===r||t.type===z.ANSWER){const e=s[n].split(" ");e[1]=0,s[n]=e.join(" ");continue}}if(d)if(c.connection[d]){if(0===s[n].indexOf("a=mid:"))a.push(s[n].split("a=mid:")[1]||"");else if(d&&["a=sendrecv","a=sendonly","a=recvonly"].indexOf(s[n])>-1){if(-1===["audio","video"].indexOf(d)){i.sdpSessions[e][r].connection.data=s[n];continue}if("local"===r)c.direction[d].send&&!c.direction[d].receive?s[n]=s[n].indexOf("send")>-1?"a=sendonly":"a=inactive":!c.direction[d].send&&c.direction[d].receive?s[n]=s[n].indexOf("recv")>-1?"a=recvonly":"a=inactive":c.direction[d].send||c.direction[d].receive||(s[n]="a=inactive"),i.hasMCU||"firefox"===window.webrtcDetectedBrowser||"firefox"!==o||t.type!==z.OFFER||"a=recvonly"!==s[n]||(jr.log.WARN([e,"RTCSessionDesription",t.type,"Overriding any original settings to receive only to send and receive to resolve chrome BUNDLE errors."]),s[n]="a=sendrecv",c.direction[d].send=!0,c.direction[d].receive=!0);else if(t.type===z.ANSWER){const t=i.sdpSessions[e].local.connection[d];"a=sendonly"===t?s[n]=-1===["a=inactive","a=recvonly"].indexOf(s[n])?"a=sendonly"===s[n]?"a=inactive":"a=recvonly":s[n]:"a=recvonly"===t?s[n]=-1===["a=inactive","a=sendonly"].indexOf(s[n])?"a=recvonly"===s[n]?"a=inactive":"a=sendonly":s[n]:"a=inactive"===t&&(s[n]="a=inactive");}i.sdpSessions[e][r].connection[d]=s[n];}}else s.splice(n,1),n-=1;(s[n]||"").replace(/\n|\r|\s|\ /gi,"")||(s.splice(n,1),n-=1);}return l>-1&&(i.peerConnectionConfig.bundlePolicy===K.MAX_BUNDLE?s[l]="a=group:BUNDLE "+a.join(" "):i.peerConnectionConfig.bundlePolicy===K.NONE&&s.splice(l,1)),"edge"!==window.webrtcDetectedBrowser&&(s[s.length-1].replace(/\n|\r|\s/gi,"")?s.push(""):s[s.length-1]=""),jr.log.INFO([e,"RTCSessionDesription",t.type,"Handling connection lines and direction ->"],c),s.join("\r\n")},removeSDPUnknownAptRtx:(e,t)=>{const n=t.sdp.split("m=");for(let e=0;e<n.length;e+=1)n[e]=Hr(n[e]),n[e]=Kr(n[e]);return n.join("m=")},removeSDPFirefoxH264Pref:(e,t)=>(jr.log.INFO([e,"RTCSessionDesription",t.type,"Removing Firefox experimental H264 flag to ensure interopability reliability"]),t.sdp.replace(/a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1\r\n/g,"")),renderSDPOutput:(e,t,n)=>{const r=Hi.getSkylinkState(n);let i=null,s=null;if(!t||!t.sdp)return;if(!r.peerConnections[e])return t.sdp;r.peerConnections[e].localStream&&(i=r.peerConnections[e].localStream,s=r.peerConnections[e].localStreamId||r.peerConnections[e].localStream.id);const o=t.sdp.split("\r\n");if(i){let e="";for(let t=0;t<o.length;t+=1)if(0===o[t].indexOf("m="))e=(o[t].split("m=")[1]||"").split(" ")[0]||"",e=-1===["audio","video"].indexOf(e)?"":e;else if(e)if(0===o[t].indexOf("a=msid:")){const e=o[t].split(" ");e[0]="a=msid:"+s,o[t]=e.join(" ");}else if(0===o[t].indexOf("a=ssrc:")){let e=null;if(o[t].indexOf(" msid:")>0?e=o[t].split(" msid:"):o[t].indexOf(" mslabel:")>0&&(e=o[t].split(" mslabel:")),e){const n=(e[1]||"").split(" ");n[0]=s,e[1]=n.join(" "),o[t].indexOf(" msid:")>0?o[t]=e.join(" msid:"):o[t].indexOf(" mslabel:")>0&&(o[t]=e.join(" mslabel:"));}}}if(t.type===z.ANSWER&&r.sdpSessions[e]){let n=-1;for(let i=0;i<o.length;i+=1)if(0===o[i].indexOf("a=group:BUNDLE")&&r.sdpSessions[e].remote.bundleLine&&r.peerConnectionConfig.bundlePolicy===K.MAX_BUNDLE)o[i]=r.sdpSessions[e].remote.bundleLine;else if(0===o[i].indexOf("m=")){n+=1;const s=o[i].split(" "),a=(r.sdpSessions[e].remote.mLines[n]||"").split(" ");s[0]&&a[0]&&s[0]!==a[0]&&(a[1]=0,jr.log.INFO([e,"RTCSessionDesription",t.type,"Appending middle rejected m= line ->"],a.join(" ")),o.splice(i,0,a.join(" ")),i+=1,n+=1);}for(;r.sdpSessions[e].remote.mLines[n+1];){n+=1;let i=o.length;o[i-1].replace(/\s/gi,"")||(i-=1);const s=(r.sdpSessions[e].remote.mLines[n]||"").split(" ");s[1]=0,jr.log.INFO([e,"RTCSessionDesription",t.type,"Appending later rejected m= line ->"],s.join(" ")),o.splice(i,0,s.join(" "));}}return "edge"!==window.webrtcDetectedBrowser||t.type!==z.OFFER||o[o.length-1].replace(/\s/gi,"")||(jr.log.INFO([e,"RTCSessionDesription",t.type,"Removing last empty space for Edge browsers"]),o.splice(o.length-1,1)),jr.log.INFO([e,"RTCSessionDescription",t.type,"Formatted output ->"],o.join("\r\n")),o.join("\r\n")},getSDPICECandidates:(e,t,n)=>{const{RTCIceCandidate:r}=window,i={host:[],srflx:[],relay:[]};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t)return;const n=((e.match(/a=mid:.*\r\n/gi)||[])[0]||"").replace(/a=mid:/gi,"").replace(/\r\n/,""),s=t-1;(e.match(/a=candidate:.*\r\n/gi)||[]).forEach(e=>{const t=(e.split(" ")[7]||"host").replace(/\r\n/g,"");i[t]=i[t]||[],i[t].push(new r({sdpMid:n,sdpMLineIndex:s,candidate:(e.split("a=")[1]||"").replace(/\r\n/g,"")}));});}),n||jr.log.DEBUG([e,"RTCSessionDesription",t.type,"Parsing session description ICE candidates ->"],i),i):i},getSDPSelectedCodec:(e,t,n,r)=>{const i={name:null,implementation:null,clockRate:null,channels:null,payloadType:null,params:null};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t||0!==e.indexOf(`${n} `))return;const r=(e.split("\r\n")[0]||"").split(" ");r.splice(0,3);for(let t=0;t<r.length;t+=1){const n=e.match(new RegExp(`a=rtpmap:${r[t]}.*\r\n`,"gi"));if(!n)continue;const s=((n[0]||"").replace(/\r\n/g,"").split(" ")[1]||"").split("/");if(!(["red","ulpfec","telephone-event","cn","rtx"].indexOf(s[0].toLowerCase())>-1)){i.name=s[0],i.clockRate=parseInt(s[1],10)||0,i.channels=parseInt(s[2]||"1",10)||1,i.payloadType=parseInt(r[t],10),i.params="",(e.match(new RegExp(`a=fmtp:${r[t]}.*\r\n`,"gi"))||[]).forEach(e=>{i.params+=e.replace(new RegExp(`a=fmtp:${r[t]}`,"gi"),"").replace(/ /g,"").replace(/\r\n/g,"");});break}}}),r||jr.log.DEBUG([e,"RTCSessionDesription",t.type,`Parsing session description "${n}" codecs ->`],i),i):i},setOriginalDTLSRole:(e,t,n)=>{const{room:r}=e,{type:i}=t,s=t.sdp.match(/a=setup:([a-z]+)/);if(null!==e.originalDTLSRole||"offer"===i)return;if(!s)return;const o=s[1];e.originalDTLSRole=n?{active:"passive",passive:"active"}[o]:o,Hi.setSkylinkState(e,r.id);},modifyDTLSRole:(e,t)=>{const{originalDTLSRole:n}=e,{type:r}=t;return null===n||"offer"===r?t.sdp:(t.sdp=t.sdp.replace(/a=setup:[a-z]+/g,`a=setup:${n}`),t.sdp)},getTransceiverMid:e=>{const t={audio:[],video:[]};return e.sdp.split("m=").forEach((e,n)=>{const r=e.split(/\n/),i=r[0].split(" ")[0];if("application"===i||0===n)return;let s={};for(let e=0;e<r.length;e+=1){if(r[e].match(/a=recvonly|a=sendonly|a=sendrecv|a=inactive/)){const t=r[e].split("=");s.direction=t[1].trim();}if(r[e].match(/a=mid:*/)&&(s.transceiverMid=r[e].split(/:/)[1].trim()),r[e].match(/a=msid:([\w|-|{]+)/)){const t=r[e].split(" "),n=t[0].split(/:/)[1].trim();s.streamId="-"===n?"":n,s.trackId=t[1].trim();}s.transceiverMid&&s.streamId&&s.trackId&&(t[i].push(s),s={});}}),t}};class Yr{static getSDPCommonSupports(...e){return $r.getSDPCommonSupports(...e)}static getCodecsSupport(...e){return $r.getCodecsSupport(...e)}static setSDPCodecParams(...e){return $r.setSDPCodecParams(...e)}static removeSDPFilteredCandidates(...e){return $r.removeSDPFilteredCandidates(...e)}static setSDPCodec(...e){return $r.setSDPCodec(...e)}static setSDPBitrate(...e){return $r.setSDPBitrate(...e)}static removeSDPCodecs(...e){return $r.removeSDPCodecs(...e)}static removeSDPREMBPackets(...e){return $r.removeSDPREMBPackets(...e)}static handleSDPConnectionSettings(...e){return $r.handleSDPConnectionSettings(...e)}static removeSDPUnknownAptRtx(...e){return $r.removeSDPUnknownAptRtx(...e)}static getSDPCodecsSupport(...e){return $r.getSDPCodecsSupport(...e)}static removeSDPFirefoxH264Pref(...e){return $r.removeSDPFirefoxH264Pref(...e)}static renderSDPOutput(...e){return $r.renderSDPOutput(...e)}static getSDPICECandidates(...e){return $r.getSDPICECandidates(...e)}static getSDPSelectedCodec(...e){return $r.getSDPSelectedCodec(...e)}static setOriginalDTLSRole(...e){return $r.setOriginalDTLSRole(...e)}static modifyDTLSRole(...e){return $r.modifyDTLSRole(...e)}static getTransceiverMid(...e){return $r.getTransceiverMid(...e)}}const zr=e=>"relay"===e?"relayed":"host"===e||e.indexOf("host")>-1?"local":"srflx"===e?"serverreflexive":"prflx"===e?"peerreflexive":e,Jr={parseSelectedCandidatePair:(e,t,n,r,i,s,o)=>{const{peerBandwidth:a,peerStats:c}=e,{raw:d,selectedCandidatePair:l}=t,{AdapterJS:u}=window,p=Object.keys(t.raw);let S=null,E=null,g=null;if(u.webrtcDetectedBrowser===Ie.CHROME)for(let e=0;e<p.length;e+=1)"transport"===d[p[e]].type&&(S=d[p[e]]);else u.webrtcDetectedBrowser===Ie.FIREFOX&&(S={});if(S)for(let e=0;e<p.length;e+=1){const t=d[p[e]];if("candidate-pair"===t.type&&t.id===S.selectedCandidatePairId||"candidate-pair"===t.type&&t.selected){const e=t;E=e.localCandidateId,g=e.remoteCandidateId,l.id=e.id,l.writable=e.writable,l.priority=e.priority,l.nominated=e.nominated;const n=o?a[s][t.id]:c[s][t.id],r=parseInt(t.totalRoundTripTime||"0",10);l.totalRoundTripTime=r,l.roundTripTime=Jr.tabulateStats(n,t,"totalRoundTripTime");const i=parseInt(t.consentRequestsSent||"0",10);l.consentRequests.totalSent=i,l.consentRequests.sent=Jr.tabulateStats(n,t,"consentRequestsSent");const d=parseInt(t.requestsReceived||"0",10);l.requests.totalReceived=d,l.requests.received=Jr.tabulateStats(n,t,"requestsReceived");const u=parseInt(t.requestsSent||"0",10);l.requests.totalSent=u,l.requests.sent=Jr.tabulateStats(n,t,"requestsSent");const p=parseInt(t.responsesSent||"0",10);l.responses.totalSent=p,l.responses.sent=Jr.tabulateStats(n,t,"responsesSent");const S=parseInt(t.responsesReceived||"0",10);l.responses.totalReceived=S,l.responses.received=Jr.tabulateStats(n,t,"responsesReceived");}}if(E&&g){if("remote-candidate"===n){const e=r;e.id===g&&(l.remote.ipAddress=e.ip?e.ip:e.address,l.remote.portNumber=e.port,l.remote.transport=e.protocol,l.remote.priority=e.priority,l.remote.candidateType=zr(e.candidateType));}if("local-candidate"===n){const e=r;e.id===E&&(l.local.ipAddress=e.ip?e.ip:e.address,l.local.portNumber=e.port,l.local.transport=e.protocol,l.local.priority=e.priority,l.local.networkType=e.networkType,l.local.candidateType=zr(e.candidateType));}}},parseCertificates:(e,t)=>{const{certificate:n,raw:r}=e,i=Object.keys(e.raw);let s=null;for(let e=0;e<i.length;e+=1)"transport"===r[i[e]].type&&(s=r[i[e]]);if(s){n.srtpCipher=s.srtpCipher,n.dtlsCipher=s.dtlsCipher,n.tlsVersion=s.tlsVersion;const{localCertificateId:e,remoteCertificateId:r}=s;t.id===e?(n.local={},n.local.base64Certificate=t.base64Certificate,n.local.fingerprintAlgorithm=t.fingerprintAlgorithm):t.id===r&&(n.remote={},n.remote.base64Certificate=t.base64Certificate,n.remote.fingerprintAlgorithm=t.fingerprintAlgorithm);}},tabulateStats:(e=null,t,n)=>{const r=t.timestamp,i=e&&e.timestamp||0,s=parseFloat(t[n]||"0",10),o=parseFloat(e&&e[n]||"0",10);return new Date(r).getTime()===new Date(i).getTime()?s:parseFloat(((s-o)/(r-i)*1e3).toFixed(3)||"0",10)},parseAudio:(e,t,n,r,i,s,o)=>{console.log("parseAudio",n,r,o);const{peerBandwidth:a,peerStats:c}=e,d=s?a[i][r.id]:c[i][r.id];switch(o){case"receiving":((e,t,n)=>{const r=e.audio.receiving,i=parseInt(t.packetsReceived||"0",10);r.totalPackets=i,r.packets=Jr.tabulateStats(n,t,"packetsReceived");const s=parseInt(t.bytesReceived||"0",10);r.totalBytes=s,r.bytes=Jr.tabulateStats(n,t,"bytesReceived");const o=parseInt(t.packetsLost||"0",10);r.totalPacketsLost=o,r.packetsLost=Jr.tabulateStats(n,t,"packetsLost"),r.jitter=parseInt(t.jitter||"0",10),r.ssrc=t.ssrc;const{trackId:a}=t,c=e.raw[a];c&&(r.audioLevel=parseFloat(c.audioLevel).toFixed(5),r.totalSamplesReceived=parseInt(c.totalSamplesReceived||"0",10),r.totalSamplesDuration=parseInt(c.totalSamplesDuration||"0",10));})(t,r,d);break;case"sending":((e,t,n)=>{const r=e.audio.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);r.totalBytes=e,r.bytes=Jr.tabulateStats(n,t,"bytesSent");}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);r.totalPackets=e,r.packets=Jr.tabulateStats(n,t,"packetsSent");}if(t.retransmittedBytesSent||ur(t.retransmittedBytesSent)){const e=parseInt(t.retransmittedBytesSent||"0",10);r.totalRetransmittedBytesSent=e,r.retransmittedBytesSent=Jr.tabulateStats(n,t,"retransmittedBytesSent");}if(t.retransmittedPacketsSent||ur(t.retransmittedPacketsSent)){const e=parseInt(t.retransmittedPacketsSent||"0",10);r.totalRetransmittedPacketsSent=e,r.retransmittedPacketsSent=Jr.tabulateStats(n,t,"retransmittedPacketsSent");}r.ssrc=t.ssrc,t.jitter&&(r.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(r.roundTripTime=parseInt(t.roundTripTime||"0",10));const{trackId:i,mediaSourceId:s}=t,o=e.raw[i];o&&(r.echoReturnLoss=parseInt(o.echoReturnLoss||"0",10),r.echoReturnLossEnhancement=parseInt(o.echoReturnLossEnhancement||"0",10));const a=e.raw[s];a&&(r.audioLevel=parseFloat(a.audioLevel).toFixed(5),r.totalSamplesDuration=parseInt(a.totalSamplesDuration||"0",10));})(t,r,d);break;default:jr.log.DEBUG([i,ge.STATS_MODULE,null,Ne.STATS_MODULE.ERRORS.PARSE_FAILED]);}},parseVideo:(e,t,n,r,i,s,o)=>{const{peerBandwidth:a,peerStats:c}=e,d=s?a[i][r.id]:c[i][r.id];switch(o){case"receiving":((e,t,n)=>{const r=e.video.receiving;if(t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);r.totalBytes=e,r.bytes=Jr.tabulateStats(n,t,"bytesReceived");}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);r.totalPackets=e,r.packets=Jr.tabulateStats(n,t,"packetsReceived");}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);r.totalPacketsLost=e,r.packetsLost=Jr.tabulateStats(n,t,"packetsLost");}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);r.totalFirs=e,r.firs=Jr.tabulateStats(n,t,"firCount");}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);r.totalNacks=e,r.nacks=Jr.tabulateStats(n,t,"nackCount");}if(t.pliCount||Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);r.totalPlis=e,r.plis=Jr.tabulateStats(n,t,"pliCount");}r.ssrc=t.ssrc,r.qpSum=parseInt(t.qpSum||"0",10),r.decoderImplementation=t.decoderImplementation;const{trackId:i}=t,s=e.raw[i];s&&(r.framesDropped=parseFloat(s.framesDropped||"0"),r.frames=parseInt(s.framesReceived||"0",10),r.framesDecoded=parseInt(s.framesDecoded||"0",10),r.frameWidth=parseInt(s.frameWidth||"0",10),r.frameHeight=parseInt(s.frameHeight||"0",10));})(t,r,d);break;case"sending":((e,t,n)=>{const r=e.video.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);r.totalBytes=e,r.bytes=Jr.tabulateStats(n,t,"bytesSent");}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);r.totalPackets=e,r.packets=Jr.tabulateStats(n,t,"packetsSent");}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);r.totalFirs=e,r.firs=Jr.tabulateStats(n,t,"firCount");}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);r.totalNacks=e,r.nacks=Jr.tabulateStats(n,t,"nackCount");}if(Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);r.totalPlis=e,r.plis=Jr.tabulateStats(n,t,"pliCount");}t.jitter&&(r.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(r.roundTripTime=parseInt(t.roundTripTime||"0",10)),Number.isInteger(t.framesEncoded)&&(r.framesEncoded=parseInt(t.framesEncoded||"0",10)),r.ssrc=t.ssrc,r.qpSum=parseInt(t.qpSum||"0",10);const{trackId:i,mediaSourceId:s}=t,o=e.raw[i];o&&(r.frameWidth=parseInt(o.frameWidth||"0",10),r.frameHeight=parseInt(o.frameHeight||"0",10),r.frames=parseInt(o.framesSent||"0",10),r.hugeFramesSent=parseInt(o.hugeFramesSent||"0",10));const a=e.raw[s];a&&(r.framesPerSecond=parseInt(a.framesPerSecond||"0",10));})(t,r,d);break;default:jr.log.DEBUG([i,ge.STATS_MODULE,null,Ne.STATS_MODULE.ERRORS.PARSE_FAILED]);}},parseMedia:(e,t,n,r,i,s,o,a)=>{const c=r.kind||r.mediaType;c===he.AUDIO?Jr.parseAudio(e,t,n,r,s,o,a):c===he.VIDEO?Jr.parseVideo(e,t,n,r,s,o,a):jr.log.DEBUG([(void 0).peerId,ge.STATS_MODULE,null,Ne.STATS_MODULE.INVALID_TRACK_KIND],r);}};class Xr{constructor(e,t){this.roomState=Hi.getSkylinkState(e),this.peerConnection=this.roomState.peerConnections[t]||null,this.peerConnStatus=this.roomState.peerConnStatus[t]||null,this.dataChannel=this.roomState.dataChannels[t]||null,this.peerId=t,this.roomKey=e,this.output={peerId:t,raw:{},connection:{},audio:{sending:{},receiving:{}},video:{sending:{},receiving:{}},selectedCandidatePair:{id:null,local:{},remote:{},consentRequests:{},responses:{},requests:{}},certificate:{}},this.beSilentOnLogs=Hi.getInitOptions().beSilentOnStatsLogs,this.isAutoBwStats=!1,this.bandwidth=null;}getConnectionStatus(){return this.getStatistics(!1,!1)}getStatsSuccess(e,t,n){const{AdapterJS:r}=window;if(!n&&r.webrtcDetectedBrowser===Ie.REACT_NATIVE)return void e(this.output);const{peerBandwidth:i,peerStats:s,room:o}=this.roomState;"function"==typeof n.forEach?n.forEach((e,t)=>{this.output.raw[t]=e;}):this.output.raw=n;try{if(or(s))return void jr.log.DEBUG([this.peerId,ge.STATS_MODULE,null,Ne.STATS_MODULE.STATS_DISCARDED]);Object.entries(this.output.raw).forEach(e=>{const t=e[0],n=e[1],{type:r}=n;switch(r){case"remote-inbound-rtp":case"outbound-rtp":case"inbound-rtp":"inbound-rtp"===r?Jr.parseMedia(this.roomState,this.output,r,n,this.peerConnection,this.peerId,this.isAutoBwStats,"receiving"):Jr.parseMedia(this.roomState,this.output,r,n,this.peerConnection,this.peerId,this.isAutoBwStats,"sending");break;case"certificate":Jr.parseCertificates(this.output,n);break;case"local-candidate":case"remote-candidate":case"media-source":Jr.parseSelectedCandidatePair(this.roomState,this.output,r,n,this.peerConnection,this.peerId,this.isAutoBwStats);}this.isAutoBwStats&&!i[this.peerId][t]?i[this.peerId][t]=this.output.raw[t]:this.isAutoBwStats||s[this.peerId][t]||(s[this.peerId][t]=this.output.raw[t]),Hi.setSkylinkState(this.roomState,o.id);});}catch(e){this.getStatsFailure(t,Ne.STATS_MODULE.ERRORS.PARSE_FAILED,e);}Lr(A({state:W.RETRIEVE_SUCCESS,peerId:this.peerId,stats:this.output})),e(this.output);}getStatsFailure(e,t,n){const r=t||Ne.STATS_MODULE.RETRIEVE_STATS_FAILED;this.beSilentOnLogs||(jr.log.ERROR([this.peerId,ge.STATS_MODULE,null,r],n),Lr(A({state:W.RETRIEVE_ERROR,peerId:this.peerId,error:n}))),e(n);}getStatistics(e=!1,t=!1){const{STATS_MODULE:n}=Ne;return new Promise((r,i)=>{if(this.roomState.peerStats[this.peerId]||t){this.beSilentOnLogs=e,this.isAutoBwStats=t;try{this.gatherRTCPeerConnectionDetails(),this.gatherSDPIceCandidates(),this.gatherSDPCodecs(),this.gatherRTCDataChannelDetails();}catch(e){jr.log.WARN([this.peerId,ge.STATS_MODULE,null,Ne.STATS_MODULE.ERRORS.PARSE_FAILED],e);}"function"!=typeof this.peerConnection.getStats&&this.getStatsFailure(i,Ne.PEER_CONNECTION.getstats_api_not_available),Lr(A({state:W.RETRIEVING,peerId:this.peerId})),this.peerConnection.getStats().then(e=>{this.getStatsSuccess(r,i,e);}).catch(e=>{e.message!==Ne.STATS_MODULE.ERRORS.STATS_IS_NULL?this.getStatsFailure(i,null,e):jr.log.WARN([this.peerId,ge.STATS_MODULE,null,Ne.STATS_MODULE.ERRORS.RETRIEVE_STATS_FAILED],e.message);});}else jr.log.WARN(n.NOT_INITIATED),r(null);})}gatherRTCPeerConnectionDetails(){const{peerConnection:e}=this;this.output.connection.iceConnectionState=e.iceConnectionState,this.output.connection.iceGatheringState=e.iceGatheringState,this.output.connection.signalingState=e.signalingState,this.output.connection.remoteDescription={type:e.remoteDescription&&e.remoteDescription.type||"",sdp:e.remoteDescription&&e.remoteDescription.sdp||""},this.output.connection.localDescription={type:e.localDescription&&e.localDescription.type||"",sdp:e.localDescription&&e.localDescription.sdp||""},this.output.connection.constraints=this.peerConnStatus?this.peerConnStatus.constraints:null,this.output.connection.optional=this.peerConnStatus?this.peerConnStatus.optional:null,this.output.connection.sdpConstraints=this.peerConnStatus?this.peerConnStatus.sdpConstraints:null;}gatherSDPIceCandidates(){const{peerConnection:e,beSilentOnLogs:t}=this;this.output.connection.candidates={sending:Yr.getSDPICECandidates(this.peerId,e.localDescription,t),receiving:Yr.getSDPICECandidates(this.peerId,e.remoteDescription,t)};}gatherSDPCodecs(){const{peerConnection:e,beSilentOnLogs:t}=this;this.output.audio.sending.codec=Yr.getSDPSelectedCodec(this.peerId,e.remoteDescription,"audio",t),this.output.video.sending.codec=Yr.getSDPSelectedCodec(this.peerId,e.remoteDescription,"video",t),this.output.audio.receiving.codec=Yr.getSDPSelectedCodec(this.peerId,e.localDescription,"audio",t),this.output.video.receiving.codec=Yr.getSDPSelectedCodec(this.peerId,e.localDescription,"video",t);}gatherRTCDataChannelDetails(){const{dataChannel:e}=this;if(e){const t=Object.keys(e);this.output.connection.dataChannels={},t.forEach(t=>{const n=e[t];this.output.connection.dataChannels[n.channel.label]={label:n.channel.label,readyState:n.channel.readyState,channelType:k["main"===t?"MESSAGING":"DATA"],currentTransferId:n.transferId||null,currentStreamId:n.streamId||null};});}}}const qr=e=>{const{peerMedias:t,user:n}=e,r={},i=Object.keys(t).filter(e=>e!==n.sid);for(let e=0;e<i.length;e+=1){const n=i[e];Object.values(t[n]).forEach(e=>{e.mediaType===me.VIDEO_SCREEN&&(r[n]=e.streamId);});}return r},Qr=(e,t,n,r=!1)=>{Fe.prepStopStreams(e.id,t.id,r,!0).then(()=>jr.log.DEBUG([n,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.STOP_SCREEN_SUCCESS}`])).catch(e=>jr.log.DEBUG([n,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.ERRORS.STOP_SCREEN}`],e));},Zr={handleScreenStreamStates:{addScreenStreamToState:(e,t)=>{const{room:n,user:r}=e,i=sr.parseStreamSettings({video:!0});sr.processStreamInState(t,i,n.id,!0,!1),Lr(a({stream:t,peerId:r.sid,room:n,isSelf:!0,peerInfo:Ke.getCurrentSessionInfo(n),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0}));},removeScreenStreamFromState:e=>{const{room:t,streams:n}=e;n.screenshare=null,Hi.setSkylinkState(e,t.id);},setScreenStateToUnavailable:(e,t)=>{const{user:n,room:r}=e,i=Wn.retrieveMediaId(he.VIDEO,t.id);Wn.setMediaStateToUnavailable(r,n.sid,i);}},addScreenStreamCallbacks:(e,t)=>{t.getTracks().forEach(n=>{n.onended=()=>Qr(e.room,t,e.user.sid);});},retrievePeersScreenStreamId:qr,retrievePeerScreenStream:e=>{const{remoteStreams:t}=e,n=qr(e);if(or(n))return null;const r={};return Object.keys(n).forEach(e=>{const i=Object.values(t[e]);r[e]=i.filter(t=>t.id===n[e].id);}),r},stopScreenStream:Qr};class ei{static addPeer(e){Sn.addPeer(e);}static createOffer(...e){return Sn.createOffer(...e)}static createAnswer(...e){return Sn.createAnswer(...e)}static createDataChannel(...e){return Sn.createDataChannel(...e)}static sendP2PMessage(...e){return Sn.sendP2PMessage(...e)}static getPeersInRoom(...e){return Sn.getPeersInRoom(...e)}static retrieveStatistics(e,t,n,r){return new Xr(e,t).getStatistics(n,r)}static signalingEndOfCandidates(...e){return Sn.signalingEndOfCandidates(...e)}static getConnectionStatus(e,t){return Sn.getConnectionStatus(e,t)}static getDataChannelBuffer(e){return Sn.getDataChannelBuffer(e)}static refreshDataChannel(e,t){return Sn.refreshDataChannel(e,t)}static closeDataChannel(e,t){return Sn.closeDataChannel(e,t)}static refreshConnection(e,t,n,r,i){return Sn.refreshConnection(e,t,n,r,i)}static refreshPeerConnection(e,t,n,r){return Sn.refreshPeerConnection(e,t,n,r)}static getPeerScreenshare(e){return Zr.retrievePeerScreenStream(e)}static buildPeerInformations(...e){return Sn.buildPeerInformations(...e)}static closePeerConnection(e,t){return Sn.closePeerConnection(e,t)}static updatePeerInformationsMediaStatus(e,t,n,r){return Sn.updatePeerInformationsMediaStatus(e,t,n,r)}}const ti={};class ni{constructor(e){const{room:t}=e;if(ti[t.id])return ti[t.id];this.roomState=e,this.stream=null,this.signaling=new Vn,this.isReplace=null,this.streamId=null,ti[t.id]=this;}streamExists(){const e=sr.getStreams(this.roomState,this.roomState.room.name),t=Object.keys(e.userMedia);for(let e=0;e<t.length;e+=1)if(t[e]===this.streamId)return !0;return !1}hasMoreThanOneVideoStream(){return sr.retrieveVideoStreams(this.roomState.room).length>1}hasUserMediaStream(){const{streams:e}=this.roomState;return e.userMedia}async start(e,t=null){this.isReplace=!1,this.streamId=t;try{if(this.checkForExistingScreenStreams(),this.checksForReplaceScreen(),this.stream=await this.startScreenCapture(),!this.stream)return this.deleteScreensharingInstance(this.roomState.room),null;Zr.handleScreenStreamStates.addScreenStreamToState(this.roomState,this.stream,this.isReplace),Zr.addScreenStreamCallbacks(this.roomState,this.stream),this.isReplace?this.replaceUserMediaStream():this.addScreenshareStream();}catch(e){jr.log.ERROR([this.roomState.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.REPLACE_SCREEN],e);}return this.stream}stop(e=!1){if(!this.stream)return jr.log.DEBUG([this.roomState.user.sid,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.ERRORS.STOP_SCREEN} - ${Ne.MEDIA_STREAM.ERRORS.NO_STREAM}`]),null;try{Zr.stopScreenStream(this.roomState.room,this.stream,this.roomState.user.sid,e),this.isReplace=null,this.streamId=null,this.stream=null;}catch(e){jr.log.ERROR([this.roomState.user.sid,ge.MEDIA_STREAM,null,`${Ne.MEDIA_STREAM.ERRORS.STOP_SCREEN}`],e);}return null}startScreenCapture(){const{navigator:e}=window;return e.mediaDevices.getDisplayMedia?e.mediaDevices.getDisplayMedia({video:!0}).then(e=>e).catch(e=>("NotAllowedError"===e.name?jr.log.WARN(e):jr.log.ERROR(e),null)):e.mediaDevices.getUserMedia({video:{mediaSource:"screen"}}).then(e=>e).catch(e=>(jr.log.ERROR(e),null))}checksForReplaceScreen(){if(this.isReplace){if(!this.hasUserMediaStream())throw new Error(Ne.MEDIA_STREAM.ERRORS.NO_USER_MEDIA_STREAMS);if(this.hasMoreThanOneVideoStream()&&!this.streamId)throw new Error(Ne.MEDIA_STREAM.ERRORS.NO_STREAM_ID);if(this.streamId&&!Er(this.streamId))throw new Error(Ne.MEDIA_STREAM.ERRORS.INVALID_STREAM_ID_TYPE);if(this.streamId&&!this.streamExists())throw new Error(`${Ne.MEDIA_STREAM.ERRORS.INVALID_STREAM_ID} - ${this.streamId}`)}}checkForExistingScreenStreams(){const e=Zr.retrievePeersScreenStreamId(this.roomState);or(e)||jr.log.WARN([this.roomState.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.PEER_SCREEN_ACTIVE]);}replaceUserMediaStream(){const{peerConnections:e,streams:t}=this.roomState,n=Object.keys(e),r=this.streamId?t.userMedia[this.streamId].stream:sr.retrieveVideoStreams(this.roomState.room)[0],i=this.stream;this.streamId=r.id,vr(r,i,this.roomState,!0),n.forEach(e=>{sr.replaceTrack(r,i,e,this.roomState);});}addScreenshareStream(){const{peerConnections:e}=this.roomState;or(e)||ei.refreshConnection(this.roomState).catch(e=>jr.log.ERROR([this.roomState.user.sid,ge.MEDIA_STREAM,null,Ne.MEDIA_STREAM.ERRORS.START_SCREEN],e));}deleteScreensharingInstance(e){delete ti[e.id];}isReplaceScreenStream(){return this.isReplace}}let ri=null;class ii{constructor(){return ri||(ri=this),this.states={},ri}setState(e){this.states[e.room.id]=e;}getAllStates(){return this.states}getState(e){return this.states[e]}removeStateByRoomId(e){return delete this.states[e]}clearRoomStateFromSingletons(e){const t=this.getState(e);new ni(t).deleteScreensharingInstance(t.room),gt.deleteAsyncInstance(t.room),pt.deleteEncryptedInstance(t.room);}}class si{static shouldProceed(e,t,n){let r=null;return e.isPrivileged||(r=Ne.PEER_PRIVILEGED.not_privileged),t||(r=Ne.PEER_PRIVILEGED.no_appkey),r&&(jr.log.DEBUG(r),n(new Error(r))),!r}static getPeerList(e,t){return new Promise((n,r)=>{try{const i=Hi.getSkylinkState(e.id),s=Hi.getInitOptions(),o=t||!1,a=e=>{const t=e.detail;t.state===J.DISPATCHED&&(kr(ye.GET_PEERS_STATE_CHANGE,a),Lr(v({state:J.RECEIVED,privilegePeerId:i.user.sid,peerList:t.peerList})),n(t.peerList));};this.shouldProceed(i,s.appKey,r)&&((new Vn).getPeerList(o),Lr(v({state:J.ENQUIRED,privilegePeerId:i.user.sid,peerList:null})),jr.log.INFO(Ne.PEER_PRIVILEGED.getPeerListFromServer),br(ye.GET_PEERS_STATE_CHANGE,a));}catch(e){jr.log.ERROR(e),r(e);}})}}const oi={defaultRoom:(new Date).valueOf(),appKey:null,roomServer:"//api.temasys.io",enableDataChannel:!0,enableSTUNServer:!0,enableTURNServer:!0,socketServerPath:null,enableStatsGathering:!0,audioFallback:!0,socketTimeout:7e3,apiTimeout:4e3,forceTURNSSL:!1,forceTURN:!1,forceSSL:!0,usePublicSTUN:!1,disableVideoFecCodecs:!1,disableComfortNoiseCodec:!1,disableREMB:!1,throttleShouldThrowError:!1,mcuUseRenegoRestart:!0,useEdgeWebRTC:!1,enableSimultaneousTransfers:!0,TURNServerTransport:V.ANY,credentials:null,filterCandidatesType:{host:!1,srflx:!1,relay:!1},throttleIntervals:{shareScreen:1e4,refreshConnection:5e3,getUserMedia:0},iceServer:null,socketServer:null,audioCodec:ie.AUTO,videoCodec:re.AUTO,codecParams:{audio:{opus:{stereo:null,"sprop-stereo":null,usedtx:null,useinbandfec:null,maxplaybackrate:null,minptime:null}},video:{h264:{profileLevelId:null,levelAsymmetryAllowed:null,packetizationMode:null},vp8:{maxFs:null,maxFr:null},vp9:{maxFs:null,maxFr:null}}},beSilentOnStatsLogs:!1};class ai{constructor(e){this.id=e.room_key,this.token=e.roomCred,this.startDateTime=e.start,this.duration=e.len,this.roomName=e.roomName,this.connection={peerConstraints:JSON.parse(e.pc_constraints),offerConstraints:JSON.parse(e.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConfig:{iceServers:[]},mediaConstraints:JSON.parse(e.media_constraints)};}getRoomKey(){return this.id}getRoomName(){return this.roomName}}class ci{constructor(e){this.uid=e.username,this.token=e.userCred,this.timeStamp=e.timeStamp,this.info={},this.sid=null,this.bufferMessage=null;}}class di{constructor(e){const{offer_constraints:t,pc_constraints:n,cid:r,apiOwner:i,ipSigserver:s,isPrivileged:o,autoIntroduce:a,httpPortList:c,httpsPortList:d,hasMCU:l,ipSigserverPath:u,hasPersistentMessage:p}=e;t||n||jr.log.ERROR(["API",null,"init","pc_constraints or offer_constraints are null"]),jr.log.DEBUG(["API",null,"init","Parsed Peer Connection constraints:"],JSON.parse(n)),jr.log.DEBUG(["API",null,"init","Parsed Offer constraints"],JSON.parse(t)),this.key=r,this.appKeyOwner=i,this.isPrivileged=o,this.autoIntroduce=a,this.room=new ai(e),this.user=new ci(e),this.hasMCU=l,this.socketServer=s,this.socketServerPath=u,this.socketPorts={"http:":Array.isArray(c)&&c.length>0?c:[80,3e3],"https:":Array.isArray(d)&&d.length>0?d:[443,3443]},this.hasPersistentMessage=p;}}const li=e=>{const{appKey:t}=e,n={isValid:!0,message:""};return jr.log.INFO(["API",null,"init","API initialised with options:"],e),t||(n.isValid=!1,n.message=Ne.INIT.ERRORS.NO_APP_KEY,Lr(m({readyState:q.ERROR,error:{status:-2,content:new Error(Ne.INIT.ERRORS.NO_APP_KEY),errorCode:Q.NO_PATH},room:null}))),n.isValid||jr.log.ERROR(["API",null,"init",n.message]),n},ui=e=>{const{ok:t}=e;return (e=>{const{status:t,ok:n}=e,r=n?"INFO":"ERROR";let i=Ne.INIT.INFO.API_SUCCESS;n||(i=Ne.INIT.ERRORS.AUTH_GENERAL,403===t&&(i=Ne.INIT.ERRORS.AUTH_CORS)),jr.log[r](["API",null,"auth",i],e);})(e),t},pi=e=>{const t=e;return !0===t.forceTURN&&(t.enableTURNServer=!0,t.enableSTUNServer=!1,t.filterCandidatesType.host=!0,t.filterCandidatesType.srflx=!0,t.filterCandidatesType.relay=!1),t},Si=e=>{const t=Hi.getUserInitOptions(),n=Hi.getInitOptions();let r=Object.assign(n,e,t);const i=li(r);if(!i.isValid)throw new Error(i.message);return r=pi(r),Hi.setInitOptions(r),r},Ei=async e=>{const{fetch:t}=window,n=(e=>{const{roomServer:t,appKey:n,defaultRoom:r,credentials:i,forceSSL:s}=e;let o=`${t}/api/${n}/${r}`,a="?";if(o=s?`https:${o}`:`${window.location.protocol}${o}`,i){const{startDateTime:e,duration:t}=i;o+=`/${e}/${t}?cred=${i.credentials}`,a="&";}return o+=`${a}rand=${Date.now()}`})(e);return {endpoint:n,response:await t(n,{headers:{Skylink_SDK_type:Ce.WEB,Skylink_SDK_version:"2.0.0",Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"}})}},gi=e=>{return new di(e)},mi=()=>{const{AdapterJS:e}=window,t={ready:!0,message:""};return (()=>{try{const e=new window.RTCPeerConnection(null);return ["object","function"].indexOf(typeof e.createOffer)>-1&&null!==e.createOffer}catch(e){return !1}})()||(window.RTCPeerConnection&&"plugin"===e.webrtcDetectedType?t.message="Plugin is not available. Please check plugin status.":t.message="WebRTC not supported. Please upgrade your browser",t.ready=!1,Lr(m({readyState:q.ERROR,error:{status:-2,content:new Error("plugin"===e.webrtcDetectedType&&window.RTCPeerConnection?"Plugin is not available":"WebRTC not available"),errorCode:Q.NO_WEBRTC_SUPPORT},room:null}))),t},fi=e=>new Promise((t,n)=>{Yr.getCodecsSupport(e).then(r=>{const i=Hi.getSkylinkState(e),{room:s}=i;0===Object.keys(r.audio).length&&0===Object.keys(r.video).length?(jr.log.ERROR(Ne.JOIN_ROOM.ERRORS.CODEC_SUPPORT),Lr(m({readyState:q.ERROR,error:{status:-2,content:new Error(Ne.JOIN_ROOM.ERRORS.CODEC_SUPPORT),errorCode:Q.PARSE_CODECS},room:s.roomName})),n(new Error(Ne.JOIN_ROOM.ERRORS.CODEC_SUPPORT))):t(!0),i.currentCodecSupport=r,Hi.setSkylinkState(i);}).catch(t=>{const r=Hi.getSkylinkState(e),{room:i}=r;jr.log.ERROR(t),Lr(m({readyState:q.ERROR,error:{status:-2,content:new Error(t.message||t.toString()),errorCode:Q.PARSE_CODECS},room:i.roomName})),n(new Error(t.message||t.toString()));});});let hi=null;class Ri{constructor(){return hi||(hi=this),this.options={},hi}init(e=oi){e&&(e.socketServer&&(e.socketServerPath=""),Hi.setUserInitOptions(e)),Lr(m({readyState:q.INIT,error:null,room:null}));const t=ft(),{AdapterJS:n}=window;if(!t.fulfilled)throw Lr(m({readyState:q.ERROR,error:{status:-2,content:new Error(t.message),errorCode:t.readyStateChangeErrorCode},room:null})),new Error(t.message);let r=Object.assign({},oi,e);const i=li(r);if(!i.isValid)throw new Error(i.message);return n.webRTCReady(()=>{const e=mi();if(!e.ready)throw new Error(e.message)}),r=pi(r)}createRoom(e){return new Promise((t,n)=>{const r=Hi.getInitOptions();r.defaultRoom=e,Ei(r).then(r=>{const{endpoint:i,response:s}=r;ui(s)?(Lr(m({readyState:q.COMPLETED,error:null,room:e})),s.json().then(e=>{t({endpoint:i,response:e});})):(Lr(m({readyState:q.ERROR,error:{status:s.status,content:new Error(s.info||`XMLHttpRequest status not OK\nStatus was: ${s.status}`),errorCode:s.error||s.status},room:e})),n(s.json()));}).catch(t=>{Lr(m({readyState:q.ERROR,error:{status:t.status||-1,content:new Error(t.message||"Network error occurred"),errorCode:Q.XML_HTTP_REQUEST_ERROR},room:e}));});})}checkCodecSupport(e){return fi(e)}static parseAPIResponseBody(e){return gi(e)}enforceUserInitOptions(e){return Si(e)}static getRoomNameFromParams(e){const t=Hi.getInitOptions(),{roomName:n}=e,{defaultRoom:r}=t;let i=null;return i=void 0!==n&&""!==n&&r!==n?n:r}static getStateByKey(e){return fr(e)}}const Ti=e=>new Promise(t=>{const n=Hi.getSkylinkState(e.room.id),{room:r,peerConnections:i}=n,{ROOM:{LEAVE_ROOM:s}}=Ne,o=new Vn,a=Object.keys(Hi.getSkylinkState()).length>1;if(n.inRoom=!1,Hi.setSkylinkState(n,r.id),a)jr.log.INFO([r.roomName,null,null,s.SENDING_BYE]),Object.keys(i).forEach(e=>{o.bye(n,e);}),t(n);else{o.config=o.resetSocketConfig(window.location.protocol);const e=()=>{jr.log.INFO([r.roomName,null,null,s.DISCONNECT_SOCKET.SUCCESS]),kr(ye.CHANNEL_CLOSE,e),t(n);};br(ye.CHANNEL_CLOSE,e),o.socket.connected?o.socket.disconnect():t(n);}}),Ci=e=>{const{room:t,streams:n}=e;n.userMedia&&Fe.prepStopStreams(t.id,null,!0),n.screenshare&&new ni(e).stop(!0);},Ii=e=>{Hi.clearRoomStateFromSingletons(e),Hi.removeSkylinkState(e);},_i=e=>new Promise((t,n)=>{const{peerConnections:r,peerInformations:i,room:s,hasMCU:o,user:a}=e,{ROOM:{LEAVE_ROOM:c}}=Ne;try{const n=o?[_e.MCU]:Array.from(new Set([...Object.keys(r),...Object.keys(i)]));if(ar(n))jr.log.DEBUG([s.roomName,null,null,c.NO_PEERS]),Ci(e),Ti(e).then(e=>{jr.log.INFO([s.roomName,null,null,c.REMOVE_STATE.SUCCESS]),Lr(I({peerId:a.sid,peerInfo:Ke.getCurrentSessionInfo(s),isSelf:!0,room:s})),Ii(e.room.id),t(e.room.roomName);});else{const r=[];n.forEach(t=>{r.push(((e,t)=>new Promise(n=>{const{room:r,peerConnections:i}=e,{ROOM:{LEAVE_ROOM:s}}=Ne;jr.log.INFO([t,r.roomName,null,s.PEER_LEFT.START]),t===_e.MCU?Lr(_({peerId:t,serverPeerType:H.MCU,room:r})):Lr(I({peerId:t,peerInfo:Ke.getCurrentSessionInfo(r),isSelf:!1,room:r})),i[t]&&i[t].signalingState!==j.CLOSED&&ei.closePeerConnection(e,t),br(ye.DATA_CHANNEL_STATE,e=>{const{detail:t}=e;t.state!==b.CLOSED&&t.state!==b.CLOSING||(jr.log.INFO([t.peerId,r.roomName,null,s.PEER_LEFT.SUCCESS]),n(t.peerId));}),ei.closeDataChannel(e,t);}))(e,t));}),Promise.all(r).then(()=>(Ci(e),Ti(e))).then(e=>{jr.log.INFO([s.roomName,null,null,c.REMOVE_STATE.SUCCESS]),Lr(I({peerId:a.sid,peerInfo:Ke.getCurrentSessionInfo(s),isSelf:!0,room:s})),Ii(e.room.id),t(e.room.roomName);});}}catch(e){jr.log.ERROR([s.roomName,null,null,c.ERROR],e),n(e);}}),vi=(e=[],t=[])=>new Promise((n,r)=>{const{ROOM:{LEAVE_ROOM:i}}=Ne;try{const r=Hi.getSkylinkState(),s=Object.values(r);s[0]?_i(s[0]).then(r=>{e.push(r),t.push(n),vi(e,t);}):(jr.log.INFO([e,"Room",null,i.LEAVE_ALL_ROOMS.SUCCESS]),t.forEach(t=>t(e)));}catch(e){jr.log.ERROR([null,"Room",null,i.LEAVE_ALL_ROOMS.ERROR],e),r(e);}});class Oi extends ze{constructor(){super();const{AdapterJS:e,navigator:t}=window;this.model={client_id:null,appKey:null,timestamp:null,username:null,sdk_name:Ce.WEB,sdk_version:null,agent_name:e.webrtcDetectedBrowser,agent_version:e.webrtcDetectedVersion,agent_platform:t.platform,agent_plugin_version:e.WebRTCPlugin.plugin&&e.WebRTCPlugin.plugin.VERSION||null,device_version:null,enumerated_devices:null,device_muted:null,network_type:t.connection?t.connection.type:"-",language:t.language};}send(e){const t=Hi.getSkylinkState(e);this.model.username=t.user&&t.user.uid||null,this.model.sdk_version=t.VERSION,this.model.client_id=t.clientId,this.model.appKey=Hi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.client,this.model);}}class Ai{constructor(e){this.dataChannels={},this.dataTransfers={},this.dataStreams={},this.peerCandidatesQueue={},this.peerEndOfCandidatesCounter={},this.gatheredCandidates={},this.retryCounters={},this.peerConnections={},this.peerStats={},this.peerBandwidth={},this.peerCustomConfigs={},this.peerInformations={},this.user=e.user,this.userData="",this.peerPriorityWeight=0,this.autoIntroduce=e.autoIntroduce,this.isPrivileged=e.isPrivileged,this.selectedRoom=null,this.roomLocked=!1,this.inRoom=!1,this.timestamp={socketMessage:null,shareScreen:null,refreshConnection:null,getUserMedia:null,lastRestart:null},this.socketSession={},this.socketMessageQueue=[],this.socketMessageTimeout=null,this.socketPorts=e.socketPorts,this.channelOpen=!1,this.socketServer=e.socketServer,this.signalingServerProtocol=e.forceSSL?"https:":window.location.protocol,this.signalingServerPort=null,this.socket=null,this.socketUseXDR=!1,this.enableIceRestart=!1,this.hasMCU=e.hasMCU,this.path=null,this.key=e.key,this.appKeyOwner=e.appKeyOwner,this.room=e.room,this.peerMessagesStamps={},this.streams={userMedia:null,screenshare:null},this.streamsDefaultSettings={userMedia:{audio:{stereo:!1},video:{resolution:{width:640,height:480},frameRate:50}},screenshare:{video:!0}},this.streamsMutedSettings={},this.streamsBandwidthSettings={googleX:{},bAS:{}},this.sdpSettings={connection:{audio:!0,video:!0,data:!0},direction:{audio:{send:!0,receive:!0},video:{send:!0,receive:!0}}},this.publishOnly=!1,this.recordings={},this.currentRecordingId=!1,this.recordingStartInterval=null,this.currentCodecSupport=null,this.sdpSessions={},this.voiceActivityDetection=!0,this.binaryChunkType=U.ARRAY_BUFFER,this.peerConnectionConfig={},this.bandwidthAdjuster=null,this.peerConnStatus={},this.joinRoomManager={timestamp:0,socketsFn:[]},this.statIdRandom=Date.now()+Math.floor(1e8*Math.random()),this.rtmpSessions={},this.SMProtocolVersion=ne,this.DTProtocolVersion=G,this.originalDTLSRole=null,this.bufferedLocalOffer={},this.bufferedRemoteOffers={},this.currentRTCRTPSenders={},this.clientId=Cr(),this.streamsMediaStatus={},this.peerMedias={},this.remoteStreams={},this.hasPersistentMessage=e.hasPersistentMessage;}}const yi=(e={},t)=>new Promise((n,r)=>{const i=new Ri,s=new Vn;let o=Hi.getInitOptions();const a=new Oi,c=Ri.getRoomNameFromParams(e)?Ri.getRoomNameFromParams(e):o.defaultRoom;Lr(m({readyState:q.LOADING,error:null,room:c})),i.createRoom(c).then(d=>{const{endpoint:l,response:u}=d;u.roomName=c;const p=new di(u);o=i.enforceUserInitOptions(p);const S=new Ai(o);S.userData=e.userData||"",S.path=l,Hi.setSkylinkState(S,c),i.checkCodecSupport(S.room.id).then(()=>(a.send(S.room.id),s.createSocket(u.room_key).then(()=>{const i=Ri.getStateByKey(u.room_key),o=Object.assign({},e);o.room=i,t||e.id&&e.active?Ve.usePrefetchedStream(u.room_key,t,e).then(()=>{s.joinRoom(i),n(null);}).catch(e=>{r(e);}):e.audio||e.video?Ve.getUserMedia(S,o).then(e=>{s.joinRoom(i),n(e);}).catch(e=>{r(e);}):(s.joinRoom(i),n(null));}))).catch(e=>{r(e);});}).catch(e=>{r(e);});}),Di=(e,t=!0)=>{const n=e,{room:r,user:i}=n,o=new Vn;n.roomLocked=t,Hi.setSkylinkState(n,r.id),o.roomLock(n),Lr(((e={})=>new s("roomLock",{detail:e}))({isLocked:n.roomLocked,peerInfo:Ke.getCurrentSessionInfo(r),peerId:i.sid,isSelf:!0}));},Ni=e=>Di(e,!0),Pi=e=>Di(e,!1);class Mi{static leaveRoom(e){return _i(e)}static leaveAllRooms(){return vi()}static lockRoom(e){return Ni(e)}static unlockRoom(e){return Pi(e)}static joinRoom(e){return yi(e)}}const wi=(e,t,n,r=null,i=null)=>{const s=new In;return jr.log.ERROR(t),s.send(e.room.id,n,r,i,t),new Error(t)},bi=(e,t)=>new Promise((n,r)=>{const{hasMCU:i,currentRecordingId:s,recordingStartInterval:o}=e;let a=t?Ne.RECORDING.START_FAILED:Ne.RECORDING.STOP_FAILED;if(!i){a=`${a} - ${Ne.RECORDING.ERRORS.MCU_NOT_CONNECTED}`;const n=t?Ne.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_START:Ne.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_STOP;r(wi(e,a,n,null,null));}if(t&&s){r(wi(e,`${a} - ${Ne.RECORDING.ERRORS.EXISTING_RECORDING_IN_PROGRESS}`,Ne.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_START_ACTIVE,s,null));}if(!t&&!s){r(wi(e,`${a} - ${Ne.RECORDING.ERRORS.NO_RECORDING_IN_PROGRESS}`,Ne.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_STOP_ACTIVE,s,null));}if(!t&&o){r(wi(e,`${a} - ${Ne.RECORDING.ERRORS.MIN_RECORDING_TIME}`,Ne.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_MIN_STOP,s,null));}((e,t)=>{const n=r=>{const i=r.detail,s=t?ae.START:ae.STOP;i.state===s&&(kr(ye.RECORDING_STATE,n),e(i.recordingId));};br(ye.RECORDING_STATE,n);})(n,t),((e,t,n=null)=>{const r=new Vn,i=new In;r.recording(e.room.id,t?de.START_RECORDING:de.STOP_RECORDING),i.send(e.room.id,t?Ne.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_START:Ne.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_STOP,n,null,null);})(e,t,s);}),ki=e=>bi(e,!0),Li=e=>bi(e,!1);class Ui{static start(...e){return ki(...e)}static stop(...e){return Li(...e)}static getRecordings(e){const{recordings:t}=e;return Object.assign({},t)}}var Gi={checkRTMPDependencies:(e,t,n=null,r=null)=>{const i={shouldProceed:!0,errorMessage:""},{hasMCU:s}=t;return s?e&&!n?(i.errorMessage=Ne.RTMP.start_no_stream_id,i.shouldProceed=!1,i):e&&!r?(i.errorMessage=Ne.RTMP.start_no_endpoint,i.shouldProceed=!1,i):i:(i.errorMessage=e?Ne.RTMP.start_no_mcu:Ne.RTMP.stop_no_mcu,i.shouldProceed=!1,i)},registerRTMPEventListenersAndResolve:(e,t)=>{const n=r=>{const i=r.detail,s=e?Se.START:Se.STOP;i.state===s&&(kr(ye.RTMP_STATE,n),t(i.rtmpId));};br(ye.RTMP_STATE,n);},sendRTMPMessageViaSig:(e,t,n,r=null,i=null)=>{const{room:s,user:o}=e,a=new Vn,c=t?de.START_RTMP:de.STOP_RTMP;a.rtmp(c,s.id,o.sid,n,r,i);}};class xi{static startSession(e,t,n){return this.commonRTMPOperations(e,t,null,n,!0,Ne.RTMP.starting_rtmp)}static stopSession(e,t){return this.commonRTMPOperations(e,null,t,null,!1,Ne.RTMP.stopping_rtmp)}static logErrorAndReject(e,t){jr.log.ERROR(e),t(e);}static commonRTMPOperations(e,t,n,r,i,s){return new Promise((o,a)=>{try{const c=Gi.checkRTMPDependencies(i,e,t,r),d=n||Cr();c.shouldProceed?(Gi.registerRTMPEventListenersAndResolve(i,o),Gi.sendRTMPMessageViaSig(e,i,d,t,r),jr.log.INFO([_e.MCU,"RTMP",s])):this.logErrorAndReject(new Error(c.errorMessage),a);}catch(e){this.logErrorAndReject(e,a);}})}}class Bi{async joinRoom(e={},t){return Mi.joinRoom(e,t)}sendP2PMessage(e="",t="",n=""){ei.sendP2PMessage(e,t,n);}sendMessage(e="",t="",n=""){mt.sendMessage(e,t,n);}getStoredMessages(e){const t=hr(e);t&&new gt(t).getStoredMessages();}getPeersInRoom(e){return gr(e,"roomName","getPeersInRoom")?ei.getPeersInRoom(e):null}getPeerInfo(e,t=null){const n=hr(e);return t&&n?Ke.getPeerInfo(t,n.room):!t&&n?Ke.getCurrentSessionInfo(n.room):null}getUserData(e,t){const n=hr(e);return n&&n.room?Ke.getUserData(n,t):null}setUserData(e,t){const n=hr(e);return n&&n.room?Ke.setUserData(n.room,t):null}getConnectionStatus(e,t){const n=hr(e);return ei.getConnectionStatus(n,t)}getPeers(e,t=!1){const n=hr(e);return n?si.getPeerList(n.room,t):null}getPeersStreams(e,t=!0){const n=hr(e);return n?Ke.getPeersStreams(n,t):null}getPeersDataChannels(e){const t=hr(e);return t?Ke.getPeersDataChannels(t):null}getPeersCustomSettings(e){const t=hr(e);return t?Ke.getPeersCustomSettings(t):null}refreshDatachannel(e,t){const n=hr(e);return n?ei.refreshDataChannel(n,t):null}refreshConnection(e,t,n,r){const i=hr(e);return ei.refreshConnection(i,t,n,r)}shareScreen(e,t){const n=hr(e);if(n){return new ni(n).start(!1,t)}return null}getPeersScreenshare(e){const t=hr(e);return t?ei.getPeerScreenshare(t):null}getUserMedia(e=null,t){if(!e)return Ir(t);if(Er(e)){const n=hr(e);if(n)return Ve.getUserMediaLayer(n,t)}else if(dr(e))return Ir(e)}stopPrefetchedStream(e){return e&&(e.getTracks().forEach(e=>{e.stop();}),Lr(c({room:null,peerId:null,peerInfo:null,isSelf:!0,isScreensharing:!1,streamId:e.id}))),null}stopScreen(e){const t=hr(e);if(t){new ni(t).stop();}return null}stopStreams(e,t){const n=hr(e);return n?Ve.stopStreams(n,t):null}leaveRoom(e){const t=hr(e);return t?Mi.leaveRoom(t):null}leaveAllRooms(){return Mi.leaveAllRooms()}startRecording(e){const t=hr(e);return t?Ui.start(t):null}stopRecording(e){const t=hr(e);return t?Ui.stop(t):null}lockRoom(e){const t=hr(e);return t?Mi.lockRoom(t):null}unlockRoom(e){const t=hr(e);return t?Mi.unlockRoom(t):null}getRecordings(e){const t=hr(e);return t?Ui.getRecordings(t):null}muteStreams(e,t={audioMuted:!0,videoMuted:!0},n){const r=hr(e);return r?Ve.muteStreams(r,t,n):null}startRTMPSession(e,t,n){const r=hr(e);return r?xi.startSession(r,t,n):null}stopRTMPSession(e,t){const n=hr(e);return n?xi.stopSession(n,t):null}getStreamSources(){return Ve.getStreamSources()}sendStream(e,t){const n=hr(e);return Ve.sendStream(n,t)}getScreenSources(){return Ve.getScreenSources()}getStreams(e){const t=hr(e);return t?Ve.getStreams(t):null}generateUUID(){return Cr()}setEncryptSecret(e="",t="",n=""){const r=hr(e);return new pt(r).setEncryptSecret(t,n)}getEncryptSecrets(e=""){const t=hr(e);return new pt(t).getEncryptSecrets()}deleteEncryptSecrets(e="",t=""){const n=hr(e);return new pt(n).deleteEncryptSecrets(t)}setSelectedSecret(e="",t=""){const n=hr(e);new pt(n).setSelectedSecretId(t);}getSelectedSecret(e,t){const n=hr(e);return new pt(n).getSelectedSecretId(t)}setMessagePersistence(e,t){const n=hr(e);return new gt(n).setMessagePersistence(t)}getMessagePersistence(e){const t=hr(e);return new gt(t).getMessagePersistence()}}window.AdapterJS=i,window.io=io;const Fi=new ii;let Vi={},ji={};const Wi=ye;class Hi extends Bi{constructor(e){super();const t=(new Ri).init(e);Hi.setInitOptions(t);}static getSkylinkState(e=null){return e?Fi.getState(e):Fi.getAllStates()}static setSkylinkState(e,t){t&&Fi.setState(e);}static removeSkylinkState(e){if(e)return Fi.removeStateByRoomId(e)}static clearRoomStateFromSingletons(e){if(e)return Fi.clearRoomStateFromSingletons(e)}static getInitOptions(){return Vi}static setInitOptions(e){Vi=e;}static setUserInitOptions(e){ji=e;}static getUserInitOptions(){return ji}static logNoRoomState(e){jr.log.ERROR(`${Ne.ROOM_STATE.NOT_FOUND} - ${e}`);}}e.default=Hi,e.SkylinkLogger=jr,e.SkylinkEventManager=wr,e.SkylinkEvents=Wi,e.SkylinkConstants=De,Object.defineProperty(e,"__esModule",{value:!0});}));

}));
