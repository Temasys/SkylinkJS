/*! skylinkjs - v0.6.3 - 2015-10-25 */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:"undefined"!=typeof global?f=global:"undefined"!=typeof self&&(f=self),f.io=e()}}(function(){var define;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){module.exports=_dereq_("./lib/")},{"./lib/":2}],2:[function(_dereq_,module,exports){function lookup(uri,opts){"object"==typeof uri&&(opts=uri,uri=void 0),opts=opts||{};var io,parsed=url(uri),source=parsed.source,id=parsed.id;return opts.forceNew||opts["force new connection"]||!1===opts.multiplex?(debug("ignoring socket cache for %s",source),io=Manager(source,opts)):(cache[id]||(debug("new io instance for %s",source),cache[id]=Manager(source,opts)),io=cache[id]),io.socket(parsed.path)}var url=_dereq_("./url"),parser=_dereq_("socket.io-parser"),Manager=_dereq_("./manager"),debug=_dereq_("debug")("socket.io-client");module.exports=exports=lookup;var cache=exports.managers={};exports.protocol=parser.protocol,exports.connect=lookup,exports.Manager=_dereq_("./manager"),exports.Socket=_dereq_("./socket")},{"./manager":3,"./socket":5,"./url":6,debug:10,"socket.io-parser":46}],3:[function(_dereq_,module,exports){function Manager(uri,opts){return this instanceof Manager?(uri&&"object"==typeof uri&&(opts=uri,uri=void 0),opts=opts||{},opts.path=opts.path||"/socket.io",this.nsps={},this.subs=[],this.opts=opts,this.reconnection(opts.reconnection!==!1),this.reconnectionAttempts(opts.reconnectionAttempts||1/0),this.reconnectionDelay(opts.reconnectionDelay||1e3),this.reconnectionDelayMax(opts.reconnectionDelayMax||5e3),this.randomizationFactor(opts.randomizationFactor||.5),this.backoff=new Backoff({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==opts.timeout?2e4:opts.timeout),this.readyState="closed",this.uri=uri,this.connected=[],this.encoding=!1,this.packetBuffer=[],this.encoder=new parser.Encoder,this.decoder=new parser.Decoder,this.autoConnect=opts.autoConnect!==!1,void(this.autoConnect&&this.open())):new Manager(uri,opts)}var eio=(_dereq_("./url"),_dereq_("engine.io-client")),Socket=_dereq_("./socket"),Emitter=_dereq_("component-emitter"),parser=_dereq_("socket.io-parser"),on=_dereq_("./on"),bind=_dereq_("component-bind"),debug=(_dereq_("object-component"),_dereq_("debug")("socket.io-client:manager")),indexOf=_dereq_("indexof"),Backoff=_dereq_("backo2");module.exports=Manager,Manager.prototype.emitAll=function(){this.emit.apply(this,arguments);for(var nsp in this.nsps)this.nsps[nsp].emit.apply(this.nsps[nsp],arguments)},Manager.prototype.updateSocketIds=function(){for(var nsp in this.nsps)this.nsps[nsp].id=this.engine.id},Emitter(Manager.prototype),Manager.prototype.reconnection=function(v){return arguments.length?(this._reconnection=!!v,this):this._reconnection},Manager.prototype.reconnectionAttempts=function(v){return arguments.length?(this._reconnectionAttempts=v,this):this._reconnectionAttempts},Manager.prototype.reconnectionDelay=function(v){return arguments.length?(this._reconnectionDelay=v,this.backoff&&this.backoff.setMin(v),this):this._reconnectionDelay},Manager.prototype.randomizationFactor=function(v){return arguments.length?(this._randomizationFactor=v,this.backoff&&this.backoff.setJitter(v),this):this._randomizationFactor},Manager.prototype.reconnectionDelayMax=function(v){return arguments.length?(this._reconnectionDelayMax=v,this.backoff&&this.backoff.setMax(v),this):this._reconnectionDelayMax},Manager.prototype.timeout=function(v){return arguments.length?(this._timeout=v,this):this._timeout},Manager.prototype.maybeReconnectOnOpen=function(){!this.reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()},Manager.prototype.open=Manager.prototype.connect=function(fn){if(debug("readyState %s",this.readyState),~this.readyState.indexOf("open"))return this;debug("opening %s",this.uri),this.engine=eio(this.uri,this.opts);var socket=this.engine,self=this;this.readyState="opening",this.skipReconnect=!1;var openSub=on(socket,"open",function(){self.onopen(),fn&&fn()}),errorSub=on(socket,"error",function(data){if(debug("connect_error"),self.cleanup(),self.readyState="closed",self.emitAll("connect_error",data),fn){var err=new Error("Connection error");err.data=data,fn(err)}else self.maybeReconnectOnOpen()});if(!1!==this._timeout){var timeout=this._timeout;debug("connect attempt will timeout after %d",timeout);var timer=setTimeout(function(){debug("connect attempt timed out after %d",timeout),openSub.destroy(),socket.close(),socket.emit("error","timeout"),self.emitAll("connect_timeout",timeout)},timeout);this.subs.push({destroy:function(){clearTimeout(timer)}})}return this.subs.push(openSub),this.subs.push(errorSub),this},Manager.prototype.onopen=function(){debug("open"),this.cleanup(),this.readyState="open",this.emit("open");var socket=this.engine;this.subs.push(on(socket,"data",bind(this,"ondata"))),this.subs.push(on(this.decoder,"decoded",bind(this,"ondecoded"))),this.subs.push(on(socket,"error",bind(this,"onerror"))),this.subs.push(on(socket,"close",bind(this,"onclose")))},Manager.prototype.ondata=function(data){this.decoder.add(data)},Manager.prototype.ondecoded=function(packet){this.emit("packet",packet)},Manager.prototype.onerror=function(err){debug("error",err),this.emitAll("error",err)},Manager.prototype.socket=function(nsp){var socket=this.nsps[nsp];if(!socket){socket=new Socket(this,nsp),this.nsps[nsp]=socket;var self=this;socket.on("connect",function(){socket.id=self.engine.id,~indexOf(self.connected,socket)||self.connected.push(socket)})}return socket},Manager.prototype.destroy=function(socket){var index=indexOf(this.connected,socket);~index&&this.connected.splice(index,1),this.connected.length||this.close()},Manager.prototype.packet=function(packet){debug("writing packet %j",packet);var self=this;self.encoding?self.packetBuffer.push(packet):(self.encoding=!0,this.encoder.encode(packet,function(encodedPackets){for(var i=0;i<encodedPackets.length;i++)self.engine.write(encodedPackets[i]);self.encoding=!1,self.processPacketQueue()}))},Manager.prototype.processPacketQueue=function(){if(this.packetBuffer.length>0&&!this.encoding){var pack=this.packetBuffer.shift();this.packet(pack)}},Manager.prototype.cleanup=function(){for(var sub;sub=this.subs.shift();)sub.destroy();this.packetBuffer=[],this.encoding=!1,this.decoder.destroy()},Manager.prototype.close=Manager.prototype.disconnect=function(){this.skipReconnect=!0,this.backoff.reset(),this.readyState="closed",this.engine&&this.engine.close()},Manager.prototype.onclose=function(reason){debug("close"),this.cleanup(),this.backoff.reset(),this.readyState="closed",this.emit("close",reason),this._reconnection&&!this.skipReconnect&&this.reconnect()},Manager.prototype.reconnect=function(){if(this.reconnecting||this.skipReconnect)return this;var self=this;if(this.backoff.attempts>=this._reconnectionAttempts)debug("reconnect failed"),this.backoff.reset(),this.emitAll("reconnect_failed"),this.reconnecting=!1;else{var delay=this.backoff.duration();debug("will wait %dms before reconnect attempt",delay),this.reconnecting=!0;var timer=setTimeout(function(){self.skipReconnect||(debug("attempting reconnect"),self.emitAll("reconnect_attempt",self.backoff.attempts),self.emitAll("reconnecting",self.backoff.attempts),self.skipReconnect||self.open(function(err){err?(debug("reconnect attempt error"),self.reconnecting=!1,self.reconnect(),self.emitAll("reconnect_error",err.data)):(debug("reconnect success"),self.onreconnect())}))},delay);this.subs.push({destroy:function(){clearTimeout(timer)}})}},Manager.prototype.onreconnect=function(){var attempt=this.backoff.attempts;this.reconnecting=!1,this.backoff.reset(),this.updateSocketIds(),this.emitAll("reconnect",attempt)}},{"./on":4,"./socket":5,"./url":6,backo2:7,"component-bind":8,"component-emitter":9,debug:10,"engine.io-client":11,indexof:42,"object-component":43,"socket.io-parser":46}],4:[function(_dereq_,module,exports){function on(obj,ev,fn){return obj.on(ev,fn),{destroy:function(){obj.removeListener(ev,fn)}}}module.exports=on},{}],5:[function(_dereq_,module,exports){function Socket(io,nsp){this.io=io,this.nsp=nsp,this.json=this,this.ids=0,this.acks={},this.io.autoConnect&&this.open(),this.receiveBuffer=[],this.sendBuffer=[],this.connected=!1,this.disconnected=!0}var parser=_dereq_("socket.io-parser"),Emitter=_dereq_("component-emitter"),toArray=_dereq_("to-array"),on=_dereq_("./on"),bind=_dereq_("component-bind"),debug=_dereq_("debug")("socket.io-client:socket"),hasBin=_dereq_("has-binary");module.exports=exports=Socket;var events={connect:1,connect_error:1,connect_timeout:1,disconnect:1,error:1,reconnect:1,reconnect_attempt:1,reconnect_failed:1,reconnect_error:1,reconnecting:1},emit=Emitter.prototype.emit;Emitter(Socket.prototype),Socket.prototype.subEvents=function(){if(!this.subs){var io=this.io;this.subs=[on(io,"open",bind(this,"onopen")),on(io,"packet",bind(this,"onpacket")),on(io,"close",bind(this,"onclose"))]}},Socket.prototype.open=Socket.prototype.connect=function(){return this.connected?this:(this.subEvents(),this.io.open(),"open"==this.io.readyState&&this.onopen(),this)},Socket.prototype.send=function(){var args=toArray(arguments);return args.unshift("message"),this.emit.apply(this,args),this},Socket.prototype.emit=function(ev){if(events.hasOwnProperty(ev))return emit.apply(this,arguments),this;var args=toArray(arguments),parserType=parser.EVENT;hasBin(args)&&(parserType=parser.BINARY_EVENT);var packet={type:parserType,data:args};return"function"==typeof args[args.length-1]&&(debug("emitting packet with ack id %d",this.ids),this.acks[this.ids]=args.pop(),packet.id=this.ids++),this.connected?this.packet(packet):this.sendBuffer.push(packet),this},Socket.prototype.packet=function(packet){packet.nsp=this.nsp,this.io.packet(packet)},Socket.prototype.onopen=function(){debug("transport is open - connecting"),"/"!=this.nsp&&this.packet({type:parser.CONNECT})},Socket.prototype.onclose=function(reason){debug("close (%s)",reason),this.connected=!1,this.disconnected=!0,delete this.id,this.emit("disconnect",reason)},Socket.prototype.onpacket=function(packet){if(packet.nsp==this.nsp)switch(packet.type){case parser.CONNECT:this.onconnect();break;case parser.EVENT:this.onevent(packet);break;case parser.BINARY_EVENT:this.onevent(packet);break;case parser.ACK:this.onack(packet);break;case parser.BINARY_ACK:this.onack(packet);break;case parser.DISCONNECT:this.ondisconnect();break;case parser.ERROR:this.emit("error",packet.data)}},Socket.prototype.onevent=function(packet){var args=packet.data||[];debug("emitting event %j",args),null!=packet.id&&(debug("attaching ack callback to event"),args.push(this.ack(packet.id))),this.connected?emit.apply(this,args):this.receiveBuffer.push(args)},Socket.prototype.ack=function(id){var self=this,sent=!1;return function(){if(!sent){sent=!0;var args=toArray(arguments);debug("sending ack %j",args);var type=hasBin(args)?parser.BINARY_ACK:parser.ACK;self.packet({type:type,id:id,data:args})}}},Socket.prototype.onack=function(packet){debug("calling ack %s with %j",packet.id,packet.data);var fn=this.acks[packet.id];fn.apply(this,packet.data),delete this.acks[packet.id]},Socket.prototype.onconnect=function(){this.connected=!0,this.disconnected=!1,this.emit("connect"),this.emitBuffered()},Socket.prototype.emitBuffered=function(){var i;for(i=0;i<this.receiveBuffer.length;i++)emit.apply(this,this.receiveBuffer[i]);for(this.receiveBuffer=[],i=0;i<this.sendBuffer.length;i++)this.packet(this.sendBuffer[i]);this.sendBuffer=[]},Socket.prototype.ondisconnect=function(){debug("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")},Socket.prototype.destroy=function(){if(this.subs){for(var i=0;i<this.subs.length;i++)this.subs[i].destroy();this.subs=null}this.io.destroy(this)},Socket.prototype.close=Socket.prototype.disconnect=function(){return this.connected&&(debug("performing disconnect (%s)",this.nsp),this.packet({type:parser.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}},{"./on":4,"component-bind":8,"component-emitter":9,debug:10,"has-binary":38,"socket.io-parser":46,"to-array":50}],6:[function(_dereq_,module,exports){(function(global){function url(uri,loc){var obj=uri,loc=loc||global.location;return null==uri&&(uri=loc.protocol+"//"+loc.host),"string"==typeof uri&&("/"==uri.charAt(0)&&(uri="/"==uri.charAt(1)?loc.protocol+uri:loc.hostname+uri),/^(https?|wss?):\/\//.test(uri)||(debug("protocol-less url %s",uri),uri="undefined"!=typeof loc?loc.protocol+"//"+uri:"https://"+uri),debug("parse %s",uri),obj=parseuri(uri)),obj.port||(/^(http|ws)$/.test(obj.protocol)?obj.port="80":/^(http|ws)s$/.test(obj.protocol)&&(obj.port="443")),obj.path=obj.path||"/",obj.id=obj.protocol+"://"+obj.host+":"+obj.port,obj.href=obj.protocol+"://"+obj.host+(loc&&loc.port==obj.port?"":":"+obj.port),obj}var parseuri=_dereq_("parseuri"),debug=_dereq_("debug")("socket.io-client:url");module.exports=url}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{debug:10,parseuri:44}],7:[function(_dereq_,module,exports){function Backoff(opts){opts=opts||{},this.ms=opts.min||100,this.max=opts.max||1e4,this.factor=opts.factor||2,this.jitter=opts.jitter>0&&opts.jitter<=1?opts.jitter:0,this.attempts=0}module.exports=Backoff,Backoff.prototype.duration=function(){var ms=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var rand=Math.random(),deviation=Math.floor(rand*this.jitter*ms);ms=0==(1&Math.floor(10*rand))?ms-deviation:ms+deviation}return 0|Math.min(ms,this.max)},Backoff.prototype.reset=function(){this.attempts=0},Backoff.prototype.setMin=function(min){this.ms=min},Backoff.prototype.setMax=function(max){this.max=max},Backoff.prototype.setJitter=function(jitter){this.jitter=jitter}},{}],8:[function(_dereq_,module,exports){var slice=[].slice;module.exports=function(obj,fn){if("string"==typeof fn&&(fn=obj[fn]),"function"!=typeof fn)throw new Error("bind() requires a function");var args=slice.call(arguments,2);return function(){return fn.apply(obj,args.concat(slice.call(arguments)))}}},{}],9:[function(_dereq_,module,exports){function Emitter(obj){return obj?mixin(obj):void 0}function mixin(obj){for(var key in Emitter.prototype)obj[key]=Emitter.prototype[key];return obj}module.exports=Emitter,Emitter.prototype.on=Emitter.prototype.addEventListener=function(event,fn){return this._callbacks=this._callbacks||{},(this._callbacks[event]=this._callbacks[event]||[]).push(fn),this},Emitter.prototype.once=function(event,fn){function on(){self.off(event,on),fn.apply(this,arguments)}var self=this;return this._callbacks=this._callbacks||{},on.fn=fn,this.on(event,on),this},Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(event,fn){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var callbacks=this._callbacks[event];if(!callbacks)return this;if(1==arguments.length)return delete this._callbacks[event],this;for(var cb,i=0;i<callbacks.length;i++)if(cb=callbacks[i],cb===fn||cb.fn===fn){callbacks.splice(i,1);break}return this},Emitter.prototype.emit=function(event){this._callbacks=this._callbacks||{};var args=[].slice.call(arguments,1),callbacks=this._callbacks[event];if(callbacks){callbacks=callbacks.slice(0);for(var i=0,len=callbacks.length;len>i;++i)callbacks[i].apply(this,args)}return this},Emitter.prototype.listeners=function(event){return this._callbacks=this._callbacks||{},this._callbacks[event]||[]},Emitter.prototype.hasListeners=function(event){return!!this.listeners(event).length}},{}],10:[function(_dereq_,module,exports){function debug(name){return debug.enabled(name)?function(fmt){fmt=coerce(fmt);var curr=new Date,ms=curr-(debug[name]||curr);debug[name]=curr,fmt=name+" "+fmt+" +"+debug.humanize(ms),window.console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)}:function(){}}function coerce(val){return val instanceof Error?val.stack||val.message:val}module.exports=debug,debug.names=[],debug.skips=[],debug.enable=function(name){try{localStorage.debug=name}catch(e){}for(var split=(name||"").split(/[\s,]+/),len=split.length,i=0;len>i;i++)name=split[i].replace("*",".*?"),"-"===name[0]?debug.skips.push(new RegExp("^"+name.substr(1)+"$")):debug.names.push(new RegExp("^"+name+"$"))},debug.disable=function(){debug.enable("")},debug.humanize=function(ms){var sec=1e3,min=6e4,hour=60*min;return ms>=hour?(ms/hour).toFixed(1)+"h":ms>=min?(ms/min).toFixed(1)+"m":ms>=sec?(ms/sec|0)+"s":ms+"ms"},debug.enabled=function(name){for(var i=0,len=debug.skips.length;len>i;i++)if(debug.skips[i].test(name))return!1;for(var i=0,len=debug.names.length;len>i;i++)if(debug.names[i].test(name))return!0;return!1};try{window.localStorage&&debug.enable(localStorage.debug)}catch(e){}},{}],11:[function(_dereq_,module,exports){module.exports=_dereq_("./lib/")},{"./lib/":12}],12:[function(_dereq_,module,exports){module.exports=_dereq_("./socket"),module.exports.parser=_dereq_("engine.io-parser")},{"./socket":13,"engine.io-parser":25}],13:[function(_dereq_,module,exports){(function(global){function Socket(uri,opts){if(!(this instanceof Socket))return new Socket(uri,opts);if(opts=opts||{},uri&&"object"==typeof uri&&(opts=uri,uri=null),uri&&(uri=parseuri(uri),opts.host=uri.host,opts.secure="https"==uri.protocol||"wss"==uri.protocol,opts.port=uri.port,uri.query&&(opts.query=uri.query)),this.secure=null!=opts.secure?opts.secure:global.location&&"https:"==location.protocol,opts.host){var pieces=opts.host.split(":");opts.hostname=pieces.shift(),pieces.length?opts.port=pieces.pop():opts.port||(opts.port=this.secure?"443":"80")}this.agent=opts.agent||!1,this.hostname=opts.hostname||(global.location?location.hostname:"localhost"),this.port=opts.port||(global.location&&location.port?location.port:this.secure?443:80),this.query=opts.query||{},"string"==typeof this.query&&(this.query=parseqs.decode(this.query)),this.upgrade=!1!==opts.upgrade,this.path=(opts.path||"/engine.io").replace(/\/$/,"")+"/",this.forceJSONP=!!opts.forceJSONP,this.jsonp=!1!==opts.jsonp,this.forceBase64=!!opts.forceBase64,this.enablesXDR=!!opts.enablesXDR,this.timestampParam=opts.timestampParam||"t",this.timestampRequests=opts.timestampRequests,this.transports=opts.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.callbackBuffer=[],this.policyPort=opts.policyPort||843,this.rememberUpgrade=opts.rememberUpgrade||!1,this.binaryType=null,this.onlyBinaryUpgrades=opts.onlyBinaryUpgrades,this.pfx=opts.pfx||null,this.key=opts.key||null,this.passphrase=opts.passphrase||null,this.cert=opts.cert||null,this.ca=opts.ca||null,this.ciphers=opts.ciphers||null,this.rejectUnauthorized=opts.rejectUnauthorized||null,this.open()}function clone(obj){var o={};for(var i in obj)obj.hasOwnProperty(i)&&(o[i]=obj[i]);return o}var transports=_dereq_("./transports"),Emitter=_dereq_("component-emitter"),debug=_dereq_("debug")("engine.io-client:socket"),index=_dereq_("indexof"),parser=_dereq_("engine.io-parser"),parseuri=_dereq_("parseuri"),parsejson=_dereq_("parsejson"),parseqs=_dereq_("parseqs");module.exports=Socket,Socket.priorWebsocketSuccess=!1,Emitter(Socket.prototype),Socket.protocol=parser.protocol,Socket.Socket=Socket,Socket.Transport=_dereq_("./transport"),Socket.transports=_dereq_("./transports"),Socket.parser=_dereq_("engine.io-parser"),Socket.prototype.createTransport=function(name){debug('creating transport "%s"',name);var query=clone(this.query);query.EIO=parser.protocol,query.transport=name,this.id&&(query.sid=this.id);var transport=new transports[name]({agent:this.agent,hostname:this.hostname,port:this.port,secure:this.secure,path:this.path,query:query,forceJSONP:this.forceJSONP,jsonp:this.jsonp,forceBase64:this.forceBase64,enablesXDR:this.enablesXDR,timestampRequests:this.timestampRequests,timestampParam:this.timestampParam,policyPort:this.policyPort,socket:this,pfx:this.pfx,key:this.key,passphrase:this.passphrase,cert:this.cert,ca:this.ca,ciphers:this.ciphers,rejectUnauthorized:this.rejectUnauthorized});return transport},Socket.prototype.open=function(){var transport;if(this.rememberUpgrade&&Socket.priorWebsocketSuccess&&-1!=this.transports.indexOf("websocket"))transport="websocket";else{if(0==this.transports.length){var self=this;return void setTimeout(function(){self.emit("error","No transports available")},0)}transport=this.transports[0]}this.readyState="opening";var transport;try{transport=this.createTransport(transport)}catch(e){return this.transports.shift(),void this.open()}transport.open(),this.setTransport(transport)},Socket.prototype.setTransport=function(transport){debug("setting transport %s",transport.name);var self=this;this.transport&&(debug("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=transport,transport.on("drain",function(){self.onDrain()}).on("packet",function(packet){self.onPacket(packet)}).on("error",function(e){self.onError(e)}).on("close",function(){self.onClose("transport close")})},Socket.prototype.probe=function(name){function onTransportOpen(){if(self.onlyBinaryUpgrades){var upgradeLosesBinary=!this.supportsBinary&&self.transport.supportsBinary;failed=failed||upgradeLosesBinary}failed||(debug('probe transport "%s" opened',name),transport.send([{type:"ping",data:"probe"}]),transport.once("packet",function(msg){if(!failed)if("pong"==msg.type&&"probe"==msg.data){if(debug('probe transport "%s" pong',name),self.upgrading=!0,self.emit("upgrading",transport),!transport)return;Socket.priorWebsocketSuccess="websocket"==transport.name,debug('pausing current transport "%s"',self.transport.name),self.transport.pause(function(){failed||"closed"!=self.readyState&&(debug("changing transport and sending upgrade packet"),cleanup(),self.setTransport(transport),transport.send([{type:"upgrade"}]),self.emit("upgrade",transport),transport=null,self.upgrading=!1,self.flush())})}else{debug('probe transport "%s" failed',name);var err=new Error("probe error");err.transport=transport.name,self.emit("upgradeError",err)}}))}function freezeTransport(){failed||(failed=!0,cleanup(),transport.close(),transport=null)}function onerror(err){var error=new Error("probe error: "+err);error.transport=transport.name,freezeTransport(),debug('probe transport "%s" failed because of error: %s',name,err),self.emit("upgradeError",error)}function onTransportClose(){onerror("transport closed")}function onclose(){onerror("socket closed")}function onupgrade(to){transport&&to.name!=transport.name&&(debug('"%s" works - aborting "%s"',to.name,transport.name),freezeTransport())}function cleanup(){transport.removeListener("open",onTransportOpen),transport.removeListener("error",onerror),transport.removeListener("close",onTransportClose),self.removeListener("close",onclose),self.removeListener("upgrading",onupgrade)}debug('probing transport "%s"',name);var transport=this.createTransport(name,{probe:1}),failed=!1,self=this;Socket.priorWebsocketSuccess=!1,transport.once("open",onTransportOpen),transport.once("error",onerror),transport.once("close",onTransportClose),this.once("close",onclose),this.once("upgrading",onupgrade),transport.open()},Socket.prototype.onOpen=function(){if(debug("socket open"),this.readyState="open",Socket.priorWebsocketSuccess="websocket"==this.transport.name,this.emit("open"),this.flush(),"open"==this.readyState&&this.upgrade&&this.transport.pause){debug("starting upgrade probes");for(var i=0,l=this.upgrades.length;l>i;i++)this.probe(this.upgrades[i])}},Socket.prototype.onPacket=function(packet){if("opening"==this.readyState||"open"==this.readyState)switch(debug('socket receive: type "%s", data "%s"',packet.type,packet.data),this.emit("packet",packet),this.emit("heartbeat"),packet.type){case"open":this.onHandshake(parsejson(packet.data));break;case"pong":this.setPing();break;case"error":var err=new Error("server error");err.code=packet.data,this.emit("error",err);break;case"message":this.emit("data",packet.data),this.emit("message",packet.data)}else debug('packet received with socket readyState "%s"',this.readyState)},Socket.prototype.onHandshake=function(data){this.emit("handshake",data),this.id=data.sid,this.transport.query.sid=data.sid,this.upgrades=this.filterUpgrades(data.upgrades),this.pingInterval=data.pingInterval,this.pingTimeout=data.pingTimeout,this.onOpen(),"closed"!=this.readyState&&(this.setPing(),this.removeListener("heartbeat",this.onHeartbeat),this.on("heartbeat",this.onHeartbeat))},Socket.prototype.onHeartbeat=function(timeout){clearTimeout(this.pingTimeoutTimer);var self=this;self.pingTimeoutTimer=setTimeout(function(){"closed"!=self.readyState&&self.onClose("ping timeout")},timeout||self.pingInterval+self.pingTimeout)},Socket.prototype.setPing=function(){var self=this;clearTimeout(self.pingIntervalTimer),self.pingIntervalTimer=setTimeout(function(){debug("writing ping packet - expecting pong within %sms",self.pingTimeout),self.ping(),self.onHeartbeat(self.pingTimeout)},self.pingInterval)},Socket.prototype.ping=function(){this.sendPacket("ping")},Socket.prototype.onDrain=function(){for(var i=0;i<this.prevBufferLen;i++)this.callbackBuffer[i]&&this.callbackBuffer[i]();this.writeBuffer.splice(0,this.prevBufferLen),this.callbackBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,0==this.writeBuffer.length?this.emit("drain"):this.flush()},Socket.prototype.flush=function(){"closed"!=this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(debug("flushing %d packets in socket",this.writeBuffer.length),this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emit("flush"))},Socket.prototype.write=Socket.prototype.send=function(msg,fn){return this.sendPacket("message",msg,fn),this},Socket.prototype.sendPacket=function(type,data,fn){if("closing"!=this.readyState&&"closed"!=this.readyState){var packet={type:type,data:data};this.emit("packetCreate",packet),this.writeBuffer.push(packet),this.callbackBuffer.push(fn),this.flush()}},Socket.prototype.close=function(){function close(){self.onClose("forced close"),debug("socket closing - telling transport to close"),self.transport.close()}function cleanupAndClose(){self.removeListener("upgrade",cleanupAndClose),self.removeListener("upgradeError",cleanupAndClose),close()}function waitForUpgrade(){self.once("upgrade",cleanupAndClose),self.once("upgradeError",cleanupAndClose)}if("opening"==this.readyState||"open"==this.readyState){this.readyState="closing";var self=this;this.writeBuffer.length?this.once("drain",function(){this.upgrading?waitForUpgrade():close()}):this.upgrading?waitForUpgrade():close()}return this},Socket.prototype.onError=function(err){debug("socket error %j",err),Socket.priorWebsocketSuccess=!1,this.emit("error",err),this.onClose("transport error",err)},Socket.prototype.onClose=function(reason,desc){if("opening"==this.readyState||"open"==this.readyState||"closing"==this.readyState){debug('socket close with reason: "%s"',reason);var self=this;clearTimeout(this.pingIntervalTimer),clearTimeout(this.pingTimeoutTimer),setTimeout(function(){self.writeBuffer=[],self.callbackBuffer=[],self.prevBufferLen=0},0),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),this.readyState="closed",this.id=null,this.emit("close",reason,desc)}},Socket.prototype.filterUpgrades=function(upgrades){for(var filteredUpgrades=[],i=0,j=upgrades.length;j>i;i++)~index(this.transports,upgrades[i])&&filteredUpgrades.push(upgrades[i]);return filteredUpgrades}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./transport":14,"./transports":15,"component-emitter":9,debug:22,"engine.io-parser":25,indexof:42,parsejson:34,parseqs:35,parseuri:36}],14:[function(_dereq_,module,exports){function Transport(opts){this.path=opts.path,this.hostname=opts.hostname,this.port=opts.port,this.secure=opts.secure,this.query=opts.query,this.timestampParam=opts.timestampParam,this.timestampRequests=opts.timestampRequests,this.readyState="",this.agent=opts.agent||!1,this.socket=opts.socket,this.enablesXDR=opts.enablesXDR,this.pfx=opts.pfx,this.key=opts.key,this.passphrase=opts.passphrase,this.cert=opts.cert,this.ca=opts.ca,this.ciphers=opts.ciphers,this.rejectUnauthorized=opts.rejectUnauthorized}var parser=_dereq_("engine.io-parser"),Emitter=_dereq_("component-emitter");module.exports=Transport,Emitter(Transport.prototype),Transport.timestamps=0,Transport.prototype.onError=function(msg,desc){var err=new Error(msg);return err.type="TransportError",err.description=desc,this.emit("error",err),this},Transport.prototype.open=function(){return("closed"==this.readyState||""==this.readyState)&&(this.readyState="opening",this.doOpen()),this},Transport.prototype.close=function(){return("opening"==this.readyState||"open"==this.readyState)&&(this.doClose(),this.onClose()),this},Transport.prototype.send=function(packets){if("open"!=this.readyState)throw new Error("Transport not open");this.write(packets)},Transport.prototype.onOpen=function(){this.readyState="open",this.writable=!0,this.emit("open")},Transport.prototype.onData=function(data){var packet=parser.decodePacket(data,this.socket.binaryType);this.onPacket(packet)},Transport.prototype.onPacket=function(packet){this.emit("packet",packet)},Transport.prototype.onClose=function(){this.readyState="closed",this.emit("close")}},{"component-emitter":9,"engine.io-parser":25}],15:[function(_dereq_,module,exports){(function(global){function polling(opts){var xhr,xd=!1,xs=!1,jsonp=!1!==opts.jsonp;if(global.location){var isSSL="https:"==location.protocol,port=location.port;port||(port=isSSL?443:80),xd=opts.hostname!=location.hostname||port!=opts.port,xs=opts.secure!=isSSL}if(opts.xdomain=xd,opts.xscheme=xs,xhr=new XMLHttpRequest(opts),"open"in xhr&&!opts.forceJSONP)return new XHR(opts);if(!jsonp)throw new Error("JSONP disabled");return new JSONP(opts)}var XMLHttpRequest=_dereq_("xmlhttprequest"),XHR=_dereq_("./polling-xhr"),JSONP=_dereq_("./polling-jsonp"),websocket=_dereq_("./websocket");exports.polling=polling,exports.websocket=websocket}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./polling-jsonp":16,"./polling-xhr":17,"./websocket":19,xmlhttprequest:20}],16:[function(_dereq_,module,exports){(function(global){function empty(){}function JSONPPolling(opts){Polling.call(this,opts),this.query=this.query||{},callbacks||(global.___eio||(global.___eio=[]),callbacks=global.___eio),this.index=callbacks.length;var self=this;callbacks.push(function(msg){self.onData(msg)}),this.query.j=this.index,global.document&&global.addEventListener&&global.addEventListener("beforeunload",function(){self.script&&(self.script.onerror=empty)},!1)}var Polling=_dereq_("./polling"),inherit=_dereq_("component-inherit");module.exports=JSONPPolling;var callbacks,rNewline=/\n/g,rEscapedNewline=/\\n/g;inherit(JSONPPolling,Polling),JSONPPolling.prototype.supportsBinary=!1,JSONPPolling.prototype.doClose=function(){this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),this.form&&(this.form.parentNode.removeChild(this.form),this.form=null,this.iframe=null),Polling.prototype.doClose.call(this)},JSONPPolling.prototype.doPoll=function(){var self=this,script=document.createElement("script");this.script&&(this.script.parentNode.removeChild(this.script),this.script=null),
script.async=!0,script.src=this.uri(),script.onerror=function(e){self.onError("jsonp poll error",e)};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt),this.script=script;var isUAgecko="undefined"!=typeof navigator&&/gecko/i.test(navigator.userAgent);isUAgecko&&setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe),document.body.removeChild(iframe)},100)},JSONPPolling.prototype.doWrite=function(data,fn){function complete(){initIframe(),fn()}function initIframe(){if(self.iframe)try{self.form.removeChild(self.iframe)}catch(e){self.onError("jsonp polling iframe removal error",e)}try{var html='<iframe src="javascript:0" name="'+self.iframeId+'">';iframe=document.createElement(html)}catch(e){iframe=document.createElement("iframe"),iframe.name=self.iframeId,iframe.src="javascript:0"}iframe.id=self.iframeId,self.form.appendChild(iframe),self.iframe=iframe}var self=this;if(!this.form){var iframe,form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="eio_iframe_"+this.index;form.className="socketio",form.style.position="absolute",form.style.top="-1000px",form.style.left="-1000px",form.target=id,form.method="POST",form.setAttribute("accept-charset","utf-8"),area.name="d",form.appendChild(area),document.body.appendChild(form),this.form=form,this.area=area}this.form.action=this.uri(),initIframe(),data=data.replace(rEscapedNewline,"\\\n"),this.area.value=data.replace(rNewline,"\\n");try{this.form.submit()}catch(e){}this.iframe.attachEvent?this.iframe.onreadystatechange=function(){"complete"==self.iframe.readyState&&complete()}:this.iframe.onload=complete}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./polling":18,"component-inherit":21}],17:[function(_dereq_,module,exports){(function(global){function empty(){}function XHR(opts){if(Polling.call(this,opts),global.location){var isSSL="https:"==location.protocol,port=location.port;port||(port=isSSL?443:80),this.xd=opts.hostname!=global.location.hostname||port!=opts.port,this.xs=opts.secure!=isSSL}}function Request(opts){this.method=opts.method||"GET",this.uri=opts.uri,this.xd=!!opts.xd,this.xs=!!opts.xs,this.async=!1!==opts.async,this.data=void 0!=opts.data?opts.data:null,this.agent=opts.agent,this.isBinary=opts.isBinary,this.supportsBinary=opts.supportsBinary,this.enablesXDR=opts.enablesXDR,this.pfx=opts.pfx,this.key=opts.key,this.passphrase=opts.passphrase,this.cert=opts.cert,this.ca=opts.ca,this.ciphers=opts.ciphers,this.rejectUnauthorized=opts.rejectUnauthorized,this.create()}function unloadHandler(){for(var i in Request.requests)Request.requests.hasOwnProperty(i)&&Request.requests[i].abort()}var XMLHttpRequest=_dereq_("xmlhttprequest"),Polling=_dereq_("./polling"),Emitter=_dereq_("component-emitter"),inherit=_dereq_("component-inherit"),debug=_dereq_("debug")("engine.io-client:polling-xhr");module.exports=XHR,module.exports.Request=Request,inherit(XHR,Polling),XHR.prototype.supportsBinary=!0,XHR.prototype.request=function(opts){return opts=opts||{},opts.uri=this.uri(),opts.xd=this.xd,opts.xs=this.xs,opts.agent=this.agent||!1,opts.supportsBinary=this.supportsBinary,opts.enablesXDR=this.enablesXDR,opts.pfx=this.pfx,opts.key=this.key,opts.passphrase=this.passphrase,opts.cert=this.cert,opts.ca=this.ca,opts.ciphers=this.ciphers,opts.rejectUnauthorized=this.rejectUnauthorized,new Request(opts)},XHR.prototype.doWrite=function(data,fn){var isBinary="string"!=typeof data&&void 0!==data,req=this.request({method:"POST",data:data,isBinary:isBinary}),self=this;req.on("success",fn),req.on("error",function(err){self.onError("xhr post error",err)}),this.sendXhr=req},XHR.prototype.doPoll=function(){debug("xhr poll");var req=this.request(),self=this;req.on("data",function(data){self.onData(data)}),req.on("error",function(err){self.onError("xhr poll error",err)}),this.pollXhr=req},Emitter(Request.prototype),Request.prototype.create=function(){var opts={agent:this.agent,xdomain:this.xd,xscheme:this.xs,enablesXDR:this.enablesXDR};opts.pfx=this.pfx,opts.key=this.key,opts.passphrase=this.passphrase,opts.cert=this.cert,opts.ca=this.ca,opts.ciphers=this.ciphers,opts.rejectUnauthorized=this.rejectUnauthorized;var xhr=this.xhr=new XMLHttpRequest(opts),self=this;try{if(debug("xhr open %s: %s",this.method,this.uri),xhr.open(this.method,this.uri,this.async),this.supportsBinary&&(xhr.responseType="arraybuffer"),"POST"==this.method)try{this.isBinary?xhr.setRequestHeader("Content-type","application/octet-stream"):xhr.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}"withCredentials"in xhr&&(xhr.withCredentials=!0),this.hasXDR()?(xhr.onload=function(){self.onLoad()},xhr.onerror=function(){self.onError(xhr.responseText)}):xhr.onreadystatechange=function(){4==xhr.readyState&&(200==xhr.status||1223==xhr.status?self.onLoad():setTimeout(function(){self.onError(xhr.status)},0))},debug("xhr data %s",this.data),xhr.send(this.data)}catch(e){return void setTimeout(function(){self.onError(e)},0)}global.document&&(this.index=Request.requestsCount++,Request.requests[this.index]=this)},Request.prototype.onSuccess=function(){this.emit("success"),this.cleanup()},Request.prototype.onData=function(data){this.emit("data",data),this.onSuccess()},Request.prototype.onError=function(err){this.emit("error",err),this.cleanup(!0)},Request.prototype.cleanup=function(fromError){if("undefined"!=typeof this.xhr&&null!==this.xhr){if(this.hasXDR()?this.xhr.onload=this.xhr.onerror=empty:this.xhr.onreadystatechange=empty,fromError)try{this.xhr.abort()}catch(e){}global.document&&delete Request.requests[this.index],this.xhr=null}},Request.prototype.onLoad=function(){var data;try{var contentType;try{contentType=this.xhr.getResponseHeader("Content-Type").split(";")[0]}catch(e){}data="application/octet-stream"===contentType?this.xhr.response:this.supportsBinary?"ok":this.xhr.responseText}catch(e){this.onError(e)}null!=data&&this.onData(data)},Request.prototype.hasXDR=function(){return"undefined"!=typeof global.XDomainRequest&&!this.xs&&this.enablesXDR},Request.prototype.abort=function(){this.cleanup()},global.document&&(Request.requestsCount=0,Request.requests={},global.attachEvent?global.attachEvent("onunload",unloadHandler):global.addEventListener&&global.addEventListener("beforeunload",unloadHandler,!1))}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./polling":18,"component-emitter":9,"component-inherit":21,debug:22,xmlhttprequest:20}],18:[function(_dereq_,module,exports){function Polling(opts){var forceBase64=opts&&opts.forceBase64;(!hasXHR2||forceBase64)&&(this.supportsBinary=!1),Transport.call(this,opts)}var Transport=_dereq_("../transport"),parseqs=_dereq_("parseqs"),parser=_dereq_("engine.io-parser"),inherit=_dereq_("component-inherit"),debug=_dereq_("debug")("engine.io-client:polling");module.exports=Polling;var hasXHR2=function(){var XMLHttpRequest=_dereq_("xmlhttprequest"),xhr=new XMLHttpRequest({xdomain:!1});return null!=xhr.responseType}();inherit(Polling,Transport),Polling.prototype.name="polling",Polling.prototype.doOpen=function(){this.poll()},Polling.prototype.pause=function(onPause){function pause(){debug("paused"),self.readyState="paused",onPause()}var self=this;if(this.readyState="pausing",this.polling||!this.writable){var total=0;this.polling&&(debug("we are currently polling - waiting to pause"),total++,this.once("pollComplete",function(){debug("pre-pause polling complete"),--total||pause()})),this.writable||(debug("we are currently writing - waiting to pause"),total++,this.once("drain",function(){debug("pre-pause writing complete"),--total||pause()}))}else pause()},Polling.prototype.poll=function(){debug("polling"),this.polling=!0,this.doPoll(),this.emit("poll")},Polling.prototype.onData=function(data){var self=this;debug("polling got data %s",data);var callback=function(packet,index,total){return"opening"==self.readyState&&self.onOpen(),"close"==packet.type?(self.onClose(),!1):void self.onPacket(packet)};parser.decodePayload(data,this.socket.binaryType,callback),"closed"!=this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"==this.readyState?this.poll():debug('ignoring poll - transport state "%s"',this.readyState))},Polling.prototype.doClose=function(){function close(){debug("writing close packet"),self.write([{type:"close"}])}var self=this;"open"==this.readyState?(debug("transport open - closing"),close()):(debug("transport not open - deferring close"),this.once("open",close))},Polling.prototype.write=function(packets){var self=this;this.writable=!1;var callbackfn=function(){self.writable=!0,self.emit("drain")},self=this;parser.encodePayload(packets,this.supportsBinary,function(data){self.doWrite(data,callbackfn)})},Polling.prototype.uri=function(){var query=this.query||{},schema=this.secure?"https":"http",port="";return!1!==this.timestampRequests&&(query[this.timestampParam]=+new Date+"-"+Transport.timestamps++),this.supportsBinary||query.sid||(query.b64=1),query=parseqs.encode(query),this.port&&("https"==schema&&443!=this.port||"http"==schema&&80!=this.port)&&(port=":"+this.port),query.length&&(query="?"+query),schema+"://"+this.hostname+port+this.path+query}},{"../transport":14,"component-inherit":21,debug:22,"engine.io-parser":25,parseqs:35,xmlhttprequest:20}],19:[function(_dereq_,module,exports){function WS(opts){var forceBase64=opts&&opts.forceBase64;forceBase64&&(this.supportsBinary=!1),Transport.call(this,opts)}var Transport=_dereq_("../transport"),parser=_dereq_("engine.io-parser"),parseqs=_dereq_("parseqs"),inherit=_dereq_("component-inherit"),debug=_dereq_("debug")("engine.io-client:websocket"),WebSocket=_dereq_("ws");module.exports=WS,inherit(WS,Transport),WS.prototype.name="websocket",WS.prototype.supportsBinary=!0,WS.prototype.doOpen=function(){if(this.check()){var uri=this.uri(),protocols=void 0,opts={agent:this.agent};opts.pfx=this.pfx,opts.key=this.key,opts.passphrase=this.passphrase,opts.cert=this.cert,opts.ca=this.ca,opts.ciphers=this.ciphers,opts.rejectUnauthorized=this.rejectUnauthorized,this.ws=new WebSocket(uri,protocols,opts),void 0===this.ws.binaryType&&(this.supportsBinary=!1),this.ws.binaryType="arraybuffer",this.addEventListeners()}},WS.prototype.addEventListeners=function(){var self=this;this.ws.onopen=function(){self.onOpen()},this.ws.onclose=function(){self.onClose()},this.ws.onmessage=function(ev){self.onData(ev.data)},this.ws.onerror=function(e){self.onError("websocket error",e)}},"undefined"!=typeof navigator&&/iPad|iPhone|iPod/i.test(navigator.userAgent)&&(WS.prototype.onData=function(data){var self=this;setTimeout(function(){Transport.prototype.onData.call(self,data)},0)}),WS.prototype.write=function(packets){function ondrain(){self.writable=!0,self.emit("drain")}var self=this;this.writable=!1;for(var i=0,l=packets.length;l>i;i++)parser.encodePacket(packets[i],this.supportsBinary,function(data){try{self.ws.send(data)}catch(e){debug("websocket closed before onclose event")}});setTimeout(ondrain,0)},WS.prototype.onClose=function(){Transport.prototype.onClose.call(this)},WS.prototype.doClose=function(){"undefined"!=typeof this.ws&&this.ws.close()},WS.prototype.uri=function(){var query=this.query||{},schema=this.secure?"wss":"ws",port="";return this.port&&("wss"==schema&&443!=this.port||"ws"==schema&&80!=this.port)&&(port=":"+this.port),this.timestampRequests&&(query[this.timestampParam]=+new Date),this.supportsBinary||(query.b64=1),query=parseqs.encode(query),query.length&&(query="?"+query),schema+"://"+this.hostname+port+this.path+query},WS.prototype.check=function(){return!(!WebSocket||"__initialize"in WebSocket&&this.name===WS.prototype.name)}},{"../transport":14,"component-inherit":21,debug:22,"engine.io-parser":25,parseqs:35,ws:37}],20:[function(_dereq_,module,exports){var hasCORS=_dereq_("has-cors");module.exports=function(opts){var xdomain=opts.xdomain,xscheme=opts.xscheme,enablesXDR=opts.enablesXDR;try{if("undefined"!=typeof XMLHttpRequest&&(!xdomain||hasCORS))return new XMLHttpRequest}catch(e){}try{if("undefined"!=typeof XDomainRequest&&!xscheme&&enablesXDR)return new XDomainRequest}catch(e){}if(!xdomain)try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}},{"has-cors":40}],21:[function(_dereq_,module,exports){module.exports=function(a,b){var fn=function(){};fn.prototype=b.prototype,a.prototype=new fn,a.prototype.constructor=a}},{}],22:[function(_dereq_,module,exports){function useColors(){return"WebkitAppearance"in document.documentElement.style||window.console&&(console.firebug||console.exception&&console.table)||navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31}function formatArgs(){var args=arguments,useColors=this.useColors;if(args[0]=(useColors?"%c":"")+this.namespace+(useColors?" %c":" ")+args[0]+(useColors?"%c ":" ")+"+"+exports.humanize(this.diff),!useColors)return args;var c="color: "+this.color;args=[args[0],c,"color: inherit"].concat(Array.prototype.slice.call(args,1));var index=0,lastC=0;return args[0].replace(/%[a-z%]/g,function(match){"%"!==match&&(index++,"%c"===match&&(lastC=index))}),args.splice(lastC,0,c),args}function log(){return"object"==typeof console&&"function"==typeof console.log&&Function.prototype.apply.call(console.log,console,arguments)}function save(namespaces){try{null==namespaces?localStorage.removeItem("debug"):localStorage.debug=namespaces}catch(e){}}function load(){var r;try{r=localStorage.debug}catch(e){}return r}exports=module.exports=_dereq_("./debug"),exports.log=log,exports.formatArgs=formatArgs,exports.save=save,exports.load=load,exports.useColors=useColors,exports.colors=["lightseagreen","forestgreen","goldenrod","dodgerblue","darkorchid","crimson"],exports.formatters.j=function(v){return JSON.stringify(v)},exports.enable(load())},{"./debug":23}],23:[function(_dereq_,module,exports){function selectColor(){return exports.colors[prevColor++%exports.colors.length]}function debug(namespace){function disabled(){}function enabled(){var self=enabled,curr=+new Date,ms=curr-(prevTime||curr);self.diff=ms,self.prev=prevTime,self.curr=curr,prevTime=curr,null==self.useColors&&(self.useColors=exports.useColors()),null==self.color&&self.useColors&&(self.color=selectColor());var args=Array.prototype.slice.call(arguments);args[0]=exports.coerce(args[0]),"string"!=typeof args[0]&&(args=["%o"].concat(args));var index=0;args[0]=args[0].replace(/%([a-z%])/g,function(match,format){if("%"===match)return match;index++;var formatter=exports.formatters[format];if("function"==typeof formatter){var val=args[index];match=formatter.call(self,val),args.splice(index,1),index--}return match}),"function"==typeof exports.formatArgs&&(args=exports.formatArgs.apply(self,args));var logFn=enabled.log||exports.log||void 0;logFn.apply(self,args)}disabled.enabled=!1,enabled.enabled=!0;var fn=exports.enabled(namespace)?enabled:disabled;return fn.namespace=namespace,fn}function enable(namespaces){exports.save(namespaces);for(var split=(namespaces||"").split(/[\s,]+/),len=split.length,i=0;len>i;i++)split[i]&&(namespaces=split[i].replace(/\*/g,".*?"),"-"===namespaces[0]?exports.skips.push(new RegExp("^"+namespaces.substr(1)+"$")):exports.names.push(new RegExp("^"+namespaces+"$")))}function disable(){exports.enable("")}function enabled(name){var i,len;for(i=0,len=exports.skips.length;len>i;i++)if(exports.skips[i].test(name))return!1;for(i=0,len=exports.names.length;len>i;i++)if(exports.names[i].test(name))return!0;return!1}function coerce(val){return val instanceof Error?val.stack||val.message:val}exports=module.exports=debug,exports.coerce=coerce,exports.disable=disable,exports.enable=enable,exports.enabled=enabled,exports.humanize=_dereq_("ms"),exports.names=[],exports.skips=[],exports.formatters={};var prevTime,prevColor=0},{ms:24}],24:[function(_dereq_,module,exports){function parse(str){var match=/^((?:\d+)?\.?\d+) *(ms|seconds?|s|minutes?|m|hours?|h|days?|d|years?|y)?$/i.exec(str);if(match){var n=parseFloat(match[1]),type=(match[2]||"ms").toLowerCase();switch(type){case"years":case"year":case"y":return n*y;case"days":case"day":case"d":return n*d;case"hours":case"hour":case"h":return n*h;case"minutes":case"minute":case"m":return n*m;case"seconds":case"second":case"s":return n*s;case"ms":return n}}}function short(ms){return ms>=d?Math.round(ms/d)+"d":ms>=h?Math.round(ms/h)+"h":ms>=m?Math.round(ms/m)+"m":ms>=s?Math.round(ms/s)+"s":ms+"ms"}function long(ms){return plural(ms,d,"day")||plural(ms,h,"hour")||plural(ms,m,"minute")||plural(ms,s,"second")||ms+" ms"}function plural(ms,n,name){return n>ms?void 0:1.5*n>ms?Math.floor(ms/n)+" "+name:Math.ceil(ms/n)+" "+name+"s"}var s=1e3,m=60*s,h=60*m,d=24*h,y=365.25*d;module.exports=function(val,options){return options=options||{},"string"==typeof val?parse(val):options["long"]?long(val):short(val)}},{}],25:[function(_dereq_,module,exports){(function(global){function encodeBase64Object(packet,callback){var message="b"+exports.packets[packet.type]+packet.data.data;return callback(message)}function encodeArrayBuffer(packet,supportsBinary,callback){if(!supportsBinary)return exports.encodeBase64Packet(packet,callback);var data=packet.data,contentArray=new Uint8Array(data),resultBuffer=new Uint8Array(1+data.byteLength);resultBuffer[0]=packets[packet.type];for(var i=0;i<contentArray.length;i++)resultBuffer[i+1]=contentArray[i];return callback(resultBuffer.buffer)}function encodeBlobAsArrayBuffer(packet,supportsBinary,callback){if(!supportsBinary)return exports.encodeBase64Packet(packet,callback);var fr=new FileReader;return fr.onload=function(){packet.data=fr.result,exports.encodePacket(packet,supportsBinary,!0,callback)},fr.readAsArrayBuffer(packet.data)}function encodeBlob(packet,supportsBinary,callback){if(!supportsBinary)return exports.encodeBase64Packet(packet,callback);if(dontSendBlobs)return encodeBlobAsArrayBuffer(packet,supportsBinary,callback);var length=new Uint8Array(1);length[0]=packets[packet.type];var blob=new Blob([length.buffer,packet.data]);return callback(blob)}function map(ary,each,done){for(var result=new Array(ary.length),next=after(ary.length,done),eachWithIndex=function(i,el,cb){each(el,function(error,msg){result[i]=msg,cb(error,result)})},i=0;i<ary.length;i++)eachWithIndex(i,ary[i],next)}var keys=_dereq_("./keys"),hasBinary=_dereq_("has-binary"),sliceBuffer=_dereq_("arraybuffer.slice"),base64encoder=_dereq_("base64-arraybuffer"),after=_dereq_("after"),utf8=_dereq_("utf8"),isAndroid=navigator.userAgent.match(/Android/i),isPhantomJS=/PhantomJS/i.test(navigator.userAgent),dontSendBlobs=isAndroid||isPhantomJS;exports.protocol=3;var packets=exports.packets={open:0,close:1,ping:2,pong:3,message:4,upgrade:5,noop:6},packetslist=keys(packets),err={type:"error",data:"parser error"},Blob=_dereq_("blob");exports.encodePacket=function(packet,supportsBinary,utf8encode,callback){"function"==typeof supportsBinary&&(callback=supportsBinary,supportsBinary=!1),"function"==typeof utf8encode&&(callback=utf8encode,utf8encode=null);var data=void 0===packet.data?void 0:packet.data.buffer||packet.data;if(global.ArrayBuffer&&data instanceof ArrayBuffer)return encodeArrayBuffer(packet,supportsBinary,callback);if(Blob&&data instanceof global.Blob)return encodeBlob(packet,supportsBinary,callback);if(data&&data.base64)return encodeBase64Object(packet,callback);var encoded=packets[packet.type];return void 0!==packet.data&&(encoded+=utf8encode?utf8.encode(String(packet.data)):String(packet.data)),callback(""+encoded)},exports.encodeBase64Packet=function(packet,callback){var message="b"+exports.packets[packet.type];if(Blob&&packet.data instanceof Blob){var fr=new FileReader;return fr.onload=function(){var b64=fr.result.split(",")[1];callback(message+b64)},fr.readAsDataURL(packet.data)}var b64data;try{b64data=String.fromCharCode.apply(null,new Uint8Array(packet.data))}catch(e){for(var typed=new Uint8Array(packet.data),basic=new Array(typed.length),i=0;i<typed.length;i++)basic[i]=typed[i];b64data=String.fromCharCode.apply(null,basic)}return message+=global.btoa(b64data),callback(message)},exports.decodePacket=function(data,binaryType,utf8decode){if("string"==typeof data||void 0===data){if("b"==data.charAt(0))return exports.decodeBase64Packet(data.substr(1),binaryType);if(utf8decode)try{data=utf8.decode(data)}catch(e){return err}var type=data.charAt(0);return Number(type)==type&&packetslist[type]?data.length>1?{type:packetslist[type],data:data.substring(1)}:{type:packetslist[type]}:err}var asArray=new Uint8Array(data),type=asArray[0],rest=sliceBuffer(data,1);return Blob&&"blob"===binaryType&&(rest=new Blob([rest])),{type:packetslist[type],data:rest}},exports.decodeBase64Packet=function(msg,binaryType){var type=packetslist[msg.charAt(0)];if(!global.ArrayBuffer)return{type:type,data:{base64:!0,data:msg.substr(1)}};var data=base64encoder.decode(msg.substr(1));return"blob"===binaryType&&Blob&&(data=new Blob([data])),{type:type,data:data}},exports.encodePayload=function(packets,supportsBinary,callback){function setLengthHeader(message){return message.length+":"+message}function encodeOne(packet,doneCallback){exports.encodePacket(packet,isBinary?supportsBinary:!1,!0,function(message){doneCallback(null,setLengthHeader(message))})}"function"==typeof supportsBinary&&(callback=supportsBinary,supportsBinary=null);var isBinary=hasBinary(packets);return supportsBinary&&isBinary?Blob&&!dontSendBlobs?exports.encodePayloadAsBlob(packets,callback):exports.encodePayloadAsArrayBuffer(packets,callback):packets.length?void map(packets,encodeOne,function(err,results){return callback(results.join(""))}):callback("0:")},exports.decodePayload=function(data,binaryType,callback){if("string"!=typeof data)return exports.decodePayloadAsBinary(data,binaryType,callback);"function"==typeof binaryType&&(callback=binaryType,binaryType=null);var packet;if(""==data)return callback(err,0,1);for(var n,msg,length="",i=0,l=data.length;l>i;i++){var chr=data.charAt(i);if(":"!=chr)length+=chr;else{if(""==length||length!=(n=Number(length)))return callback(err,0,1);if(msg=data.substr(i+1,n),length!=msg.length)return callback(err,0,1);if(msg.length){if(packet=exports.decodePacket(msg,binaryType,!0),err.type==packet.type&&err.data==packet.data)return callback(err,0,1);var ret=callback(packet,i+n,l);if(!1===ret)return}i+=n,length=""}}return""!=length?callback(err,0,1):void 0},exports.encodePayloadAsArrayBuffer=function(packets,callback){function encodeOne(packet,doneCallback){exports.encodePacket(packet,!0,!0,function(data){return doneCallback(null,data)})}return packets.length?void map(packets,encodeOne,function(err,encodedPackets){var totalLength=encodedPackets.reduce(function(acc,p){var len;return len="string"==typeof p?p.length:p.byteLength,acc+len.toString().length+len+2},0),resultArray=new Uint8Array(totalLength),bufferIndex=0;return encodedPackets.forEach(function(p){var isString="string"==typeof p,ab=p;if(isString){for(var view=new Uint8Array(p.length),i=0;i<p.length;i++)view[i]=p.charCodeAt(i);ab=view.buffer}isString?resultArray[bufferIndex++]=0:resultArray[bufferIndex++]=1;for(var lenStr=ab.byteLength.toString(),i=0;i<lenStr.length;i++)resultArray[bufferIndex++]=parseInt(lenStr[i]);resultArray[bufferIndex++]=255;for(var view=new Uint8Array(ab),i=0;i<view.length;i++)resultArray[bufferIndex++]=view[i]}),callback(resultArray.buffer)}):callback(new ArrayBuffer(0))},exports.encodePayloadAsBlob=function(packets,callback){function encodeOne(packet,doneCallback){exports.encodePacket(packet,!0,!0,function(encoded){var binaryIdentifier=new Uint8Array(1);if(binaryIdentifier[0]=1,"string"==typeof encoded){for(var view=new Uint8Array(encoded.length),i=0;i<encoded.length;i++)view[i]=encoded.charCodeAt(i);encoded=view.buffer,binaryIdentifier[0]=0}for(var len=encoded instanceof ArrayBuffer?encoded.byteLength:encoded.size,lenStr=len.toString(),lengthAry=new Uint8Array(lenStr.length+1),i=0;i<lenStr.length;i++)lengthAry[i]=parseInt(lenStr[i]);if(lengthAry[lenStr.length]=255,Blob){var blob=new Blob([binaryIdentifier.buffer,lengthAry.buffer,encoded]);doneCallback(null,blob)}})}map(packets,encodeOne,function(err,results){return callback(new Blob(results))})},exports.decodePayloadAsBinary=function(data,binaryType,callback){"function"==typeof binaryType&&(callback=binaryType,binaryType=null);for(var bufferTail=data,buffers=[],numberTooLong=!1;bufferTail.byteLength>0;){for(var tailArray=new Uint8Array(bufferTail),isString=0===tailArray[0],msgLength="",i=1;255!=tailArray[i];i++){if(msgLength.length>310){numberTooLong=!0;break}msgLength+=tailArray[i]}if(numberTooLong)return callback(err,0,1);bufferTail=sliceBuffer(bufferTail,2+msgLength.length),msgLength=parseInt(msgLength);var msg=sliceBuffer(bufferTail,0,msgLength);if(isString)try{msg=String.fromCharCode.apply(null,new Uint8Array(msg))}catch(e){var typed=new Uint8Array(msg);msg="";for(var i=0;i<typed.length;i++)msg+=String.fromCharCode(typed[i])}buffers.push(msg),bufferTail=sliceBuffer(bufferTail,msgLength)}var total=buffers.length;buffers.forEach(function(buffer,i){callback(exports.decodePacket(buffer,binaryType,!0),i,total)})}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./keys":26,after:27,"arraybuffer.slice":28,"base64-arraybuffer":29,blob:30,"has-binary":31,utf8:33}],26:[function(_dereq_,module,exports){module.exports=Object.keys||function(obj){var arr=[],has=Object.prototype.hasOwnProperty;for(var i in obj)has.call(obj,i)&&arr.push(i);return arr}},{}],27:[function(_dereq_,module,exports){function after(count,callback,err_cb){function proxy(err,result){if(proxy.count<=0)throw new Error("after called too many times");--proxy.count,err?(bail=!0,callback(err),callback=err_cb):0!==proxy.count||bail||callback(null,result)}var bail=!1;return err_cb=err_cb||noop,proxy.count=count,0===count?callback():proxy}function noop(){}module.exports=after},{}],28:[function(_dereq_,module,exports){module.exports=function(arraybuffer,start,end){var bytes=arraybuffer.byteLength;if(start=start||0,end=end||bytes,arraybuffer.slice)return arraybuffer.slice(start,end);if(0>start&&(start+=bytes),0>end&&(end+=bytes),end>bytes&&(end=bytes),start>=bytes||start>=end||0===bytes)return new ArrayBuffer(0);for(var abv=new Uint8Array(arraybuffer),result=new Uint8Array(end-start),i=start,ii=0;end>i;i++,ii++)result[ii]=abv[i];return result.buffer}},{}],29:[function(_dereq_,module,exports){!function(chars){"use strict";exports.encode=function(arraybuffer){var i,bytes=new Uint8Array(arraybuffer),len=bytes.length,base64="";for(i=0;len>i;i+=3)base64+=chars[bytes[i]>>2],base64+=chars[(3&bytes[i])<<4|bytes[i+1]>>4],base64+=chars[(15&bytes[i+1])<<2|bytes[i+2]>>6],base64+=chars[63&bytes[i+2]];return len%3===2?base64=base64.substring(0,base64.length-1)+"=":len%3===1&&(base64=base64.substring(0,base64.length-2)+"=="),base64},exports.decode=function(base64){var i,encoded1,encoded2,encoded3,encoded4,bufferLength=.75*base64.length,len=base64.length,p=0;"="===base64[base64.length-1]&&(bufferLength--,"="===base64[base64.length-2]&&bufferLength--);var arraybuffer=new ArrayBuffer(bufferLength),bytes=new Uint8Array(arraybuffer);for(i=0;len>i;i+=4)encoded1=chars.indexOf(base64[i]),encoded2=chars.indexOf(base64[i+1]),encoded3=chars.indexOf(base64[i+2]),encoded4=chars.indexOf(base64[i+3]),bytes[p++]=encoded1<<2|encoded2>>4,bytes[p++]=(15&encoded2)<<4|encoded3>>2,bytes[p++]=(3&encoded3)<<6|63&encoded4;return arraybuffer}}("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/")},{}],30:[function(_dereq_,module,exports){(function(global){function BlobBuilderConstructor(ary,options){options=options||{};for(var bb=new BlobBuilder,i=0;i<ary.length;i++)bb.append(ary[i]);return options.type?bb.getBlob(options.type):bb.getBlob()}var BlobBuilder=global.BlobBuilder||global.WebKitBlobBuilder||global.MSBlobBuilder||global.MozBlobBuilder,blobSupported=function(){try{var b=new Blob(["hi"]);return 2==b.size}catch(e){return!1}}(),blobBuilderSupported=BlobBuilder&&BlobBuilder.prototype.append&&BlobBuilder.prototype.getBlob;module.exports=function(){return blobSupported?global.Blob:blobBuilderSupported?BlobBuilderConstructor:void 0}()}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],31:[function(_dereq_,module,exports){(function(global){function hasBinary(data){function _hasBinary(obj){if(!obj)return!1;if(global.Buffer&&global.Buffer.isBuffer(obj)||global.ArrayBuffer&&obj instanceof ArrayBuffer||global.Blob&&obj instanceof Blob||global.File&&obj instanceof File)return!0;if(isArray(obj)){for(var i=0;i<obj.length;i++)if(_hasBinary(obj[i]))return!0}else if(obj&&"object"==typeof obj){obj.toJSON&&(obj=obj.toJSON());for(var key in obj)if(obj.hasOwnProperty(key)&&_hasBinary(obj[key]))return!0}return!1}return _hasBinary(data)}var isArray=_dereq_("isarray");module.exports=hasBinary}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{isarray:32}],32:[function(_dereq_,module,exports){module.exports=Array.isArray||function(arr){return"[object Array]"==Object.prototype.toString.call(arr)}},{}],33:[function(_dereq_,module,exports){(function(global){!function(root){function ucs2decode(string){for(var value,extra,output=[],counter=0,length=string.length;length>counter;)value=string.charCodeAt(counter++),value>=55296&&56319>=value&&length>counter?(extra=string.charCodeAt(counter++),56320==(64512&extra)?output.push(((1023&value)<<10)+(1023&extra)+65536):(output.push(value),counter--)):output.push(value);return output}function ucs2encode(array){for(var value,length=array.length,index=-1,output="";++index<length;)value=array[index],value>65535&&(value-=65536,output+=stringFromCharCode(value>>>10&1023|55296),value=56320|1023&value),output+=stringFromCharCode(value);return output}function createByte(codePoint,shift){return stringFromCharCode(codePoint>>shift&63|128)}function encodeCodePoint(codePoint){if(0==(4294967168&codePoint))return stringFromCharCode(codePoint);var symbol="";return 0==(4294965248&codePoint)?symbol=stringFromCharCode(codePoint>>6&31|192):0==(4294901760&codePoint)?(symbol=stringFromCharCode(codePoint>>12&15|224),symbol+=createByte(codePoint,6)):0==(4292870144&codePoint)&&(symbol=stringFromCharCode(codePoint>>18&7|240),symbol+=createByte(codePoint,12),symbol+=createByte(codePoint,6)),symbol+=stringFromCharCode(63&codePoint|128)}function utf8encode(string){for(var codePoint,codePoints=ucs2decode(string),length=codePoints.length,index=-1,byteString="";++index<length;)codePoint=codePoints[index],byteString+=encodeCodePoint(codePoint);return byteString}function readContinuationByte(){if(byteIndex>=byteCount)throw Error("Invalid byte index");var continuationByte=255&byteArray[byteIndex];if(byteIndex++,128==(192&continuationByte))return 63&continuationByte;throw Error("Invalid continuation byte")}function decodeSymbol(){var byte1,byte2,byte3,byte4,codePoint;if(byteIndex>byteCount)throw Error("Invalid byte index");if(byteIndex==byteCount)return!1;if(byte1=255&byteArray[byteIndex],byteIndex++,0==(128&byte1))return byte1;if(192==(224&byte1)){var byte2=readContinuationByte();if(codePoint=(31&byte1)<<6|byte2,codePoint>=128)return codePoint;throw Error("Invalid continuation byte")}if(224==(240&byte1)){if(byte2=readContinuationByte(),byte3=readContinuationByte(),codePoint=(15&byte1)<<12|byte2<<6|byte3,codePoint>=2048)return codePoint;throw Error("Invalid continuation byte")}if(240==(248&byte1)&&(byte2=readContinuationByte(),byte3=readContinuationByte(),byte4=readContinuationByte(),codePoint=(15&byte1)<<18|byte2<<12|byte3<<6|byte4,codePoint>=65536&&1114111>=codePoint))return codePoint;throw Error("Invalid UTF-8 detected")}function utf8decode(byteString){byteArray=ucs2decode(byteString),byteCount=byteArray.length,byteIndex=0;for(var tmp,codePoints=[];(tmp=decodeSymbol())!==!1;)codePoints.push(tmp);return ucs2encode(codePoints)}var freeExports="object"==typeof exports&&exports,freeModule="object"==typeof module&&module&&module.exports==freeExports&&module,freeGlobal="object"==typeof global&&global;
(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal)&&(root=freeGlobal);var byteArray,byteCount,byteIndex,stringFromCharCode=String.fromCharCode,utf8={version:"2.0.0",encode:utf8encode,decode:utf8decode};if("function"==typeof define&&"object"==typeof define.amd&&define.amd)define(function(){return utf8});else if(freeExports&&!freeExports.nodeType)if(freeModule)freeModule.exports=utf8;else{var object={},hasOwnProperty=object.hasOwnProperty;for(var key in utf8)hasOwnProperty.call(utf8,key)&&(freeExports[key]=utf8[key])}else root.utf8=utf8}(this)}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],34:[function(_dereq_,module,exports){(function(global){var rvalidchars=/^[\],:{}\s]*$/,rvalidescape=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,rvalidtokens=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,rvalidbraces=/(?:^|:|,)(?:\s*\[)+/g,rtrimLeft=/^\s+/,rtrimRight=/\s+$/;module.exports=function(data){return"string"==typeof data&&data?(data=data.replace(rtrimLeft,"").replace(rtrimRight,""),global.JSON&&JSON.parse?JSON.parse(data):rvalidchars.test(data.replace(rvalidescape,"@").replace(rvalidtokens,"]").replace(rvalidbraces,""))?new Function("return "+data)():void 0):null}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],35:[function(_dereq_,module,exports){exports.encode=function(obj){var str="";for(var i in obj)obj.hasOwnProperty(i)&&(str.length&&(str+="&"),str+=encodeURIComponent(i)+"="+encodeURIComponent(obj[i]));return str},exports.decode=function(qs){for(var qry={},pairs=qs.split("&"),i=0,l=pairs.length;l>i;i++){var pair=pairs[i].split("=");qry[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])}return qry}},{}],36:[function(_dereq_,module,exports){var re=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];module.exports=function(str){var src=str,b=str.indexOf("["),e=str.indexOf("]");-1!=b&&-1!=e&&(str=str.substring(0,b)+str.substring(b,e).replace(/:/g,";")+str.substring(e,str.length));for(var m=re.exec(str||""),uri={},i=14;i--;)uri[parts[i]]=m[i]||"";return-1!=b&&-1!=e&&(uri.source=src,uri.host=uri.host.substring(1,uri.host.length-1).replace(/;/g,":"),uri.authority=uri.authority.replace("[","").replace("]","").replace(/;/g,":"),uri.ipv6uri=!0),uri}},{}],37:[function(_dereq_,module,exports){function ws(uri,protocols,opts){var instance;return instance=protocols?new WebSocket(uri,protocols):new WebSocket(uri)}var global=function(){return this}(),WebSocket=global.WebSocket||global.MozWebSocket;module.exports=WebSocket?ws:null,WebSocket&&(ws.prototype=WebSocket.prototype)},{}],38:[function(_dereq_,module,exports){(function(global){function hasBinary(data){function _hasBinary(obj){if(!obj)return!1;if(global.Buffer&&global.Buffer.isBuffer(obj)||global.ArrayBuffer&&obj instanceof ArrayBuffer||global.Blob&&obj instanceof Blob||global.File&&obj instanceof File)return!0;if(isArray(obj)){for(var i=0;i<obj.length;i++)if(_hasBinary(obj[i]))return!0}else if(obj&&"object"==typeof obj){obj.toJSON&&(obj=obj.toJSON());for(var key in obj)if(Object.prototype.hasOwnProperty.call(obj,key)&&_hasBinary(obj[key]))return!0}return!1}return _hasBinary(data)}var isArray=_dereq_("isarray");module.exports=hasBinary}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{isarray:39}],39:[function(_dereq_,module,exports){module.exports=_dereq_(32)},{}],40:[function(_dereq_,module,exports){var global=_dereq_("global");try{module.exports="XMLHttpRequest"in global&&"withCredentials"in new global.XMLHttpRequest}catch(err){module.exports=!1}},{global:41}],41:[function(_dereq_,module,exports){module.exports=function(){return this}()},{}],42:[function(_dereq_,module,exports){var indexOf=[].indexOf;module.exports=function(arr,obj){if(indexOf)return arr.indexOf(obj);for(var i=0;i<arr.length;++i)if(arr[i]===obj)return i;return-1}},{}],43:[function(_dereq_,module,exports){var has=Object.prototype.hasOwnProperty;exports.keys=Object.keys||function(obj){var keys=[];for(var key in obj)has.call(obj,key)&&keys.push(key);return keys},exports.values=function(obj){var vals=[];for(var key in obj)has.call(obj,key)&&vals.push(obj[key]);return vals},exports.merge=function(a,b){for(var key in b)has.call(b,key)&&(a[key]=b[key]);return a},exports.length=function(obj){return exports.keys(obj).length},exports.isEmpty=function(obj){return 0==exports.length(obj)}},{}],44:[function(_dereq_,module,exports){var re=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];module.exports=function(str){for(var m=re.exec(str||""),uri={},i=14;i--;)uri[parts[i]]=m[i]||"";return uri}},{}],45:[function(_dereq_,module,exports){(function(global){var isArray=_dereq_("isarray"),isBuf=_dereq_("./is-buffer");exports.deconstructPacket=function(packet){function _deconstructPacket(data){if(!data)return data;if(isBuf(data)){var placeholder={_placeholder:!0,num:buffers.length};return buffers.push(data),placeholder}if(isArray(data)){for(var newData=new Array(data.length),i=0;i<data.length;i++)newData[i]=_deconstructPacket(data[i]);return newData}if("object"==typeof data&&!(data instanceof Date)){var newData={};for(var key in data)newData[key]=_deconstructPacket(data[key]);return newData}return data}var buffers=[],packetData=packet.data,pack=packet;return pack.data=_deconstructPacket(packetData),pack.attachments=buffers.length,{packet:pack,buffers:buffers}},exports.reconstructPacket=function(packet,buffers){function _reconstructPacket(data){if(data&&data._placeholder){var buf=buffers[data.num];return buf}if(isArray(data)){for(var i=0;i<data.length;i++)data[i]=_reconstructPacket(data[i]);return data}if(data&&"object"==typeof data){for(var key in data)data[key]=_reconstructPacket(data[key]);return data}return data}return packet.data=_reconstructPacket(packet.data),packet.attachments=void 0,packet},exports.removeBlobs=function(data,callback){function _removeBlobs(obj,curKey,containingObject){if(!obj)return obj;if(global.Blob&&obj instanceof Blob||global.File&&obj instanceof File){pendingBlobs++;var fileReader=new FileReader;fileReader.onload=function(){containingObject?containingObject[curKey]=this.result:bloblessData=this.result,--pendingBlobs||callback(bloblessData)},fileReader.readAsArrayBuffer(obj)}else if(isArray(obj))for(var i=0;i<obj.length;i++)_removeBlobs(obj[i],i,obj);else if(obj&&"object"==typeof obj&&!isBuf(obj))for(var key in obj)_removeBlobs(obj[key],key,obj)}var pendingBlobs=0,bloblessData=data;_removeBlobs(bloblessData),pendingBlobs||callback(bloblessData)}}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./is-buffer":47,isarray:48}],46:[function(_dereq_,module,exports){function Encoder(){}function encodeAsString(obj){var str="",nsp=!1;return str+=obj.type,(exports.BINARY_EVENT==obj.type||exports.BINARY_ACK==obj.type)&&(str+=obj.attachments,str+="-"),obj.nsp&&"/"!=obj.nsp&&(nsp=!0,str+=obj.nsp),null!=obj.id&&(nsp&&(str+=",",nsp=!1),str+=obj.id),null!=obj.data&&(nsp&&(str+=","),str+=json.stringify(obj.data)),debug("encoded %j as %s",obj,str),str}function encodeAsBinary(obj,callback){function writeEncoding(bloblessData){var deconstruction=binary.deconstructPacket(bloblessData),pack=encodeAsString(deconstruction.packet),buffers=deconstruction.buffers;buffers.unshift(pack),callback(buffers)}binary.removeBlobs(obj,writeEncoding)}function Decoder(){this.reconstructor=null}function decodeString(str){var p={},i=0;if(p.type=Number(str.charAt(0)),null==exports.types[p.type])return error();if(exports.BINARY_EVENT==p.type||exports.BINARY_ACK==p.type){for(var buf="";"-"!=str.charAt(++i)&&(buf+=str.charAt(i),i!=str.length););if(buf!=Number(buf)||"-"!=str.charAt(i))throw new Error("Illegal attachments");p.attachments=Number(buf)}if("/"==str.charAt(i+1))for(p.nsp="";++i;){var c=str.charAt(i);if(","==c)break;if(p.nsp+=c,i==str.length)break}else p.nsp="/";var next=str.charAt(i+1);if(""!==next&&Number(next)==next){for(p.id="";++i;){var c=str.charAt(i);if(null==c||Number(c)!=c){--i;break}if(p.id+=str.charAt(i),i==str.length)break}p.id=Number(p.id)}if(str.charAt(++i))try{p.data=json.parse(str.substr(i))}catch(e){return error()}return debug("decoded %s as %j",str,p),p}function BinaryReconstructor(packet){this.reconPack=packet,this.buffers=[]}function error(data){return{type:exports.ERROR,data:"parser error"}}var debug=_dereq_("debug")("socket.io-parser"),json=_dereq_("json3"),Emitter=(_dereq_("isarray"),_dereq_("component-emitter")),binary=_dereq_("./binary"),isBuf=_dereq_("./is-buffer");exports.protocol=4,exports.types=["CONNECT","DISCONNECT","EVENT","BINARY_EVENT","ACK","BINARY_ACK","ERROR"],exports.CONNECT=0,exports.DISCONNECT=1,exports.EVENT=2,exports.ACK=3,exports.ERROR=4,exports.BINARY_EVENT=5,exports.BINARY_ACK=6,exports.Encoder=Encoder,exports.Decoder=Decoder,Encoder.prototype.encode=function(obj,callback){if(debug("encoding packet %j",obj),exports.BINARY_EVENT==obj.type||exports.BINARY_ACK==obj.type)encodeAsBinary(obj,callback);else{var encoding=encodeAsString(obj);callback([encoding])}},Emitter(Decoder.prototype),Decoder.prototype.add=function(obj){var packet;if("string"==typeof obj)packet=decodeString(obj),exports.BINARY_EVENT==packet.type||exports.BINARY_ACK==packet.type?(this.reconstructor=new BinaryReconstructor(packet),0===this.reconstructor.reconPack.attachments&&this.emit("decoded",packet)):this.emit("decoded",packet);else{if(!isBuf(obj)&&!obj.base64)throw new Error("Unknown type: "+obj);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");packet=this.reconstructor.takeBinaryData(obj),packet&&(this.reconstructor=null,this.emit("decoded",packet))}},Decoder.prototype.destroy=function(){this.reconstructor&&this.reconstructor.finishedReconstruction()},BinaryReconstructor.prototype.takeBinaryData=function(binData){if(this.buffers.push(binData),this.buffers.length==this.reconPack.attachments){var packet=binary.reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),packet}return null},BinaryReconstructor.prototype.finishedReconstruction=function(){this.reconPack=null,this.buffers=[]}},{"./binary":45,"./is-buffer":47,"component-emitter":9,debug:10,isarray:48,json3:49}],47:[function(_dereq_,module,exports){(function(global){function isBuf(obj){return global.Buffer&&global.Buffer.isBuffer(obj)||global.ArrayBuffer&&obj instanceof ArrayBuffer}module.exports=isBuf}).call(this,"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],48:[function(_dereq_,module,exports){module.exports=_dereq_(32)},{}],49:[function(_dereq_,module,exports){!function(window){function has(name){if(has[name]!==undef)return has[name];var isSupported;if("bug-string-char-index"==name)isSupported="a"!="a"[0];else if("json"==name)isSupported=has("json-stringify")&&has("json-parse");else{var value,serialized='{"a":[1,true,false,null,"\\u0000\\b\\n\\f\\r\\t"]}';if("json-stringify"==name){var stringify=JSON3.stringify,stringifySupported="function"==typeof stringify&&isExtended;if(stringifySupported){(value=function(){return 1}).toJSON=value;try{stringifySupported="0"===stringify(0)&&"0"===stringify(new Number)&&'""'==stringify(new String)&&stringify(getClass)===undef&&stringify(undef)===undef&&stringify()===undef&&"1"===stringify(value)&&"[1]"==stringify([value])&&"[null]"==stringify([undef])&&"null"==stringify(null)&&"[null,null,null]"==stringify([undef,getClass,null])&&stringify({a:[value,!0,!1,null,"\x00\b\n\f\r	"]})==serialized&&"1"===stringify(null,value)&&"[\n 1,\n 2\n]"==stringify([1,2],null,1)&&'"-271821-04-20T00:00:00.000Z"'==stringify(new Date(-864e13))&&'"+275760-09-13T00:00:00.000Z"'==stringify(new Date(864e13))&&'"-000001-01-01T00:00:00.000Z"'==stringify(new Date(-621987552e5))&&'"1969-12-31T23:59:59.999Z"'==stringify(new Date(-1))}catch(exception){stringifySupported=!1}}isSupported=stringifySupported}if("json-parse"==name){var parse=JSON3.parse;if("function"==typeof parse)try{if(0===parse("0")&&!parse(!1)){value=parse(serialized);var parseSupported=5==value.a.length&&1===value.a[0];if(parseSupported){try{parseSupported=!parse('"	"')}catch(exception){}if(parseSupported)try{parseSupported=1!==parse("01")}catch(exception){}if(parseSupported)try{parseSupported=1!==parse("1.")}catch(exception){}}}}catch(exception){parseSupported=!1}isSupported=parseSupported}}return has[name]=!!isSupported}var isProperty,forEach,undef,getClass={}.toString,isLoader="function"==typeof define&&define.amd,nativeJSON="object"==typeof JSON&&JSON,JSON3="object"==typeof exports&&exports&&!exports.nodeType&&exports;JSON3&&nativeJSON?(JSON3.stringify=nativeJSON.stringify,JSON3.parse=nativeJSON.parse):JSON3=window.JSON=nativeJSON||{};var isExtended=new Date(-0xc782b5b800cec);try{isExtended=-109252==isExtended.getUTCFullYear()&&0===isExtended.getUTCMonth()&&1===isExtended.getUTCDate()&&10==isExtended.getUTCHours()&&37==isExtended.getUTCMinutes()&&6==isExtended.getUTCSeconds()&&708==isExtended.getUTCMilliseconds()}catch(exception){}if(!has("json")){var functionClass="[object Function]",dateClass="[object Date]",numberClass="[object Number]",stringClass="[object String]",arrayClass="[object Array]",booleanClass="[object Boolean]",charIndexBuggy=has("bug-string-char-index");if(!isExtended)var floor=Math.floor,Months=[0,31,59,90,120,151,181,212,243,273,304,334],getDay=function(year,month){return Months[month]+365*(year-1970)+floor((year-1969+(month=+(month>1)))/4)-floor((year-1901+month)/100)+floor((year-1601+month)/400)};(isProperty={}.hasOwnProperty)||(isProperty=function(property){var constructor,members={};return(members.__proto__=null,members.__proto__={toString:1},members).toString!=getClass?isProperty=function(property){var original=this.__proto__,result=property in(this.__proto__=null,this);return this.__proto__=original,result}:(constructor=members.constructor,isProperty=function(property){var parent=(this.constructor||constructor).prototype;return property in this&&!(property in parent&&this[property]===parent[property])}),members=null,isProperty.call(this,property)});var PrimitiveTypes={"boolean":1,number:1,string:1,undefined:1},isHostType=function(object,property){var type=typeof object[property];return"object"==type?!!object[property]:!PrimitiveTypes[type]};if(forEach=function(object,callback){var Properties,members,property,size=0;(Properties=function(){this.valueOf=0}).prototype.valueOf=0,members=new Properties;for(property in members)isProperty.call(members,property)&&size++;return Properties=members=null,size?forEach=2==size?function(object,callback){var property,members={},isFunction=getClass.call(object)==functionClass;for(property in object)isFunction&&"prototype"==property||isProperty.call(members,property)||!(members[property]=1)||!isProperty.call(object,property)||callback(property)}:function(object,callback){var property,isConstructor,isFunction=getClass.call(object)==functionClass;for(property in object)isFunction&&"prototype"==property||!isProperty.call(object,property)||(isConstructor="constructor"===property)||callback(property);(isConstructor||isProperty.call(object,property="constructor"))&&callback(property)}:(members=["valueOf","toString","toLocaleString","propertyIsEnumerable","isPrototypeOf","hasOwnProperty","constructor"],forEach=function(object,callback){var property,length,isFunction=getClass.call(object)==functionClass,hasProperty=!isFunction&&"function"!=typeof object.constructor&&isHostType(object,"hasOwnProperty")?object.hasOwnProperty:isProperty;for(property in object)isFunction&&"prototype"==property||!hasProperty.call(object,property)||callback(property);for(length=members.length;property=members[--length];hasProperty.call(object,property)&&callback(property));}),forEach(object,callback)},!has("json-stringify")){var Escapes={92:"\\\\",34:'\\"',8:"\\b",12:"\\f",10:"\\n",13:"\\r",9:"\\t"},leadingZeroes="000000",toPaddedString=function(width,value){return(leadingZeroes+(value||0)).slice(-width)},unicodePrefix="\\u00",quote=function(value){var symbols,result='"',index=0,length=value.length,isLarge=length>10&&charIndexBuggy;for(isLarge&&(symbols=value.split(""));length>index;index++){var charCode=value.charCodeAt(index);switch(charCode){case 8:case 9:case 10:case 12:case 13:case 34:case 92:result+=Escapes[charCode];break;default:if(32>charCode){result+=unicodePrefix+toPaddedString(2,charCode.toString(16));break}result+=isLarge?symbols[index]:charIndexBuggy?value.charAt(index):value[index]}}return result+'"'},serialize=function(property,object,callback,properties,whitespace,indentation,stack){var value,className,year,month,date,time,hours,minutes,seconds,milliseconds,results,element,index,length,prefix,result;try{value=object[property]}catch(exception){}if("object"==typeof value&&value)if(className=getClass.call(value),className!=dateClass||isProperty.call(value,"toJSON"))"function"==typeof value.toJSON&&(className!=numberClass&&className!=stringClass&&className!=arrayClass||isProperty.call(value,"toJSON"))&&(value=value.toJSON(property));else if(value>-1/0&&1/0>value){if(getDay){for(date=floor(value/864e5),year=floor(date/365.2425)+1970-1;getDay(year+1,0)<=date;year++);for(month=floor((date-getDay(year,0))/30.42);getDay(year,month+1)<=date;month++);date=1+date-getDay(year,month),time=(value%864e5+864e5)%864e5,hours=floor(time/36e5)%24,minutes=floor(time/6e4)%60,seconds=floor(time/1e3)%60,milliseconds=time%1e3}else year=value.getUTCFullYear(),month=value.getUTCMonth(),date=value.getUTCDate(),hours=value.getUTCHours(),minutes=value.getUTCMinutes(),seconds=value.getUTCSeconds(),milliseconds=value.getUTCMilliseconds();value=(0>=year||year>=1e4?(0>year?"-":"+")+toPaddedString(6,0>year?-year:year):toPaddedString(4,year))+"-"+toPaddedString(2,month+1)+"-"+toPaddedString(2,date)+"T"+toPaddedString(2,hours)+":"+toPaddedString(2,minutes)+":"+toPaddedString(2,seconds)+"."+toPaddedString(3,milliseconds)+"Z"}else value=null;if(callback&&(value=callback.call(object,property,value)),null===value)return"null";if(className=getClass.call(value),className==booleanClass)return""+value;if(className==numberClass)return value>-1/0&&1/0>value?""+value:"null";if(className==stringClass)return quote(""+value);if("object"==typeof value){for(length=stack.length;length--;)if(stack[length]===value)throw TypeError();if(stack.push(value),results=[],prefix=indentation,indentation+=whitespace,className==arrayClass){for(index=0,length=value.length;length>index;index++)element=serialize(index,value,callback,properties,whitespace,indentation,stack),results.push(element===undef?"null":element);result=results.length?whitespace?"[\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"]":"["+results.join(",")+"]":"[]"}else forEach(properties||value,function(property){var element=serialize(property,value,callback,properties,whitespace,indentation,stack);element!==undef&&results.push(quote(property)+":"+(whitespace?" ":"")+element)}),result=results.length?whitespace?"{\n"+indentation+results.join(",\n"+indentation)+"\n"+prefix+"}":"{"+results.join(",")+"}":"{}";return stack.pop(),result}};JSON3.stringify=function(source,filter,width){var whitespace,callback,properties,className;if("function"==typeof filter||"object"==typeof filter&&filter)if((className=getClass.call(filter))==functionClass)callback=filter;else if(className==arrayClass){properties={};for(var value,index=0,length=filter.length;length>index;value=filter[index++],className=getClass.call(value),(className==stringClass||className==numberClass)&&(properties[value]=1));}if(width)if((className=getClass.call(width))==numberClass){if((width-=width%1)>0)for(whitespace="",width>10&&(width=10);whitespace.length<width;whitespace+=" ");}else className==stringClass&&(whitespace=width.length<=10?width:width.slice(0,10));return serialize("",(value={},value[""]=source,value),callback,properties,whitespace,"",[])}}if(!has("json-parse")){var Index,Source,fromCharCode=String.fromCharCode,Unescapes={92:"\\",34:'"',47:"/",98:"\b",116:"	",110:"\n",102:"\f",114:"\r"},abort=function(){throw Index=Source=null,SyntaxError()},lex=function(){for(var value,begin,position,isSigned,charCode,source=Source,length=source.length;length>Index;)switch(charCode=source.charCodeAt(Index)){case 9:case 10:case 13:case 32:Index++;break;case 123:case 125:case 91:case 93:case 58:case 44:return value=charIndexBuggy?source.charAt(Index):source[Index],Index++,value;case 34:for(value="@",Index++;length>Index;)if(charCode=source.charCodeAt(Index),32>charCode)abort();else if(92==charCode)switch(charCode=source.charCodeAt(++Index)){case 92:case 34:case 47:case 98:case 116:case 110:case 102:case 114:value+=Unescapes[charCode],Index++;break;case 117:for(begin=++Index,position=Index+4;position>Index;Index++)charCode=source.charCodeAt(Index),charCode>=48&&57>=charCode||charCode>=97&&102>=charCode||charCode>=65&&70>=charCode||abort();value+=fromCharCode("0x"+source.slice(begin,Index));break;default:abort()}else{if(34==charCode)break;for(charCode=source.charCodeAt(Index),begin=Index;charCode>=32&&92!=charCode&&34!=charCode;)charCode=source.charCodeAt(++Index);value+=source.slice(begin,Index)}if(34==source.charCodeAt(Index))return Index++,value;abort();default:if(begin=Index,45==charCode&&(isSigned=!0,charCode=source.charCodeAt(++Index)),charCode>=48&&57>=charCode){for(48==charCode&&(charCode=source.charCodeAt(Index+1),charCode>=48&&57>=charCode)&&abort(),isSigned=!1;length>Index&&(charCode=source.charCodeAt(Index),charCode>=48&&57>=charCode);Index++);if(46==source.charCodeAt(Index)){for(position=++Index;length>position&&(charCode=source.charCodeAt(position),charCode>=48&&57>=charCode);position++);position==Index&&abort(),Index=position}if(charCode=source.charCodeAt(Index),101==charCode||69==charCode){for(charCode=source.charCodeAt(++Index),(43==charCode||45==charCode)&&Index++,position=Index;length>position&&(charCode=source.charCodeAt(position),charCode>=48&&57>=charCode);position++);position==Index&&abort(),Index=position}return+source.slice(begin,Index)}if(isSigned&&abort(),"true"==source.slice(Index,Index+4))return Index+=4,!0;if("false"==source.slice(Index,Index+5))return Index+=5,!1;if("null"==source.slice(Index,Index+4))return Index+=4,null;abort()}return"$"},get=function(value){var results,hasMembers;if("$"==value&&abort(),"string"==typeof value){if("@"==(charIndexBuggy?value.charAt(0):value[0]))return value.slice(1);if("["==value){for(results=[];value=lex(),"]"!=value;hasMembers||(hasMembers=!0))hasMembers&&(","==value?(value=lex(),"]"==value&&abort()):abort()),","==value&&abort(),results.push(get(value));return results}if("{"==value){for(results={};value=lex(),"}"!=value;hasMembers||(hasMembers=!0))hasMembers&&(","==value?(value=lex(),"}"==value&&abort()):abort()),(","==value||"string"!=typeof value||"@"!=(charIndexBuggy?value.charAt(0):value[0])||":"!=lex())&&abort(),results[value.slice(1)]=get(lex());return results}abort()}return value},update=function(source,property,callback){var element=walk(source,property,callback);element===undef?delete source[property]:source[property]=element},walk=function(source,property,callback){var length,value=source[property];if("object"==typeof value&&value)if(getClass.call(value)==arrayClass)for(length=value.length;length--;)update(value,length,callback);else forEach(value,function(property){update(value,property,callback)});return callback.call(source,property,value)};JSON3.parse=function(source,callback){var result,value;return Index=0,Source=""+source,result=get(lex()),"$"!=lex()&&abort(),Index=Source=null,callback&&getClass.call(callback)==functionClass?walk((value={},value[""]=result,value),"",callback):result}}}isLoader&&define(function(){return JSON3})}(this)},{}],50:[function(_dereq_,module,exports){function toArray(list,index){var array=[];index=index||0;for(var i=index||0;i<list.length;i++)array[i-index]=list[i];return array}module.exports=toArray},{}]},{},[1])(1)});var AdapterJS=AdapterJS||{};if("undefined"!=typeof exports&&(module.exports=AdapterJS),AdapterJS.options=AdapterJS.options||{},AdapterJS.VERSION="0.12.2",AdapterJS.onwebrtcready=AdapterJS.onwebrtcready||function(isUsingPlugin){},AdapterJS.webRTCReady=function(callback){if("function"!=typeof callback)throw new Error("Callback provided is not a function");!0===AdapterJS.onwebrtcreadyDone?callback(null!==AdapterJS.WebRTCPlugin.plugin):AdapterJS.onwebrtcready=callback},AdapterJS.WebRTCPlugin=AdapterJS.WebRTCPlugin||{},AdapterJS.WebRTCPlugin.pluginInfo={prefix:"Tem",plugName:"TemWebRTCPlugin",pluginId:"plugin0",type:"application/x-temwebrtcplugin",onload:"__TemWebRTCReady0",portalLink:"http://skylink.io/plugin/",downloadLink:null,companyName:"Temasys"},navigator.platform.match(/^Mac/i)?AdapterJS.WebRTCPlugin.pluginInfo.downloadLink="http://bit.ly/1n77hco":navigator.platform.match(/^Win/i)&&(AdapterJS.WebRTCPlugin.pluginInfo.downloadLink="http://bit.ly/1kkS4FN"),AdapterJS.WebRTCPlugin.TAGS={NONE:"none",AUDIO:"audio",VIDEO:"video"},AdapterJS.WebRTCPlugin.pageId=Math.random().toString(36).slice(2),AdapterJS.WebRTCPlugin.plugin=null,AdapterJS.WebRTCPlugin.setLogLevel=null,AdapterJS.WebRTCPlugin.defineWebRTCInterface=null,AdapterJS.WebRTCPlugin.isPluginInstalled=null,AdapterJS.WebRTCPlugin.pluginInjectionInterval=null,AdapterJS.WebRTCPlugin.injectPlugin=null,AdapterJS.WebRTCPlugin.PLUGIN_STATES={NONE:0,INITIALIZING:1,INJECTING:2,INJECTED:3,READY:4},AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.NONE,AdapterJS.onwebrtcreadyDone=!1,AdapterJS.WebRTCPlugin.PLUGIN_LOG_LEVELS={NONE:"NONE",ERROR:"ERROR",WARNING:"WARNING",INFO:"INFO",VERBOSE:"VERBOSE",SENSITIVE:"SENSITIVE"},AdapterJS.WebRTCPlugin.WaitForPluginReady=null,AdapterJS.WebRTCPlugin.callWhenPluginReady=null,__TemWebRTCReady0=function(){"complete"===document.readyState?(AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY,AdapterJS.maybeThroughWebRTCReady()):AdapterJS.WebRTCPlugin.documentReadyInterval=setInterval(function(){"complete"===document.readyState&&(clearInterval(AdapterJS.WebRTCPlugin.documentReadyInterval),AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY,AdapterJS.maybeThroughWebRTCReady())},100)},AdapterJS.maybeThroughWebRTCReady=function(){AdapterJS.onwebrtcreadyDone||(AdapterJS.onwebrtcreadyDone=!0,"function"==typeof AdapterJS.onwebrtcready&&AdapterJS.onwebrtcready(null!==AdapterJS.WebRTCPlugin.plugin))},AdapterJS.TEXT={PLUGIN:{REQUIRE_INSTALLATION:"This website requires you to install a WebRTC-enabling plugin to work on this browser.",NOT_SUPPORTED:"Your browser does not support WebRTC.",BUTTON:"Install Now"},REFRESH:{REQUIRE_REFRESH:"Please refresh page",BUTTON:"Refresh Page"}},AdapterJS._iceConnectionStates={starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"},AdapterJS._iceConnectionFiredStates=[],AdapterJS.isDefined=null,AdapterJS.parseWebrtcDetectedBrowser=function(){var hasMatch,checkMatch=navigator.userAgent.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(checkMatch[1])?(hasMatch=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],webrtcDetectedBrowser="IE",webrtcDetectedVersion=parseInt(hasMatch[1]||"0",10)):"Chrome"===checkMatch[1]&&(hasMatch=navigator.userAgent.match(/\bOPR\/(\d+)/),null!==hasMatch&&(webrtcDetectedBrowser="opera",webrtcDetectedVersion=parseInt(hasMatch[1],10))),navigator.userAgent.indexOf("Safari")&&("undefined"!=typeof InstallTrigger?webrtcDetectedBrowser="firefox":document.documentMode?webrtcDetectedBrowser="IE":Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0?webrtcDetectedBrowser="safari":window.opera||navigator.userAgent.indexOf(" OPR/")>=0?webrtcDetectedBrowser="opera":window.chrome&&(webrtcDetectedBrowser="chrome")),webrtcDetectedBrowser||(webrtcDetectedVersion=checkMatch[1]),!webrtcDetectedVersion)try{checkMatch=checkMatch[2]?[checkMatch[1],checkMatch[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(hasMatch=navigator.userAgent.match(/version\/(\d+)/i))&&checkMatch.splice(1,1,hasMatch[1]),webrtcDetectedVersion=parseInt(checkMatch[1],10)}catch(error){}},AdapterJS.maybeFixConfiguration=function(pcConfig){if(null!==pcConfig)for(var i=0;i<pcConfig.iceServers.length;i++)pcConfig.iceServers[i].hasOwnProperty("urls")&&(pcConfig.iceServers[i].url=pcConfig.iceServers[i].urls,delete pcConfig.iceServers[i].urls)},AdapterJS.addEvent=function(elem,evnt,func){elem.addEventListener?elem.addEventListener(evnt,func,!1):elem.attachEvent?elem.attachEvent("on"+evnt,func):elem[evnt]=func},AdapterJS.renderNotificationBar=function(text,buttonText,buttonLink,openNewTab,displayRefreshBar){if("complete"===document.readyState){var w=window,i=document.createElement("iframe");i.style.position="fixed",i.style.top="-41px",i.style.left=0,i.style.right=0,i.style.width="100%",i.style.height="40px",i.style.backgroundColor="#ffffe1",i.style.border="none",i.style.borderBottom="1px solid #888888",i.style.zIndex="9999999","string"==typeof i.style.webkitTransition?i.style.webkitTransition="all .5s ease-out":"string"==typeof i.style.transition&&(i.style.transition="all .5s ease-out"),document.body.appendChild(i),c=i.contentWindow?i.contentWindow:i.contentDocument.document?i.contentDocument.document:i.contentDocument,c.document.open(),c.document.write('<span style="display: inline-block; font-family: Helvetica, Arial,sans-serif; font-size: .9rem; padding: 4px; vertical-align: middle; cursor: default;">'+text+"</span>"),buttonText&&buttonLink?(c.document.write('<button id="okay">'+buttonText+'</button><button id="cancel">Cancel</button>'),c.document.close(),AdapterJS.addEvent(c.document.getElementById("okay"),"click",function(e){displayRefreshBar&&AdapterJS.renderNotificationBar(AdapterJS.TEXT.EXTENSION?AdapterJS.TEXT.EXTENSION.REQUIRE_REFRESH:AdapterJS.TEXT.REFRESH.REQUIRE_REFRESH,AdapterJS.TEXT.REFRESH.BUTTON,"javascript:location.reload()"),window.open(buttonLink,openNewTab?"_blank":"_top"),e.preventDefault();try{event.cancelBubble=!0}catch(error){}var pluginInstallInterval=setInterval(function(){isIE||navigator.plugins.refresh(!1),AdapterJS.WebRTCPlugin.isPluginInstalled(AdapterJS.WebRTCPlugin.pluginInfo.prefix,AdapterJS.WebRTCPlugin.pluginInfo.plugName,function(){clearInterval(pluginInstallInterval),AdapterJS.WebRTCPlugin.defineWebRTCInterface()},function(){})},500)}),AdapterJS.addEvent(c.document.getElementById("cancel"),"click",function(e){w.document.body.removeChild(i)})):c.document.close(),setTimeout(function(){"string"==typeof i.style.webkitTransform?i.style.webkitTransform="translateY(40px)":"string"==typeof i.style.transform?i.style.transform="translateY(40px)":i.style.top="0px"},300)}},webrtcDetectedType=null,webrtcDetectedDCSupport=null,checkMediaDataChannelSettings=function(peerBrowserAgent,peerBrowserVersion,callback,constraints){if("function"==typeof callback){var beOfferer=!0,isLocalFirefox="firefox"===webrtcDetectedBrowser,isLocalFirefoxInterop="moz"===webrtcDetectedType&&webrtcDetectedVersion>30,isPeerFirefox="firefox"===peerBrowserAgent;if(isLocalFirefox&&isPeerFirefox||isLocalFirefoxInterop)try{delete constraints.mandatory.MozDontOfferDataChannel}catch(error){}else isLocalFirefox&&!isPeerFirefox&&(constraints.mandatory.MozDontOfferDataChannel=!0);if(!isLocalFirefox)for(var prop in constraints.mandatory)constraints.mandatory.hasOwnProperty(prop)&&-1!==prop.indexOf("Moz")&&delete constraints.mandatory[prop];
!isLocalFirefox||isPeerFirefox||isLocalFirefoxInterop||(beOfferer=!1),callback(beOfferer,constraints)}},checkIceConnectionState=function(peerId,iceConnectionState,callback){"function"==typeof callback&&(peerId=peerId?peerId:"peer",AdapterJS._iceConnectionFiredStates[peerId]&&iceConnectionState!==AdapterJS._iceConnectionStates.disconnected&&iceConnectionState!==AdapterJS._iceConnectionStates.failed&&iceConnectionState!==AdapterJS._iceConnectionStates.closed||(AdapterJS._iceConnectionFiredStates[peerId]=[]),iceConnectionState=AdapterJS._iceConnectionStates[iceConnectionState],AdapterJS._iceConnectionFiredStates[peerId].indexOf(iceConnectionState)<0&&(AdapterJS._iceConnectionFiredStates[peerId].push(iceConnectionState),iceConnectionState===AdapterJS._iceConnectionStates.connected&&setTimeout(function(){AdapterJS._iceConnectionFiredStates[peerId].push(AdapterJS._iceConnectionStates.done),callback(AdapterJS._iceConnectionStates.done)},1e3),callback(iceConnectionState)))},createIceServer=null,createIceServers=null,RTCPeerConnection=null,RTCSessionDescription="function"==typeof RTCSessionDescription?RTCSessionDescription:null,RTCIceCandidate="function"==typeof RTCIceCandidate?RTCIceCandidate:null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,webrtcDetectedBrowser=null,webrtcDetectedVersion=null,navigator.mozGetUserMedia)webrtcDetectedBrowser="firefox",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1],10),webrtcDetectedType="moz",webrtcDetectedDCSupport="SCTP",RTCPeerConnection=function(pcConfig,pcConstraints){return AdapterJS.maybeFixConfiguration(pcConfig),new mozRTCPeerConnection(pcConfig,pcConstraints)},RTCSessionDescription=mozRTCSessionDescription,window.RTCSessionDescription=RTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,window.RTCIceCandidate=RTCIceCandidate,window.getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=window.getUserMedia,MediaStreamTrack.getSources=function(successCb){setTimeout(function(){var infos=[{kind:"audio",id:"default",label:"",facing:""},{kind:"video",id:"default",label:"",facing:""}];successCb(infos)},0)},createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");if(0===url_parts[0].indexOf("stun"))iceServer={url:url};else if(0===url_parts[0].indexOf("turn"))if(webrtcDetectedVersion<27){var turn_url_parts=url.split("?");(1===turn_url_parts.length||0===turn_url_parts[1].indexOf("transport=udp"))&&(iceServer={url:turn_url_parts[0],credential:password,username:username})}else iceServer={url:url,credential:password,username:username};return iceServer},createIceServers=function(urls,username,password){var iceServers=[];for(i=0;i<urls.length;i++){var iceServer=createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},attachMediaStream=function(element,stream){return element.mozSrcObject=stream,null!==stream&&element.play(),element},reattachMediaStream=function(to,from){return to.mozSrcObject=from.mozSrcObject,to.play(),to},MediaStreamTrack.getSources=MediaStreamTrack.getSources||function(callback){if(!callback)throw new TypeError("Failed to execute 'getSources' on 'MediaStreamTrack': 1 argument required, but only 0 present.");return callback([])},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]}),AdapterJS.maybeThroughWebRTCReady();else if(navigator.webkitGetUserMedia){webrtcDetectedBrowser="chrome",webrtcDetectedType="webkit",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2],10);var checkIfOpera=navigator.userAgent.match(/\bOPR\/(\d+)/);null!==checkIfOpera&&(webrtcDetectedBrowser="opera",webrtcDetectedVersion=parseInt(checkIfOpera[1],10)),"chrome"===webrtcDetectedBrowser&&webrtcDetectedVersion>=31||"opera"===webrtcDetectedBrowser&&webrtcDetectedVersion>=20?webrtcDetectedDCSupport="SCTP":"chrome"===webrtcDetectedBrowser&&webrtcDetectedVersion<30&&webrtcDetectedVersion>24?webrtcDetectedDCSupport="RTP":webrtcDetectedDCSupport="",createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");return 0===url_parts[0].indexOf("stun")?iceServer={url:url}:0===url_parts[0].indexOf("turn")&&(iceServer={url:url,credential:password,username:username}),iceServer},createIceServers=function(urls,username,password){var iceServers=[];if(webrtcDetectedVersion>=34)iceServers={urls:urls,credential:password,username:username};else for(i=0;i<urls.length;i++){var iceServer=createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},RTCPeerConnection=function(pcConfig,pcConstraints){return webrtcDetectedVersion<34&&AdapterJS.maybeFixConfiguration(pcConfig),new webkitRTCPeerConnection(pcConfig,pcConstraints)},window.getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=window.getUserMedia,attachMediaStream=function(element,stream){return"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src&&(element.src=null===stream?"":URL.createObjectURL(stream)),element},reattachMediaStream=function(to,from){return to.src=from.src,to},AdapterJS.maybeThroughWebRTCReady()}else navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)?(webrtcDetectedBrowser="edge",webrtcDetectedVersion=parseInt(navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)[2],10),webrtcMinimumVersion=12,window.getUserMedia=navigator.getUserMedia.bind(navigator),attachMediaStream=function(element,stream){return element.srcObject=stream,element},reattachMediaStream=function(to,from){return to.srcObject=from.srcObject,to},AdapterJS.maybeThroughWebRTCReady()):(("object"!=typeof console||"function"!=typeof console.log)&&(console={}||console,console.log=function(arg){},console.info=function(arg){},console.error=function(arg){},console.dir=function(arg){},console.exception=function(arg){},console.trace=function(arg){},console.warn=function(arg){},console.count=function(arg){},console.debug=function(arg){},console.count=function(arg){},console.time=function(arg){},console.timeEnd=function(arg){},console.group=function(arg){},console.groupCollapsed=function(arg){},console.groupEnd=function(arg){}),webrtcDetectedType="plugin",webrtcDetectedDCSupport="plugin",AdapterJS.parseWebrtcDetectedBrowser(),isIE="IE"===webrtcDetectedBrowser,AdapterJS.WebRTCPlugin.WaitForPluginReady=function(){for(;AdapterJS.WebRTCPlugin.pluginState!==AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY;);},AdapterJS.WebRTCPlugin.callWhenPluginReady=function(callback){if(AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY)callback();else var checkPluginReadyState=setInterval(function(){AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY&&(clearInterval(checkPluginReadyState),callback())},100)},AdapterJS.WebRTCPlugin.setLogLevel=function(logLevel){AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.setLogLevel(logLevel)})},AdapterJS.WebRTCPlugin.injectPlugin=function(){if("complete"===document.readyState&&AdapterJS.WebRTCPlugin.pluginState===AdapterJS.WebRTCPlugin.PLUGIN_STATES.INITIALIZING){if(AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INJECTING,"IE"===webrtcDetectedBrowser&&webrtcDetectedVersion<=10){var frag=document.createDocumentFragment();for(AdapterJS.WebRTCPlugin.plugin=document.createElement("div"),AdapterJS.WebRTCPlugin.plugin.innerHTML='<object id="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'" type="'+AdapterJS.WebRTCPlugin.pluginInfo.type+'" width="1" height="1"><param name="pluginId" value="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'" /> <param name="windowless" value="false" /> <param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> <param name="onload" value="'+AdapterJS.WebRTCPlugin.pluginInfo.onload+'" /><param name="tag" value="'+AdapterJS.WebRTCPlugin.TAGS.NONE+'" />'+(AdapterJS.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+"</object>";AdapterJS.WebRTCPlugin.plugin.firstChild;)frag.appendChild(AdapterJS.WebRTCPlugin.plugin.firstChild);document.body.appendChild(frag),AdapterJS.WebRTCPlugin.plugin=document.getElementById(AdapterJS.WebRTCPlugin.pluginInfo.pluginId)}else AdapterJS.WebRTCPlugin.plugin=document.createElement("object"),AdapterJS.WebRTCPlugin.plugin.id=AdapterJS.WebRTCPlugin.pluginInfo.pluginId,isIE?(AdapterJS.WebRTCPlugin.plugin.width="1px",AdapterJS.WebRTCPlugin.plugin.height="1px"):(AdapterJS.WebRTCPlugin.plugin.width="0px",AdapterJS.WebRTCPlugin.plugin.height="0px"),AdapterJS.WebRTCPlugin.plugin.type=AdapterJS.WebRTCPlugin.pluginInfo.type,AdapterJS.WebRTCPlugin.plugin.innerHTML='<param name="onload" value="'+AdapterJS.WebRTCPlugin.pluginInfo.onload+'"><param name="pluginId" value="'+AdapterJS.WebRTCPlugin.pluginInfo.pluginId+'"><param name="windowless" value="false" /> '+(AdapterJS.options.getAllCams?'<param name="forceGetAllCams" value="True" />':"")+'<param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'"><param name="tag" value="'+AdapterJS.WebRTCPlugin.TAGS.NONE+'" />',document.body.appendChild(AdapterJS.WebRTCPlugin.plugin);AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INJECTED}},AdapterJS.WebRTCPlugin.isPluginInstalled=function(comName,plugName,installedCb,notInstalledCb){if(isIE){try{new ActiveXObject(comName+"."+plugName)}catch(e){return void notInstalledCb()}installedCb()}else{for(var pluginArray=navigator.plugins,i=0;i<pluginArray.length;i++)if(pluginArray[i].name.indexOf(plugName)>=0)return void installedCb();notInstalledCb()}},AdapterJS.WebRTCPlugin.defineWebRTCInterface=function(){AdapterJS.WebRTCPlugin.pluginState!==AdapterJS.WebRTCPlugin.PLUGIN_STATES.READY&&(AdapterJS.WebRTCPlugin.pluginState=AdapterJS.WebRTCPlugin.PLUGIN_STATES.INITIALIZING,AdapterJS.isDefined=function(variable){return null!==variable&&void 0!==variable},createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");return 0===url_parts[0].indexOf("stun")?iceServer={url:url,hasCredentials:!1}:0===url_parts[0].indexOf("turn")&&(iceServer={url:url,hasCredentials:!0,credential:password,username:username}),iceServer},createIceServers=function(urls,username,password){for(var iceServers=[],i=0;i<urls.length;++i)iceServers.push(createIceServer(urls[i],username,password));return iceServers},RTCSessionDescription=function(info){return AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.ConstructSessionDescription(info.type,info.sdp)},RTCPeerConnection=function(servers,constraints){var iceServers=null;if(servers){iceServers=servers.iceServers;for(var i=0;i<iceServers.length;i++)iceServers[i].urls&&!iceServers[i].url&&(iceServers[i].url=iceServers[i].urls),iceServers[i].hasCredentials=AdapterJS.isDefined(iceServers[i].username)&&AdapterJS.isDefined(iceServers[i].credential)}var mandatory=constraints&&constraints.mandatory?constraints.mandatory:null,optional=constraints&&constraints.optional?constraints.optional:null;return AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.PeerConnection(AdapterJS.WebRTCPlugin.pageId,iceServers,mandatory,optional)},MediaStreamTrack={},MediaStreamTrack.getSources=function(callback){AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.GetSources(callback)})},window.getUserMedia=function(constraints,successCallback,failureCallback){constraints.audio=constraints.audio||!1,constraints.video=constraints.video||!1,AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){AdapterJS.WebRTCPlugin.plugin.getUserMedia(constraints,successCallback,failureCallback)})},window.navigator.getUserMedia=window.getUserMedia,attachMediaStream=function(element,stream){if(element&&element.parentNode){var streamId;null===stream?streamId="":(stream.enableSoundTracks(!0),streamId=stream.id);var elementId=0===element.id.length?Math.random().toString(36).slice(2):element.id,nodeName=element.nodeName.toLowerCase();if("object"!==nodeName){var tag;switch(nodeName){case"audio":tag=AdapterJS.WebRTCPlugin.TAGS.AUDIO;break;case"video":tag=AdapterJS.WebRTCPlugin.TAGS.VIDEO;break;default:tag=AdapterJS.WebRTCPlugin.TAGS.NONE}var frag=document.createDocumentFragment(),temp=document.createElement("div"),classHTML="";for(element.className?classHTML='class="'+element.className+'" ':element.attributes&&element.attributes["class"]&&(classHTML='class="'+element.attributes["class"].value+'" '),temp.innerHTML='<object id="'+elementId+'" '+classHTML+'type="'+AdapterJS.WebRTCPlugin.pluginInfo.type+'"><param name="pluginId" value="'+elementId+'" /> <param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> <param name="windowless" value="true" /> <param name="streamId" value="'+streamId+'" /> <param name="tag" value="'+tag+'" /> </object>';temp.firstChild;)frag.appendChild(temp.firstChild);var height="",width="";element.clientWidth||element.clientHeight?(width=element.clientWidth,height=element.clientHeight):(element.width||element.height)&&(width=element.width,height=element.height),element.parentNode.insertBefore(frag,element),frag=document.getElementById(elementId),frag.width=width,frag.height=height,element.parentNode.removeChild(element)}else{for(var children=element.children,i=0;i!==children.length;++i)if("streamId"===children[i].name){children[i].value=streamId;break}element.setStreamId(streamId)}var newElement=document.getElementById(elementId);return AdapterJS.forwardEventHandlers(newElement,element,Object.getPrototypeOf(element)),newElement}},reattachMediaStream=function(to,from){for(var stream=null,children=from.children,i=0;i!==children.length;++i)if("streamId"===children[i].name){AdapterJS.WebRTCPlugin.WaitForPluginReady(),stream=AdapterJS.WebRTCPlugin.plugin.getStreamWithId(AdapterJS.WebRTCPlugin.pageId,children[i].value);break}return null!==stream?attachMediaStream(to,stream):void 0},AdapterJS.forwardEventHandlers=function(destElem,srcElem,prototype){properties=Object.getOwnPropertyNames(prototype);for(prop in properties)propName=properties[prop],"on"==propName.slice(0,2)&&null!=srcElem[propName]&&(isIE?destElem.attachEvent(propName,srcElem[propName]):destElem.addEventListener(propName.slice(2),srcElem[propName],!1));var subPrototype=Object.getPrototypeOf(prototype);null!=subPrototype&&AdapterJS.forwardEventHandlers(destElem,srcElem,subPrototype)},RTCIceCandidate=function(candidate){return candidate.sdpMid||(candidate.sdpMid=""),AdapterJS.WebRTCPlugin.WaitForPluginReady(),AdapterJS.WebRTCPlugin.plugin.ConstructIceCandidate(candidate.sdpMid,candidate.sdpMLineIndex,candidate.candidate)},AdapterJS.addEvent(document,"readystatechange",AdapterJS.WebRTCPlugin.injectPlugin),AdapterJS.WebRTCPlugin.injectPlugin())},AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb=AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb||function(){AdapterJS.addEvent(document,"readystatechange",AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv),AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv()},AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCbPriv=function(){if(!AdapterJS.options.hidePluginInstallPrompt){var downloadLink=AdapterJS.WebRTCPlugin.pluginInfo.downloadLink;if(downloadLink){var popupString;popupString=AdapterJS.WebRTCPlugin.pluginInfo.portalLink?'This website requires you to install the  <a href="'+AdapterJS.WebRTCPlugin.pluginInfo.portalLink+'" target="_blank">'+AdapterJS.WebRTCPlugin.pluginInfo.companyName+" WebRTC Plugin</a> to work on this browser.":AdapterJS.TEXT.PLUGIN.REQUIRE_INSTALLATION,AdapterJS.renderNotificationBar(popupString,AdapterJS.TEXT.PLUGIN.BUTTON,downloadLink)}else AdapterJS.renderNotificationBar(AdapterJS.TEXT.PLUGIN.NOT_SUPPORTED)}},AdapterJS.WebRTCPlugin.isPluginInstalled(AdapterJS.WebRTCPlugin.pluginInfo.prefix,AdapterJS.WebRTCPlugin.pluginInfo.plugName,AdapterJS.WebRTCPlugin.defineWebRTCInterface,AdapterJS.WebRTCPlugin.pluginNeededButNotInstalledCb));!function(){"use strict";var baseGetUserMedia=null;AdapterJS.TEXT.EXTENSION={REQUIRE_INSTALLATION_FF:"To enable screensharing you need to install the Skylink WebRTC tools Firefox Add-on.",REQUIRE_INSTALLATION_CHROME:"To enable screensharing you need to install the Skylink WebRTC tools Chrome Extension.",REQUIRE_REFRESH:"Please refresh this page after the Skylink WebRTC tools extension has been installed.",BUTTON_FF:"Install Now",BUTTON_CHROME:"Go to Chrome Web Store"};var clone=function(obj){if(null==obj||"object"!=typeof obj)return obj;var copy=obj.constructor();for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=obj[attr]);return copy};if(window.navigator.mozGetUserMedia?(baseGetUserMedia=window.navigator.getUserMedia,navigator.getUserMedia=function(constraints,successCb,failureCb){if(constraints&&constraints.video&&constraints.video.mediaSource){if("screen"!==constraints.video.mediaSource&&"window"!==constraints.video.mediaSource)throw new Error('Only "screen" and "window" option is available as mediaSource');var updatedConstraints=clone(constraints);updatedConstraints.video.mozMediaSource=updatedConstraints.video.mediaSource;var checkIfReady=setInterval(function(){"complete"===document.readyState&&(clearInterval(checkIfReady),baseGetUserMedia(updatedConstraints,successCb,function(error){"PermissionDeniedError"===error.name&&"https:"===window.parent.location.protocol?AdapterJS.renderNotificationBar(AdapterJS.TEXT.EXTENSION.REQUIRE_INSTALLATION_FF,AdapterJS.TEXT.EXTENSION.BUTTON_FF,"http://skylink.io/screensharing/ff_addon.php?domain="+window.location.hostname,!1,!0):failureCb(error)}))},1)}else baseGetUserMedia(constraints,successCb,failureCb)},getUserMedia=navigator.getUserMedia):window.navigator.webkitGetUserMedia?(baseGetUserMedia=window.navigator.getUserMedia,navigator.getUserMedia=function(constraints,successCb,failureCb){if(constraints&&constraints.video&&constraints.video.mediaSource){if("chrome"!==window.webrtcDetectedBrowser)throw new Error("Current browser does not support screensharing");var updatedConstraints=clone(constraints),chromeCallback=function(error,sourceId){if(error)throw"permission-denied"===error?new Error("Permission denied for screen retrieval"):new Error("Failed retrieving selected screen");updatedConstraints.video.mandatory=updatedConstraints.video.mandatory||{},updatedConstraints.video.mandatory.chromeMediaSource="desktop",updatedConstraints.video.mandatory.maxWidth=window.screen.width>1920?window.screen.width:1920,updatedConstraints.video.mandatory.maxHeight=window.screen.height>1080?window.screen.height:1080,sourceId&&(updatedConstraints.video.mandatory.chromeMediaSourceId=sourceId),delete updatedConstraints.video.mediaSource,baseGetUserMedia(updatedConstraints,successCb,failureCb)},onIFrameCallback=function(event){event.data&&(event.data.chromeMediaSourceId&&("PermissionDeniedError"===event.data.chromeMediaSourceId?chromeCallback("permission-denied"):chromeCallback(null,event.data.chromeMediaSourceId)),event.data.chromeExtensionStatus&&("not-installed"===event.data.chromeExtensionStatus?AdapterJS.renderNotificationBar(AdapterJS.TEXT.EXTENSION.REQUIRE_INSTALLATION_CHROME,AdapterJS.TEXT.EXTENSION.BUTTON_CHROME,event.data.data,!0,!0):chromeCallback(event.data.chromeExtensionStatus,null)),window.removeEventListener("message",onIFrameCallback))};window.addEventListener("message",onIFrameCallback),postFrameMessage({captureSourceId:!0})}else baseGetUserMedia(constraints,successCb,failureCb)},getUserMedia=navigator.getUserMedia):navigator.mediaDevices&&navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||(baseGetUserMedia=window.navigator.getUserMedia,navigator.getUserMedia=function(constraints,successCb,failureCb){if(constraints&&constraints.video&&constraints.video.mediaSource){var updatedConstraints=clone(constraints);AdapterJS.WebRTCPlugin.callWhenPluginReady(function(){if(!AdapterJS.WebRTCPlugin.plugin.HasScreensharingFeature||!AdapterJS.WebRTCPlugin.plugin.isScreensharingAvailable)throw new Error("Your WebRTC plugin does not support screensharing");updatedConstraints.video.optional=updatedConstraints.video.optional||[],updatedConstraints.video.optional.push({sourceId:AdapterJS.WebRTCPlugin.plugin.screensharingKey||"Screensharing"}),delete updatedConstraints.video.mediaSource,baseGetUserMedia(updatedConstraints,successCb,failureCb)})}else baseGetUserMedia(constraints,successCb,failureCb)},getUserMedia=window.navigator.getUserMedia),"chrome"===window.webrtcDetectedBrowser){var iframe=document.createElement("iframe");iframe.onload=function(){iframe.isLoaded=!0},iframe.src="https://cdn.temasys.com.sg/skylink/extensions/detectRTC.html",iframe.style.display="none",(document.body||document.documentElement).appendChild(iframe);var postFrameMessage=function(object){return object=object||{},iframe.isLoaded?void iframe.contentWindow.postMessage(object,"*"):void setTimeout(function(){iframe.contentWindow.postMessage(object,"*")},100)}}else"opera"===window.webrtcDetectedBrowser}(),function(){"use strict";function Skylink(){return this instanceof Skylink?(this.VERSION="0.6.3",void(this.generateUUID=function(){var d=(new Date).getTime(),uuid="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=(d+16*Math.random())%16|0;return d=Math.floor(d/16),("x"==c?r:7&r|8).toString(16)});return uuid})):new Skylink}Object.keys||(Object.keys=function(){var hasOwnProperty=Object.prototype.hasOwnProperty,hasDontEnumBug=!{toString:null}.propertyIsEnumerable("toString"),dontEnums=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],dontEnumsLength=dontEnums.length;return function(obj){if("object"!=typeof obj&&"function"!=typeof obj||null===obj)throw new TypeError("Object.keys called on non-object");var result=[];for(var prop in obj)hasOwnProperty.call(obj,prop)&&result.push(prop);if(hasDontEnumBug)for(var i=0;dontEnumsLength>i;i++)hasOwnProperty.call(obj,dontEnums[i])&&result.push(dontEnums[i]);return result}}()),function(){function pad(number){return 10>number?"0"+number:number}Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+pad(this.getUTCMonth()+1)+"-"+pad(this.getUTCDate())+"T"+pad(this.getUTCHours())+":"+pad(this.getUTCMinutes())+":"+pad(this.getUTCSeconds())+"."+(this.getUTCMilliseconds()/1e3).toFixed(3).slice(2,5)+"Z"}}(),function(win,doc){function docHijack(p){var old=doc[p];doc[p]=function(v){return addListen(old(v))}}function addEvent(on,fn,self){return(self=this).attachEvent("on"+on,function(e){var e=e||win.event;e.preventDefault=e.preventDefault||function(){e.returnValue=!1},e.stopPropagation=e.stopPropagation||function(){e.cancelBubble=!0},fn.call(self,e)})}function addListen(obj,i){if(i=obj.length)for(;i--;)obj[i].addEventListener=addEvent;else obj.addEventListener=addEvent;return obj}win.addEventListener||(addListen([doc,win]),"Element"in win?win.Element.prototype.addEventListener=addEvent:(doc.attachEvent("onreadystatechange",function(){addListen(doc.all)}),docHijack("getElementsByTagName"),docHijack("getElementById"),docHijack("createElement"),addListen(doc.all)))}(window,document);var clone=function(obj){if(null===obj||"object"!=typeof obj)return obj;var copy=obj.constructor();for(var attr in obj)obj.hasOwnProperty(attr)&&(copy[attr]=obj[attr]);return copy};this.Skylink=Skylink,Skylink.prototype.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error"},Skylink.prototype.DATA_CHANNEL_TYPE={MESSAGING:"messaging",DATA:"data"},Skylink.prototype._enableDataChannel=!0,Skylink.prototype._dataChannels={},Skylink.prototype._createDataChannel=function(peerId,channelType,dc,customChannelName){var self=this;if("string"==typeof dc&&(customChannelName=dc,dc=null),!customChannelName)return void log.error([peerId,"RTCDataChannel",null,"Aborting of creating Datachannel as no channel name is provided for channel. Aborting of creating Datachannel"],{channelType:channelType});var channelName=dc?dc.label:customChannelName,pc=self._peerConnections[peerId];if("SCTP"!==window.webrtcDetectedDCSupport&&"plugin"!==window.webrtcDetectedDCSupport)return void log.warn([peerId,"RTCDataChannel",channelName,"SCTP not supported"],{channelType:channelType});var dcHasOpened=function(){log.log([peerId,"RTCDataChannel",channelName,"Datachannel state ->"],{readyState:"open",channelType:channelType}),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.OPEN,peerId,null,channelName,channelType)};if(dc)dc.readyState===self.DATA_CHANNEL_STATE.OPEN?setTimeout(dcHasOpened,500):dc.onopen=dcHasOpened;else try{dc=pc.createDataChannel(channelName),dc.readyState===self.DATA_CHANNEL_STATE.OPEN?setTimeout(dcHasOpened,500):(self._trigger("dataChannelState",dc.readyState,peerId,null,channelName,channelType),self._wait(function(){log.log([peerId,"RTCDataChannel",dc.label,"Firing callback. Datachannel state has opened ->"],dc.readyState),dcHasOpened()},function(){return dc.readyState===self.DATA_CHANNEL_STATE.OPEN})),log.debug([peerId,"RTCDataChannel",channelName,"Datachannel RTC object is created"],{readyState:dc.readyState,channelType:channelType})}catch(error){return log.error([peerId,"RTCDataChannel",channelName,"Exception occurred in datachannel:"],{channelType:channelType,error:error}),void self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.ERROR,peerId,error,channelName,channelType)}return log.log([peerId,"RTCDataChannel",channelName,"Binary type support ->"],{binaryType:dc.binaryType,readyState:dc.readyState,channelType:channelType}),dc.dcType=channelType,dc.onerror=function(error){log.error([peerId,"RTCDataChannel",channelName,"Exception occurred in datachannel:"],{channelType:channelType,readyState:dc.readyState,error:error}),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.ERROR,peerId,error,channelName,channelType)},dc.onclose=function(){log.debug([peerId,"RTCDataChannel",channelName,"Datachannel state ->"],{readyState:"closed",channelType:channelType}),dc.hasFiredClosed=!0,setTimeout(function(){pc=self._peerConnections[peerId];var checkIfChannelClosedDuringConn=pc?!pc.dataChannelClosed:!1;checkIfChannelClosedDuringConn&&dc.dcType===self.DATA_CHANNEL_TYPE.MESSAGING?(log.debug([peerId,"RTCDataChannel",channelName,"Re-opening closed datachannel in on-going connection"],{channelType:channelType,readyState:dc.readyState,isClosedDuringConnection:checkIfChannelClosedDuringConn}),self._dataChannels[peerId].main=self._createDataChannel(peerId,self.DATA_CHANNEL_TYPE.MESSAGING,null,peerId),log.debug([peerId,"RTCDataChannel",channelName,"Re-opened closed datachannel"],{channelType:channelType,readyState:dc.readyState,isClosedDuringConnection:checkIfChannelClosedDuringConn})):(self._closeDataChannel(peerId,channelName),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.CLOSED,peerId,null,channelName,channelType),log.debug([peerId,"RTCDataChannel",channelName,"Datachannel has closed"],{channelType:channelType,readyState:dc.readyState,isClosedDuringConnection:checkIfChannelClosedDuringConn}))},100)},dc.onmessage=function(event){self._dataChannelProtocolHandler(event.data,peerId,channelName,channelType)},dc},Skylink.prototype._sendDataChannelMessage=function(peerId,data,channelKey){var channelName,self=this;channelKey&&channelKey!==peerId||(channelKey="main");var dcList=self._dataChannels[peerId]||{},dc=dcList[channelKey];if(!dc)return void log.error([peerId,"RTCDataChannel",channelKey+"|"+channelName,"Datachannel connection to peer does not exist"],{enabledState:self._enableDataChannel,dcList:dcList,dc:dc,type:data.type||"DATA",data:data,channelKey:channelKey});if(channelName=dc.label,log.debug([peerId,"RTCDataChannel",channelKey+"|"+channelName,"Sending data using this channel key"],data),dc.readyState===this.DATA_CHANNEL_STATE.OPEN){var dataString="object"==typeof data?JSON.stringify(data):data;log.debug([peerId,"RTCDataChannel",channelKey+"|"+dc.label,"Sending to peer ->"],{readyState:dc.readyState,type:data.type||"DATA",data:data}),dc.send(dataString)}else log.error([peerId,"RTCDataChannel",channelKey+"|"+dc.label,"Datachannel is not opened"],{readyState:dc.readyState,type:data.type||"DATA",data:data}),this._trigger("dataChannelState",this.DATA_CHANNEL_STATE.ERROR,peerId,"Datachannel is not ready.\nState is: "+dc.readyState)},Skylink.prototype._closeDataChannel=function(peerId,channelName){var self=this,dcList=self._dataChannels[peerId]||{},dcKeysList=Object.keys(dcList);channelName&&(dcKeysList=[channelName]);for(var i=0;i<dcKeysList.length;i++){var channelKey=dcKeysList[i],dc=dcList[channelKey];dc?(dc.readyState!==self.DATA_CHANNEL_STATE.CLOSED?(log.log([peerId,"RTCDataChannel",channelKey+"|"+dc.label,"Closing datachannel"]),dc.close()):dc.hasFiredClosed||"firefox"!==window.webrtcDetectedBrowser||(log.log([peerId,"RTCDataChannel",channelKey+"|"+dc.label,"Closed Firefox datachannel"]),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.CLOSED,peerId,null,channelName,"main"===channelKey?self.DATA_CHANNEL_TYPE.MESSAGING:self.DATA_CHANNEL_TYPE.DATA)),delete self._dataChannels[peerId][channelKey],log.log([peerId,"RTCDataChannel",channelKey+"|"+dc.label,"Sucessfully removed datachannel"])):log.log([peerId,"RTCDataChannel",channelKey+"|"+channelName,"Unable to close Datachannel as it does not exists"],{dc:dc,dcList:dcList})}},Skylink.prototype._CHUNK_FILE_SIZE=49152,Skylink.prototype._CHUNK_DATAURL_SIZE=1212,Skylink.prototype._MOZ_CHUNK_FILE_SIZE=12288,Skylink.prototype.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob"},Skylink.prototype._base64ToBlob=function(dataURL){for(var byteString=atob(dataURL.replace(/\s\r\n/g,"")),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);return new Blob([ab])},Skylink.prototype._blobToBase64=function(data,callback){var fileReader=new FileReader;fileReader.onload=function(){var base64BinaryString=fileReader.result.split(",")[1];callback(base64BinaryString)},fileReader.readAsDataURL(data)},Skylink.prototype._chunkBlobData=function(blob,chunkSize){var chunksArray=[],startCount=0,endCount=0,blobByteSize=blob.size;if(blobByteSize>chunkSize){for(;blobByteSize-1>endCount;)endCount=startCount+chunkSize,chunksArray.push(blob.slice(startCount,endCount)),startCount+=chunkSize;blobByteSize-(startCount+1)>0&&chunksArray.push(blob.slice(startCount,blobByteSize-1))}else chunksArray.push(blob);return chunksArray},Skylink.prototype._chunkDataURL=function(dataURL,chunkSize){var outputStr=dataURL,dataURLArray=[],startCount=0,endCount=0,dataByteSize=dataURL.size||dataURL.length;if(dataByteSize>chunkSize){for(;dataByteSize-1>endCount;)endCount=startCount+chunkSize,dataURLArray.push(outputStr.slice(startCount,endCount)),startCount+=chunkSize;dataByteSize-(startCount+1)>0&&chunksArray.push(outputStr.slice(startCount,dataByteSize-1))}else dataURLArray.push(outputStr);return dataURLArray},Skylink.prototype._assembleDataURL=function(dataURLArray){for(var outputStr="",i=0;i<dataURLArray.length;i++)try{outputStr+=dataURLArray[i]}catch(error){}return outputStr},Skylink.prototype.DT_PROTOCOL_VERSION="0.1.0",Skylink.prototype._TRANSFER_DELIMITER="_skylink__",Skylink.prototype._DC_PROTOCOL_TYPE={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},Skylink.prototype._INTEROP_MULTI_TRANSFERS=["Android","iOS"],Skylink.prototype.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},Skylink.prototype.DATA_TRANSFER_STATE={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},Skylink.prototype._uploadDataTransfers={},Skylink.prototype._uploadDataSessions={},Skylink.prototype._downloadDataTransfers={},
Skylink.prototype._downloadDataSessions={},Skylink.prototype._dataTransfersTimeout={},Skylink.prototype._setDataChannelTimeout=function(peerId,timeout,isSender,channelName){var self=this;self._dataTransfersTimeout[channelName]||(self._dataTransfersTimeout[channelName]=null);var type=isSender?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD;self._dataTransfersTimeout[channelName]=setTimeout(function(){var name;self._dataTransfersTimeout[channelName][type]&&(isSender?(name=self._uploadDataSessions[channelName].name,delete self._uploadDataTransfers[channelName],delete self._uploadDataSessions[channelName]):(name=self._downloadDataSessions[channelName].name,delete self._downloadDataTransfers[channelName],delete self._downloadDataSessions[channelName]),self._sendDataChannelMessage(peerId,{type:self._DC_PROTOCOL_TYPE.ERROR,sender:self._user.sid,name:name,content:"Connection Timeout. Longer than "+timeout+" seconds. Connection is abolished.",isUploadError:isSender},channelName),log.error([peerId,"RTCDataChannel",channelName,"Failed transfering data:"],"Transfer "+(isSender?"for":"from")+" "+peerId+" failed. Connection timeout"),self._clearDataChannelTimeout(peerId,isSender,channelName))},1e3*timeout)},Skylink.prototype._clearDataChannelTimeout=function(peerId,isSender,channelName){this._dataTransfersTimeout[channelName]?(clearTimeout(this._dataTransfersTimeout[channelName]),delete this._dataTransfersTimeout[channelName],log.debug([peerId,"RTCDataChannel",channelName,"Clear datachannel timeout"])):log.debug([peerId,"RTCDataChannel",channelName,"Unable to find timeouts. Not clearing the datachannel timeouts"])},Skylink.prototype._sendBlobDataToPeer=function(data,dataInfo,targetPeerId){var i,self=this,targetChannel=targetPeerId,targetPeerList=[],binarySize=parseInt((dataInfo.size*(4/3)).toFixed(),10),binaryChunkSize=0,chunkSize=0,hasSend=!1;self._hasMCU&&(targetPeerList=Array.isArray(targetPeerList)?targetPeerId:[targetPeerId],targetPeerId="MCU"),"blob"!==dataInfo.dataType?(binaryChunkSize=self._CHUNK_DATAURL_SIZE,chunkSize=self._CHUNK_DATAURL_SIZE,binarySize=dataInfo.size):"firefox"===window.webrtcDetectedBrowser?(binaryChunkSize=self._MOZ_CHUNK_FILE_SIZE*(4/3),chunkSize=self._MOZ_CHUNK_FILE_SIZE):(binaryChunkSize=parseInt((self._CHUNK_FILE_SIZE*(4/3)).toFixed(),10),chunkSize=self._CHUNK_FILE_SIZE);var throwTransferErrorFn=function(message){if(self._hasMCU)for(i=0;i<targetPeerList.length;i++){var peerId=targetPeerList[i];self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,dataInfo.transferId,peerId,{name:dataInfo.name,size:dataInfo.size,percentage:0,data:null,dataType:dataInfo.dataType,senderPeerId:self._user.sid,timeout:dataInfo.timeout,isPrivate:dataInfo.isPrivate},{message:message,transferType:self.DATA_TRANSFER_TYPE.UPLOAD})}else self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,dataInfo.transferId,targetPeerId,{name:dataInfo.name,size:dataInfo.size,percentage:0,data:null,dataType:dataInfo.dataType,senderPeerId:self._user.sid,timeout:dataInfo.timeout,isPrivate:dataInfo.isPrivate},{message:message,transferType:self.DATA_TRANSFER_TYPE.UPLOAD})},startTransferFn=function(targetId,channel){if(!hasSend){hasSend=!0;var payload={type:self._DC_PROTOCOL_TYPE.WRQ,sender:self._user.sid,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,name:dataInfo.name,size:binarySize,dataType:dataInfo.dataType,chunkSize:binaryChunkSize,timeout:dataInfo.timeout,target:self._hasMCU?"MCU":targetPeerId,isPrivate:dataInfo.isPrivate};if(self._hasMCU){self._sendDataChannelMessage("MCU",payload,channel);try{var mainChannel=self._dataChannels.MCU.main.label;self._setDataChannelTimeout("MCU",dataInfo.timeout,!0,mainChannel)}catch(error){log.error(["MCU","RTCDataChannel","MCU","Failed setting datachannel timeout for MCU"],error)}}else self._sendDataChannelMessage(targetId,payload,channel),self._setDataChannelTimeout(targetId,dataInfo.timeout,!0,channel)}};log.log([targetPeerId,"RTCDataChannel",targetChannel,"Chunk size of data:"],{chunkSize:chunkSize,binaryChunkSize:binaryChunkSize,transferId:dataInfo.transferId,dataType:dataInfo.dataType});var supportMulti=!1,peerAgent=(self._peerInformations[targetPeerId]||{}).agent;if(!peerAgent&&!peerAgent.name)return log.error([targetPeerId,"RTCDataChannel",targetChannel,"Aborting transfer to peer as peer agent information for peer does not exists"],dataInfo),void throwTransferErrorFn("Peer agent information for peer does not exists");if(-1===self._INTEROP_MULTI_TRANSFERS.indexOf(peerAgent.name)){if(targetChannel=targetPeerId+"-"+dataInfo.transferId,supportMulti=!0,!(self._dataChannels[targetPeerId]||{}).main)return log.error([targetPeerId,"RTCDataChannel",targetChannel,"Main datachannel does not exists"],dataInfo),void throwTransferErrorFn("Main datachannel does not exists");if(self._dataChannels[targetPeerId].main.readyState!==self.DATA_CHANNEL_STATE.OPEN)return log.error([targetPeerId,"RTCDataChannel",targetChannel,"Main datachannel is not opened"],{transferId:dataInfo.transferId,readyState:self._dataChannels[targetPeerId].main.readyState}),void throwTransferErrorFn("Main datachannel is not opened");self._dataChannels[targetPeerId][targetChannel]=self._createDataChannel(targetPeerId,self.DATA_CHANNEL_TYPE.DATA,null,targetChannel)}else{var ongoingTransfer=null;if(self._uploadDataSessions[targetChannel]?ongoingTransfer=self.DATA_TRANSFER_TYPE.UPLOAD:self._downloadDataSessions[targetChannel]&&(ongoingTransfer=self.DATA_TRANSFER_TYPE.DOWNLOAD),ongoingTransfer)return log.error([targetPeerId,"RTCDataChannel",targetChannel,"User have ongoing "+ongoingTransfer+" transfer session with peer. Unable to send data"],dataInfo),void throwTransferErrorFn("Another "+ongoingTransfer+" transfer is ongoing. Unable to send data.")}return"blob"===dataInfo.dataType?self._uploadDataTransfers[targetChannel]=self._chunkBlobData(data,chunkSize):self._uploadDataTransfers[targetChannel]=self._chunkDataURL(data,chunkSize),self._uploadDataSessions[targetChannel]={name:dataInfo.name,size:binarySize,isUpload:!0,senderPeerId:self._user.sid,transferId:dataInfo.transferId,percentage:0,timeout:dataInfo.timeout,chunkSize:chunkSize,dataType:dataInfo.dataType,isPrivate:dataInfo.isPrivate},supportMulti?self._condition("dataChannelState",function(){startTransferFn(targetPeerId,targetChannel)},function(){return self._dataChannels[targetPeerId][targetChannel].readyState===self.DATA_CHANNEL_STATE.OPEN},function(state){return state===self.DATA_CHANNEL_STATE.OPEN}):startTransferFn(targetChannel,targetChannel),targetChannel},Skylink.prototype._dataChannelProtocolHandler=function(dataString,peerId,channelName,channelType){if(!(this._peerInformations[peerId]||{}).agent)return void log.error([peerId,"RTCDataChannel",channelName,"Peer informations is missing during protocol handling. Dropping packet"],dataString);if("string"==typeof dataString){var data={};try{data=JSON.parse(dataString)}catch(error){return log.debug([peerId,"RTCDataChannel",channelName,"Received from peer ->"],{type:"DATA",data:dataString}),void this._DATAProtocolHandler(peerId,dataString,this.DATA_TRANSFER_DATA_TYPE.BINARY_STRING,channelName)}switch(log.debug([peerId,"RTCDataChannel",channelName,"Received from peer ->"],{type:data.type,data:data}),data.type){case this._DC_PROTOCOL_TYPE.WRQ:this._WRQProtocolHandler(peerId,data,channelName);break;case this._DC_PROTOCOL_TYPE.ACK:this._ACKProtocolHandler(peerId,data,channelName);break;case this._DC_PROTOCOL_TYPE.ERROR:this._ERRORProtocolHandler(peerId,data,channelName);break;case this._DC_PROTOCOL_TYPE.CANCEL:this._CANCELProtocolHandler(peerId,data,channelName);break;case this._DC_PROTOCOL_TYPE.MESSAGE:this._MESSAGEProtocolHandler(peerId,data,channelName);break;default:log.error([peerId,"RTCDataChannel",channelName,"Unsupported message ->"],{type:data.type,data:data})}}},Skylink.prototype._WRQProtocolHandler=function(peerId,data,channelName){var transferId=channelName+this._TRANSFER_DELIMITER+(new Date).getTime();log.log([peerId,"RTCDataChannel",channelName,"Received file request from peer:"],data);var name=data.name,binarySize=data.size,expectedSize=data.chunkSize,timeout=data.timeout;this._downloadDataSessions[channelName]={transferId:transferId,name:name,isUpload:!1,senderPeerId:peerId,size:binarySize,percentage:0,dataType:data.dataType,ackN:0,receivedSize:0,chunkSize:expectedSize,timeout:timeout,isPrivate:data.isPrivate},this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.UPLOAD_REQUEST,transferId,peerId,{name:name,size:binarySize,percentage:0,data:null,dataType:data.dataType,senderPeerId:peerId,timeout:timeout,isPrivate:data.isPrivate}),this._trigger("incomingDataRequest",transferId,peerId,{name:name,size:binarySize,percentage:0,dataType:data.dataType,senderPeerId:peerId,timeout:timeout,isPrivate:data.isPrivate},!1)},Skylink.prototype._ACKProtocolHandler=function(peerId,data,channelName){var self=this,ackN=data.ackN,transferStatus=self._uploadDataSessions[channelName];if(!transferStatus)return void log.error([peerId,"RTCDataChannel",channelName,"Ignoring data received as upload data transfers is empty"],{status:transferStatus,data:data});if(!this._uploadDataTransfers[channelName])return void log.error([peerId,"RTCDataChannel",channelName,"Ignoring data received as upload data transfers array is missing"],{data:data});var chunksLength=self._uploadDataTransfers[channelName].length,transferId=transferStatus.transferId,timeout=transferStatus.timeout;if(self._clearDataChannelTimeout(peerId,!0,channelName),log.log([peerId,"RTCDataChannel",channelName,"ACK stage ("+transferStatus.transferId+") ->"],ackN+" / "+chunksLength),ackN>-1){if(chunksLength>ackN){var sendDataFn=function(base64BinaryString){var percentage=parseFloat(((ackN+1)/chunksLength*100).toFixed(2),10);return self._uploadDataSessions[channelName]?(self._uploadDataSessions[channelName].percentage=percentage,self._sendDataChannelMessage(peerId,base64BinaryString,channelName),self._setDataChannelTimeout(peerId,timeout,!0,channelName),void(100!==percentage&&self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOADING,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:percentage,data:null,dataType:transferStatus.dataType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate}))):void log.error([peerId,"RTCDataChannel",channelName,"Failed uploading as data session is empty"],{status:transferStatus,data:data})};"blob"===transferStatus.dataType?self._blobToBase64(self._uploadDataTransfers[channelName][ackN],sendDataFn):sendDataFn(self._uploadDataTransfers[channelName][ackN])}else if(ackN===chunksLength){log.log([peerId,"RTCDataChannel",channelName,"Upload completed ("+transferStatus.transferId+")"],transferStatus),self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOAD_COMPLETED,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:100,data:null,dataType:transferStatus.dataType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate});var blob=null;blob="blob"===transferStatus.dataType?new Blob(self._uploadDataTransfers[channelName]):self._assembleDataURL(self._uploadDataTransfers[channelName]),self._trigger("incomingData",blob,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:100,dataType:transferStatus.dataType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate},!0),delete self._uploadDataTransfers[channelName],delete self._uploadDataSessions[channelName],self._dataChannels[peerId]&&self._dataChannels[peerId][channelName]&&(log.debug([peerId,"RTCDataChannel",channelName,"Closing datachannel for upload transfer"]),self._closeDataChannel(peerId,channelName))}}else log.debug([peerId,"RTCDataChannel",channelName,"Upload rejected ("+transferStatus.transferId+")"],transferStatus),self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.REJECTED,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:0,data:null,dataType:transferStatus.dataType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate}),delete self._uploadDataTransfers[channelName],delete self._uploadDataSessions[channelName],self._dataChannels[peerId]&&self._dataChannels[peerId][channelName]&&(log.debug([peerId,"RTCDataChannel",channelName,"Closing datachannel for upload transfer"]),self._closeDataChannel(peerId,channelName))},Skylink.prototype._MESSAGEProtocolHandler=function(peerId,data,channelName){var targetMid=data.sender;log.log([targetMid,"RTCDataChannel",channelName,"Received P2P message from peer:"],data),this._trigger("incomingMessage",{content:data.data,isPrivate:data.isPrivate,isDataChannel:!0,targetPeerId:this._user.sid,senderPeerId:targetMid},targetMid,this.getPeerInfo(targetMid),!1)},Skylink.prototype._ERRORProtocolHandler=function(peerId,data,channelName){var isUploader=data.isUploadError,transferStatus=isUploader?this._uploadDataSessions[channelName]:this._downloadDataSessions[channelName];if(!transferStatus)return void log.error([peerId,"RTCDataChannel",channelName,"Ignoring data received as "+(isUploader?"upload":"download")+" data session is empty"],data);var transferId=transferStatus.transferId;log.error([peerId,"RTCDataChannel",channelName,"Received an error from peer:"],data),this._clearDataChannelTimeout(peerId,isUploader,channelName),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:transferStatus.percentage,data:null,dataType:transferStatus.dataType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate},{message:data.content,transferType:isUploader?this.DATA_TRANSFER_TYPE.UPLOAD:this.DATA_TRANSFER_TYPE.DOWNLOAD})},Skylink.prototype._CANCELProtocolHandler=function(peerId,data,channelName){var isUpload=!!this._uploadDataSessions[channelName],transferStatus=(!!this._downloadDataSessions[channelName],isUpload?this._uploadDataSessions[channelName]:this._downloadDataSessions[channelName]);if(!transferStatus)return void log.error([peerId,"RTCDataChannel",channelName,"Ignoring data received as "+(isUpload?"upload":"download")+" data session is empty"],data);var transferId=transferStatus.transferId;log.log([peerId,"RTCDataChannel",channelName,"Received file transfer cancel request:"],data),this._clearDataChannelTimeout(peerId,isUpload,channelName);try{isUpload?(delete this._uploadDataSessions[channelName],delete this._uploadDataTransfers[channelName]):(delete this._downloadDataSessions[channelName],delete this._downloadDataTransfers[channelName]),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.CANCEL,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,data:null,dataType:transferStatus.dataType,percentage:transferStatus.percentage,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate},{message:data.content,transferType:isUpload?this.DATA_TRANSFER_TYPE.UPLOAD:this.DATA_TRANSFER_TYPE.DOWNLOAD}),log.log([peerId,"RTCDataChannel",channelName,"Emptied file transfer session:"],data)}catch(error){this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,data:null,dataType:transferStatus.dataType,percentage:transferStatus.percentage,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate},{message:"Failed cancelling data request from peer",transferType:isUpload?this.DATA_TRANSFER_TYPE.UPLOAD:this.DATA_TRANSFER_TYPE.DOWNLOAD}),log.error([peerId,"RTCDataChannel",channelName,"Failed emptying file transfer session:"],{data:data,error:error})}},Skylink.prototype._DATAProtocolHandler=function(peerId,dataString,dataType,channelName){var chunk,error="",transferStatus=this._downloadDataSessions[channelName];if(log.log([peerId,"RTCDataChannel",channelName,"Received data chunk from peer ->"],{dataType:dataType,data:dataString,type:"DATA"}),!transferStatus)return void log.error([peerId,"RTCDataChannel",channelName,"Ignoring data received as download data session is empty"],{dataType:dataType,data:dataString,type:"DATA"});if(!this._downloadDataTransfers[channelName])return void log.error([peerId,"RTCDataChannel",channelName,"Ignoring data received as download data transfers array is missing"],{dataType:dataType,data:dataString,type:"DATA"});var transferId=transferStatus.transferId,dataTransferType=transferStatus.dataType,receivedSize=0;if(this._clearDataChannelTimeout(peerId,!1,channelName),dataType===this.DATA_TRANSFER_DATA_TYPE.BINARY_STRING)"blob"===dataTransferType?(chunk=this._base64ToBlob(dataString),receivedSize=chunk.size*(4/3)):(chunk=dataString,receivedSize=dataString.length);else if(dataType===this.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER)chunk=new Blob(dataString);else{if(dataType!==this.DATA_TRANSFER_DATA_TYPE.BLOB)return error="Unhandled data exception: "+dataType,log.error([peerId,"RTCDataChannel",channelName,"Failed downloading data packets:"],{dataType:dataType,data:dataString,type:"DATA",error:error}),void this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:transferStatus.percentage,data:null,dataType:dataTransferType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate},{message:error,transferType:this.DATA_TRANSFER_TYPE.DOWNLOAD});chunk=dataString}if(log.log([peerId,"RTCDataChannel",channelName,"Received and expected data chunk size ("+receivedSize+" === "+transferStatus.chunkSize+")"],{dataType:dataType,data:dataString,receivedSize:receivedSize,expectedSize:transferStatus.chunkSize,type:"DATA"}),transferStatus.chunkSize>=receivedSize){this._downloadDataTransfers[channelName].push(chunk),transferStatus.ackN+=1,transferStatus.receivedSize+=receivedSize;var totalReceivedSize=transferStatus.receivedSize,percentage=parseFloat((totalReceivedSize/transferStatus.size*100).toFixed(2),10);if(this._sendDataChannelMessage(peerId,{type:this._DC_PROTOCOL_TYPE.ACK,sender:this._user.sid,ackN:transferStatus.ackN},channelName),this._downloadDataSessions[channelName].percentage=percentage,transferStatus.chunkSize===receivedSize&&100>percentage){if(log.log([peerId,"RTCDataChannel",channelName,"Transfer in progress ACK n ("+transferStatus.ackN+")"],{dataType:dataType,data:dataString,ackN:transferStatus.ackN,type:"DATA"}),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.DOWNLOADING,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:percentage,data:null,dataType:dataTransferType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate}),this._setDataChannelTimeout(peerId,transferStatus.timeout,!1,channelName),!this._downloadDataSessions[channelName])return void log.error([peerId,"RTCDataChannel",channelName,"Failed downloading as data session is empty"],{dataType:dataType,data:dataString,type:"DATA"});this._downloadDataSessions[channelName].info=transferStatus}else{log.log([peerId,"RTCDataChannel",channelName,"Download complete"],{dataType:dataType,data:dataString,type:"DATA",transferInfo:transferStatus});var blob=null;blob="blob"===dataTransferType?new Blob(this._downloadDataTransfers[channelName]):this._assembleDataURL(this._downloadDataTransfers[channelName]),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.DOWNLOAD_COMPLETED,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:100,data:blob,dataType:dataTransferType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate}),this._trigger("incomingData",blob,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:100,dataType:dataTransferType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate},!1),delete this._downloadDataTransfers[channelName],delete this._downloadDataSessions[channelName],log.log([peerId,"RTCDataChannel",channelName,"Converted to Blob as download"],{dataType:dataType,data:dataString,type:"DATA",transferInfo:transferStatus}),this._dataChannels[peerId]&&this._dataChannels[peerId][channelName]&&(log.debug([peerId,"RTCDataChannel",channelName,"Closing datachannel for download transfer"]),this._closeDataChannel(peerId,channelName))}}else error="Packet not match - [Received]"+receivedSize+" / [Expected]"+transferStatus.chunkSize,this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,transferId,peerId,{name:transferStatus.name,size:transferStatus.size,percentage:transferStatus.percentage,data:null,dataType:dataTransferType,senderPeerId:transferStatus.senderPeerId,timeout:transferStatus.timeout,isPrivate:transferStatus.isPrivate},{message:error,transferType:this.DATA_TRANSFER_TYPE.DOWNLOAD}),log.error([peerId,"RTCDataChannel",channelName,"Failed downloading data packets:"],{dataType:dataType,data:dataString,type:"DATA",transferInfo:transferStatus,error:error})},Skylink.prototype.sendBlobData=function(data,timeout,targetPeerId,callback){var errorMsg,errorPayload,i,peerId,listOfPeers=Object.keys(this._peerConnections),isPrivate=!1,dataInfo={},transferId=this._user.sid+this.DATA_TRANSFER_TYPE.UPLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),singleError=null,transferErrors={},stateError=null,singlePeerId=null;if("function"==typeof timeout?callback=timeout:"string"==typeof timeout?(listOfPeers=[timeout],isPrivate=!0):Array.isArray(timeout)&&(listOfPeers=timeout,isPrivate=!0),"function"==typeof targetPeerId?callback=targetPeerId:Array.isArray(targetPeerId)?(listOfPeers=targetPeerId,isPrivate=!0):"string"==typeof targetPeerId&&(listOfPeers=[targetPeerId],isPrivate=!0),!("object"==typeof data&&data instanceof Blob)){if(errorMsg="Provided data is not a Blob data",0===listOfPeers.length)transferErrors.self=errorMsg;else{for(i=0;i<listOfPeers.length;i++)peerId=listOfPeers[i],transferErrors[peerId]=errorMsg;1===listOfPeers.length&&isPrivate&&(stateError=self.DATA_TRANSFER_STATE.ERROR,singleError=errorMsg,singlePeerId=listOfPeers[0])}return errorPayload={state:stateError,error:singleError,transferId:transferId,peerId:singlePeerId,listOfPeers:listOfPeers,transferErrors:transferErrors,transferInfo:dataInfo,isPrivate:isPrivate},log.error(errorMsg,errorPayload),void("function"==typeof callback&&(log.log([null,"RTCDataChannel",null,"Error occurred. Firing callback with error -> "],errorPayload),callback(errorPayload,null)))}if(dataInfo.name=data.name||transferId,dataInfo.size=data.size,dataInfo.timeout="number"==typeof timeout?timeout:60,dataInfo.transferId=transferId,dataInfo.dataType="blob",dataInfo.isPrivate=isPrivate,!this._enableDataChannel){if(errorMsg="Unable to send any blob data. Datachannel is disabled",0===listOfPeers.length)transferErrors.self=errorMsg;else{for(i=0;i<listOfPeers.length;i++)peerId=listOfPeers[i],transferErrors[peerId]=errorMsg;1===listOfPeers.length&&isPrivate&&(stateError=self.DATA_TRANSFER_STATE.ERROR,singleError=errorMsg,singlePeerId=listOfPeers[0])}return errorPayload={state:stateError,error:singleError,transferId:transferId,peerId:singlePeerId,listOfPeers:listOfPeers,transferErrors:transferErrors,transferInfo:dataInfo,isPrivate:isPrivate},log.error(errorMsg,errorPayload),void("function"==typeof callback&&(log.log([null,"RTCDataChannel",null,"Error occurred. Firing callback with error -> "],errorPayload),callback(errorPayload,null)))}this._startDataTransfer(data,dataInfo,listOfPeers,callback)},Skylink.prototype._startDataTransfer=function(data,dataInfo,listOfPeers,callback){var i,peerId,self=this,error="",noOfPeersSent=0,transferId=dataInfo.transferId,dataType=dataInfo.dataType,isPrivate=dataInfo.isPrivate,listOfPeersTransferState={},transferSuccess=!0,listOfPeersTransferErrors={},listOfPeersChannels={},successfulPeerTransfers=[],triggerCallbackFn=function(){for(i=0;i<listOfPeers.length;i++){var transferPeerId=listOfPeers[i];if(!listOfPeersTransferState[transferPeerId]){transferSuccess=!1;break}}transferSuccess?(log.log([null,"RTCDataChannel",transferId,"Firing success callback for data transfer"],dataInfo),1===listOfPeers.length&&isPrivate?callback(null,{state:self.DATA_TRANSFER_STATE.UPLOAD_COMPLETED,peerId:listOfPeers[0],listOfPeers:listOfPeers,transferId:transferId,isPrivate:isPrivate,transferInfo:dataInfo}):callback(null,{state:null,peerId:null,transferId:transferId,listOfPeers:listOfPeers,isPrivate:isPrivate,transferInfo:dataInfo})):(log.log([null,"RTCDataChannel",transferId,"Firing failure callback for data transfer"],dataInfo),1===listOfPeers.length&&isPrivate?callback({state:self.DATA_TRANSFER_STATE.ERROR,error:listOfPeersTransferErrors[listOfPeers[0]],peerId:listOfPeers[0],transferId:transferId,transferErrors:listOfPeersTransferErrors,transferInfo:dataInfo,isPrivate:isPrivate,listOfPeers:listOfPeers},null):callback({state:null,peerId:null,error:null,transferId:transferId,listOfPeers:listOfPeers,isPrivate:isPrivate,transferInfo:dataInfo,transferErrors:listOfPeersTransferErrors},null))};for(i=0;i<listOfPeers.length;i++)peerId=listOfPeers[i],"MCU"!==peerId&&(self._dataChannels[peerId]&&self._dataChannels[peerId].main?(log.log([peerId,"RTCDataChannel",null,"Sending blob data ->"],dataInfo),self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOAD_STARTED,transferId,peerId,{name:dataInfo.name,size:dataInfo.size,percentage:0,data:data,dataType:dataType,senderPeerId:self._user.sid,timeout:dataInfo.timeout,isPrivate:isPrivate}),self._trigger("incomingDataRequest",transferId,peerId,{name:dataInfo.name,size:dataInfo.size,percentage:0,dataType:dataType,senderPeerId:self._user.sid,timeout:dataInfo.timeout,isPrivate:isPrivate},!0),listOfPeersChannels[peerId]=self._sendBlobDataToPeer(data,dataInfo,peerId),noOfPeersSent++):(error="Datachannel does not exist. Unable to start data transfer with peer",log.error([peerId,"RTCDataChannel",null,error]),listOfPeersTransferErrors[peerId]=error));if(0===noOfPeersSent){for(error="Failed sending data as there is no available datachannels to send data",i=0;i<listOfPeers.length;i++)peerId=listOfPeers[i],self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,transferId,peerId,{name:dataInfo.name,size:dataInfo.size,data:null,dataType:dataType,percentage:0,senderPeerId:self._user.sid,timeout:dataInfo.timeout,isPrivate:isPrivate},{message:error,transferType:self.DATA_TRANSFER_TYPE.UPLOAD}),listOfPeersTransferErrors[peerId]=error;return log.error([null,"RTCDataChannel",null,error]),self._uploadDataTransfers=[],self._uploadDataSessions=[],transferSuccess=!1,void("function"==typeof callback&&triggerCallbackFn())}if("function"==typeof callback){var dataChannelStateFn=function(state,transferringPeerId,errorObj,channelName,channelType){state===self.DATA_CHANNEL_STATE.ERROR&&state===self.DATA_CHANNEL_STATE.CLOSED&&listOfPeersChannels[peerId]===channelName&&-1===successfulPeerTransfers.indexOf(transferringPeerId)&&(listOfPeersTransferState[transferringPeerId]=!1,listOfPeersTransferErrors[transferringPeerId]=errorObj,log.error([transferringPeerId,"RTCDataChannel",null,"Data channel state has met a failure state for peer (datachannel) ->"],{state:state,error:errorObj})),Object.keys(listOfPeersTransferState).length===listOfPeers.length&&(self.off("dataTransferState",dataTransferStateFn),self.off("dataChannelState",dataChannelStateFn),log.log([null,"RTCDataChannel",transferId,"Transfer states have been gathered completely in dataChannelState"],state),triggerCallbackFn())},dataTransferStateFn=function(state,stateTransferId,transferringPeerId,transferInfo,errorObj){stateTransferId===transferId&&(state===self.DATA_TRANSFER_STATE.UPLOAD_COMPLETED?(log.debug([transferringPeerId,"RTCDataChannel",stateTransferId,"Data transfer state has met a success state for peer ->"],state),-1===successfulPeerTransfers.indexOf(transferringPeerId)&&(listOfPeersTransferState[transferringPeerId]=!0)):(state===self.DATA_TRANSFER_STATE.REJECTED||state===self.DATA_TRANSFER_STATE.CANCEL||state===self.DATA_TRANSFER_STATE.ERROR)&&(state===self.DATA_TRANSFER_STATE.REJECTED&&(errorObj=new Error("Peer has rejected data transfer request")),log.error([transferringPeerId,"RTCDataChannel",stateTransferId,"Data transfer state has met a failure state for peer ->"],{state:state,error:errorObj}),-1===successfulPeerTransfers.indexOf(transferringPeerId)&&(listOfPeersTransferState[transferringPeerId]=!1,listOfPeersTransferErrors[transferringPeerId]=errorObj))),Object.keys(listOfPeersTransferState).length===listOfPeers.length&&(self.off("dataTransferState",dataTransferStateFn),self.off("dataChannelState",dataChannelStateFn),log.log([null,"RTCDataChannel",stateTransferId,"Transfer states have been gathered completely in dataTransferState"],state),triggerCallbackFn())};self.on("dataTransferState",dataTransferStateFn),self.on("dataChannelState",dataChannelStateFn)}},Skylink.prototype.respondBlobRequest=Skylink.prototype.acceptDataTransfer=function(peerId,transferId,accept){if("string"!=typeof transferId&&"string"!=typeof peerId)return void log.error([peerId,"RTCDataChannel",null,"Aborting accept data transfer as transfer ID and peer ID is not provided"],{accept:accept,peerId:peerId,transferId:transferId});if(-1===transferId.indexOf(this._TRANSFER_DELIMITER))return void log.error([peerId,"RTCDataChannel",null,"Aborting accept data transfer as invalid transfer ID is provided"],{accept:accept,transferId:transferId});var channelName=transferId.split(this._TRANSFER_DELIMITER)[0];if(accept){if(log.info([peerId,"RTCDataChannel",channelName,"User accepted peer's request"],{accept:accept,transferId:transferId}),!this._peerInformations[peerId]&&!this._peerInformations[peerId].agent)return void log.error([peerId,"RTCDataChannel",channelName,"Aborting accept data transfer as Peer informations for peer is missing"],{accept:accept,transferId:transferId});this._downloadDataTransfers[channelName]=[];var data=this._downloadDataSessions[channelName];this._sendDataChannelMessage(peerId,{type:this._DC_PROTOCOL_TYPE.ACK,sender:this._user.sid,ackN:0,agent:window.webrtcDetectedBrowser},channelName),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.DOWNLOAD_STARTED,data.transferId,peerId,{name:data.name,size:data.size,data:null,dataType:data.dataType,percentage:0,senderPeerId:peerId,timeout:data.timeout,isPrivate:data.isPrivate})}else log.info([peerId,"RTCDataChannel",channelName,"User rejected peer's request"],{accept:accept,transferId:transferId}),this._sendDataChannelMessage(peerId,{type:this._DC_PROTOCOL_TYPE.ACK,sender:this._user.sid,ackN:-1},channelName),delete this._downloadDataSessions[channelName],delete this._downloadDataTransfers[channelName]},Skylink.prototype.cancelBlobTransfer=Skylink.prototype.cancelDataTransfer=function(peerId,transferId){var data,channelName=peerId+"-"+transferId;if(transferId.indexOf(this._TRANSFER_DELIMITER)>0)channelName=transferId.split(this._TRANSFER_DELIMITER)[0];else{var peerAgent=(this._peerInformations[peerId]||{}).agent;if(!peerAgent&&!peerAgent.name)return void log.error([peerId,"RTCDataChannel",null,"Cancel transfer to peer failed as peer agent information for peer does not exists"],transferId);self._INTEROP_MULTI_TRANSFERS.indexOf(peerAgent.name)>-1&&(channelName=peerId)}if(this._uploadDataSessions[channelName])data=this._uploadDataSessions[channelName],delete this._uploadDataSessions[channelName],delete this._uploadDataTransfers[channelName],this._sendDataChannelMessage(peerId,{type:this._DC_PROTOCOL_TYPE.CANCEL,sender:this._user.sid,name:data.name,content:"Peer cancelled upload transfer"},channelName),log.debug([peerId,"RTCDataChannel",channelName,"Cancelling upload data transfers"],transferId);else{if(!this._downloadDataSessions[channelName])return void log.error([peerId,"RTCDataChannel",null,"Cancel transfer to peer failed as transfer session with peer does not exists"],transferId);
data=this._downloadDataSessions[channelName],delete this._downloadDataSessions[channelName],delete this._downloadDataTransfers[channelName],this._sendDataChannelMessage(peerId,{type:this._DC_PROTOCOL_TYPE.CANCEL,sender:this._user.sid,name:data.name,content:"Peer cancelled download transfer"},channelName),log.debug([peerId,"RTCDataChannel",channelName,"Cancelling download data transfers"],transferId)}this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.CANCEL,data.transferId,peerId,{name:data.name,size:data.size,percentage:data.percentage,data:null,dataType:data.dataType,senderPeerId:data.senderPeerId,timeout:data.timeout,isPrivate:data.isPrivate})},Skylink.prototype.sendP2PMessage=function(message,targetPeerId){var self=this;if(!self._enableDataChannel)return void log.warn("Unable to send any P2P message. Datachannel is disabled");var listOfPeers=Object.keys(self._dataChannels),isPrivate=!1;Array.isArray(targetPeerId)?(listOfPeers=targetPeerId,isPrivate=!0):"string"==typeof targetPeerId&&(listOfPeers=[targetPeerId],isPrivate=!0),self._hasMCU&&!isPrivate&&(log.log(["MCU",null,null,"Relaying P2P message to peers"]),self._sendDataChannelMessage("MCU",{type:self._DC_PROTOCOL_TYPE.MESSAGE,isPrivate:isPrivate,sender:self._user.sid,target:"MCU",data:message}));for(var i=0;i<listOfPeers.length;i++){var peerId=listOfPeers[i],useChannel=self._hasMCU?"MCU":peerId;"MCU"!==peerId&&(isPrivate||!self._hasMCU)&&(self._hasMCU?log.log([peerId,null,useChannel,"Sending private P2P message to peer"]):log.log([peerId,null,useChannel,"Sending P2P message to peer"]),self._sendDataChannelMessage(useChannel,{type:self._DC_PROTOCOL_TYPE.MESSAGE,isPrivate:isPrivate,sender:self._user.sid,target:peerId,data:message}))}self._trigger("incomingMessage",{content:message,isPrivate:isPrivate,targetPeerId:targetPeerId||null,isDataChannel:!0,senderPeerId:self._user.sid},self._user.sid,self.getPeerInfo(),!0)},Skylink.prototype.sendURLData=function(data,timeout,targetPeerId,callback){var errorMsg,errorPayload,i,peerId,listOfPeers=Object.keys(this._peerConnections),isPrivate=!1,dataInfo={},transferId=this._user.sid+this.DATA_TRANSFER_TYPE.UPLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),singleError=null,transferErrors={},stateError=null,singlePeerId=null;if("function"==typeof timeout?callback=timeout:"string"==typeof timeout?(listOfPeers=[timeout],isPrivate=!0):Array.isArray(timeout)&&(listOfPeers=timeout,isPrivate=!0),"function"==typeof targetPeerId?callback=targetPeerId:Array.isArray(targetPeerId)?(listOfPeers=targetPeerId,isPrivate=!0):"string"==typeof targetPeerId&&(listOfPeers=[targetPeerId],isPrivate=!0),"string"!=typeof data){if(errorMsg="Provided data is not a dataURL",0===listOfPeers.length)transferErrors.self=errorMsg;else{for(i=0;i<listOfPeers.length;i++)peerId=listOfPeers[i],transferErrors[peerId]=errorMsg;1===listOfPeers.length&&isPrivate&&(stateError=self.DATA_TRANSFER_STATE.ERROR,singleError=errorMsg,singlePeerId=listOfPeers[0])}return errorPayload={state:stateError,error:singleError,transferId:transferId,peerId:singlePeerId,listOfPeers:listOfPeers,transferErrors:transferErrors,transferInfo:dataInfo,isPrivate:isPrivate},log.error(errorMsg,errorPayload),void("function"==typeof callback&&(log.log([null,"RTCDataChannel",null,"Error occurred. Firing callback with error -> "],errorPayload),callback(errorPayload,null)))}if(dataInfo.name=data.name||transferId,dataInfo.size=data.size||data.length,dataInfo.timeout="number"==typeof timeout?timeout:60,dataInfo.transferId=transferId,dataInfo.dataType="dataURL",dataInfo.isPrivate=isPrivate,!this._enableDataChannel){if(errorMsg="Unable to send any dataURL. Datachannel is disabled",0===listOfPeers.length)transferErrors.self=errorMsg;else{for(i=0;i<listOfPeers.length;i++)peerId=listOfPeers[i],transferErrors[peerId]=errorMsg;1===listOfPeers.length&&isPrivate&&(stateError=self.DATA_TRANSFER_STATE.ERROR,singleError=errorMsg,singlePeerId=listOfPeers[0])}return errorPayload={state:stateError,error:singleError,transferId:transferId,peerId:singlePeerId,listOfPeers:listOfPeers,transferErrors:transferErrors,transferInfo:dataInfo,isPrivate:isPrivate},log.error(errorMsg,errorPayload),void("function"==typeof callback&&(log.log([null,"RTCDataChannel",null,"Error occurred. Firing callback with error -> "],errorPayload),callback(errorPayload,null)))}this._startDataTransfer(data,dataInfo,listOfPeers,callback)},Skylink.prototype._peerCandidatesQueue={},Skylink.prototype._peerIceTrickleDisabled={},Skylink.prototype.CANDIDATE_GENERATION_STATE={NEW:"new",GATHERING:"gathering",COMPLETED:"completed"},Skylink.prototype._onIceCandidate=function(targetMid,event){if(event.candidate){if(this._enableIceTrickle&&!this._peerIceTrickleDisabled[targetMid]){var messageCan=event.candidate.candidate.split(" "),candidateType=messageCan[7];log.debug([targetMid,"RTCIceCandidate",null,"Created and sending "+candidateType+" candidate:"],event),this._sendChannelMessage({type:this._SIG_MESSAGE_TYPE.CANDIDATE,label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate,mid:this._user.sid,target:targetMid,rid:this._room.id})}}else if(log.debug([targetMid,"RTCIceCandidate",null,"End of gathering"]),this._trigger("candidateGenerationState",this.CANDIDATE_GENERATION_STATE.COMPLETED,targetMid),!this._enableIceTrickle||this._peerIceTrickleDisabled[targetMid]){var sessionDescription=this._peerConnections[targetMid].localDescription;this._sendChannelMessage({type:sessionDescription.type,sdp:sessionDescription.sdp,mid:this._user.sid,agent:window.webrtcDetectedBrowser,target:targetMid,rid:this._room.id})}},Skylink.prototype._addIceCandidateToQueue=function(targetMid,candidate){log.debug([targetMid,null,null,"Queued candidate to add after setRemoteDescription"],candidate),this._peerCandidatesQueue[targetMid]=this._peerCandidatesQueue[targetMid]||[],this._peerCandidatesQueue[targetMid].push(candidate)},Skylink.prototype._onAddIceCandidateSuccess=function(){log.debug([null,"RTCICECandidate",null,"Successfully added ICE candidate"])},Skylink.prototype._onAddIceCandidateFailure=function(error){log.error([null,"RTCICECandidate",null,"Error"],error)},Skylink.prototype._addIceCandidateFromQueue=function(targetMid){if(this._peerCandidatesQueue[targetMid]=this._peerCandidatesQueue[targetMid]||[],this._peerCandidatesQueue[targetMid].length>0){for(var i=0;i<this._peerCandidatesQueue[targetMid].length;i++){var candidate=this._peerCandidatesQueue[targetMid][i];log.debug([targetMid,null,null,"Added queued candidate"],candidate),this._peerConnections[targetMid].addIceCandidate(candidate,this._onAddIceCandidateSuccess,this._onAddIceCandidateFailure)}delete this._peerCandidatesQueue[targetMid]}else log.log([targetMid,null,null,"No queued candidates to add"])},Skylink.prototype.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",TRICKLE_FAILED:"trickleFailed",DISCONNECTED:"disconnected"},Skylink.prototype.TURN_TRANSPORT={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},Skylink.prototype._enableIceTrickle=!0,Skylink.prototype._enableSTUN=!0,Skylink.prototype._enableTURN=!0,Skylink.prototype._usePublicSTUN=!0,Skylink.prototype._TURNTransport="any",Skylink.prototype._ICEConnectionFailures={},Skylink.prototype._setIceServers=function(givenConfig){var givenIceServers=clone(givenConfig.iceServers),iceServersList={},newIceServers=[],useTURNSSLProtocol=!1,useTURNSSLPort=!1;("https:"===window.location.protocol||this._forceTURNSSL)&&("chrome"===window.webrtcDetectedBrowser||"safari"===window.webrtcDetectedBrowser||"IE"===window.webrtcDetectedBrowser?(useTURNSSLProtocol=!0,useTURNSSLPort=!1):useTURNSSLPort=!0),log.log("TURN server connections SSL configuration",{useTURNSSLProtocol:useTURNSSLProtocol,useTURNSSLPort:useTURNSSLPort});var i,pushIceServer=function(username,credential,url,index){iceServersList[username]||(iceServersList[username]={}),iceServersList[username][credential]||(iceServersList[username][credential]=[]),-1===iceServersList[username][credential].indexOf(url)&&("number"==typeof index?iceServersList[username][credential].splice(index,0,url):iceServersList[username][credential].push(url))};for(i=0;i<givenIceServers.length;i++){var server=givenIceServers[i];if("string"==typeof server.url){if(0===server.url.indexOf("stun")){if(!this._enableSTUN){log.warn("Ignoring STUN server provided at index "+i,clone(server));continue}if(!this._usePublicSTUN&&-1===server.url.indexOf("temasys")){log.warn("Ignoring public STUN server provided at index "+i,clone(server));continue}}else if(0===server.url.indexOf("turn")){if(!this._enableTURN){log.warn("Ignoring TURN server provided at index "+i,clone(server));continue}if(-1===server.url.indexOf(":443")&&useTURNSSLPort){log.log("Ignoring TURN Server (non-SSL port) provided at index "+i,clone(server));continue}if(useTURNSSLProtocol){var parts=server.url.split(":");parts[0]="turns",server.url=parts.join(":")}}if(server.url.indexOf("@")>0){var protocolParts=server.url.split(":"),urlParts=protocolParts[1].split("@");server.username=urlParts[0],server.url=protocolParts[0]+":"+urlParts[1],protocolParts[2]&&(server.url+=":"+protocolParts[2])}var username="string"==typeof server.username?server.username:"none",credential="string"==typeof server.credential?server.credential:"none";if(0===server.url.indexOf("turn"))if(this._TURNTransport===this.TURN_TRANSPORT.ANY)pushIceServer(username,credential,server.url);else{var rawUrl=server.url;if(rawUrl.indexOf("?transport=")>0&&(rawUrl=rawUrl.split("?transport=")[0]),this._TURNTransport===this.TURN_TRANSPORT.NONE)pushIceServer(username,credential,rawUrl);else if(this._TURNTransport===this.TURN_TRANSPORT.UDP)pushIceServer(username,credential,rawUrl+"?transport=udp");else if(this._TURNTransport===this.TURN_TRANSPORT.TCP)pushIceServer(username,credential,rawUrl+"?transport=tcp");else{if(this._TURNTransport!==this.TURN_TRANSPORT.ALL){log.warn('Invalid TURN transport option "'+this._TURNTransport+'". Ignoring TURN server at index'+i,clone(server));continue}pushIceServer(username,credential,rawUrl+"?transport=tcp"),pushIceServer(username,credential,rawUrl+"?transport=udp")}}else pushIceServer(username,credential,server.url)}else log.warn("Ignoring ICE server provided at index "+i,clone(server))}this._enableSTUN&&this._usePublicSTUN&&"firefox"===window.webrtcDetectedBrowser&&pushIceServer("none","none","stun:stun.services.mozilla.com",0);var hasUrlsSupport=!1;"chrome"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion>34&&(hasUrlsSupport=!0),"firefox"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion>38&&(hasUrlsSupport=!0),"opera"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion>31&&(hasUrlsSupport=!0),("safari"===window.webrtcDetectedBrowser||"IE"===window.webrtcDetectedBrowser)&&(hasUrlsSupport=!0);for(var serverUsername in iceServersList)if(iceServersList.hasOwnProperty(serverUsername))for(var serverCred in iceServersList[serverUsername])if(iceServersList[serverUsername].hasOwnProperty(serverCred))if(hasUrlsSupport){var urlsItem={urls:iceServersList[serverUsername][serverCred]};"none"!==serverUsername&&(urlsItem.username=serverUsername),"none"!==serverCred&&(urlsItem.credential=serverCred),newIceServers.push(urlsItem)}else for(var j=0;j<iceServersList[serverUsername][serverCred].length;j++){var urlItem={url:iceServersList[serverUsername][serverCred][j]};"none"!==serverUsername&&(urlItem.username=serverUsername),"none"!==serverCred&&(urlItem.credential=serverCred),newIceServers.push(urlItem)}return log.log("Output iceServers configuration:",newIceServers),{iceServers:newIceServers}},Skylink.prototype.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed"},Skylink.prototype.SERVER_PEER_TYPE={MCU:"mcu"},Skylink.prototype._lastRestart=null,Skylink.prototype._retryCount=0,Skylink.prototype._peerConnections={},Skylink.prototype._peerRestartPriorities={},Skylink.prototype._addPeer=function(targetMid,peerBrowser,toOffer,restartConn,receiveOnly,isSS){var self=this;if(self._peerConnections[targetMid]&&!restartConn)return void log.error([targetMid,null,null,"Connection to peer has already been made"]);if(log.log([targetMid,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:peerBrowser,toOffer:toOffer,receiveOnly:receiveOnly,enableDataChannel:self._enableDataChannel}),log.info("Adding peer",isSS),restartConn||(self._peerConnections[targetMid]=self._createPeerConnection(targetMid,!!isSS)),!self._peerConnections[targetMid])return void log.error([targetMid,null,null,"Failed creating the connection to peer"]);if(self._peerConnections[targetMid].receiveOnly=!!receiveOnly,self._peerConnections[targetMid].hasScreen=!!isSS,receiveOnly||self._addLocalMediaStreams(targetMid),toOffer){if(self._enableDataChannel){if("object"!=typeof self._dataChannels[targetMid])return void log.error([targetMid,"RTCDataChannel",null,"Create offer error as unable to create datachannel as datachannels array is undefined"],self._dataChannels[targetMid]);self._dataChannels[targetMid].main=self._createDataChannel(targetMid,self.DATA_CHANNEL_TYPE.MESSAGING,null,targetMid),self._peerConnections[targetMid].hasMainChannel=!0}self._doOffer(targetMid,peerBrowser)}return self._hasMCU?void log.warn([targetMid,"PeerConnectionHealth",null,"Not setting health timer for MCU connection"]):void this._startPeerConnectionHealthCheck(targetMid,toOffer)},Skylink.prototype._restartPeerConnection=function(peerId,isSelfInitiatedRestart,isConnectionRestart,callback,explicit){var self=this;if(!self._peerConnections[peerId])return void log.error([peerId,null,null,"Peer does not have an existing connection. Unable to restart"]);log.log([peerId,null,null,"Restarting a peer connection"]);var receiveOnly=self._peerConnections[peerId]?!!self._peerConnections[peerId].receiveOnly:!1,hasScreenSharing=self._peerConnections[peerId]?!!self._peerConnections[peerId].hasScreen:!1,iceConnectionStateClosed=!1,peerConnectionStateClosed=!1;!self._enableDataChannel;self._peerConnections[peerId].dataChannelClosed=!0,self.once("iceConnectionState",function(){iceConnectionStateClosed=!0},function(state,currentPeerId){return state===self.ICE_CONNECTION_STATE.CLOSED&&peerId===currentPeerId}),self.once("peerConnectionState",function(){peerConnectionStateClosed=!0},function(state,currentPeerId){return state===self.PEER_CONNECTION_STATE.CLOSED&&peerId===currentPeerId}),delete self._peerConnectionHealth[peerId],delete self._peerRestartPriorities[peerId],self._stopPeerConnectionHealthCheck(peerId),"closed"!==self._peerConnections[peerId].signalingState&&self._peerConnections[peerId].close(),self._peerConnections[peerId].hasStream&&self._trigger("streamEnded",peerId,self.getPeerInfo(peerId),!1),self._wait(function(){log.log([peerId,null,null,"Ice and peer connections closed"]),delete self._peerConnections[peerId],log.log([peerId,null,null,"Re-creating peer connection"]),self._peerConnections[peerId]=self._createPeerConnection(peerId,!!hasScreenSharing),setTimeout(function(){if(self._peerConnections[peerId]&&(self._peerConnections[peerId].receiveOnly=receiveOnly,self._peerConnections[peerId].hasScreen=hasScreenSharing),receiveOnly||self._addLocalMediaStreams(peerId),isSelfInitiatedRestart){log.log([peerId,null,null,"Sending restart message to signaling server"]);var lastRestart=Date.now()||function(){return+new Date},weight=(new Date).valueOf();self._peerRestartPriorities[peerId]=weight,self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.RESTART,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,os:window.navigator.platform,userInfo:self.getPeerInfo(),target:peerId,isConnectionRestart:!!isConnectionRestart,lastRestart:lastRestart,weight:weight,receiveOnly:receiveOnly,enableIceTrickle:self._enableIceTrickle,enableDataChannel:self._enableDataChannel,sessionType:self._mediaScreen?"screensharing":"stream",explicit:!!explicit})}self._trigger("peerRestart",peerId,self.getPeerInfo(peerId),!0),"function"==typeof callback&&(log.debug([peerId,"RTCPeerConnection",null,"Firing restart callback"]),callback())},1e3)},function(){return iceConnectionStateClosed&&peerConnectionStateClosed})},Skylink.prototype._removePeer=function(peerId){var peerInfo=clone(this.getPeerInfo(peerId))||{userData:"",settings:{},mediaStatus:{},agent:{},room:clone(this._selectedRoom)};"MCU"!==peerId?this._trigger("peerLeft",peerId,peerInfo,!1):(this._hasMCU=!1,log.log([peerId,null,null,"MCU has stopped listening and left"]),this._trigger("serverPeerLeft",peerId,this.SERVER_PEER_TYPE.MCU)),this._stopPeerConnectionHealthCheck(peerId),"undefined"!=typeof this._peerConnections[peerId]&&(this._peerConnections[peerId].dataChannelClosed=!0,"closed"!==this._peerConnections[peerId].signalingState&&this._peerConnections[peerId].close(),this._peerConnections[peerId].hasStream&&this._trigger("streamEnded",peerId,this.getPeerInfo(peerId),!1),delete this._peerConnections[peerId]),"undefined"!=typeof this._peerHSPriorities[peerId]&&delete this._peerHSPriorities[peerId],"undefined"!=typeof this._peerRestartPriorities[peerId]&&delete this._peerRestartPriorities[peerId],"undefined"!=typeof this._peerInformations[peerId]&&delete this._peerInformations[peerId],"undefined"!=typeof this._peerConnectionHealth[peerId]&&delete this._peerConnectionHealth[peerId],this._enableDataChannel&&this._closeDataChannel(peerId),log.log([peerId,null,null,"Successfully removed peer"])},Skylink.prototype._createPeerConnection=function(targetMid,isScreenSharing){var pc,self=this,newRTCPeerConnection=window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.RTCPeerConnection;try{pc=new newRTCPeerConnection(self._room.connection.peerConfig,self._room.connection.peerConstraints),log.info([targetMid,null,null,"Created peer connection"]),log.debug([targetMid,null,null,"Peer connection config:"],self._room.connection.peerConfig),log.debug([targetMid,null,null,"Peer connection constraints:"],self._room.connection.peerConstraints)}catch(error){return log.error([targetMid,null,null,"Failed creating peer connection:"],error),null}return pc.setOffer="",pc.setAnswer="",pc.hasStream=!1,pc.hasScreen=!!isScreenSharing,pc.hasMainChannel=!1,self._dataChannels[targetMid]={},pc.ondatachannel=function(event){var dc=event.channel||event;if(log.debug([targetMid,"RTCDataChannel",dc.label,"Received datachannel ->"],dc),self._enableDataChannel){var channelType=self.DATA_CHANNEL_TYPE.DATA,channelKey=dc.label;pc.hasMainChannel||(channelType=self.DATA_CHANNEL_TYPE.MESSAGING,channelKey="main",pc.hasMainChannel=!0),self._dataChannels[targetMid][channelKey]=self._createDataChannel(targetMid,channelType,dc,dc.label)}else log.warn([targetMid,"RTCDataChannel",dc.label,"Not adding datachannel as enable datachannel is set to false"])},pc.onaddstream=function(event){pc.hasStream=!0,self._onRemoteStreamAdded(targetMid,event,!!pc.hasScreen)},pc.onicecandidate=function(event){log.debug([targetMid,"RTCIceCandidate",null,"Ice candidate generated ->"],event.candidate),self._onIceCandidate(targetMid,event)},pc.oniceconnectionstatechange=function(evt){checkIceConnectionState(targetMid,pc.iceConnectionState,function(iceConnectionState){log.debug([targetMid,"RTCIceConnectionState",null,"Ice connection state changed ->"],iceConnectionState),self._trigger("iceConnectionState",iceConnectionState,targetMid),iceConnectionState===self.ICE_CONNECTION_STATE.COMPLETED&&pc.signalingState===self.PEER_CONNECTION_STATE.STABLE&&(log.debug([targetMid,"PeerConnectionHealth",null,"Peer connection with user is stable"]),self._peerConnectionHealth[targetMid]=!0,self._stopPeerConnectionHealthCheck(targetMid),self._retryCount=0),"undefined"==typeof self._ICEConnectionFailures[targetMid]&&(self._ICEConnectionFailures[targetMid]=0),self._ICEConnectionFailures[targetMid]>2&&(self._peerIceTrickleDisabled[targetMid]=!0),iceConnectionState===self.ICE_CONNECTION_STATE.FAILED&&(self._ICEConnectionFailures[targetMid]+=1,self._enableIceTrickle&&!self._peerIceTrickleDisabled[targetMid]&&self._trigger("iceConnectionState",self.ICE_CONNECTION_STATE.TRICKLE_FAILED,targetMid),self._hasMCU||self._restartPeerConnection(targetMid,!0,!0,null,!1))})},pc.onsignalingstatechange=function(){log.debug([targetMid,"RTCSignalingState",null,"Peer connection state changed ->"],pc.signalingState),self._trigger("peerConnectionState",pc.signalingState,targetMid),pc.iceConnectionState!==self.ICE_CONNECTION_STATE.COMPLETED&&pc.iceConnectionState!==self.ICE_CONNECTION_STATE.CONNECTED||pc.signalingState!==self.PEER_CONNECTION_STATE.STABLE||(log.debug([targetMid,"PeerConnectionHealth",null,"Peer connection with user is stable"]),self._peerConnectionHealth[targetMid]=!0,self._stopPeerConnectionHealthCheck(targetMid),self._retryCount=0)},pc.onicegatheringstatechange=function(){log.log([targetMid,"RTCIceGatheringState",null,"Ice gathering state changed ->"],pc.iceGatheringState),self._trigger("candidateGenerationState",pc.iceGatheringState,targetMid)},pc},Skylink.prototype.refreshConnection=function(targetPeerId,callback){var self=this,listOfPeers=Object.keys(self._peerConnections),listOfPeerRestarts=[],error="",listOfPeerRestartErrors={};if(Array.isArray(targetPeerId)?listOfPeers=targetPeerId:"string"==typeof targetPeerId?listOfPeers=[targetPeerId]:"function"==typeof targetPeerId&&(callback=targetPeerId),0===listOfPeers.length)return error="There is currently no peer connections to restart",log.warn([null,"PeerConnection",null,error]),listOfPeerRestartErrors.self=new Error(error),void("function"==typeof callback&&callback({refreshErrors:listOfPeerRestartErrors,listOfPeers:listOfPeers},null));var refreshSinglePeerCallback=function(peerId){return function(error,success){-1===listOfPeerRestarts.indexOf(peerId)&&(error&&(log.error([peerId,"RTCPeerConnection",null,"Failed restarting for peer"],error),listOfPeerRestartErrors[peerId]=error),listOfPeerRestarts.push(peerId)),listOfPeerRestarts.length===listOfPeers.length&&"function"==typeof callback&&(log.log([null,"PeerConnection",null,"Invoked all peers to restart. Firing callback"]),Object.keys(listOfPeerRestartErrors).length>0?callback({refreshErrors:listOfPeerRestartErrors,listOfPeers:listOfPeers},null):callback(null,{listOfPeers:listOfPeers}))}},refreshSinglePeer=function(peerId,peerCallback){if(!self._peerConnections[peerId])return error="There is currently no existing peer connection made with the peer. Unable to restart connection",log.error([peerId,null,null,error]),void(listOfPeerRestartErrors[peerId]=new Error(error));var now=Date.now()||function(){return+new Date};return now-self.lastRestart<3e3?(error="Last restart was so tight. Aborting.",log.error([peerId,null,null,error]),void(listOfPeerRestartErrors[peerId]=new Error(error))):(log.log([peerId,"PeerConnection",null,"Restarting peer connection"]),void self._restartPeerConnection(peerId,!0,!1,peerCallback,!0))},toRefresh=function(){if(self._hasMCU)self._restartMCUConnection(callback);else{var i;for(i=0;i<listOfPeers.length;i++){var peerId=listOfPeers[i];Object.keys(self._peerConnections).indexOf(peerId)>-1?refreshSinglePeer(peerId,refreshSinglePeerCallback(peerId)):(error="Peer connection with peer does not exists. Unable to restart",log.error([peerId,"PeerConnection",null,error]),listOfPeerRestartErrors[peerId]=new Error(error)),i===listOfPeers.length-1&&Object.keys(listOfPeerRestartErrors).length>0&&"function"==typeof callback&&callback({refreshErrors:listOfPeerRestartErrors,listOfPeers:listOfPeers},null)}}};self._throttle(toRefresh,5e3)()},Skylink.prototype._restartMCUConnection=function(callback){var self=this;log.info([self._user.sid,null,null,"Restarting with MCU enabled"]);var peerId,listOfPeers=Object.keys(self._peerConnections),listOfPeerRestartErrors={},receiveOnly=!1,lastRestart=Date.now()||function(){return+new Date},weight=(new Date).valueOf();self._trigger("serverPeerRestart","MCU",self.SERVER_PEER_TYPE.MCU);for(var i=0;i<listOfPeers.length;i++)if(peerId=listOfPeers[i],self._peerConnections[peerId])"MCU"===peerId&&(receiveOnly=!!self._peerConnections[peerId].receiveOnly),"MCU"!==peerId&&(self._trigger("peerRestart",peerId,self.getPeerInfo(peerId),!0),log.log([peerId,null,null,"Sending restart message to signaling server"]),self._peerRestartPriorities[peerId]=weight,self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.RESTART,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,os:window.navigator.platform,userInfo:self.getPeerInfo(),target:peerId,isConnectionRestart:!1,lastRestart:lastRestart,weight:weight,receiveOnly:receiveOnly,enableIceTrickle:self._enableIceTrickle,enableDataChannel:self._enableDataChannel,sessionType:self._mediaScreen?"screensharing":"stream",explicit:!0}));else{var error="Peer connection with peer does not exists. Unable to restart";log.error([peerId,"PeerConnection",null,error]),listOfPeerRestartErrors[peerId]=new Error(error)}var peerJoinedFn=function(peerId,peerInfo,isSelf){log.log([null,"PeerConnection",null,"Invoked all peers to restart with MCU. Firing callback"]),"function"==typeof callback&&(Object.keys(listOfPeerRestartErrors).length>0?callback({refreshErrors:listOfPeerRestartErrors,listOfPeers:listOfPeers},null):callback(null,{listOfPeers:listOfPeers}))};self.once("peerJoined",peerJoinedFn,function(peerId,peerInfo,isSelf){return isSelf}),self.leaveRoom(!1,function(error,success){if(error){if("function"==typeof callback){for(var i=0;i<listOfPeers.length;i++)listOfPeerRestartErrors[listOfPeers[i]]=error;callback({refreshErrors:listOfPeerRestartErrors,listOfPeers:listOfPeers},null)}}else self.joinRoom(self._selectedRoom)})},Skylink.prototype._peerInformations={},Skylink.prototype._user=null,Skylink.prototype._userData="",Skylink.prototype.setUserData=function(userData){var self=this;self._parseUserData(userData),self._inRoom?(log.log("Updated userData -> ",userData),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.UPDATE_USER,mid:self._user.sid,rid:self._room.id,userData:self._userData}),self._trigger("peerUpdated",self._user.sid,self.getPeerInfo(),!0)):log.warn("User is not in the room. Broadcast of updated information will be dropped")},Skylink.prototype.getUserData=function(peerId){if(peerId&&peerId!==this._user.sid){var peerInfo=this._peerInformations[peerId];return"object"==typeof peerInfo?peerInfo.userData:null}return this._userData},Skylink.prototype._parseUserData=function(userData){log.debug("Parsing user data:",userData),this._userData=userData||""},Skylink.prototype.getPeerInfo=function(peerId){var isNotSelf=this._user&&this._user.sid?peerId!==this._user.sid:!1;if("string"==typeof peerId&&isNotSelf){var peerInfo=this._peerInformations[peerId];return"object"==typeof peerInfo?peerInfo:null}var mediaSettings={};return this._mediaScreen&&null!==this._mediaScreen?(mediaSettings=clone(this._screenSharingStreamSettings),mediaSettings.bandwidth=clone(this._streamSettings.bandwidth)):mediaSettings=clone(this._streamSettings),{userData:clone(this._userData)||"",settings:mediaSettings||{},mediaStatus:clone(this._mediaStreamsStatus)||{},agent:{name:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion},room:clone(this._selectedRoom)}},Skylink.prototype.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ERROR:"error"},Skylink.prototype._peerConnectionHealthTimers={},Skylink.prototype._peerConnectionHealth={},Skylink.prototype._peerHSPriorities={},Skylink.prototype._doOffer=function(targetMid,peerBrowser){var self=this,pc=self._peerConnections[targetMid]||self._addPeer(targetMid,peerBrowser);log.log([targetMid,null,null,"Checking caller status"],peerBrowser);var inputConstraints=self._room.connection.offerConstraints,sc=self._room.connection.sdpConstraints;for(var name in sc.mandatory)sc.mandatory.hasOwnProperty(name)&&(inputConstraints.mandatory[name]=sc.mandatory[name]);inputConstraints.optional.concat(sc.optional),checkMediaDataChannelSettings(peerBrowser.agent,peerBrowser.version,function(beOfferer,unifiedOfferConstraints){"moz"===window.webrtcDetectedType&&"MCU"===peerBrowser.agent&&(unifiedOfferConstraints.mandatory=unifiedOfferConstraints.mandatory||{},unifiedOfferConstraints.mandatory.MozDontOfferDataChannel=!0,beOfferer=!0),peerBrowser.os=peerBrowser.os||"","firefox"===window.webrtcDetectedBrowser&&0===window.navigator.platform.indexOf("Win")&&"firefox"!==peerBrowser.agent&&0===peerBrowser.os.indexOf("Mac")&&(beOfferer=!1),beOfferer?("firefox"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion>=32&&(unifiedOfferConstraints={offerToReceiveAudio:!0,offerToReceiveVideo:!0}),log.debug([targetMid,null,null,"Creating offer with config:"],unifiedOfferConstraints),pc.createOffer(function(offer){log.debug([targetMid,null,null,"Created offer"],offer),self._setLocalAndSendMessage(targetMid,offer)},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error),log.error([targetMid,null,null,"Failed creating an offer:"],error)},unifiedOfferConstraints)):(log.debug([targetMid,null,null,"User's browser is not eligible to create the offer to the other peer. Requesting other peer to create the offer instead"],peerBrowser),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.WELCOME,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,os:window.navigator.platform,userInfo:self.getPeerInfo(),target:targetMid,weight:-1,sessionType:self._mediaScreen?"screensharing":"stream"}))},inputConstraints)},Skylink.prototype._doAnswer=function(targetMid){var self=this;log.log([targetMid,null,null,"Creating answer with config:"],self._room.connection.sdpConstraints);var pc=self._peerConnections[targetMid];return pc?void pc.createAnswer(function(answer){log.debug([targetMid,null,null,"Created answer"],answer),self._setLocalAndSendMessage(targetMid,answer)},function(error){log.error([targetMid,null,null,"Failed creating an answer:"],error),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error)}):void log.error([targetMid,null,null,"Requested to create an answer but user does not have any existing connection to peer"])},Skylink.prototype._startPeerConnectionHealthCheck=function(peerId,toOffer){var self=this,timer=self._enableIceTrickle&&!self._peerIceTrickleDisabled[peerId]?toOffer?12500:1e4:5e4;timer=self._hasMCU?105e3:timer,timer+=1e4*self._retryCount,log.log([peerId,"PeerConnectionHealth",null,"Initializing check for peer's connection health"]),self._peerConnectionHealthTimers[peerId]&&self._stopPeerConnectionHealthCheck(peerId),self._peerConnectionHealthTimers[peerId]=setTimeout(function(){self._peerConnectionHealth[peerId]||(log.warn([peerId,"PeerConnectionHealth",null,"Peer's health timer has expired"],1e4),self._stopPeerConnectionHealthCheck(peerId),log.debug([peerId,"PeerConnectionHealth",null,"Ice connection state time out. Re-negotiating connection"]),self._retryCount<30&&self._retryCount++,self._hasMCU?self._restartMCUConnection():self._restartPeerConnection(peerId,!0,!0,null,!1))},timer)},Skylink.prototype._stopPeerConnectionHealthCheck=function(peerId){var self=this;self._peerConnectionHealthTimers[peerId]?(log.debug([peerId,"PeerConnectionHealth",null,"Stopping peer connection health timer check"]),clearTimeout(self._peerConnectionHealthTimers[peerId]),delete self._peerConnectionHealthTimers[peerId]):log.debug([peerId,"PeerConnectionHealth",null,"Peer connection health does not have a timer check"])},Skylink.prototype._setLocalAndSendMessage=function(targetMid,sessionDescription){var self=this,pc=self._peerConnections[targetMid];if(sessionDescription.type===self.HANDSHAKE_PROGRESS.ANSWER&&pc.setAnswer)return void log.log([targetMid,"RTCSessionDescription",sessionDescription.type,"Ignoring session description. User has already set local answer"],sessionDescription);
if(sessionDescription.type===self.HANDSHAKE_PROGRESS.OFFER&&pc.setOffer)return void log.log([targetMid,"RTCSessionDescription",sessionDescription.type,"Ignoring session description. User has already set local offer"],sessionDescription);var sdpLines=sessionDescription.sdp.split("\r\n");if(sdpLines=self._removeSDPFirefoxH264Pref(sdpLines),self._streamSettings.hasOwnProperty("audio")&&self._streamSettings.audio.stereo&&self._addSDPStereo(sdpLines),log.info([targetMid,null,null,"Requested stereo:"],self._streamSettings.audio&&self._streamSettings.audio.stereo?self._streamSettings.audio.stereo:!1),self._streamSettings.hasOwnProperty("bandwidth")){var peerSettings=(self._peerInformations[targetMid]||{}).settings||{};sdpLines=self._setSDPBitrate(sdpLines,peerSettings)}self._streamSettings.bandwidth=self._streamSettings.bandwidth||{},self._streamSettings.video=self._streamSettings.video||!1,log.info([targetMid,null,null,"Custom bandwidth settings:"],{audio:(self._streamSettings.bandwidth.audio||"Not set")+" kB/s",video:(self._streamSettings.bandwidth.video||"Not set")+" kB/s",data:(self._streamSettings.bandwidth.data||"Not set")+" kB/s"}),self._streamSettings.video.hasOwnProperty("frameRate")&&self._streamSettings.video.hasOwnProperty("resolution")&&log.info([targetMid,null,null,"Custom resolution settings:"],{frameRate:(self._streamSettings.video.frameRate||"Not set")+" fps",width:(self._streamSettings.video.resolution.width||"Not set")+" px",height:(self._streamSettings.video.resolution.height||"Not set")+" px"}),self._selectedVideoCodec!==self.VIDEO_CODEC.AUTO?sdpLines=self._setSDPVideoCodec(sdpLines):log.log([targetMid,null,null,"Not setting any video codec"]),self._selectedAudioCodec!==self.AUDIO_CODEC.AUTO?sdpLines=self._setSDPAudioCodec(sdpLines):log.log([targetMid,null,null,"Not setting any audio codec"]),sessionDescription.sdp=sdpLines.join("\r\n"),log.log([targetMid,"RTCSessionDescription",sessionDescription.type,"Updated session description:"],sessionDescription),pc.setLocalDescription(sessionDescription,function(){log.debug([targetMid,sessionDescription.type,"Local description set"]),self._trigger("handshakeProgress",sessionDescription.type,targetMid),sessionDescription.type===self.HANDSHAKE_PROGRESS.ANSWER?pc.setAnswer="local":pc.setOffer="local",self._enableIceTrickle&&!self._peerIceTrickleDisabled[targetMid]?self._sendChannelMessage({type:sessionDescription.type,sdp:sessionDescription.sdp,mid:self._user.sid,target:targetMid,rid:self._room.id}):log.log([targetMid,"RTCSessionDescription",sessionDescription.type,"Waiting for Ice gathering to complete to prevent Ice trickle"])},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error),log.error([targetMid,"RTCSessionDescription",sessionDescription.type,"Failed setting local description: "],error)})},Skylink.prototype.GET_PEERS_STATE={ENQUIRED:"enquired",RECEIVED:"received"},Skylink.prototype.INTRODUCE_STATE={INTRODUCING:"introducing",ERROR:"error"},Skylink.prototype._autoIntroduce=!0,Skylink.prototype._isPrivileged=!1,Skylink.prototype._parentKey=null,Skylink.prototype._peerList=null,Skylink.prototype.getPeers=function(showAll,callback){var self=this;return self._isPrivileged?self._appKey?self._parentKey?("function"==typeof showAll&&(callback=showAll,showAll=!1),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.GET_PEERS,privilegedKey:self._appKey,parentKey:self._parentKey,showAll:showAll||!1}),self._trigger("getPeersStateChange",self.GET_PEERS_STATE.ENQUIRED,self._user.sid,null),log.log("Enquired server for peers within the realm"),void("function"==typeof callback&&self.once("getPeersStateChange",function(state,privilegedPeerId,peerList){callback(null,peerList)},function(state,privilegedPeerId,peerList){return state===self.GET_PEERS_STATE.RECEIVED}))):void log.warn("Parent key is not defined. Please authenticate again."):void log.warn("App key is not defined. Please authenticate again."):void log.warn("Please upgrade your key to privileged to use this function")},Skylink.prototype.introducePeer=function(sendingPeerId,receivingPeerId){var self=this;return self._isPrivileged?(self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.INTRODUCE,sendingPeerId:sendingPeerId,receivingPeerId:receivingPeerId}),self._trigger("introduceStateChange",self.INTRODUCE_STATE.INTRODUCING,self._user.sid,sendingPeerId,receivingPeerId,null),void log.log("Introducing",sendingPeerId,"to",receivingPeerId)):(log.warn("Please upgrade your key to privileged to use this function"),void self._trigger("introduceStateChange",self.INTRODUCE_STATE.ERROR,self._user.sid,sendingPeerId,receivingPeerId,"notPrivileged"))},Skylink.prototype.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject"},Skylink.prototype.SYSTEM_ACTION_REASON={ROOM_LOCKED:"locked",DUPLICATED_LOGIN:"duplicatedLogin",SERVER_ERROR:"serverError",EXPIRED:"expired",ROOM_CLOSED:"roomclose",ROOM_CLOSING:"toclose"},Skylink.prototype._selectedRoom=null,Skylink.prototype._roomLocked=!1,Skylink.prototype._inRoom=!1,Skylink.prototype.joinRoom=function(room,mediaOptions,callback){var error,self=this,stopStream=!1;if("string"==typeof room){if("function"==typeof mediaOptions)callback=mediaOptions,mediaOptions=void 0;else if(null===mediaOptions||"object"!=typeof mediaOptions&&"undefined"!=typeof mediaOptions)return error="Invalid mediaOptions is provided",log.error(error,mediaOptions),void("function"==typeof callback&&callback({room:room,errorCode:self._readyState,error:new Error(error)},null))}else if("object"==typeof room){if("function"==typeof mediaOptions?(callback=mediaOptions,mediaOptions=room,room=void 0):mediaOptions=room,null===mediaOptions)return error="Invalid mediaOptions is provided",log.error(error,mediaOptions),void("function"==typeof callback&&callback({room:self._defaultRoom,errorCode:self._readyState,error:new Error(error)},null))}else if("function"==typeof room)callback=room,room=void 0,mediaOptions=void 0;else if(null===room)return error="Invalid room name is provided",log.error(error,room),void("function"==typeof callback&&callback({room:room,errorCode:self._readyState,error:new Error(error)},null));room||(room=self._defaultRoom);var channelCallback=function(error,success){error?"function"==typeof callback&&callback({error:error,errorCode:null,room:self._selectedRoom},null):("function"==typeof callback&&self.once("peerJoined",function(peerId,peerInfo,isSelf){self._wait(function(){log.log([null,"Socket",self._selectedRoom,"Peer joined. Firing callback. PeerId ->"],peerId),callback(null,{room:self._selectedRoom,peerId:peerId,peerInfo:peerInfo})},function(){return self._inRoom},!1)},function(peerId,peerInfo,isSelf){return isSelf},!1),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.JOIN_ROOM,uid:self._user.uid,cid:self._key,rid:self._room.id,userCred:self._user.token,timeStamp:self._user.timeStamp,apiOwner:self._appKeyOwner,roomCred:self._room.token,start:self._room.startDateTime,len:self._room.duration,isPrivileged:self._isPrivileged===!0,autoIntroduce:self._autoIntroduce!==!1}))};if(self._channelOpen)"object"==typeof mediaOptions&&mediaOptions.audio===!1&&mediaOptions.video===!1&&(stopStream=!0,log.warn([null,"MediaStream",self._selectedRoom,"Stopping current MediaStream as provided settings for audio and video is false ("+stopStream+")"],mediaOptions)),self.leaveRoom(stopStream,function(){log.log([null,"Socket",self._selectedRoom,"Joining room. Media options:"],mediaOptions),("string"==typeof room?room===self._selectedRoom:1)?self._waitForOpenChannel(mediaOptions,channelCallback):self._initSelectedRoom(room,function(errorObj){errorObj?"function"==typeof callback&&callback({room:self._selectedRoom,errorCode:self._readyState,error:new Error(errorObj)},null):self._waitForOpenChannel(mediaOptions,channelCallback)})});else{log.log([null,"Socket",self._selectedRoom,"Joining room. Media options:"],mediaOptions);var isNotSameRoom="string"==typeof room?room!==self._selectedRoom:!1;isNotSameRoom?self._initSelectedRoom(room,function(errorObj){errorObj?"function"==typeof callback&&callback({room:self._selectedRoom,errorCode:self._readyState,error:new Error(errorObj)},null):self._waitForOpenChannel(mediaOptions,channelCallback)}):self._waitForOpenChannel(mediaOptions,channelCallback)}},Skylink.prototype._waitForOpenChannel=function(mediaOptions,callback){var self=this;self._socketCurrentReconnectionAttempt=0,self._wait(function(){self._condition("channelOpen",function(){mediaOptions=mediaOptions||{},self._parseUserData(mediaOptions.userData||self._userData),self._parseBandwidthSettings(mediaOptions.bandwidth),self._waitForLocalMediaStream(callback,mediaOptions)},function(){return self._channelOpen||self._openChannel(),self._channelOpen},function(state){return!0})},function(){return self._readyState===self.READY_STATE_CHANGE.COMPLETED})},Skylink.prototype.leaveRoom=function(stopMediaOptions,callback){var error,self=this,stopUserMedia=!0,stopScreenshare=!0;if("function"==typeof stopMediaOptions?(callback=stopMediaOptions,stopMediaOptions=!0):"undefined"==typeof stopMediaOptions&&(stopMediaOptions=!0),"object"==typeof stopMediaOptions&&null!==stopMediaOptions)stopUserMedia=stopMediaOptions.userMedia!==!1,stopScreenshare=stopMediaOptions.screenshare!==!1;else{if("boolean"!=typeof stopMediaOptions)return error="stopMediaOptions parameter provided is not a boolean or valid object",log.error(error,stopMediaOptions),void("function"==typeof callback&&(log.log([null,"Socket",self._selectedRoom,"Error occurred. Firing callback with error -> "],error),callback(new Error(error),null)));stopMediaOptions===!1&&(stopUserMedia=!1,stopScreenshare=!1)}if(!self._inRoom)return error="Unable to leave room as user is not in any room",log.error(error),void("function"==typeof callback&&(log.log([null,"Socket",self._selectedRoom,"Error occurred. Firing callback with error -> "],error),callback(new Error(error),null)));for(var pc_index in self._peerConnections)self._peerConnections.hasOwnProperty(pc_index)&&self._removePeer(pc_index);self._inRoom=!1,self._closeChannel(),self._stopLocalMediaStreams({userMedia:stopUserMedia,screenshare:stopScreenshare}),self._wait(function(){log.log([null,"Socket",self._selectedRoom,"User left the room. Callback fired."]),self._trigger("peerLeft",self._user.sid,self.getPeerInfo(),!0),"function"==typeof callback&&callback(null,{peerId:self._user.sid,previousRoom:self._selectedRoom})},function(){return 0===Object.keys(self._peerConnections).length&&self._channelOpen===!1},!1)},Skylink.prototype.lockRoom=function(){log.log("Update to isRoomLocked status ->",!0),this._sendChannelMessage({type:this._SIG_MESSAGE_TYPE.ROOM_LOCK,mid:this._user.sid,rid:this._room.id,lock:!0}),this._trigger("roomLock",!0,this._user.sid,this.getPeerInfo(),!0)},Skylink.prototype.unlockRoom=function(){log.log("Update to isRoomLocked status ->",!1),this._sendChannelMessage({type:this._SIG_MESSAGE_TYPE.ROOM_LOCK,mid:this._user.sid,rid:this._room.id,lock:!1}),this._trigger("roomLock",!1,this._user.sid,this.getPeerInfo(),!0)},Skylink.prototype.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},Skylink.prototype.READY_STATE_CHANGE_ERROR={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,ROOM_LOCKED:5001,XML_HTTP_REQUEST_ERROR:-1,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,INVALID_XMLHTTPREQUEST_STATUS:5,SCRIPT_ERROR:6,ADAPTER_NO_LOADED:7},Skylink.prototype.REGIONAL_SERVER={APAC1:"sg",US1:"us2"},Skylink.prototype._forceSSL=!1,Skylink.prototype._forceTURNSSL=!1,Skylink.prototype._forceTURN=!1,Skylink.prototype._path=null,Skylink.prototype._serverRegion=null,Skylink.prototype._roomServer="//api.temasys.com.sg",Skylink.prototype._appKey=null,Skylink.prototype._defaultRoom=null,Skylink.prototype._roomStart=null,Skylink.prototype._roomDuration=null,Skylink.prototype._roomCredentials=null,Skylink.prototype._readyState=0,Skylink.prototype._key=null,Skylink.prototype._appKeyOwner=null,Skylink.prototype._room=null,Skylink.prototype._requestServerInfo=function(method,url,callback,params){var self=this,useXDomainRequest="function"==typeof window.XDomainRequest||"object"==typeof window.XDomainRequest;self._socketUseXDR=useXDomainRequest;var xhr;url=self._forceSSL?"https:"+url:url,useXDomainRequest?(log.debug([null,"XMLHttpRequest",method,"Using XDomainRequest. XMLHttpRequest is now XDomainRequest"],{agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion}),xhr=new XDomainRequest,xhr.setContentType=function(contentType){xhr.contentType=contentType}):(log.debug([null,"XMLHttpRequest",method,"Using XMLHttpRequest"],{agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion}),xhr=new window.XMLHttpRequest,xhr.setContentType=function(contentType){xhr.setRequestHeader("Content-type",contentType)}),xhr.onload=function(){var response=xhr.responseText||xhr.response,status=xhr.status||200;log.debug([null,"XMLHttpRequest",method,"Received sessions parameters"],JSON.parse(response||"{}")),callback(status,JSON.parse(response||"{}"))},xhr.onerror=function(error){log.error([null,"XMLHttpRequest",method,"Failed retrieving information:"],{status:xhr.status}),self._readyState=-1,self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:xhr.status||null,content:"Network error occurred. (Status: "+xhr.status+")",errorCode:self.READY_STATE_CHANGE_ERROR.XML_HTTP_REQUEST_ERROR},self._selectedRoom)},xhr.onprogress=function(){log.debug([null,"XMLHttpRequest",method,"Retrieving information and config from webserver. Url:"],url),log.debug([null,"XMLHttpRequest",method,"Provided parameters:"],params)},xhr.open(method,url,!0),params?(xhr.setContentType("application/json;charset=UTF-8"),xhr.send(JSON.stringify(params))):xhr.send()},Skylink.prototype._parseInfo=function(info){return log.log("Parsing parameter from server",info),info.pc_constraints||info.offer_constraints?(log.debug("Peer connection constraints:",info.pc_constraints),log.debug("Offer constraints:",info.offer_constraints),this._key=info.cid,this._appKeyOwner=info.apiOwner,this._signalingServer=info.ipSigserver,this._isPrivileged=info.isPrivileged,this._autoIntroduce=info.autoIntroduce,this._parentKey=info.room_key.substring(0,36),this._user={uid:info.username,token:info.userCred,timeStamp:info.timeStamp,streams:[],info:{}},this._room={id:info.room_key,token:info.roomCred,startDateTime:info.start,duration:info.len,connection:{peerConstraints:JSON.parse(info.pc_constraints),peerConfig:null,offerConstraints:JSON.parse(info.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},mediaConstraints:JSON.parse(info.media_constraints)}},this._parseDefaultMediaStreamSettings(this._room.connection.mediaConstraints),this._socketPorts={"http:":info.httpPortList,"https:":info.httpsPortList},this._readyState=2,this._trigger("readyStateChange",this.READY_STATE_CHANGE.COMPLETED,null,this._selectedRoom),void log.info("Parsed parameters from webserver. Ready for web-realtime communication")):void this._trigger("readyStateChange",this.READY_STATE_CHANGE.ERROR,{status:200,content:info.info,errorCode:info.error},self._selectedRoom)},Skylink.prototype._loadInfo=function(){var self=this,adapter=function(){try{return window.AdapterJS||AdapterJS}catch(error){return!1}}();if(!(adapter?"function"==typeof adapter.webRTCReady:!1)){var noAdapterErrorMsg="AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used";return void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:noAdapterErrorMsg,errorCode:self.READY_STATE_CHANGE_ERROR.ADAPTER_NO_LOADED},self._selectedRoom)}return window.io?window.XMLHttpRequest?window.RTCPeerConnection?self._path?void adapter.webRTCReady(function(){self._readyState=1,self._trigger("readyStateChange",self.READY_STATE_CHANGE.LOADING,null,self._selectedRoom),self._requestServerInfo("GET",self._path,function(status,response){if(200!==status){var errorMessage="XMLHttpRequest status not OK\nStatus was: "+status;return self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:status,content:response?response.info||errorMessage:errorMessage,errorCode:response.error||self.READY_STATE_CHANGE_ERROR.INVALID_XMLHTTPREQUEST_STATUS},self._selectedRoom)}self._parseInfo(response)})}):(log.error("Skylink is not initialised. Please call init() first"),self._readyState=-1,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:"No API Path is found",errorCode:self.READY_STATE_CHANGE_ERROR.NO_PATH},self._selectedRoom)):(log.error("WebRTC not supported. Please upgrade your browser"),self._readyState=-1,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:"WebRTC not available",errorCode:self.READY_STATE_CHANGE_ERROR.NO_WEBRTC_SUPPORT},self._selectedRoom)):(log.error("XMLHttpRequest not supported. Please upgrade your browser"),self._readyState=-1,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:"XMLHttpRequest not available",errorCode:self.READY_STATE_CHANGE_ERROR.NO_XMLHTTPREQUEST_SUPPORT},self._selectedRoom)):(log.error("Socket.io not loaded. Please load socket.io"),self._readyState=-1,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:"Socket.io not found",errorCode:self.READY_STATE_CHANGE_ERROR.NO_SOCKET_IO},self._selectedRoom))},Skylink.prototype._initSelectedRoom=function(room,callback){var self=this;if("function"==typeof room||"undefined"==typeof room)return void log.error("Invalid room provided. Room:",room);var defaultRoom=self._defaultRoom,initOptions={roomServer:self._roomServer,defaultRoom:room||defaultRoom,appKey:self._appKey,region:self._serverRegion,enableDataChannel:self._enableDataChannel,enableIceTrickle:self._enableIceTrickle};self._roomCredentials&&(initOptions.credentials={credentials:self._roomCredentials,duration:self._roomDuration,startDateTime:self._roomStart}),self.init(initOptions,function(error,success){self._defaultRoom=defaultRoom,callback(error?error:null)})},Skylink.prototype.init=function(options,callback){var self=this;if("function"==typeof options&&(callback=options,options=void 0),!options){var error="No API key provided";return log.error(error),void("function"==typeof callback&&callback(error,null))}var appKey,room,defaultRoom,region,startDateTime,duration,credentials,roomServer=self._roomServer,enableIceTrickle=!0,enableDataChannel=!0,enableSTUNServer=!0,enableTURNServer=!0,TURNTransport=self.TURN_TRANSPORT.ANY,audioFallback=!1,forceSSL=!1,socketTimeout=0,forceTURNSSL=!1,audioCodec=self.AUDIO_CODEC.AUTO,videoCodec=self.VIDEO_CODEC.AUTO,forceTURN=!1,usePublicSTUN=!0;if(log.log("Provided init options:",options),"string"==typeof options)appKey=options,defaultRoom=appKey,room=appKey;else{if(appKey=options.appKey||options.apiKey,roomServer=options.roomServer||roomServer,roomServer=roomServer.lastIndexOf("/")===roomServer.length-1?roomServer.substring(0,roomServer.length-1):roomServer,region=options.region||region,defaultRoom=options.defaultRoom||appKey,room=defaultRoom,enableIceTrickle="boolean"==typeof options.enableIceTrickle?options.enableIceTrickle:enableIceTrickle,enableDataChannel="boolean"==typeof options.enableDataChannel?options.enableDataChannel:enableDataChannel,enableSTUNServer="boolean"==typeof options.enableSTUNServer?options.enableSTUNServer:enableSTUNServer,enableTURNServer="boolean"==typeof options.enableTURNServer?options.enableTURNServer:enableTURNServer,forceSSL="boolean"==typeof options.forceSSL?options.forceSSL:forceSSL,socketTimeout="number"==typeof options.socketTimeout?options.socketTimeout:socketTimeout,socketTimeout=5e3>socketTimeout?5e3:socketTimeout,forceTURNSSL="boolean"==typeof options.forceTURNSSL?options.forceTURNSSL:forceTURNSSL,audioCodec="string"==typeof options.audioCodec?options.audioCodec:audioCodec,videoCodec="string"==typeof options.videoCodec?options.videoCodec:videoCodec,forceTURN="boolean"==typeof options.forceTURN?options.forceTURN:forceTURN,usePublicSTUN="boolean"==typeof options.usePublicSTUN?options.usePublicSTUN:usePublicSTUN,"string"==typeof options.TURNServerTransport)for(var type in self.TURN_TRANSPORT)if(self.TURN_TRANSPORT.hasOwnProperty(type)&&self.TURN_TRANSPORT[type]===options.TURNServerTransport){TURNTransport=options.TURNServerTransport;break}audioFallback=options.audioFallback||audioFallback,options.credentials&&(startDateTime=options.credentials.startDateTime||(new Date).toISOString(),duration=options.credentials.duration||200,credentials=options.credentials.credentials),forceTURN===!0&&(enableTURNServer=!0,enableSTUNServer=!1)}if(self._appKey=appKey,self._roomServer=roomServer,self._defaultRoom=defaultRoom,self._selectedRoom=room,self._serverRegion=region||null,self._path=roomServer+"/api/"+appKey+"/"+room,credentials&&(self._roomStart=startDateTime,self._roomDuration=duration,self._roomCredentials=credentials,self._path+=credentials?"/"+startDateTime+"/"+duration+"?&cred="+credentials:""),self._path+=(credentials?"&":"?")+"rand="+(new Date).toISOString(),region&&(self._path+="&rg="+region),self._enableIceTrickle=enableIceTrickle,self._enableDataChannel=enableDataChannel,self._enableSTUN=enableSTUNServer,self._enableTURN=enableTURNServer,self._TURNTransport=TURNTransport,self._audioFallback=audioFallback,self._forceSSL=forceSSL,self._socketTimeout=socketTimeout,self._forceTURNSSL=forceTURNSSL,self._selectedAudioCodec=audioCodec,self._selectedVideoCodec=videoCodec,self._forceTURN=forceTURN,self._usePublicSTUN=usePublicSTUN,log.log("Init configuration:",{serverUrl:self._path,readyState:self._readyState,appKey:self._appKey,roomServer:self._roomServer,defaultRoom:self._defaultRoom,selectedRoom:self._selectedRoom,serverRegion:self._serverRegion,enableDataChannel:self._enableDataChannel,enableIceTrickle:self._enableIceTrickle,enableTURNServer:self._enableTURN,enableSTUNServer:self._enableSTUN,TURNTransport:self._TURNTransport,audioFallback:self._audioFallback,forceSSL:self._forceSSL,socketTimeout:self._socketTimeout,forceTURNSSL:self._forceTURNSSL,audioCodec:self._selectedAudioCodec,videoCodec:self._selectedVideoCodec,forceTURN:self._forceTURN,usePublicSTUN:self._usePublicSTUN}),self._readyState=0,self._trigger("readyStateChange",self.READY_STATE_CHANGE.INIT,null,self._selectedRoom),"function"==typeof callback){var hasTriggered=!1,readyStateChangeFn=function(readyState,error){hasTriggered||(readyState===self.READY_STATE_CHANGE.COMPLETED?(log.log([null,"Socket",null,"Firing callback. Ready state change has met provided state ->"],readyState),hasTriggered=!0,self.off("readyStateChange",readyStateChangeFn),callback(null,{serverUrl:self._path,readyState:self._readyState,appKey:self._appKey,roomServer:self._roomServer,defaultRoom:self._defaultRoom,selectedRoom:self._selectedRoom,serverRegion:self._serverRegion,enableDataChannel:self._enableDataChannel,enableIceTrickle:self._enableIceTrickle,enableTURNServer:self._enableTURN,enableSTUNServer:self._enableSTUN,TURNTransport:self._TURNTransport,audioFallback:self._audioFallback,forceSSL:self._forceSSL,socketTimeout:self._socketTimeout,forceTURNSSL:self._forceTURNSSL,audioCodec:self._selectedAudioCodec,videoCodec:self._selectedVideoCodec,forceTURN:self._forceTURN,usePublicSTUN:self._usePublicSTUN})):readyState===self.READY_STATE_CHANGE.ERROR&&(log.log([null,"Socket",null,"Firing callback. Ready state change has met provided state ->"],readyState),log.debug([null,"Socket",null,"Ready state met failure"],error),hasTriggered=!0,self.off("readyStateChange",readyStateChangeFn),callback({error:new Error(error),errorCode:error.errorCode,status:error.status},null)))};self.on("readyStateChange",readyStateChangeFn)}self._loadInfo()},Skylink.prototype.LOG_LEVEL={DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0};var _LOG_KEY="SkylinkJS",_LOG_LEVELS=["error","warn","info","log","debug"],_logLevel=0,_enableDebugMode=!1,_enableDebugStack=!1,_enableDebugTrace=!1,_storedLogs=[],_getStoredLogsFn=function(logLevel){if("undefined"==typeof logLevel)return _storedLogs;for(var returnLogs=[],i=0;i<_storedLogs.length;i++)_storedLogs[i][1]===_LOG_LEVELS[logLevel]&&returnLogs.push(_storedLogs[i]);return returnLogs},_clearAllStoredLogsFn=function(){_storedLogs=[]},_printAllStoredLogsFn=function(){for(var i=0;i<_storedLogs.length;i++){_storedLogs[i][0],"undefined"!==console[_storedLogs[i][1]]?_storedLogs[i][1]:"log",_storedLogs[i][2],_storedLogs[i][3]}};window.SkylinkLogs={getLogs:_getStoredLogsFn,clearAllLogs:_clearAllStoredLogsFn,printAllLogs:_printAllStoredLogsFn};var _logFn=function(logLevel,message,debugObject){var outputLog=_LOG_KEY;if("object"==typeof message){if(outputLog+=message[0]?" ["+message[0]+"] -":" -",outputLog+=message[1]?" <<"+message[1]+">>":"",message[2])if(outputLog+=" ","object"==typeof message[2])for(var i=0;i<message[2].length;i++)outputLog+="("+message[2][i]+")";else outputLog+="("+message[2]+")";outputLog+=" "+message[3]}else outputLog+=" - "+message;if(_enableDebugMode&&_enableDebugStack){var logItem=[new Date,_LOG_LEVELS[logLevel],outputLog];"undefined"!=typeof debugObject&&logItem.push(debugObject),_storedLogs.push(logItem)}if(_logLevel>=logLevel&&(logLevel="undefined"==typeof console[_LOG_LEVELS[logLevel]]?3:logLevel,_enableDebugMode&&_enableDebugTrace)){"undefined"==typeof console.trace?logLevel[3]:"trace";"undefined"!=typeof debugObject?"undefined"!=typeof console.trace:"undefined"!=typeof console.trace}},log={debug:function(message,object){_logFn(4,message,object)},log:function(message,object){_logFn(3,message,object)},info:function(message,object){_logFn(2,message,object)},warn:function(message,object){_logFn(1,message,object)},error:function(message,object){_logFn(0,message,object)}};Skylink.prototype.setLogLevel=function(logLevel){void 0===logLevel&&(logLevel=Skylink.LOG_LEVEL.WARN);for(var level in this.LOG_LEVEL)if(this.LOG_LEVEL[level]===logLevel)return _logLevel=logLevel,void log.log([null,"Log",level,"Log level exists. Level is set"]);log.error([null,"Log",level,"Log level does not exist. Level is not set"])},Skylink.prototype.setDebugMode=function(isDebugMode){return"object"==typeof isDebugMode&&(Object.keys(isDebugMode).length>0?(_enableDebugTrace=!!isDebugMode.trace,_enableDebugStack=!!isDebugMode.storeLogs):(_enableDebugMode=!1,_enableDebugTrace=!1,_enableDebugStack=!1)),isDebugMode===!1?(_enableDebugMode=!1,_enableDebugTrace=!1,void(_enableDebugStack=!1)):(_enableDebugMode=!0,_enableDebugTrace=!0,void(_enableDebugStack=!0))},Skylink.prototype._EVENTS={channelOpen:[],channelClose:[],channelMessage:[],channelError:[],channelRetry:[],socketError:[],readyStateChange:[],handshakeProgress:[],candidateGenerationState:[],peerConnectionState:[],iceConnectionState:[],mediaAccessError:[],mediaAccessFallback:[],mediaAccessSuccess:[],mediaAccessRequired:[],mediaAccessStopped:[],peerJoined:[],peerRestart:[],peerUpdated:[],peerLeft:[],incomingStream:[],incomingMessage:[],incomingData:[],incomingDataRequest:[],roomLock:[],dataChannelState:[],dataTransferState:[],systemAction:[],serverPeerJoined:[],serverPeerLeft:[],serverPeerRestart:[],streamEnded:[],streamMuted:[],getPeersStateChange:[],introduceStateChange:[]},Skylink.prototype._onceEvents={},Skylink.prototype._timestamp={now:Date.now()||function(){return+new Date}},Skylink.prototype._trigger=function(eventName){var args=Array.prototype.slice.call(arguments),arr=this._EVENTS[eventName],once=this._onceEvents[eventName]||null;if(args.shift(),arr)for(var i=0;i<arr.length;i++)try{if(log.log([null,"Event",eventName,"Event is fired"]),arr[i].apply(this,args)===!1)break}catch(error){throw log.error([null,"Event",eventName,"Exception occurred in event:"],error),error}if(once)for(var j=0;j<once.length;j++)if(once[j][1].apply(this,args)===!0){if(log.log([null,"Event",eventName,"Condition is met. Firing event"]),once[j][0].apply(this,args)===!1)break;once[j][2]||(log.log([null,"Event",eventName,"Removing event after firing once"]),once.splice(j,1),j--)}else log.log([null,"Event",eventName,"Condition is still not met. Holding event from being fired"]);log.log([null,"Event",eventName,"Event is triggered"])},Skylink.prototype.on=function(eventName,callback){"function"==typeof callback?(this._EVENTS[eventName]=this._EVENTS[eventName]||[],this._EVENTS[eventName].push(callback),log.log([null,"Event",eventName,"Event is subscribed"])):log.error([null,"Event",eventName,"Provided parameter is not a function"])},Skylink.prototype.once=function(eventName,callback,condition,fireAlways){"boolean"==typeof condition&&(fireAlways=condition,condition=null),fireAlways="undefined"==typeof fireAlways?!1:fireAlways,condition="function"!=typeof condition?function(){return!0}:condition,"function"==typeof callback?(this._EVENTS[eventName]=this._EVENTS[eventName]||[],this._onceEvents[eventName]=this._onceEvents[eventName]||[],this._onceEvents[eventName].push([callback,condition,fireAlways]),log.log([null,"Event",eventName,"Event is subscribed on condition"])):log.error([null,"Event",eventName,"Provided callback is not a function"])},Skylink.prototype.off=function(eventName,callback){if(void 0===callback)return this._EVENTS[eventName]=[],this._onceEvents[eventName]=[],void log.log([null,"Event",eventName,"All events are unsubscribed"]);for(var arr=this._EVENTS[eventName],once=this._onceEvents[eventName],i=0;i<arr.length;i++)if(arr[i]===callback){log.log([null,"Event",eventName,"Event is unsubscribed"]),arr.splice(i,1);break}if(void 0!==once)for(var j=0;j<once.length;j++)if(once[j][0]===callback){log.log([null,"Event",eventName,"One-time Event is unsubscribed"]),once.splice(j,1);break}},Skylink.prototype._condition=function(eventName,callback,checkFirst,condition,fireAlways){if("boolean"==typeof condition&&(fireAlways=condition,condition=null),"function"==typeof callback&&"function"==typeof checkFirst){if(checkFirst())return log.log([null,"Event",eventName,"First condition is met. Firing callback"]),void callback();log.log([null,"Event",eventName,"First condition is not met. Subscribing to event"]),this.once(eventName,callback,condition,fireAlways)}else log.error([null,"Event",eventName,"Provided callback or checkFirst is not a function"])},Skylink.prototype._wait=function(callback,condition,intervalTime,fireAlways){if(fireAlways="undefined"==typeof fireAlways?!1:fireAlways,"function"==typeof callback&&"function"==typeof condition){if(condition())return log.log([null,"Event",null,"Condition is met. Firing callback"]),void callback();log.log([null,"Event",null,"Condition is not met. Doing a check."]),intervalTime="number"==typeof intervalTime?intervalTime:50;var doWait=setInterval(function(){condition()&&(log.log([null,"Event",null,"Condition is met after waiting. Firing callback"]),fireAlways||clearInterval(doWait),callback())},intervalTime)}else"function"!=typeof callback&&log.error([null,"Event",null,"Provided callback is not a function"]),"function"!=typeof condition&&log.error([null,"Event",null,"Provided condition is not a function"])},Skylink.prototype._throttle=function(func,wait){var self=this;return function(){self._timestamp.func||(self._timestamp.func=self._timestamp.now-wait);var now=Date.now();now-self._timestamp.func<wait||(func.apply(self,arguments),self._timestamp.func=now)}},Skylink.prototype.SOCKET_ERROR={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},Skylink.prototype._socketMessageQueue=[],Skylink.prototype._socketMessageTimeout=null,Skylink.prototype._socketPorts={"http:":[80,3e3],"https:":[443,3443]},Skylink.prototype.SOCKET_FALLBACK={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},Skylink.prototype._channelOpen=!1,Skylink.prototype._signalingServer=null,
Skylink.prototype._signalingServerProtocol=window.location.protocol,Skylink.prototype._signalingServerPort=null,Skylink.prototype._socket=null,Skylink.prototype._socketTimeout=0,Skylink.prototype._socketUseXDR=!1,Skylink.prototype._sendChannelMessage=function(message){var self=this,interval=1e3,throughput=16;if(self._channelOpen){var messageString=JSON.stringify(message),sendLater=function(){self._socketMessageQueue.length>0&&(self._socketMessageQueue.length<throughput?(log.debug([message.target?message.target:"server",null,null,"Sending delayed message"+(message.target?"":"s")+" ->"],{type:self._SIG_MESSAGE_TYPE.GROUP,lists:self._socketMessageQueue.slice(0,self._socketMessageQueue.length),mid:self._user.sid,rid:self._room.id}),self._socket?self._socket.send({type:self._SIG_MESSAGE_TYPE.GROUP,lists:self._socketMessageQueue.splice(0,self._socketMessageQueue.length),mid:self._user.sid,rid:self._room.id}):log.error([message.target?message.target:"server",null,null,"Dropping delayed message"+(message.target?"":"s")+" as socket object is no longer defined ->"],{type:self._SIG_MESSAGE_TYPE.GROUP,lists:self._socketMessageQueue.slice(0,self._socketMessageQueue.length),mid:self._user.sid,rid:self._room.id}),clearTimeout(self._socketMessageTimeout),self._socketMessageTimeout=null):(log.debug([message.target?message.target:"server",null,null,"Sending delayed message"+(message.target?"":"s")+" ->"],{type:self._SIG_MESSAGE_TYPE.GROUP,lists:self._socketMessageQueue.slice(0,throughput),mid:self._user.sid,rid:self._room.id}),self._socket?self._socket.send({type:self._SIG_MESSAGE_TYPE.GROUP,lists:self._socketMessageQueue.splice(0,throughput),mid:self._user.sid,rid:self._room.id}):log.error([message.target?message.target:"server",null,null,"Dropping delayed message"+(message.target?"":"s")+" as socket object is no longer defined ->"],{type:self._SIG_MESSAGE_TYPE.GROUP,lists:self._socketMessageQueue.slice(0,throughput),mid:self._user.sid,rid:self._room.id}),clearTimeout(self._socketMessageTimeout),self._socketMessageTimeout=null,self._socketMessageTimeout=setTimeout(sendLater,interval)),self._timestamp.now=Date.now()||function(){return+new Date})};if((Date.now()||function(){return+new Date})-self._timestamp.now<interval&&self._groupMessageList.indexOf(message.type)>-1)return log.warn([message.target?message.target:"server",null,null,"Messages fired too rapidly. Delaying."],{interval:1e3,throughput:16,message:message}),self._socketMessageQueue.push(messageString),void(self._socketMessageTimeout||(self._socketMessageTimeout=setTimeout(sendLater,interval-((Date.now()||function(){return+new Date})-self._timestamp.now))));log.debug([message.target?message.target:"server",null,null,"Sending to peer"+(message.target?"":"s")+" ->"],message),self._socket.send(messageString),self._timestamp.now=Date.now()||function(){return+new Date}}},Skylink.prototype._createSocket=function(type){var self=this,options={forceNew:!0,reconnection:!1},ports=self._socketPorts[self._signalingServerProtocol],connectionType=null;null===self._signalingServerPort?(self._signalingServerPort=ports[0],connectionType=self.SOCKET_FALLBACK.NON_FALLBACK):ports.indexOf(self._signalingServerPort)===ports.length-1?"WebSocket"===type?(type="Polling",self._signalingServerPort=ports[0]):"Polling"===type&&(options.reconnection=!0,options.reconnectionAttempts=4,options.reconectionDelayMax=1e3):self._signalingServerPort=ports[ports.indexOf(self._signalingServerPort)+1];var url=self._signalingServerProtocol+"//"+self._signalingServer+":"+self._signalingServerPort;"WebSocket"===type?options.transports=["websocket"]:"Polling"===type&&(options.transports=["xhr-polling","jsonp-polling","polling"]),self._socket&&(self._socket.removeAllListeners("connect_error"),self._socket.removeAllListeners("reconnect_attempt"),self._socket.removeAllListeners("reconnect_error"),self._socket.removeAllListeners("reconnect_failed"),self._socket.removeAllListeners("connect"),self._socket.removeAllListeners("reconnect"),self._socket.removeAllListeners("error"),self._socket.removeAllListeners("disconnect"),self._socket.removeAllListeners("message"),self._socket.disconnect(),self._socket=null),self._channelOpen=!1,log.log("Opening channel with signaling server url:",{url:url,useXDR:self._socketUseXDR,options:options}),self._socket=io.connect(url,options),null===connectionType&&(connectionType="http:"===self._signalingServerProtocol?"Polling"===type?self.SOCKET_FALLBACK.LONG_POLLING:self.SOCKET_FALLBACK.FALLBACK_PORT:"Polling"===type?self.SOCKET_FALLBACK.LONG_POLLING_SSL:self.SOCKET_FALLBACK.FALLBACK_SSL_PORT),self._socket.on("connect_error",function(error){self._channelOpen=!1,self._trigger("socketError",self.SOCKET_ERROR.CONNECTION_FAILED,error,connectionType),self._trigger("channelRetry",connectionType,1),options.reconnection===!1&&self._createSocket(type)}),self._socket.on("reconnect_attempt",function(attempt){self._channelOpen=!1,self._trigger("socketError",self.SOCKET_ERROR.RECONNECTION_ATTEMPT,attempt,connectionType),self._trigger("channelRetry",connectionType,attempt)}),self._socket.on("reconnect_error",function(error){self._channelOpen=!1,self._trigger("socketError",self.SOCKET_ERROR.RECONNECTION_FAILED,error,connectionType)}),self._socket.on("reconnect_failed",function(error){self._channelOpen=!1,self._trigger("socketError",self.SOCKET_ERROR.RECONNECTION_ABORTED,error,connectionType)}),self._socket.on("connect",function(){self._channelOpen||(self._channelOpen=!0,self._trigger("channelOpen"),log.log([null,"Socket",null,"Channel opened"]))}),self._socket.on("reconnect",function(){self._channelOpen||(self._channelOpen=!0,self._trigger("channelOpen"),log.log([null,"Socket",null,"Channel opened"]))}),self._socket.on("error",function(error){self._channelOpen=!1,self._trigger("channelError",error),log.error([null,"Socket",null,"Exception occurred:"],error)}),self._socket.on("disconnect",function(){self._channelOpen=!1,self._trigger("channelClose"),log.log([null,"Socket",null,"Channel closed"])}),self._socket.on("message",function(message){log.log([null,"Socket",null,"Received message"]),self._processSigMessage(message)})},Skylink.prototype._openChannel=function(){var self=this;if(self._channelOpen)return void log.error([null,"Socket",null,"Unable to instantiate a new channel connection as there is already an ongoing channel connection"]);if(self._readyState!==self.READY_STATE_CHANGE.COMPLETED)return void log.error([null,"Socket",null,"Unable to instantiate a new channel connection as readyState is not ready"]);self._forceSSL?self._signalingServerProtocol="https:":self._signalingServerProtocol=window.location.protocol;var socketType="WebSocket";window.WebSocket||(socketType="Polling"),self._createSocket(socketType)},Skylink.prototype._closeChannel=function(){this._channelOpen&&(this._socket&&(this._socket.removeAllListeners("connect_error"),this._socket.removeAllListeners("reconnect_attempt"),this._socket.removeAllListeners("reconnect_error"),this._socket.removeAllListeners("reconnect_failed"),this._socket.removeAllListeners("connect"),this._socket.removeAllListeners("reconnect"),this._socket.removeAllListeners("error"),this._socket.removeAllListeners("disconnect"),this._socket.removeAllListeners("message"),this._socket.disconnect(),this._socket=null),this._channelOpen=!1,this._trigger("channelClose"))},Skylink.prototype.SM_PROTOCOL_VERSION="0.1.1",Skylink.prototype._SIG_MESSAGE_TYPE={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",RESTART:"restart",OFFER:"offer",ANSWER:"answer",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",MUTE_VIDEO:"muteVideoEvent",MUTE_AUDIO:"muteAudioEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach"},Skylink.prototype._hasMCU=!1,Skylink.prototype._groupMessageList=[Skylink.prototype._SIG_MESSAGE_TYPE.STREAM,Skylink.prototype._SIG_MESSAGE_TYPE.UPDATE_USER,Skylink.prototype._SIG_MESSAGE_TYPE.ROOM_LOCK,Skylink.prototype._SIG_MESSAGE_TYPE.MUTE_AUDIO,Skylink.prototype._SIG_MESSAGE_TYPE.MUTE_VIDEO,Skylink.prototype._SIG_MESSAGE_TYPE.PUBLIC_MESSAGE],Skylink.prototype._hasMCU=!1,Skylink.prototype._receiveOnly=!1,Skylink.prototype._processSigMessage=function(messageString){var message=JSON.parse(messageString);if(message.type===this._SIG_MESSAGE_TYPE.GROUP){log.debug("Bundle of "+message.lists.length+" messages");for(var i=0;i<message.lists.length;i++)this._processSingleMessage(JSON.parse(message.lists[i]))}else this._processSingleMessage(message)},Skylink.prototype._processSingleMessage=function(message){this._trigger("channelMessage",message);var origin=message.mid;if(origin&&origin!==this._user.sid||(origin="Server"),log.debug([origin,null,null,"Received from peer ->"],message.type),message.mid===this._user.sid&&message.type!==this._SIG_MESSAGE_TYPE.REDIRECT&&message.type!==this._SIG_MESSAGE_TYPE.IN_ROOM)return void log.debug([origin,null,null,"Ignoring message ->"],message.type);switch(message.type){case this._SIG_MESSAGE_TYPE.PUBLIC_MESSAGE:this._publicMessageHandler(message);break;case this._SIG_MESSAGE_TYPE.PRIVATE_MESSAGE:this._privateMessageHandler(message);break;case this._SIG_MESSAGE_TYPE.IN_ROOM:this._inRoomHandler(message);break;case this._SIG_MESSAGE_TYPE.ENTER:this._enterHandler(message);break;case this._SIG_MESSAGE_TYPE.WELCOME:this._welcomeHandler(message);break;case this._SIG_MESSAGE_TYPE.RESTART:this._restartHandler(message);break;case this._SIG_MESSAGE_TYPE.OFFER:this._offerHandler(message);break;case this._SIG_MESSAGE_TYPE.ANSWER:this._answerHandler(message);break;case this._SIG_MESSAGE_TYPE.CANDIDATE:this._candidateHandler(message);break;case this._SIG_MESSAGE_TYPE.BYE:this._byeHandler(message);break;case this._SIG_MESSAGE_TYPE.REDIRECT:this._redirectHandler(message);break;case this._SIG_MESSAGE_TYPE.UPDATE_USER:this._updateUserEventHandler(message);break;case this._SIG_MESSAGE_TYPE.MUTE_VIDEO:this._muteVideoEventHandler(message);break;case this._SIG_MESSAGE_TYPE.MUTE_AUDIO:this._muteAudioEventHandler(message);break;case this._SIG_MESSAGE_TYPE.STREAM:this._streamEventHandler(message);break;case this._SIG_MESSAGE_TYPE.ROOM_LOCK:this._roomLockEventHandler(message);break;case this._SIG_MESSAGE_TYPE.PEER_LIST:this._peerListEventHandler(message);break;case this._SIG_MESSAGE_TYPE.INTRODUCE_ERROR:this._introduceErrorEventHandler(message);break;case this._SIG_MESSAGE_TYPE.APPROACH:this._approachEventHandler(message);break;default:log.error([message.mid,null,null,"Unsupported message ->"],message.type)}},Skylink.prototype._peerListEventHandler=function(message){var self=this;self._peerList=message.result,log.log(["Server",null,message.type,"Received list of peers"],self._peerList),self._trigger("getPeersStateChange",self.GET_PEERS_STATE.RECEIVED,self._user.sid,self._peerList)},Skylink.prototype._introduceErrorEventHandler=function(message){var self=this;log.log(["Server",null,message.type,"Introduce failed. Reason: "+message.reason]),self._trigger("introduceStateChange",self.INTRODUCE_STATE.ERROR,self._user.sid,message.sendingPeerId,message.receivingPeerId,message.reason)},Skylink.prototype._approachEventHandler=function(message){var self=this;log.log(["Server",null,message.type,"Approaching peer"],message.target),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,self._user.sid),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.ENTER,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,os:window.navigator.platform,userInfo:self.getPeerInfo(),receiveOnly:self._receiveOnly,sessionType:self._mediaScreen?"screensharing":"stream",target:message.target})},Skylink.prototype._redirectHandler=function(message){if(log.log(["Server",null,message.type,"System action warning:"],{message:message.info,reason:message.reason,action:message.action}),message.action===this.SYSTEM_ACTION.REJECT)for(var key in this._peerConnections)this._peerConnections.hasOwnProperty(key)&&this._removePeer(key);this._trigger("systemAction",message.action,message.info,message.reason)},Skylink.prototype._updateUserEventHandler=function(message){var targetMid=message.mid;log.log([targetMid,null,message.type,"Peer updated userData:"],message.userData),this._peerInformations[targetMid]?(this._peerInformations[targetMid].userData=message.userData||{},this._trigger("peerUpdated",targetMid,this.getPeerInfo(targetMid),!1)):log.log([targetMid,null,message.type,"Peer does not have any user information"])},Skylink.prototype._roomLockEventHandler=function(message){var targetMid=message.mid;log.log([targetMid,message.type,"Room lock status:"],message.lock),this._trigger("roomLock",message.lock,targetMid,this.getPeerInfo(targetMid),!1)},Skylink.prototype._muteAudioEventHandler=function(message){var targetMid=message.mid;log.log([targetMid,null,message.type,"Peer's audio muted:"],message.muted),this._peerInformations[targetMid]?(this._peerInformations[targetMid].mediaStatus.audioMuted=message.muted,this._trigger("peerUpdated",targetMid,this.getPeerInfo(targetMid),!1)):log.log([targetMid,message.type,"Peer does not have any user information"])},Skylink.prototype._muteVideoEventHandler=function(message){var targetMid=message.mid;log.log([targetMid,null,message.type,"Peer's video muted:"],message.muted),this._peerInformations[targetMid]?(this._peerInformations[targetMid].mediaStatus.videoMuted=message.muted,this._trigger("peerUpdated",targetMid,this.getPeerInfo(targetMid),!1)):log.log([targetMid,null,message.type,"Peer does not have any user information"])},Skylink.prototype._streamEventHandler=function(message){var targetMid=message.mid;log.log([targetMid,null,message.type,"Peer's stream status:"],message.status),this._peerInformations[targetMid]?"ended"===message.status&&(this._trigger("streamEnded",targetMid,this.getPeerInfo(targetMid),!1,"screensharing"===message.sessionType),this._peerConnections[targetMid]?(this._peerConnections[targetMid].hasStream=!1,"screensharing"===message.sessionType&&(this._peerConnections[targetMid].hasScreen=!1)):log.log([targetMid,null,message.type,"Peer connection not found"])):log.log([targetMid,null,message.type,"Peer does not have any user information"])},Skylink.prototype._byeHandler=function(message){var targetMid=message.mid,selfId=(this._user||{}).sid;selfId!==targetMid?(log.log([targetMid,null,message.type,"Peer has left the room"]),this._removePeer(targetMid)):log.log([targetMid,null,message.type,"Self has left the room"])},Skylink.prototype._privateMessageHandler=function(message){var targetMid=message.mid;log.log([targetMid,null,message.type,"Received private message from peer:"],message.data),this._trigger("incomingMessage",{content:message.data,isPrivate:!0,targetPeerId:message.target,isDataChannel:!1,senderPeerId:targetMid},targetMid,this.getPeerInfo(targetMid),!1)},Skylink.prototype._publicMessageHandler=function(message){var targetMid=message.mid;log.log([targetMid,null,message.type,"Received public message from peer:"],message.data),this._trigger("incomingMessage",{content:message.data,isPrivate:!1,targetPeerId:null,isDataChannel:!1,senderPeerId:targetMid},targetMid,this.getPeerInfo(targetMid),!1)},Skylink.prototype._inRoomHandler=function(message){var self=this;log.log(["Server",null,message.type,"User is now in the room and functionalities are now available. Config received:"],message.pc_config),self._room.connection.peerConfig=self._setIceServers(message.pc_config),self._inRoom=!0,self._user.sid=message.sid,self._trigger("peerJoined",self._user.sid,self.getPeerInfo(),!0),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,self._user.sid),self._mediaScreen&&null!==self._mediaScreen?self._trigger("incomingStream",self._user.sid,self._mediaScreen,!0,self.getPeerInfo()):self._mediaStream&&null!==self._mediaStream&&self._trigger("incomingStream",self._user.sid,self._mediaStream,!0,self.getPeerInfo()),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.ENTER,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,os:window.navigator.platform,userInfo:self.getPeerInfo(),receiveOnly:self._receiveOnly,sessionType:self._mediaScreen?"screensharing":"stream"})},Skylink.prototype._enterHandler=function(message){var self=this,targetMid=message.mid;if(log.log([targetMid,null,message.type,"Incoming peer have initiated handshake. Peer's information:"],message.userInfo),self._peerInformations[targetMid])return void log.log([targetMid,null,message.type,"Ignoring message as peer is already added"]);self._addPeer(targetMid,{agent:message.agent,version:message.version,os:message.os},!1,!1,message.receiveOnly,"screensharing"===message.sessionType),self._peerInformations[targetMid]=message.userInfo||{},self._peerInformations[targetMid].agent={name:message.agent,version:message.version,os:message.os||""},"MCU"!==targetMid?self._trigger("peerJoined",targetMid,message.userInfo,!1):(log.info([targetMid,"RTCPeerConnection","MCU","MCU feature has been enabled"],message),log.log([targetMid,null,message.type,"MCU has joined"],message.userInfo),this._hasMCU=!0,this._trigger("serverPeerJoined",targetMid,this.SERVER_PEER_TYPE.MCU)),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,targetMid);var weight=(new Date).valueOf();self._peerHSPriorities[targetMid]=weight,self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.WELCOME,mid:self._user.sid,rid:self._room.id,receiveOnly:self._peerConnections[targetMid]?!!self._peerConnections[targetMid].receiveOnly:!1,enableIceTrickle:self._enableIceTrickle,enableDataChannel:self._enableDataChannel,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,os:window.navigator.platform,userInfo:self.getPeerInfo(),target:targetMid,weight:weight,sessionType:self._mediaScreen?"screensharing":"stream"}),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.WELCOME,targetMid)},Skylink.prototype._restartHandler=function(message){var self=this,targetMid=message.mid;if(!self._peerInformations[targetMid])return void log.error([targetMid,null,null,"Peer does not have an existing session. Ignoring restart process."]);if(self._hasMCU)return void self._trigger("peerRestart",targetMid,self.getPeerInfo(targetMid),!1);if(self.lastRestart=message.lastRestart||Date.now()||function(){return+new Date},!self._peerConnections[targetMid])return void log.error([targetMid,null,null,"Peer does not have an existing connection. Unable to restart"]);if(self._peerRestartPriorities.hasOwnProperty(targetMid)&&self._peerRestartPriorities[targetMid]>message.weight)return void log.log([targetMid,null,message.type,"Peer's generated restart weight is lesser than user's. Ignoring message"],this._peerRestartPriorities[targetMid]+" > "+message.weight);self._peerInformations[targetMid]=message.userInfo||{},self._peerInformations[targetMid].agent={name:message.agent,version:message.version,os:message.os||""},"MCU"===targetMid&&(log.log([targetMid,null,message.type,"MCU has restarted its connection"]),self._hasMCU=!0),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.WELCOME,targetMid),message.agent=message.agent?message.agent:"chrome",self._enableIceTrickle="boolean"==typeof message.enableIceTrickle?message.enableIceTrickle:self._enableIceTrickle,self._enableDataChannel="boolean"==typeof message.enableDataChannel?message.enableDataChannel:self._enableDataChannel;self._restartPeerConnection(targetMid,!1,!1,function(){log.info("Received message",message),self._addPeer(targetMid,{agent:message.agent,version:message.version,os:message.os},!0,!0,message.receiveOnly,"screensharing"===message.sessionType),self._trigger("peerRestart",targetMid,self.getPeerInfo(targetMid),!1),self._startPeerConnectionHealthCheck(targetMid)},message.explicit)},Skylink.prototype._welcomeHandler=function(message){var targetMid=message.mid,restartConn=!1;if(log.log([targetMid,null,message.type,"Received peer's response to handshake initiation. Peer's information:"],message.userInfo),this._peerConnections[targetMid]){if(this._peerConnections[targetMid].setOffer&&!(message.weight<0))return void log.warn([targetMid,null,message.type,"Ignoring message as peer is already added"]);if(message.weight<0){if(log.log([targetMid,null,message.type,"Peer's weight is lower than 0. Proceeding with offer"],message.weight),restartConn=!0,-2===message.weight)return void this._restartHandler(message)}else{if(this._peerHSPriorities[targetMid]>message.weight)return void log.log([targetMid,null,message.type,"Peer's generated weight is lesser than user's. Ignoring message"],this._peerHSPriorities[targetMid]+" > "+message.weight);log.log([targetMid,null,message.type,"Peer's generated weight is higher than user's. Proceeding with offer"],this._peerHSPriorities[targetMid]+" < "+message.weight),restartConn=!0}}message.agent=message.agent?message.agent:"chrome",this._enableIceTrickle="boolean"==typeof message.enableIceTrickle?message.enableIceTrickle:this._enableIceTrickle,this._enableDataChannel="boolean"==typeof message.enableDataChannel?message.enableDataChannel:this._enableDataChannel,"MCU"===targetMid&&(log.info([targetMid,"RTCPeerConnection","MCU","MCU feature is currently enabled"],message),log.log([targetMid,null,message.type,"MCU has "+(message.weight>-1?"joined and ":"")+" responded"]),this._hasMCU=!0,this._trigger("serverPeerJoined",targetMid,this.SERVER_PEER_TYPE.MCU)),this._peerInformations[targetMid]||(this._peerInformations[targetMid]=message.userInfo||{},this._peerInformations[targetMid].agent={name:message.agent,version:message.version,os:message.os||""},"MCU"!==targetMid&&this._trigger("peerJoined",targetMid,message.userInfo,!1),this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.WELCOME,targetMid)),this._addPeer(targetMid,{agent:message.agent,version:message.version,os:message.os},!0,restartConn,message.receiveOnly,"screensharing"===message.sessionType)},Skylink.prototype._offerHandler=function(message){var self=this,targetMid=message.mid,pc=self._peerConnections[targetMid];if(!pc)return void log.error([targetMid,null,message.type,"Peer connection object not found. Unable to setRemoteDescription for offer"]);if(pc.localDescription?!!pc.localDescription.sdp:!1)return void log.warn([targetMid,null,message.type,"Peer has an existing connection"],pc.localDescription);log.log([targetMid,null,message.type,"Received offer from peer. Session description:"],message.sdp),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.OFFER,targetMid);var offer=new window.RTCSessionDescription(message);log.log([targetMid,"RTCSessionDescription",message.type,"Session description object created"],offer),pc.setRemoteDescription(new window.RTCSessionDescription(offer),function(){log.debug([targetMid,"RTCSessionDescription",message.type,"Remote description set"]),pc.setOffer="remote",self._addIceCandidateFromQueue(targetMid),self._doAnswer(targetMid)},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error),log.error([targetMid,null,message.type,"Failed setting remote description:"],error)})},Skylink.prototype._candidateHandler=function(message){var targetMid=message.mid,pc=this._peerConnections[targetMid];log.log([targetMid,null,message.type,"Received candidate from peer. Candidate config:"],{sdp:message.sdp,target:message.target,candidate:message.candidate,label:message.label});var messageCan=message.candidate.split(" "),canType=messageCan[7];log.log([targetMid,null,message.type,"Candidate type:"],canType);var index=message.label,candidate=new window.RTCIceCandidate({sdpMLineIndex:index,candidate:message.candidate,sdpMid:message.id});if(pc){if(pc.signalingState===this.PEER_CONNECTION_STATE.CLOSED)return void log.warn([targetMid,null,message.type,"Peer connection state is closed. Not adding candidate"]);"local"===pc.setOffer&&"remote"===pc.setAnswer||"local"===pc.setAnswer&&"remote"===pc.setOffer?(pc.addIceCandidate(candidate,this._onAddIceCandidateSuccess,this._onAddIceCandidateFailure),log.debug([targetMid,"RTCIceCandidate",message.type,"Added candidate"],candidate)):this._addIceCandidateToQueue(targetMid,candidate)}else log.debug([targetMid,"RTCIceCandidate",message.type,"Not adding candidate as peer connection not present"]),this._addIceCandidateToQueue(targetMid,candidate)},Skylink.prototype._answerHandler=function(message){var self=this,targetMid=message.mid;log.log([targetMid,null,message.type,"Received answer from peer. Session description:"],message.sdp),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ANSWER,targetMid);var answer=new window.RTCSessionDescription(message);log.log([targetMid,"RTCSessionDescription",message.type,"Session description object created"],answer);var pc=self._peerConnections[targetMid];return pc?(pc.remoteDescription?!pc.remoteDescription.sdp:1)?pc.signalingState===self.PEER_CONNECTION_STATE.STABLE?void log.error([targetMid,null,message.type,'Unable to set peer connection at signalingState "stable". Ignoring remote answer'],pc.signalingState):("moz"===window.webrtcDetectedType&&"MCU"===targetMid&&(message.sdp=message.sdp.replace(/ generation 0/g,""),message.sdp=message.sdp.replace(/ udp /g," UDP ")),void pc.setRemoteDescription(new window.RTCSessionDescription(answer),function(){log.debug([targetMid,null,message.type,"Remote description set"]),pc.setAnswer="remote",self._addIceCandidateFromQueue(targetMid)},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error),log.error([targetMid,null,message.type,"Failed setting remote description:"],error)})):void log.warn([targetMid,null,message.type,"Peer has an existing connection"],pc.remoteDescription):void log.error([targetMid,null,message.type,"Peer connection object not found. Unable to setRemoteDescription for offer"])},Skylink.prototype.sendMessage=function(message,targetPeerId){var i,listOfPeers=({cid:this._key,data:message,mid:this._user.sid,rid:this._room.id,type:this._SIG_MESSAGE_TYPE.PUBLIC_MESSAGE},Object.keys(this._peerConnections)),isPrivate=!1;for(Array.isArray(targetPeerId)?(listOfPeers=targetPeerId,isPrivate=!0):"string"==typeof targetPeerId&&(listOfPeers=[targetPeerId],isPrivate=!0),isPrivate||(log.log([null,"Socket",null,"Broadcasting message to peers"]),this._sendChannelMessage({cid:this._key,data:message,mid:this._user.sid,rid:this._room.id,type:this._SIG_MESSAGE_TYPE.PUBLIC_MESSAGE})),i=0;i<listOfPeers.length;i++){var peerId=listOfPeers[i];"MCU"!==peerId&&isPrivate&&(log.log([peerId,"Socket",null,"Sending message to peer"]),this._sendChannelMessage({cid:this._key,data:message,mid:this._user.sid,rid:this._room.id,target:peerId,type:this._SIG_MESSAGE_TYPE.PRIVATE_MESSAGE}))}this._trigger("incomingMessage",{content:message,isPrivate:isPrivate,targetPeerId:targetPeerId,isDataChannel:!1,senderPeerId:this._user.sid},this._user.sid,this.getPeerInfo(),!0)},Skylink.prototype.VIDEO_CODEC={AUTO:"auto",VP8:"VP8",H264:"H264"},Skylink.prototype.AUDIO_CODEC={AUTO:"auto",ISAC:"ISAC",OPUS:"opus"},Skylink.prototype._selectedAudioCodec="auto",Skylink.prototype._selectedVideoCodec="auto",Skylink.prototype.VIDEO_RESOLUTION={QQVGA:{width:160,height:120,aspectRatio:"4:3"},HQVGA:{width:240,height:160,aspectRatio:"3:2"},QVGA:{width:320,height:240,aspectRatio:"4:3"},WQVGA:{width:384,height:240,aspectRatio:"16:10"},HVGA:{width:480,height:320,aspectRatio:"3:2"},VGA:{width:640,height:480,aspectRatio:"4:3"},WVGA:{width:768,height:480,aspectRatio:"16:10"},FWVGA:{width:854,height:480,aspectRatio:"16:9"},SVGA:{width:800,height:600,aspectRatio:"4:3"},DVGA:{width:960,height:640,aspectRatio:"3:2"},WSVGA:{width:1024,height:576,aspectRatio:"16:9"},HD:{width:1280,height:720,aspectRatio:"16:9"},HDPLUS:{width:1600,height:900,aspectRatio:"16:9"},FHD:{width:1920,height:1080,aspectRatio:"16:9"},QHD:{width:2560,height:1440,aspectRatio:"16:9"},WQXGAPLUS:{width:3200,height:1800,aspectRatio:"16:9"},UHD:{width:3840,height:2160,aspectRatio:"16:9"},UHDPLUS:{width:5120,height:2880,aspectRatio:"16:9"},FUHD:{width:7680,height:4320,aspectRatio:"16:9"},QUHD:{width:15360,height:8640,aspectRatio:"16:9"}},Skylink.prototype._mediaStream=null,Skylink.prototype._mediaScreen=null,Skylink.prototype._mediaScreenClone=null,Skylink.prototype._defaultStreamSettings={audio:{stereo:!1},video:{resolution:{width:640,height:480},frameRate:50},bandwidth:{audio:50,video:256,data:1638400}},Skylink.prototype._streamSettings={},Skylink.prototype._screenSharingStreamSettings={video:{screenshare:!0}},Skylink.prototype._screenSharingAvailable=!1,Skylink.prototype._getUserMediaSettings={},Skylink.prototype._mediaStreamsStatus={},Skylink.prototype._audioFallback=!1,Skylink.prototype._onUserMediaSuccess=function(stream,isScreenSharing){var self=this;log.log([null,"MediaStream",stream.id,"User has granted access to local media"],stream);var streamEnded=function(){log.log([null,"MediaStream",stream.id,"Local mediastream has ended"],{inRoom:self._inRoom,currentTime:stream.currentTime,ended:"boolean"==typeof stream.active?stream.active:stream.ended}),self._inRoom&&(log.debug([null,"MediaStream",stream.id,"Sending mediastream ended status"]),self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.STREAM,mid:self._user.sid,rid:self._room.id,cid:self._key,sessionType:isScreenSharing?"screensharing":"stream",status:"ended"})),self._trigger("streamEnded",self._user.sid||null,self.getPeerInfo(),!0,!!isScreenSharing)};stream.onended=streamEnded,"firefox"===window.webrtcDetectedBrowser&&(stream.onended=setInterval(function(){"undefined"==typeof stream.recordedTime&&(stream.recordedTime=0),stream.recordedTime===stream.currentTime?(clearInterval(stream.onended),streamEnded()):stream.recordedTime=stream.currentTime},1e3)),isScreenSharing?self._mediaScreen=stream:self._mediaStream=stream,self._muteLocalMediaStreams(),self._wait(function(){self._trigger("mediaAccessSuccess",stream,!!isScreenSharing)},function(){return isScreenSharing?self._mediaScreen&&null!==self._mediaScreen:self._mediaStream&&null!==self._mediaStream})},Skylink.prototype._onUserMediaError=function(error,isScreenSharing,audioFallback){var self=this,hasAudioVideoRequest=!!self._streamSettings.video&&!!self._streamSettings.audio;self._audioFallback&&hasAudioVideoRequest&&audioFallback?(self._streamSettings.video=!1,self._getUserMediaSettings.video=!1,log.debug([null,"MediaStream",null,"Falling back to audio stream call"]),self._trigger("mediaAccessFallback",error),window.getUserMedia({audio:!0},function(stream){self._onUserMediaSuccess(stream)},function(error){log.error([null,"MediaStream",null,"Failed retrieving audio in audio fallback:"],error),self._trigger("mediaAccessError",error,!!isScreenSharing,!0)})):(log.error([null,"MediaStream",null,"Failed retrieving stream:"],error),self._trigger("mediaAccessError",error,!!isScreenSharing,!1))},Skylink.prototype._onRemoteStreamAdded=function(targetMid,event,isScreenSharing){var self=this;if("MCU"!==targetMid){if(!self._peerInformations[targetMid])return void log.error([targetMid,"MediaStream",event.stream.id,"Received remote stream when peer is not connected. Ignoring stream ->"],event.stream);if(!self._peerInformations[targetMid].settings.audio&&!self._peerInformations[targetMid].settings.video&&!isScreenSharing)return void log.log([targetMid,"MediaStream",event.stream.id,"Receive remote stream but ignoring stream as it is empty ->"],event.stream);log.log([targetMid,"MediaStream",event.stream.id,"Received remote stream ->"],event.stream),isScreenSharing&&log.log([targetMid,"MediaStream",event.stream.id,"Peer is having a screensharing session with user"]),self._trigger("incomingStream",targetMid,event.stream,!1,self.getPeerInfo(targetMid),!!isScreenSharing)}else log.log([targetMid,null,null,"MCU is listening"])},Skylink.prototype._parseAudioStreamSettings=function(audioOptions){audioOptions="object"==typeof audioOptions?audioOptions:!!audioOptions;
var hasOptional=!1;if(audioOptions!==!1){audioOptions="boolean"==typeof audioOptions?{}:audioOptions;var tempAudioOptions={};tempAudioOptions.stereo=!!audioOptions.stereo,tempAudioOptions.optional=[],Array.isArray(audioOptions.optional)&&(tempAudioOptions.optional=audioOptions.optional,hasOptional=!0),audioOptions=tempAudioOptions}var userMedia="object"==typeof audioOptions?!0:audioOptions;return hasOptional&&(userMedia={optional:audioOptions.optional}),{settings:audioOptions,userMedia:userMedia}},Skylink.prototype._parseVideoStreamSettings=function(videoOptions){videoOptions="object"==typeof videoOptions?videoOptions:!!videoOptions;var userMedia=!1;if(videoOptions!==!1){videoOptions="boolean"==typeof videoOptions?{resolution:{}}:videoOptions;var tempVideoOptions={};videoOptions.resolution=videoOptions.resolution||{},tempVideoOptions.resolution=tempVideoOptions.resolution||{},tempVideoOptions.resolution.width=videoOptions.resolution.width||this._defaultStreamSettings.video.resolution.width,tempVideoOptions.resolution.height=videoOptions.resolution.height||this._defaultStreamSettings.video.resolution.height,tempVideoOptions.frameRate=videoOptions.frameRate||this._defaultStreamSettings.video.frameRate,tempVideoOptions.screenshare=!1,tempVideoOptions.optional=[],Array.isArray(videoOptions.optional)&&(tempVideoOptions.optional=videoOptions.optional),videoOptions=tempVideoOptions,userMedia={mandatory:{maxWidth:videoOptions.resolution.width,maxHeight:videoOptions.resolution.height,maxFrameRate:videoOptions.frameRate},optional:tempVideoOptions.optional},"plugin"===window.webrtcDetectedType&&delete userMedia.mandatory.maxFrameRate,"edge"===window.webrtcDetectedBrowser&&(userMedia=!0)}return{settings:videoOptions,userMedia:userMedia}},Skylink.prototype._parseBandwidthSettings=function(bwOptions){bwOptions="object"==typeof bwOptions?bwOptions:{},bwOptions.audio="number"==typeof bwOptions.audio?bwOptions.audio:50,bwOptions.video="number"==typeof bwOptions.video?bwOptions.video:256,bwOptions.data="number"==typeof bwOptions.data?bwOptions.data:1638400,this._streamSettings.bandwidth=bwOptions},Skylink.prototype._parseMutedSettings=function(options){options="object"==typeof options?options:{audio:!1,video:!1};var updateAudioMuted="object"==typeof options.audio?!!options.audio.mute:!options.audio,updateVideoMuted="object"==typeof options.video?!!options.video.mute:!options.video;return{audioMuted:updateAudioMuted,videoMuted:updateVideoMuted}},Skylink.prototype._parseDefaultMediaStreamSettings=function(options){options=options||{},log.debug("Parsing stream settings. Default stream options:",options),options.maxWidth="number"==typeof options.maxWidth?options.maxWidth:640,options.maxHeight="number"==typeof options.maxHeight?options.maxHeight:480,this._defaultStreamSettings.video.resolution.width=options.maxWidth,this._defaultStreamSettings.video.resolution.height=options.maxHeight,log.debug("Parsed default media stream settings",this._defaultStreamSettings)},Skylink.prototype._parseMediaStreamSettings=function(options){options=options||{},log.debug("Parsing stream settings. Stream options:",options);var audioSettings=this._parseAudioStreamSettings(options.audio);this._streamSettings.audio=audioSettings.settings,this._getUserMediaSettings.audio=audioSettings.userMedia;var videoSettings=this._parseVideoStreamSettings(options.video);this._streamSettings.video=videoSettings.settings,this._getUserMediaSettings.video=videoSettings.userMedia;var mutedSettings=this._parseMutedSettings(options);this._mediaStreamsStatus=mutedSettings,log.debug("Parsed user media stream settings",this._streamSettings),log.debug("User media status:",this._mediaStreamsStatus)},Skylink.prototype._addLocalMediaStreams=function(peerId){try{log.log([peerId,null,null,"Adding local stream"]);var pc=this._peerConnections[peerId];pc?pc.signalingState!==this.PEER_CONNECTION_STATE.CLOSED?this._mediaScreen&&null!==this._mediaScreen?(pc.addStream(this._mediaScreen),log.debug([peerId,"MediaStream",this._mediaStream,"Sending screen"])):this._mediaStream&&null!==this._mediaStream?(pc.addStream(this._mediaStream),log.debug([peerId,"MediaStream",this._mediaStream,"Sending stream"])):log.warn([peerId,null,null,"No media to send. Will be only receiving"]):log.warn([peerId,"MediaStream",this._mediaStream,"Not adding stream as signalingState is closed"]):log.warn([peerId,"MediaStream",this._mediaStream,"Not adding stream as peerconnection object does not exists"])}catch(error){(error.message||"").indexOf("already added")>-1?log.warn([peerId,null,null,"Not re-adding stream as LocalMediaStream is already added"],error):log.error([peerId,null,null,"Failed adding local stream"],error)}},Skylink.prototype.stopStream=function(){this._stopLocalMediaStreams({userMedia:!0})},Skylink.prototype._muteLocalMediaStreams=function(){var audioTracks,videoTracks,a,v,hasAudioTracks=!1,hasVideoTracks=!1;if(this._mediaStream&&null!==this._mediaStream){for(audioTracks=this._mediaStream.getAudioTracks(),videoTracks=this._mediaStream.getVideoTracks(),hasAudioTracks=audioTracks.length>0||hasAudioTracks,hasVideoTracks=videoTracks.length>0||hasVideoTracks,a=0;a<audioTracks.length;a++)this._mediaStreamsStatus.audioMuted?audioTracks[a].enabled=!1:audioTracks[a].enabled=!0;for(v=0;v<videoTracks.length;v++)this._mediaStreamsStatus.videoMuted?videoTracks[v].enabled=!1:videoTracks[v].enabled=!0}if(this._mediaScreen&&null!==this._mediaScreen){for(audioTracks=this._mediaScreen.getAudioTracks(),videoTracks=this._mediaScreen.getVideoTracks(),hasAudioTracks=hasAudioTracks||audioTracks.length>0,hasVideoTracks=hasVideoTracks||videoTracks.length>0,a=0;a<audioTracks.length;a++)this._mediaStreamsStatus.audioMuted?audioTracks[a].enabled=!1:audioTracks[a].enabled=!0;for(v=0;v<videoTracks.length;v++)this._mediaStreamsStatus.videoMuted?videoTracks[v].enabled=!1:videoTracks[v].enabled=!0}if(this._mediaScreenClone&&null!==this._mediaScreenClone)for(videoTracks=this._mediaScreen.getVideoTracks(),hasVideoTracks=hasVideoTracks||videoTracks.length>0,v=0;v<videoTracks.length;v++)this._mediaStreamsStatus.videoMuted?videoTracks[v].enabled=!1:videoTracks[v].enabled=!0;return hasAudioTracks||(this._mediaStreamsStatus.audioMuted=!0,this._streamSettings.audio=!1),hasVideoTracks||(this._mediaStreamsStatus.videoMuted=!0,this._streamSettings.video=!1),log.log("Update to muted status ->",this._mediaStreamsStatus),{hasAudioTracks:hasAudioTracks,hasVideoTracks:hasVideoTracks}},Skylink.prototype._stopLocalMediaStreams=function(options){var stopUserMedia=!1,stopScreenshare=!1,triggerStopped=!1;"object"==typeof options&&(stopUserMedia=options.userMedia===!0,stopScreenshare=options.screenshare===!0);var stopTracksFn=function(stream){for(var audioTracks=stream.getAudioTracks(),videoTracks=stream.getVideoTracks(),i=0;i<audioTracks.length;i++)audioTracks[i].stop();for(var j=0;j<videoTracks.length;j++)videoTracks[j].stop()},stopFn=function(stream,name){if("chrome"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion>44)stopTracksFn(stream);else try{stream.stop()}catch(error){log.warn("Failed stopping MediaStreamTracks for "+name+". Stopping MediaStream instead",error),stopTracksFn(stream)}};stopScreenshare?(log.log([null,"MediaStream",self._selectedRoom,"Stopping screensharing MediaStream"]),this._mediaScreen&&null!==this._mediaScreen&&(stopFn(this._mediaScreen,"_mediaScreen"),this._mediaScreen=null,triggerStopped=!0),this._mediaScreenClone&&null!==this._mediaScreenClone&&(stopFn(this._mediaScreenClone,"_mediaScreenClone"),this._mediaScreenClone=null),triggerStopped&&this._trigger("mediaAccessStopped",!0)):log.log([null,"MediaStream",self._selectedRoom,"Screensharing MediaStream will not be stopped"]),stopUserMedia?(log.log([null,"MediaStream",self._selectedRoom,"Stopping user's MediaStream"]),this._mediaStream&&null!==this._mediaStream&&(stopFn(this._mediaStream,"_mediaStream"),this._mediaStream=null,triggerStopped=!0),triggerStopped&&this._trigger("mediaAccessStopped",!1)):log.log([null,"MediaStream",self._selectedRoom,"User's MediaStream will not be stopped"])},Skylink.prototype._waitForLocalMediaStream=function(callback,options){var self=this;options=options||{},options.manualGetUserMedia===!0&&self._trigger("mediaAccessRequired");var requireAudio=!!options.audio,requireVideo=!!options.video;if(log.log("Requested audio:",requireAudio),log.log("Requested video:",requireVideo),!requireAudio&&!requireVideo&&!options.manualGetUserMedia)return options.audio===!1&&options.video===!1&&self._parseMediaStreamSettings(options),void callback(null);if(options.manualGetUserMedia||!options.audio&&!options.video||self.getUserMedia({audio:options.audio,video:options.video},function(error,success){error?callback(error):callback(null,success)}),self.stopStream(),options.manualGetUserMedia===!0){var current50Block=0,mediaAccessRequiredFailure=!1;self._wait(function(){mediaAccessRequiredFailure===!0?self._onUserMediaError(new Error("Waiting for stream timeout"),!1,!1):callback(null,self._mediaStream)},function(){return current50Block+=1,600===current50Block?(mediaAccessRequiredFailure=!0,!0):self._mediaStream&&null!==self._mediaStream?!0:void 0},50)}},Skylink.prototype.getUserMedia=function(options,callback){var errorMsg,self=this;if("function"==typeof options)callback=options,options={audio:!0,video:!0};else if("object"!=typeof options||null===options){if("undefined"!=typeof options)return errorMsg="Please provide a valid options",log.error(errorMsg,options),void("function"==typeof callback&&callback(new Error(errorMsg),null));options={audio:!0,video:!0}}else if(!options.audio&&!options.video)return errorMsg="Please select audio or video",log.error(errorMsg,options),void("function"==typeof callback&&callback(new Error(errorMsg),null));return"https:"!==window.location.protocol&&"chrome"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion>46?(errorMsg="getUserMedia() has to be called in https:// application",log.error(errorMsg,options),void("function"==typeof callback&&callback(new Error(errorMsg),null))):(self._parseMediaStreamSettings(options),void(options.audio!==!1||options.video!==!1?(self.stopStream(),setTimeout(function(){try{if("function"==typeof callback){var mediaAccessErrorFn=function(error){callback(error,null),self.off("mediaAccessSuccess",mediaAccessSuccessFn)},mediaAccessSuccessFn=function(stream){callback(null,stream),self.off("mediaAccessError",mediaAccessErrorFn)};self.once("mediaAccessError",mediaAccessErrorFn),self.once("mediaAccessSuccess",mediaAccessSuccessFn)}window.getUserMedia(self._getUserMediaSettings,function(stream){var isSuccess=!1,requireAudio=!!options.audio,requireVideo=!!options.video,hasAudio=!requireAudio,hasVideo=!requireVideo;if(stream&&null!==stream){var notSameTracksError=new Error("Expected audio tracks length with "+(requireAudio?"1":"0")+" and video tracks length with "+(requireVideo?"1":"0")+" but received audio tracks length with "+stream.getAudioTracks().length+" and video tracks length with "+stream.getVideoTracks().length);requireAudio&&(hasAudio=stream.getAudioTracks().length>0),requireVideo&&(hasVideo=stream.getVideoTracks().length>0,self._audioFallback&&!hasVideo&&(hasVideo=!0,self._trigger("mediaAccessFallback",notSameTracksError))),hasAudio&&hasVideo&&(isSuccess=!0),isSuccess?self._onUserMediaSuccess(stream):self._onUserMediaError(notSameTracksError,!1,!1)}},function(error){self._onUserMediaError(error,!1,!0)})}catch(error){self._onUserMediaError(error,!1,!0)}},"firefox"===window.webrtcDetectedBrowser?500:1)):log.warn([null,"MediaStream",null,"Not retrieving stream"])))},Skylink.prototype.sendStream=function(stream,callback){var self=this,restartCount=0,peerCount=Object.keys(self._peerConnections).length;if("object"!=typeof stream||null===stream){var error="Provided stream settings is invalid";return log.error(error,stream),void("function"==typeof callback&&callback(new Error(error),null))}var hasNoPeers=0===Object.keys(self._peerConnections).length;"function"==typeof stream.getAudioTracks||"function"==typeof stream.getVideoTracks?(self.stopStream(),self._streamSettings.audio=stream.getAudioTracks().length>0,self._streamSettings.video=stream.getVideoTracks().length>0,self._mediaStreamsStatus.audioMuted=self._streamSettings.audio===!1,self._mediaStreamsStatus.videoMuted=self._streamSettings.video===!1,self._inRoom&&self.once("mediaAccessSuccess",function(stream){if(self._hasMCU)self._restartMCUConnection();else{self._trigger("incomingStream",self._user.sid,self._mediaStream,!0,self.getPeerInfo(),!1);for(var peer in self._peerConnections)self._peerConnections.hasOwnProperty(peer)&&self._restartPeerConnection(peer,!0,!1,null,!0)}self._trigger("peerUpdated",self._user.sid,self.getPeerInfo(),!0)}),self._mediaStream!==stream&&self._onUserMediaSuccess(stream),"function"!=typeof callback||hasNoPeers||self.once("peerRestart",function(peerId,peerInfo,isSelfInitiatedRestart){log.log([null,"MediaStream",stream.id,"Stream was sent. Firing callback"],stream),callback(null,stream),restartCount=0},function(peerId,peerInfo,isSelfInitiatedRestart){return isSelfInitiatedRestart&&(restartCount++,restartCount===peerCount)?!0:!1},!1),"function"==typeof callback&&hasNoPeers&&callback(null,self._mediaStream)):("function"!=typeof callback||hasNoPeers||self.once("peerRestart",function(peerId,peerInfo,isSelfInitiatedRestart){log.log([null,"MediaStream",stream.id,"Stream was sent. Firing callback"],stream),callback(null,stream),restartCount=0},function(peerId,peerInfo,isSelfInitiatedRestart){return isSelfInitiatedRestart&&(restartCount++,restartCount===peerCount)?!0:!1},!1),self._inRoom&&self.once("mediaAccessSuccess",function(stream){if(self._hasMCU)self._restartMCUConnection();else{self._trigger("incomingStream",self._user.sid,self._mediaStream,!0,self.getPeerInfo(),!1);for(var peer in self._peerConnections)self._peerConnections.hasOwnProperty(peer)&&self._restartPeerConnection(peer,!0,!1,null,!0)}self._trigger("peerUpdated",self._user.sid,self.getPeerInfo(),!0)}),self._waitForLocalMediaStream(function(error){error?callback(error,null):"function"==typeof callback&&hasNoPeers&&callback(null,self._mediaStream)},stream))},Skylink.prototype.muteStream=function(options){var self=this,hasAudioError=!1,hasVideoError=!1;if("object"!=typeof options)return void log.error("Provided settings is not an object");if(!(self._mediaStream&&null!==self._mediaStream||self._mediaScreen&&null!==self._mediaScreen))return void log.warn("No streams are available to mute / unmute!");"boolean"==typeof options.audioMuted&&(self._streamSettings.audio===!1?(log.error("No audio available to mute / unmute"),hasAudioError=!0):options.audioMuted?self._mediaStreamsStatus.audioMuted=!0:self._mediaStreamsStatus.audioMuted=!1),"boolean"==typeof options.videoMuted&&(self._streamSettings.video===!1?(log.error("No video available to mute / unmute"),hasVideoError=!0):options.videoMuted?self._mediaStreamsStatus.videoMuted=!0:self._mediaStreamsStatus.videoMuted=!1);var hasTracksOption=self._muteLocalMediaStreams();self._inRoom&&(hasTracksOption.hasVideoTracks&&self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.MUTE_VIDEO,mid:self._user.sid,rid:self._room.id,muted:self._mediaStreamsStatus.videoMuted}),hasTracksOption.hasAudioTracks&&setTimeout(function(){self._sendChannelMessage({type:self._SIG_MESSAGE_TYPE.MUTE_AUDIO,mid:self._user.sid,rid:self._room.id,muted:self._mediaStreamsStatus.audioMuted})},1050),hasAudioError&&hasVideoError||self._trigger("peerUpdated",self._user.sid,self.getPeerInfo(),!0)),hasAudioError&&hasVideoError||self._trigger("streamMuted",self._user.sid||null,self.getPeerInfo(),!0,!!self._mediaScreen&&null!==self._mediaScreen)},Skylink.prototype.enableAudio=function(){this.muteStream({audioMuted:!1})},Skylink.prototype.disableAudio=function(){this.muteStream({audioMuted:!0})},Skylink.prototype.enableVideo=function(){this.muteStream({videoMuted:!1})},Skylink.prototype.disableVideo=function(){this.muteStream({videoMuted:!0})},Skylink.prototype.shareScreen=function(enableAudio,callback){var self=this,hasAudio=!1,settings={video:{mediaSource:"window"}};"function"==typeof enableAudio&&(callback=enableAudio,enableAudio=!0),"boolean"!=typeof enableAudio&&(enableAudio=!0);var triggerSuccessFn=function(sStream){hasAudio?"object"==typeof self._streamSettings.audio?self._screenSharingStreamSettings.audio={stereo:!!self._streamSettings.audio.stereo}:self._screenSharingStreamSettings.audio=!0:(log.warn("This screensharing session will not support audio streaming"),self._screenSharingStreamSettings.audio=!1),self._onUserMediaSuccess(sStream,!0)};"firefox"===window.webrtcDetectedBrowser&&(settings.audio=!!enableAudio);try{window.getUserMedia(settings,function(stream){self.once("mediaAccessSuccess",function(stream){if(self._inRoom)if(self._hasMCU)self._restartMCUConnection();else{self._trigger("incomingStream",self._user.sid,self._mediaStream,!0,self.getPeerInfo(),!1);for(var peer in self._peerConnections)self._peerConnections.hasOwnProperty(peer)&&self._restartPeerConnection(peer,!0,!1,null,!0)}else"function"==typeof callback&&callback(null,stream)}),"firefox"!==window.webrtcDetectedBrowser&&enableAudio?window.getUserMedia({audio:!0},function(audioStream){try{audioStream.addTrack(stream.getVideoTracks()[0]),self._mediaScreenClone=stream,hasAudio=!0,triggerSuccessFn(audioStream,!0)}catch(error){log.error("Failed retrieving audio stream for screensharing stream",error),triggerSuccessFn(stream,!0)}},function(error){log.error("Failed retrieving audio stream for screensharing stream",error),triggerSuccessFn(stream,!0)}):(hasAudio="firefox"===window.webrtcDetectedBrowser?enableAudio:!1,triggerSuccessFn(stream,!0))},function(error){self._onUserMediaError(error,!0,!1),"function"==typeof callback&&callback(error,null)})}catch(error){self._onUserMediaError(error,!0,!1),"function"==typeof callback&&callback(error,null)}},Skylink.prototype.stopScreen=function(){var endSession=!1;if(this._mediaScreen&&null!==this._mediaScreen&&(endSession=!!this._mediaScreen.endSession,this._stopLocalMediaStreams({screenshare:!0}),!endSession))if(this._hasMCU)this._restartMCUConnection();else{this._mediaStream&&null!==this._mediaStream&&this._trigger("incomingStream",this._user.sid,this._mediaStream,!0,this.getPeerInfo(),!1);for(var peer in this._peerConnections)this._peerConnections.hasOwnProperty(peer)&&this._restartPeerConnection(peer,!0,!1,null,!0)}},Skylink.prototype._addSDPStereo=function(sdpLines){var i,j,line,opusRtmpLineIndex=0,opusLineFound=!1,opusPayload=0,fmtpLineFound=!1;for(i=0;i<sdpLines.length;i+=1)if(line=sdpLines[i],0===line.indexOf("a=rtpmap:")){var parts=line.split(" ");if(0===parts[1].indexOf("opus/48000/")){opusLineFound=!0,opusPayload=parts[0].split(":")[1],opusRtmpLineIndex=i;break}}if(opusLineFound){for(log.debug([null,"SDP",null,"OPUS line is found. Enabling stereo"]),j=0;j<sdpLines.length;j+=1)if(line=sdpLines[j],0===line.indexOf("a=fmtp:"+opusPayload)){fmtpLineFound=!0,sdpLines[j]+="; stereo=1";break}fmtpLineFound||sdpLines.splice(opusRtmpLineIndex,0,"a=fmtp:"+opusPayload+" stereo=1")}return sdpLines},Skylink.prototype._setSDPVideoResolution=function(sdpLines){var i,j,k,line,video=this._streamSettings.video,frameRate=video.frameRate||50,videoLineFound=!1,videoLineIndex=0,fmtpPayloads=[],sdpLineData="max-fr="+frameRate+"; max-recv-width=320; max-recv-height=160";for(i=0;i<sdpLines.length;i+=1)if(line=sdpLines[i],0===line.indexOf("a=video")||0===line.indexOf("m=video")){videoLineFound=!0,videoLineIndex=i,fmtpPayloads=line.split(" "),fmtpPayloads.splice(0,3);break}if(videoLineFound){for(j=0;j<fmtpPayloads.length;j+=1){var payload=fmtpPayloads[j],rtpmapLineIndex=0,fmtpLineIndex=0,fmtpLineFound=!1,ignore=!1;for(k=0;k<sdpLines.length;k+=1){if(line=sdpLines[k],0===line.indexOf("a=rtpmap:"+payload)){if(!(line.indexOf("VP8")>0||line.indexOf("H264")>0)){ignore=!0;break}rtpmapLineIndex=k}0===line.indexOf("a=fmtp:"+payload)&&(fmtpLineFound=!0,fmtpLineIndex=k)}ignore||(fmtpLineFound?sdpLines[fmtpLineIndex]+=";"+sdpLineData:sdpLines.splice(rtpmapLineIndex+1,0,"a=fmtp:"+payload+" "+sdpLineData))}log.debug([null,"SDP",null,"Setting video resolution (broken)"])}return sdpLines},Skylink.prototype._setSDPBitrate=function(sdpLines,settings){var i,j,k,bandwidth=this._streamSettings.bandwidth;!!(settings||{}).audio,!!(settings||{}).video;for(i=0;i<sdpLines.length;i+=1)if(0===sdpLines[i].indexOf("a=audio")||0===sdpLines[i].indexOf("m=audio")){sdpLines.splice(i+1,0,"b=AS:"+bandwidth.audio),log.debug([null,"SDP",null,"Setting audio bitrate ("+bandwidth.audio+")"],i);break}for(j=0;j<sdpLines.length;j+=1)if(0===sdpLines[j].indexOf("a=video")||0===sdpLines[j].indexOf("m=video")){sdpLines.splice(j+1,0,"b=AS:"+bandwidth.video),log.debug([null,"SDP",null,"Setting video bitrate ("+bandwidth.video+")"],j);break}for(k=0;k<sdpLines.length;k+=1)if(0===sdpLines[k].indexOf("a=application")||0===sdpLines[k].indexOf("m=application")){sdpLines.splice(k+1,0,"b=AS:"+bandwidth.data),log.debug([null,"SDP",null,"Setting data bitrate ("+bandwidth.data+")"],k);break}return sdpLines},Skylink.prototype._setSDPVideoCodec=function(sdpLines){log.log("Setting video codec",this._selectedVideoCodec);var i,j,line,codecFound=!1,payload=0;for(i=0;i<sdpLines.length;i+=1)if(line=sdpLines[i],0===line.indexOf("a=rtpmap:")&&line.indexOf(this._selectedVideoCodec)>0){codecFound=!0,payload=line.split(":")[1].split(" ")[0];break}if(codecFound)for(j=0;j<sdpLines.length;j+=1)if(line=sdpLines[j],0===line.indexOf("m=video")||0===line.indexOf("a=video")){var parts=line.split(" "),payloads=line.split(" ");payloads.splice(0,3);var selectedPayloadIndex=payloads.indexOf(payload);if(-1===selectedPayloadIndex)payloads.splice(0,0,payload);else{var first=payloads[0];payloads[0]=payload,payloads[selectedPayloadIndex]=first}sdpLines[j]=parts[0]+" "+parts[1]+" "+parts[2]+" "+payloads.join(" ");break}return sdpLines},Skylink.prototype._setSDPAudioCodec=function(sdpLines){log.log("Setting audio codec",this._selectedAudioCodec);var i,j,line,codecFound=!1,payload=0;for(i=0;i<sdpLines.length;i+=1)line=sdpLines[i],0===line.indexOf("a=rtpmap:")&&line.indexOf(this._selectedAudioCodec)>0&&(codecFound=!0,payload=line.split(":")[1].split(" ")[0]);if(codecFound)for(j=0;j<sdpLines.length;j+=1)if(line=sdpLines[j],0===line.indexOf("m=audio")||0===line.indexOf("a=audio")){var parts=line.split(" "),payloads=line.split(" ");payloads.splice(0,3);var selectedPayloadIndex=payloads.indexOf(payload);if(-1===selectedPayloadIndex)payloads.splice(0,0,payload);else{var first=payloads[0];payloads[0]=payload,payloads[selectedPayloadIndex]=first}sdpLines[j]=parts[0]+" "+parts[1]+" "+parts[2]+" "+payloads.join(" ");break}return sdpLines},Skylink.prototype._removeSDPFirefoxH264Pref=function(sdpLines){var invalidLineIndex=sdpLines.indexOf("a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1");return invalidLineIndex>-1&&(log.debug([null,"SDP",null,"Firefox H264 invalid pref found:"],invalidLineIndex),sdpLines.splice(invalidLineIndex,1)),sdpLines},window.Skylink=Skylink}.call(this);