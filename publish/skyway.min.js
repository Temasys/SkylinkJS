/*! skywayjs - v0.5.0 - 2014-09-29 */
(function(){function Skyway(){return this instanceof Skyway?(this.VERSION="0.5.0",this.REGIONAL_SERVER={APAC1:"sg",US1:"us2"},this.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},this.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",CLOSED:"closed"},this.CANDIDATE_GENERATION_STATE={NEW:"new",GATHERING:"gathering",COMPLETED:"completed"},this.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ERROR:"error"},this.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error"},this.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject"},this.SYSTEM_ACTION_REASON={FAST_MESSAGE:"fastmsg",ROOM_LOCKED:"locked",ROOM_FULL:"roomfull",DUPLICATED_LOGIN:"duplicatedLogin",SERVER_ERROR:"serverError",VERIFICATION:"verification",EXPIRED:"expired",ROOM_CLOSED:"roomclose",ROOM_CLOSING:"toclose",OVER_SEAT_LIMIT:"seatquota"},this.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},this.READY_STATE_CHANGE_ERROR={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NOT_ENOUGH_CREDIT:4007,API_NOT_ENOUGH_PREPAID_CREDIT:4008,API_FAILED_FINDING_PREPAID_CREDIT:4009,API_NO_MEETING_RECORD_FOUND:4010,ROOM_LOCKED:5001,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,INVALID_XMLHTTPREQUEST_STATUS:5,SCRIPT_ERROR:6},this.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},this.DATA_TRANSFER_STATE={UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},this.DATA_TRANSFER_DATA_TYPE={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob"},this.SIG_TYPE={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:this.HANDSHAKE_PROGRESS.ENTER,WELCOME:this.HANDSHAKE_PROGRESS.WELCOME,OFFER:this.HANDSHAKE_PROGRESS.OFFER,ANSWER:this.HANDSHAKE_PROGRESS.ANSWER,CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",MUTE_VIDEO:"muteVideoEvent",MUTE_AUDIO:"muteAudioEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",GROUP:"group"},this.DC_TYPE={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},this.VIDEO_RESOLUTION={QVGA:{width:320,height:180},VGA:{width:640,height:360},HD:{width:1280,height:720},FHD:{width:1920,height:1080}},this._path=null,this._serverPath="//api.temasys.com.sg",this._serverRegion=null,this._roomServer=null,this._apiKey=null,this._defaultRoom=null,this._selectedRoom=null,this._roomStart=null,this._roomDuration=null,this._roomCredentials=null,this._key=null,this._socket=null,this._socketVersion=null,this._user=null,this._room=null,this._peerConnections=[],this._peerInformations=[],this._peerCandidatesQueue=[],this._peerHSPriorities=[],this._dataChannels=[],this._uploadDataTransfers=[],this._uploadDataSessions=[],this._downloadDataTransfers=[],this._downloadDataSessions=[],this._dataTransfersTimeout=[],this._readyState=0,this._channel_open=!1,this._room_lock=!1,this._in_room=!1,this._chunkFileSize=49152,this._mozChunkFileSize=16384,this._enableIceTrickle=!0,this._enableDataChannel=!0,this._streamSettings={audio:!1,video:!1},this._requestServerInfo=function(method,url,callback,params){var xhr=new window.XMLHttpRequest;xhr.onreadystatechange=function(){xhr.readyState===xhr.DONE&&(200!==xhr.status,callback(xhr.status,JSON.parse(xhr.response||"{}")))},xhr.open(method,url,!0),params?(xhr.setRequestHeader("Content-type","application/json;charset=UTF-8"),xhr.send(JSON.stringify(params))):xhr.send()},this._parseInfo=function(info,self){return info.pc_constraints||info.offer_constraints?(self._key=info.cid,self._user={id:info.username,token:info.userCred,timeStamp:info.timeStamp,apiOwner:info.apiOwner,streams:[],info:{}},self._room={id:info.room_key,token:info.roomCred,start:info.start,len:info.len,signalingServer:{ip:info.ipSigserver,port:info.portSigserver,protocol:info.protocol},pcHelper:{pcConstraints:JSON.parse(info.pc_constraints),pcConfig:null,offerConstraints:JSON.parse(info.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}},self._readyState=2,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.COMPLETED)):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:200,content:info.info,errorCode:info.error})},void(this._loadInfo=function(self){return window.io?window.XMLHttpRequest?window.RTCPeerConnection?self._path?(self._readyState=1,self._trigger("readyStateChange",self.READY_STATE_CHANGE.LOADING),void self._requestServerInfo("GET",self._path,function(status,response){if(200!==status){var errorMessage="XMLHttpRequest status not OK\nStatus was: "+status;return self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:status,content:response?response.info||errorMessage:errorMessage,errorCode:response.error||self.READY_STATE_CHANGE_ERROR.INVALID_XMLHTTPREQUEST_STATUS})}self._parseInfo(response,self)})):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:"No API Path is found",errorCode:self.READY_STATE_CHANGE_ERROR.NO_PATH}):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:"WebRTC not available",errorCode:self.READY_STATE_CHANGE_ERROR.NO_WEBRTC_SUPPORT}):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:"XMLHttpRequest not available",errorCode:self.READY_STATE_CHANGE_ERROR.NO_XMLHTTPREQUEST_SUPPORT}):void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:"Socket.io not found",errorCode:self.READY_STATE_CHANGE_ERROR.NO_SOCKET_IO})})):new Skyway}this.Skyway=Skyway,Skyway.prototype.on=function(eventName,callback){"function"==typeof callback&&(this._events[eventName]=this._events[eventName]||[],this._events[eventName].push(callback))},Skyway.prototype.off=function(eventName,callback){if(void 0===callback)return void(this._events[eventName]=[]);for(var arr=this._events[eventName],l=arr.length,i=0;l>i;i++)if(arr[i]===callback){arr.splice(i,1);break}},Skyway.prototype._trigger=function(eventName){var args=Array.prototype.slice.call(arguments),arr=this._events[eventName];if(args.shift(),arr)for(var e in arr)if(arr.hasOwnProperty(e))try{if(arr[e].apply(this,args)===!1)break}catch(error){}},Skyway.prototype.init=function(options){if(options){var apiKey,room,defaultRoom,startDateTime,duration,credentials,region,roomserver=this._serverPath,iceTrickle=!0,dataChannel=!0;"string"==typeof options?(apiKey=options,defaultRoom=apiKey,room=apiKey):(apiKey=options.apiKey,roomserver=options.roomServer||roomserver,roomserver=roomserver.lastIndexOf("/")===roomserver.length-1?roomserver.substring(0,roomserver.length-1):roomserver,region=options.region||region,defaultRoom=options.defaultRoom||apiKey,room=defaultRoom,iceTrickle="boolean"==typeof options.iceTrickle?options.iceTrickle:iceTrickle,dataChannel="boolean"==typeof options.dataChannel?options.dataChannel:dataChannel,options.credentials&&(startDateTime=options.credentials.startDateTime||(new Date).toISOString(),duration=options.credentials.duration||200,credentials=options.credentials.credentials)),this._readyState=0,this._trigger("readyStateChange",this.READY_STATE_CHANGE.INIT),this._apiKey=apiKey,this._roomServer=roomserver,this._defaultRoom=defaultRoom,this._selectedRoom=room,this._serverRegion=region,this._enableIceTrickle=iceTrickle,this._enableDataChannel=dataChannel,this._path=roomserver+"/api/"+apiKey+"/"+room,credentials&&(this._roomStart=startDateTime,this._roomDuration=duration,this._roomCredentials=credentials,this._path+=credentials?"/"+startDateTime+"/"+duration+"?&cred="+credentials:""),region&&(this._path+=(this._path.indexOf("?&")>-1?"&":"?&")+"rg="+region),this._loadInfo(this)}},Skyway.prototype._reinit=function(options,callback){var startDateTime,duration,credentials,self=this,apiKey=options.apiKey||self._apiKey,roomserver=options.roomServer||self._roomServer;roomserver=roomserver.lastIndexOf("/")===roomserver.length-1?roomserver.substring(0,roomserver.length-1):roomserver;var region=options.region||self._serverRegion,defaultRoom=options.defaultRoom||self._defaultRoom,room=options.room||defaultRoom,iceTrickle="boolean"==typeof options.iceTrickle?options.iceTrickle:self._enableIceTrickle,dataChannel="boolean"==typeof options.dataChannel?options.dataChannel:self._enableDataChannel;options.credentials?(startDateTime=options.credentials.startDateTime||(new Date).toISOString(),duration=options.credentials.duration||500,credentials=options.credentials.credentials||self._roomCredentials):self._roomCredentials&&(startDateTime=self._roomStart,duration=self._roomDuration,credentials=self._roomCredentials),self._apiKey=apiKey,self._roomServer=roomserver,self._defaultRoom=defaultRoom,self._selectedRoom=room,self._serverRegion=region,self._enableIceTrickle=iceTrickle,self._enableDataChannel=dataChannel,self._path=roomserver+"/api/"+apiKey+"/"+room,credentials&&(self._roomStart=startDateTime,self._roomDuration=duration,self._roomCredentials=credentials,self._path+=credentials?"/"+startDateTime+"/"+duration+"?&cred="+credentials:""),region&&(self._path+=(self._path.indexOf("?&")>-1?"&":"?&")+"rg="+region),self._requestServerInfo("GET",self._path,function(status,response){if(200!==status){var errorMessage="XMLHttpRequest status not OK.\nStatus was: "+status;return self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:status,content:response?response.info||errorMessage:errorMessage,errorCode:response.error||self.READY_STATE_CHANGE_ERROR.INVALID_XMLHTTPREQUEST_STATUS})}var info=response;try{self._key=info.cid,self._user={id:info.username,token:info.userCred,timeStamp:info.timeStamp,apiOwner:info.apiOwner,streams:[]},self._room={id:info.room_key,token:info.roomCred,start:info.start,len:info.len,signalingServer:{ip:info.ipSigserver,port:info.portSigserver,protocol:info.protocol},pcHelper:{pcConstraints:JSON.parse(info.pc_constraints),pcConfig:null,offerConstraints:JSON.parse(info.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}},callback()}catch(error){return self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR,{status:null,content:error,errorCode:self.READY_STATE_CHANGE_ERROR.SCRIPT_ERROR})}})},Skyway.prototype.setUserData=function(userData){var self=this;if(self._readyState===self.READY_STATE_CHANGE.COMPLETED)self._user.info=self._user.info||{},self._user.info.userData=userData||self._user.info.userData||{},self._in_room&&(self._sendMessage({type:self.SIG_TYPE.UPDATE_USER,mid:self._user.sid,rid:self._room.id,userData:self._user.info.userData}),self._trigger("peerUpdated",self._user.sid,self._user.info,!0));else var checkInRoom=setInterval(function(){self._readyState===self.READY_STATE_CHANGE.COMPLETED&&(clearInterval(checkInRoom),self.setUserData(userData))},50)},Skyway.prototype.getUserData=function(){return this._user&&this._user.info?this._user.info.userData||"":""},Skyway.prototype.getPeerInfo=function(peerId){return peerId&&peerId!==this._user.sid?this._peerInformations[peerId]:this._user?this._user.info:null},Skyway.prototype._events={channelOpen:[],channelClose:[],channelMessage:[],channelError:[],readyStateChange:[],handshakeProgress:[],candidateGenerationState:[],peerConnectionState:[],iceConnectionState:[],mediaAccessError:[],mediaAccessSuccess:[],peerJoined:[],peerUpdated:[],peerLeft:[],presenceChanged:[],incomingStream:[],incomingMessage:[],roomLock:[],dataChannelState:[],dataTransferState:[],systemAction:[]},Skyway.prototype.sendMessage=function(message,targetPeerId){var params={cid:this._key,data:message,mid:this._user.sid,rid:this._room.id,type:this.SIG_TYPE.PUBLIC_MESSAGE};targetPeerId&&(params.target=targetPeerId,params.type=this.SIG_TYPE.PRIVATE_MESSAGE),this._sendMessage(params),this._trigger("incomingMessage",{content:message,isPrivate:targetPeerId?!0:!1,targetPeerId:targetPeerId||null,isDataChannel:!1,senderPeerId:this._user.sid},this._user.sid,this._user.info,!0)},Skyway.prototype.sendP2PMessage=function(message,targetPeerId){for(var peerId in this._dataChannels)this._dataChannels.hasOwnProperty(peerId)&&(targetPeerId&&targetPeerId===peerId||!targetPeerId)&&this._sendDataChannel(peerId,{type:this.DC_TYPE.MESSAGE,isPrivate:!!targetPeerId,sender:this._user.sid,target:targetPeerId,data:message});this._trigger("incomingMessage",{content:message,isPrivate:targetPeerId?!0:!1,targetPeerId:targetPeerId||null,isDataChannel:!0,senderPeerId:this._user.sid},this._user.sid,this._user.info,!0)},Skyway.prototype.getUserMedia=function(options){var self=this,getStream=!1;if(options=options||{audio:!0,video:!0},self._user=self._user||{},self._user.info=self._user.info||{},self._user.info.settings=self._user.info.settings||{},self._user.streams=self._user.streams||[],self._user.info.settings?(options.video||options.audio)&&(self._user.info.settings.audio!==options.audio||self._user.info.settings.video!==options.video)&&(Object.keys(self._user.streams).length>0?(getStream=self._setStreams(options),getStream&&(self._user.streams=[])):getStream=!0):getStream=!0,self._parseStreamSettings(options),getStream)try{window.getUserMedia({audio:self._streamSettings.audio,video:self._streamSettings.video},function(stream){self._onUserMediaSuccess(stream)},function(error){self._onUserMediaError(error)})}catch(error){this._onUserMediaError(error,self)}else Object.keys(self._user.streams).length>0},Skyway.prototype._onUserMediaSuccess=function(stream){var self=this;self._trigger("mediaAccessSuccess",stream);var checkReadyState=setInterval(function(){if(self._readyState===self.READY_STATE_CHANGE.COMPLETED){clearInterval(checkReadyState),self._user.streams[stream.id]=stream,self._user.streams[stream.id].active=!0;var checkIfUserInRoom=setInterval(function(){self._in_room&&(clearInterval(checkIfUserInRoom),self._trigger("incomingStream",self._user.sid,stream,!0))},500)}},500)},Skyway.prototype._onUserMediaError=function(error){this._trigger("mediaAccessError",error)},Skyway.prototype._processSigMessage=function(messageString){var message=JSON.parse(messageString);if(message.type===this.SIG_TYPE.GROUP)for(var i=0;i<message.lists.length;i++)this._processSingleMessage(message.lists[i]);else this._processSingleMessage(message)},Skyway.prototype._processSingleMessage=function(message){this._trigger("channelMessage",message);var origin=message.mid;if(origin&&origin!==this._user.sid||(origin="Server"),message.mid!==this._user.sid||message.type===this.SIG_TYPE.REDIRECT||message.type===this.SIG_TYPE.IN_ROOM)switch(message.type){case this.SIG_TYPE.PUBLIC_MESSAGE:this._publicMessageHandler(message);break;case this.SIG_TYPE.PRIVATE_MESSAGE:this._privateMessageHandler(message);break;case this.SIG_TYPE.IN_ROOM:this._inRoomHandler(message);break;case this.SIG_TYPE.ENTER:this._enterHandler(message);break;case this.SIG_TYPE.WELCOME:this._welcomeHandler(message);break;case this.SIG_TYPE.OFFER:this._offerHandler(message);break;case this.SIG_TYPE.ANSWER:this._answerHandler(message);break;case this.SIG_TYPE.CANDIDATE:this._candidateHandler(message);break;case this.SIG_TYPE.BYE:this._byeHandler(message);break;case this.SIG_TYPE.REDIRECT:this._redirectHandler(message);break;case this.SIG_TYPE.UPDATE_USER:this._updateUserEventHandler(message);break;case this.SIG_TYPE.MUTE_VIDEO:this._muteVideoEventHandler(message);break;case this.SIG_TYPE.MUTE_AUDIO:this._muteAudioEventHandler(message);break;case this.SIG_TYPE.ROOM_LOCK:this._roomLockEventHandler(message)}},Skyway.prototype._redirectHandler=function(message){this._trigger("systemAction",message.action,message.info,message.reason)},Skyway.prototype._updateUserEventHandler=function(message){var targetMid=message.mid;this._peerInformations[targetMid]&&(this._peerInformations[targetMid].userData=message.userData||{},this._trigger("peerUpdated",targetMid,this._peerInformations[targetMid],!1))},Skyway.prototype._roomLockEventHandler=function(message){var targetMid=message.mid;this._trigger("roomLock",message.lock,targetMid,this._peerInformations[targetMid],!1)},Skyway.prototype._muteAudioEventHandler=function(message){var targetMid=message.mid;this._peerInformations[targetMid]&&(this._peerInformations[targetMid].mediaStatus.audioMuted=message.muted,this._trigger("peerUpdated",targetMid,this._peerInformations[targetMid],!1))},Skyway.prototype._muteVideoEventHandler=function(message){var targetMid=message.mid;this._peerInformations[targetMid]&&(this._peerInformations[targetMid].mediaStatus.videoMuted=message.muted,this._trigger("peerUpdated",targetMid,this._peerInformations[targetMid],!1))},Skyway.prototype._byeHandler=function(message){var targetMid=message.mid;this._removePeer(targetMid)},Skyway.prototype._privateMessageHandler=function(message){var targetMid=message.mid;this._trigger("incomingMessage",{content:message.data,isPrivate:!0,targetPeerId:message.target,isDataChannel:!1,senderPeerId:targetMid},targetMid,this._peerInformations[targetMid],!1)},Skyway.prototype._publicMessageHandler=function(message){var targetMid=message.mid;this._trigger("incomingMessage",{content:message.data,isPrivate:!1,targetPeerId:null,isDataChannel:!1,senderPeerId:targetMid},targetMid,this._peerInformations[targetMid],!1)},Skyway.prototype._inRoomHandler=function(message){var self=this;self._room.pcHelper.pcConfig=self._setFirefoxIceServers(message.pc_config),self._in_room=!0,self._user.sid=message.sid,self._trigger("peerJoined",self._user.sid,self._user.info,!0),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,self._user.sid),self._sendMessage({type:self.SIG_TYPE.ENTER,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,userInfo:self._user.info})},Skyway.prototype._enterHandler=function(message){var self=this,targetMid=message.mid;self._peerInformations[targetMid]||(self._peerInformations[targetMid]=message.userInfo,self._trigger("peerJoined",targetMid,message.userInfo,!1),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,targetMid),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.WELCOME,targetMid),self._sendMessage({type:self.SIG_TYPE.WELCOME,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,userInfo:self._user.info,target:targetMid}))},Skyway.prototype._welcomeHandler=function(message){var targetMid=message.mid;if(this._peerInformations[targetMid]){if(this._peerConnections[targetMid])return;if(this._peerHSPriorities[targetMid]||(this._peerHSPriorities[targetMid]=0),(!message.hasOwnProperty("hsPriority")||message.hsPriority<=this._peerHSPriorities[targetMid])&&-1!==message.hsPriority)return this._peerHSPriorities[targetMid]||(this._peerHSPriorities[targetMid]=Math.floor(1e3*Math.random()+1)),this._peerHSPriorities===message.hsPriority&&(this._peerHSPriorities+=Math.floor(15*Math.random()+1)),void this._sendMessage({type:this.SIG_TYPE.WELCOME,mid:this._user.sid,rid:this._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,userInfo:this._user.info,target:targetMid,restartNego:!0,hsPriority:this._peerHSPriorities[targetMid]})}message.agent=message.agent?message.agent:"chrome",this._enableIceTrickle="boolean"==typeof message.enableIceTrickle?message.enableIceTrickle:this._enableIceTrickle,this._enableDataChannel="boolean"==typeof message.enableDataChannel?message.enableDataChannel:this._enableDataChannel,this._peerInformations[targetMid]||(this._peerInformations[targetMid]=message.userInfo,this._trigger("peerJoined",targetMid,message.userInfo,!1),this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.WELCOME,targetMid)),this._openPeer(targetMid,{agent:message.agent,version:message.version},!0,message.receiveOnly)},Skyway.prototype._offerHandler=function(message){var self=this,targetMid=message.mid;message.agent=message.agent?message.agent:"Chrome",self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.OFFER,targetMid);var offer=new window.RTCSessionDescription(message),pc=self._peerConnections[targetMid];pc||(self._openPeer(targetMid,{agent:message.agent,version:message.version},!1),pc=self._peerConnections[targetMid]),pc.setRemoteDescription(new window.RTCSessionDescription(offer),function(){pc.setOffer="remote",self._popCandidate(targetMid),self._doAnswer(targetMid)},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error)})},Skyway.prototype._candidateHandler=function(message){var targetMid=message.mid,pc=this._peerConnections[targetMid],messageCan=message.candidate.split(" "),index=(messageCan[7],message.label),candidate=new window.RTCIceCandidate({sdpMLineIndex:index,candidate:message.candidate});pc?"local"===pc.setOffer&&!pc.setAnswer||"local"===pc.setAnswer&&!pc.setOffer?this._queueCandidate(targetMid,candidate):pc.addIceCandidate(candidate):this._queueCandidate(targetMid,candidate)},Skyway.prototype._answerHandler=function(message){var self=this,targetMid=message.mid;self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ANSWER,targetMid);var answer=new window.RTCSessionDescription(message),pc=self._peerConnections[targetMid];pc.setRemoteDescription(new window.RTCSessionDescription(answer),function(){pc.setAnswer="remote",self._popCandidate(targetMid)},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error)})},Skyway.prototype._removePeer=function(peerId){this._trigger("peerLeft",peerId,this._peerInformations[peerId],!1),this._peerConnections[peerId]&&this._peerConnections[peerId].close(),this._peerHSPriorities[peerId]&&delete this._peerHSPriorities[peerId],delete this._peerConnections[peerId],delete this._peerInformations[peerId]},Skyway.prototype._doAnswer=function(targetMid){var self=this,pc=self._peerConnections[targetMid];pc&&pc.createAnswer(function(answer){self._setLocalAndSendMessage(targetMid,answer)},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error)},self._room.pcHelper.sdpConstraints)},Skyway.prototype._openPeer=function(targetMid,peerBrowser,toOffer,receiveOnly){var self=this;self._peerConnections[targetMid]||(self._peerConnections[targetMid]=self._createPeerConnection(targetMid),receiveOnly||self._addLocalStream(targetMid),toOffer&&(self._enableDataChannel&&self._createDataChannel(targetMid),self._doCall(targetMid,peerBrowser)))},Skyway.prototype._addLocalStream=function(peerId){if(Object.keys(this._user.streams).length>0)for(var stream in this._user.streams)this._user.streams.hasOwnProperty(stream)&&this._user.streams[stream].active&&this._peerConnections[peerId].addStream(this._user.streams[stream])},Skyway.prototype._onRemoteStreamAdded=function(targetMid,event){"MCU"!==targetMid&&this._trigger("incomingStream",targetMid,event.stream,!1)},Skyway.prototype._doCall=function(targetMid,peerBrowser){var self=this,pc=self._peerConnections[targetMid],inputConstraints=self._room.pcHelper.offerConstraints,sc=self._room.pcHelper.sdpConstraints;for(var name in sc.mandatory)sc.mandatory.hasOwnProperty(name)&&(inputConstraints.mandatory[name]=sc.mandatory[name]);inputConstraints.optional.concat(sc.optional),checkMediaDataChannelSettings(peerBrowser.agent,peerBrowser.version,function(beOfferer,unifiedOfferConstraints){"moz"===window.webrtcDetectedType&&"MCU"===targetMid&&(unifiedOfferConstraints.mandatory=unifiedOfferConstraints.mandatory||{},unifiedOfferConstraints.mandatory.MozDontOfferDataChannel=!0,beOfferer=!0),beOfferer?pc.createOffer(function(offer){self._setLocalAndSendMessage(targetMid,offer)},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error)},unifiedOfferConstraints):self._sendMessage({type:self.SIG_TYPE.WELCOME,mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,userInfo:self._user.info,target:targetMid,restartNego:!0,hsPriority:-1})},inputConstraints)},Skyway.prototype._findSDPLine=function(sdpLines,condition,value){for(var index in sdpLines)if(sdpLines.hasOwnProperty(index))for(var c in condition)if(condition.hasOwnProperty(c)&&0===sdpLines[index].indexOf(c))return sdpLines[index]=value,[index,sdpLines[index]];return[]},Skyway.prototype._addStereo=function(sdpLines){var opusLineFound=!1,opusPayload=0,rtpmapLine=this._findSDPLine(sdpLines,["a=rtpmap:"]);if(rtpmapLine.length&&0===rtpmapLine[1].split(" ")[1].indexOf("opus/48000/")&&(opusLineFound=!0,opusPayload=rtpmapLine[1].split(" ")[0].split(":")[1]),opusLineFound){var fmtpLine=this._findSDPLine(sdpLines,["a=fmtp:"+opusPayload]);fmtpLine.length&&(sdpLines[fmtpLine[0]]=fmtpLine[1]+"; stereo=1")}return sdpLines},Skyway.prototype._setSDPBitrate=function(sdpLines){var bandwidth=this._streamSettings.bandwidth,maLineFound=this._findSDPLine(sdpLines,["m=","a="]).length,cLineFound=this._findSDPLine(sdpLines,["c="]).length;if(maLineFound&&cLineFound){if(bandwidth.audio){var audioLine=this._findSDPLine(sdpLines,["a=mid:audio","m=mid:audio"]);sdpLines.splice(audioLine[0],0,"b=AS:"+bandwidth.audio)}if(bandwidth.video){var videoLine=this._findSDPLine(sdpLines,["a=mid:video","m=mid:video"]);sdpLines.splice(videoLine[0],0,"b=AS:"+bandwidth.video)}if(bandwidth.data){var dataLine=this._findSDPLine(sdpLines,["a=mid:data","m=mid:data"]);sdpLines.splice(dataLine[0],0,"b=AS:"+bandwidth.data)}}return sdpLines},Skyway.prototype._setLocalAndSendMessage=function(targetMid,sessionDescription){var self=this,pc=self._peerConnections[targetMid];if(!(sessionDescription.type===self.HANDSHAKE_PROGRESS.ANSWER&&pc.setAnswer||sessionDescription.type===self.HANDSHAKE_PROGRESS.OFFER&&pc.setOffer)){var sdpLines=sessionDescription.sdp.split("\r\n");self._streamSettings.stereo&&self._addStereo(sdpLines),self._streamSettings.bandwidth&&(sdpLines=self._setSDPBitrate(sdpLines,self._streamSettings.bandwidth)),self._streamSettings.bandwidth=self._streamSettings.bandwidth||{},sessionDescription.sdp=sdpLines.join("\r\n"),pc.setLocalDescription(sessionDescription,function(){self._trigger("handshakeProgress",sessionDescription.type,targetMid),sessionDescription.type===self.HANDSHAKE_PROGRESS.ANSWER?pc.setAnswer="local":pc.setOffer="local",(self._enableIceTrickle||!self._enableIceTrickle&&sessionDescription.type!==self.HANDSHAKE_PROGRESS.OFFER)&&self._sendMessage({type:sessionDescription.type,sdp:sessionDescription.sdp,mid:self._user.sid,agent:window.webrtcDetectedBrowser,version:window.webrtcDetectedVersion,target:targetMid,rid:self._room.id})},function(error){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ERROR,targetMid,error)})}},Skyway.prototype._setFirefoxIceServers=function(config){if("moz"===window.webrtcDetectedType){for(var newIceServers=[{url:"stun:stun.services.mozilla.com"}],i=0;i<config.iceServers.length;i++){var iceServer=config.iceServers[i],iceServerType=iceServer.url.split(":")[0];if("stun"===iceServerType){if(iceServer.url.indexOf("google"))continue;iceServer.url=[iceServer.url],newIceServers.push(iceServer)}else{var newIceServer={};newIceServer.credential=iceServer.credential,newIceServer.url=iceServer.url.split(":")[0],newIceServer.username=iceServer.url.split(":")[1].split("@")[0],newIceServer.url+=":"+iceServer.url.split(":")[1].split("@")[1],newIceServers.push(newIceServer)}}config.iceServers=newIceServers}return config},Skyway.prototype._waitForMediaStream=function(callback,options){var self=this;options=options||{},self.getUserMedia(options);var hasAudio=options.audio?!1:!0,hasVideo=options.video?!1:!0;if(options.video||options.audio)var count=0,checkForStream=setInterval(function(){if(5>count)for(var stream in self._user.streams)self._user.streams.hasOwnProperty(stream)&&(options.audio&&self._user.streams[stream].getAudioTracks().length>0&&(hasAudio=!0),options.video&&self._user.streams[stream].getVideoTracks().length>0&&(hasVideo=!0),hasAudio&&hasVideo?(clearInterval(checkForStream),callback()):count++);else{clearInterval(checkForStream);var error=(!hasAudio&&options.audio?"Expected audio but no audio stream received":"")+"\n"+(!hasVideo&&options.video?"Expected video but no video stream received":"");self._trigger("mediaAccessError",error)}},2e3);else callback()},Skyway.prototype._setStreams=function(options){var hasAudioTracks=!1,hasVideoTracks=!1;if(this._user){for(var stream in this._user.streams)if(this._user.streams.hasOwnProperty(stream)){var audios=this._user.streams[stream].getAudioTracks(),videos=this._user.streams[stream].getVideoTracks();for(var audio in audios)audios.hasOwnProperty(audio)&&(audios[audio].enabled=options.audio,hasAudioTracks=!0);for(var video in videos)videos.hasOwnProperty(video)&&(videos[video].enabled=options.video,hasVideoTracks=!0);this._user.streams[stream].active=options.video||options.audio?!0:!1}return!hasAudioTracks&&options.audio||!hasVideoTracks&&options.video}},Skyway.prototype._createPeerConnection=function(targetMid){var pc,self=this;try{pc=new window.RTCPeerConnection(self._room.pcHelper.pcConfig,self._room.pcHelper.pcConstraints)}catch(error){return null}return pc.setOffer="",pc.setAnswer="",pc.ondatachannel=function(event){var dc=event.channel||event;self._enableDataChannel&&self._createDataChannel(targetMid,dc)},pc.onaddstream=function(event){self._onRemoteStreamAdded(targetMid,event)},pc.onicecandidate=function(event){self._onIceCandidate(targetMid,event)},pc.oniceconnectionstatechange=function(){checkIceConnectionState(targetMid,pc.iceConnectionState,function(iceConnectionState){self._trigger("iceConnectionState",iceConnectionState,targetMid)})},pc.onsignalingstatechange=function(){self._trigger("peerConnectionState",pc.signalingState,targetMid)},pc.onicegatheringstatechange=function(){self._trigger("candidateGenerationState",pc.iceGatheringState,targetMid)},pc},Skyway.prototype._queueCandidate=function(targetMid,candidate){this._peerCandidatesQueue[targetMid]=this._peerCandidatesQueue[targetMid]||[],this._peerCandidatesQueue[targetMid].push(candidate)},Skyway.prototype._popCandidate=function(targetMid){if(this._peerCandidatesQueue[targetMid]=this._peerCandidatesQueue[targetMid]||[],this._peerCandidatesQueue[targetMid].length>0){for(var i=0;i<this._peerCandidatesQueue[targetMid].length;i++){var candidate=this._peerCandidatesQueue[targetMid][i];this._peerConnections[targetMid].addIceCandidate(candidate)}delete this._peerCandidatesQueue[targetMid]}},Skyway.prototype._onIceCandidate=function(targetMid,event){if(event.candidate){if(this._enableIceTrickle){{var messageCan=event.candidate.candidate.split(" ");messageCan[7]}this._sendMessage({type:this.SIG_TYPE.CANDIDATE,label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate,mid:this._user.sid,target:targetMid,rid:this._room.id})}}else if(this._trigger("candidateGenerationState",this.CANDIDATE_GENERATION_STATE.COMPLETED,targetMid),!this._enableIceTrickle){var sessionDescription=this._peerConnections[targetMid].localDescription;this._sendMessage({type:sessionDescription.type,sdp:sessionDescription.sdp,mid:this._user.sid,agent:window.webrtcDetectedBrowser,target:targetMid,rid:this._room.id})}},Skyway.prototype._sendMessage=function(message){if(this._channel_open){var messageString=JSON.stringify(message);this._socket.send(messageString)}},Skyway.prototype._openChannel=function(){var self=this;if(!self._channel_open&&self._readyState===self.READY_STATE_CHANGE.COMPLETED){var ip_signaling=self._room.signalingServer.protocol+"://"+self._room.signalingServer.ip+":"+self._room.signalingServer.port;
self._socket=self._socketVersion>=1?io.connect(ip_signaling,{forceNew:!0}):window.io.connect(ip_signaling,{"force new connection":!0}),self._socket.on("connect",function(){self._channel_open=!0,self._trigger("channelOpen")}),self._socket.on("error",function(error){self._channel_open=!1,self._trigger("channelError",error)}),self._socket.on("disconnect",function(){self._trigger("channelClose")}),self._socket.on("message",function(message){self._processSigMessage(message)})}},Skyway.prototype._closeChannel=function(){this._channel_open&&(this._socket.disconnect(),this._socket=null,this._channel_open=!1)},Skyway.prototype._createDataChannel=function(peerId,dc){var self=this,channelName=dc?dc.label:peerId,pc=self._peerConnections[peerId],dcOpened=function(){self._dataChannels[peerId]=dc,self._trigger("dataChannelState",dc.readyState,peerId)};if("SCTP"===window.webrtcDetectedDCSupport||"plugin"===window.webrtcDetectedDCSupport){if(!dc){dc=pc.createDataChannel(channelName),self._trigger("dataChannelState",dc.readyState,peerId);var checkDcOpened=setInterval(function(){dc.readyState===self.DATA_CHANNEL_STATE.OPEN&&(clearInterval(checkDcOpened),dcOpened())},50)}dc.readyState===self.DATA_CHANNEL_STATE.OPEN?dcOpened():dc.onopen=dcOpened,dc.onerror=function(error){self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.ERROR,peerId,error)},dc.onclose=function(){self._closeDataChannel(peerId),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.CLOSED,peerId),self._peerConnections[peerId]&&self._createDataChannel(peerId)},dc.onmessage=function(event){self._dataChannelHandler(event.data,peerId,channelName)}}},Skyway.prototype._sendDataChannel=function(peerId,data){var dc=this._dataChannels[peerId];if(dc)if(dc.readyState===this.DATA_CHANNEL_STATE.OPEN){var dataString="object"==typeof data?JSON.stringify(data):data;dc.send(dataString)}else this._trigger("dataChannelState",this.DATA_CHANNEL_STATE.ERROR,peerId,"Datachannel is not ready.\nState is: "+dc.readyState)},Skyway.prototype._closeDataChannel=function(peerId){var dc=this._dataChannels[peerId];dc&&(dc.readyState!==this.DATA_CHANNEL_STATE.CLOSED&&dc.close(),delete this._dataChannels[peerId])},Skyway.prototype._dataChannelHandler=function(dataString,peerId,channelName){if("string"==typeof dataString){var data={};try{data=JSON.parse(dataString)}catch(error){return void this._dataChannelDATAHandler(peerId,dataString,this.DATA_TRANSFER_DATA_TYPE.BINARY_STRING,channelName)}switch(data.type){case this.DC_TYPE.WRQ:this._dataChannelWRQHandler(peerId,data,channelName);break;case this.DC_TYPE.ACK:this._dataChannelACKHandler(peerId,data,channelName);break;case this.DC_TYPE.ERROR:this._dataChannelERRORHandler(peerId,data,channelName);break;case this.DC_TYPE.CANCEL:this._dataChannelCANCELHandler(peerId,data,channelName);break;case this.DC_TYPE.MESSAGE:this._dataChannelMESSAGEHandler(peerId,data,channelName)}}},Skyway.prototype._dataChannelWRQHandler=function(peerId,data,channelName){var transferId=this._user.sid+this.DATA_TRANSFER_TYPE.DOWNLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),name=data.name,binarySize=data.size,expectedSize=data.chunkSize,timeout=data.timeout;this._downloadDataSessions[peerId]={transferId:transferId,name:name,size:binarySize,ackN:0,receivedSize:0,chunkSize:expectedSize,timeout:timeout},this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.UPLOAD_REQUEST,transferId,peerId,{name:name,size:binarySize,senderPeerId:peerId})},Skyway.prototype._dataChannelACKHandler=function(peerId,data,channelName){var self=this,ackN=data.ackN,chunksLength=self._uploadDataTransfers[peerId].length,uploadedDetails=self._uploadDataSessions[peerId],transferId=uploadedDetails.transferId,timeout=uploadedDetails.timeout;if(self._clearDataChannelTimeout(peerId,!0),ackN>-1)if(chunksLength>ackN){var fileReader=new FileReader;fileReader.onload=function(){var base64BinaryString=fileReader.result.split(",")[1];self._sendDataChannel(peerId,base64BinaryString),self._setDataChannelTimeout(peerId,timeout,!0),self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOADING,transferId,peerId,{percentage:((ackN+1)/chunksLength*100).toFixed()})},fileReader.readAsDataURL(self._uploadDataTransfers[peerId][ackN])}else ackN===chunksLength&&(self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOAD_COMPLETED,transferId,peerId,{name:uploadedDetails.name}),delete self._uploadDataTransfers[peerId],delete self._uploadDataSessions[peerId]);else self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.REJECTED,transferId,peerId),delete self._uploadDataTransfers[peerId],delete self._uploadDataSessions[peerId]},Skyway.prototype._dataChannelMESSAGEHandler=function(peerId,data,channelName){var targetMid=data.sender;this._trigger("incomingMessage",{content:data.data,isPrivate:data.isPrivate,isDataChannel:!0,targetPeerId:this._user.sid,senderPeerId:targetMid},targetMid,this._peerInformations[targetMid],!1)},Skyway.prototype._dataChannelERRORHandler=function(peerId,data,channelName){var isUploader=data.isUploadError,transferId=isUploader?this._uploadDataSessions[peerId].transferId:this._downloadDataSessions[peerId].transferId;this._clearDataChannelTimeout(peerId,isUploader),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,transferId,peerId,null,{name:data.name,message:data.content,transferType:isUploader?this.DATA_TRANSFER_TYPE.UPLOAD:this.DATA_TRANSFER_TYPE.DOWNLOAD})},Skyway.prototype._dataChannelCANCELHandler=function(peerId,data,channelName){var isUploader=data.isUploadError,transferId=isUploader?this._uploadDataSessions[peerId].transferId:this._downloadDataSessions[peerId].transferId;this._clearDataChannelTimeout(peerId,isUploader),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.CANCEL,transferId,peerId,null,{name:data.name,content:data.content,senderPeerId:data.sender,transferType:isUploader?this.DATA_TRANSFER_TYPE.UPLOAD:this.DATA_TRANSFER_TYPE.DOWNLOAD})},Skyway.prototype._dataChannelDATAHandler=function(peerId,dataString,dataType,channelName){var chunk,error="",transferStatus=this._downloadDataSessions[peerId],transferId=transferStatus.transferId;if(this._clearDataChannelTimeout(peerId,!1),dataType===this.DATA_TRANSFER_DATA_TYPE.BINARY_STRING)chunk=this._base64ToBlob(dataString);else if(dataType===this.DATA_TRANSFER_DATA_TYPE.ARRAY_BUFFER)chunk=new Blob(dataString);else{if(dataType!==this.DATA_TRANSFER_DATA_TYPE.BLOB)return error="Unhandled data exception: "+dataType,void this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,transferId,peerId,null,{message:error,transferType:this.DATA_TRANSFER_TYPE.DOWNLOAD});chunk=dataString}var receivedSize=chunk.size*(4/3);if(transferStatus.chunkSize>=receivedSize){this._downloadDataTransfers[peerId].push(chunk),transferStatus.ackN+=1,transferStatus.receivedSize+=receivedSize;var totalReceivedSize=transferStatus.receivedSize,percentage=(totalReceivedSize/transferStatus.size*100).toFixed();if(this._sendDataChannel(peerId,{type:this.DC_TYPE.ACK,sender:this._user.sid,ackN:transferStatus.ackN}),transferStatus.chunkSize===receivedSize)this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.DOWNLOADING,transferId,peerId,{percentage:percentage}),this._setDataChannelTimeout(peerId,transferStatus.timeout,!1),this._downloadDataTransfers[peerId].info=transferStatus;else{var blob=new Blob(this._downloadDataTransfers[peerId]);this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.DOWNLOAD_COMPLETED,transferId,peerId,{data:blob}),delete this._downloadDataTransfers[peerId],delete this._downloadDataSessions[peerId]}}else error="Packet not match - [Received]"+receivedSize+" / [Expected]"+transferStatus.chunkSize,this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,transferId,peerId,null,{message:error,transferType:this.DATA_TRANSFER_TYPE.DOWNLOAD})},Skyway.prototype.respondBlobRequest=function(peerId,accept){if(accept){this._downloadDataTransfers[peerId]=[];var data=this._downloadDataSessions[peerId];this._sendDataChannel(peerId,{type:this.DC_TYPE.ACK,sender:this._user.sid,ackN:0,agent:window.webrtcDetectedBrowser}),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.DOWNLOAD_STARTED,data.transferId,peerId,{name:data.name,size:data.size,senderPeerId:peerId})}else this._sendDataChannel(peerId,{type:this.DC_TYPE.ACK,sender:this._user.sid,ackN:-1}),delete this._downloadDataSessions[peerId]},Skyway.prototype.cancelBlobTransfer=function(peerId){if(accept){this._downloadDataTransfers[peerId]=[];var data=this._downloadDataSessions[peerId];this._sendDataChannel(peerId,{type:this.DC_TYPE.ACK,sender:this._user.sid,ackN:0,agent:window.webrtcDetectedBrowser}),this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.CANCEL,data.transferId,peerId,{name:data.name,size:data.size,senderPeerId:peerId})}else this._sendDataChannel(peerId,{type:this.DC_TYPE.ACK,sender:this._user.sid,ackN:-1}),delete this._downloadDataSessions[peerId]},Skyway.prototype._setDataChannelTimeout=function(peerId,timeout,isSender){var self=this;self._dataTransfersTimeout[peerId]||(self._dataTransfersTimeout[peerId]=[]);var type=isSender?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD;self._dataTransfersTimeout[peerId][type]=setTimeout(function(){var name;self._dataTransfersTimeout[peerId][type]&&(isSender?(name=self._uploadDataSessions[peerId].name,delete self._uploadDataTransfers[peerId],delete self._uploadDataSessions[peerId]):(name=self._downloadDataSessions[peerId].name,delete self._downloadDataTransfers[peerId],delete self._downloadDataSessions[peerId]),self._sendDataChannel(peerId,{type:self.DC_TYPE.ERROR,sender:self._user.sid,name:name,content:"Connection Timeout. Longer than "+timeout+" seconds. Connection is abolished.",isUploadError:isSender}),self._clearDataChannelTimeout(peerId,isSender))},1e3*timeout)},Skyway.prototype._clearDataChannelTimeout=function(peerId,isSender){if(this._dataTransfersTimeout[peerId]){var type=isSender?this.DATA_TRANSFER_TYPE.UPLOAD:this.DATA_TRANSFER_TYPE.DOWNLOAD;clearTimeout(this._dataTransfersTimeout[peerId][type]),delete this._dataTransfersTimeout[peerId][type]}},Skyway.prototype._base64ToBlob=function(dataURL){for(var byteString=atob(dataURL.replace(/\s\r\n/g,"")),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);return new Blob([ab])},Skyway.prototype._chunkFile=function(blob,blobByteSize){var chunksArray=[],startCount=0,endCount=0;if(blobByteSize>this._chunkFileSize){for(;blobByteSize-1>endCount;)endCount=startCount+this._chunkFileSize,chunksArray.push(blob.slice(startCount,endCount)),startCount+=this._chunkFileSize;blobByteSize-(startCount+1)>0&&chunksArray.push(blob.slice(startCount,blobByteSize-1))}else chunksArray.push(blob);return chunksArray},Skyway.prototype.sendBlobData=function(data,dataInfo,targetPeerId){if(!data&&!dataInfo)return!1;var noOfPeersSent=0;if(dataInfo.timeout=dataInfo.timeout||60,dataInfo.transferId=this._user.sid+this.DATA_TRANSFER_TYPE.UPLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),targetPeerId)this._dataChannels.hasOwnProperty(targetPeerId)&&(this._sendBlobDataToPeer(data,dataInfo,targetPeerId),noOfPeersSent=1);else{targetpeerId=this._user.sid;for(var peerId in this._dataChannels)this._dataChannels.hasOwnProperty(peerId)&&(this._sendBlobDataToPeer(data,dataInfo,peerId),noOfPeersSent++)}if(noOfPeersSent>0)this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.UPLOAD_STARTED,dataInfo.transferId,targetPeerId,{transferId:dataInfo.transferId,senderPeerId:this._user.sid,name:dataInfo.name,size:dataInfo.size,timeout:dataInfo.timeout||60,data:data});else{var error="No available datachannels to send data.";this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,transferId,targetPeerId,null,{message:error,transferType:this.DATA_TRANSFER_TYPE.UPLOAD}),this._uploadDataTransfers=[],this._uploadDataSessions=[]}},Skyway.prototype._sendBlobDataToPeer=function(data,dataInfo,targetPeerId){var binarySize=parseInt((dataInfo.size*(4/3)).toFixed(),10),chunkSize=parseInt((this._chunkFileSize*(4/3)).toFixed(),10);"firefox"===window.webrtcDetectedBrowser&&window.webrtcDetectedVersion<30&&(chunkSize=this._mozChunkFileSize),this._uploadDataTransfers[targetPeerId]=this._chunkFile(data,dataInfo.size),this._uploadDataSessions[targetPeerId]={name:dataInfo.name,size:binarySize,transferId:dataInfo.transferId,timeout:dataInfo.timeout},this._sendDataChannel(targetPeerId,{type:this.DC_TYPE.WRQ,sender:this._user.sid,agent:window.webrtcDetectedBrowser,name:dataInfo.name,size:binarySize,chunkSize:chunkSize,timeout:dataInfo.timeout}),this._setDataChannelTimeout(targetPeerId,dataInfo.timeout,!0)},Skyway.prototype._handleAV=function(mediaType,enableMedia){if(("audio"===mediaType||"video"===mediaType)&&this._in_room){var hasTracks=!1,isStreamActive=!1;for(var stream in this._user.streams)if(this._user.streams.hasOwnProperty(stream)){var tracks="audio"===mediaType?this._user.streams[stream].getAudioTracks():this._user.streams[stream].getVideoTracks();for(var track in tracks)tracks.hasOwnProperty(track)&&(tracks[track].enabled=enableMedia,hasTracks=!0);isStreamActive=this._user.streams[stream].active}if(hasTracks&&isStreamActive||!enableMedia)this._sendMessage({type:"audio"===mediaType?this.SIG_TYPE.MUTE_AUDIO:this.SIG_TYPE.MUTE_VIDEO,mid:this._user.sid,rid:this._room.id,muted:!enableMedia});else{this.leaveRoom();var hasProperty=this._user&&this._user.info&&this._user.info.settings?!0:!1;this.joinRoom({audio:"audio"===mediaType?!0:hasProperty?this._user.info.settings.audio:!1,video:"video"===mediaType?!0:hasProperty?this._user.info.settings.video:!1})}this._user.info.mediaStatus[mediaType+"Muted"]=!enableMedia,this._trigger("peerUpdated",this._user.sid,this._user.info,!0)}},Skyway.prototype.lockRoom=function(){this._sendMessage({type:this.SIG_TYPE.ROOM_LOCK,mid:this._user.sid,rid:this._room.id,lock:!0}),this._trigger("roomLock",!0,this._user.sid,this._user.info,!0)},Skyway.prototype.unlockRoom=function(){this._sendMessage({type:this.SIG_TYPE.ROOM_LOCK,mid:this._user.sid,rid:this._room.id,lock:!1}),this._trigger("roomLock",!1,this._user.sid,this._user.info,!0)},Skyway.prototype.enableAudio=function(){this._handleAV("audio",!0)},Skyway.prototype.disableAudio=function(){this._handleAV("audio",!1)},Skyway.prototype.enableVideo=function(){this._handleAV("video",!0)},Skyway.prototype.disableVideo=function(){this._handleAV("video",!1)},Skyway.prototype._parseStreamSettings=function(options){if(options=options||{},this._user.info=this._user.info||{},this._user.info.settings=this._user.info.settings||{},this._user.info.mediaStatus=this._user.info.mediaStatus||{},this._user.info.userData=options.userData||this._user.info.userData||"",this._streamSettings.bandwidth=options.bandwidth||this._streamSettings.bandwidth||{},this._user.info.settings.bandwidth=options.bandwidth||this._user.info.settings.bandwidth||{},this._user.info.settings.audio="boolean"==typeof options.audio||"object"==typeof options.audio?options.audio:this._streamSettings.audio||!1,this._user.info.mediaStatus.audioMuted=options.audio?"boolean"==typeof this._user.info.mediaStatus.audioMuted?this._user.info.mediaStatus.audioMuted:!options.audio:!0,this._user.info.settings.video="boolean"==typeof options.video||"object"==typeof options.video?options.video:this._streamSettings.video||!1,this._user.info.mediaStatus.videoMuted=options.video?"boolean"==typeof this._user.info.mediaStatus.videoMuted?this._user.info.mediaStatus.videoMuted:!options.video:!0,options.video||options.audio){if(options.video=options.video||!1,options.audio=options.audio||!1,"object"==typeof options.video&&"object"==typeof options.video.resolution){var width=options.video.resolution.width,height=options.video.resolution.height,frameRate="number"==typeof options.video.frameRate?options.video.frameRate:50;options.video=width&&height?{mandatory:{minWidth:width,minHeight:height},optional:[{minFrameRate:frameRate}]}:!0}"object"==typeof options.audio&&(options.stereo="boolean"==typeof options.audio.stereo?options.audio.stereo:!1,options.audio=!0),this._streamSettings.video=options.video,this._streamSettings.audio=options.audio,this._streamSettings.stereo=options.stereo}},Skyway.prototype.joinRoom=function(room,mediaOptions){var self=this;if(!self._in_room){var sendJoinRoomMessage=function(){self._sendMessage({type:self.SIG_TYPE.JOIN_ROOM,uid:self._user.id,cid:self._key,rid:self._room.id,userCred:self._user.token,timeStamp:self._user.timeStamp,apiOwner:self._user.apiOwner,roomCred:self._room.token,start:self._room.start,len:self._room.len})},doJoinRoom=function(){var checkChannelOpen=setInterval(function(){self._channel_open?(clearInterval(checkChannelOpen),self._waitForMediaStream(function(){sendJoinRoomMessage()},mediaOptions)):self._readyState===self.READY_STATE_CHANGE.COMPLETED&&self._openChannel()},500)};"string"==typeof room?self._reinit({room:room},doJoinRoom):(mediaOptions=room,doJoinRoom())}},Skyway.prototype.leaveRoom=function(){if(this._in_room){for(var pc_index in this._peerConnections)this._peerConnections.hasOwnProperty(pc_index)&&this._removePeer(pc_index);this._in_room=!1,this._closeChannel(),this._trigger("peerLeft",this._user.sid,this._user.info,!0)}}}).call(this);