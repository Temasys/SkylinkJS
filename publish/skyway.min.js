/*! skywayjs - v0.1.0 - 2014-07-16 */
if(RTCPeerConnection=null,getUserMedia=null,attachMediaStream=null,reattachMediaStream=null,isPluginInstalled=null,defineWebRTCInterface=null,pluginNeededButNotInstalledCb=null,webrtcDetectedBrowser={},ICEConnectionState={starting:"starting",checking:"checking",connected:"connected",completed:"connected",done:"completed",disconnected:"disconnected",failed:"failed",closed:"closed"},ICEConnectionFiredStates={},RTCDataChannels={},temPluginInfo={pluginId:"plugin0",type:"application/x-temwebrtcplugin",onload:"TemInitPlugin0"},TemPageId=Math.random().toString(36).slice(2),getBrowserVersion=function(){var tem,agent={},na=navigator,ua=na.userAgent,M=ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(na.mozGetUserMedia?agent.mozWebRTC=!0:na.webkitGetUserMedia?agent.webkitWebRTC=!0:ua.indexOf("Safari")&&("undefined"!=typeof InstallTrigger?agent.browser="Firefox":document.documentMode?agent.browser="IE":Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0?agent.browser="Safari":window.opera||na.userAgent.indexOf(" OPR/")>=0?agent.browser="Opera":window.chrome&&(agent.browser="Chrome"),agent.pluginWebRTC=!0),/trident/i.test(M[1])?(tem=/\brv[ :]+(\d+)/g.exec(ua)||[],agent.browser="IE",agent.version=parseInt(tem[1]||"0",10)):"Chrome"===M[1]&&(tem=ua.match(/\bOPR\/(\d+)/),null!==tem&&(agent.browser="Opera",agent.version=parseInt(tem[1],10))),agent.browser||(agent.browser=M[1]),!agent.version)try{M=M[2]?[M[1],M[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(tem=ua.match(/version\/(\d+)/i))&&M.splice(1,1,tem[1]),agent.version=parseInt(M[1],10)}catch(err){agent.version=0}return agent.os=navigator.platform,agent.isSCTPDCSupported=agent.mozWebRTC||"Chrome"===agent.browser&&agent.version>30||"Opera"===agent.browser&&agent.version>19,agent.isRTPDCSupported="Chrome"===agent.browser&&agent.version<30&&agent.version>24,agent.isPluginSupported=!agent.isSCTPDCSupported&&!agent.isRTPDCSupported,agent},webrtcDetectedBrowser=getBrowserVersion(),TemRTCPlugin=null,TemPrivateWebRTCReadyCb=function(){arguments.callee.StaticWasInit=arguments.callee.StaticWasInit||1,1===arguments.callee.StaticWasInit&&"function"==typeof WebRTCReadyCb&&WebRTCReadyCb(),arguments.callee.StaticWasInit++},TemInitPlugin0=function(){TemRTCPlugin.setPluginId(TemPageId,temPluginInfo.pluginId),TemRTCPlugin.setLogFunction(console),TemPrivateWebRTCReadyCb()},maybeFixConfiguration=function(pcConfig){if(null!==pcConfig)for(var i=0;i<pcConfig.iceServers.length;i++)pcConfig.iceServers[i].hasOwnProperty("urls")&&(pcConfig.iceServers[i].url=pcConfig.iceServers[i].urls,delete pcConfig.iceServers[i].urls)},checkIceConnectionState=function(peerID,iceConnectionState,callback,returnStateAlways){if("function"==typeof callback){peerID=peerID?peerID:"peer";var returnState=!1;ICEConnectionFiredStates[peerID]&&iceConnectionState!==ICEConnectionState.disconnected&&iceConnectionState!==ICEConnectionState.failed&&iceConnectionState!==ICEConnectionState.closed||(ICEConnectionFiredStates[peerID]=[]),iceConnectionState=ICEConnectionState[iceConnectionState],-1===ICEConnectionFiredStates[peerID].indexOf(iceConnectionState)&&(ICEConnectionFiredStates[peerID].push(iceConnectionState),iceConnectionState===ICEConnectionState.connected&&setTimeout(function(){ICEConnectionFiredStates[peerID].push(ICEConnectionState.done),callback(ICEConnectionState.done)},1e3),returnState=!0),(returnStateAlways||returnState)&&callback(iceConnectionState)}},checkMediaDataChannelSettings=function(isOffer,peerBrowserAgent,callback,constraints){if("function"==typeof callback){var peerBrowserVersion,beOfferer=!1;peerBrowserAgent.indexOf("|")>-1&&(peerBrowser=peerBrowserAgent.split("|"),peerBrowserAgent=peerBrowser[0],peerBrowserVersion=parseInt(peerBrowser[1],10));var isLocalFirefox=webrtcDetectedBrowser.mozWebRTC,isLocalFirefoxInterop=webrtcDetectedBrowser.mozWebRTC&&webrtcDetectedBrowser.version>30,isPeerFirefox="Firefox"===peerBrowserAgent,isPeerFirefoxInterop="Firefox"===peerBrowserAgent&&(peerBrowserVersion?peerBrowserVersion>30:!1);if(isOffer){if(isLocalFirefox&&isPeerFirefox||isLocalFirefoxInterop)try{delete constraints.mandatory.MozDontOfferDataChannel}catch(err){}else isLocalFirefox&&!isPeerFirefox&&(constraints.mandatory.MozDontOfferDataChannel=!0);if(!isLocalFirefox)for(var prop in constraints.mandatory)constraints.mandatory.hasOwnProperty(prop)&&-1!==prop.indexOf("Moz")&&delete constraints.mandatory[prop];callback(constraints)}else isLocalFirefox||!isPeerFirefox||isPeerFirefoxInterop||(beOfferer=!0),callback(beOfferer)}},webrtcDetectedBrowser.mozWebRTC)RTCPeerConnection=function(pcConfig,pcConstraints){return maybeFixConfiguration(pcConfig),new mozRTCPeerConnection(pcConfig,pcConstraints)},RTCSessionDescription=mozRTCSessionDescription,RTCIceCandidate=mozRTCIceCandidate,getUserMedia=navigator.mozGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");if(0===url_parts[0].indexOf("stun"))iceServer={url:url};else if(0===url_parts[0].indexOf("turn"))if(webrtcDetectedBrowser.version<27){var turn_url_parts=url.split("?");(1===turn_url_parts.length||0===turn_url_parts[1].indexOf("transport=udp"))&&(iceServer={url:turn_url_parts[0],credential:password,username:username})}else iceServer={url:url,credential:password,username:username};return iceServer},createIceServers=function(urls,username,password){var iceServers=[];for(i=0;i<urls.length;i++){var iceServer=createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},attachMediaStream=function(element,stream){return element.mozSrcObject=stream,element.play(),element},reattachMediaStream=function(to,from){return to.mozSrcObject=from.mozSrcObject,to.play(),to},MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]}),TemPrivateWebRTCReadyCb();else if(webrtcDetectedBrowser.webkitWebRTC)createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");return 0===url_parts[0].indexOf("stun")?iceServer={url:url}:0===url_parts[0].indexOf("turn")&&(iceServer={url:url,credential:password,username:username}),iceServer},createIceServers=function(urls,username,password){var iceServers=[];if(webrtcDetectedBrowser.version>=34)iceServers={urls:urls,credential:password,username:username};else for(i=0;i<urls.length;i++){var iceServer=createIceServer(urls[i],username,password);null!==iceServer&&iceServers.push(iceServer)}return iceServers},RTCPeerConnection=function(pcConfig,pcConstraints){return webrtcDetectedBrowser.version<34&&maybeFixConfiguration(pcConfig),new webkitRTCPeerConnection(pcConfig,pcConstraints)},getUserMedia=navigator.webkitGetUserMedia.bind(navigator),navigator.getUserMedia=getUserMedia,attachMediaStream=function(element,stream){return"undefined"!=typeof element.srcObject?element.srcObject=stream:"undefined"!=typeof element.mozSrcObject?element.mozSrcObject=stream:"undefined"!=typeof element.src&&(element.src=URL.createObjectURL(stream)),element},reattachMediaStream=function(to,from){return to.src=from.src,to},TemPrivateWebRTCReadyCb();else if(webrtcDetectedBrowser.pluginWebRTC){var isFirefox="Firefox"===webrtcDetectedBrowser.browser,isSafari="Safari"===webrtcDetectedBrowser.browser,isChrome="Chrome"===webrtcDetectedBrowser.browser,isIE="IE"===webrtcDetectedBrowser.browser;TemRTCPlugin=document.createElement("object"),TemRTCPlugin.id=temPluginInfo.pluginId,TemRTCPlugin.style.visibility="hidden",TemRTCPlugin.type=temPluginInfo.type,TemRTCPlugin.innerHTML='<param name="onload" value="'+temPluginInfo.onload+'"><param name="pluginId" value="'+temPluginInfo.pluginId+'"><param name="pageId" value="'+TemPageId+'">',document.getElementsByTagName("body")[0].appendChild(TemRTCPlugin),TemRTCPlugin.onreadystatechange=function(state){},isPluginInstalled=function(comName,plugName,installedCb,notInstalledCb){if(isChrome||isSafari||isFirefox){for(var pluginArray=navigator.plugins,i=0;i<pluginArray.length;i++)if(pluginArray[i].name.indexOf(plugName)>=0)return void installedCb();notInstalledCb()}else{if(!isIE)return;try{{new ActiveXObject(comName+"."+plugName)}}catch(e){return void notInstalledCb()}installedCb()}},defineWebRTCInterface=function(){isDefined=function(variable){return null!==variable&&void 0!==variable},createIceServer=function(url,username,password){var iceServer=null,url_parts=url.split(":");return 0===url_parts[0].indexOf("stun")?iceServer={url:url,hasCredentials:!1}:0===url_parts[0].indexOf("turn")&&(iceServer={url:url,hasCredentials:!0,credential:password,username:username}),iceServer},createIceServers=function(urls,username,password){for(var iceServers=[],i=0;i<urls.length;++i)iceServers.push(createIceServer(urls[i],username,password));return iceServers},RTCSessionDescription=function(info){return TemRTCPlugin.ConstructSessionDescription(info.type,info.sdp)},RTCPeerConnection=function(servers,constraints){var iceServers=null;if(servers){iceServers=servers.iceServers;for(var i=0;i<iceServers.length;i++)iceServers[i].urls&&!iceServers[i].url&&(iceServers[i].url=iceServers[i].urls),iceServers[i].hasCredentials=isDefined(iceServers[i].username)&&isDefined(iceServers[i].credential)}var mandatory=constraints&&constraints.mandatory?constraints.mandatory:null,optional=constraints&&constraints.optional?constraints.optional:null;return TemRTCPlugin.PeerConnection(TemPageId,iceServers,mandatory,optional)},MediaStreamTrack={},MediaStreamTrack.getSources=function(callback){TemRTCPlugin.GetSources(callback)},getUserMedia=function(constraints,successCallback,failureCallback){constraints.audio||(constraints.audio=!1),TemRTCPlugin.getUserMedia(constraints,successCallback,failureCallback)},navigator.getUserMedia=getUserMedia,attachMediaStream=function(element,stream){if(stream.enableSoundTracks(!0),"audio"!==element.nodeName.toLowerCase()){var elementId=0===element.id.length?Math.random().toString(36).slice(2):element.id;if(element.isTemWebRTCPlugin&&element.isTemWebRTCPlugin()){for(var children=element.children,i=0;i!==children.length;++i)if("streamId"===children[i].name){children[i].value=stream.id;break}element.setStreamId(stream.id)}else{var frag=document.createDocumentFragment(),temp=document.createElement("div"),classHTML=element.className?'class="'+element.className+'" ':"";for(temp.innerHTML='<object id="'+elementId+'" '+classHTML+'type="application/x-temwebrtcplugin"><param name="pluginId" value="'+elementId+'" /> <param name="pageId" value="'+TemPageId+'" /> <param name="streamId" value="'+stream.id+'" /> </object>';temp.firstChild;)frag.appendChild(temp.firstChild);var rectObject=element.getBoundingClientRect();element.parentNode.insertBefore(frag,element),frag=document.getElementById(elementId),frag.width=rectObject.width+"px",frag.height=rectObject.height+"px",element.parentNode.removeChild(element)}var newElement=document.getElementById(elementId);return newElement.onclick=element.onclick?element.onclick:function(){},newElement._TemOnClick=function(id){var arg={srcElement:document.getElementById(id)};newElement.onclick(arg)},newElement}return element},reattachMediaStream=function(to,from){for(var stream=null,children=from.children,i=0;i!==children.length;++i)if("streamId"===children[i].name){stream=TemRTCPlugin.getStreamWithId(TemPageId,children[i].value);break}return null!==stream?attachMediaStream(to,stream):void alert("Could not find the stream associated with this element")},RTCIceCandidate=function(candidate){return candidate.sdpMid||(candidate.sdpMid=""),TemRTCPlugin.ConstructIceCandidate(candidate.sdpMid,candidate.sdpMLineIndex,candidate.candidate)}},pluginNeededButNotInstalledCb=function(){alert("Your browser is not webrtc ready and Temasys plugin is not installed")},isPluginInstalled("Tem","TemWebRTCPlugin",defineWebRTCInterface,pluginNeededButNotInstalledCb)}(function(){function Skyway(){return this instanceof Skyway?(this.VERSION="0.1.0",this.ICE_CONNECTION_STATE={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",DISCONNECTED:"disconnected"},this.PEER_CONNECTION_STATE={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",HAVE_LOCAL_PRANSWER:"have-local-pranswer",HAVE_REMOTE_PRANSWER:"have-remote-pranswer",ESTABLISHED:"established",CLOSED:"closed"},this.CANDIDATE_GENERATION_STATE={GATHERING:"gathering",DONE:"done"},this.HANDSHAKE_PROGRESS={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer"},this.DATA_CHANNEL_STATE={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",NEW:"new",LOADED:"loaded",ERROR:"error"},this.SYSTEM_ACTION={WARNING:"warning",REJECT:"reject",CLOSED:"close"},this.READY_STATE_CHANGE={INIT:0,LOADING:1,COMPLETED:2,ERROR:0,APIERROR:-2},this.DATA_TRANSFER_TYPE={UPLOAD:"upload",DOWNLOAD:"download"},this.DATA_TRANSFER_STATE={UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted"},this.DATA_TRANSFER_DATA_TYPE={BINARYSTRING:"binaryString",ARRAYBUFFER:"arrayBuffer",BLOB:"blob"},this._path=null,this._key=null,this._socket=null,this._socketVersion=null,this._user=null,this._room=null,this._peerConnections=[],this._dataChannels=[],this._dataChannelPeers=[],this._readyState=0,this._channel_open=!1,this._in_room=!1,this._uploadDataTransfers={},this._uploadDataSessions={},this._downloadDataTransfers={},this._downloadDataSessions={},this._dataTransfersTimeout={},this._chunkFileSize=49152,this._requireVideo=!0,this._loadSocket=function(ipSigserver,portSigserver,onSuccess,onError){var socketScript=document.createElement("script");socketScript.src="http://"+ipSigserver+":"+portSigserver+"/socket.io/socket.io.js",socketScript.onreadystatechange=onSuccess,socketScript.onload=onSuccess,socketScript.onerror=onError,document.head.appendChild(socketScript)},this._parseInfo=function(info,self){return info.pc_constraints||info.offer_constraints?(self._key=info.cid,self._user={id:info.username,token:info.userCred,timeStamp:info.timeStamp,displayName:info.displayName,apiOwner:info.apiOwner,streams:[]},self._room={id:info.room_key,token:info.roomCred,start:info.start,len:info.len,signalingServer:{ip:info.ipSigserver,port:info.portSigserver},pcHelper:{pcConstraints:JSON.parse(info.pc_constraints),pcConfig:null,offerConstraints:JSON.parse(info.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}},void self._loadSocket(info.ipSigserver,info.portSigserver,function(){window.io&&(self._readyState=2,self._trigger("readyStateChange",self.READY_STATE_CHANGE.COMPLETED))},function(err){})):void self._trigger("readyStateChange",this.READY_STATE_CHANGE.APIERROR)},void(this._init=function(self){if(window.XMLHttpRequest&&window.RTCPeerConnection&&this._path){self._readyState=1,self._trigger("readyStateChange",self.READY_STATE_CHANGE.LOADING);var xhr=new window.XMLHttpRequest;xhr.onreadystatechange=function(){if(this.readyState===this.DONE){if(200!==this.status)return self._readyState=0,void self._trigger("readyStateChange",self.READY_STATE_CHANGE.ERROR);self._parseInfo(JSON.parse(this.response),self),self._requireVideo&&self.getDefaultStream()}},xhr.open("GET",self._path,!0),xhr.send()}})):new Skyway}this.Skyway=Skyway,Skyway.prototype.on=function(eventName,callback){"function"==typeof callback&&(this._events[eventName]=this._events[eventName]||[],this._events[eventName].push(callback))},Skyway.prototype.off=function(eventName,callback){if(void 0===callback)return void(this._events[eventName]=[]);for(var arr=this._events[eventName],l=arr.length,i=0;l>i;i++)if(arr[i]===callback){arr.splice(i,1);break}},Skyway.prototype._trigger=function(eventName){var args=Array.prototype.slice.call(arguments),arr=this._events[eventName];args.shift();for(var e in arr)if(arr[e].apply(this,args)===!1)break},Skyway.prototype.init=function(roomserver,appID,room,requireVideo,startTime,duration,credential,region){roomserver.lastIndexOf("/")!==roomserver.length-1&&(roomserver+="/"),this._readyState=0,this._trigger("readyStateChange",this.READY_STATE_CHANGE.INIT),this._key=appID,this._requireVideo=requireVideo?requireVideo:!1,region||(region="us1"),this._path=roomserver+"api/"+appID+"/"+room,startTime&&duration&&credential&&(this._path+="/"+startTime+"/"+duration+"?&cred="+credential),this._path+=(this._path.indexOf("?&")>-1?"&":"?&")+"rg="+region,this._init(this)},Skyway.prototype.setUser=function(user){this._user=user},Skyway.prototype._events={channelOpen:[],channelClose:[],channelMessage:[],channelError:[],joinedRoom:[],readyStateChange:[],handshakeProgress:[],candidateGenerationState:[],peerConnectionState:[],iceConnectionState:[],mediaAccessError:[],mediaAccessSuccess:[],chatMessage:[],peerJoined:[],peerLeft:[],presenceChanged:[],roomLock:[],addPeerStream:[],removePeerStream:[],peerVideoMute:[],peerAudioMute:[],addContact:[],removeContact:[],invitePeer:[],dataChannelState:[],dataTransferState:[],systemAction:[],privateMessage:[],publicMessage:[]},Skyway.prototype.sendChatMsg=function(chatMsg,targetPeerID){var msg_json={cid:this._key,data:chatMsg,mid:this._user.sid,nick:this._user.displayName,rid:this._room.id,type:"chat"};targetPeerID&&(msg_json.target=targetPeerID),this._sendMessage(msg_json),this._trigger("chatMessage",chatMsg,this._user.displayName,!!targetPeerID)},Skyway.prototype.sendPrivateMsg=function(data,targetPeerID){var msg_json={cid:this._key,data:data,mid:this._user.sid,nick:this._user.displayName,rid:this._room.id,type:"private"};targetPeerID&&(msg_json.target=targetPeerID),this._sendMessage(msg_json),this._trigger("privateMessage",data,this._user.displayName,targetPeerID,!0)},Skyway.prototype.sendPublicMsg=function(data){var msg_json={cid:this._key,data:data,mid:this._user.sid,nick:this._user.displayName,rid:this._room.id,type:"public"};this._sendMessage(msg_json),this._trigger("publicMessage",this._user.displayName,data,!0)},Skyway.prototype.getDefaultStream=function(){var self=this;try{window.getUserMedia({audio:!0,video:!0},function(s){self._onUserMediaSuccess(s,self)},function(e){self._onUserMediaError(e,self)})}catch(e){this._onUserMediaError(e,self)}},Skyway.prototype._onUserMediaSuccess=function(stream,self){self._trigger("mediaAccessSuccess",stream),self._user.streams.push(stream)},Skyway.prototype._onUserMediaError=function(e,self){e.message,e.constraintName,self._trigger("mediaAccessError",e.name||e)},Skyway.prototype._processSigMsg=function(message){var msg=JSON.parse(message);if("group"===msg.type)for(var i=0;i<msg.lists.length;i++)this._processSingleMsg(msg.lists[i]);else this._processSingleMsg(msg)},Skyway.prototype._processSingleMsg=function(msg){this._trigger("channelMessage");var origin=msg.mid;if(origin&&origin!==this._user.sid||(origin="Server"),msg.mid!==this._user.sid||"redirect"===msg.type||"inRoom"===msg.type||"chat"===msg.type)switch(msg.type){case"public":this._privateMsgHandler(msg);break;case"private":this._privateMsgHandler(msg);break;case"inRoom":this._inRoomHandler(msg);break;case"enter":this._enterHandler(msg);break;case"welcome":this._welcomeHandler(msg);break;case"offer":this._offerHandler(msg);break;case"answer":this._answerHandler(msg);break;case"candidate":this._candidateHandler(msg);break;case"bye":this._byeHandler(msg);break;case"chat":this._chatHandler(msg);break;case"redirect":this._redirectHandler(msg);break;case"update_guest_name":break;case"error":break;case"invite":break;case"video_mute_event":break;case"roomLockEvent":}},Skyway.prototype._chatHandler=function(msg){this._trigger("chatMessage",msg.data,msg.id===this._user.sid?"Me, myself and I":msg.nick,msg.target?!0:!1)},Skyway.prototype._redirectHandler=function(msg){this._trigger("systemAction",msg.action,msg.info)},Skyway.prototype._byeHandler=function(msg){var targetMid=msg.mid;this._removePeer(targetMid)},Skyway.prototype._privateMsgHandler=function(msg){this._trigger("privateMessage",msg.data,msg.nick,msg.target,!1)},Skyway.prototype._publicMsgHandler=function(msg){this._trigger("publicMessage",msg.nick,msg.data,!1)},Skyway.prototype._removePeer=function(peerID){this._trigger("peerLeft",peerID),this._peerConnections[peerID]&&this._peerConnections[peerID].close(),delete this._peerConnections[peerID]},Skyway.prototype._inRoomHandler=function(msg){this._room.pcHelper.pcConfig=this._setFirefoxIceServers(msg.pc_config),this._in_room=!0,this._user.sid=msg.sid,this._trigger("joinedRoom",this._room.id,this._user.sid);var self=this;this._waitForMediaStream(function(){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER),self._sendMessage({type:"enter",mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser.browser,version:window.webrtcDetectedBrowser.version,nick:self._user.displayName})})},Skyway.prototype._enterHandler=function(msg){var targetMid=msg.mid,self=this;if(!self._requireVideo||self._user.streams.length>0){if(self._peerConnections[targetMid])return;var browserAgent=msg.agent+(msg.version?"|"+msg.version:"");checkMediaDataChannelSettings(!1,browserAgent,function(beOfferer){self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.ENTER,targetMid);var params={type:beOfferer?"enter":"welcome",mid:self._user.sid,rid:self._room.id,agent:window.webrtcDetectedBrowser.browser,nick:self._user.displayName};beOfferer||(self._trigger("peerJoined",targetMid),self._trigger("handshakeProgress",self.HANDSHAKE_PROGRESS.WELCOME,targetMid),params.target=targetMid),self._sendMessage(params)})}},Skyway.prototype._welcomeHandler=function(msg){var targetMid=msg.mid;this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.WELCOME,targetMid),this._trigger("peerJoined",targetMid),this._peerConnections[targetMid]||this._openPeer(targetMid,msg.agent,!0)},Skyway.prototype._offerHandler=function(msg){var targetMid=msg.mid;this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.OFFER,targetMid);var offer=new window.RTCSessionDescription(msg),pc=this._peerConnections[targetMid];pc||(this._openPeer(targetMid,msg.agent,!1),pc=this._peerConnections[targetMid]);var self=this;pc.setRemoteDescription(new RTCSessionDescription(offer),function(){self._doAnswer(targetMid)},function(err){})},Skyway.prototype._doAnswer=function(targetMid){var pc=this._peerConnections[targetMid],self=this;pc&&pc.createAnswer(function(answer){self._setLocalAndSendMessage(targetMid,answer)},function(error){self._onOfferOrAnswerError(targetMid,error,"answer")},self._room.pcHelper.sdpConstraints)},Skyway.prototype._onOfferOrAnswerError=function(targetMid,error,type){},Skyway.prototype._openPeer=function(targetMid,peerAgentBrowser,toOffer){var self=this;self._peerConnections[targetMid]=self._createPeerConnection(targetMid),self._addLocalStream(targetMid),toOffer&&self._createDataChannel(targetMid,function(dc){self._dataChannels[targetMid]=dc,self._dataChannelPeers[dc.label]=targetMid,self._checkDataChannelStatus(dc),self._doCall(targetMid,peerAgentBrowser)})},Skyway.prototype._addLocalStream=function(peerID){if(this._user.streams.length>0)for(var i in this._user.streams)this._user.streams.hasOwnProperty(i)&&this._peerConnections[peerID].addStream(this._user.streams[i])},Skyway.prototype._onRemoteStreamAdded=function(targetMid,event){this._trigger("addPeerStream",targetMid,event.stream)},Skyway.prototype._doCall=function(targetMid,peerAgentBrowser){var pc=this._peerConnections[targetMid],constraints=this._room.pcHelper.offerConstraints,sc=this._room.pcHelper.sdpConstraints;for(var name in sc.mandatory)sc.mandatory.hasOwnProperty(name)&&(constraints.mandatory[name]=sc.mandatory[name]);constraints.optional.concat(sc.optional);var self=this;checkMediaDataChannelSettings(!0,peerAgentBrowser,function(offerConstraints){pc.createOffer(function(offer){self._setLocalAndSendMessage(targetMid,offer)},function(error){self._onOfferOrAnswerError(targetMid,error,"offer")},offerConstraints)},constraints)},Skyway.prototype._setLocalAndSendMessage=function(targetMid,sessionDescription){var pc=this._peerConnections[targetMid],self=this;pc.setLocalDescription(sessionDescription,function(){self._trigger("handshakeProgress",sessionDescription.type,targetMid),self._sendMessage({type:sessionDescription.type,sdp:sessionDescription.sdp,mid:self._user.sid,agent:window.webrtcDetectedBrowser.browser,target:targetMid,rid:self._room.id})},function(){})},Skyway.prototype._setFirefoxIceServers=function(config){if(window.webrtcDetectedBrowser.mozWebRTC){for(var newIceServers=[{url:"stun:stun.services.mozilla.com"}],i=0;i<config.iceServers.length;i++){var iceServer=config.iceServers[i],iceServerType=iceServer.url.split(":")[0];if("stun"===iceServerType){if(iceServer.url.indexOf("google"))continue;iceServer.url=[iceServer.url],newIceServers.push(iceServer)}else{var newIceServer={};newIceServer.credential=iceServer.credential,newIceServer.url=iceServer.url.split(":")[0],newIceServer.username=iceServer.url.split(":")[1].split("@")[0],newIceServer.url+=":"+iceServer.url.split(":")[1].split("@")[1],newIceServers.push(newIceServer)}}config.iceServers=newIceServers}return config},Skyway.prototype._waitForMediaStream=function(callback){var self=this,checkForStream=setInterval(function(){var waitForStream=self._requireVideo&&!(self._user&&self._user.streams.length>0);waitForStream||(clearInterval(checkForStream),callback())},2e3)},Skyway.prototype._createPeerConnection=function(targetMid){var pc;try{pc=new window.RTCPeerConnection(this._room.pcHelper.pcConfig,this._room.pcHelper.pcConstraints)}catch(e){return null}var self=this;return pc.ondatachannel=function(event){var dc=event.channel||event;self._createDataChannel(targetMid,function(dc){self._dataChannels[targetMid]=dc,self._dataChannelPeers[dc.label]=targetMid,self._checkDataChannelStatus(dc)},dc)},pc.onaddstream=function(event){self._onRemoteStreamAdded(targetMid,event)},pc.onicecandidate=function(event){self._onIceCandidate(targetMid,event)},pc.oniceconnectionstatechange=function(){checkIceConnectionState(targetMid,pc.iceConnectionState,function(iceConnectionState){self._trigger("iceConnectionState",iceConnectionState,targetMid)})},pc.onsignalingstatechange=function(){var signalingState=pc.signalingState;pc.signalingState!==self.PEER_CONNECTION_STATE.STABLE&&pc.signalingState!==self.PEER_CONNECTION_STATE.CLOSED?pc.hasSetOffer=!0:pc.signalingState===self.PEER_CONNECTION_STATE.STABLE&&pc.hasSetOffer&&(signalingState=self.PEER_CONNECTION_STATE.ESTABLISHED),self._trigger("peerConnectionState",signalingState,targetMid)},pc.onicegatheringstatechange=function(){self._trigger("candidateGenerationState",pc.iceGatheringState,targetMid)},pc},Skyway.prototype._onIceCandidate=function(targetMid,event){if(event.candidate){{var msgCan=event.candidate.candidate.split(" ");msgCan[7]}this._sendMessage({type:"candidate",label:event.candidate.sdpMLineIndex,id:event.candidate.sdpMid,candidate:event.candidate.candidate,mid:this._user.sid,target:targetMid,rid:this._room.id})}else this._trigger("candidateGenerationState",this.CANDIDATE_GENERATION_STATE.DONE,targetMid)},Skyway.prototype._candidateHandler=function(msg){var targetMid=msg.mid,pc=this._peerConnections[targetMid];if(pc){if(pc.iceConnectionState===this.ICE_CONNECTION_STATE.CONNECTED)return;var msgCan=msg.candidate.split(" "),index=(msgCan[7],msg.label),candidate=new window.RTCIceCandidate({sdpMLineIndex:index,candidate:msg.candidate});pc.addIceCandidate(candidate)}},Skyway.prototype._answerHandler=function(msg){var targetMid=msg.mid;this._trigger("handshakeProgress",this.HANDSHAKE_PROGRESS.ANSWER,targetMid);var answer=new window.RTCSessionDescription(msg),pc=this._peerConnections[targetMid];pc.setRemoteDescription(new RTCSessionDescription(answer),function(){pc.remotePeerReady=!0},function(err){})},Skyway.prototype._sendMessage=function(message){if(this._channel_open){var msgString=JSON.stringify(message);this._socket.send(msgString)}},Skyway.prototype._openChannel=function(){var self=this,_openChannelImpl=function(readyState){if(2===readyState){self.off("readyStateChange",_openChannelImpl);var ip_signaling="ws://"+self._room.signalingServer.ip+":"+self._room.signalingServer.port;self._socket=self._socketVersion>=1?io.connect(ip_signaling,{forceNew:!0}):window.io.connect(ip_signaling,{"force new connection":!0}),self._socket=window.io.connect(ip_signaling,{"force new connection":!0}),self._socket.on("connect",function(){self._channel_open=!0,self._trigger("channelOpen")}),self._socket.on("error",function(err){self._channel_open=!1,self._trigger("channelError",err)}),self._socket.on("disconnect",function(){self._trigger("channelClose")}),self._socket.on("message",function(msg){self._processSigMsg(msg)})}};this._channel_open||(0===this._readyState?(this.on("readyStateChange",_openChannelImpl),this._init(this)):_openChannelImpl(2))},Skyway.prototype._closeChannel=function(){this._channel_open&&(this._socket.disconnect(),this._socket=null,this._channel_open=!1,this._readyState=0)},Skyway.prototype._createDataChannel=function(peerID,callback,dc){var self=this,pc=self._peerConnections[peerID],channel_name=self._user.id+"_"+peerID;dc?channel_name=dc.label:(!webrtcDetectedBrowser.isSCTPDCSupported&&!webrtcDetectedBrowser.isPluginSupported,dc=pc.createDataChannel(channel_name)),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.NEW,peerID),dc.onerror=function(err){self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.ERROR,peerID)},dc.onclose=function(){self._closeDataChannel(peerID,self),self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.CLOSED,peerID)},dc.onopen=function(){dc.push=dc.send,dc.send=function(data){dc.push(data)}},dc.onmessage=function(event){self._dataChannelHandler(event.data,peerID,self)},self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.LOADED,peerID),callback(dc)},Skyway.prototype._checkDataChannelStatus=function(dc){var self=this;setTimeout(function(){var peerID=self._dataChannelPeers[dc.label];self._trigger("dataChannelState",dc.readyState,peerID),dc.readyState===self.DATA_CHANNEL_STATE.OPEN&&self._sendDataChannel(peerID,["CONN",dc.label])},500)},Skyway.prototype._sendDataChannel=function(peerID,data){var dc=this._dataChannels[peerID];if(dc&&dc.readyState===this.DATA_CHANNEL_STATE.OPEN)try{for(var dataString="",i=0;i<data.length;i++)dataString+=data[i],dataString+=i!==data.length-1?"|":"";dc.send(dataString)}catch(err){}},Skyway.prototype._dataChannelPeer=function(channel,self){return self._dataChannelPeers[channel]},Skyway.prototype._closeDataChannel=function(peerID,self){var dc=self._dataChannels[peerID];dc&&(dc.readyState!==self.DATA_CHANNEL_STATE.CLOSED&&dc.close(),delete self._dataChannels[peerID],delete self._dataChannelPeers[dc.label])},Skyway.prototype._dataChannelHandler=function(dataString,peerID,self){if("string"==typeof dataString)if(dataString.indexOf("|")>-1&&dataString.indexOf("|")<6){var data=dataString.split("|"),state=data[0];switch(state){case"CONN":self._trigger("dataChannelState",self.DATA_CHANNEL_STATE.OPEN,peerID);break;case"WRQ":self._dataChannelWRQHandler(peerID,data,self);break;case"ACK":self._dataChannelACKHandler(peerID,data,self);break;case"ERROR":self._dataChannelERRORHandler(peerID,data,self)}}else self._dataChannelDATAHandler(peerID,dataString,self.DATA_TRANSFER_DATA_TYPE.BINARYSTRING,self)},Skyway.prototype._dataChannelWRQHandler=function(peerID,data,self){var itemID=this._user.sid+this.DATA_TRANSFER_TYPE.DOWNLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),name=data[2],binarySize=parseInt(data[3],10),expectedSize=parseInt(data[4],10),timeout=parseInt(data[5],10);if(confirm('Do you want to receive "'+name+'" ?')){self._downloadDataTransfers[peerID]=[],self._downloadDataSessions[peerID]={itemID:itemID,name:name,size:binarySize,ackN:0,receivedSize:0,chunkSize:expectedSize,timeout:timeout},self._sendDataChannel(peerID,["ACK",0,window.webrtcDetectedBrowser.browser]);
var transferInfo={name:name,size:binarySize,senderID:peerID};this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.DOWNLOAD_STARTED,itemID,peerID,transferInfo)}else self._sendDataChannel(peerID,["ACK",-1])},Skyway.prototype._dataChannelACKHandler=function(peerID,data,self){self._clearDataChannelTimeout(peerID,!0,self);var ackN=parseInt(data[1],10),chunksLength=self._uploadDataTransfers[peerID].length,uploadedDetails=self._uploadDataSessions[peerID],itemID=uploadedDetails.itemID,timeout=uploadedDetails.timeout,transferInfo={};if(ackN>-1)if(chunksLength>ackN){var fileReader=new FileReader;fileReader.onload=function(){var base64BinaryString=fileReader.result.split(",")[1];self._sendDataChannel(peerID,[base64BinaryString]),self._setDataChannelTimeout(peerID,timeout,!0,self),transferInfo={percentage:((ackN+1)/chunksLength*100).toFixed()},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOADING,itemID,peerID,transferInfo)},fileReader.readAsDataURL(self._uploadDataTransfers[peerID][ackN])}else ackN===chunksLength&&(transferInfo={name:uploadedDetails.name},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.UPLOAD_COMPLETED,itemID,peerID,transferInfo),delete self._uploadDataTransfers[peerID],delete self._uploadDataSessions[peerID]);else self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.REJECTED,itemID,peerID),delete self._uploadDataTransfers[peerID],delete self._uploadDataSessions[peerID]},Skyway.prototype._dataChannelERRORHandler=function(peerID,data,self){var isUploader=data[2],itemID=isUploader?self._uploadDataSessions[peerID].itemID:self._downloadDataSessions[peerID].itemID,transferInfo={message:data[1],type:isUploader?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD};self._clearDataChannelTimeout(peerID,isUploader,self),self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,itemID,peerID,transferInfo)},Skyway.prototype._dataChannelDATAHandler=function(peerID,dataString,dataType,self){var chunk,transferInfo={};self._clearDataChannelTimeout(peerID,!1,self);var transferStatus=self._downloadDataSessions[peerID],itemID=transferStatus.itemID;if(dataType===self.DATA_TRANSFER_DATA_TYPE.BINARYSTRING)chunk=self._base64ToBlob(dataString);else if(dataType===self.DATA_TRANSFER_DATA_TYPE.ARRAYBUFFER)chunk=new Blob(dataString);else{if(dataType!==self.DATA_TRANSFER_DATA_TYPE.BLOB)return transferInfo={message:"Unhandled data exception: "+dataType,type:self.DATA_TRANSFER_TYPE.DOWNLOAD},void self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,itemID,peerID,transferInfo);chunk=dataString}var receivedSize=chunk.size*(4/3);if(transferStatus.chunkSize>=receivedSize){self._downloadDataTransfers[peerID].push(chunk),transferStatus.ackN+=1,transferStatus.totalReceivedSize+=receivedSize;var totalReceivedSize=transferStatus.totalReceivedSize,percentage=(totalReceivedSize/transferStatus.size*100).toFixed();if(self._sendDataChannel(peerID,["ACK",transferStatus.ackN,self._user.sid]),transferStatus.chunkSize===receivedSize)transferInfo={percentage:percentage},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.DOWNLOADING,itemID,peerID,transferInfo),self._setDataChannelTimeout(peerID,transferStatus.timeout,!1,self),self._downloadDataTransfers[peerID].info=transferStatus;else{var blob=new Blob(self._downloadDataTransfers[peerID]);transferInfo={data:URL.createObjectURL(blob)},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.DOWNLOAD_COMPLETED,itemID,peerID,transferInfo),delete self._downloadDataTransfers[peerID],delete self._downloadDataSessions[peerID]}}else transferInfo={message:"Packet not match - [Received]"+receivedSize+" / [Expected]"+transferStatus.chunkSize,type:self.DATA_TRANSFER_TYPE.DOWNLOAD},self._trigger("dataTransferState",self.DATA_TRANSFER_STATE.ERROR,itemID,peerID,transferInfo)},Skyway.prototype._setDataChannelTimeout=function(peerID,timeout,isSender,self){self._dataTransfersTimeout[peerID]||(self._dataTransfersTimeout[peerID]={});var type=isSender?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD;self._dataTransfersTimeout[peerID][type]=setTimeout(function(){self._dataTransfersTimeout[peerID][type]&&(isSender?(delete self._uploadDataTransfers[peerID],delete self._uploadDataSessions[peerID]):(delete self._downloadDataTransfers[peerID],delete self._downloadDataSessions[peerID]),self._sendDataChannel(peerID,["ERROR","Connection Timeout. Longer than "+timeout+" seconds. Connection is abolished.",isSender]),self._clearDataChannelTimeout(peerID,isSender,self))},1e3*timeout)},Skyway.prototype._clearDataChannelTimeout=function(peerID,isSender,self){if(self._dataTransfersTimeout[peerID]){var type=isSender?self.DATA_TRANSFER_TYPE.UPLOAD:self.DATA_TRANSFER_TYPE.DOWNLOAD;clearTimeout(self._dataTransfersTimeout[peerID][type]),delete self._dataTransfersTimeout[peerID][type]}},Skyway.prototype._base64ToBlob=function(dataURL){for(var byteString=atob(dataURL.replace(/\s\r\n/g,"")),ab=new ArrayBuffer(byteString.length),ia=new Uint8Array(ab),j=0;j<byteString.length;j++)ia[j]=byteString.charCodeAt(j);return new Blob([ab])},Skyway.prototype._chunkFile=function(blob,blobByteSize){var chunksArray=[],startCount=0,endCount=0;if(blobByteSize>this._chunkFileSize){for(;blobByteSize-1>endCount;)endCount=startCount+this._chunkFileSize,chunksArray.push(blob.slice(startCount,endCount)),startCount+=this._chunkFileSize;blobByteSize-(startCount+1)>0&&chunksArray.push(blob.slice(startCount,blobByteSize-1))}else chunksArray.push(blob);return chunksArray},Skyway.prototype.sendBlobData=function(data,dataInfo){if(!data&&!dataInfo)return!1;var noOfPeersSent=0,timeout=60,itemID=this._user.sid+this.DATA_TRANSFER_TYPE.UPLOAD+(new Date).toISOString().replace(/-/g,"").replace(/:/g,"").replace(".",""),transferInfo={};for(var peerID in this._dataChannels)if(this._dataChannels.hasOwnProperty(peerID)){var binarySize=(dataInfo.size*(4/3)).toFixed(),chunkSize=(this._chunkFileSize*(4/3)).toFixed();this._uploadDataTransfers[peerID]=this._chunkFile(data,dataInfo.size),this._uploadDataSessions[peerID]={name:dataInfo.name,size:binarySize,itemID:itemID,timeout:timeout},this._sendDataChannel(peerID,["WRQ",window.webrtcDetectedBrowser.browser,dataInfo.name,binarySize,chunkSize,timeout]),noOfPeersSent++,this._setDataChannelTimeout(peerID,timeout,!0,this)}noOfPeersSent>0?(transferInfo={itemID:itemID,senderID:this._user.sid,name:dataInfo.name,size:dataInfo.size,data:URL.createObjectURL(data)},this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.UPLOAD_STARTED,itemID,peerID,transferInfo)):(transferInfo={message:"No available DataChannels to send Blob data",type:this.DATA_TRANSFER_TYPE.UPLOAD},this._trigger("dataTransferState",this.DATA_TRANSFER_STATE.ERROR,itemID,peerID,transferInfo),this._uploadDataTransfers={},this._uploadDataSessions={})},Skyway.prototype.toggleLock=function(){},Skyway.prototype.toggleAudio=function(){},Skyway.prototype.toggleVideo=function(){},Skyway.prototype.joinRoom=function(){if(!this._in_room){var self=this,_sendJoinRoomMsg=function(){self.off("channelOpen",_sendJoinRoomMsg),self._sendMessage({type:"joinRoom",uid:self._user.id,cid:self._key,rid:self._room.id,userCred:self._user.token,timeStamp:self._user.timeStamp,apiOwner:self._user.apiOwner,roomCred:self._room.token,start:self._room.start,len:self._room.len}),this._user.peer=this._createPeerConnection(this._user.id)};this._channel_open?_sendJoinRoomMsg():(this.on("channelOpen",_sendJoinRoomMsg),this._openChannel())}},Skyway.prototype.leaveRoom=function(){if(this._in_room){for(var pc_index in this._peerConnections)this._peerConnections.hasOwnProperty(pc_index)&&this._removePeer(pc_index);this._in_room=!1,this._closeChannel()}}}).call(this);