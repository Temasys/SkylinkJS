

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      server-communication/signaling-server/index.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
  <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700,900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,700&display=swap" rel="stylesheet">
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
           <div>Web SDK Client Reference</div>

          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
    </h3>

    

    <h3>Classes</h3><ul><li id="Skylink-nav"><a href="Skylink.html">Skylink</a><ul class='methods'><li data-type="method" id="Skylink-cancelBlobTransfer-nav"><a href="Skylink.html#cancelBlobTransfer">cancelBlobTransfer</a></li><li data-type="method" id="Skylink-deleteEncryptSecrets-nav"><a href="Skylink.html#deleteEncryptSecrets">deleteEncryptSecrets</a></li><li data-type="method" id="Skylink-generateUUID-nav"><a href="Skylink.html#generateUUID">generateUUID</a></li><li data-type="method" id="Skylink-getConnectionStatus-nav"><a href="Skylink.html#getConnectionStatus">getConnectionStatus</a></li><li data-type="method" id="Skylink-getEncryptSecrets-nav"><a href="Skylink.html#getEncryptSecrets">getEncryptSecrets</a></li><li data-type="method" id="Skylink-getMessagePersistence-nav"><a href="Skylink.html#getMessagePersistence">getMessagePersistence</a></li><li data-type="method" id="Skylink-getPeerInfo-nav"><a href="Skylink.html#getPeerInfo">getPeerInfo</a></li><li data-type="method" id="Skylink-getPeers-nav"><a href="Skylink.html#getPeers">getPeers</a></li><li data-type="method" id="Skylink-getPeersCustomSettings-nav"><a href="Skylink.html#getPeersCustomSettings">getPeersCustomSettings</a></li><li data-type="method" id="Skylink-getPeersDataChannels-nav"><a href="Skylink.html#getPeersDataChannels">getPeersDataChannels</a></li><li data-type="method" id="Skylink-getPeersInRoom-nav"><a href="Skylink.html#getPeersInRoom">getPeersInRoom</a></li><li data-type="method" id="Skylink-getRecordings-nav"><a href="Skylink.html#getRecordings">getRecordings</a></li><li data-type="method" id="Skylink-getSdkVersion-nav"><a href="Skylink.html#getSdkVersion">getSdkVersion</a></li><li data-type="method" id="Skylink-getSelectedSecret-nav"><a href="Skylink.html#getSelectedSecret">getSelectedSecret</a></li><li data-type="method" id="Skylink-getStoredMessages-nav"><a href="Skylink.html#getStoredMessages">getStoredMessages</a></li><li data-type="method" id="Skylink-getStreams-nav"><a href="Skylink.html#getStreams">getStreams</a></li><li data-type="method" id="Skylink-getStreamSources-nav"><a href="Skylink.html#getStreamSources">getStreamSources</a></li><li data-type="method" id="Skylink-getUserData-nav"><a href="Skylink.html#getUserData">getUserData</a></li><li data-type="method" id="Skylink-getUserMedia-nav"><a href="Skylink.html#getUserMedia">getUserMedia</a></li><li data-type="method" id="Skylink-joinRoom-nav"><a href="Skylink.html#joinRoom">joinRoom</a></li><li data-type="method" id="Skylink-leaveAllRooms-nav"><a href="Skylink.html#leaveAllRooms">leaveAllRooms</a></li><li data-type="method" id="Skylink-leaveRoom-nav"><a href="Skylink.html#leaveRoom">leaveRoom</a></li><li data-type="method" id="Skylink-lockRoom-nav"><a href="Skylink.html#lockRoom">lockRoom</a></li><li data-type="method" id="Skylink-muteStreams-nav"><a href="Skylink.html#muteStreams">muteStreams</a></li><li data-type="method" id="Skylink-refreshConnection-nav"><a href="Skylink.html#refreshConnection">refreshConnection</a></li><li data-type="method" id="Skylink-refreshDatachannel-nav"><a href="Skylink.html#refreshDatachannel">refreshDatachannel</a></li><li data-type="method" id="Skylink-respondBlobRequest-nav"><a href="Skylink.html#respondBlobRequest">respondBlobRequest</a></li><li data-type="method" id="Skylink-sendBlobData-nav"><a href="Skylink.html#sendBlobData">sendBlobData</a></li><li data-type="method" id="Skylink-sendMessage-nav"><a href="Skylink.html#sendMessage">sendMessage</a></li><li data-type="method" id="Skylink-sendP2PMessage-nav"><a href="Skylink.html#sendP2PMessage">sendP2PMessage</a></li><li data-type="method" id="Skylink-sendStream-nav"><a href="Skylink.html#sendStream">sendStream</a></li><li data-type="method" id="Skylink-setEncryptSecret-nav"><a href="Skylink.html#setEncryptSecret">setEncryptSecret</a></li><li data-type="method" id="Skylink-setMessagePersistence-nav"><a href="Skylink.html#setMessagePersistence">setMessagePersistence</a></li><li data-type="method" id="Skylink-setSelectedSecret-nav"><a href="Skylink.html#setSelectedSecret">setSelectedSecret</a></li><li data-type="method" id="Skylink-setUserData-nav"><a href="Skylink.html#setUserData">setUserData</a></li><li data-type="method" id="Skylink-shareScreen-nav"><a href="Skylink.html#shareScreen">shareScreen</a></li><li data-type="method" id="Skylink-startRecording-nav"><a href="Skylink.html#startRecording">startRecording</a></li><li data-type="method" id="Skylink-startRTMPSession-nav"><a href="Skylink.html#startRTMPSession">startRTMPSession</a></li><li data-type="method" id="Skylink-stopRecording-nav"><a href="Skylink.html#stopRecording">stopRecording</a></li><li data-type="method" id="Skylink-stopRTMPSession-nav"><a href="Skylink.html#stopRTMPSession">stopRTMPSession</a></li><li data-type="method" id="Skylink-stopScreen-nav"><a href="Skylink.html#stopScreen">stopScreen</a></li><li data-type="method" id="Skylink-stopStreams-nav"><a href="Skylink.html#stopStreams">stopStreams</a></li><li data-type="method" id="Skylink-unlockRoom-nav"><a href="Skylink.html#unlockRoom">unlockRoom</a></li></ul></li><li id="SkylinkLogger-nav"><a href="SkylinkLogger.html">SkylinkLogger</a><ul class='methods'><li data-type="method" id="SkylinkLogger-disableAll-nav"><a href="SkylinkLogger.html#disableAll">disableAll</a></li><li data-type="method" id="SkylinkLogger-enableAll-nav"><a href="SkylinkLogger.html#enableAll">enableAll</a></li><li data-type="method" id="SkylinkLogger-setLevel-nav"><a href="SkylinkLogger.html#setLevel">setLevel</a></li></ul></li></ul><h3>Namespaces</h3><ul><li id="Reconnection-nav"><a href="Reconnection.html">Reconnection</a></li><li id="SkylinkConstants-nav"><a href="SkylinkConstants.html">SkylinkConstants</a></li><li id="SkylinkEvents-nav"><a href="SkylinkEvents.html">SkylinkEvents</a></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#AdapterJS">AdapterJS</a></li><li><a href="global.html#io">io</a></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        server-communication/signaling-server/index.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>import clone from 'clone';
import {
  createSocket,
  sendChannelMessage,
  processSignalingMessage,
  setSocketCallbacks,
  shouldBufferMessage,
} from './signaling-server-helpers';
import logger from '../../logger';
import SignalingMessageHandler from './message-handler/index';
import SignalingMessageBuilder from './message-builder/index';
import {
  socketError, channelMessage, handshakeProgress,
} from '../../skylink-events';
import { dispatchEvent } from '../../utils/skylinkEventManager';
import Skylink from '../../index';
import MESSAGES from '../../messages';
import { TAGS, SOCKET_ERROR, HANDSHAKE_PROGRESS } from '../../constants';
import Room from '../../room';
import HandleSessionStats from '../../skylink-stats/handleSessionStats';

const SOCKET_TYPE = {
  POLLING: 'Polling',
  WEBSOCKET: 'WebSocket',
  XHR_POLLING: 'xhr-polling',
  JSONP_POLLING: 'jsonp-polling',
};

let instance = null;

/**
 * @class
 * @classdesc Singleton class that represents a signaling server
 * @private
 */
class SkylinkSignalingServer {
  constructor() {
    if (!instance) {
      instance = this;
    }
    /**
     * Stores the WebSocket object
     * @type {WebSocket}
     */
    this.socket = null;
    /**
     * Stores the number of socket reconnect attempts
     * @type {number}
     */
    this.attempts = 0;
    /**
     * Current timestamp
     * @type {number}
     */
    this.timestamp = new Date().valueOf();
    /**
     * Handler for incoming messages on the socket
     * @type {SignalingMessageHandler}
     */
    this.messageHandler = new SignalingMessageHandler();
    /**
     * Handler for outbound messages via the socket
     * @type {SignalingMessageBuilder}
     */
    this.messageBuilder = new SignalingMessageBuilder();
    /**
     * Config needed for create a socket and establishing a socket connection with the Signaling Server
     * @type {{protocol: Window.location.protocol, socketType: string, signalingServerProtocol: Window.location.protocol, socketSession: {finalAttempts: number, attempts: number}, fallbackType: null, signalingServerPort: null}}
     */
    this.config = null;
    return instance;
  }

  // eslint-disable-next-line class-methods-use-this
  resetSocketConfig(protocol) {
    return {
      protocol,
      socketType: !window.WebSocket ? SOCKET_TYPE.POLLING : SOCKET_TYPE.WEBSOCKET,
      signalingServerProtocol: protocol,
      socketSession: {
        finalAttempts: 0,
        attempts: 0,
      },
      fallbackType: null,
      signalingServerPort: null,
      socketTimeout: false,
    };
  }

  /**
   * Method that creates a socket - Returns the same instance of socket if already created.
   * @param {SkylinkRoom.id} roomKey
   * @fires SOCKET_ERROR
   * @return {Promise}
   */
  createSocket(roomKey) {
    const roomState = Skylink.getSkylinkState(roomKey);
    roomState.socketSession = this.resetSocketConfig(roomState.signalingServerProtocol);
    Skylink.setSkylinkState(roomState, roomKey);

    return new Promise((resolve, reject) => {
      try {
        if (this.socket !== null &amp;&amp; this.socket instanceof window.io.Socket &amp;&amp; this.socket.connected) {
          resolve();
        } else {
          this.tryCreateSocket(roomKey, resolve, reject);
        }
      } catch (ex) {
        this.handleCreateSocketFailure(roomKey, resolve, reject, ex);
      }
    });
  }

  tryCreateSocket(roomKey, resolve, reject) {
    try {
      const roomState = Skylink.getSkylinkState(roomKey);
      const { socketSession } = roomState;

      this.socket = createSocket({
        config: socketSession,
        roomKey,
      });

      setSocketCallbacks(roomKey, this, resolve);
    } catch (error) {
      reject(error);
    }
  }

  // eslint-disable-next-line class-methods-use-this
  handleCreateSocketFailure(roomKey, resolve, reject, error) {
    const roomState = Skylink.getSkylinkState(roomKey);
    const { socketSession } = roomState;
    logger.log.ERROR(MESSAGES.INIT.SOCKET_CREATE_FAILED, error);

    dispatchEvent(socketError({
      session: clone(socketSession),
      errorCode: SOCKET_ERROR.CONNECTION_FAILED,
      type: socketSession.fallbackType,
      error,
    }));

    reject(error);
  }

  // eslint-disable-next-line class-methods-use-this
  dispatchHandshakeProgress(roomState, state) {
    dispatchEvent(handshakeProgress({
      peerId: roomState.user.sid,
      state: HANDSHAKE_PROGRESS[state],
      error: null,
      room: Room.getRoomInfo(roomState.room.id),
    }));
  }

  // eslint-disable-next-line class-methods-use-this
  logClientSessionStats(roomKey, message) {
    const handleSessionStats = new HandleSessionStats();
    handleSessionStats.send(roomKey, message);
  }

  /**
   *
   * @param args
   */
  answer(...args) {
    return this.messageBuilder.getAnswerMessage(...args).then((answer) => {
      const state = args[0];
      this.sendMessage(answer);
      this.dispatchHandshakeProgress(state, 'ANSWER');
      return answer;
    });
  }

  answerAck(...args) {
    const answerAck = this.messageBuilder.getAnswerAckMessage(...args);
    const roomState = args[0];
    this.sendMessage(answerAck);
    this.dispatchHandshakeProgress(roomState, 'ANSWER_ACK');
  }

  /**
   *
   * @param args
   */
  enterRoom(...args) {
    const enter = this.messageBuilder.getEnterRoomMessage(...args);
    this.sendMessage(enter);
    this.dispatchHandshakeProgress(...args, 'ENTER');
    this.logClientSessionStats(args[0].room.id, enter);
  }

  joinRoom(...args) {
    const join = this.messageBuilder.getJoinRoomMessage(...args);
    this.sendMessage(join);
    this.logClientSessionStats(args[0].room.id, join);
  }

  offer(...args) {
    const room = args[0];
    const peerId = args[1];
    const state = Skylink.getSkylinkState(room.id);
    if (state.peerConnections[peerId].negotiating) {
      logger.log.DEBUG([peerId, TAGS.SIG_SERVER, null, `${MESSAGES.SIGNALING.ABORTING_OFFER}`]);
      return;
    }

    this.messageBuilder.getOfferMessage(...args).then((offer) => {
      this.sendMessage(offer);
      this.dispatchHandshakeProgress(state, 'OFFER');
    });
  }

  welcome(...args) {
    const welcome = this.messageBuilder.getWelcomeMessage(...args);
    this.sendMessage(welcome);
  }

  // eslint-disable-next-line class-methods-use-this
  noop() {
    return null;
  }

  sendCandidate(...args) {
    const candidate = this.messageBuilder.getCandidateMessage(...args);
    if (candidate) {
      this.sendMessage(candidate);
    }
  }

  /**
   * @param {SkylinkState} roomState
   */
  setUserData(roomState) {
    const userData = this.messageBuilder.getSetUserDataMessage(roomState);
    if (userData) {
      this.sendMessage(userData);
    }
  }

  /**
   * @param {boolean} showAll
   */
  getPeerList(showAll) {
    const peers = this.messageBuilder.getPeerListMessage(showAll);
    if (peers) {
      this.sendMessage(peers);
    }
  }

  stream(...args) {
    const stream = this.messageBuilder.getStreamMessage(...args);
    if (stream) {
      this.sendMessage(stream);
    }
  }

  recording(...args) {
    const recordingMessage = this.messageBuilder.getRecordingMessage(...args);
    this.sendMessage(recordingMessage);
  }

  rtmp(...args) {
    const rtmpMessage = this.messageBuilder.getRTMPMessage(...args);
    this.sendMessage(rtmpMessage);
  }

  roomLock(roomState) {
    const roomLock = this.messageBuilder.getRoomLockMessage(roomState);
    if (roomLock) {
      this.sendMessage(roomLock);
    }
  }

  bye(...args) {
    const byeMessage = this.messageBuilder.getByeMessage(...args);
    this.sendMessage(byeMessage);
  }

  mediaInfoEvent(roomState, peerId, mediaInfo) {
    const mInfo = this.messageBuilder.getMediaInfoEventMessage(roomState, peerId, mediaInfo);
    if (mInfo) {
      this.sendMessage(mInfo);
    }
  }

  getStoredMessages(roomState) {
    const history = this.messageBuilder.getGetStoredMessagesMessage(roomState);
    if (history) {
      this.sendMessage(history);
    }
  }

  onMessage(message) {
    const roomState = Skylink.getSkylinkState(JSON.parse(message).rid);
    if (!roomState) {
      return; // FIXME: to handle multi room when the last peer has left one room and that roomState has been removed but the socket channel is still open as the peer is still in the other room
    }
    const { socketSession } = roomState;
    dispatchEvent(channelMessage({
      message,
      socketSession: clone(socketSession),
    }));
    processSignalingMessage(this.messageHandler, JSON.parse(message));
  }

  sendMessage(message) {
    if (!shouldBufferMessage(message)) {
      logger.log.INFO(['SIG SERVER', null, message.type, 'sent']);
      sendChannelMessage(this.socket, message);
    }
  }

  sendUserMessage(roomState, config, message) {
    const peerMessages = this.messageBuilder.getUserMessages(roomState, config, message);
    if (Array.isArray(peerMessages) &amp;&amp; peerMessages.length) {
      peerMessages.map((peerMessage) => {
        this.sendMessage(peerMessage);
        return null;
      });
    }
  }

  updateAttempts(roomKey, key, attempts) {
    this.attempts = attempts;

    const state = Skylink.getSkylinkState(roomKey);
    const { socketSession } = state;
    socketSession.socketSession[key] = attempts;

    Skylink.setSkylinkState(state, roomKey);
  }

  getAttempts() {
    return this.attempts;
  }
}

export default SkylinkSignalingServer;
</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://temasys.io/">Temasys</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
