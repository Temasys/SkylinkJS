(function (factory) {
  typeof define === 'function' && define.amd ? define(factory) :
  factory();
}(function () { 'use strict';

  !function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e=e||self).Skylink={});}(undefined,(function(e){let t=!0,r=!0;function n(e,t,r){const n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function s(e,t,r){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,s=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return s.apply(this,arguments);const i=e=>{const t=r(e);t&&n(t);};return this._eventMap=this._eventMap||{},this._eventMap[n]=i,s.apply(this,[e,i])};const i=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return i.apply(this,arguments);const n=this._eventMap[r];return delete this._eventMap[r],i.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e);},enumerable:!0,configurable:!0});}function i(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(t=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function o(e){return "boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(r=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function a(){if("object"==typeof window){if(t)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments);}}function c(e,t){r&&console.warn(e+" is deprecated, please use "+t+" instead.");}function d(e){const{navigator:t}=e,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=n(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)r.browser="chrome",r.version=n(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=n(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=n(t.userAgent,/AppleWebKit\/(\d+)\./,1),r.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype;}return r}function l(e){return "[object Object]"===Object.prototype.toString.call(e)}function p(e){return l(e)?Object.keys(e).reduce((function(t,r){const n=l(e[r]),s=n?p(e[r]):e[r],i=n&&!Object.keys(s).length;return void 0===s||i?t:Object.assign(t,{[r]:s})}),{}):e}function u(e,t,r){const n=r?"outbound-rtp":"inbound-rtp",s=new Map;if(null===t)return s;const i=[];return e.forEach(e=>{"track"===e.type&&e.trackIdentifier===t.id&&i.push(e);}),i.forEach(t=>{e.forEach(r=>{r.type===n&&r.trackId===t.id&&function e(t,r,n){r&&!n.has(r.id)&&(n.set(r.id,r),Object.keys(r).forEach(s=>{s.endsWith("Id")?e(t,t.get(r[s]),n):s.endsWith("Ids")&&r[s].forEach(r=>{e(t,t.get(r),n);});}));}(e,r,s);});}),s}const S=a;function E(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const r=d(e),n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach(r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;const n="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const s=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[s("min",r)]=n.ideal,t.optional.push(e),(e={})[s("max",r)]=n.ideal,t.optional.push(e)):(e[s("",r)]=n.ideal,t.optional.push(e));}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[s("",r)]=n.exact):["min","max"].forEach(e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[s(e,r)]=n[e]);});}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,s){if(r.version>=61)return s(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t]);};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio);}if(e&&"object"==typeof e.video){let i=e.video.facingMode;i=i&&("object"==typeof i?i:{ideal:i});const o=r.version<66;if(i&&("user"===i.exact||"environment"===i.exact||"user"===i.ideal||"environment"===i.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||o)){let r;if(delete e.video.facingMode,"environment"===i.exact||"environment"===i.ideal?r=["back","rear"]:"user"!==i.exact&&"user"!==i.ideal||(r=["front"]),r)return t.mediaDevices.enumerateDevices().then(t=>{let o=(t=t.filter(e=>"videoinput"===e.kind)).find(e=>r.some(t=>e.label.toLowerCase().includes(t)));return !o&&t.length&&r.includes("back")&&(o=t[t.length-1]),o&&(e.video.deviceId=i.exact?{exact:o.deviceId}:{ideal:o.deviceId}),e.video=n(e.video),S("chrome: "+JSON.stringify(e)),s(e)})}e.video=n(e.video);}return S("chrome: "+JSON.stringify(e)),s(e)},i=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,n){s(e,e=>{t.webkitGetUserMedia(e,r,e=>{n&&n(i(e));});});}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return s(t,t=>e(t).then(e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(e=>{e.stop();}),new DOMException("","NotFoundError");return e},e=>Promise.reject(i(e))))};}}function h(e){e.MediaStream=e.MediaStream||e.webkitMediaStream;}function g(e){if("object"!=typeof e||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)s(e,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e));else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e);},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===r.track.id):{track:r.track};const s=new Event("track");s.track=r.track,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s);}),t.stream.getTracks().forEach(r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(e=>e.track&&e.track.id===r.id):{track:r};const s=new Event("track");s.track=r,s.receiver=n,s.transceiver={receiver:n},s.streams=[t.stream],this.dispatchEvent(s);});},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)};}}function m(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return {track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let s=r.apply(this,arguments);return s||(s=t(this,e),this._senders.push(s)),s};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1);};}const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach(e=>{this._senders.push(t(this,e));});};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach(e=>{const t=this._senders.find(t=>t.track===e);t&&this._senders.splice(this._senders.indexOf(t),1);});};}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}});}}function f(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const s=function(e){const t={};return e.result().forEach(e=>{const r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach(t=>{r[t]=e.stat(t);}),t[r.id]=r;}),t},i=function(e){return new Map(Object.keys(e).map(t=>[t,e[t]]))};if(arguments.length>=2){const n=function(e){r(i(s(e)));};return t.apply(this,[n,e])}return new Promise((e,r)=>{t.apply(this,[function(t){e(i(s(t)));},r]);}).then(r,n)};}function R(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>u(t,e.track,!0))};}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),s(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then(t=>u(t,e.track,!1))};}if(!("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,r,n;return this.getSenders().forEach(r=>{r.track===e&&(t?n=!0:t=r);}),this.getReceivers().forEach(t=>(t.track===e&&(r?n=!0:r=t),t.track===e)),n||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)};}function T(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(e=>this._shimmedLocalStreams[e][0])};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")});const t=this.getSenders();r.apply(this,arguments);const n=this.getSenders().filter(e=>-1===t.indexOf(e));this._shimmedLocalStreams[e.id]=[e].concat(n);};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const s=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach(t=>{const r=this._shimmedLocalStreams[t].indexOf(e);-1!==r&&this._shimmedLocalStreams[t].splice(r,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t];}),s.apply(this,arguments)};}function C(e){if(!e.RTCPeerConnection)return;const t=d(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return T(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map(e=>this._reverseStreams[e.id])};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach(e=>{if(this.getSenders().find(t=>t.track===e))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[t.id]){const r=new e.MediaStream(t.getTracks());this._streams[t.id]=r,this._reverseStreams[r.id]=t,t=r;}n.apply(this,[t]);};const s=e.RTCPeerConnection.prototype.removeStream;function i(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],s=e._streams[n.id];r=r.replace(new RegExp(s.id,"g"),n.id);}),new RTCSessionDescription({type:t.type,sdp:r})}function o(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach(t=>{const n=e._reverseStreams[t],s=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),s.id);}),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},s.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id];},e.RTCPeerConnection.prototype.addTrack=function(t,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find(e=>e===t))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const s=this.getSenders().find(e=>e.track===t);if(s)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const i=this._streams[r.id];if(i)i.addTrack(t),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"));});else{const n=new e.MediaStream([t]);this._streams[r.id]=n,this._reverseStreams[n.id]=r,this.addStream(n);}return this.getSenders().find(e=>e.track===t)},["createOffer","createAnswer"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[t=>{const r=i(this,t);e[0].apply(null,[r]);},t=>{e[1]&&e[1].apply(null,t);},arguments[2]]):r.apply(this,arguments).then(e=>i(this,e))}};e.RTCPeerConnection.prototype[t]=n[t];}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=o(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return ""===e.type?e:i(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach(r=>{this._streams[r].getTracks().find(t=>e.track===t)&&(t=this._streams[r]);}),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")));};}function _(e){const t=d(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const r=0===e.RTCPeerConnection.prototype.addIceCandidate.length;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t];}));const n=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return r||arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():n.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};}function I(e){s(e,"negotiationneeded",e=>{if("stable"===e.target.signalingState)return e});}var O=Object.freeze({shimMediaStream:h,shimOnTrack:g,shimGetSendersWithDtmf:m,shimGetStats:f,shimSenderReceiverGetStats:R,shimAddTrackRemoveTrackWithNative:T,shimAddTrackRemoveTrack:C,shimPeerConnection:_,fixNegotiationNeeded:I,shimGetUserMedia:E,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then(t=>{const n=r.video&&r.video.width,s=r.video&&r.video.height,i=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:i||3}},n&&(r.video.mandatory.maxWidth=n),s&&(r.video.mandatory.maxHeight=s),e.navigator.mediaDevices.getUserMedia(r)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"));}});function A(e,t){return e(t={exports:{}},t.exports),t.exports}var v=A((function(e){var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return (t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){var r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter((function(e){return 0===e.indexOf(r)}))},t.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1];}return r},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return "a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return {id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return "a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),s=0;s<n.length;s++)r[(t=n[s].trim().split("="))[0].trim()]=t[1];return r},t.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t);})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n";}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return {type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n";})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return {semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return {algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,r){return {role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n";})),r},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return {tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return "a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return {keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,r){return t.matchPrefix(e+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,r){var n=t.matchPrefix(e+r,"a=ice-ufrag:")[0],s=t.matchPrefix(e+r,"a=ice-pwd:")[0];return n&&s?{usernameFragment:n.substr(12),password:s.substr(10)}:null},t.writeIceParameters=function(e){return "a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" "),s=3;s<n.length;s++){var i=n[s],o=t.matchPrefix(e,"a=rtpmap:"+i+" ")[0];if(o){var a=t.parseRtpMap(o),c=t.matchPrefix(e,"a=fmtp:"+i+" ");switch(a.parameters=c.length?t.parseFmtp(c[0]):{},a.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+i+" ").map(t.parseRtcpFb),r.codecs.push(a),a.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(a.name.toUpperCase());}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){r.headerExtensions.push(t.parseExtmap(e));})),r},t.writeRtpDescription=function(e,r){var n="";n+="m="+e+" ",n+=r.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=r.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach((function(e){n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e);}));var s=0;return r.codecs.forEach((function(e){e.maxptime>s&&(s=e.maxptime);})),s>0&&(n+="a=maxptime:"+s+"\r\n"),n+="a=rtcp-mux\r\n",r.headerExtensions&&r.headerExtensions.forEach((function(e){n+=t.writeExtmap(e);})),n},t.parseRtpEncodingParameters=function(e){var r,n=[],s=t.parseRtpParameters(e),i=-1!==s.fecMechanisms.indexOf("RED"),o=-1!==s.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "cname"===e.attribute})),c=a.length>0&&a[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(r=d[0][1]),s.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&r&&(t.rtx={ssrc:r}),n.push(t),i&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:o?"red+ulpfec":"red"},n.push(t));}})),0===n.length&&c&&n.push({ssrc:c});var l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,n.forEach((function(e){e.maxBitrate=l;}))),n},t.parseRtcpParameters=function(e){var r={},n=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "cname"===e.attribute}))[0];n&&(r.cname=n.value,r.ssrc=n.ssrc);var s=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=s.length>0,r.compound=0===s.length;var i=t.matchPrefix(e,"a=rtcp-mux");return r.mux=i.length>0,r},t.parseMsid=function(e){var r,n=t.matchPrefix(e,"a=msid:");if(1===n.length)return {stream:(r=n[0].substr(7).split(" "))[0],track:r[1]};var s=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return "msid"===e.attribute}));return s.length>0?{stream:(r=s[0].value.split(" "))[0],track:r[1]}:void 0},t.parseSctpDescription=function(e){var r,n=t.parseMLine(e),s=t.matchPrefix(e,"a=max-message-size:");s.length>0&&(r=parseInt(s[0].substr(19),10)),isNaN(r)&&(r=65536);var i=t.matchPrefix(e,"a=sctp-port:");if(i.length>0)return {port:parseInt(i[0].substr(12),10),protocol:n.fmt,maxMessageSize:r};if(t.matchPrefix(e,"a=sctpmap:").length>0){var o=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return {port:parseInt(o[0],10),protocol:o[1],maxMessageSize:r}}},t.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,r,n){var s=void 0!==r?r:2;return "v=0\r\no="+(n||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+s+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,r,n,s){var i=t.writeRtpDescription(e.kind,r);if(i+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),i+="a=mid:"+e.mid+"\r\n",e.direction?i+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?i+="a=sendrecv\r\n":e.rtpSender?i+="a=sendonly\r\n":e.rtpReceiver?i+="a=recvonly\r\n":i+="a=inactive\r\n",e.rtpSender){var o="msid:"+s.id+" "+e.rtpSender.track.id+"\r\n";i+="a="+o,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+o,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+o,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n");}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),i},t.getDirection=function(e,r){for(var n=t.splitLines(e),s=0;s<n.length;s++)switch(n[s]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[s].substr(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return "0"===e.split(" ",2)[1]},t.parseMLine=function(e){var r=t.splitLines(e)[0].substr(2).split(" ");return {kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){var r=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return {username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return !1;for(var r=t.splitLines(e),n=0;n<r.length;n++)if(r[n].length<2||"="!==r[n].charAt(1))return !1;return !0},e.exports=t;}));function D(e,t,r,n,s){var i=v.writeRtpDescription(e.kind,t);if(i+=v.writeIceParameters(e.iceGatherer.getLocalParameters()),i+=v.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":s||"active"),i+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?i+="a=sendrecv\r\n":e.rtpSender?i+="a=sendonly\r\n":e.rtpReceiver?i+="a=recvonly\r\n":i+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var a="msid:"+(n?n.id:"-")+" "+o+"\r\n";i+="a="+a,i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,i+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n");}return i+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+v.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(i+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+v.localCName+"\r\n"),i}function y(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},s=function(e,t,r,s){var i=n(e.parameters.apt,r),o=n(t.parameters.apt,s);return i&&o&&i.name.toLowerCase()===o.name.toLowerCase()};return e.codecs.forEach((function(n){for(var i=0;i<t.codecs.length;i++){var o=t.codecs[i];if(n.name.toLowerCase()===o.name.toLowerCase()&&n.clockRate===o.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&o.parameters.apt&&!s(n,o,e.codecs,t.codecs))continue;(o=JSON.parse(JSON.stringify(o))).numChannels=Math.min(n.numChannels,o.numChannels),r.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return !0;return !1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var s=t.headerExtensions[n];if(e.uri===s.uri){r.headerExtensions.push(s);break}}})),r}function N(e,t,r){return -1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function P(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function M(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}var w=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}));}function n(t,r,n,s){var i=new Event("track");i.track=r,i.receiver=n,i.transceiver={receiver:n},i.streams=s,e.setTimeout((function(){t._dispatchEvent("track",i);}));}var s=function(r){var n=this,s=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){n[e]=s[e].bind(s);})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw M("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all";}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced";}if(r.iceServers=function(e,t){var r=!1;return (e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var s="string"==typeof n;return s&&(n=[n]),n=n.filter((function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")&&!r?(r=!0,!0):0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp")})),delete e.url,e.urls=s?n[0]:n,!!n.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var i=r.iceCandidatePoolSize;i>0;i--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=v.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1;};Object.defineProperty(s.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(s.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),s.prototype.onicecandidate=null,s.prototype.onaddstream=null,s.prototype.ontrack=null,s.prototype.onremovestream=null,s.prototype.onsignalingstatechange=null,s.prototype.oniceconnectionstatechange=null,s.prototype.onconnectionstatechange=null,s.prototype.onicegatheringstatechange=null,s.prototype.onnegotiationneeded=null,s.prototype.ondatachannel=null,s.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t));},s.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e);},s.prototype.getConfiguration=function(){return this._config},s.prototype.getLocalStreams=function(){return this.localStreams},s.prototype.getRemoteStreams=function(){return this.remoteStreams},s.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var s=this._createIceAndDtlsTransports();n.iceTransport=s.iceTransport,n.dtlsTransport=s.dtlsTransport;}return t||this.transceivers.push(n),n},s.prototype.addTrack=function(t,r){if(this._isClosed)throw M("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw M("InvalidAccessError","Track already exists.");for(var s=0;s<this.transceivers.length;s++)this.transceivers[s].track||this.transceivers[s].kind!==t.kind||(n=this.transceivers[s]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),n.track=t,n.stream=r,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},s.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e);}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled;}));})),n.getTracks().forEach((function(e){r.addTrack(e,n);}));}},s.prototype.removeTrack=function(t){if(this._isClosed)throw M("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw M("InvalidAccessError","Sender was not created by this connection.");var n=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded();},s.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r);}));},s.prototype.getSenders=function(){return this.transceivers.filter((function(e){return !!e.rtpSender})).map((function(e){return e.rtpSender}))},s.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return !!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},s.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var s=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(s,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;s.state=r?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e);},s.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),s},s.prototype._gather=function(t,r){var n=this,s=this.transceivers[r].iceGatherer;if(!s.onlocalcandidate){var i=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,s.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),s.onlocalcandidate=function(e){if(!(n.usingBundle&&r>0)){var i=new Event("icecandidate");i.candidate={sdpMid:t,sdpMLineIndex:r};var o=e.candidate,a=!o||0===Object.keys(o).length;if(a)"new"!==s.state&&"gathering"!==s.state||(s.state="completed");else{"new"===s.state&&(s.state="gathering"),o.component=1,o.ufrag=s.getLocalParameters().usernameFragment;var c=v.writeCandidate(o);i.candidate=Object.assign(i.candidate,v.parseCandidate(c)),i.candidate.candidate=c,i.candidate.toJSON=function(){return {candidate:i.candidate.candidate,sdpMid:i.candidate.sdpMid,sdpMLineIndex:i.candidate.sdpMLineIndex,usernameFragment:i.candidate.usernameFragment}};}var d=v.getMediaSections(n._localDescription.sdp);d[i.candidate.sdpMLineIndex]+=a?"a=end-of-candidates\r\n":"a="+i.candidate.candidate+"\r\n",n._localDescription.sdp=v.getDescription(n._localDescription.sdp)+d.join("");var l=n.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),a||n._dispatchEvent("icecandidate",i),l&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange());}},e.setTimeout((function(){i.forEach((function(e){s.onlocalcandidate(e);}));}),0);}},s.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState();};var n=new e.RTCDtlsTransport(r);return n.ondtlsstatechange=function(){t._updateConnectionState();},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState();},{iceTransport:r,dtlsTransport:n}},s.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport);},s.prototype._transceive=function(e,r,n){var s=y(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:v.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),n&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx;})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s));},s.prototype.setLocalDescription=function(e){var t,r,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(M("TypeError",'Unsupported type "'+e.type+'"'));if(!N("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(M("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=v.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=v.parseRtpParameters(e);n.transceivers[t].localCapabilities=r;})),n.transceivers.forEach((function(e,t){n._gather(e.mid,t);}));else if("answer"===e.type){t=v.splitSections(n._remoteDescription.sdp),r=t.shift();var s=v.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var i=n.transceivers[t],o=i.iceGatherer,a=i.iceTransport,c=i.dtlsTransport,d=i.localCapabilities,l=i.remoteCapabilities;if(!(v.isRejected(e)&&0===v.matchPrefix(e,"a=bundle-only").length)&&!i.rejected){var p=v.getIceParameters(e,r),u=v.getDtlsParameters(e,r);s&&(u.role="server"),n.usingBundle&&0!==t||(n._gather(i.mid,t),"new"===a.state&&a.start(o,p,s?"controlling":"controlled"),"new"===c.state&&c.start(u));var S=y(d,l);n._transceive(i,S.codecs.length>0,!1);}}));}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()},s.prototype.setRemoteDescription=function(s){var i=this;if(-1===["offer","answer"].indexOf(s.type))return Promise.reject(M("TypeError",'Unsupported type "'+s.type+'"'));if(!N("setRemoteDescription",s.type,i.signalingState)||i._isClosed)return Promise.reject(M("InvalidStateError","Can not set remote "+s.type+" in state "+i.signalingState));var o={};i.remoteStreams.forEach((function(e){o[e.id]=e;}));var a=[],c=v.splitSections(s.sdp),d=c.shift(),l=v.matchPrefix(d,"a=ice-lite").length>0,p=v.matchPrefix(d,"a=group:BUNDLE ").length>0;i.usingBundle=p;var u=v.matchPrefix(d,"a=ice-options:")[0];return i.canTrickleIceCandidates=!!u&&u.substr(14).split(" ").indexOf("trickle")>=0,c.forEach((function(n,c){var u=v.splitLines(n),S=v.getKind(n),E=v.isRejected(n)&&0===v.matchPrefix(n,"a=bundle-only").length,h=u[0].substr(2).split(" ")[2],g=v.getDirection(n,d),m=v.parseMsid(n),f=v.getMid(n)||v.generateIdentifier();if(E||"application"===S&&("DTLS/SCTP"===h||"UDP/DTLS/SCTP"===h))i.transceivers[c]={mid:f,kind:S,protocol:h,rejected:!0};else{var R,T,C,_,I,O,A,D,N;!E&&i.transceivers[c]&&i.transceivers[c].rejected&&(i.transceivers[c]=i._createTransceiver(S,!0));var M,w,b=v.parseRtpParameters(n);E||(M=v.getIceParameters(n,d),(w=v.getDtlsParameters(n,d)).role="client"),A=v.parseRtpEncodingParameters(n);var k=v.parseRtcpParameters(n),L=v.matchPrefix(n,"a=end-of-candidates",d).length>0,U=v.matchPrefix(n,"a=candidate:").map((function(e){return v.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===s.type||"answer"===s.type)&&!E&&p&&c>0&&i.transceivers[c]&&(i._disposeIceAndDtlsTransports(c),i.transceivers[c].iceGatherer=i.transceivers[0].iceGatherer,i.transceivers[c].iceTransport=i.transceivers[0].iceTransport,i.transceivers[c].dtlsTransport=i.transceivers[0].dtlsTransport,i.transceivers[c].rtpSender&&i.transceivers[c].rtpSender.setTransport(i.transceivers[0].dtlsTransport),i.transceivers[c].rtpReceiver&&i.transceivers[c].rtpReceiver.setTransport(i.transceivers[0].dtlsTransport)),"offer"!==s.type||E){if("answer"===s.type&&!E){T=(R=i.transceivers[c]).iceGatherer,C=R.iceTransport,_=R.dtlsTransport,I=R.rtpReceiver,O=R.sendEncodingParameters,D=R.localCapabilities,i.transceivers[c].recvEncodingParameters=A,i.transceivers[c].remoteCapabilities=b,i.transceivers[c].rtcpParameters=k,U.length&&"new"===C.state&&(!l&&!L||p&&0!==c?U.forEach((function(e){P(R.iceTransport,e);})):C.setRemoteCandidates(U)),p&&0!==c||("new"===C.state&&C.start(T,M,"controlling"),"new"===_.state&&_.start(w)),!y(R.localCapabilities,R.remoteCapabilities).codecs.filter((function(e){return "rtx"===e.name.toLowerCase()})).length&&R.sendEncodingParameters[0].rtx&&delete R.sendEncodingParameters[0].rtx,i._transceive(R,"sendrecv"===g||"recvonly"===g,"sendrecv"===g||"sendonly"===g),!I||"sendrecv"!==g&&"sendonly"!==g?delete R.rtpReceiver:(N=I.track,m?(o[m.stream]||(o[m.stream]=new e.MediaStream),r(N,o[m.stream]),a.push([N,I,o[m.stream]])):(o.default||(o.default=new e.MediaStream),r(N,o.default),a.push([N,I,o.default])));}}else{(R=i.transceivers[c]||i._createTransceiver(S)).mid=f,R.iceGatherer||(R.iceGatherer=i._createIceGatherer(c,p)),U.length&&"new"===R.iceTransport.state&&(!L||p&&0!==c?U.forEach((function(e){P(R.iceTransport,e);})):R.iceTransport.setRemoteCandidates(U)),D=e.RTCRtpReceiver.getCapabilities(S),t<15019&&(D.codecs=D.codecs.filter((function(e){return "rtx"!==e.name}))),O=R.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var G,x=!1;if("sendrecv"===g||"sendonly"===g){if(x=!R.rtpReceiver,I=R.rtpReceiver||new e.RTCRtpReceiver(R.dtlsTransport,S),x)N=I.track,m&&"-"===m.stream||(m?(o[m.stream]||(o[m.stream]=new e.MediaStream,Object.defineProperty(o[m.stream],"id",{get:function(){return m.stream}})),Object.defineProperty(N,"id",{get:function(){return m.track}}),G=o[m.stream]):(o.default||(o.default=new e.MediaStream),G=o.default)),G&&(r(N,G),R.associatedRemoteMediaStreams.push(G)),a.push([N,I,G]);}else R.rtpReceiver&&R.rtpReceiver.track&&(R.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===R.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}));}(r,t);})),R.associatedRemoteMediaStreams=[]);R.localCapabilities=D,R.remoteCapabilities=b,R.rtpReceiver=I,R.rtcpParameters=k,R.sendEncodingParameters=O,R.recvEncodingParameters=A,i._transceive(i.transceivers[c],!1,x);}}})),void 0===i._dtlsRole&&(i._dtlsRole="offer"===s.type?"active":"passive"),i._remoteDescription={type:s.type,sdp:s.sdp},"offer"===s.type?i._updateSignalingState("have-remote-offer"):i._updateSignalingState("stable"),Object.keys(o).forEach((function(t){var r=o[t];if(r.getTracks().length){if(-1===i.remoteStreams.indexOf(r)){i.remoteStreams.push(r);var s=new Event("addstream");s.stream=r,e.setTimeout((function(){i._dispatchEvent("addstream",s);}));}a.forEach((function(e){var t=e[0],s=e[1];r.id===e[2].id&&n(i,t,s,[r]);}));}})),a.forEach((function(e){e[2]||n(i,e[0],e[1],[]);})),e.setTimeout((function(){i&&i.transceivers&&i.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}));}));}),4e3),Promise.resolve()},s.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop();})),this._isClosed=!0,this._updateSignalingState("closed");},s.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t);},s.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e);}}),0));},s.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++;})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r);}},s.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++);})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r);}},s.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(M("InvalidStateError","Can not call createOffer after close"));var n=r.transceivers.filter((function(e){return "audio"===e.kind})).length,s=r.transceivers.filter((function(e){return "video"===e.kind})).length,i=arguments[0];if(i){if(i.mandatory||i.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==i.offerToReceiveAudio&&(n=!0===i.offerToReceiveAudio?1:!1===i.offerToReceiveAudio?0:i.offerToReceiveAudio),void 0!==i.offerToReceiveVideo&&(s=!0===i.offerToReceiveVideo?1:!1===i.offerToReceiveVideo?0:i.offerToReceiveVideo);}for(r.transceivers.forEach((function(e){"audio"===e.kind?--n<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1);}));n>0||s>0;)n>0&&(r._createTransceiver("audio"),n--),s>0&&(r._createTransceiver("video"),s--);var o=v.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(n,s){var i=n.track,o=n.kind,a=n.mid||v.generateIdentifier();n.mid=a,n.iceGatherer||(n.iceGatherer=r._createIceGatherer(s,r.usingBundle));var c=e.RTCRtpSender.getCapabilities(o);t<15019&&(c.codecs=c.codecs.filter((function(e){return "rtx"!==e.name}))),c.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType);}));})),c.headerExtensions.forEach((function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id);}));}));var d=n.sendEncodingParameters||[{ssrc:1001*(2*s+1)}];i&&t>=15019&&"video"===o&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,o)),n.localCapabilities=c,n.sendEncodingParameters=d;})),"max-compat"!==r._config.bundlePolicy&&(o+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),o+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){o+=D(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),o+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,o+="a="+v.writeCandidate(e)+"\r\n";})),"completed"===e.iceGatherer.state&&(o+="a=end-of-candidates\r\n"));}));var a=new e.RTCSessionDescription({type:"offer",sdp:o});return Promise.resolve(a)},s.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(M("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(M("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var n=v.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(n+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),n+="a=ice-options:trickle\r\n";var s=v.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,i){if(!(i+1>s)){if(e.rejected)return "application"===e.kind?"DTLS/SCTP"===e.protocol?n+="m=application 0 DTLS/SCTP 5000\r\n":n+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?n+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(n+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(n+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var o;if(e.stream)"audio"===e.kind?o=e.stream.getAudioTracks()[0]:"video"===e.kind&&(o=e.stream.getVideoTracks()[0]),o&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var a=y(e.localCapabilities,e.remoteCapabilities);!a.codecs.filter((function(e){return "rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,n+=D(e,a,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(n+="a=rtcp-rsize\r\n");}}));var i=new e.RTCSessionDescription({type:"answer",sdp:n});return Promise.resolve(i)},s.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(n,s){if(!r._remoteDescription)return s(M("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var i=e.sdpMLineIndex;if(e.sdpMid)for(var o=0;o<r.transceivers.length;o++)if(r.transceivers[o].mid===e.sdpMid){i=o;break}var a=r.transceivers[i];if(!a)return s(M("OperationError","Can not add ICE candidate"));if(a.rejected)return n();var c=Object.keys(e.candidate).length>0?v.parseCandidate(e.candidate):{};if("tcp"===c.protocol&&(0===c.port||9===c.port))return n();if(c.component&&1!==c.component)return n();if((0===i||i>0&&a.iceTransport!==r.transceivers[0].iceTransport)&&!P(a.iceTransport,c))return s(M("OperationError","Can not add ICE candidate"));var d=e.candidate.trim();0===d.indexOf("a=")&&(d=d.substr(2)),(t=v.getMediaSections(r._remoteDescription.sdp))[i]+="a="+(c.type?d:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=v.getDescription(r._remoteDescription.sdp)+t.join("");}else for(var l=0;l<r.transceivers.length&&(r.transceivers[l].rejected||(r.transceivers[l].iceTransport.addRemoteCandidate({}),(t=v.getMediaSections(r._remoteDescription.sdp))[l]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=v.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));l++);n();}))},s.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver);})),!r)throw M("InvalidAccessError","Invalid selector.");return r.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats());}));})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e);}));})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var n;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[r]).type]||n.type,t.set(r,e[r]);})),t}))};}}));var i=["createOffer","createAnswer"];return i.forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t]);}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t]);})):t.apply(this,arguments)};})),(i=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null);}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t]);})):t.apply(this,arguments)};})),["getStats"].forEach((function(e){var t=s.prototype[e];s.prototype[e]=function(){var e=arguments;return "function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null);})):t.apply(this,arguments)};})),s};function b(e){const t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch(e=>Promise.reject(function(e){return {name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e)))};}function k(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)));}function L(e){const t=d(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const r=new Event("enabled");r.enabled=e,this.dispatchEvent(r);}});}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const r=w(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let r=!1;return (e=JSON.parse(JSON.stringify(e))).filter(e=>{if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&c("RTCIceServer.url","RTCIceServer.urls");const n="string"==typeof t;return n&&(t=[t]),t=t.filter(e=>{if(0===e.indexOf("stun:"))return !1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r}),delete e.url,e.urls=n?t[0]:t,!!t.length}})}(e.iceServers,t.version),a("ICE servers after filtering:",e.iceServers)),new r(e)},e.RTCPeerConnection.prototype=r.prototype;}function U(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack);}var G=Object.freeze({shimPeerConnection:L,shimReplaceTrack:U,shimGetUserMedia:b,shimGetDisplayMedia:k});function x(e){const t=d(e),r=e&&e.navigator,n=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){c("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n);},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t]);},t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return "object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),e(r.audio,"autoGainControl","mozAutoGainControl"),e(r.audio,"noiseSuppression","mozNoiseSuppression")),t(r)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const r=t.apply(this,arguments);return e(r,"mozAutoGainControl","autoGainControl"),e(r,"mozNoiseSuppression","noiseSuppression"),r};}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(r){return "audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),e(r,"autoGainControl","mozAutoGainControl"),e(r,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[r])};}}}function B(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function F(e){const t=d(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t],n={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=n[t];})),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())};}const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,s,i]=arguments;return n.apply(this,[e||null]).then(e=>{if(t.version<53&&!s)try{e.forEach(e=>{e.type=r[e.type]||e.type;});}catch(t){if("TypeError"!==t.name)throw t;e.forEach((t,n)=>{e.set(n,Object.assign({},t,{type:r[t.type]||t.type}));});}return e}).then(s,i)};}function V(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)};}function j(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach(e=>e._pc=this),e}),s(e,"track",e=>(e.receiver._pc=e.srcElement,e)),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)};}function H(e){!e.RTCPeerConnection||"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){c("removeStream","removeTrack"),this.getSenders().forEach(t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t);});});}function W(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel);}function K(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach(e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const n=t.apply(this,arguments);if(r){const{sender:t}=n,r=t.getParameters();"encodings"in r||(r.encodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(r).catch(()=>{})));}return n});}function $(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[];}):t.apply(this,arguments)};}function z(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>t.apply(this,arguments)).finally(()=>{this.setParametersPromises=[];}):t.apply(this,arguments)};}var Y=Object.freeze({shimOnTrack:B,shimPeerConnection:F,shimSenderGetStats:V,shimReceiverGetStats:j,shimRemoveStream:H,shimRTCDataChannel:W,shimAddTransceiver:K,shimCreateOffer:$,shimCreateAnswer:z,shimGetUserMedia:x,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return !0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)});}});function J(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach(r=>t.call(this,r,e)),e.getVideoTracks().forEach(r=>t.call(this,r,e));},e.RTCPeerConnection.prototype.addTrack=function(e,...r){return r&&r.forEach(e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e];}),t.apply(this,arguments)};}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const r=e.getTracks();this.getSenders().forEach(e=>{r.includes(e.track)&&this.removeTrack(e);});});}}function X(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach(e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t);});});}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach(t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const r=new Event("addstream");r.stream=t,e.dispatchEvent(r);});}),t.apply(e,arguments)};}}function Q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,s=t.setLocalDescription,i=t.setRemoteDescription,o=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:e,s=r.apply(this,[n]);return t?(s.then(e,t),Promise.resolve()):s},t.createAnswer=function(e,t){const r=arguments.length>=2?arguments[2]:e,s=n.apply(this,[r]);return t?(s.then(e,t),Promise.resolve()):s};let a=function(e,t,r){const n=s.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=a,a=function(e,t,r){const n=i.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=a,a=function(e,t,r){const n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=a;}function q(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>r(Z(e));}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n);}.bind(t));}function Z(e){return e&&void 0!==e.video?Object.assign({},e,{video:p(e.video)}):e}function ee(e){const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){const t=[];for(let r=0;r<e.iceServers.length;r++){let n=e.iceServers[r];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(c("RTCIceServer.url","RTCIceServer.urls"),(n=JSON.parse(JSON.stringify(n))).urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[r]);}e.iceServers=t;}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate});}function te(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return {receiver:this.receiver}}});}function re(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find(e=>"audio"===e.receiver.track.kind);!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find(e=>"video"===e.receiver.track.kind);!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video");}return t.apply(this,arguments)};}var ne=Object.freeze({shimLocalStreamsAPI:J,shimRemoteStreamsAPI:X,shimCallbacksAPI:Q,shimGetUserMedia:q,shimConstraints:Z,shimRTCIceServerUrls:ee,shimTrackEventTransceiver:te,shimCreateOfferLegacy:re});function se(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const r=new t(e),n=v.parseCandidate(e.candidate),s=Object.assign(r,n);return s.toJSON=function(){return {candidate:s.candidate,sdpMid:s.sdpMid,sdpMLineIndex:s.sdpMLineIndex,usernameFragment:s.usernameFragment}},s}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,s(e,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t));}function ie(e){if(!e.RTCPeerConnection)return;const t=d(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const r=function(e){if(!e||!e.sdp)return !1;const t=v.splitSections(e.sdp);return t.shift(),t.some(e=>{const t=v.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")})},n=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return -1;const r=parseInt(t[1],10);return r!=r?-1:r},s=function(e){let r=65536;return "firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},i=function(e,r){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const s=v.matchPrefix(e.sdp,"a=max-message-size:");return s.length>0?n=parseInt(s[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},o=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0});}if(r(arguments[0])){const e=n(arguments[0]),t=s(e),r=i(arguments[0],e);let o;o=0===t&&0===r?Number.POSITIVE_INFINITY:0===t||0===r?Math.max(t,r):Math.min(t,r);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a;}return o.apply(this,arguments)};}function oe(e){if(!(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const r=e.send;e.send=function(){const n=arguments[0],s=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&s>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)};}const r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=r.apply(this,arguments);return t(e,this),e},s(e,"datachannel",e=>(t(e.channel,e.target),e));}function ae(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return {completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e);},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(e=>{const r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const r=new Event("connectionstatechange",e);t.dispatchEvent(r);}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)};});}function ce(e){if(!e.RTCPeerConnection)return;const t=d(e);if("chrome"===t.browser&&t.version>=71)return;const r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter(e=>"a=extmap-allow-mixed"!==e.trim()).join("\n")),r.apply(this,arguments)};}var de=Object.freeze({shimRTCIceCandidate:se,shimMaxMessageSize:ie,shimSendThrowTypeError:oe,shimConnectionState:ae,removeAllowExtmapMixed:ce});const le=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const r=a,s=d(e),c={browserDetails:s,commonShim:de,extractVersion:n,disableLog:i,disableWarnings:o};switch(s.browser){case"chrome":if(!O||!_||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),c;r("adapter.js shimming chrome."),c.browserShim=O,E(e),h(e),_(e),g(e),C(e),m(e),f(e),R(e),I(e),se(e),ae(e),ie(e),oe(e),ce(e);break;case"firefox":if(!Y||!F||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),c;r("adapter.js shimming firefox."),c.browserShim=Y,x(e),F(e),B(e),H(e),V(e),j(e),W(e),K(e),$(e),z(e),se(e),ae(e),ie(e),oe(e);break;case"edge":if(!G||!L||!t.shimEdge)return r("MS edge shim is not included in this adapter release."),c;r("adapter.js shimming edge."),c.browserShim=G,b(e),k(e),L(e),U(e),ie(e),oe(e);break;case"safari":if(!ne||!t.shimSafari)return r("Safari shim is not included in this adapter release."),c;r("adapter.js shimming safari."),c.browserShim=ne,ee(e),re(e),Q(e),J(e),X(e),te(e),q(e),se(e),ie(e),oe(e),ce(e);break;default:r("Unsupported browser!");}return c}({window:window});le.options=le.options||{},le.onwebrtcreadyDone=!1,le.WebRTCPlugin={plugin:null},le._onwebrtcreadies=[],le.webRTCReady=function(e){if("function"!=typeof e)throw new Error("Callback provided is not a function");var t=function(){"function"==typeof window.require&&"function"==typeof le._defineMediaSourcePolyfill&&le._defineMediaSourcePolyfill(),e(null!==le.WebRTCPlugin.plugin);};!0===le.onwebrtcreadyDone?t():le._onwebrtcreadies.push(t);},le.maybeThroughWebRTCReady=function(){le.onwebrtcreadyDone||(le.onwebrtcreadyDone=!0,le._onwebrtcreadies.length?le._onwebrtcreadies.forEach((function(e){"function"==typeof e&&e(null!==le.WebRTCPlugin.plugin);})):"function"==typeof le.onwebrtcready&&le.onwebrtcready(null!==le.WebRTCPlugin.plugin));},window.webrtcDetectedBrowser=null,window.webrtcDetectedVersion=null,window.webrtcMinimumVersion=null,window.webrtcDetectedDCSupport=null,le.parseWebrtcDetectedBrowser=function(){var e=null;if(window.opr&&opr.addons||window.opera||navigator.userAgent.indexOf(" OPR/")>=0)e=navigator.userAgent.match(/OPR\/(\d+)/i)||[],window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=26,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport="SCTP";else if(navigator.userAgent.match(/Bowser\/[0-9.]*/g)){e=navigator.userAgent.match(/Bowser\/[0-9.]*/g)||[];var t=parseInt((navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[])[2]||"0",10);window.webrtcDetectedBrowser="bowser",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=0,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=t>30?"SCTP":"RTP";}else if(navigator.userAgent.indexOf("OPiOS")>0)e=navigator.userAgent.match(/OPiOS\/([0-9]+)\./),window.webrtcDetectedBrowser="opera",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("CriOS")>0)e=navigator.userAgent.match(/CriOS\/([0-9]+)\./)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedBrowser="chrome",window.webrtcDetectedDCSupport=null;else if(navigator.userAgent.indexOf("FxiOS")>0)e=navigator.userAgent.match(/FxiOS\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=0,window.webrtcDetectedType=null,window.webrtcDetectedDCSupport=null;else if(document.documentMode)e=/\brv[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedBrowser="IE",window.webrtcDetectedVersion=parseInt(e[1],10),window.webrtcMinimumVersion=9,window.webrtcDetectedType="plugin",window.webrtcDetectedDCSupport="SCTP",webrtcDetectedVersion||(e=/\bMSIE[ :]+(\d+)/g.exec(navigator.userAgent)||[],window.webrtcDetectedVersion=parseInt(e[1]||"0",10));else if(window.StyleMedia||navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))e=navigator.userAgent.match(/Edge\/(\d+).(\d+)$/)||[],window.webrtcDetectedBrowser="edge",window.webrtcDetectedVersion=parseFloat((e[0]||"0/0").split("/")[1],10),window.webrtcMinimumVersion=13.10547,window.webrtcDetectedType="ms",window.webrtcDetectedDCSupport=null;else if("undefined"!=typeof InstallTrigger||navigator.userAgent.indexOf("irefox")>0)e=navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[],window.webrtcDetectedBrowser="firefox",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=33,window.webrtcDetectedType="moz",window.webrtcDetectedDCSupport="SCTP";else if(window.chrome&&window.chrome.webstore||navigator.userAgent.indexOf("Chrom")>0)e=navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./i)||[],window.webrtcDetectedBrowser="chrome",window.webrtcDetectedVersion=parseInt(e[2]||"0",10),window.webrtcMinimumVersion=38,window.webrtcDetectedType="webkit",window.webrtcDetectedDCSupport=window.webrtcDetectedVersion>30?"SCTP":"RTP";else if(/constructor/i.test(window.HTMLElement)||"[object SafariRemoteNotification]"===(!window.safari||safari.pushNotification).toString()||navigator.userAgent.match(/AppleWebKit\/(\d+)\./)||navigator.userAgent.match(/Version\/(\d+).(\d+)/)){e=navigator.userAgent.match(/version\/(\d+)\.(\d+)/i)||[];var r=navigator.userAgent.match(/AppleWebKit\/(\d+)/i)||[],n=navigator.userAgent.match(/(iPhone|iPad)/gi),s=r.length>=1&&r[1]>=604;if(window.webrtcDetectedBrowser="safari",window.webrtcDetectedVersion=parseInt(e[1]||"0",10),window.webrtcMinimumVersion=7,n)window.webrtcDetectedType=s?"AppleWebKit":null;else{var i=window.webrtcDetectedVersion,o=parseInt(e[2]||"0",10),a=11==i&&o<2;window.webrtcDetectedType=!s||le.options.forceSafariPlugin&&a?"plugin":"AppleWebKit";}window.webrtcDetectedDCSupport="SCTP";}le.webrtcDetectedBrowser=window.webrtcDetectedBrowser,le.webrtcDetectedVersion=window.webrtcDetectedVersion,le.webrtcMinimumVersion=window.webrtcMinimumVersion,le.webrtcDetectedType=window.webrtcDetectedType,le.webrtcDetectedDCSupport=window.webrtcDetectedDCSupport;},le.addExtensions=function(){var e=null,t=null;navigator.mozGetUserMedia?(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}):navigator.webkitGetUserMedia?(e=function(e,t){return le.webrtcDetectedVersion>=43?e.srcObject=t:void 0!==e.src?e.src=URL.createObjectURL(t):console.error("Error attaching stream to element."),e},t=function(e,t){return le.webrtcDetectedVersion>=43?e.srcObject=t.srcObject:e.src=t.src,e}):"AppleWebKit"===le.webrtcDetectedType&&(e=function(e,t){return e.srcObject=t,e},t=function(e,t){return e.srcObject=t.srcObject,e}),window.attachMediaStream=e,window.reattachMediaStream=t,le.attachMediaStream=e,le.reattachMediaStream=t;},le.parseWebrtcDetectedBrowser(),le.addExtensions(),le.maybeThroughWebRTCReady();class pe{constructor(e,t){this.name=e,this.detail=t;}}const ue=(e={})=>new pe("onIncomingStream",{detail:e}),Se=(e={})=>new pe("onIncomingScreenStream",{detail:e}),Ee=(e={})=>new pe("streamEnded",{detail:e}),he=(e={})=>new pe("streamMuted",{detail:e}),ge=(e={})=>new pe("dataChannelState",{detail:e}),me=(e={})=>new pe("onIncomingMessage",{detail:e}),fe=(e={})=>new pe("storedMessages",{detail:e}),Re=(e={})=>new pe("encryptSecretsUpdated",{detail:e}),Te=(e={})=>new pe("persistentMessageState",{detail:e}),Ce=(e={})=>new pe("handshakeProgress",{detail:e}),_e=(e={})=>new pe("readyStateChange",{detail:e}),Ie=e=>new pe("candidateProcessingState",{detail:e}),Oe=e=>new pe("candidateGenerationState",{detail:e}),Ae=e=>new pe("iceConnectionState",{detail:e}),ve=(e={})=>new pe("peerUpdated",{detail:e}),De=(e={})=>new pe("peerJoined",{detail:e}),ye=(e={})=>new pe("peerLeft",{detail:e}),Ne=(e={})=>new pe("serverPeerLeft",{detail:e}),Pe=(e={})=>new pe("getPeersStateChange",{detail:e}),Me=(e={})=>new pe("peerConnectionState",{detail:e}),we=(e={})=>new pe("getConnectionStatusStateChange",{detail:e}),be=e=>new pe("channelMessage",{detail:e}),ke=e=>new pe("socketError",{detail:e}),Le=(e={})=>new pe("mediaAccessFallback",{detail:e}),Ue=(e={})=>new pe("rtmpState",{detail:e}),Ge=(e={})=>new pe("mediaAccessError",{detail:e}),xe=(e={})=>new pe("mediaInfoDeleted",{detail:e}),Be={CONNECTING:"connecting",OPEN:"open",CLOSING:"closing",CLOSED:"closed",ERROR:"error",CREATE_ERROR:"createError",BUFFERED_AMOUNT_LOW:"bufferedAmountLow",SEND_MESSAGE_ERROR:"sendMessageError"},Fe={MESSAGING:"messaging",DATA:"data"},Ve={MESSAGE:"message",TRANSFER:"transfer"},je={BINARY_STRING:"binaryString",ARRAY_BUFFER:"arrayBuffer",BLOB:"blob",STRING:"string"},He="0.1.3",We={NEW:"new",GATHERING:"gathering",COMPLETED:"complete"},Ke={RECEIVED:"received",DROPPED:"dropped",BUFFERED:"buffered",PROCESSING:"processing",PROCESS_SUCCESS:"processSuccess",PROCESS_ERROR:"processError"},$e={STARTING:"starting",CHECKING:"checking",CONNECTED:"connected",COMPLETED:"completed",CLOSED:"closed",FAILED:"failed",TRICKLE_FAILED:"trickleFailed",DISCONNECTED:"disconnected"},ze={UDP:"udp",TCP:"tcp",ANY:"any",NONE:"none",ALL:"all"},Ye={STABLE:"stable",HAVE_LOCAL_OFFER:"have-local-offer",HAVE_REMOTE_OFFER:"have-remote-offer",CLOSED:"closed"},Je={RETRIEVING:0,RETRIEVE_SUCCESS:1,RETRIEVE_ERROR:-1},Xe={MCU:"mcu"},Qe={MAX_COMPAT:"max-compat",BALANCED:"balanced",MAX_BUNDLE:"max-bundle",NONE:"none"},qe={REQUIRE:"require",NEGOTIATE:"negotiate"},Ze={RSA:"RSA",ECDSA:"ECDSA",AUTO:"AUTO"},et={ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",ERROR:"error"},tt={ENQUIRED:"enquired",DISPATCHED:"dispatched",RECEIVED:"received"},rt={WARNING:"warning",REJECT:"reject",LOCKED:"locked"},nt={INIT:0,LOADING:1,COMPLETED:2,ERROR:-1},st={API_INVALID:4001,API_DOMAIN_NOT_MATCH:4002,API_CORS_DOMAIN_NOT_MATCH:4003,API_CREDENTIALS_INVALID:4004,API_CREDENTIALS_NOT_MATCH:4005,API_INVALID_PARENT_KEY:4006,API_NO_MEETING_RECORD_FOUND:4010,API_OVER_SEAT_LIMIT:4020,API_RETRIEVAL_FAILED:4021,API_WRONG_ACCESS_DOMAIN:5005,XML_HTTP_REQUEST_ERROR:-1,XML_HTTP_NO_REPONSE_ERROR:-2,NO_SOCKET_IO:1,NO_XMLHTTPREQUEST_SUPPORT:2,NO_WEBRTC_SUPPORT:3,NO_PATH:4,ADAPTER_NO_LOADED:7,PARSE_CODECS:8},it={ENFORCE_OFFERER:"enforceOfferer",ENFORCE_ANSWERER:"enforceAnswerer",AUTO:"auto"},ot={CONNECTION_FAILED:0,RECONNECTION_FAILED:-1,CONNECTION_ABORTED:-2,RECONNECTION_ABORTED:-3,RECONNECTION_ATTEMPT:-4},at={NON_FALLBACK:"nonfallback",FALLBACK_PORT:"fallbackPortNonSSL",FALLBACK_SSL_PORT:"fallbackPortSSL",LONG_POLLING:"fallbackLongPollingNonSSL",LONG_POLLING_SSL:"fallbackLongPollingSSL"},ct="2.1.0",dt={AUTO:"auto",VP8:"VP8",H264:"H264",VP9:"VP9"},lt={AUTO:"auto",ISAC:"ISAC",OPUS:"opus",ILBC:"ILBC",G722:"G722",PCMU:"PCMU",PCMA:"PCMA"},pt={QQVGA:{width:160,height:120},HQVGA:{width:240,height:160},QVGA:{width:320,height:240},WQVGA:{width:384,height:240},HVGA:{width:480,height:320},VGA:{width:640,height:480},WVGA:{width:768,height:480},FWVGA:{width:854,height:480},SVGA:{width:800,height:600},DVGA:{width:960,height:640},WSVGA:{width:1024,height:576},HD:{width:1280,height:720},HDPLUS:{width:1600,height:900},FHD:{width:1920,height:1080},QHD:{width:2560,height:1440},WQXGAPLUS:{width:3200,height:1800},UHD:{width:3840,height:2160},UHDPLUS:{width:5120,height:2880},FUHD:{width:7680,height:4320},QUHD:{width:15360,height:8640}},ut={FALLBACKING:0,FALLBACKED:1,ERROR:-1},St={START:0,STOP:1,LINK:2,ERROR:-1},Et={WRQ:"WRQ",ACK:"ACK",ERROR:"ERROR",CANCEL:"CANCEL",MESSAGE:"MESSAGE"},ht={JOIN_ROOM:"joinRoom",IN_ROOM:"inRoom",ENTER:"enter",WELCOME:"welcome",OFFER:"offer",ANSWER:"answer",ANSWER_ACK:"answerAck",CANDIDATE:"candidate",BYE:"bye",REDIRECT:"redirect",UPDATE_USER:"updateUserEvent",ROOM_LOCK:"roomLockEvent",PUBLIC_MESSAGE:"public",PRIVATE_MESSAGE:"private",STREAM:"stream",GROUP:"group",GET_PEERS:"getPeers",PEER_LIST:"peerList",INTRODUCE:"introduce",INTRODUCE_ERROR:"introduceError",APPROACH:"approach",START_RECORDING:"startRecordingRoom",STOP_RECORDING:"stopRecordingRoom",RECORDING:"recordingEvent",END_OF_CANDIDATES:"endOfCandidates",START_SCREENSHARE:"startScreenshare",START_RTMP:"startRTMP",STOP_RTMP:"stopRTMP",RTMP:"rtmpEvent",MEDIA_INFO_EVENT:"mediaInfoEvent",MUTE_VIDEO_EVENT:"muteVideoEvent",MUTE_AUDIO_EVENT:"muteAudioEvent",MESSAGE:"message",GET_STORED_MESSAGES:"getStoredMessages",STORED_MESSAGES:"storedMessages"},gt={ENDED:"ended",REPLACED_STREAM_ENDED:"replacedStreamEnded",SCREENSHARE_REPLACE_START:"screenshareStart",USER_MEDIA_REPLACE_START:"userMediaReplaceStart"},mt=[ht.STREAM,ht.UPDATE_USER,ht.MUTE_AUDIO_EVENT,ht.MUTE_VIDEO_EVENT,ht.PUBLIC_MESSAGE],ft={PLAN_B:"plan-b",UNIFIED:"unified-plan"},Rt={START:0,STOP:1,ERROR:-1},Tt={MUTED:0,ACTIVE:1,UNAVAILABLE:-1},Ct={SKYLINK_EVENT:"SKYLINK EVENT",SKYLINK_ERROR:"SKYLINK ERROR",STATS_MODULE:"RTCStatsReport",SESSION_DESCRIPTION:"RTCSessionDescription",PEER_CONNECTION:"RTCPeerConnection",CANDIDATE_HANDLER:"RTCIceCandidate",DATA_CHANNEL:"RTCDataChannel",SIG_SERVER:"SIG SERVER",PEER_MEDIA:"PEER MEDIA",PEER_INFORMATION:"PEER INFORMATION",ROOM:"ROOM",RECORDING:"RECORDING",MEDIA_STREAM:"MEDIA STREAM",MESSAGING:"MESSAGING",ASYNC_MESSAGING:"ASYNC MESSAGING",ENCRYPTED_MESSAGING:"ENCRYPTED MESSAGING"},_t={AUDIO_MIC:"audioMic",VIDEO_CAMERA:"videoCamera",VIDEO_SCREEN:"videoScreen",VIDEO_OTHER:"videoOther",AUDIO:"audio",VIDEO:"video"},It={LIVE:"live",ENDED:"ended"},Ot={AUDIO:"audio",VIDEO:"video"},At={MUTED:"muted",ACTIVE:"active",STOPPED:"stopped",UNAVAILABLE:"unavailable"},vt={PUBLISHER_ID:"publisherId",MEDIA_ID:"mediaId",MEDIA_TYPE:"mediaType",MEDIA_STATE:"mediaState",TRANSCEIVER_MID:"transceiverMid",MEDIA_META_DATA:"mediaMetaData",SIMULCAST:"simulcast",STREAM_ID:"streamId"},Dt={WEB:"Web SDK",ANDROID:"Android SDK",IOS:"iOS SDK",CPP:"C++ SDK"},yt={CHROME:"chrome",FIREFOX:"firefox",SAFARI:"safari",REACT_NATIVE:"react-native"},Nt={MCU:"MCU"},Pt={CONNECT:"connect",DISCONNECT:"disconnect",RECONNECT_ATTEMPT:"reconnect_attempt",RECONNECT_SUCCESS:"reconnect_success",RECONNECT_FAILED:"reconnect_failed",RECONNECT_ERROR:"reconnect_error",MESSAGE:"message",ERROR:"error"},Mt={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"},wt={SIGNALING:Pt},bt=Object.freeze({ON_INCOMING_STREAM:"onIncomingStream",ON_INCOMING_SCREEN_STREAM:"onIncomingScreenStream",STREAM_ENDED:"streamEnded",PEER_UPDATED:"peerUpdated",PEER_JOINED:"peerJoined",PEER_LEFT:"peerLeft",PEER_CONNECTION_STATE:"peerConnectionState",DATA_CHANNEL_STATE:"dataChannelState",ON_INCOMING_MESSAGE:"onIncomingMessage",HANDSHAKE_PROGRESS:"handshakeProgress",SERVER_PEER_JOINED:"serverPeerJoined",SERVER_PEER_LEFT:"serverPeerLeft",CANDIDATE_PROCESSING_STATE:"candidateProcessingState",CANDIDATE_GENERATION_STATE:"candidateGenerationState",CANDIDATES_GATHERED:"candidatesGathered",DATA_STREAM_STATE:"dataStreamState",DATA_TRANSFER_STATE:"dataTransferState",ON_INCOMING_DATA:"onIncomingData",ON_INCOMING_DATA_REQUEST:"onIncomingDataRequest",ON_INCOMING_DATA_STREAM:"onIncomingDataStream",ON_INCOMING_DATA_STREAM_STARTED:"onIncomingDataStreamStarted",ON_INCOMING_DATA_STREAM_STOPPED:"onIncomingDataStreamStopped",GET_PEERS_STATE_CHANGE:"getPeersStateChange",SESSION_DISCONNECT:"sessionDisconnect",STREAM_MUTED:"streamMuted",CHANNEL_OPEN:"channelOpen",CHANNEL_REOPEN:"channelReopen",CHANNEL_CLOSE:"channelClose",CHANNEL_MESSAGE:"channelMessage",CHANNEL_ERROR:"channelError",CHANNEL_RETRY:"channelRetry",SOCKET_ERROR:"socketError",SYSTEM_ACTION:"systemAction",MEDIA_ACCESS_FALLBACK:"mediaAccessFallback",MEDIA_ACCESS_REQUIRED:"mediaAccessRequired",MEDIA_ACCESS_STOPPED:"mediaAccessStopped",MEDIA_ACCESS_SUCCESS:"mediaAccessSuccess",RECORDING_STATE:"recordingState",LOCAL_MEDIA_MUTED:"localMediaMuted",MEDIA_ACCESS_ERROR:"mediaAccessError",GET_CONNECTION_STATUS_STATE_CHANGE:"getConnectionStatusStateChange",READY_STATE_CHANGE:"readyStateChange",ROOM_LOCK:"roomLock",INTRODUCE_STATE_CHANGE:"introduceStateChange",ICE_CONNECTION_STATE:"iceConnectionState",BYE:"bye",RTMP_STATE:"rtmpState",LOGGED_ON_CONSOLE:"loggedOnConsole",MEDIA_INFO_DELETED:"mediaInfoDeleted",STORED_MESSAGES:"storedMessages",ENCRYPT_SECRETS_UPDATED:"encryptSecretsUpdated",PERSISTENT_MESSAGE_STATE:"persistentMessageState"});var kt=Object.freeze({DATA_CHANNEL_STATE:Be,DATA_CHANNEL_TYPE:Fe,DATA_CHANNEL_MESSAGE_ERROR:Ve,DATA_TRANSFER_DATA_TYPE:je,DT_PROTOCOL_VERSION:He,DATA_TRANSFER_TYPE:{UPLOAD:"upload",DOWNLOAD:"download"},DATA_TRANSFER_SESSION_TYPE:{BLOB:"blob",DATA_URL:"dataURL"},DATA_TRANSFER_STATE:{UPLOAD_REQUEST:"request",UPLOAD_STARTED:"uploadStarted",DOWNLOAD_STARTED:"downloadStarted",REJECTED:"rejected",CANCEL:"cancel",ERROR:"error",UPLOADING:"uploading",DOWNLOADING:"downloading",UPLOAD_COMPLETED:"uploadCompleted",DOWNLOAD_COMPLETED:"downloadCompleted",USER_REJECTED:"userRejected",USER_UPLOAD_REQUEST:"userRequest",START_ERROR:"startError"},DATA_STREAM_STATE:{SENDING_STARTED:"sendStart",SENDING_STOPPED:"sendStop",RECEIVING_STARTED:"receiveStart",RECEIVING_STOPPED:"receiveStop",RECEIVED:"received",SENT:"sent",ERROR:"error",START_ERROR:"startError"},CANDIDATE_GENERATION_STATE:We,CANDIDATE_PROCESSING_STATE:Ke,ICE_CONNECTION_STATE:$e,TURN_TRANSPORT:ze,PEER_CONNECTION_STATE:Ye,GET_CONNECTION_STATUS_STATE:Je,SERVER_PEER_TYPE:Xe,BUNDLE_POLICY:Qe,RTCP_MUX_POLICY:qe,PEER_CERTIFICATE:Ze,HANDSHAKE_PROGRESS:et,GET_PEERS_STATE:tt,INTRODUCE_STATE:{INTRODUCING:"introducing",ERROR:"error"},SYSTEM_ACTION:rt,SYSTEM_ACTION_REASON:{CREDENTIALS_EXPIRED:"oldTimeStamp",CREDENTIALS_ERROR:"credentialError",DUPLICATED_LOGIN:"duplicatedLogin",ROOM_NOT_STARTED:"notStart",EXPIRED:"expired",ROOM_LOCKED:"locked",FAST_MESSAGE:"fastmsg",ROOM_CLOSING:"toclose",ROOM_CLOSED:"roomclose",SERVER_ERROR:"serverError",KEY_ERROR:"keyFailed"},READY_STATE_CHANGE:nt,READY_STATE_CHANGE_ERROR:st,REGIONAL_SERVER:{APAC1:"",US1:""},PRIORITY_WEIGHT_SCHEME:it,LOG_LEVEL:{DEBUG:4,LOG:3,INFO:2,WARN:1,ERROR:0,NONE:-1},SOCKET_ERROR:ot,SOCKET_FALLBACK:at,SM_PROTOCOL_VERSION:ct,VIDEO_CODEC:dt,AUDIO_CODEC:lt,MEDIA_SOURCE:{SCREEN:"screen",WINDOW:"window",TAB:"tab",TAB_AUDIO:"audio",APPLICATION:"application",BROWSER:"browser",CAMERA:"camera"},VIDEO_RESOLUTION:pt,MEDIA_ACCESS_FALLBACK_STATE:ut,RECORDING_STATE:St,CHUNK_FILE_SIZE:49152,MOZ_CHUNK_FILE_SIZE:12288,BINARY_FILE_SIZE:65456,MOZ_BINARY_FILE_SIZE:16384,CHUNK_DATAURL_SIZE:1212,DC_PROTOCOL_TYPE:Et,SIG_MESSAGE_TYPE:ht,STREAM_STATUS:gt,GROUP_MESSAGE_LIST:mt,VIDEO_QUALITY:{HD:{video:3200,audio:150},HQ:{video:1200,audio:80},SQ:{video:800,audio:30},LQ:{video:400,audio:20}},SDP_SEMANTICS:ft,RTMP_STATE:Rt,MEDIA_STATUS:Tt,TAGS:Ct,MEDIA_TYPE:_t,TRACK_READY_STATE:It,TRACK_KIND:Ot,MEDIA_STATE:At,MEDIA_INFO:vt,SDK_VERSION:"2.0.0",SDK_NAME:Dt,API_VERSION:"9.0.0",SIGNALING_VERSION:"sig-v2",BROWSER_AGENT:yt,PEER_TYPE:Nt,SOCKET_EVENTS:Pt,SOCKET_TYPE:Mt,STATES:wt,EVENTS:bt});const Lt={INIT:{ERRORS:{NO_ADAPTER:"AdapterJS dependency is not loaded or incorrect AdapterJS dependency is used",NO_SOCKET_IO:"Socket.io not loaded - Please load socket.io",NO_FETCH_SUPPORT:"Fetch API is not supported in your browser. Please make sure you are using a modern browser: https://caniuse.com/#search=fetch",NO_APP_KEY:"Please provide an App Key - Get one at console.temasys.io!",AUTH_CORS:"Promise rejected due to CORS forbidden request - Please visit: http://support.temasys.com.sg/support/solutions/articles/12000006761-i-get-a-403-forbidden-access-is-denied-when-i-load-the-application-why-",AUTH_GENERAL:"Promise rejected due to network issue",SOCKET_CREATE_FAILED:"Failed creating socket connection object ->",SOCKET_ERROR_ABORT:"Reconnection aborted as the connection timed out or there no more available ports, transports and final attempts left"},INFO:{API_SUCCESS:"Promise resolved: APP Authenticated Successfully!"}},JOIN_ROOM:{ERRORS:{CODEC_SUPPORT:"No audio/video codecs available to start connection"}},ROOM:{ERRORS:{STOP:{SCREEN_SHARE:"Error stopping screenshare"},NOT_IN_ROOM:"User is not in room",NO_PEERS:"No peers in room"},LEAVE_ROOM:{ERROR:"Leave room error --\x3e",NO_PEERS:"No peers in room",DROPPING_HANGUP:"Dropping hang-up from remote peer",LEAVE_ALL_ROOMS:{SUCCESS:"Successfully left all rooms",ERROR:"Leave all rooms error --\x3e"},PEER_LEFT:{START:"Initiating peer left process",SUCCESS:"Successfully completed peer left process",ERROR:"Failed peer left process"},SENDING_BYE:"Sending bye message to all peers",DISCONNECT_SOCKET:{SUCCESS:"Successfully disconnected socket"},REMOVE_STATE:{SUCCESS:"Successfully removed room state"}}},ROOM_STATE:{NOT_FOUND:"Could not retrieve room state for room name/key",LEFT:"Peer left room",NO_ROOM_NAME:"No room name specified"},PEER_INFORMATIONS:{NO_PEER_INFO:"Not able to retrieve Peer Information for peerId:",UPDATE_USER_DATA:"Peer updated userData: ",OUTDATED_MSG:"Dropping outdated status ->",USER_DATA_NOT_JSON:"UserData is not JSON"},PEER_CONNECTION:{NO_PEER_CONNECTION:"No Peer Connection detected",ERRORS:{REMOVE_TRACK:"Error removing track from peer connection",REPLACE_TRACK:"Error replacing track in peer connection",REFRESH:"Error refreshing peer connection"},end_of_candidates:"Signaling of end-of-candidates remote ICE gathering",end_of_candidate_failure:"Failed signaling end-of-candidates ->",not_initialised:"Peer connection is not initialised",getstats_api_not_available:"getStats() API is not available",connection_status_no_pc:"There is currently no peer connections to retrieve connection status",ice_connection_state:"Ice connection state changed ->",peer_connection_state:"Peer connection state changed ->",ice_gathering_state:"Ice gathering state changed ->",refresh_start:"START: Refreshing peer connections",refresh_failed:"FAILED: Refreshing peer connections",refresh_completed:"All peer connections refreshed with resolve or errors",refresh_peer_failed:"Peer connection failed to refresh: ",refresh_peer_success:"Peer connection refreshed successfully: ",refresh_no_peer_connection:"There is currently no peer connections to restart",refresh_peerId_no_match:"PeerId does not match existing peer connections",refresh_no_edge_support:"Edge browser currently does not support renegotiation",refresh_not_supported:"Failed restarting with other agents connecting from other SDKs as re-negotiation is not supported by other SDKs",peerId_does_not_exist:"Peer Id does not exist ->"},PEER_PRIVILEGED:{not_privileged:"Please upgrade your key to privileged to use this function",no_appkey:"App key is not defined - Please authenticate again",getPeerListFromServer:"Enquired server for peers within the App space"},ICE_CANDIDATE:{CANDIDATE_HANDLER:{DROPPING_CANDIDATE:"Dropping ICE candidate",INVALID_CANDIDATE:"Received invalid ICE candidate message ->",VALID_CANDIDATE:"Received ICE candidate ->",FILTERED_CANDIDATE:"Dropping received ICE candidate as it matches ICE candidate filtering flag ->",FILTERING_FLAG_NOT_HONOURED:"Not dropping received ICE candidate as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured ->",CANDIDATE_ADDED:"Added ICE candidate successfully",ADDING_CANDIDATE:"Adding ICE Candidate",FAILED_ADDING_CANDIDATE:"Failed adding ICE candidate ->",ADD_BUFFERED_CANDIDATE:"Adding buffered ICE candidate",ADD_CANDIDATE_TO_BUFFER:"Adding ICE candidate to buffer",END_OF_CANDIDATES_SUCCESS:"Signaling of end-of-candidates remote ICE gathering",END_OF_CANDIDATES_FAILURE:"Failed signaling of end-of-candidates remote ICE gathering",ICE_GATHERING_STARTED:"ICE gathering has started",ICE_GATHERING_COMPLETED:"ICE gathering has completed",CANDIDATE_GENERATED:"Generated ICE candidate ->",DROP_EOC:"Dropping of sending ICE candidate end-of-candidates signal or unused ICE candidates to prevent errors ->",ICE_TRICKLE_DISABLED:"Dropping of sending ICE candidate as trickle ICE is disabled ->",SENDING_CANDIDATE:"Sending ICE candidate ->",NO_SDP:"Not sending any session description after ICE gathering completed as it is not present"}},SESSION_DESCRIPTION:{parsing_media_ssrc:"Parsing session description media SSRCs ->"},DATA_CHANNEL:{reviving_dataChannel:"Reviving Datachannel connection",refresh_error:"Not a valid Datachannel connection",CLOSING:"Closing DataChannel",closed:"Datachannel has closed",onclose_error:"Error in data-channel onclose callback",NO_REMOTE_DATA_CHANNEL:"Remote peer does not have data channel",ERRORS:{FAILED_CLOSING:"Failed closing DataChannels --\x3e ",NO_SESSIONS:"Peer Connection does not have DataChannel sessions"}},NEGOTIATION_PROGRESS:{SET_LOCAL_DESCRIPTION:"Successfully set local description --\x3e",SET_REMOTE_DESCRIPTION:"Successfully set remote description --\x3e",APPLYING_BUFFERED_REMOTE_OFFER:"Applying buffered remote offer",ERRORS:{FAILED_SET_LOCAL_DESCRIPTION:"Failed setting local description --\x3e",FAILED_SET_REMOTE_DESCRIPTION:"Failed setting remote description --\x3e",FAILED_SET_REMOTE_ANSWER:"Peer failed to set remote answer.",FAILED_RENEGOTIATION:"Failed renegotiation after answerAck",NOT_STABLE:"Dropping of message as signaling state is not stable",PROCESSING_EXISTING_SDP:"Dropping message as there is another sessionDescription being processed --\x3e",OFFER_TIEBREAKER:"Dropping the received offer: self weight is greater than incoming offer weight --\x3e",NO_LOCAL_BUFFERED_OFFER:"FATAL: No buffered local offer found - Unable to setLocalDescription",ADDING_REMOTE_OFFER_TO_BUFFER:"Adding remote offer received to buffer as current negotiation has not completed"}},SIGNALING:{MESSAGE_ADDED_TO_BUFFER:"Message buffered as enter message has not been sent",ENTER_LISTENER:"Enter listener initialized",BUFFERED_MESSAGES_SENT:"Buffered messages sent",BUFFERED_MESSAGES_DROPPED:"Buffered messages dropped - no mid",OUTDATED_MSG:"Dropping outdated status ->",DROPPING_MUTE_EVENT:"Dropping mute audio / video event message as it is processed by mediaInfoEvent",BUFFER_NOT_NEEDED:"Enter message sent. Messages do not need to be buffered",ABORTING_OFFER:"Aborting offer as current negotiation has not completed"},MESSAGING:{PRIVATE_MESSAGE:"Sending private message to Peer",BROADCAST_MESSAGE:"Broadcasting message to Peers",RECEIVED_MESSAGE:"Received message from Peer",PERSISTENCE:{SEND_MESSAGE:"Sending persisted message",NOT_PERSISTED:"Message will not be persisted as persistent flag is set to false",STORED_MESSAGES:"Received stored messages for room",IS_PERSISTENT_CONFIG:"Persistent message flag is set to",ERRORS:{FAILED_SETTING_PERSISTENCE:"Failed setting persistent message flag",INVALID_TYPE:"Persistent message flag must be of type boolean",PRIVATE_MESSAGE:"Cannot persist private messages",PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED:"Persistent Message feature is not enabled. Enable this feature on the key under 'Advanced Settings' in the Temasys Console"}},ENCRYPTION:{SEND_MESSAGE:"Sending encrypted message",DELETE_ALL:"Deleting all stored secrets",ERRORS:{FAILED_DECRYPTING_MESSAGE:"Failed decrypting message",ENCRYPT_SECRET:"Incorrect secret provided",INVALID_SECRETS:"No or invalid secret and secret id provided",SET_SELECTED_SECRET:"Failed setting selected secret",DELETE_ENCRYPT_SECRETS:"Failed deleting secret",SET_ENCRYPT_SECRET:"Failed setting secret",SECRET_ID_NOT_FOUND:"Secret id not found",NO_SECRET_OR_SECRET_ID:"Secret and / or secret id not provided",INVALID_TYPE:"Secret and secret id must be of type string and not empty",SECRET_ID_NOT_UNIQUE:"Secret id provided is not unique",SECRET_ID_NOT_SELECTED:"Secret id not selected",SECRET_ID_NOT_PROVIDED:"Secret id not provided",SECRETS_NOT_PROVIDED:"Secrets not provided"}},ERRORS:{DROPPING_MESSAGE:"Dropping message",FAILED_SENDING_MESSAGE:"Failed to send user message"}},MEDIA_INFO:{UPDATE_SUCCESS:"Successfully updated media info",ERRORS:{NO_ASSOCIATED_STREAM_ID:"There is no streamId associated with the mediaId and transceiverMid pair",FAILED_PROCESSING_MEDIA_INFO_EVENT:"Failed to process mediaInfoEvent message",FAILED_UPDATING:"Failed to update media info",FAILED_PROCESSING_PEER_MEDIA:"Failed to process media info",FAILED_UPDATING_TRANSCEIVER_MID:"Failed updating media info transceiverMid after setLocalDescription",FAILED_SETTING_PEER_MEDIA_INFO:"Failed setting peer media at offer / answer"},WARN:{READ_ONLY_VALUE:"Attempting to change media info read only value: ",INVALID_MEDIA_TYPE:"Invalid media info media type: "},VIDEO_STATE_CHANGE:"Peers's video state changed to ->",AUDIO_STATE_CHANGE:"Peers's audio state changed to ->",VIDEO_SCREEN_STATE_CHANGE:"Peers's video screen state changed to ->"},MEDIA_STREAM:{STOP_SETTINGS:"Stopped streams with settings:",STOP_SUCCESS:"Successfully stopped and removed stream from state",REMOTE_TRACK_REMOVED:"Remote MediaStreamTrack removed",START_FALLBACK:"Fall back to retrieve audio only stream",NO_OPTIONS:"No user media options provided",DEFAULT_OPTIONS:"Using default options",FALLBACK_SUCCESS:"Successfully retrieved audio fallback stream",START_SCREEN_SUCCESS:"Successfully retrieved screen share stream",STOP_SCREEN_SUCCESS:"Successfully stopped screen share stream",UPDATE_MUTED_SETTINGS:"Updated stream muted setting",UPDATE_MEDIA_STATUS:"Updated stream media status",AUDIO_MUTED:"Peers's audio muted: ",VIDEO_MUTED:"Peers's video muted: ",ERRORS:{STOP_SCREEN:"Error stopping screen share stream",START_SCREEN:"Error starting screen share stream",STOP_ADDED_STREAM:"Error stopping added stream",STOP_REPLACED_STREAM:"Error stopping replaced stream",STOP_USER_MEDIA:"Error stopping user media",STOP_AUDIO_TRACK:"Error stopping audio tracks in stream",STOP_VIDEO_TRACK:"Error stopping video tracks in stream",STOP_MEDIA_TRACK:"Error stopping MediaTrack",STOP_SCREEN_TRACK:"Error stopping screen track in stream",DROPPING_ONREMOVETRACK:"Dropping onremovetrack",NO_STREAM:"No stream to process",INVALID_STREAM_ID:"No stream detected with stream id",NO_USER_MEDIA_STREAMS:"No user media streams detected",INVALID_STREAM_ID_TYPE:"Stream id is not a string",NO_STREAM_ID:"No stream id provided",PEER_SCREEN_ACTIVE:"Peer has existing screen share",REPLACE_SCREEN:"Error replacing user media stream with screenshare stream",FALLBACK:"Error retrieving fallback audio stream",INVALID_GUM_OPTIONS:"Invalid user media options",GET_USER_MEDIA:"Error retrieving stream from 'getUserMedia' method",INVALID_MUTE_OPTIONS:"Invalid muteStreams options provided",NO_STREAMS_MUTED:"No streams to mute",SEND_STREAM:"Error sending stream",INVALID_MEDIA_STREAM_ARRAY:"Array is not of type MediaStream",ACTIVE_STREAMS:"There are currently active streams being sent to remote peers. Please stop streams."}},STATS_MODULE:{NOT_INITIATED:"Stats Module is not initiated",STATS_DISCARDED:"Stats report discarded as peer has left the room",ERRORS:{RETRIEVE_STATS_FAILED:"Failed retrieving stats",POST_FAILED:"Failed posting to stats api",PARSE_FAILED:"Failed parsing stats report",STATS_IS_NULL:"Stats object is null",INVALID_TRACK_KIND:"Media kind is not audio or video"},HANDLE_ICE_GATHERING_STATS:{PROCESS_FAILED:"process_failed",PROCESS_SUCCESS:"process_success",PROCESSING:"processing",DROPPED:"dropped",BUFFERED:"buffered"},HANDLE_NEGOTIATION_STATS:{OFFER:{create:"create_offer",create_error:"error_create_offer",set:"set_offer",set_error:"error_set_offer",offer:"offer",dropped:"dropped_offer"},ANSWER:{create:"create_answer",create_error:"error_create_answer",set:"set_answer",set_error:"error_set_ANSWER",answer:"answer",dropped:"dropped_answer"}},HANDLE_DATA_CHANNEL_STATS:{open:"open",closed:"closed",reconnecting:"reconnecting"},HANDLE_CONNECTION_STATS:{},HANDLE_BANDWIDTH_STATS:{RETRIEVE_FAILED:"Failed posting bandwidth stats: ",NO_STATE:"No room state"},HANDLE_ICE_CONNECTION_STATS:{RETRIEVE_FAILED:"Failed retrieving stats: ",SEND_FAILED:"Failed sending ice connection stats: "},HANDLE_RECORDING_STATS:{START:"start",STOP:"stop",REQUEST_START:"request-start",REQUEST_STOP:"request-stop",ERROR_NO_MCU_START:"error-no-mcu-start",ERROR_NO_MCU_STOP:"error-no-mcu-stop",ERROR_START_ACTIVE:"error-start-when-active",ERROR_STOP_ACTIVE:"error-stop-when-active",ERROR_MIN_STOP:"error-min-stop",MCU_RECORDING_ERROR:"mcu-recording-error"}},RECORDING:{START_SUCCESS:"Started recording",STOP_SUCCESS:"Stopped recording",START_FAILED:"Failed to start recording",STOP_FAILED:"Failed to stop recording",MIN_RECORDING_TIME_REACHED:"4 seconds has been recorded - Recording can be stopped now",ERRORS:{MCU_NOT_CONNECTED:"MCU is not connected",EXISTING_RECORDING_IN_PROGRESS:"There is an existing recording in-progress",NO_RECORDING_IN_PROGRESS:"There is no existing recording in-progress",MIN_RECORDING_TIME:"4 seconds has not been recorded yet",STOP_ABRUPT:"Recording stopped abruptly before 4 seconds",SESSION_EMPTY:'Received request of "off" but the session is empty',MCU_RECORDING_ERROR:"Recording error received from MCU"}},RTMP:{start_no_mcu:"Unable to start RTMP session as MCU is not connected",stop_no_mcu:"Unable to stop RTMP as MCU is not connected",start_no_stream_id:"Unable to start RTMP Session stream id is missing",start_no_endpoint:"Unable to start RTMP Session as Endpoint is missing",starting_rtmp:"Starting RTMP Session",stopping_rtmp:"Stopping RTMP Session",message_received_from_sig:"Received RTMP Session message ->",stop_session_empty:'Received request of "off" but the session is empty',stopped_success:"Stopped RTMP Session",started_success:"Started RTMP Session",error_session_empty:"Received error but the session is empty ->",error_session:"RTMP session failure ->",error_Session_abrupt:"Stopped RTMP session abruptly"},PERSISTENT_MESSAGE:{ERRORS:{NO_DEPENDENCY:"CryptoJS is not available"}},UTILS:{INVALID_BROWSER_AGENT:"Invalid browser agent"},LOGGER:{EVENT_DISPATCHED:"Event dispatched",EVENT_REGISTERED:"Event successfully registered",EVENT_UNREGISTERED:"Event successfully unregistered",EVENT_DISPATCH_ERROR:"Error dispatching event",EVENT_REGISTER_ERROR:"Error registering event",EVENT_UNREGISTER_ERROR:"Error unregistering event",LOGS_NOT_STORED:"Store logs feature is not enabled. Enable it via SkylinkLogger.setLevel(logLevel, storeLogs)",LOGS_CLEARED:"Stored logs cleared",INVALID_CB:"Dropping listener as it is not a function"},BROWSER_AGENT:{REACT_NATIVE:{ERRORS:{DROPPING_ONREMOVETRACK:"Dropping onremovetrack as trackInfo is malformed"}}}};var Ut=A((function(e){var t=function(){function e(e,t){return null!=t&&e instanceof t}var t,r,n;try{t=Map;}catch(e){t=function(){};}try{r=Set;}catch(e){r=function(){};}try{n=Promise;}catch(e){n=function(){};}function s(i,a,c,d,l){"object"==typeof a&&(c=a.depth,d=a.prototype,l=a.includeNonEnumerable,a=a.circular);var p=[],u=[],S="undefined"!=typeof Buffer;return void 0===a&&(a=!0),void 0===c&&(c=1/0),function i(c,E){if(null===c)return null;if(0===E)return c;var h,g;if("object"!=typeof c)return c;if(e(c,t))h=new t;else if(e(c,r))h=new r;else if(e(c,n))h=new n((function(e,t){c.then((function(t){e(i(t,E-1));}),(function(e){t(i(e,E-1));}));}));else if(s.__isArray(c))h=[];else if(s.__isRegExp(c))h=new RegExp(c.source,o(c)),c.lastIndex&&(h.lastIndex=c.lastIndex);else if(s.__isDate(c))h=new Date(c.getTime());else{if(S&&Buffer.isBuffer(c))return h=Buffer.allocUnsafe?Buffer.allocUnsafe(c.length):new Buffer(c.length),c.copy(h),h;e(c,Error)?h=Object.create(c):void 0===d?(g=Object.getPrototypeOf(c),h=Object.create(g)):(h=Object.create(d),g=d);}if(a){var m=p.indexOf(c);if(-1!=m)return u[m];p.push(c),u.push(h);}for(var f in e(c,t)&&c.forEach((function(e,t){var r=i(t,E-1),n=i(e,E-1);h.set(r,n);})),e(c,r)&&c.forEach((function(e){var t=i(e,E-1);h.add(t);})),c){var R;g&&(R=Object.getOwnPropertyDescriptor(g,f)),R&&null==R.set||(h[f]=i(c[f],E-1));}if(Object.getOwnPropertySymbols){var T=Object.getOwnPropertySymbols(c);for(f=0;f<T.length;f++){var C=T[f];(!(I=Object.getOwnPropertyDescriptor(c,C))||I.enumerable||l)&&(h[C]=i(c[C],E-1),I.enumerable||Object.defineProperty(h,C,{enumerable:!1}));}}if(l){var _=Object.getOwnPropertyNames(c);for(f=0;f<_.length;f++){var I,O=_[f];(I=Object.getOwnPropertyDescriptor(c,O))&&I.enumerable||(h[O]=i(c[O],E-1),Object.defineProperty(h,O,{enumerable:!1}));}}return h}(i,c)}function i(e){return Object.prototype.toString.call(e)}function o(e){var t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),t}return s.clonePrototype=function(e){if(null===e)return null;var t=function(){};return t.prototype=e,new t},s.__objToStr=i,s.__isDate=function(e){return "object"==typeof e&&"[object Date]"===i(e)},s.__isArray=function(e){return "object"==typeof e&&"[object Array]"===i(e)},s.__isRegExp=function(e){return "object"==typeof e&&"[object RegExp]"===i(e)},s.__getRegExpFlags=o,s}();e.exports&&(e.exports=t);}));const Gt=(e,t)=>e.id===t.id,xt={RECONNECTION_ATTEMPTS:{WEBSOCKET:5,POLLING:4},RECONNECTION_DELAY_MAX:5e3,RECONNECTION_DELAY:1e3,RECONNECTION_FINAL_ATTEMPTS:10},Bt={SOCKET:e=>({forceNew:!0,reconnection:!0,timeout:e.socketTimeout,path:e.socketServerPath,reconnectionAttempts:xt.RECONNECTION_ATTEMPTS.WEBSOCKET,reconnectionDelayMax:xt.RECONNECTION_DELAY_MAX,reconnectionDelay:xt.RECONNECTION_DELAY,transports:[Mt.WEBSOCKET.toLowerCase()],query:{Skylink_SDK_type:Dt.WEB,Skylink_SDK_version:"2.0.0",Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"},extraHeaders:{Skylink_SDK_type:Dt.WEB,Skylink_SDK_version:"2.0.0",Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"}})},Ft=xt,Vt=e=>{const t=Xi.getSkylinkState(e.roomKey),r=Xi.getInitOptions(),{config:n}=e,{socketServer:s,socketTimeout:i,socketServerPath:o}=r,{socketPorts:a}=t,c=((e,t)=>Bt[e](t))("SOCKET",{socketTimeout:i,socketServerPath:o});let d=[];s&&hs(s)&&Array.isArray(s.ports)&&s.ports.length?({ports:d}=s):d=a[n.signalingServerProtocol],(e=>!e.signalingServerPort)(n)?(n.signalingServerPort=d[0],n.fallbackType=at.NON_FALLBACK):((e,t)=>e.indexOf(t.signalingServerPort)===e.length-1)(d,n)||Ts(r.socketServer)?n.socketType===Mt.WEBSOCKET?(n.socketType=Mt.POLLING,n.signalingServerPort=d[0]):(n.socketSession.finalAttempts+=1,n.signalingServerPort=d[0]):n.signalingServerPort=d[d.indexOf(n.signalingServerPort)+1],n.socketType===Mt.POLLING&&(c.reconnectionDelayMax=Ft.RECONNECTION_DELAY_MAX,c.reconnectionAttempts=Ft.RECONNECTION_ATTEMPTS.POLLING,c.transports=[Mt.XHR_POLLING,Mt.JSONP_POLLING,Mt.POLLING.toLowerCase()]);const l=(e=>{const{signalingServerProtocol:t,signalingServer:r,signalingServerPort:n,socketServer:s}=e;let i="";return i=Ts(r)?`${t}//${r}`:r&&hs(r)&&r.protocol?`${r.protocol}//${s.url}:${n}?rand=${Date.now()}`:`${t}//${r}:${n}?rand=${Date.now()}`})({signalingServerProtocol:n.signalingServerProtocol,signalingServer:t.socketServer,signalingServerPort:n.signalingServerPort,socketServer:s});return n.socketServer=s,n.socketServerPath=o,t.socketSession=n,Xi.setSkylinkState(t,e.roomKey),window.io(l,c)},jt=e=>{const t=Xt.getCurrentSessionInfo(e);return delete t.room,t},Ht=(e,t)=>{const{streams:r}=e;return !!r.userMedia&&Object.values(r.userMedia).some(e=>e.isReplaced&&e.id===t.id)},Wt=(e,t)=>!(!e||!e[0])&&(e.forEach(e=>{try{e.stop();}catch(r){Ys.log.ERROR([t,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.ERRORS.STOP_MEDIA_TRACK} - track id: ${e.id}`],r);}}),!0),Kt=(e,t,r)=>{const{room:n}=e,s=e;let i=-1;if(!s.currentRTCRTPSenders[t])return;const o=s.currentRTCRTPSenders[t];for(let e=0;e<o.length;e+=1)if(r===o[e]){i=e;break}-1!==i?(o.splice(i,1),s.currentRTCRTPSenders[t]=o,Xi.setSkylinkState(s,n.id)):Ys.log.WARN([t,null,null,"No matching sender was found for the peer."],r);},$t={prepStopStreams:(e,t,r=!1,n=!1)=>new Promise((s,i)=>{const o=Xi.getSkylinkState(e),{streams:a}=o;o&&a||i(new Error(`${Lt.ROOM_STATE.NOT_FOUND} - ${e}`)),(!a||!n&&!a.userMedia||n&&!a.screenshare||n&&a.screenshare&&a.screenshare.id!==t)&&i(new Error(`${Lt.MEDIA_STREAM.ERRORS.NO_STREAM} - ${t}`)),n?$t.prepStopScreenStream(o.room,t,r).then(()=>s()).catch(e=>i(e)):$t.prepStopUserMediaStreams(o,t,r).then(()=>s()).catch(e=>i(e));}),prepStopUserMediaStreams:(e,t,r)=>new Promise((n,s)=>{const{user:i}=e,o=(e=>{const{streams:t}=e,r={replacedStreams:[],addedStreams:[]};return Object.keys(t.userMedia).forEach(n=>{Ht(e,t.userMedia[n].stream)?r.replacedStreams.push(t.userMedia[n].stream):r.addedStreams.push(t.userMedia[n].stream);}),r})(e);try{if(t){const{stream:n}=e.streams.userMedia[t];Ht(e,n)?$t.stopReplacedStream(e,n,r):$t.stopAddedStream(e,n,!1,r);}else $t.stopAddedStreams(e,o.addedStreams,!1,r),$t.stopReplacedStreams(e,o.replacedStreams,!1,r);return $t.initRefreshConnectionAndResolve(e.room,r,n,s)}catch(e){Ys.log.DEBUG([i.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA],e),s(Lt.MEDIA_STREAM.ERRORS.STOP_USER_MEDIA);}}),stopAddedStream:(e,t,r=!1,n=!1)=>{const{room:s,user:i}=e;try{$t.tryStopStream(t,i.sid),n||($t.removeTracks(s,t),$t.updateMediaInfoMediaState(s,t),$t.deleteStreamFromState(s,t,r),$t.listenForEventAndDeleteMediaInfo(s,t),$t.dispatchOnLocalStreamEnded(s,t,r),r&&new ci(e).deleteScreensharingInstance(s));}catch(e){Ys.log.ERROR([i.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.STOP_ADDED_STREAM],e);}},tryStopStream:(e,t)=>{if(e){try{Wt(e.getAudioTracks());}catch(r){Ys.log.ERROR([t,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.ERRORS.STOP_AUDIO_TRACK} - stream id: ${e.id}`],r);}try{Wt(e.getVideoTracks());}catch(r){Ys.log.ERROR([t,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.ERRORS.STOP_VIDEO_TRACK} - stream id: ${e.id}`],r);}}},removeTracks:(e,t)=>{const r=Xi.getSkylinkState(e.id),{peerConnections:n,user:s}=r,i=t.getTracks();try{i.forEach(e=>{((e,t,r)=>{const n=r.id,s=Object.keys(t);for(let r=0;r<s.length;r+=1)try{const i=s[r],o=t[i];if(o.connectionState===Ye.CLOSED)break;const a=o.getSenders();let c=null;for(let t=0;t<a.length;t+=1)a[t].track&&a[t].track.id===n&&(c=a[t],o.removeTrack(c),Kt(e,i,c));}catch(e){Ys.log.ERROR([s[r],Ct.PEER_CONNECTION,null,Lt.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e);}})(r,n,e);});}catch(e){Ys.log.ERROR([s.sid,Ct.PEER_CONNECTION,null,Lt.PEER_CONNECTION.ERRORS.REMOVE_TRACK],e);}},listenForEventAndDeleteMediaInfo:(e,t)=>{const r=Xi.getSkylinkState(e.id),n=n=>{const s=t,{user:i}=r,{detail:o}=n;if(o.state===et.OFFER){const t=Jn.retrieveMediaId(ws(s)?Ot.AUDIO:Ot.VIDEO,s.id);Jn.deleteUnavailableMedia(e,i.sid,t);}},s=()=>{Fs(bt.HANDSHAKE_PROGRESS,n),Fs(bt.MEDIA_INFO_DELETED,s);};Bs(bt.HANDSHAKE_PROGRESS,n),Bs(bt.MEDIA_INFO_DELETED,s);},stopAddedStreams:(e,t,r,n)=>{t.forEach(t=>{$t.stopAddedStream(e,t,r,n);});},updateMediaInfoMediaState:(e,t)=>{const r=Xi.getSkylinkState(e.id),{user:n}=r,s=t.id,i=Jn.retrieveMediaId(t.getTracks()[0].kind,s);Jn.setMediaStateToUnavailable(e,n.sid,i);},deleteStreamFromState:(e,t,r=null)=>{const n=Xi.getSkylinkState(e.id),{user:s}=n,i=t.id;r?(delete n.streams.screenshare,delete n.streamsMediaStatus[t.id],delete n.streamsMutedSettings[t.id],n.streams.screenshare=null,Ys.log.INFO([s.sid,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id} (screenshare)`])):(delete n.streams.userMedia[i],delete n.streamsMediaStatus[t.id],delete n.streamsMutedSettings[t.id],us(n.streams.userMedia)&&(n.streams.userMedia=null),Ys.log.INFO([s.sid,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.STOP_SUCCESS} - stream id: ${t.id}`])),Xi.setSkylinkState(n,n.room.id);},dispatchOnLocalStreamEnded:(e,t,r=!1)=>{const n=Xi.getSkylinkState(e.id),{MEDIA_STREAM:s}=Lt,{user:i}=n;Ys.log.INFO([i.sid,Ct.MEDIA_STREAM,null,s.STOP_SETTINGS],{peerId:i.sid,isSelf:!0,isScreensharing:r,stream:t}),Vs(Ee({room:e,peerId:i.sid,peerInfo:Qt.getCurrentSessionInfo(e),isSelf:!0,isScreensharing:r,streamId:t.id,isVideo:bs(t),isAudio:ws(t)})),Vs(((e={})=>new pe("mediaAccessStopped",{detail:e}))({isScreensharing:r,streamId:t.id})),Vs(ve({peerId:i.sid,peerInfo:Xt.getCurrentSessionInfo(e),isSelf:!0}));},prepStopScreenStream:(e,t,r=!1)=>new Promise((t,n)=>{const s=Xi.getSkylinkState(e.id),{user:i,streams:o}=s,a=o.screenshare.stream;try{((e,t)=>{const{streams:r}=e;return !!r.userMedia&&Object.values(r.userMedia).some(e=>e.isReplaced&&e.id===t.id)})(s,a)?$t.stopReplacedStream(s,a,!0,r):$t.stopAddedStream(s,a,!0,r),$t.initRefreshConnectionAndResolve(s.room,r,t,n);}catch(e){Ys.log.DEBUG([i.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.STOP_SCREEN],e),n(new Error(Lt.MEDIA_STREAM.ERRORS.STOP_SCREEN));}}),initRefreshConnectionAndResolve:(e,t,r,n)=>{const s=Xi.getSkylinkState(e.id),{peerConnections:i}=s;try{if(!t){if(Ss(Object.keys(i)))return (e=>{const{room:t,user:r}=e;Vs(ve({peerId:r.sid,isSelf:!0,peerInfo:Qt.getCurrentSessionInfo(t)}));})(s),Jn.deleteUnavailableMedia(s.room,s.user.sid),r();{const e=e=>{const{detail:t}=e;if(t.state===et.ANSWER_ACK)return r()};Bs(bt.HANDSHAKE_PROGRESS,e),oi.refreshConnection(s);}}}catch(e){n(e);}},stopReplacedStream:(e,t,r,n)=>{const{user:s,room:i}=e;try{$t.tryStopStream(t),n||(((e,t)=>{const{room:r,user:n}=e;(new zn).stream(r.id,n,t,gt.REPLACED_STREAM_ENDED,null);})(e,t),$t.deleteStreamFromState(i,t,r),$t.dispatchOnLocalStreamEnded(i,t));}catch(e){Ys.log.ERROR([s.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.STOP_REPLACED_STREAM],e);}},stopReplacedStreams:(e,t,r,n)=>{t.forEach(t=>{$t.stopReplacedStream(e,t,r,n);});}};class zt{static getUserMedia(e,t={}){const{room:r}=e,n=ps.parseMediaOptions(t,e),{audio:s,video:i}=t,o=!!t.useExactConstraints;return Xi.setSkylinkState(n,r.id),ps.prepMediaAccessRequest({useExactConstraints:o,audio:s,video:i,roomKey:r.id})}static getUserMediaLayer(e,t=null){return new Promise((r,n)=>{let s={audio:!0,video:!0};t||Ys.log.WARN([e.user.sid,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.NO_OPTIONS} - ${Lt.MEDIA_STREAM.DEFAULT_OPTIONS}`],s),hs(t)||(Ys.log.ERROR([e.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS],t),n(new Error(Lt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),null)),s=t,zt.getUserMedia(e,s).then(e=>{r(e);}).catch(e=>{n(e);});})}static stopStreams(e,t){return $t.prepStopStreams(e.room.id,t)}static addLocalMediaStreams(e,t){ps.addLocalMediaStreams(e,t);}static onRemoteTrackAdded(e,t,r,n,s,i){ps.onRemoteTrackAdded(e,t,r,n,s,i);}static muteStreams(e,t,r){return ps.muteStreams(e,t,r)}static sendStream(e,t){return ps.sendStream(e,t)}static getStreamSources(){return ps.getStreamSources()}static getScreenSources(){return ps.getScreenSources()}static updateRemoteStreams(e,t,r){return ps.updateRemoteStreams(e,t,r)}static getStreams(e){return ps.getStreams(e)}static usePrefetchedStream(e,t,r=null){return new Promise(n=>{!t&&r.id&&r.active&&(t=r);const s={audio:0!==t.getAudioTracks().length,video:0!==t.getVideoTracks().length},i=ps.parseStreamSettings(s,Ot.AUDIO),o=ps.parseStreamSettings(s,Ot.VIDEO);return ps.onStreamAccessSuccess(e,t,i,o,!1,n)})}}const Yt=e=>!us(e),Jt=(e,t)=>{const{streams:r}=e,n={};n.settings={audio:!1,video:!1,data:!1,bandwidth:Ut(e.streamsBandwidthSettings.bAS),googleXBandwidth:Ut(e.streamsBandwidthSettings.googleX)};const s=e.hasMCU?Nt.MCU:t;if(e.peerConnections[s].signalingState!==Ye.CLOSED){const t=Xi.getInitOptions(),i=Qt.getPeerInfo(s,e.room);n.settings=Ut(i.settings),n.settings.data=t.enableDataChannel&&e.peerInformations[s].config.enableDataChannel,r.userMedia||r.screenshare;}if(e.peerCustomConfigs[s]){if(Object.hasOwnProperty.call(e.peerCustomConfigs[s],"bandwidth")){const t=e.peerCustomConfigs[s].bandwidth;hs(t)&&(ms(t.audio)&&(n.settings.bandwidth.audio=t.audio),ms(t.video)&&(n.settings.bandwidth.video=t.video),ms(t.data)&&(n.settings.bandwidth.data=t.data));}if(Object.hasOwnProperty.call(e.peerCustomConfigs[s],"googleXBandwidth")){const t=e.peerCustomConfigs[s].googleXBandwidth;hs(t)&&(ms(t.min)&&(n.settings.googleXBandwidth.min=t.min),ms(t.max)&&(n.settings.googleXBandwidth.max=t.max));}}return n},Xt={getPeerInfo:(e,t)=>{let r=null;if(!e)return null;const n=Xi.getSkylinkState(t.id);return n?((e,t)=>{const{user:r}=t;return e===r.sid})(e,n)?Qt.getCurrentSessionInfo(t):(r=Ut(n.peerInformations[e]))?(r.room=Ut(t.roomName),r.settings.data=!!(n.dataChannels[e]&&n.dataChannels[e].main&&n.dataChannels[e].main.channel&&n.dataChannels[e].main.channel.readyState===Be.OPEN),r.connected=n.peerConnStatus[e]&&!!n.peerConnStatus[e].connected,r.init=n.peerConnStatus[e]&&!!n.peerConnStatus[e].init,e===Nt.MCU?(r.config.receiveOnly=!0,r.config.publishOnly=!1):n.hasMCU&&(r.config.receiveOnly=!1,r.config.publishOnly=!0),r.settings.audio||r.settings.video||(r.config.receiveOnly=!0,r.config.publishOnly=!1),r):(Ys.log.ERROR(`${Lt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`),r):(Xi.logNoRoomState(t.id),r)},getCurrentSessionInfo:e=>{const t=Xi.getSkylinkState(e.id),r=Xi.getInitOptions(),{AdapterJS:n}=window,{enableDataChannel:s,codecParams:i}=r,{roomName:o}=e,{streamsMediaStatus:a,userData:c,peerPriorityWeight:d,enableIceRestart:l,publishOnly:p,SMProtocolVersion:u,DTProtocolVersion:S,streams:E,streamsBandwidthSettings:h,sdpSettings:g,user:m}=t,f={userData:c,settings:{audio:!1,video:!1},mediaStatus:{},agent:{name:n.webrtcDetectedBrowser,version:n.webrtcDetectedVersion,os:window.navigator.platform,pluginVersion:n.WebRTCPlugin.plugin?n.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:u,DTProtocolVersion:S,SDKVersion:"2.0.0"},room:o,config:{enableDataChannel:s,enableIceRestart:l,priorityWeight:d,receiveOnly:!1,publishOnly:p},sid:m.sid,screenshare:!1};if(E&&E.userMedia){const e=Object.keys(E.userMedia);E.userMedia[e[0]]&&(f.settings=Ut(E.userMedia[e[0]].settings));}return f.mediaStatus=a,f.userData=c||null,f.config.receiveOnly=!f.settings.video&&!f.settings.audio,E.screenshare&&(f.screenshare=!0),f.settings.maxBandwidth=Ut(h.bAS),f.settings.googleXBandwidth=Ut(h.googleX),f.settings.bandwidth&&(f.settings.maxBandwidth=Ut(f.settings.bandwidth),delete f.settings.bandwidth),f.settings.data=s&&g.connection.data,f.settings.audio&&hs(f.settings.audio)&&(Rs(typeof i.audio.opus.stereo)&&(f.settings.audio.stereo=i.audio.opus.stereo),Rs(i.audio.opus.usedtx)&&(f.settings.audio.usedtx=i.audio.opus.usedtx),ms(i.audio.opus.maxplaybackrate)&&(f.settings.audio.maxplaybackrate=i.audio.opus.maxplaybackrate),Rs(i.audio.opus.useinbandfec)&&(f.settings.audio.useinbandfec=i.audio.opus.useinbandfec)),f.settings.video&&hs(f.settings.video)&&(f.settings.video.customSettings={},f.settings.video.frameRate&&hs(f.settings.video.frameRate)&&(f.settings.video.customSettings.frameRate=Ut(f.settings.video.frameRate),f.settings.video.frameRate=-1),f.settings.video.facingMode&&hs(f.settings.video.facingMode)&&(f.settings.video.customSettings.facingMode=Ut(f.settings.video.facingMode),f.settings.video.facingMode="-1"),f.settings.video.resolution&&hs(f.settings.video.resolution)&&(f.settings.video.resolution.width&&hs(f.settings.video.resolution.width)&&(f.settings.video.customSettings.width=Ut(f.settings.video.width),f.settings.video.resolution.width=-1),f.settings.video.resolution.height&&hs(f.settings.video.resolution.height)&&(f.settings.video.customSettings.height=Ut(f.settings.video.height),f.settings.video.resolution.height=-1))),f.settings.audio||f.settings.video||(f.config.receiveOnly=!0,f.config.publishOnly=!1),Ut(f)},getUserInfo:jt,getUserData:(e,t)=>{if(t&&e.peerInformations[t]){let r=e.peerInformations[t].userData;return r||(r=""),r}return e.userData},setUserData:(e,t)=>{const r=Xi.getSkylinkState(e.id),{PEER_INFORMATIONS:{UPDATE_USER_DATA:n}}=Lt,s=t||"";r.userData=s,Xi.setSkylinkState(r,r.room.id),(new zn).setUserData(r),Vs(ve({peerId:r.user.sid,peerInfo:Xt.getCurrentSessionInfo(e),isSelf:!0})),Ys.log.INFO(n,s);},getPeersStreams:(e,t=!0)=>{const r={},{peerConnections:n,user:s,streams:i,hasMCU:o}=e;if(s&&s.sid&&t){const e=(e=>e.userMedia?e.userMedia:null)(i),t=(e=>e.screenshare?e.screenshare:null)(i);r[s.sid]=e||t?{}:null,e&&Object.keys(e).forEach(t=>{r[s.sid].isSelf=!0,r[s.sid][t]=e[t].stream;}),t&&(r[s.sid].isSelf=!0,r[s.sid][t.id]=t);}if(((e,t)=>t?!!e.MCU.maps:!us(e))(n,o)){const t=o?Object.keys(n.MCU.maps):Object.keys(n);for(let n=0;n<t.length;n+=1){r[t[n]]={},zt.retrieveRemoteStreams(e,t[n]).forEach(e=>{r[t[n]][e.id]=e;});}}return us(r)?null:r},getPeersDataChannels:e=>{const{dataChannels:t}=e,r={},n=Object.keys(t);for(let e=0;e<n.length;e+=1){const s=n[e];if(r[s]={},Yt(t)){const e=Object.keys(t[s]);for(let n=0;n<e.length;n+=1){const i=t[s][e[n]],{channelName:o,channelType:a,transferId:c,streamId:d}=i;let l=null;(l=oi.getDataChannelBuffer(i)).channelProp=e[n],l.channelName=o,l.channelType=a,l.currentTransferId=c,l.currentStreamId=d,l.readyState=i.channel?i.channel.readyState:Be.CREATE_ERROR,r[s][o]=l;}}}return r},getPeersCustomSettings:e=>{const{peerInformations:t}=e,r={};if((e=>!us(e))(t)){const n=Object.keys(t);for(let t=0;t<n.length;t+=1)r[n[t]]=Jt(e,n[t]);return r}return r},setGreatestPeerPriorityWeight:e=>{const t=Xi.getSkylinkState(e.room.id),{peerInformations:r}=t,n=Object.entries(r);let s=t.peerPriorityWeight;for(let e=0;e<n.length;e+=1){const r=n[e][1],{config:{priorityWeight:i}}=r;i>s&&(s=i,t.peerPriorityWeight=s+1);}Xi.setSkylinkState(t,t.room.id),Ys.log.DEBUG(`User's priorityWeight is set to ${s}`);}};class Qt{static getPeerInfo(e,t){return Xt.getPeerInfo(e,t)}static getCurrentSessionInfo(e){return Xt.getCurrentSessionInfo(e)}static getUserInfo(e){return Xt.getUserInfo(e)}static getUserData(e,t){return Xt.getUserData(e,t)}static setUserData(e,t){Xt.setUserData(e,t);}static getPeersStreams(e,t){return Xt.getPeersStreams(e,t)}static getPeersDataChannels(e){return Xt.getPeersDataChannels(e)}static getPeersCustomSettings(e){return Xt.getPeersCustomSettings(e)}static setGreatestPeerPriorityWeight(e){return Xt.setGreatestPeerPriorityWeight(e)}}const qt=(e,t)=>{const r=Xi.getSkylinkState(e)||Object.values(Xi.getSkylinkState())[0],{socketSession:n,inRoom:s,room:i,user:o}=r;Ys.log.INFO([null,"Socket",null,`Channel closed. Reason - ${t}`]),r.channelOpen=!1,Xi.setSkylinkState(r,e),Vs((e=>new pe("channelClose",{detail:e}))({socketSession:Ut(n)})),s&&o&&o.sid&&Vs(((e={})=>new pe("sessionDisconnect",{detail:e}))({peerId:o.sid,peerInfo:Qt.getCurrentSessionInfo(i)}));},Zt={apiBase:"https://api.temasys.io",stats:{endPoints:{client:"/client",session:"/session",auth:"/auth",signaling:"/signaling",iceConnection:"/client/iceconnection",iceCandidate:"/client/icecandidate",iceGathering:"/client/icegathering",negotiation:"/client/negotiation",bandwidth:"/client/bandwidth",recording:"/client/recording",dataChannel:"/client/datachannel"}}};Zt.stats.statsBase=`${Zt.apiBase}/rest/stats`;class er{constructor(){this.endpoints=Zt.stats.endPoints,this.stats_buffer={},this.bufferTimeout=!1;}postStats(e,t){const{STATS_MODULE:r}=Lt,{fetch:n}=window;try{if(!t.client_id)return;const r=Xi.getInitOptions(),{enableStatsGathering:s}=r;s&&n(`${Zt.stats.statsBase}${e}`,{method:"POST",mode:"cors",headers:{"Content-type":"application/json"},body:JSON.stringify(t)});}catch(e){Ys.log.WARN(r.ERRORS.POST_FAILED,e);}}addToStatsBuffer(e,t,r){this.stats_buffer[e]||(this.stats_buffer[e]={},this.stats_buffer[e].url=r,this.stats_buffer[e].data=[]);const n=Object.assign({},t);this.stats_buffer[e].data.push(n);}manageStatsBuffer(){this.bufferTimeout||(this.bufferTimeout=!0,setInterval(()=>{const e=Object.keys(this.stats_buffer);for(let t=0;t<e.length;t+=1)this.stats_buffer[e[t]].data.length>0&&(this.postStats(this.stats_buffer[e[t]].url,this.stats_buffer[e[t]].data),this.stats_buffer[e[t]].data=[]);},5e3));}}class tr extends er{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,signaling_url:null,signaling_transport:null,attempts:null,error:null};}send(e,t,r){const n=Xi.getSkylinkState(e),{socketSession:s}=n;this.model.room_id=e,this.model.user_id=n&&n.user&&n.user.sid||null,this.model.client_id=n.clientId,this.model.state=t,this.model.signaling_url=n.socketSession.socketServer,this.model.signaling_transport=n.socketSession.socketType.toLowerCase(),this.model.attempts=0===s.socketSession.finalAttempts?s.socketSession.attempts:2*s.socketSession.finalAttempts+s.socketSession.attempts,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.attempts="number"==typeof r?r:null,this.model.error=("string"==typeof r?r:r&&r.message)||null,this.postStats(this.endpoints.signaling,this.model);}}const rr={onConnection:(e,t)=>{const r=Xi.getSkylinkState(t),{socketSession:n}=r;(new tr).send(t,wt.SIGNALING.CONNECT,null),r.channelOpen||(r.channelOpen=!0,Xi.setSkylinkState(r,t)),0!==n.socketSession.finalAttempts||0!==n.socketSession.attempts?(Vs((e=>new pe("channelReopen",{detail:e}))({socketSession:Ut(n)})),(new tr).send(t,wt.SIGNALING.RECONNECT_SUCCESS)):Vs((e=>new pe("channelOpen",{detail:e}))({socketSession:Ut(n)})),e();},onDisconnect:(e,t)=>{const r=Xi.getSkylinkState(e)||Object.values(Xi.getSkylinkState())[0],n=r.channelOpen,{room:s}=r;(new tr).send(s.id,wt.SIGNALING.DISCONNECT,null),(n||!n&&e!==s.roomName)&&dr(s.id,t);},onError:(e,t)=>{const r=Xi.getSkylinkState(e),{socketSession:n}=r;(new tr).send(e,wt.SIGNALING.ERROR,t),Ys.log.ERROR([null,"Socket",null,"Exception occurred ->"],t),Vs((e=>new pe("channelError",{detail:e}))({error:t,socketSession:Ut(n)}));},onReconnectAttempt:(e,t)=>{const r=Xi.getSkylinkState(e),{socketSession:n}=r;let s=0;(new zn).updateAttempts(e,"attempts",t),s=0===n.socketSession.finalAttempts?t:2*n.socketSession.finalAttempts+n.socketSession.attempts,(new tr).send(e,wt.SIGNALING.RECONNECT_ATTEMPT,s),Vs((e=>new pe("channelRetry",{detail:e}))({fallbackType:n.fallbackType,currentAttempt:s,session:Ut(Xi.getSkylinkState(e).socketSession)}));},onReconnectFailed:(e,t,r)=>{const n=Xi.getSkylinkState(r),{socketSession:s}=n,i=new zn;s.socketSession.attempts===Ft.RECONNECTION_ATTEMPTS.WEBSOCKET&&s.socketSession.finalAttempts<Ft.RECONNECTION_FINAL_ATTEMPTS&&!s.socketTimeout?(i.socket.connect(),i.updateAttempts(r,"attempts",s.socketSession.attempts===Ft.RECONNECTION_ATTEMPTS.WEBSOCKET?0:s.socketSession.attempts+=1),i.updateAttempts(r,"finalAttempts",s.socketSession.finalAttempts+=1)):((new tr).send(r,wt.SIGNALING.RECONNECT_FAILED,Lt.INIT.ERRORS.SOCKET_ERROR_ABORT),Vs(ke({session:Ut(s),errorCode:ot.RECONNECTION_ABORTED,type:s.fallbackType,error:new Error(Lt.INIT.ERRORS.SOCKET_ERROR_ABORT)})),t(new Error(Lt.INIT.ERRORS.SOCKET_ERROR_ABORT)));},onReconnectError:(e,t)=>{const r=Xi.getSkylinkState(e),{socketSession:n}=r;(new tr).send(e,wt.SIGNALING.RECONNECT_ERROR,t),!n.socketTimeout&&t&&"timeout"===t&&(Ys.log.ERROR([null,"Socket",null,`${n.socketType} connection timed out.`]),n.socketTimeout=!0,Xi.setSkylinkState(r,e));}},nr=e=>Rs(e)&&e,sr=(e,t)=>{const r=Xi.getSkylinkState(e),{detail:n}=t;if(n.state===et.ENTER){const e=Ut(r.socketMessageQueue);r.user.bufferMessage=!1,r.socketMessageQueue=[],Xi.setSkylinkState(r,r.room.id),Ys.log.DEBUG([r.user.sid,Ct.SIG_SERVER,null,`${Lt.SIGNALING.BUFFERED_MESSAGES_SENT}: ${e.length}`]),((e,t)=>{const r=new zn;for(let n=t.length-1;n>=0;n-=1){const s=t[n];if(!s.mid){if(!e.user.sid)return void Ys.log.DEBUG([e.user.sid,Ct.SIG_SERVER,null,`${Lt.SIGNALING.BUFFERED_MESSAGES_DROPPED}`]);s.mid=e.user.sid;}r.sendMessage(s),t.splice(n,1);}})(r,e),xs.removeEventListener(bt.HANDSHAKE_PROGRESS,sr);}},ir=e=>{const{rid:t}=e,r=Xi.getSkylinkState(t),{user:n,room:s}=r;return !gs(n.bufferMessage)&&!nr(n.bufferMessage)||(e=>{const{JOIN_ROOM:t,ENTER:r,WELCOME:n,OFFER:s,ANSWER:i,ANSWER_ACK:o,CANDIDATE:a,END_OF_CANDIDATES:c}=ht;return [t,r,n,s,i,o,a,c].indexOf(e.type)>-1})(e)?(e.type===et.ENTER&&gs(n.bufferMessage)&&(Ys.log.DEBUG([n.sid,Ct.SIG_SERVER,null,Lt.SIGNALING.BUFFER_NOT_NEEDED]),r.user.bufferMessage=!1,r.socketMessageQueue=[],Xi.setSkylinkState(r,r.room.id)),!1):(Ys.log.DEBUG([n.sid,Ct.SIG_SERVER,null,Lt.SIGNALING.MESSAGE_ADDED_TO_BUFFER]),r.socketMessageQueue.unshift(e),nr(n.bufferMessage)||(r.user.bufferMessage=!0,Ys.log.DEBUG([n.sid,Ct.SIG_SERVER,null,Lt.SIGNALING.ENTER_LISTENER]),xs.addEventListener(bt.HANDSHAKE_PROGRESS,sr.bind(void 0,t))),Xi.setSkylinkState(r,s.id),!0)},or=e=>Vt(e),ar=(...e)=>{((e,t)=>{const{type:r}=t;switch(Ys.log.INFO(["SIG SERVER",null,r,"received"]),r){case ht.IN_ROOM:e.inRoomHandler(t);break;case ht.ENTER:e.enterRoomHandler(t);break;case ht.OFFER:e.offerHandler(t);break;case ht.WELCOME:e.welcomeHandler(t);break;case ht.ANSWER:e.answerHandler(t);break;case ht.ANSWER_ACK:e.answerAckHandler(t);break;case ht.CANDIDATE:e.candidateHandler(t);break;case ht.PEER_LIST:e.getPeerListHandler(t);break;case ht.INTRODUCE_ERROR:e.introduceError(t);break;case ht.BYE:e.byeHandler(t);break;case ht.STREAM:e.streamHandler(t);break;case ht.RECORDING:e.recordingHandler(t);break;case ht.REDIRECT:e.redirectHandler(t);break;case ht.RTMP:e.rtmpHandler(t);break;case ht.UPDATE_USER:e.setUserDataHandler(t);break;case ht.MEDIA_INFO_EVENT:e.mediaInfoEventHandler(t);break;case ht.MESSAGE:e.userMessageHandler(t,null);break;case ht.STORED_MESSAGES:e.storedMessagesHandler(t);break;case ht.MUTE_AUDIO_EVENT:e.muteAudioEventHandler(t);break;case ht.MUTE_VIDEO_EVENT:e.muteVideoEventHandler(t);break;case ht.PUBLIC_MESSAGE:e.userMessageHandler(t,!0);break;case ht.PRIVATE_MESSAGE:e.userMessageHandler(t,!1);}})(...e);},cr=(e,t)=>{e.send(JSON.stringify(t));},dr=(...e)=>{qt(...e);},lr=(...e)=>{((e,t,r,n)=>{t.socket.on(Pt.CONNECT,rr.onConnection.bind(t,r,e)),t.socket.on(Pt.MESSAGE,t.onMessage.bind(t)),t.socket.on(Pt.DISCONNECT,rr.onDisconnect.bind(t,e)),t.socket.on(Pt.ERROR,rr.onError.bind(t,e)),t.socket.on(Pt.RECONNECT_ATTEMPT,rr.onReconnectAttempt.bind(t,e)),t.socket.on(Pt.RECONNECT_ERROR,rr.onReconnectError.bind(t,e)),t.socket.on(Pt.RECONNECT_FAILED,rr.onReconnectFailed.bind(t,r,n,e));})(...e);},pr=(...e)=>ir(...e);var ur=A((function(e,t){var r;e.exports=(r=r||function(e,t){var r=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),n={},s=n.lib={},i=s.Base={extend:function(e){var t=r(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments);}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString);},clone:function(){return this.init.prototype.extend(this)}},o=s.WordArray=i.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:4*e.length;},toString:function(e){return (e||c).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,s=e.sigBytes;if(this.clamp(),n%4)for(var i=0;i<s;i++){var o=r[i>>>2]>>>24-i%4*8&255;t[n+i>>>2]|=o<<24-(n+i)%4*8;}else for(i=0;i<s;i+=4)t[n+i>>>2]=r[i>>>2];return this.sigBytes+=s,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4);},clone:function(){var e=i.clone.call(this);return e.words=this.words.slice(0),e},random:function(t){for(var r,n=[],s=function(t){t=t;var r=987654321,n=4294967295;return function(){var s=((r=36969*(65535&r)+(r>>16)&n)<<16)+(t=18e3*(65535&t)+(t>>16)&n)&n;return s/=4294967296,(s+=.5)*(e.random()>.5?1:-1)}},i=0;i<t;i+=4){var a=s(4294967296*(r||e.random()));r=987654071*a(),n.push(4294967296*a()|0);}return new o.init(n,t)}}),a=n.enc={},c=a.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s++){var i=t[s>>>2]>>>24-s%4*8&255;n.push((i>>>4).toString(16)),n.push((15&i).toString(16));}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new o.init(r,t/2)}},d=a.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s++){var i=t[s>>>2]>>>24-s%4*8&255;n.push(String.fromCharCode(i));}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new o.init(r,t)}},l=a.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},p=s.BufferedBlockAlgorithm=i.extend({reset:function(){this._data=new o.init,this._nDataBytes=0;},_append:function(e){"string"==typeof e&&(e=l.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes;},_process:function(t){var r=this._data,n=r.words,s=r.sigBytes,i=this.blockSize,a=s/(4*i),c=(a=t?e.ceil(a):e.max((0|a)-this._minBufferSize,0))*i,d=e.min(4*c,s);if(c){for(var l=0;l<c;l+=i)this._doProcessBlock(n,l);var p=n.splice(0,c);r.sigBytes-=d;}return new o.init(p,d)},clone:function(){var e=i.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0}),u=(s.Hasher=p.extend({cfg:i.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset();},reset:function(){p.reset.call(this),this._doReset();},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new u.HMAC.init(e,r).finalize(t)}}}),n.algo={});return n}(Math),r);})),Sr=(A((function(e,t){var r,n,s,i,o,a;e.exports=(n=(r=a=ur).lib,s=n.Base,i=n.WordArray,(o=r.x64={}).Word=s.extend({init:function(e,t){this.high=e,this.low=t;}}),o.WordArray=s.extend({init:function(e,t){e=this.words=e||[],this.sigBytes=null!=t?t:8*e.length;},toX32:function(){for(var e=this.words,t=e.length,r=[],n=0;n<t;n++){var s=e[n];r.push(s.high),r.push(s.low);}return i.create(r,this.sigBytes)},clone:function(){for(var e=s.clone.call(this),t=e.words=this.words.slice(0),r=t.length,n=0;n<r;n++)t[n]=t[n].clone();return e}}),a);})),A((function(e,t){var r;e.exports=(r=ur,function(){if("function"==typeof ArrayBuffer){var e=r.lib.WordArray,t=e.init;(e.init=function(e){if(e instanceof ArrayBuffer&&(e=new Uint8Array(e)),(e instanceof Int8Array||"undefined"!=typeof Uint8ClampedArray&&e instanceof Uint8ClampedArray||e instanceof Int16Array||e instanceof Uint16Array||e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array||e instanceof Float64Array)&&(e=new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),e instanceof Uint8Array){for(var r=e.byteLength,n=[],s=0;s<r;s++)n[s>>>2]|=e[s]<<24-s%4*8;t.call(this,n,r);}else t.apply(this,arguments);}).prototype=e;}}(),r.lib.WordArray);})),A((function(e,t){var r;e.exports=(r=ur,function(){var e=r,t=e.lib.WordArray,n=e.enc;function s(e){return e<<8&4278255360|e>>>8&16711935}n.Utf16=n.Utf16BE={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],s=0;s<r;s+=2){var i=t[s>>>2]>>>16-s%4*8&65535;n.push(String.fromCharCode(i));}return n.join("")},parse:function(e){for(var r=e.length,n=[],s=0;s<r;s++)n[s>>>1]|=e.charCodeAt(s)<<16-s%2*16;return t.create(n,2*r)}},n.Utf16LE={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i+=2){var o=s(t[i>>>2]>>>16-i%4*8&65535);n.push(String.fromCharCode(o));}return n.join("")},parse:function(e){for(var r=e.length,n=[],i=0;i<r;i++)n[i>>>1]|=s(e.charCodeAt(i)<<16-i%2*16);return t.create(n,2*r)}};}(),r.enc.Utf16);})),A((function(e,t){var r,n,s;e.exports=(n=(r=s=ur).lib.WordArray,r.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var s=[],i=0;i<r;i+=3)for(var o=(t[i>>>2]>>>24-i%4*8&255)<<16|(t[i+1>>>2]>>>24-(i+1)%4*8&255)<<8|t[i+2>>>2]>>>24-(i+2)%4*8&255,a=0;a<4&&i+.75*a<r;a++)s.push(n.charAt(o>>>6*(3-a)&63));var c=n.charAt(64);if(c)for(;s.length%4;)s.push(c);return s.join("")},parse:function(e){var t=e.length,r=this._map,s=this._reverseMap;if(!s){s=this._reverseMap=[];for(var i=0;i<r.length;i++)s[r.charCodeAt(i)]=i;}var o=r.charAt(64);if(o){var a=e.indexOf(o);-1!==a&&(t=a);}return function(e,t,r){for(var s=[],i=0,o=0;o<t;o++)if(o%4){var a=r[e.charCodeAt(o-1)]<<o%4*2,c=r[e.charCodeAt(o)]>>>6-o%4*2;s[i>>>2]|=(a|c)<<24-i%4*8,i++;}return n.create(s,i)}(e,t,s)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="},s.enc.Base64);})),A((function(e,t){var r;e.exports=(r=ur,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=[];!function(){for(var t=0;t<64;t++)a[t]=4294967296*e.abs(e.sin(t+1))|0;}();var c=o.MD5=i.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878]);},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var n=t+r,s=e[n];e[n]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8);}var i=this._hash.words,o=e[t+0],c=e[t+1],S=e[t+2],E=e[t+3],h=e[t+4],g=e[t+5],m=e[t+6],f=e[t+7],R=e[t+8],T=e[t+9],C=e[t+10],_=e[t+11],I=e[t+12],O=e[t+13],A=e[t+14],v=e[t+15],D=i[0],y=i[1],N=i[2],P=i[3];D=d(D,y,N,P,o,7,a[0]),P=d(P,D,y,N,c,12,a[1]),N=d(N,P,D,y,S,17,a[2]),y=d(y,N,P,D,E,22,a[3]),D=d(D,y,N,P,h,7,a[4]),P=d(P,D,y,N,g,12,a[5]),N=d(N,P,D,y,m,17,a[6]),y=d(y,N,P,D,f,22,a[7]),D=d(D,y,N,P,R,7,a[8]),P=d(P,D,y,N,T,12,a[9]),N=d(N,P,D,y,C,17,a[10]),y=d(y,N,P,D,_,22,a[11]),D=d(D,y,N,P,I,7,a[12]),P=d(P,D,y,N,O,12,a[13]),N=d(N,P,D,y,A,17,a[14]),D=l(D,y=d(y,N,P,D,v,22,a[15]),N,P,c,5,a[16]),P=l(P,D,y,N,m,9,a[17]),N=l(N,P,D,y,_,14,a[18]),y=l(y,N,P,D,o,20,a[19]),D=l(D,y,N,P,g,5,a[20]),P=l(P,D,y,N,C,9,a[21]),N=l(N,P,D,y,v,14,a[22]),y=l(y,N,P,D,h,20,a[23]),D=l(D,y,N,P,T,5,a[24]),P=l(P,D,y,N,A,9,a[25]),N=l(N,P,D,y,E,14,a[26]),y=l(y,N,P,D,R,20,a[27]),D=l(D,y,N,P,O,5,a[28]),P=l(P,D,y,N,S,9,a[29]),N=l(N,P,D,y,f,14,a[30]),D=p(D,y=l(y,N,P,D,I,20,a[31]),N,P,g,4,a[32]),P=p(P,D,y,N,R,11,a[33]),N=p(N,P,D,y,_,16,a[34]),y=p(y,N,P,D,A,23,a[35]),D=p(D,y,N,P,c,4,a[36]),P=p(P,D,y,N,h,11,a[37]),N=p(N,P,D,y,f,16,a[38]),y=p(y,N,P,D,C,23,a[39]),D=p(D,y,N,P,O,4,a[40]),P=p(P,D,y,N,o,11,a[41]),N=p(N,P,D,y,E,16,a[42]),y=p(y,N,P,D,m,23,a[43]),D=p(D,y,N,P,T,4,a[44]),P=p(P,D,y,N,I,11,a[45]),N=p(N,P,D,y,v,16,a[46]),D=u(D,y=p(y,N,P,D,S,23,a[47]),N,P,o,6,a[48]),P=u(P,D,y,N,f,10,a[49]),N=u(N,P,D,y,A,15,a[50]),y=u(y,N,P,D,g,21,a[51]),D=u(D,y,N,P,I,6,a[52]),P=u(P,D,y,N,E,10,a[53]),N=u(N,P,D,y,C,15,a[54]),y=u(y,N,P,D,c,21,a[55]),D=u(D,y,N,P,R,6,a[56]),P=u(P,D,y,N,v,10,a[57]),N=u(N,P,D,y,m,15,a[58]),y=u(y,N,P,D,O,21,a[59]),D=u(D,y,N,P,h,6,a[60]),P=u(P,D,y,N,_,10,a[61]),N=u(N,P,D,y,S,15,a[62]),y=u(y,N,P,D,T,21,a[63]),i[0]=i[0]+D|0,i[1]=i[1]+y|0,i[2]=i[2]+N|0,i[3]=i[3]+P|0;},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,s=8*t.sigBytes;r[s>>>5]|=128<<24-s%32;var i=e.floor(n/4294967296),o=n;r[15+(s+64>>>9<<4)]=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),r[14+(s+64>>>9<<4)]=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),t.sigBytes=4*(r.length+1),this._process();for(var a=this._hash,c=a.words,d=0;d<4;d++){var l=c[d];c[d]=16711935&(l<<8|l>>>24)|4278255360&(l<<24|l>>>8);}return a},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});function d(e,t,r,n,s,i,o){var a=e+(t&r|~t&n)+s+o;return (a<<i|a>>>32-i)+t}function l(e,t,r,n,s,i,o){var a=e+(t&n|r&~n)+s+o;return (a<<i|a>>>32-i)+t}function p(e,t,r,n,s,i,o){var a=e+(t^r^n)+s+o;return (a<<i|a>>>32-i)+t}function u(e,t,r,n,s,i,o){var a=e+(r^(t|~n))+s+o;return (a<<i|a>>>32-i)+t}t.MD5=i._createHelper(c),t.HmacMD5=i._createHmacHelper(c);}(Math),r.MD5);})),A((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=ur).lib,s=n.WordArray,i=n.Hasher,o=r.algo,a=[],c=o.SHA1=i.extend({_doReset:function(){this._hash=new s.init([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],c=r[4],d=0;d<80;d++){if(d<16)a[d]=0|e[t+d];else{var l=a[d-3]^a[d-8]^a[d-14]^a[d-16];a[d]=l<<1|l>>>31;}var p=(n<<5|n>>>27)+c+a[d];p+=d<20?1518500249+(s&i|~s&o):d<40?1859775393+(s^i^o):d<60?(s&i|s&o|i&o)-1894007588:(s^i^o)-899497514,c=o,o=i,i=s<<30|s>>>2,s=n,n=p;}r[0]=r[0]+n|0,r[1]=r[1]+s|0,r[2]=r[2]+i|0,r[3]=r[3]+o|0,r[4]=r[4]+c|0;},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=Math.floor(r/4294967296),t[15+(n+64>>>9<<4)]=r,e.sigBytes=4*t.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}}),r.SHA1=i._createHelper(c),r.HmacSHA1=i._createHmacHelper(c),d.SHA1);})),A((function(e,t){var r;e.exports=(r=ur,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=[],c=[];!function(){function t(t){for(var r=e.sqrt(t),n=2;n<=r;n++)if(!(t%n))return !1;return !0}function r(e){return 4294967296*(e-(0|e))|0}for(var n=2,s=0;s<64;)t(n)&&(s<8&&(a[s]=r(e.pow(n,.5))),c[s]=r(e.pow(n,1/3)),s++),n++;}();var d=[],l=o.SHA256=i.extend({_doReset:function(){this._hash=new s.init(a.slice(0));},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],a=r[4],l=r[5],p=r[6],u=r[7],S=0;S<64;S++){if(S<16)d[S]=0|e[t+S];else{var E=d[S-15],h=(E<<25|E>>>7)^(E<<14|E>>>18)^E>>>3,g=d[S-2],m=(g<<15|g>>>17)^(g<<13|g>>>19)^g>>>10;d[S]=h+d[S-7]+m+d[S-16];}var f=n&s^n&i^s&i,R=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),T=u+((a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25))+(a&l^~a&p)+c[S]+d[S];u=p,p=l,l=a,a=o+T|0,o=i,i=s,s=n,n=T+(R+f)|0;}r[0]=r[0]+n|0,r[1]=r[1]+s|0,r[2]=r[2]+i|0,r[3]=r[3]+o|0,r[4]=r[4]+a|0,r[5]=r[5]+l|0,r[6]=r[6]+p|0,r[7]=r[7]+u|0;},_doFinalize:function(){var t=this._data,r=t.words,n=8*this._nDataBytes,s=8*t.sigBytes;return r[s>>>5]|=128<<24-s%32,r[14+(s+64>>>9<<4)]=e.floor(n/4294967296),r[15+(s+64>>>9<<4)]=n,t.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});t.SHA256=i._createHelper(l),t.HmacSHA256=i._createHmacHelper(l);}(Math),r.SHA256);})),A((function(e,t){var r,n,s,i,o,a;e.exports=(n=(r=a=ur).lib.WordArray,s=r.algo,i=s.SHA256,o=s.SHA224=i.extend({_doReset:function(){this._hash=new n.init([3238371032,914150663,812702999,4144912697,4290775857,1750603025,1694076839,3204075428]);},_doFinalize:function(){var e=i._doFinalize.call(this);return e.sigBytes-=4,e}}),r.SHA224=i._createHelper(o),r.HmacSHA224=i._createHmacHelper(o),a.SHA224);})),A((function(e,t){var r;e.exports=(r=ur,function(){var e=r,t=e.lib.Hasher,n=e.x64,s=n.Word,i=n.WordArray,o=e.algo;function a(){return s.create.apply(s,arguments)}var c=[a(1116352408,3609767458),a(1899447441,602891725),a(3049323471,3964484399),a(3921009573,2173295548),a(961987163,4081628472),a(1508970993,3053834265),a(2453635748,2937671579),a(2870763221,3664609560),a(3624381080,2734883394),a(310598401,1164996542),a(607225278,1323610764),a(1426881987,3590304994),a(1925078388,4068182383),a(2162078206,991336113),a(2614888103,633803317),a(3248222580,3479774868),a(3835390401,2666613458),a(4022224774,944711139),a(264347078,2341262773),a(604807628,2007800933),a(770255983,1495990901),a(1249150122,1856431235),a(1555081692,3175218132),a(1996064986,2198950837),a(2554220882,3999719339),a(2821834349,766784016),a(2952996808,2566594879),a(3210313671,3203337956),a(3336571891,1034457026),a(3584528711,2466948901),a(113926993,3758326383),a(338241895,168717936),a(666307205,1188179964),a(773529912,1546045734),a(1294757372,1522805485),a(1396182291,2643833823),a(1695183700,2343527390),a(1986661051,1014477480),a(2177026350,1206759142),a(2456956037,344077627),a(2730485921,1290863460),a(2820302411,3158454273),a(3259730800,3505952657),a(3345764771,106217008),a(3516065817,3606008344),a(3600352804,1432725776),a(4094571909,1467031594),a(275423344,851169720),a(430227734,3100823752),a(506948616,1363258195),a(659060556,3750685593),a(883997877,3785050280),a(958139571,3318307427),a(1322822218,3812723403),a(1537002063,2003034995),a(1747873779,3602036899),a(1955562222,1575990012),a(2024104815,1125592928),a(2227730452,2716904306),a(2361852424,442776044),a(2428436474,593698344),a(2756734187,3733110249),a(3204031479,2999351573),a(3329325298,3815920427),a(3391569614,3928383900),a(3515267271,566280711),a(3940187606,3454069534),a(4118630271,4000239992),a(116418474,1914138554),a(174292421,2731055270),a(289380356,3203993006),a(460393269,320620315),a(685471733,587496836),a(852142971,1086792851),a(1017036298,365543100),a(1126000580,2618297676),a(1288033470,3409855158),a(1501505948,4234509866),a(1607167915,987167468),a(1816402316,1246189591)],d=[];!function(){for(var e=0;e<80;e++)d[e]=a();}();var l=o.SHA512=t.extend({_doReset:function(){this._hash=new i.init([new s.init(1779033703,4089235720),new s.init(3144134277,2227873595),new s.init(1013904242,4271175723),new s.init(2773480762,1595750129),new s.init(1359893119,2917565137),new s.init(2600822924,725511199),new s.init(528734635,4215389547),new s.init(1541459225,327033209)]);},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],s=r[1],i=r[2],o=r[3],a=r[4],l=r[5],p=r[6],u=r[7],S=n.high,E=n.low,h=s.high,g=s.low,m=i.high,f=i.low,R=o.high,T=o.low,C=a.high,_=a.low,I=l.high,O=l.low,A=p.high,v=p.low,D=u.high,y=u.low,N=S,P=E,M=h,w=g,b=m,k=f,L=R,U=T,G=C,x=_,B=I,F=O,V=A,j=v,H=D,W=y,K=0;K<80;K++){var $=d[K];if(K<16)var z=$.high=0|e[t+2*K],Y=$.low=0|e[t+2*K+1];else{var J=d[K-15],X=J.high,Q=J.low,q=(X>>>1|Q<<31)^(X>>>8|Q<<24)^X>>>7,Z=(Q>>>1|X<<31)^(Q>>>8|X<<24)^(Q>>>7|X<<25),ee=d[K-2],te=ee.high,re=ee.low,ne=(te>>>19|re<<13)^(te<<3|re>>>29)^te>>>6,se=(re>>>19|te<<13)^(re<<3|te>>>29)^(re>>>6|te<<26),ie=d[K-7],oe=ie.high,ae=ie.low,ce=d[K-16],de=ce.high,le=ce.low;z=(z=(z=q+oe+((Y=Z+ae)>>>0<Z>>>0?1:0))+ne+((Y+=se)>>>0<se>>>0?1:0))+de+((Y+=le)>>>0<le>>>0?1:0),$.high=z,$.low=Y;}var pe,ue=G&B^~G&V,Se=x&F^~x&j,Ee=N&M^N&b^M&b,he=P&w^P&k^w&k,ge=(N>>>28|P<<4)^(N<<30|P>>>2)^(N<<25|P>>>7),me=(P>>>28|N<<4)^(P<<30|N>>>2)^(P<<25|N>>>7),fe=(G>>>14|x<<18)^(G>>>18|x<<14)^(G<<23|x>>>9),Re=(x>>>14|G<<18)^(x>>>18|G<<14)^(x<<23|G>>>9),Te=c[K],Ce=Te.high,_e=Te.low,Ie=H+fe+((pe=W+Re)>>>0<W>>>0?1:0),Oe=me+he;H=V,W=j,V=B,j=F,B=G,F=x,G=L+(Ie=(Ie=(Ie=Ie+ue+((pe+=Se)>>>0<Se>>>0?1:0))+Ce+((pe+=_e)>>>0<_e>>>0?1:0))+z+((pe+=Y)>>>0<Y>>>0?1:0))+((x=U+pe|0)>>>0<U>>>0?1:0)|0,L=b,U=k,b=M,k=w,M=N,w=P,N=Ie+(ge+Ee+(Oe>>>0<me>>>0?1:0))+((P=pe+Oe|0)>>>0<pe>>>0?1:0)|0;}E=n.low=E+P,n.high=S+N+(E>>>0<P>>>0?1:0),g=s.low=g+w,s.high=h+M+(g>>>0<w>>>0?1:0),f=i.low=f+k,i.high=m+b+(f>>>0<k>>>0?1:0),T=o.low=T+U,o.high=R+L+(T>>>0<U>>>0?1:0),_=a.low=_+x,a.high=C+G+(_>>>0<x>>>0?1:0),O=l.low=O+F,l.high=I+B+(O>>>0<F>>>0?1:0),v=p.low=v+j,p.high=A+V+(v>>>0<j>>>0?1:0),y=u.low=y+W,u.high=D+H+(y>>>0<W>>>0?1:0);},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;return t[n>>>5]|=128<<24-n%32,t[30+(n+128>>>10<<5)]=Math.floor(r/4294967296),t[31+(n+128>>>10<<5)]=r,e.sigBytes=4*t.length,this._process(),this._hash.toX32()},clone:function(){var e=t.clone.call(this);return e._hash=this._hash.clone(),e},blockSize:32});e.SHA512=t._createHelper(l),e.HmacSHA512=t._createHmacHelper(l);}(),r.SHA512);})),A((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=ur).x64,s=n.Word,i=n.WordArray,o=r.algo,a=o.SHA512,c=o.SHA384=a.extend({_doReset:function(){this._hash=new i.init([new s.init(3418070365,3238371032),new s.init(1654270250,914150663),new s.init(2438529370,812702999),new s.init(355462360,4144912697),new s.init(1731405415,4290775857),new s.init(2394180231,1750603025),new s.init(3675008525,1694076839),new s.init(1203062813,3204075428)]);},_doFinalize:function(){var e=a._doFinalize.call(this);return e.sigBytes-=16,e}}),r.SHA384=a._createHelper(c),r.HmacSHA384=a._createHmacHelper(c),d.SHA384);})),A((function(e,t){var r;e.exports=(r=ur,function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.x64.Word,a=t.algo,c=[],d=[],l=[];!function(){for(var e=1,t=0,r=0;r<24;r++){c[e+5*t]=(r+1)*(r+2)/2%64;var n=(2*e+3*t)%5;e=t%5,t=n;}for(e=0;e<5;e++)for(t=0;t<5;t++)d[e+5*t]=t+(2*e+3*t)%5*5;for(var s=1,i=0;i<24;i++){for(var a=0,p=0,u=0;u<7;u++){if(1&s){var S=(1<<u)-1;S<32?p^=1<<S:a^=1<<S-32;}128&s?s=s<<1^113:s<<=1;}l[i]=o.create(a,p);}}();var p=[];!function(){for(var e=0;e<25;e++)p[e]=o.create();}();var u=a.SHA3=i.extend({cfg:i.cfg.extend({outputLength:512}),_doReset:function(){for(var e=this._state=[],t=0;t<25;t++)e[t]=new o.init;this.blockSize=(1600-2*this.cfg.outputLength)/32;},_doProcessBlock:function(e,t){for(var r=this._state,n=this.blockSize/2,s=0;s<n;s++){var i=e[t+2*s],o=e[t+2*s+1];i=16711935&(i<<8|i>>>24)|4278255360&(i<<24|i>>>8),o=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),(y=r[s]).high^=o,y.low^=i;}for(var a=0;a<24;a++){for(var u=0;u<5;u++){for(var S=0,E=0,h=0;h<5;h++)S^=(y=r[u+5*h]).high,E^=y.low;var g=p[u];g.high=S,g.low=E;}for(u=0;u<5;u++){var m=p[(u+4)%5],f=p[(u+1)%5],R=f.high,T=f.low;for(S=m.high^(R<<1|T>>>31),E=m.low^(T<<1|R>>>31),h=0;h<5;h++)(y=r[u+5*h]).high^=S,y.low^=E;}for(var C=1;C<25;C++){var _=(y=r[C]).high,I=y.low,O=c[C];O<32?(S=_<<O|I>>>32-O,E=I<<O|_>>>32-O):(S=I<<O-32|_>>>64-O,E=_<<O-32|I>>>64-O);var A=p[d[C]];A.high=S,A.low=E;}var v=p[0],D=r[0];for(v.high=D.high,v.low=D.low,u=0;u<5;u++)for(h=0;h<5;h++){var y=r[C=u+5*h],N=p[C],P=p[(u+1)%5+5*h],M=p[(u+2)%5+5*h];y.high=N.high^~P.high&M.high,y.low=N.low^~P.low&M.low;}y=r[0];var w=l[a];y.high^=w.high,y.low^=w.low;}},_doFinalize:function(){var t=this._data,r=t.words,n=(this._nDataBytes,8*t.sigBytes),i=32*this.blockSize;r[n>>>5]|=1<<24-n%32,r[(e.ceil((n+1)/i)*i>>>5)-1]|=128,t.sigBytes=4*r.length,this._process();for(var o=this._state,a=this.cfg.outputLength/8,c=a/8,d=[],l=0;l<c;l++){var p=o[l],u=p.high,S=p.low;u=16711935&(u<<8|u>>>24)|4278255360&(u<<24|u>>>8),S=16711935&(S<<8|S>>>24)|4278255360&(S<<24|S>>>8),d.push(S),d.push(u);}return new s.init(d,a)},clone:function(){for(var e=i.clone.call(this),t=e._state=this._state.slice(0),r=0;r<25;r++)t[r]=t[r].clone();return e}});t.SHA3=i._createHelper(u),t.HmacSHA3=i._createHmacHelper(u);}(Math),r.SHA3);})),A((function(e,t){var r;e.exports=(r=ur,
  /** @preserve
    	(c) 2012 by Cdric Mesnil. All rights reserved.

    	Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:

    	    - Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.
    	    - Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.

    	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
    	*/
  function(e){var t=r,n=t.lib,s=n.WordArray,i=n.Hasher,o=t.algo,a=s.create([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,7,4,13,1,10,6,15,3,12,0,9,5,2,14,11,8,3,10,14,4,9,15,8,1,2,7,0,6,13,11,5,12,1,9,11,10,0,8,12,4,13,3,7,15,14,5,6,2,4,0,5,9,7,12,2,10,14,1,3,8,11,6,15,13]),c=s.create([5,14,7,0,9,2,11,4,13,6,15,8,1,10,3,12,6,11,3,7,0,13,5,10,14,15,8,12,4,9,1,2,15,5,1,3,7,14,6,9,11,8,12,2,10,0,4,13,8,6,4,1,3,11,15,0,5,12,2,13,9,7,10,14,12,15,10,4,1,5,8,7,6,2,13,14,0,3,9,11]),d=s.create([11,14,15,12,5,8,7,9,11,13,14,15,6,7,9,8,7,6,8,13,11,9,7,15,7,12,15,9,11,7,13,12,11,13,6,7,14,9,13,15,14,8,13,6,5,12,7,5,11,12,14,15,14,15,9,8,9,14,5,6,8,6,5,12,9,15,5,11,6,8,13,12,5,12,13,14,11,8,5,6]),l=s.create([8,9,9,11,13,15,15,5,7,7,8,11,14,14,12,6,9,13,15,7,12,8,9,11,7,7,12,7,6,15,13,11,9,7,15,11,8,6,6,14,12,13,5,14,13,13,7,5,15,5,8,11,14,14,6,14,6,9,12,9,12,5,15,8,8,5,12,9,12,5,14,6,8,13,6,5,15,13,11,11]),p=s.create([0,1518500249,1859775393,2400959708,2840853838]),u=s.create([1352829926,1548603684,1836072691,2053994217,0]),S=o.RIPEMD160=i.extend({_doReset:function(){this._hash=s.create([1732584193,4023233417,2562383102,271733878,3285377520]);},_doProcessBlock:function(e,t){for(var r=0;r<16;r++){var n=t+r,s=e[n];e[n]=16711935&(s<<8|s>>>24)|4278255360&(s<<24|s>>>8);}var i,o,S,T,C,_,I,O,A,v,D,y=this._hash.words,N=p.words,P=u.words,M=a.words,w=c.words,b=d.words,k=l.words;for(_=i=y[0],I=o=y[1],O=S=y[2],A=T=y[3],v=C=y[4],r=0;r<80;r+=1)D=i+e[t+M[r]]|0,D+=r<16?E(o,S,T)+N[0]:r<32?h(o,S,T)+N[1]:r<48?g(o,S,T)+N[2]:r<64?m(o,S,T)+N[3]:f(o,S,T)+N[4],D=(D=R(D|=0,b[r]))+C|0,i=C,C=T,T=R(S,10),S=o,o=D,D=_+e[t+w[r]]|0,D+=r<16?f(I,O,A)+P[0]:r<32?m(I,O,A)+P[1]:r<48?g(I,O,A)+P[2]:r<64?h(I,O,A)+P[3]:E(I,O,A)+P[4],D=(D=R(D|=0,k[r]))+v|0,_=v,v=A,A=R(O,10),O=I,I=D;D=y[1]+S+A|0,y[1]=y[2]+T+v|0,y[2]=y[3]+C+_|0,y[3]=y[4]+i+I|0,y[4]=y[0]+o+O|0,y[0]=D;},_doFinalize:function(){var e=this._data,t=e.words,r=8*this._nDataBytes,n=8*e.sigBytes;t[n>>>5]|=128<<24-n%32,t[14+(n+64>>>9<<4)]=16711935&(r<<8|r>>>24)|4278255360&(r<<24|r>>>8),e.sigBytes=4*(t.length+1),this._process();for(var s=this._hash,i=s.words,o=0;o<5;o++){var a=i[o];i[o]=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8);}return s},clone:function(){var e=i.clone.call(this);return e._hash=this._hash.clone(),e}});function E(e,t,r){return e^t^r}function h(e,t,r){return e&t|~e&r}function g(e,t,r){return (e|~t)^r}function m(e,t,r){return e&r|t&~r}function f(e,t,r){return e^(t|~r)}function R(e,t){return e<<t|e>>>32-t}t.RIPEMD160=i._createHelper(S),t.HmacRIPEMD160=i._createHmacHelper(S);}(Math),r.RIPEMD160);})),A((function(e,t){var r,n,s;e.exports=(n=(r=ur).lib.Base,s=r.enc.Utf8,void(r.algo.HMAC=n.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=s.parse(t));var r=e.blockSize,n=4*r;t.sigBytes>n&&(t=e.finalize(t)),t.clamp();for(var i=this._oKey=t.clone(),o=this._iKey=t.clone(),a=i.words,c=o.words,d=0;d<r;d++)a[d]^=1549556828,c[d]^=909522486;i.sigBytes=o.sigBytes=n,this.reset();},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey);},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})));})),A((function(e,t){var r,n,s,i,o,a,c,d,l;e.exports=(n=(r=l=ur).lib,s=n.Base,i=n.WordArray,o=r.algo,a=o.SHA1,c=o.HMAC,d=o.PBKDF2=s.extend({cfg:s.extend({keySize:4,hasher:a,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e);},compute:function(e,t){for(var r=this.cfg,n=c.create(r.hasher,e),s=i.create(),o=i.create([1]),a=s.words,d=o.words,l=r.keySize,p=r.iterations;a.length<l;){var u=n.update(t).finalize(o);n.reset();for(var S=u.words,E=S.length,h=u,g=1;g<p;g++){h=n.finalize(h),n.reset();for(var m=h.words,f=0;f<E;f++)S[f]^=m[f];}s.concat(u),d[0]++;}return s.sigBytes=4*l,s}}),r.PBKDF2=function(e,t,r){return d.create(r).compute(e,t)},l.PBKDF2);})),A((function(e,t){var r,n,s,i,o,a,c,d;e.exports=(n=(r=d=ur).lib,s=n.Base,i=n.WordArray,o=r.algo,a=o.MD5,c=o.EvpKDF=s.extend({cfg:s.extend({keySize:4,hasher:a,iterations:1}),init:function(e){this.cfg=this.cfg.extend(e);},compute:function(e,t){for(var r=this.cfg,n=r.hasher.create(),s=i.create(),o=s.words,a=r.keySize,c=r.iterations;o.length<a;){d&&n.update(d);var d=n.update(e).finalize(t);n.reset();for(var l=1;l<c;l++)d=n.finalize(d),n.reset();s.concat(d);}return s.sigBytes=4*a,s}}),r.EvpKDF=function(e,t,r){return c.create(r).compute(e,t)},d.EvpKDF);})),A((function(e,t){var r,n,s,i,o,a,c,d,l,p,u,S,E,h,g,m,f,R,T,C;e.exports=void((r=ur).lib.Cipher||(s=r,i=s.lib,o=i.Base,a=i.WordArray,c=i.BufferedBlockAlgorithm,d=s.enc,d.Utf8,l=d.Base64,p=s.algo.EvpKDF,u=i.Cipher=c.extend({cfg:o.extend(),createEncryptor:function(e,t){return this.create(this._ENC_XFORM_MODE,e,t)},createDecryptor:function(e,t){return this.create(this._DEC_XFORM_MODE,e,t)},init:function(e,t,r){this.cfg=this.cfg.extend(r),this._xformMode=e,this._key=t,this.reset();},reset:function(){c.reset.call(this),this._doReset();},process:function(e){return this._append(e),this._process()},finalize:function(e){return e&&this._append(e),this._doFinalize()},keySize:4,ivSize:4,_ENC_XFORM_MODE:1,_DEC_XFORM_MODE:2,_createHelper:function(){function e(e){return "string"==typeof e?C:R}return function(t){return {encrypt:function(r,n,s){return e(n).encrypt(t,r,n,s)},decrypt:function(r,n,s){return e(n).decrypt(t,r,n,s)}}}}()}),i.StreamCipher=u.extend({_doFinalize:function(){return this._process(!0)},blockSize:1}),S=s.mode={},E=i.BlockCipherMode=o.extend({createEncryptor:function(e,t){return this.Encryptor.create(e,t)},createDecryptor:function(e,t){return this.Decryptor.create(e,t)},init:function(e,t){this._cipher=e,this._iv=t;}}),h=S.CBC=function(){var e=E.extend();function t(e,t,r){var s=this._iv;if(s){var i=s;this._iv=n;}else i=this._prevBlock;for(var o=0;o<r;o++)e[t+o]^=i[o];}return e.Encryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize;t.call(this,e,r,s),n.encryptBlock(e,r),this._prevBlock=e.slice(r,r+s);}}),e.Decryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize,i=e.slice(r,r+s);n.decryptBlock(e,r),t.call(this,e,r,s),this._prevBlock=i;}}),e}(),g=(s.pad={}).Pkcs7={pad:function(e,t){for(var r=4*t,n=r-e.sigBytes%r,s=n<<24|n<<16|n<<8|n,i=[],o=0;o<n;o+=4)i.push(s);var c=a.create(i,n);e.concat(c);},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},i.BlockCipher=u.extend({cfg:u.cfg.extend({mode:h,padding:g}),reset:function(){u.reset.call(this);var e=this.cfg,t=e.iv,r=e.mode;if(this._xformMode==this._ENC_XFORM_MODE)var n=r.createEncryptor;else n=r.createDecryptor,this._minBufferSize=1;this._mode&&this._mode.__creator==n?this._mode.init(this,t&&t.words):(this._mode=n.call(r,this,t&&t.words),this._mode.__creator=n);},_doProcessBlock:function(e,t){this._mode.processBlock(e,t);},_doFinalize:function(){var e=this.cfg.padding;if(this._xformMode==this._ENC_XFORM_MODE){e.pad(this._data,this.blockSize);var t=this._process(!0);}else t=this._process(!0),e.unpad(t);return t},blockSize:4}),m=i.CipherParams=o.extend({init:function(e){this.mixIn(e);},toString:function(e){return (e||this.formatter).stringify(this)}}),f=(s.format={}).OpenSSL={stringify:function(e){var t=e.ciphertext,r=e.salt;if(r)var n=a.create([1398893684,1701076831]).concat(r).concat(t);else n=t;return n.toString(l)},parse:function(e){var t=l.parse(e),r=t.words;if(1398893684==r[0]&&1701076831==r[1]){var n=a.create(r.slice(2,4));r.splice(0,4),t.sigBytes-=16;}return m.create({ciphertext:t,salt:n})}},R=i.SerializableCipher=o.extend({cfg:o.extend({format:f}),encrypt:function(e,t,r,n){n=this.cfg.extend(n);var s=e.createEncryptor(r,n),i=s.finalize(t),o=s.cfg;return m.create({ciphertext:i,key:r,iv:o.iv,algorithm:e,mode:o.mode,padding:o.padding,blockSize:e.blockSize,formatter:n.format})},decrypt:function(e,t,r,n){return n=this.cfg.extend(n),t=this._parse(t,n.format),e.createDecryptor(r,n).finalize(t.ciphertext)},_parse:function(e,t){return "string"==typeof e?t.parse(e,this):e}}),T=(s.kdf={}).OpenSSL={execute:function(e,t,r,n){n||(n=a.random(8));var s=p.create({keySize:t+r}).compute(e,n),i=a.create(s.words.slice(t),4*r);return s.sigBytes=4*t,m.create({key:s,iv:i,salt:n})}},C=i.PasswordBasedCipher=R.extend({cfg:R.cfg.extend({kdf:T}),encrypt:function(e,t,r,n){var s=(n=this.cfg.extend(n)).kdf.execute(r,e.keySize,e.ivSize);n.iv=s.iv;var i=R.encrypt.call(this,e,t,s.key,n);return i.mixIn(s),i},decrypt:function(e,t,r,n){n=this.cfg.extend(n),t=this._parse(t,n.format);var s=n.kdf.execute(r,e.keySize,e.ivSize,t.salt);return n.iv=s.iv,R.decrypt.call(this,e,t,s.key,n)}})));})),A((function(e,t){var r;e.exports=((r=ur).mode.CFB=function(){var e=r.lib.BlockCipherMode.extend();function t(e,t,r,n){var s=this._iv;if(s){var i=s.slice(0);this._iv=void 0;}else i=this._prevBlock;n.encryptBlock(i,0);for(var o=0;o<r;o++)e[t+o]^=i[o];}return e.Encryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize;t.call(this,e,r,s,n),this._prevBlock=e.slice(r,r+s);}}),e.Decryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize,i=e.slice(r,r+s);t.call(this,e,r,s,n),this._prevBlock=i;}}),e}(),r.mode.CFB);})),A((function(e,t){var r,n,s;e.exports=((s=ur).mode.CTR=(r=s.lib.BlockCipherMode.extend(),n=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,s=this._iv,i=this._counter;s&&(i=this._counter=s.slice(0),this._iv=void 0);var o=i.slice(0);r.encryptBlock(o,0),i[n-1]=i[n-1]+1|0;for(var a=0;a<n;a++)e[t+a]^=o[a];}}),r.Decryptor=n,r),s.mode.CTR);})),A((function(e,t){var r;e.exports=(
  /** @preserve
    	 * Counter block mode compatible with  Dr Brian Gladman fileenc.c
    	 * derived from CryptoJS.mode.CTR
    	 * Jan Hruby jhruby.web@gmail.com
    	 */
  (r=ur).mode.CTRGladman=function(){var e=r.lib.BlockCipherMode.extend();function t(e){if(255==(e>>24&255)){var t=e>>16&255,r=e>>8&255,n=255&e;255===t?(t=0,255===r?(r=0,255===n?n=0:++n):++r):++t,e=0,e+=t<<16,e+=r<<8,e+=n;}else e+=1<<24;return e}var n=e.Encryptor=e.extend({processBlock:function(e,r){var n=this._cipher,s=n.blockSize,i=this._iv,o=this._counter;i&&(o=this._counter=i.slice(0),this._iv=void 0),function(e){0===(e[0]=t(e[0]))&&(e[1]=t(e[1]));}(o);var a=o.slice(0);n.encryptBlock(a,0);for(var c=0;c<s;c++)e[r+c]^=a[c];}});return e.Decryptor=n,e}(),r.mode.CTRGladman);})),A((function(e,t){var r,n,s;e.exports=((s=ur).mode.OFB=(r=s.lib.BlockCipherMode.extend(),n=r.Encryptor=r.extend({processBlock:function(e,t){var r=this._cipher,n=r.blockSize,s=this._iv,i=this._keystream;s&&(i=this._keystream=s.slice(0),this._iv=void 0),r.encryptBlock(i,0);for(var o=0;o<n;o++)e[t+o]^=i[o];}}),r.Decryptor=n,r),s.mode.OFB);})),A((function(e,t){var r,n;e.exports=((n=ur).mode.ECB=((r=n.lib.BlockCipherMode.extend()).Encryptor=r.extend({processBlock:function(e,t){this._cipher.encryptBlock(e,t);}}),r.Decryptor=r.extend({processBlock:function(e,t){this._cipher.decryptBlock(e,t);}}),r),n.mode.ECB);})),A((function(e,t){var r;e.exports=((r=ur).pad.AnsiX923={pad:function(e,t){var r=e.sigBytes,n=4*t,s=n-r%n,i=r+s-1;e.clamp(),e.words[i>>>2]|=s<<24-i%4*8,e.sigBytes+=s;},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},r.pad.Ansix923);})),A((function(e,t){var r;e.exports=((r=ur).pad.Iso10126={pad:function(e,t){var n=4*t,s=n-e.sigBytes%n;e.concat(r.lib.WordArray.random(s-1)).concat(r.lib.WordArray.create([s<<24],1));},unpad:function(e){var t=255&e.words[e.sigBytes-1>>>2];e.sigBytes-=t;}},r.pad.Iso10126);})),A((function(e,t){var r;e.exports=((r=ur).pad.Iso97971={pad:function(e,t){e.concat(r.lib.WordArray.create([2147483648],1)),r.pad.ZeroPadding.pad(e,t);},unpad:function(e){r.pad.ZeroPadding.unpad(e),e.sigBytes--;}},r.pad.Iso97971);})),A((function(e,t){var r;e.exports=((r=ur).pad.ZeroPadding={pad:function(e,t){var r=4*t;e.clamp(),e.sigBytes+=r-(e.sigBytes%r||r);},unpad:function(e){for(var t=e.words,r=e.sigBytes-1;!(t[r>>>2]>>>24-r%4*8&255);)r--;e.sigBytes=r+1;}},r.pad.ZeroPadding);})),A((function(e,t){var r;e.exports=((r=ur).pad.NoPadding={pad:function(){},unpad:function(){}},r.pad.NoPadding);})),A((function(e,t){var r,n,s,i;e.exports=(n=(r=i=ur).lib.CipherParams,s=r.enc.Hex,r.format.Hex={stringify:function(e){return e.ciphertext.toString(s)},parse:function(e){var t=s.parse(e);return n.create({ciphertext:t})}},i.format.Hex);})),A((function(e,t){var r;e.exports=(r=ur,function(){var e=r,t=e.lib.BlockCipher,n=e.algo,s=[],i=[],o=[],a=[],c=[],d=[],l=[],p=[],u=[],S=[];!function(){for(var e=[],t=0;t<256;t++)e[t]=t<128?t<<1:t<<1^283;var r=0,n=0;for(t=0;t<256;t++){var E=n^n<<1^n<<2^n<<3^n<<4;E=E>>>8^255&E^99,s[r]=E,i[E]=r;var h=e[r],g=e[h],m=e[g],f=257*e[E]^16843008*E;o[r]=f<<24|f>>>8,a[r]=f<<16|f>>>16,c[r]=f<<8|f>>>24,d[r]=f,f=16843009*m^65537*g^257*h^16843008*r,l[E]=f<<24|f>>>8,p[E]=f<<16|f>>>16,u[E]=f<<8|f>>>24,S[E]=f,r?(r=h^e[e[e[m^h]]],n^=e[e[n]]):r=n=1;}}();var E=[0,1,2,4,8,16,32,64,128,27,54],h=n.AES=t.extend({_doReset:function(){if(!this._nRounds||this._keyPriorReset!==this._key){for(var e=this._keyPriorReset=this._key,t=e.words,r=e.sigBytes/4,n=4*((this._nRounds=r+6)+1),i=this._keySchedule=[],o=0;o<n;o++)if(o<r)i[o]=t[o];else{var a=i[o-1];o%r?r>6&&o%r==4&&(a=s[a>>>24]<<24|s[a>>>16&255]<<16|s[a>>>8&255]<<8|s[255&a]):(a=s[(a=a<<8|a>>>24)>>>24]<<24|s[a>>>16&255]<<16|s[a>>>8&255]<<8|s[255&a],a^=E[o/r|0]<<24),i[o]=i[o-r]^a;}for(var c=this._invKeySchedule=[],d=0;d<n;d++)o=n-d,a=d%4?i[o]:i[o-4],c[d]=d<4||o<=4?a:l[s[a>>>24]]^p[s[a>>>16&255]]^u[s[a>>>8&255]]^S[s[255&a]];}},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._keySchedule,o,a,c,d,s);},decryptBlock:function(e,t){var r=e[t+1];e[t+1]=e[t+3],e[t+3]=r,this._doCryptBlock(e,t,this._invKeySchedule,l,p,u,S,i),r=e[t+1],e[t+1]=e[t+3],e[t+3]=r;},_doCryptBlock:function(e,t,r,n,s,i,o,a){for(var c=this._nRounds,d=e[t]^r[0],l=e[t+1]^r[1],p=e[t+2]^r[2],u=e[t+3]^r[3],S=4,E=1;E<c;E++){var h=n[d>>>24]^s[l>>>16&255]^i[p>>>8&255]^o[255&u]^r[S++],g=n[l>>>24]^s[p>>>16&255]^i[u>>>8&255]^o[255&d]^r[S++],m=n[p>>>24]^s[u>>>16&255]^i[d>>>8&255]^o[255&l]^r[S++],f=n[u>>>24]^s[d>>>16&255]^i[l>>>8&255]^o[255&p]^r[S++];d=h,l=g,p=m,u=f;}h=(a[d>>>24]<<24|a[l>>>16&255]<<16|a[p>>>8&255]<<8|a[255&u])^r[S++],g=(a[l>>>24]<<24|a[p>>>16&255]<<16|a[u>>>8&255]<<8|a[255&d])^r[S++],m=(a[p>>>24]<<24|a[u>>>16&255]<<16|a[d>>>8&255]<<8|a[255&l])^r[S++],f=(a[u>>>24]<<24|a[d>>>16&255]<<16|a[l>>>8&255]<<8|a[255&p])^r[S++],e[t]=h,e[t+1]=g,e[t+2]=m,e[t+3]=f;},keySize:8});e.AES=t._createHelper(h);}(),r.AES);})),A((function(e,t){var r;e.exports=(r=ur,function(){var e=r,t=e.lib,n=t.WordArray,s=t.BlockCipher,i=e.algo,o=[57,49,41,33,25,17,9,1,58,50,42,34,26,18,10,2,59,51,43,35,27,19,11,3,60,52,44,36,63,55,47,39,31,23,15,7,62,54,46,38,30,22,14,6,61,53,45,37,29,21,13,5,28,20,12,4],a=[14,17,11,24,1,5,3,28,15,6,21,10,23,19,12,4,26,8,16,7,27,20,13,2,41,52,31,37,47,55,30,40,51,45,33,48,44,49,39,56,34,53,46,42,50,36,29,32],c=[1,2,4,6,8,10,12,14,15,17,19,21,23,25,27,28],d=[{0:8421888,268435456:32768,536870912:8421378,805306368:2,1073741824:512,1342177280:8421890,1610612736:8389122,1879048192:8388608,2147483648:514,2415919104:8389120,2684354560:33280,2952790016:8421376,3221225472:32770,3489660928:8388610,3758096384:0,4026531840:33282,134217728:0,402653184:8421890,671088640:33282,939524096:32768,1207959552:8421888,1476395008:512,1744830464:8421378,2013265920:2,2281701376:8389120,2550136832:33280,2818572288:8421376,3087007744:8389122,3355443200:8388610,3623878656:32770,3892314112:514,4160749568:8388608,1:32768,268435457:2,536870913:8421888,805306369:8388608,1073741825:8421378,1342177281:33280,1610612737:512,1879048193:8389122,2147483649:8421890,2415919105:8421376,2684354561:8388610,2952790017:33282,3221225473:514,3489660929:8389120,3758096385:32770,4026531841:0,134217729:8421890,402653185:8421376,671088641:8388608,939524097:512,1207959553:32768,1476395009:8388610,1744830465:2,2013265921:33282,2281701377:32770,2550136833:8389122,2818572289:514,3087007745:8421888,3355443201:8389120,3623878657:0,3892314113:33280,4160749569:8421378},{0:1074282512,16777216:16384,33554432:524288,50331648:1074266128,67108864:1073741840,83886080:1074282496,100663296:1073758208,117440512:16,134217728:540672,150994944:1073758224,167772160:1073741824,184549376:540688,201326592:524304,218103808:0,234881024:16400,251658240:1074266112,8388608:1073758208,25165824:540688,41943040:16,58720256:1073758224,75497472:1074282512,92274688:1073741824,109051904:524288,125829120:1074266128,142606336:524304,159383552:0,176160768:16384,192937984:1074266112,209715200:1073741840,226492416:540672,243269632:1074282496,260046848:16400,268435456:0,285212672:1074266128,301989888:1073758224,318767104:1074282496,335544320:1074266112,352321536:16,369098752:540688,385875968:16384,402653184:16400,419430400:524288,436207616:524304,452984832:1073741840,469762048:540672,486539264:1073758208,503316480:1073741824,520093696:1074282512,276824064:540688,293601280:524288,310378496:1074266112,327155712:16384,343932928:1073758208,360710144:1074282512,377487360:16,394264576:1073741824,411041792:1074282496,427819008:1073741840,444596224:1073758224,461373440:524304,478150656:0,494927872:16400,511705088:1074266128,528482304:540672},{0:260,1048576:0,2097152:67109120,3145728:65796,4194304:65540,5242880:67108868,6291456:67174660,7340032:67174400,8388608:67108864,9437184:67174656,10485760:65792,11534336:67174404,12582912:67109124,13631488:65536,14680064:4,15728640:256,524288:67174656,1572864:67174404,2621440:0,3670016:67109120,4718592:67108868,5767168:65536,6815744:65540,7864320:260,8912896:4,9961472:256,11010048:67174400,12058624:65796,13107200:65792,14155776:67109124,15204352:67174660,16252928:67108864,16777216:67174656,17825792:65540,18874368:65536,19922944:67109120,20971520:256,22020096:67174660,23068672:67108868,24117248:0,25165824:67109124,26214400:67108864,27262976:4,28311552:65792,29360128:67174400,30408704:260,31457280:65796,32505856:67174404,17301504:67108864,18350080:260,19398656:67174656,20447232:0,21495808:65540,22544384:67109120,23592960:256,24641536:67174404,25690112:65536,26738688:67174660,27787264:65796,28835840:67108868,29884416:67109124,30932992:67174400,31981568:4,33030144:65792},{0:2151682048,65536:2147487808,131072:4198464,196608:2151677952,262144:0,327680:4198400,393216:2147483712,458752:4194368,524288:2147483648,589824:4194304,655360:64,720896:2147487744,786432:2151678016,851968:4160,917504:4096,983040:2151682112,32768:2147487808,98304:64,163840:2151678016,229376:2147487744,294912:4198400,360448:2151682112,425984:0,491520:2151677952,557056:4096,622592:2151682048,688128:4194304,753664:4160,819200:2147483648,884736:4194368,950272:4198464,1015808:2147483712,1048576:4194368,1114112:4198400,1179648:2147483712,1245184:0,1310720:4160,1376256:2151678016,1441792:2151682048,1507328:2147487808,1572864:2151682112,1638400:2147483648,1703936:2151677952,1769472:4198464,1835008:2147487744,1900544:4194304,1966080:64,2031616:4096,1081344:2151677952,1146880:2151682112,1212416:0,1277952:4198400,1343488:4194368,1409024:2147483648,1474560:2147487808,1540096:64,1605632:2147483712,1671168:4096,1736704:2147487744,1802240:2151678016,1867776:4160,1933312:2151682048,1998848:4194304,2064384:4198464},{0:128,4096:17039360,8192:262144,12288:536870912,16384:537133184,20480:16777344,24576:553648256,28672:262272,32768:16777216,36864:537133056,40960:536871040,45056:553910400,49152:553910272,53248:0,57344:17039488,61440:553648128,2048:17039488,6144:553648256,10240:128,14336:17039360,18432:262144,22528:537133184,26624:553910272,30720:536870912,34816:537133056,38912:0,43008:553910400,47104:16777344,51200:536871040,55296:553648128,59392:16777216,63488:262272,65536:262144,69632:128,73728:536870912,77824:553648256,81920:16777344,86016:553910272,90112:537133184,94208:16777216,98304:553910400,102400:553648128,106496:17039360,110592:537133056,114688:262272,118784:536871040,122880:0,126976:17039488,67584:553648256,71680:16777216,75776:17039360,79872:537133184,83968:536870912,88064:17039488,92160:128,96256:553910272,100352:262272,104448:553910400,108544:0,112640:553648128,116736:16777344,120832:262144,124928:537133056,129024:536871040},{0:268435464,256:8192,512:270532608,768:270540808,1024:268443648,1280:2097152,1536:2097160,1792:268435456,2048:0,2304:268443656,2560:2105344,2816:8,3072:270532616,3328:2105352,3584:8200,3840:270540800,128:270532608,384:270540808,640:8,896:2097152,1152:2105352,1408:268435464,1664:268443648,1920:8200,2176:2097160,2432:8192,2688:268443656,2944:270532616,3200:0,3456:270540800,3712:2105344,3968:268435456,4096:268443648,4352:270532616,4608:270540808,4864:8200,5120:2097152,5376:268435456,5632:268435464,5888:2105344,6144:2105352,6400:0,6656:8,6912:270532608,7168:8192,7424:268443656,7680:270540800,7936:2097160,4224:8,4480:2105344,4736:2097152,4992:268435464,5248:268443648,5504:8200,5760:270540808,6016:270532608,6272:270540800,6528:270532616,6784:8192,7040:2105352,7296:2097160,7552:0,7808:268435456,8064:268443656},{0:1048576,16:33555457,32:1024,48:1049601,64:34604033,80:0,96:1,112:34603009,128:33555456,144:1048577,160:33554433,176:34604032,192:34603008,208:1025,224:1049600,240:33554432,8:34603009,24:0,40:33555457,56:34604032,72:1048576,88:33554433,104:33554432,120:1025,136:1049601,152:33555456,168:34603008,184:1048577,200:1024,216:34604033,232:1,248:1049600,256:33554432,272:1048576,288:33555457,304:34603009,320:1048577,336:33555456,352:34604032,368:1049601,384:1025,400:34604033,416:1049600,432:1,448:0,464:34603008,480:33554433,496:1024,264:1049600,280:33555457,296:34603009,312:1,328:33554432,344:1048576,360:1025,376:34604032,392:33554433,408:34603008,424:0,440:34604033,456:1049601,472:1024,488:33555456,504:1048577},{0:134219808,1:131072,2:134217728,3:32,4:131104,5:134350880,6:134350848,7:2048,8:134348800,9:134219776,10:133120,11:134348832,12:2080,13:0,14:134217760,15:133152,2147483648:2048,2147483649:134350880,2147483650:134219808,2147483651:134217728,2147483652:134348800,2147483653:133120,2147483654:133152,2147483655:32,2147483656:134217760,2147483657:2080,2147483658:131104,2147483659:134350848,2147483660:0,2147483661:134348832,2147483662:134219776,2147483663:131072,16:133152,17:134350848,18:32,19:2048,20:134219776,21:134217760,22:134348832,23:131072,24:0,25:131104,26:134348800,27:134219808,28:134350880,29:133120,30:2080,31:134217728,2147483664:131072,2147483665:2048,2147483666:134348832,2147483667:133152,2147483668:32,2147483669:134348800,2147483670:134217728,2147483671:134219808,2147483672:134350880,2147483673:134217760,2147483674:134219776,2147483675:0,2147483676:133120,2147483677:2080,2147483678:131104,2147483679:134350848}],l=[4160749569,528482304,33030144,2064384,129024,8064,504,2147483679],p=i.DES=s.extend({_doReset:function(){for(var e=this._key.words,t=[],r=0;r<56;r++){var n=o[r]-1;t[r]=e[n>>>5]>>>31-n%32&1;}for(var s=this._subKeys=[],i=0;i<16;i++){var d=s[i]=[],l=c[i];for(r=0;r<24;r++)d[r/6|0]|=t[(a[r]-1+l)%28]<<31-r%6,d[4+(r/6|0)]|=t[28+(a[r+24]-1+l)%28]<<31-r%6;for(d[0]=d[0]<<1|d[0]>>>31,r=1;r<7;r++)d[r]=d[r]>>>4*(r-1)+3;d[7]=d[7]<<5|d[7]>>>27;}var p=this._invSubKeys=[];for(r=0;r<16;r++)p[r]=s[15-r];},encryptBlock:function(e,t){this._doCryptBlock(e,t,this._subKeys);},decryptBlock:function(e,t){this._doCryptBlock(e,t,this._invSubKeys);},_doCryptBlock:function(e,t,r){this._lBlock=e[t],this._rBlock=e[t+1],u.call(this,4,252645135),u.call(this,16,65535),S.call(this,2,858993459),S.call(this,8,16711935),u.call(this,1,1431655765);for(var n=0;n<16;n++){for(var s=r[n],i=this._lBlock,o=this._rBlock,a=0,c=0;c<8;c++)a|=d[c][((o^s[c])&l[c])>>>0];this._lBlock=o,this._rBlock=i^a;}var p=this._lBlock;this._lBlock=this._rBlock,this._rBlock=p,u.call(this,1,1431655765),S.call(this,8,16711935),S.call(this,2,858993459),u.call(this,16,65535),u.call(this,4,252645135),e[t]=this._lBlock,e[t+1]=this._rBlock;},keySize:2,ivSize:2,blockSize:2});function u(e,t){var r=(this._lBlock>>>e^this._rBlock)&t;this._rBlock^=r,this._lBlock^=r<<e;}function S(e,t){var r=(this._rBlock>>>e^this._lBlock)&t;this._lBlock^=r,this._rBlock^=r<<e;}e.DES=s._createHelper(p);var E=i.TripleDES=s.extend({_doReset:function(){var e=this._key.words;this._des1=p.createEncryptor(n.create(e.slice(0,2))),this._des2=p.createEncryptor(n.create(e.slice(2,4))),this._des3=p.createEncryptor(n.create(e.slice(4,6)));},encryptBlock:function(e,t){this._des1.encryptBlock(e,t),this._des2.decryptBlock(e,t),this._des3.encryptBlock(e,t);},decryptBlock:function(e,t){this._des3.decryptBlock(e,t),this._des2.encryptBlock(e,t),this._des1.decryptBlock(e,t);},keySize:6,ivSize:2,blockSize:2});e.TripleDES=s._createHelper(E);}(),r.TripleDES);})),A((function(e,t){var r;e.exports=(r=ur,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=n.RC4=t.extend({_doReset:function(){for(var e=this._key,t=e.words,r=e.sigBytes,n=this._S=[],s=0;s<256;s++)n[s]=s;s=0;for(var i=0;s<256;s++){var o=s%r,a=t[o>>>2]>>>24-o%4*8&255;i=(i+n[s]+a)%256;var c=n[s];n[s]=n[i],n[i]=c;}this._i=this._j=0;},_doProcessBlock:function(e,t){e[t]^=i.call(this);},keySize:8,ivSize:0});function i(){for(var e=this._S,t=this._i,r=this._j,n=0,s=0;s<4;s++){r=(r+e[t=(t+1)%256])%256;var i=e[t];e[t]=e[r],e[r]=i,n|=e[(e[t]+e[r])%256]<<24-8*s;}return this._i=t,this._j=r,n}e.RC4=t._createHelper(s);var o=n.RC4Drop=s.extend({cfg:s.cfg.extend({drop:192}),_doReset:function(){s._doReset.call(this);for(var e=this.cfg.drop;e>0;e--)i.call(this);}});e.RC4Drop=t._createHelper(o);}(),r.RC4);})),A((function(e,t){var r;e.exports=(r=ur,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=[],i=[],o=[],a=n.Rabbit=t.extend({_doReset:function(){for(var e=this._key.words,t=this.cfg.iv,r=0;r<4;r++)e[r]=16711935&(e[r]<<8|e[r]>>>24)|4278255360&(e[r]<<24|e[r]>>>8);var n=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],s=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];for(this._b=0,r=0;r<4;r++)c.call(this);for(r=0;r<8;r++)s[r]^=n[r+4&7];if(t){var i=t.words,o=i[0],a=i[1],d=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),l=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),p=d>>>16|4294901760&l,u=l<<16|65535&d;for(s[0]^=d,s[1]^=p,s[2]^=l,s[3]^=u,s[4]^=d,s[5]^=p,s[6]^=l,s[7]^=u,r=0;r<4;r++)c.call(this);}},_doProcessBlock:function(e,t){var r=this._X;c.call(this),s[0]=r[0]^r[5]>>>16^r[3]<<16,s[1]=r[2]^r[7]>>>16^r[5]<<16,s[2]=r[4]^r[1]>>>16^r[7]<<16,s[3]=r[6]^r[3]>>>16^r[1]<<16;for(var n=0;n<4;n++)s[n]=16711935&(s[n]<<8|s[n]>>>24)|4278255360&(s[n]<<24|s[n]>>>8),e[t+n]^=s[n];},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,r=0;r<8;r++)i[r]=t[r];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<i[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<i[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<i[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<i[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<i[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<i[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<i[6]>>>0?1:0)|0,this._b=t[7]>>>0<i[7]>>>0?1:0,r=0;r<8;r++){var n=e[r]+t[r],s=65535&n,a=n>>>16,c=((s*s>>>17)+s*a>>>15)+a*a,d=((4294901760&n)*n|0)+((65535&n)*n|0);o[r]=c^d;}e[0]=o[0]+(o[7]<<16|o[7]>>>16)+(o[6]<<16|o[6]>>>16)|0,e[1]=o[1]+(o[0]<<8|o[0]>>>24)+o[7]|0,e[2]=o[2]+(o[1]<<16|o[1]>>>16)+(o[0]<<16|o[0]>>>16)|0,e[3]=o[3]+(o[2]<<8|o[2]>>>24)+o[1]|0,e[4]=o[4]+(o[3]<<16|o[3]>>>16)+(o[2]<<16|o[2]>>>16)|0,e[5]=o[5]+(o[4]<<8|o[4]>>>24)+o[3]|0,e[6]=o[6]+(o[5]<<16|o[5]>>>16)+(o[4]<<16|o[4]>>>16)|0,e[7]=o[7]+(o[6]<<8|o[6]>>>24)+o[5]|0;}e.Rabbit=t._createHelper(a);}(),r.Rabbit);})),A((function(e,t){var r;e.exports=(r=ur,function(){var e=r,t=e.lib.StreamCipher,n=e.algo,s=[],i=[],o=[],a=n.RabbitLegacy=t.extend({_doReset:function(){var e=this._key.words,t=this.cfg.iv,r=this._X=[e[0],e[3]<<16|e[2]>>>16,e[1],e[0]<<16|e[3]>>>16,e[2],e[1]<<16|e[0]>>>16,e[3],e[2]<<16|e[1]>>>16],n=this._C=[e[2]<<16|e[2]>>>16,4294901760&e[0]|65535&e[1],e[3]<<16|e[3]>>>16,4294901760&e[1]|65535&e[2],e[0]<<16|e[0]>>>16,4294901760&e[2]|65535&e[3],e[1]<<16|e[1]>>>16,4294901760&e[3]|65535&e[0]];this._b=0;for(var s=0;s<4;s++)c.call(this);for(s=0;s<8;s++)n[s]^=r[s+4&7];if(t){var i=t.words,o=i[0],a=i[1],d=16711935&(o<<8|o>>>24)|4278255360&(o<<24|o>>>8),l=16711935&(a<<8|a>>>24)|4278255360&(a<<24|a>>>8),p=d>>>16|4294901760&l,u=l<<16|65535&d;for(n[0]^=d,n[1]^=p,n[2]^=l,n[3]^=u,n[4]^=d,n[5]^=p,n[6]^=l,n[7]^=u,s=0;s<4;s++)c.call(this);}},_doProcessBlock:function(e,t){var r=this._X;c.call(this),s[0]=r[0]^r[5]>>>16^r[3]<<16,s[1]=r[2]^r[7]>>>16^r[5]<<16,s[2]=r[4]^r[1]>>>16^r[7]<<16,s[3]=r[6]^r[3]>>>16^r[1]<<16;for(var n=0;n<4;n++)s[n]=16711935&(s[n]<<8|s[n]>>>24)|4278255360&(s[n]<<24|s[n]>>>8),e[t+n]^=s[n];},blockSize:4,ivSize:2});function c(){for(var e=this._X,t=this._C,r=0;r<8;r++)i[r]=t[r];for(t[0]=t[0]+1295307597+this._b|0,t[1]=t[1]+3545052371+(t[0]>>>0<i[0]>>>0?1:0)|0,t[2]=t[2]+886263092+(t[1]>>>0<i[1]>>>0?1:0)|0,t[3]=t[3]+1295307597+(t[2]>>>0<i[2]>>>0?1:0)|0,t[4]=t[4]+3545052371+(t[3]>>>0<i[3]>>>0?1:0)|0,t[5]=t[5]+886263092+(t[4]>>>0<i[4]>>>0?1:0)|0,t[6]=t[6]+1295307597+(t[5]>>>0<i[5]>>>0?1:0)|0,t[7]=t[7]+3545052371+(t[6]>>>0<i[6]>>>0?1:0)|0,this._b=t[7]>>>0<i[7]>>>0?1:0,r=0;r<8;r++){var n=e[r]+t[r],s=65535&n,a=n>>>16,c=((s*s>>>17)+s*a>>>15)+a*a,d=((4294901760&n)*n|0)+((65535&n)*n|0);o[r]=c^d;}e[0]=o[0]+(o[7]<<16|o[7]>>>16)+(o[6]<<16|o[6]>>>16)|0,e[1]=o[1]+(o[0]<<8|o[0]>>>24)+o[7]|0,e[2]=o[2]+(o[1]<<16|o[1]>>>16)+(o[0]<<16|o[0]>>>16)|0,e[3]=o[3]+(o[2]<<8|o[2]>>>24)+o[1]|0,e[4]=o[4]+(o[3]<<16|o[3]>>>16)+(o[2]<<16|o[2]>>>16)|0,e[5]=o[5]+(o[4]<<8|o[4]>>>24)+o[3]|0,e[6]=o[6]+(o[5]<<16|o[5]>>>16)+(o[4]<<16|o[4]>>>16)|0,e[7]=o[7]+(o[6]<<8|o[6]>>>24)+o[5]|0;}e.RabbitLegacy=t._createHelper(a);}(),r.RabbitLegacy);})),A((function(e,t){e.exports=ur;})));class Er{static throwError(e="",t=""){throw Ys.log.ERROR([null,Ct.SKYLINK_ERROR,null,`${e}${t?` - ${t}`:""}`]),new Error(`${e}${t?` - ${t}`:""}`)}}const hr={getMessageConfig:(e,t)=>{const{peerInformations:r,inRoom:n,user:s}=e;let i,o=!1;if(!n||!s)throw Error(Lt.ROOM.ERRORS.NOT_IN_ROOM);return Array.isArray(t)&&!Ss(t)?(i=t,o=!0):t&&Ts(t)?(i=[t],o=!0):i=Object.keys(r),i.forEach((e,t)=>{r[e]?e===Nt.MCU&&i.splice(t,1):(Ys.log.WARN([e,Ct.MESSAGING,null,`${Lt.MESSAGING.ERRORS.DROPPING_MESSAGE} - ${Lt.PEER_CONNECTION.NO_PEER_CONNECTION}`]),i.splice(t,1));}),0===i.length&&Ys.log.WARN([null,Ct.MESSAGING,null,Lt.PEER_CONNECTION.NO_PEER_CONNECTION]),{listOfPeers:i,isPrivate:o}},sendMessageToSig:(e,t,r,n="",s)=>{(new zn).sendUserMessage(e,t,n||r),hr.dispatchOnIncomingMessage(e,t,r,!0,s);},dispatchOnIncomingMessage:(e,t,r,n,s)=>{const{room:i,user:o}=e;Ys.log.DEBUG([n?null:s,Ct.MESSAGING,null,`${Lt.MESSAGING.RECEIVED_MESSAGE} - isPrivate: ${t.isPrivate}`]);const a={targetPeerId:n?t.isPrivate?s:null:o.sid,content:r,senderPeerId:n?o.sid:s,isDataChannel:!1,isPrivate:t.isPrivate,timeStamp:Gs()};n&&(a.listOfPeers=t.listOfPeers),Vs(me({room:i,message:a,isSelf:n,peerId:n?o.sid:s,peerInfo:n?Qt.getCurrentSessionInfo(i):Qt.getPeerInfo(s,i)}));},trySendMessage:(e,t,r)=>{try{const n=hr.getMessageConfig(e,r);hr.sendMessageToSig(e,n,t,null,r);}catch(e){Er.throwError(Lt.MESSAGING.ERRORS.FAILED_SENDING_MESSAGE);}}},gr={deleteEncryptSecrets:(e,t,r)=>{const n={encryptSecrets:e,selectedSecretId:t};if(r){if(!n.encryptSecrets[r])throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);n.selectedSecretId===r&&(n.selectedSecretId=gr.setSelectedSecretId()),delete n.encryptSecrets[r];}else Ys.log.DEBUG([null,Ct.ENCRYPTED_MESSAGING,null,`${Lt.MESSAGING.ENCRYPTION.DELETE_ALL}`]),n.selectedSecretId=gr.setSelectedSecretId(),n.encryptSecrets={};return n},setEncryptSecret:(e,t,r)=>{const n=e;if((e=>{if(!e)throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!gr.utils.isValidString(e));return !0})(t)&&((e,t)=>{if(!e)throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.NO_SECRET_OR_SECRET_ID);if(!gr.utils.isValidString(e));if(gr.utils.isExisting(e,t))throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_UNIQUE);return !0})(r,n))return n[r]=t,n},setSelectedSecretId:(e,t)=>{if(!t)return "";if(gr.utils.isValidString(t),!e[t])throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return t},utils:{isExisting:(e,t)=>{return Object.keys(t).filter(t=>t===e).length>0},isValidString:e=>{if(!Ts(e)||!Ts(e)||Es(e))throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.INVALID_TYPE);return !0},hasCrypto:()=>Sr||(Ys.log.ERROR([null,Ct.ASYNC_MESSAGING,null,Lt.PERSISTENT_MESSAGE.ERRORS.NO_DEPENDENCY]),!1),canEncrypt:(e,t)=>{if(us(t)&&Es(e))throw new Error(`${Lt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED}, ${Lt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_PROVIDED}`);if(Es(e))throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_SELECTED);if(us(t))throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return !0},canDecrypt:e=>{if(us(e))throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.SECRETS_NOT_PROVIDED);return !0}},getMessageConfig:(e,t,r,n,s)=>{const i=hr.getMessageConfig(e,t);return gr.utils.hasCrypto()&&gr.utils.canEncrypt(n,r)&&(i.secretId=n),s&&(i.isPersistent=s),i},encryptMessage:(e,t,r=!1)=>{if(r)try{return Sr.AES.decrypt(e,t).toString(Sr.enc.Utf8)}catch(e){throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET)}return Sr.AES.encrypt(e,t).toString()},tryDecryptMessage:(e,t,r)=>{const n=gr.encryptMessage(e,r[t],!0);if(Es(n))throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.ENCRYPT_SECRET);return n}},mr={};class fr{constructor(e){const{room:t,user:r}=e;return mr[t.id]||(mr[t.id]=this),this.room=t,this.peerId=r.sid,this.encryptSecrets={},this.selectedSecretId="",mr[t.id]}setEncryptSecret(e,t){try{this.encryptSecrets=gr.setEncryptSecret(this.encryptSecrets,e,t),this.dispatchEncryptSecretEvent();}catch(e){Er.throwError(Lt.MESSAGING.ENCRYPTION.ERRORS.SET_ENCRYPT_SECRET,e.message);}}getEncryptSecrets(){return this.encryptSecrets}deleteEncryptSecrets(e){try{const t=gr.deleteEncryptSecrets(this.encryptSecrets,this.selectedSecretId,e);this.encryptSecrets=t.encryptSecrets,this.selectedSecretId=t.selectedSecretId,this.dispatchEncryptSecretEvent();}catch(e){Er.throwError(Lt.MESSAGING.ENCRYPTION.ERRORS.DELETE_ENCRYPT_SECRETS,e.message);}}setSelectedSecretId(e){try{this.selectedSecretId=gr.setSelectedSecretId(this.encryptSecrets,e),this.dispatchEncryptSecretEvent();}catch(e){Er.throwError(Lt.MESSAGING.ENCRYPTION.ERRORS.SET_SELECTED_SECRET,e.message);}}getSelectedSecretId(){return this.selectedSecretId}dispatchEncryptSecretEvent(){Vs(Re({room:this.room,encryptSecrets:this.encryptSecrets,selectedSecretId:this.selectedSecretId,peerInfo:jt(this.room),peerId:this.peerId}));}canEncrypt(e){try{return !!gr.utils.canEncrypt(this.selectedSecretId,this.encryptSecrets)&&(gr.utils.isValidString(this.selectedSecretId)&&gr.utils.isValidString(this.encryptSecrets[this.selectedSecretId]))}catch(t){if(e)throw new Error(t.message);return !1}}decryptStoredMessages(e,t){if(gr.utils.canEncrypt(t,this.encryptSecrets)&&!Object.keys(this.encryptSecrets).filter(e=>e===t).length)throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.SECRET_ID_NOT_FOUND);return this.decryptMessage(e,t)}decryptMessage(e,t=""){if(t&&gr.utils.canDecrypt(this.encryptSecrets))return gr.tryDecryptMessage(e,t,this.encryptSecrets);throw new Error(Lt.MESSAGING.ENCRYPTION.ERRORS.INVALID_SECRETS)}sendMessage(e,t,r,n=!1){const s=Os(e);if(Cs(t,"message","sendMessage")&&s)try{Ys.log.DEBUG([null,Ct.ASYNC_MESSAGING,null,Lt.MESSAGING.ENCRYPTION.SEND_MESSAGE]);const e=gr.getMessageConfig(s,r,this.encryptSecrets,this.selectedSecretId,n),i=gr.encryptMessage(t,this.encryptSecrets[this.selectedSecretId]);hr.sendMessageToSig(s,e,t,i,r);}catch(e){Er.throwError(Lt.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message);}}static deleteEncryptedInstance(e){delete mr[e.id];}}const Rr={getMessageConfig:(e,t)=>{const r=gr.getMessageConfig(e,t);return r.isPersistent=!0,r},parseDecryptedMessageData:(e,t)=>({targetPeerId:t,senderPeerId:e.mid,content:e.data,timeStamp:Us(e.timeStamp),isPrivate:!1,isDataChannel:!1})},Tr={};class Cr{constructor(e){const{user:t,room:r,hasPersistentMessage:n}=e;return Tr[r.id]||(Tr[r.id]=this),this.room=r,this.peerId=t.sid,this.isPersistent=n,this.hasPersistentMessage=n,Tr[r.id]}setMessagePersistence(e){if(!Rs(e))throw Er.throwError(Lt.MESSAGING.PERSISTENCE.ERRORS.FAILED_SETTING_PERSISTENCE,Lt.MESSAGING.PERSISTENCE.ERRORS.INVALID_TYPE);if(!this.hasPersistentMessage)throw this.isPersistent=e,Er.throwError(Lt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);this.isPersistent=e,Vs(Te({room:this.room,isPersistent:this.isPersistent,peerInfo:jt(this.room),peerId:this.peerId}));}getMessagePersistence(){return this.isPersistent}sendMessage(e,t,r){const n=Os(e),s=!r||Array.isArray(r)&&Ss(r);if(Cs(t,"message","sendMessage")&&n)try{Ys.log.DEBUG([null,Ct.ASYNC_MESSAGING,null,Lt.MESSAGING.PERSISTENCE.SEND_MESSAGE]);const i=new fr(n);if(!s)throw new Error(Lt.MESSAGING.PERSISTENCE.ERRORS.PRIVATE_MESSAGE);i.canEncrypt(!0)&&i.sendMessage(e,t,r,this.isPersistent);}catch(e){Er.throwError(Lt.MESSAGING.ERRORS.DROPPING_MESSAGE,e.message);}}getStoredMessages(){const e=Xi.getSkylinkState(this.room.id);this.hasPersistentMessage?(new zn).getStoredMessages(e):Ys.log.WARN([this.peerId,Ct.ASYNC_MESSAGING,null,`${Lt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED}`]);}canPersist(){if(this.hasPersistentMessage)return !!this.isPersistent||(Ys.log.DEBUG([null,Ct.ASYNC_MESSAGING,null,Lt.MESSAGING.PERSISTENCE.NOT_PERSISTED]),!1);if(this.isPersistent)throw Ys.log.DEBUG([null,Ct.ASYNC_MESSAGING,null,`${Lt.MESSAGING.PERSISTENCE.IS_PERSISTENT_CONFIG} ${this.isPersistent}`]),new Error(Lt.MESSAGING.PERSISTENCE.ERRORS.PERSISTENT_MESSAGE_FEATURE_NOT_ENABLED);return !1}static processStoredMessages(e){const t=Xi.getSkylinkState(e.rid),{room:r}=t,n=e.mid,s=JSON.parse(e.data),i=new fr(t),o=[];Ys.log.DEBUG([n,Ct.ASYNC_MESSAGING,null,Lt.MESSAGING.PERSISTENCE.STORED_MESSAGES],s);try{for(let e=0;e<s.length;e+=1)s[e].data=i.decryptStoredMessages(s[e].data,s[e].secretId),o.push(Rr.parseDecryptedMessageData(s[e],n));}catch(e){throw Er.throwError(Lt.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message)}Vs(fe({room:r,storedMessages:o,isSelf:!1,peerId:n,peerInfo:Qt.getPeerInfo(n,r)}));}static deleteAsyncInstance(e){delete Tr[e.id];}}class _r{static sendMessage(e,t,r){const n=Os(e);if(Cs(t,"message","sendMessage")&&n){const s=new fr(n),i=new Cr(n);i.canPersist()?i.sendMessage(e,t,r):s.canEncrypt()?s.sendMessage(e,t,r):hr.trySendMessage(n,t,r);}}static sendP2PMessage(e,t,r){const n=Os(e);Cs(t,"message","sendP2PMessage")&&n&&oi.sendP2PMessage(e,t,r);}static processMessage(e,t){const{mid:r,target:n,rid:s,secretId:i,data:o}=e,a=Xi.getSkylinkState(s),c=r;let d=o;if(i)try{d=new fr(a).decryptMessage(o,i);}catch(e){Er.throwError(Lt.MESSAGING.ENCRYPTION.ERRORS.FAILED_DECRYPTING_MESSAGE,e.message);}hr.dispatchOnIncomingMessage(a,{isPrivate:Rs(t)?!t:!!n},d,!1,c);}}const Ir=()=>{const e={fulfilled:!0,message:""},{AdapterJS:t,io:r,fetch:n}=window;return "function"!=typeof(t||window.AdapterJS||window.AdapterJS||{}).webRTCReady?(e.message=Lt.INIT.ERRORS.NO_ADAPTER,e.fulfilled=!1,e.readyStateChangeErrorCode=st.ADAPTER_NO_LOADED):r||window.io?n&&window.fetch||(e.message=Lt.INIT.ERRORS.NO_FETCH_SUPPORT,e.fulfilled=!1,e.readyStateChangeErrorCode=st.NO_XMLHTTPREQUEST_SUPPORT):(e.message=Lt.INIT.ERRORS.NO_SOCKET_IO,e.fulfilled=!1,e.readyStateChangeErrorCode=st.NO_SOCKET_IO),e.fulfilled||Ys.log.ERROR(["Validating Dependencies",null,null,e.message]),e},Or={udp:[3478,19302,19303,19304],tcp:[80,443],both:[19305,19306,19307,19308]},Ar={STUN:"stun",TURN:"turn",TEMASYS:"temasys",DEFAULT_TURN_SERVER:"turn.temasys.io",TCP:"TCP",UDP:"UDP"},vr=(e,t)=>{const{urls:r}=e;return [{urls:r,username:t.iceServers[1].username||null,credential:t.iceServers[1].credential||null}]},Dr=()=>Or;class yr extends er{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:!1,candidate_id:null,candidate_sdp_mid:null,candidate_sdp_mindex:null,candidate_candidate:null,error:null};}send(e,t,r,n,s,i){const o=Xi.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=r,this.model.client_id=o.clientId,this.model.state=t,this.model.is_remote=!!n,this.model.candidate_id=n||null,this.model.candidate_sdp_mid=s.sdpMid,this.model.candidate_sdp_mindex=s.sdpMLineIndex,this.model.candidate_candidate=s.candidate,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.error=("string"==typeof i?i:i&&i.message)||null,this.addToStatsBuffer("iceCandidate",this.model,this.endpoints.iceCandidate),this.manageStatsBuffer();}}const Nr=new yr,Pr=(e,t,r,n,s,i)=>{const{STATS_MODULE:o,ICE_CANDIDATE:a}=Lt,{CANDIDATE_PROCESSING_STATE:c,TAGS:d}=kt;Ys.log.ERROR([t,d.CANDIDATE_HANDLER,`${r}:${n}`,a.CANDIDATE_HANDLER.FAILED_ADDING_CANDIDATE],i),Vs(Ie({room:e,state:c.PROCESS_ERROR,peerId:t,candidateId:r,candidateType:n,candidate:s,error:i})),Nr.send(e.id,o.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,t,r,s,i);};const Mr=new class extends er{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,bundlePolicy:null,rtcpMuxPolicy:null};}send(e,t,r,n){const s=Xi.getSkylinkState(e);this.model.client_id=s.clientId,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=r,this.model.state=t,this.model.is_remote=n,this.model.bundlePolicy=s.peerConnectionConfig.bundlePolicy,this.model.rtcpMuxPolicy=s.peerConnectionConfig.rtcpMuxPolicy,this.addToStatsBuffer("iceGathering",this.model,this.endpoints.iceGathering),this.manageStatsBuffer();}},wr={setIceServers:e=>{const t=Xi.getInitOptions(),r={iceServerName:null,iceServerPorts:Dr(),iceServerProtocol:Ar.STUN,iceServers:[{urls:[]},{urls:[]}]},{iceServer:n,enableTURNServer:s,forceTURNSSL:i,TURNServerTransport:o,enableSTUNServer:a,usePublicSTUN:c}=t;if(e.forEach(e=>{if(0===e.url.indexOf(`${Ar.STUN}:`))e.url.indexOf(`${Ar.TEMASYS}`)>0?r.iceServerName=(e.url.split(":")[1]||"").split("?")[0]||null:r.iceServers[0].urls.push(e.url);else if(0===e.url.indexOf("turn:")&&e.url.indexOf("@")>0&&e.credential&&!r.iceServers[1].username&&!r.iceServers[1].credential){const t=(e.url.split(":")[1]||"").split("@");r.iceServerName=(t[1]||"").split("?")[0],r.iceServers[1].username=t[0],r.iceServers[1].credential=e.credential,r.iceServerProtocol=Ar.TURN;}}),n)return {iceServers:vr(n,r)};if(r.iceServerName=r.iceServerName||Ar.DEFAULT_TURN_SERVER,r.iceServerProtocol!==Ar.TURN||s||i){const e=(e=>{const{forceTURNSSL:t,CONSTANTS:r,serverConfig:n}=e,{AdapterJS:s}=window,i={tcp:n.iceServerPorts.tcp,udp:n.iceServerPorts.udp,both:n.iceServerPorts.both,iceServerProtocol:n.iceServerProtocol,iceServerPorts:n.iceServerPorts};return "edge"===s.webrtcDetectedBrowser?(i.tcp=[],i.udp=[3478],i.iceServerPorts.both=[],i.iceServerProtocol=r.TURN):t?"firefox"===s.webrtcDetectedBrowser&&s.webrtcDetectedVersion<53?(i.udp=[],i.tcp=[443],i.both=[],i.iceServerProtocol=r.TURN):(i.iceServerPorts.udp=[],i.iceServerProtocol="turns"):"firefox"===s.webrtcDetectedBrowser&&(i.udp=[3478],i.tcp=[443,80],i.both=[]),i})({forceTURNSSL:i,enableTURNServer:s,CONSTANTS:Ar,serverConfig:r});r.iceServerPorts.tcp=e.tcp,r.iceServerPorts.udp=e.udp,r.iceServerPorts.both=e.both,r.iceServerProtocol=e.iceServerProtocol;}else r.iceServerProtocol=Ar.STUN;const d=(e=>{const{TURNServerTransport:t,forceTURNSSL:r,udp:n,tcp:s,both:i}=e,o={udp:[],tcp:[],both:[]};return t!==ze.UDP||r?t===ze.TCP?(o.tcp=s.concat(i),o.udp=[],o.both=[]):t===ze.NONE?(o.tcp=[],o.udp=[]):(o.tcp=s,o.udp=n,o.both=i):(o.udp=n.concat(i),o.tcp=[],o.both=[]),o})({forceTURNSSL:i,TURNServerTransport:o,udp:r.iceServerPorts.udp,tcp:r.iceServerPorts.tcp,both:r.iceServerPorts.both});return r.iceServerPorts.tcp=d.tcp,r.iceServerPorts.udp=d.udp,r.iceServerPorts.both=d.both,r.iceServerProtocol===Ar.STUN&&(r.iceServerPorts.tcp=[]),r.iceServerProtocol!==Ar.STUN||a?(r.iceServerPorts.tcp.forEach(e=>{r.iceServers[1].urls.push(`${r.iceServerProtocol}:${r.iceServerName}:${e}?transport=tcp`);}),r.iceServerPorts.udp.forEach(e=>{r.iceServers[1].urls.push(`${r.iceServerProtocol}:${r.iceServerName}:${e}?transport=udp`);}),r.iceServerPorts.both.forEach(e=>{r.iceServers[1].urls.push(`${r.iceServerProtocol}:${r.iceServerName}:${e}`);}),c||r.iceServers.splice(0,1),{iceServers:r.iceServers}):(r.iceServers=[],null)},addIceCandidateFromQueue:(e,t)=>{const r=Xi.getSkylinkState(t.id),n=r.peerCandidatesQueue[e]||[],s=r.peerConnections[e],{AdapterJS:i}=window,{TAGS:o,PEER_CONNECTION_STATE:a}=kt;for(let t=0;t<n.length;t+=1){const c=n[t];if(c){const t=c[1],n=c[0],s=t.candidate.split(" ")[7];Ys.log.DEBUG([e,o.CANDIDATE_HANDLER,`${n}:${s}`,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.ADD_BUFFERED_CANDIDATE]),br.addIceCandidate(e,n,s,t,r);}else if(s&&s.signalingState!==a.CLOSED&&i&&As(i.VERSION,"0.14.0"))try{s.addIceCandidate(null),Ys.log.DEBUG([e,o.CANDIDATE_HANDLER,null,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.END_OF_CANDIDATES_SUCCESS]);}catch(t){Ys.log.DEBUG([e,o.CANDIDATE_HANDLER,null,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.END_OF_CANDIDATES_FAILURE]);}}delete r.peerCandidatesQueue[e],oi.signalingEndOfCandidates(e,r);},addIceCandidate:(e,t,r,n,s)=>{const i=Xi.getSkylinkState(s.room.id),{peerConnections:o,room:a}=i,c=o[e],d={candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex},{STATS_MODULE:l,ICE_CANDIDATE:p,PEER_CONNECTION:u}=Lt,{CANDIDATE_PROCESSING_STATE:S,PEER_CONNECTION_STATE:E,TAGS:h}=kt;Ys.log.DEBUG([e,h.CANDIDATE_HANDLER,`${t}:${r}`,p.CANDIDATE_HANDLER.ADDING_CANDIDATE]),Vs(Ie({peerId:e,room:a,candidateType:r,candidate:d,candidateId:t,state:S.PROCESSING,error:null})),Nr.send(a.id,l.HANDLE_ICE_GATHERING_STATS.PROCESSING,e,t,d),c&&c.signalingState!==E.CLOSED&&c.remoteDescription&&c.remoteDescription.sdp&&c.remoteDescription.sdp.indexOf(`\r\na=mid:${d.sdpMid}\r\n`)>-1||(Ys.log.WARN([e,h.CANDIDATE_HANDLER,`${t}:${r}`,`${p.CANDIDATE_HANDLER.DROPPING_CANDIDATE} - ${u.NO_PEER_CONNECTION}`]),Vs(Ie({peerId:e,room:s.room,candidateType:r,candidate:d,candidateId:t,state:Ke.DROPPED,error:new Error(u.NO_PEER_CONNECTION)})),Nr.send(a.id,l.HANDLE_ICE_GATHERING_STATS.PROCESS_FAILED,e,t,d,u.NO_PEER_CONNECTION));try{c.addIceCandidate(d).then(()=>{((e,t,r,n,s)=>{const{STATS_MODULE:i,ICE_CANDIDATE:o}=Lt,{CANDIDATE_PROCESSING_STATE:a,TAGS:c}=kt;Ys.log.INFO([t,c.CANDIDATE_HANDLER,`${r}:${n}`,o.CANDIDATE_HANDLER.CANDIDATE_ADDED]),Vs(Ie({room:e,state:a.PROCESS_SUCCESS,peerId:t,candidateId:r,candidateType:n,candidate:s,error:null})),Nr.send(e.id,i.HANDLE_ICE_GATHERING_STATS.PROCESS_SUCCESS,t,r,s);})(a,e,t,r,d);}).catch(n=>{Pr(a,e,t,r,d,n);});}catch(n){Pr.bind(c,a,e,t,r,d,n);}},onIceCandidate:(e,t,r)=>{const n=Xi.getSkylinkState(r.id),s=Xi.getInitOptions(),i=n.peerConnections[e],o=new zn;let a=n.gatheredCandidates[e];const{CANDIDATE_GENERATION_STATE:c,TAGS:d}=kt;if(!i)return Ys.log.WARN([e,d.CANDIDATE_HANDLER,null,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.no_peer_connection],t),null;if(t.candidate){i.gathering||(Ys.log.WARN([e,d.CANDIDATE_HANDLER,null,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.ICE_GATHERING_STARTED],t),i.gathering=!0,i.gathered=!1,Vs(Oe({room:r,peerId:e,state:We.GATHERING})),Mr.send(r.id,c.GATHERING,e,!1));const l=t.candidate.split(" ")[7];if(Ys.log.DEBUG([e,d.CANDIDATE_HANDLER,l,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.CANDIDATE_GENERATED],t),"endOfCandidates"===l||!(i&&i.localDescription&&i.localDescription.sdp&&i.localDescription.sdp.indexOf(`\r\na=mid:${t.sdpMid}\r\n`)>-1))return Ys.log.WARN([e,d.CANDIDATE_HANDLER,l,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.DROP_EOC],t),null;if(s.filterCandidatesType[l]){if(!n.hasMCU||!s.forceTURN)return Ys.log.WARN([e,d.CANDIDATE_HANDLER,l,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.FILTERED_CANDIDATE],t),null;Ys.log.WARN([e,d.CANDIDATE_HANDLER,l,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.FILTERING_FLAG_NOT_HONOURED],t);}a||(a={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),a.sending[l].push({sdpMid:t.sdpMid,sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),n.gatheredCandidates[e]=a,Xi.setSkylinkState(n,r.id),Ys.log.DEBUG([e,d.CANDIDATE_HANDLER,l,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.SENDING_CANDIDATE],t),o.sendCandidate(e,n,t);}else{if(Ys.log.INFO([e,d.CANDIDATE_HANDLER,null,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.ICE_GATHERING_COMPLETED]),i.gathered)return null;if(i.gathering=!1,i.gathered=!0,Vs(Oe({peerId:e,state:We.COMPLETED,room:r})),Mr.send(r.id,c.COMPLETED,e,!1),n.gatheredCandidates[e]){setTimeout(()=>{n.gatheredCandidates[e]&&o.sendMessage({type:ht.END_OF_CANDIDATES,noOfExpectedCandidates:n.gatheredCandidates[e].sending.srflx.length+n.gatheredCandidates[e].sending.host.length+n.gatheredCandidates[e].sending.relay.length,mid:n.user.sid,target:e,rid:r.id});},6e3);}}return null},addIceCandidateToQueue:(e,t,r,n,s)=>{const{STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:i}}=Lt,o=s,{room:a}=o,c=new yr;Ys.log.DEBUG([e,Ct.CANDIDATE_HANDLER,`${t}:${r}`,Lt.ICE_CANDIDATE.CANDIDATE_HANDLER.ADD_CANDIDATE_TO_BUFFER]),c.send(a.id,i.BUFFERED,e,t,n),Vs(Ie({room:a,state:Ke.BUFFERED,peerId:e,candidateId:t,candidateType:r,candidate:n.candidate,error:null})),o.peerCandidatesQueue[e]=o.peerCandidatesQueue[e]||[],o.peerCandidatesQueue[e].push([t,n]),Xi.setSkylinkState(o,a.id);}};class br{static setIceServers(e){return wr.setIceServers(e)}static addIceCandidateFromQueue(e,t){return wr.addIceCandidateFromQueue(e,t)}static addIceCandidateToQueue(e,t,r,n,s){return wr.addIceCandidateToQueue(e,t,r,n,s)}static addIceCandidate(e,t,r,n,s){return wr.addIceCandidate(e,t,r,n,s)}static onIceCandidate(e,t,r){return wr.onIceCandidate(e,t,r)}}const kr={enterAndWelcome:e=>{const t=Xi.getSkylinkState(e.rid),r={},{hasMCU:n}=t,{rid:s,mid:i,enableIceRestart:o,enableDataChannel:a,weight:c,receiveOnly:d,publishOnly:l,agent:p,os:u,temasysPluginVersion:S,SMProtocolVersion:E,DTProtocolVersion:h,version:g,parentId:m,publisherId:f}=e;return r.publisherId=f||null,r.rid=s,r.mid=i,r.agent=p&&Ts(p)?p:"other",r.version=(e=>{if(!e||"string"!=typeof e)return 0;if(e.indexOf(".")>-1){const t=e.split(".");if(t.length>2){const e=t[0]||"0";return t.splice(0,1),parseFloat(`${e}.${t.join("0")}`,10)}return parseFloat(e||"0",10)}return parseInt(e||"0",10)})(g),r.SMProtocolVersion=Ts(E)?E:ct,r.DTProtocolVersion=Ts(h)?h:n||i===Nt.MCU?He:"0.1.0",r.weight=ms(c)?c:0,r.receiveOnly=d&&!1!==d,r.enableDataChannel=!Rs(a)||a,r.enableIceRestart=!!Rs(o)&&o,r.os=u&&Ts(u)?u:null,r.temasysPluginVersion=S&&Ts(S)?S:null,r.publishOnly=!!l,r.parentId=l&&m&&Ts(m)?m:null,r.userInfo=kr.parseUserInfo(t,e,r),n&&(r.peersInRoom=e.peersInRoom),Ut(r)},parseUserInfo:(e,t,r)=>{const n=Object.assign({},t.userInfo);return n.config=n.config?n.config:{enableDataChannel:r.enableDataChannel,enableIceRestart:r.enableIceRestart,priorityWeight:r.weight,receiveOnly:r.receiveOnly,publishOnly:r.publishOnly},n.agent=n.agent?n.agent:{name:r.agent,version:r.version,os:r.os,pluginVersion:r.temasysPluginVersion,SMProtocolVersion:r.SMProtocolVersion,DTProtocolVersion:r.DTProtocolVersion},n.settings=n.settings?n.settings:{},n.mediaStatus=n.mediaStatus?n.mediaStatus:{},n}},Lr=(e,t,r)=>{const{room:n}=e;e.peerInformations[t]=oi.buildPeerInformations(r,e),Xi.setSkylinkState(e,n.id);},Ur=e=>{const{currentRoom:t,targetMid:r,cert:n,userInfo:s,message:i,caller:o}=e;let a=!1;const c=Xi.getSkylinkState(t.id),{hasMCU:d}=c,{peerInformations:l}=c;if(!l[r]&&!d||d&&r===Nt.MCU&&!l.MCU){const e=!!s.screenshare;a=!0,c.peerInformations[r]=oi.buildPeerInformations(i.userInfo,c);const o={agent:s.agent.name,version:s.agent.version,os:s.agent.os};Xi.setSkylinkState(c,t.id),oi.addPeer({currentRoom:t,targetMid:r,peerBrowser:o,cert:n,receiveOnly:i.receiveOnly,hasScreenshare:e}),r===Nt.MCU?(Ys.log.INFO([r,"RTCPeerConnection",null,"MCU feature has been enabled"]),c.hasMCU=!0,Vs(((e={})=>new pe("serverPeerJoined",{detail:e}))({peerId:r,serverPeerType:Xe.MCU,room:t}))):Vs(De({peerId:r,peerInfo:Qt.getPeerInfo(r,t),isSelf:!1,room:t}));}if(c.peerMessagesStamps[r]=c.peerMessagesStamps[r]||{userData:0,audioMuted:0,videoMuted:0},o===xr.WELCOME&&(c.peerMessagesStamps[r].hasWelcome=!1),o===xr.WELCOME&&d&&Array.isArray(i.peersInRoom)&&i.peersInRoom.length){const e=c.user.sid;for(let r=0;r<i.peersInRoom.length;r+=1){const n=i.peersInRoom[r].mid;if(n!==e){const e=kr.enterAndWelcome(i.peersInRoom[r]).userInfo;Lr(c,n,e),Vs(De({peerId:n,peerInfo:Qt.getPeerInfo(n,t),isSelf:!1,room:t}));}}}else d&&r!==c.user.sid&&r!==Nt.MCU&&(Lr(c,r,s),Vs(De({peerId:r,peerInfo:Qt.getPeerInfo(r,t),isSelf:!1,room:t})));Xi.setSkylinkState(c,t.id),a&&Vs(Ce({peerId:r,state:et.WELCOME,error:null,room:t}));};const Gr=new class extends er{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,is_remote:null,weight:null,sdp_type:null,sdp_sdp:null,error:null};}send(e,t,r,n,s,i){const o=Xi.getSkylinkState(e);this.model.client_id=o.clientId,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.sid||null,this.model.peer_id=r,this.model.state=t,this.model.is_remote=s,this.model.weight=n.weight||null,this.model.error=("string"==typeof i?i:i&&i.msg)||null,this.model.sdp_type=null,this.model.sdp_sdp=null,-1===["enter","welcome"].indexOf(this.model.state)&&(this.model.weight=this.model.is_remote&&Qt.getPeerInfo(this.model.peer_id,o.room).config&&Qt.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight?Qt.getPeerInfo(this.model.peer_id,o.room).config.priorityWeight:Qt.getCurrentSessionInfo(o.room).config.priorityWeight,this.model.sdp_type=n&&n.type||null,this.model.sdp_sdp=n&&n.sdp||null),this.addToStatsBuffer("negotiation",this.model,this.endpoints.negotiation),this.manageStatsBuffer();}},xr={ENTER:"enterHandler",WELCOME:"welcomeHander"},Br=e=>{const{currentRoom:t,targetMid:r,message:n}=e,s=Xi.getSkylinkState(t.id),{peerConnections:i,hasMCU:o}=s,{STATS_MODULE:a,NEGOTIATION_PROGRESS:c}=Lt,d=new zn,l=(e=>{let t="welcome";if(e.caller===xr.WELCOME){const r=Xi.getSkylinkState(e.currentRoom.id),{peerMessagesStamps:n,peerPriorityWeight:s,hasMCU:i}=r;(i||s>e.message.weight)&&(n[e.targetMid].hasWelcome?(t="noop",Ys.log.WARN([e.targetMid,"RTCPeerConnection",null,'Discarding extra "welcome" received.'])):(t="offer",r.peerMessagesStamps[e.targetMid].hasWelcome=!0,Xi.setSkylinkState(r,e.currentRoom.id)));}return t})(e);if("offer"===l){if(!i[r])return Ys.log.WARN([r,"RTCSessionDescription","offer",c.ERRORS.no_peer_connection]),Gr.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,r,n,!1,c.ERRORS.no_peer_connection),null;const{signalingState:s}=i[r];if(s!==Ye.STABLE)return Ys.log.WARN([r,"RTCSessionDescription","offer",c.ERRORS.NOT_STABLE],s),Gr.send(t.id,a.HANDLE_NEGOTIATION_STATS.OFFER.dropped,r,n,!1,c.ERRORS.NOT_STABLE),null;d[l](e.currentRoom,e.targetMid);}else o||d[l](e.currentRoom,e.targetMid);},Fr=(e,t)=>{const r=kr.enterAndWelcome(e),{rid:n,mid:s,userInfo:i,publisherId:o}=r,a=Xi.getSkylinkState(n),{hasMCU:c}=a,d=c&&o?o:s,{RTCPeerConnection:l}=window;((e,t,r,n)=>{const{room:s}=r;let i="enter";e===xr.WELCOME&&(i="welcome"),Ys.log.INFO([t,"RTCPeerConnection",null,`Peer ${i} received ->`],n),Gr.send(s.id,i,t,n,!0);})(t,d,a,r);let p="enter";if(t===xr.WELCOME&&(p="welcome"),d!==Nt.MCU&&c&&a.publishOnly)return void Ys.log.WARN([d,"RTCPeerConnection",null,`Discarding ${p} for publishOnly case -> `],e);const u={currentRoom:a.room,targetMid:d,userInfo:i,message:r,caller:t};if(a.peerConnectionConfig.certificate!==Ze.AUTO&&"function"==typeof l.generateCertificate){let e={};e=a.peerConnectionConfig.certificate===Ze.ECDSA?{name:"ECDSA",namedCurve:"P-256"}:{name:"RSASSA-PKCS1-v1_5",modulusLength:2048,publicExponent:new Uint8Array([1,0,1]),hash:"SHA-256"},l.generateCertificate(e).then(e=>{u.cert=e,Ur(u),Br(u);});}else Ur(u),Br(u);},Vr=(e,t,r,n)=>{const{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:s}}=Lt,{peerConnections:i,bufferedLocalOffer:o,room:a}=e,c=i[t],d="offer"===r.type?"OFFER":"ANSWER";Gr.send(a.id,s[d].set,t,r,n),n&&Vs(Ce({state:et[d],peerId:t,room:a})),n?("offer"===r.type?c.setOffer="remote":c.setAnswer="remote",br.addIceCandidateFromQueue(t,a)):(o[t]=null,"offer"===r.type?c.setOffer="local":c.setAnswer="local"),Xi.setSkylinkState(e,a.id);},jr=(e,t,r,n,s)=>{const{room:i,user:o}=e,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:a}}=Lt,c="offer"===r.type?"OFFER":"ANSWER";Gr.send(i.id,a[c].set_error,t,r,n,s),Vs(Ce({state:et.ERROR,peerId:n?t:o.sid,error:s,room:i}));},Hr=(e,t,r)=>{const n=Xi.getSkylinkState(e.id),{peerConnections:s}=n,{type:i}=r,o=s[t],{STATS_MODULE:a}=Lt,c="offer"===i?"OFFER":"ANSWER";return o.processingLocalSDP=!0,Gr.send(e.id,a.HANDLE_NEGOTIATION_STATS[c][i],t,r,!1),o.setLocalDescription(r).then(()=>o)},Wr=(e,t,r,n)=>{const s=Xi.getSkylinkState(t.id),{peerConnections:i}=s,{NEGOTIATION_PROGRESS:o}=Lt,a=i[r]=e;Ys.log.DEBUG([r,Ct.SESSION_DESCRIPTION,n.type,o.SET_LOCAL_DESCRIPTION],n),a.processingLocalSDP=!1,Vr(s,r,n,!1);},Kr=(e,t,r,n)=>{const s=Xi.getSkylinkState(e.id),{peerConnections:i}=s,o=i[t],{NEGOTIATION_PROGRESS:a}=Lt;Ys.log.ERROR([t,Ct.SESSION_DESCRIPTION,r.type,a.FAILED_SET_LOCAL_DESCRIPTION],n),o.processingLocalSDP=!1,o.negotiating=!1,jr(s,t,r,!1,n);},$r=(e,t,r)=>{const n=Xi.getSkylinkState(e.id),{peerConnections:s}=n,{type:i}=r,{STATS_MODULE:o,NEGOTIATION_PROGRESS:a}=Lt,c=s[t],d="offer"===i?"OFFER":"ANSWER";c.processingRemoteSDP=!0,Gr.send(e.id,o.HANDLE_NEGOTIATION_STATS[d][i],t,r,!0);const l=((e,t,r)=>{const n=t;return n.sdp=Zs.setSDPBitrate(e,n,r),n})(t,r,e.id);return c.setRemoteDescription(l).then(()=>c)},zr=(e,t,r)=>{const n=e;n.peerConnections[t].negotiating=!1,Xi.setSkylinkState(n,t),(new zn).answerAck(e,t,r);},Yr=(e,t,r,n)=>{const s=new zn,{type:i}=n,{NEGOTIATION_PROGRESS:o,DATA_CHANNEL:a}=Lt,c=Xi.getSkylinkState(t.id),{peerConnections:d}=c,l=d[r]=e;return Ys.log.DEBUG([r,Ct.SESSION_DESCRIPTION,i,o.SET_REMOTE_DESCRIPTION],n),l.processingRemoteSDP=!1,"offer"===i?(Vr(c,r,n,!0),s.answer(c,r)):(c.peerMessagesStamps[r]&&(c.peerMessagesStamps[r].hasRestart=!1),c.dataChannels[r]&&(-1===l.remoteDescription.sdp.indexOf("m=application")||l.remoteDescription.sdp.indexOf("m=application 0")>0)&&(Ys.log.WARN([r,Ct.PEER_CONNECTION,null,`${a.CLOSING} - ${a.NO_REMOTE_DATA_CHANNEL}`]),oi.closeDataChannel(c,r)),Vr(c,r,n,!0),zr(c,r,!0),!0)},Jr=(e,t,r,n)=>{const s=Xi.getSkylinkState(e.id),{peerConnections:i}=s,o=i[t],{type:a}=r;Ys.log.ERROR([t,Ct.SESSION_DESCRIPTION,a,`${Lt.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_DESCRIPTION} ->`],{error:n,state:o.signalingState,[a]:r}),o.processingRemoteSDP=!1,o.negotiating=!1,jr(s,t,r,!0,n),"answer"===a&&zr(s,t,!1);},Xr=e=>{const{rid:t,mid:r,type:n,sdp:s,mediaInfoList:i}=e,o=Xi.getSkylinkState(t),{hasMCU:a,room:c,bufferedLocalOffer:d}=o,l=r,p="offer"===n?"OFFER":"ANSWER",{NEGOTIATION_PROGRESS:u}=Lt;if(Ys.log.INFO([l,null,n,`Received ${n} from peer. ${p}:`],e),((e,t)=>{const{weight:r,type:n,mid:s,sdp:i,resend:o}=t,{peerPriorityWeight:a,bufferedLocalOffer:c,room:d,peerConnections:l}=e,p=s,{processingRemoteSDP:u,processingLocalSDP:S,negotiating:E}=l[p],{STATS_MODULE:h,NEGOTIATION_PROGRESS:g,NO_PEER_CONNECTION:m}=Lt,f="offer"===n?"OFFER":"ANSWER";let R=null;if(l[p]||(Ys.log.ERROR([p,null,n,`${m.NO_PEER_CONNECTION}. Unable to set${"offer"===n?"Remote":"Local"}Offer.`]),R=m.NO_PEER_CONNECTION),"offer"===n&&l[p].signalingState!==Ye.STABLE&&(Ys.log.WARN([p,null,n,g.ERRORS.NOT_STABLE],{signalingState:l[p].signalingState,isRestart:!!o}),R=`Peer connection state is ${l[p].signalingState}.`),"offer"===n&&c[p]&&a>r&&(Ys.log.WARN([p,null,n,g.ERRORS.OFFER_TIEBREAKER],{selfWeight:a,messageWeight:r}),R=g.ERRORS.OFFER_TIEBREAKER),u)Ys.log.WARN([p,Ct.SESSION_DESCRIPTION,n,g.ERRORS.PROCESSING_EXISTING_SDP],i),R=g.ERRORS.PROCESSING_EXISTING_SDP;else if(!S&&!u&&E&&"offer"===n){const r=e;Ys.log.DEBUG([p,Ct.SESSION_DESCRIPTION,n,g.ERRORS.ADDING_REMOTE_OFFER_TO_BUFFER],t),r.bufferedRemoteOffers[p]=r.bufferedRemoteOffers[p]?r.bufferedRemoteOffers[p]:[],r.bufferedRemoteOffers[p].push(t),Xi.setSkylinkState(r,d.id);}return R&&Gr.send(d.id,h.HANDLE_NEGOTIATION_STATS[f].dropped,p,t,!0,R),!R})(o,e))try{if(((e,t)=>{const r=e,{userInfo:n,rid:s,mid:i}=t,o=n,a=i;n&&"object"==typeof n&&(o.settings.data=!!(r.dataChannels[a]&&r.dataChannels[a].main&&r.dataChannels[a].main.channel&&r.dataChannels[a].main.channel.readyState===Be.OPEN),r.peerInformations[a].settings=o.settings||{},r.peerInformations[a].mediaStatus=o.mediaStatus||{},r.peerInformations[a].userData=o.userData),r.peerConnections[a].negotiating=!0,Xi.setSkylinkState(r,s);})(o,e),Jn.setPeerMediaInfo(c,l,i),Jn.deleteUnavailableMedia(c,l),"offer"===n){let e=null;const t={type:n,sdp:a?s.replace(/\r\n/g,"\n").split("\n").join("\r\n"):s};$r(c,l,t).then(e=>Yr(e,c,l,t)).catch(e=>Jr(c,l,t,e)).then(t=>(e={type:t.type,sdp:t.sdp},Hr(c,l,e))).then(t=>Wr(t,c,l,e)).catch(t=>Kr(c,l,e,t));}else if(d[l]){const e=d[l],t={type:n,sdp:a?s.replace(/\r\n/g,"\n").split("\n").join("\r\n"):s};Hr(c,l,e).then(t=>Wr(t,c,l,e)).catch(t=>Kr(c,l,e,t)).then(()=>$r(c,l,t)).then(e=>Yr(e,c,l,t)).catch(e=>Jr(c,l,t,e));}else Ys.log.ERROR([l,Ct.PEER_CONNECTION,null,u.ERRORS.NO_LOCAL_BUFFERED_OFFER]);}catch(e){Ys.log.ERROR([l,Ct.SESSION_DESCRIPTION,n,`Failed processing ${p} ->`],e);}return null},Qr=(e,t,r)=>{const n={};return n.listOfPeers=e,n.refreshErrors=t,n.refreshSettings=r,n},qr=(e,t,r)=>{const n=[];return Object.keys(e).forEach(s=>{n.push(((e,t,r,n)=>{const s=Xi.getSkylinkState(t.id),{hasMCU:i,peerInformations:o,enableIceRestart:a}=s,c=Qt.getPeersCustomSettings(s),d={};return d[e]={iceRestart:!i&&o[e]&&o[e].config&&o[e].config.enableIceRestart&&a&&r,customSettings:c[e]||{}},n&&(d.errors=n),d})(e[s],t,r));}),n},Zr=(e,t)=>{const r={};return r[e]=t,r},en=(e,t,r,n)=>new Promise((s,i)=>{e||i(new Error(Lt.ROOM_STATE.NO_ROOM_NAME));const{peerConnections:o,hasMCU:a,room:c}=e,d=Xi.getInitOptions(),{mcuUseRenegoRestart:l}=d,{PEER_CONNECTION:p}=Lt,u=((e,t,r,n)=>{let s=!1,i={},o=Object.keys(n);return Array.isArray(e)?o=e:Ts(e)?o=[e]:Rs(e)?s=e:e&&hs(e)&&(i=e),Rs(t)?s=t:t&&hs(t)&&(i=t),r&&hs(r)&&(i=r),{listOfPeers:o,doIceRestart:s,bwOptions:i}})(t,r,n,o),{listOfPeers:S,doIceRestart:E,bwOptions:h}=u;try{!Ss(S)||a&&!l||(Ys.log.ERROR(p.refresh_no_peer_connection),i({refreshErrors:{self:p.refresh_no_peer_connection},listOfPeers:S})),Ys.log.INFO([null,"PeerConnection",null,p.refresh_start]),oi.refreshPeerConnection(S,e,E,h).then(e=>{const t=a?[e]:e,r=[];for(let e=0;e<t.length;e+=1)if(Array.isArray(t[e])){const n=t[e];r.push(Zr(n[0],n[1])),Ys.log.WARN([S,"PeerConnection",null,p.refresh_peer_failed],n[0]);}else"string"==typeof t[e]&&Ys.log.INFO([S,"PeerConnection",null,p.refresh_peer_success],t[e]);r.length===S.length?i(Qr(S,r,qr(S,c,E))):s(Qr(S,r,qr(S,c,E)));}).catch(e=>Ys.log.ERROR([null,"RTCPeerConnection",null,p.refresh_failed],e)).finally(()=>Ys.log.INFO(p.refresh_completed));}catch(e){i(e);}});class tn extends er{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,contents:null};}send(e,t){const r=Xi.getSkylinkState(e);this.model.room_id=e,this.model.user_id=r&&r.user&&r.user.sid||null,this.model.client_id=r.clientId,this.model.state=t.type,this.model.contents=t,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.session,this.model);}}class rn extends er{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,local_candidate:{},remote_candidate:{}};}send(e,t,r){try{const n=Xi.getSkylinkState(e);if(!n)return;this.model.room_id=e,this.model.user_id=n&&n.user&&n.user.sid||null,this.model.peer_id=r,this.model.client_id=n.clientId,this.model.state=t,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),oi.retrieveStatistics(e,r,Xi.getInitOptions().beSilentOnStatsLogs).then(e=>{e&&["local","remote"].forEach(t=>{const r=e.selectedCandidatePair[t];if(r){const e=this.model[`${t}_candidate`];e.ip_address=r.ipAddress||null,e.port_number=r.portNumber||null,e.candidate_type=r.candidateType||null,e.protocol=r.transport||null,e.priority=r.priority||null,"local"===t&&(this.model.local_candidate.network_type=r.networkType||null);}}),this.postStats(this.endpoints.iceConnection,this.model);}).catch(e=>{Ys.log.DEBUG(Lt.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.RETRIEVE_FAILED,e);});}catch(e){Ys.log.DEBUG(Lt.STATS_MODULE.HANDLE_ICE_CONNECTION_STATS.SEND_FAILED,e);}}}const nn=(e,t)=>{const r=Xi.getSkylinkState(e);r.peerConnections[t].signalingState!==Ye.CLOSED&&(r.peerConnections[t].close(),ks(yt.SAFARI)&&Ls(11)&&(((e,t)=>{const r=e;r.peerConnections[t].signalingStateClosed||(r.peerConnections[t].signalingStateClosed=!0,Vs(Me({peerId:t,state:Ye.CLOSED})));})(r,t),((e,t)=>{const r=e;r.peerConnections[t].iceConnectionStateClosed||(r.peerConnections[t].iceConnectionStateClosed=!0,(new rn).send(r.room.id,t,e),Vs(Ae({peerId:t,state:$e.CLOSED})));})(r,t)));},sn=(e,t)=>{const r=Xi.getSkylinkState(e);if(!((e,t)=>{const r=e;return !!r&&(!(!r.peerConnections[t]&&!r.peerInformations[t])||(Ys.log.DEBUG([t,Ct.PEER_CONNECTION,null,`${Lt.ROOM.LEAVE_ROOM.DROPPING_HANGUP} - ${Lt.PEER_CONNECTION.NO_PEER_CONNECTION}`]),!1))})(r,t))return;const{room:n}=r,s=Qt.getPeerInfo(t,n);if(t===Nt.MCU){const e=r;return Vs(Ne({peerId:t,serverPeerType:Xe.MCU,room:n})),e.hasMCU=!1,void Xi.setSkylinkState(e,n.id)}Vs(ye({peerId:t,peerInfo:s,isSelf:!1,room:n}));},on=(e,t,r,n,s)=>{const i=Xi.getSkylinkState(r.room.id),{peerConnections:o,peerConnectionConfig:a,bufferedLocalOffer:c,peerPriorityWeight:d,room:l}=i,{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:p}}=Lt,{AdapterJS:u}=window,S=o[t],E={type:n.type,sdp:n.sdp};if(S.processingLocalSDP=!0,"firefox"===u.webrtcDetectedBrowser&&(Zs.setOriginalDTLSRole(i,E,!1),E.sdp=Zs.modifyDTLSRole(i,n)),a.disableBundle&&(E.sdp=E.sdp.replace(/a=group:BUNDLE.*\r\n/gi,"")),Ys.log.INFO([t,"RTCSessionDescription",n.type,"Local session description updated ->"],E.sdp),n.type===et.OFFER){Gr.send(l.id,p.OFFER.offer,t,n,!1),Ys.log.INFO([t,"RTCSessionDescription",n.type,"Local offer saved."]),c[t]=n;const o={type:E.type,sdp:E.sdp,mid:i.user.sid,target:t,rid:r.room.id,userInfo:Qt.getUserInfo(r.room),weight:d,mediaInfoList:Jn.retrieveMediaInfoForOfferAnswer(l,E)};if(s&&Object.keys(s).length){const e=Object.keys(s),t=Object.keys(o);for(let r=0;r<e.length;r+=1){const n=e[r];-1===t.indexOf(n)&&(o[n]=s[n]);}}e(o);}else{Gr.send(l.id,p.ANSWER.answer,t,n,!1),e({type:E.type,sdp:E.sdp,mid:i.user.sid,target:t,rid:r.room.id,userInfo:Qt.getUserInfo(r.room),mediaInfoList:Jn.retrieveMediaInfoForOfferAnswer(l,E)});}},{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:an}}=Lt,cn=e=>{let t=null;const{currentRoom:r,targetMid:n,cert:s,hasScreenShare:i}=e,o=Xi.getInitOptions(),{filterCandidatesType:a}=o,c=Xi.getSkylinkState(r.id),{peerConnectionConfig:d,room:l}=c,p={iceServers:c.room.connection.peerConfig.iceServers,iceTransportPolicy:a.host&&a.srflx&&!a.relay?"relay":"all",bundlePolicy:d.bundlePolicy===Qe.NONE?Qe.BALANCED:d.bundlePolicy,rtcpMuxPolicy:d.rtcpMuxPolicy,iceCandidatePoolSize:d.iceCandidatePoolSize},u={optional:[{DtlsSrtpKeyAgreement:!0},{googIPv6:!0}]};s&&(p.certificates=[s]),c.peerConnStatus[n]&&(c.peerConnStatus[n].constraints=p,c.peerConnStatus[n].optional=u),Xi.setSkylinkState(c,r.id);try{t=((e,t,r,n,s)=>{const i=Xi.getInitOptions(),o=Xi.getSkylinkState(s.id),{AdapterJS:a}=window;Ys.log.DEBUG([e,"RTCPeerConnection",null,"Creating peer connection ->"],{constraints:t,optional:r});const{RTCPeerConnection:c,msRTCPeerConnection:d}=window,l=new(i.useEdgeWebRTC&&d?window.msRTCPeerConnection:c)(t,r),p=[l,e,o];return l.setOffer="",l.setAnswer="",l.negotiating=!1,l.hasStream=!1,l.hasMainChannel=!1,l.firefoxStreamId="",l.processingLocalSDP=!1,l.processingRemoteSDP=!1,l.gathered=!1,l.gathering=!1,l.localStream=null,l.localStreamId=null,l.iceConnectionStateClosed=!1,l.signalingStateClosed=!1,o.gatheredCandidates[e]={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}},o.peerEndOfCandidatesCounter[e]=o.peerEndOfCandidatesCounter[e]||{},o.sdpSessions[e]={local:{},remote:{}},o.peerBandwidth[e]={},e===Nt.MCU&&(Ys.log.INFO("Creating an empty transceiver of kind video with MCU"),"function"==typeof l.addTransceiver&&l.addTransceiver("video")),Xi.setSkylinkState(o,s.id),"firefox"===a.webrtcDetectedBrowser&&(l.removeStream=(e=>{const{getSenders:t,removeTrack:r}=e;return e=>{const{getTracks:n}=e,s=t();for(let e=0;e<s.length;e+=1){const t=n();for(let n=0;n<t.length;n+=1)t[n]===s[e].track&&r(s[e]);}}})(l)),l.ontrack=Dn.ontrack.bind(l,...p),l.ondatachannel=Dn.ondatachannel.bind(l,...p),l.onicecandidate=Dn.onicecandidate.bind(l,...p),l.oniceconnectionstatechange=Dn.oniceconnectionstatechange.bind(l,...p),l.onsignalingstatechange=Dn.onsignalingstatechange.bind(l,...p),l.onicegatheringstatechange=Dn.onicegatheringstatechange.bind(l,...p),a.webrtcDetectedBrowser===yt.REACT_NATIVE&&(l.onsenderadded=Dn.onsenderadded.bind(l,...p),l.onremovetrack=Dn.onremovetrack.bind(l,e,o.room,!1)),l})(n,p,u,0,r);}catch(e){Ys.log.ERROR([n,null,null,"Failed creating peer connection:"],e),t=null,Vs(Ce({state:et.ERROR,peerId:n,error:e,room:l}));}return t},{STATS_MODULE:{HANDLE_NEGOTIATION_STATS:dn}}=Lt,ln=(e,t,r,n,s)=>{const i=Xi.getSkylinkState(e.room.id),o=i.peerConnections[t],a=i.dataChannels[t];let c=n;if(c&&c!==t||(c="main"),!("object"==typeof r&&r||r&&"string"==typeof r))return Ys.log.WARN([t,"RTCDataChannel",c,"Dropping invalid data ->"],r),null;if(!o||o.signalingState===Ye.CLOSED)return Ys.log.WARN([t,"RTCDataChannel",c,"Dropping for sending message as Peer connection does not exists or is closed ->"],r),null;if(!a||!a[c])return Ys.log.WARN([t,"RTCDataChannel",c,"Dropping for sending message as Datachannel connection does not exists ->"],r),null;const d=a[c].channelName,l=a[c].channelType,p=a[c].channel.readyState,u="object"==typeof r&&r.type===Et.MESSAGE?Ve.MESSAGE:Ve.TRANSFER;if(p!==Be.OPEN){const e=new Error(`Failed sending message as Datachannel connection state is not opened. Current readyState is ${p}`);throw Ys.log.ERROR([t,"RTCDataChannel",c,e],r),Vs(ge({peerId:t,channelName:d,channelType:l,messageType:u,error:e,state:Be.SEND_MESSAGE_ERROR,bufferAmount:oi.getDataChannelBuffer(a[c].channel)})),e}try{s||"object"!=typeof r?(Ys.log.DEBUG([t,"RTCDataChannel",c,"Sending data with size ->"],r.size||r.length||r.byteLength),a[c].channel.send(r)):(Ys.log.DEBUG([t,"RTCDataChannel",c,`Sending ${r.type} protocol message ->`],r),a[c].channel.send(JSON.stringify(r)));}catch(e){throw Ys.log.ERROR([t,"RTCDataChannel",c,"Failed sending data)"],{error:e,data:r}),Vs(ge({peerId:t,channelName:d,channelType:l,messageType:u,error:e,state:Be.SEND_MESSAGE_ERROR,bufferAmount:oi.getDataChannelBuffer(a[c].channel)})),e}return null},pn=(e,t,r,n,s)=>{const i=Xi.getSkylinkState(e.room.id);let o=null,a=null,c=!1;const d=s===Fe.MESSAGING?"main":n,l=i.dataChannels[r]||{};if(!l.hasOwnProperty(d)||"object"!=typeof l[d])return null;if(o=l[d].transferId,(a=l[d].streamId)&&i.dataStreams[a]&&(c="string"===i.dataStreams[a].sessionChunkType?"string"==typeof t:"object"==typeof t),!i.peerConnections[r])return Ys.log.WARN([r,"RTCDataChannel",d,"Dropping data received from Peer as connection is not present ->"],t),null;if(!i.dataChannels[r]||!i.dataChannels[r][d])return Ys.log.WARN([r,"RTCDataChannel",d,"Dropping data received from Peer as Datachannel connection is not present ->"],t),null;if("string"==typeof t)try{const n=JSON.parse(t);if(c=!1,Ys.log.DEBUG([r,"RTCDataChannel",d,`Received protocol ${n.type} message ->`],n),[Et.ACK,Et.ERROR,Et.CANCEL].indexOf(n.type)>-1&&!(o&&i.dataTransfers[o]&&i.dataTransfers[o].sessions[r]))return Ys.log.WARN([r,"RTCDataChannel",d,"Discarded protocol message as data transfer session is not present ->"],n),null;switch(n.type){case Et.WRQ:if(o&&i.dataTransfers[o]&&i.dataTransfers[o].sessions[r]){Ys.log.WARN([r,"RTCDataChannel",d,"Rejecting bidirectional data transfer request as it is currently not supported in the SDK ->"],n),ln(e,r,{type:Et.ACK,ackN:-1,sender:i.user.sid},d);break}break;case Et.MESSAGE:((e,t,r,n)=>{const s=r.sender||t;Ys.log.INFO([s,"RTCDataChannel",n,"Received P2P message from peer:"],r),Vs(me({room:e.room,message:{targetPeerId:r.target,content:r.data,senderPeerId:s,isDataChannel:!0,isPrivate:r.isPrivate},isSelf:!1,peerId:s,peerInfo:Qt.getPeerInfo(s,e.room)}));})(i,r,n,d);break;default:Ys.log.WARN([r,"RTCDataChannel",d,`Discarded unknown ${n.type} message ->`],n);}}catch(e){Vs(ge({peerId:r,channelName:n,channelType:s,error:e,state:Be.ERROR,bufferAmount:oi.getDataChannelBuffer(i.dataChannels[r][d].channel)}));}return null};class un extends er{constructor(){super();const{AdapterJS:e}=window;this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,state:null,channel_id:null,channel_label:null,channel_type:null,channel_binary_type:null,error:null,agent_name:e.webrtcDetectedBrowser,agent_type:e.webrtcDetectedType,agent_version:e.webrtcDetectedVersion};}send(e,t,r,n,s,i){const o=Xi.getSkylinkState(e);this.model.room_id=e,this.model.user_id=o&&o.user&&o.user.uid||null,this.model.peer_id=r,this.model.client_id=o.clientId,this.model.state=t,this.model.channel=n,this.model.channel_id=n.id,this.model.channel_label=n.label,this.model.channel_type="main"===s?"persistent":"temporal",this.model.channel_binary_type=n.binaryType,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.error=("string"==typeof i?i:i&&i.message)||null,"plugin"===this.model.agent_name&&(this.model.channel_binary_type="int8Array","IE"===this.model.agent_name&&this.model.agent_version<11&&(this.model.channel_binary_type="none")),this.postStats(this.endpoints.dataChannel,this.model);}}const Sn={onopen:e=>{const{dataChannel:t,channelProp:r,channelName:n,channelType:s,peerId:i,roomState:o,bufferThreshold:a}=e,c=new un,{room:d}=o,{STATS_MODULE:l}=Lt;Ys.log.DEBUG([i,"RTCDataChannel",r,"Datachannel has opened"]),t.bufferedAmountLowThreshold=a||0,c.send(d.id,l.HANDLE_DATA_CHANNEL_STATS.closed,i,t,r),Vs(ge({state:Be.OPEN,peerId:i,channelName:n,channelType:s,bufferAmount:oi.getDataChannelBuffer(t)}));},onmessage:(e,t)=>{const{peerId:r,channelName:n,channelType:s,roomState:i}=e;pn(i,t.data,r,n,s);},onerror:(e,t)=>{const{dataChannel:r,peerId:n,channelName:s,channelProp:i,channelType:o,roomState:a}=e;if("NONE"!==t.error.errorDetail){const e=Xi.getSkylinkState(a.room.id),{room:c}=e,d=new un;Ys.log.ERROR([n,"RTCDataChannel",i,"Datachannel has an exception ->"],t),d.send(c.id,Be.ERROR,n,r,i,t),Vs(ge({state:Be.ERROR,room:c,peerId:n,channelName:s,channelType:o,bufferAmount:oi.getDataChannelBuffer(r),error:t}));}else Ys.log.DEBUG([n,"RTCDataChannel",i,"Datachannel state ->"],t.error.message);},onbufferedamountlow:e=>{const{dataChannel:t,peerId:r,channelName:n,channelProp:s,channelType:i,roomState:o}=e,a=Xi.getSkylinkState(o.room.id),{room:c}=a;Ys.log.DEBUG([r,"RTCDataChannel",s,"Datachannel buffering data transfer low"]),Vs(ge({state:Be.BUFFERED_AMOUNT_LOW,room:c,peerId:r,channelName:n,channelType:i,bufferAmount:oi.getDataChannelBuffer(t)}));},onclose:e=>{const{dataChannel:t,peerId:r,channelName:n,channelProp:s,channelType:i,roomState:o}=e,{DATA_CHANNEL:a,STATS_MODULE:c}=Lt,d=Xi.getSkylinkState(o.room.id)||Object.values(Xi.getSkylinkState())[0];if(!d)return;const{room:l,peerConnections:p}=d,u=((e,t)=>{const{dataTransfers:r}=t,n=Object.keys(r);for(let t=0;t<n.length;t+=1)if(-1!==n[t].indexOf(e))return n[t];return null})(r,d),S=new un;Ys.log.DEBUG([r,"RTCDataChannel",s,a.closed]);try{if(S.send(l.id,c.HANDLE_DATA_CHANNEL_STATS.closed,r,t,s),Vs(ge({state:Be.CLOSED,peerId:r,room:l,channelName:n,channelType:i,bufferAmount:oi.getDataChannelBuffer(t)})),u&&Vs((e=>new pe("dataTransferState",{detail:e}))({state:Be.ERROR,transferId:u,peerId:r,transferInfo:null,error:new Error(a.closed)})),p[r]&&p[r].remoteDescription&&p[r].remoteDescription.sdp&&(-1===p[r].remoteDescription.sdp.indexOf("m=application")||p[r].remoteDescription.sdp.indexOf("m=application 0")>0))return;i===Fe.MESSAGING&&setTimeout(()=>{p[r]&&p[r].signalingState!==Ye.CLOSED&&p[r].localDescription&&p[r].localDescription.type===et.OFFER&&(Ys.log.DEBUG([r,"RTCDataChannel",s,a.reviving_dataChannel]),oi.createDataChannel({peerId:r,dataChannel:t,bufferThreshold:oi.getDataChannelBuffer(t),createAsMessagingChannel:!0,roomState:d}),S.send(l.id,c.HANDLE_DATA_CHANNEL_STATS.reconnecting,r,{label:n},"main"));},100);}catch(e){Ys.log.WARN([r,"RTCDataChannel",s,a.closed]);}}},En=(e,t,r)=>{const n=Xi.getInitOptions(),{dataChannels:s,inRoom:i,user:o,hasMCU:a}=e;let c=Object.keys(s),d=!1;if(Array.isArray(r)&&r.length?(c=r,d=!0):r&&"string"==typeof r&&(c=[r],d=!0),!i||!o||!o.sid)return Ys.log.ERROR("Unable to send message as User is not in Room. ->",t),null;if(!n.enableDataChannel)return Ys.log.ERROR("Unable to send message as User does not have DataChannel enabled. ->",t),null;for(let n=0;n<c.length;n+=1){const i=c[n];s[i]||a?i===Nt.MCU?(c.splice(n,1),n-=1):a||(Ys.log.DEBUG([i,"RTCDataChannel",null,`Sending ${d?"private":""} P2P message to Peer.`]),ln(e,i,{type:Et.MESSAGE,isPrivate:d,sender:o.sid,target:r?i:null,data:t},"main")):(Ys.log.ERROR([i,"RTCDataChannel",null,"Dropping of sending message to Peer as DataChannel connection does not exist."]),c.splice(n,1),n-=1);}return 0===c.length&&Ys.log.WARN("Currently there are no Peers to send P2P message to."),a&&(Ys.log.DEBUG([Nt.MCU,"RTCDataChannel",null,`Broadcasting ${d?"private":""} P2P message to Peers.`]),ln(e,Nt.MCU,{type:Et.MESSAGE,isPrivate:d,sender:o.sid,target:c,data:t},"main")),!r&&a||Vs(me({room:e.room,message:{targetPeerId:r||null,content:t,senderPeerId:o.sid,isDataChannel:!0,isPrivate:d},isSelf:!0,peerId:o.sid,peerInfo:Qt.getCurrentSessionInfo(e.room)})),null},hn=(e,t,r)=>{const{dataChannels:n}=e,s=n[t][r],{channelName:i,channelType:o}=s.channelName;if(s.readyState!==Be.CLOSED){const{room:a}=e,c=new un;Ys.log.DEBUG([t,Ct.DATA_CHANNEL,r,Lt.DATA_CHANNEL.CLOSING]),c.send(a.id,Be.CLOSING,t,s.channel,r),Vs(ge({room:a,peerId:t,state:Be.CLOSING,channelName:i,channelType:o,bufferAmount:oi.getDataChannelBuffer(s.channel)})),s.channel.close(),delete n[t][r];}},gn=(e,t,r)=>{const{room:n}=e,s=new zn;try{const e=s.messageBuilder.getRestartOfferMessage(n.id,t,r);return s.offer(n,t,r,e),t}catch(e){return [t,e]}},mn=(e,t,r)=>{const n=Xi.getSkylinkState(t.room.id),{AdapterJS:s}=window,{peerConnections:i,peerCustomConfigs:o,peerEndOfCandidatesCounter:a,room:c,user:d}=n,{doIceRestart:l,bwOptions:p}=r,u=new zn,{PEER_CONNECTION:S}=Lt,E=[];return new Promise(t=>{if(!i[e])return Ys.log.ERROR([e,null,null,S.refresh_peerId_no_match]),E.push(S.refresh_peerId_no_match),t([e,E]);const r=i[e];if("edge"===s.webrtcDetectedBrowser&&(Ys.log.WARN([e,"RTCPeerConnection",null,S.refresh_not_supported]),E.push(S.refresh_no_edge_support)),0!==E.length)return t([e,E]);if(r.signalingState===Ye.STABLE)return Ys.log.INFO([e,null,null,"Sending restart message to signaling server ->"],{iceRestart:l,options:p}),o[e]=o[e]||{},o[e].bandwidth=o[e].bandwidth||{},o[e].googleXBandwidth=o[e].googleXBandwidth||{},p.bandwidth&&"object"==typeof p.bandwidth&&("number"==typeof p.bandwidth.audio&&(o[e].bandwidth.audio=p.bandwidth.audio),"number"==typeof p.bandwidth.video&&(o[e].bandwidth.video=p.bandwidth.video),"number"==typeof p.bandwidth.data&&(o[e].bandwidth.data=p.bandwidth.data)),p.googleXBandwidth&&"object"==typeof p.googleXBandwidth&&("number"==typeof p.googleXBandwidth.min&&(o[e].googleXBandwidth.min=p.googleXBandwidth.min),"number"==typeof p.googleXBandwidth.max&&(o[e].googleXBandwidth.max=p.googleXBandwidth.max)),a[e]=a[e]||{},a[e].len=0,t(gn(n,e,l));const h=r.localDescription&&r.localDescription.sdp;if(r.signalingState===Ye.HAVE_LOCAL_OFFER&&h)return u.sendMessage({type:r.localDescription.type,sdp:r.localDescription.sdp,mid:d.sid,target:e,rid:c.id,restart:!0}),t(e);const g=`Failed restarting as peer connection state is ${r.signalingState} and there is no localDescription set to connection. There could be a handshaking step error.`;return Ys.log.DEBUG([e,"RTCPeerConnection",null,g],{localDescription:r.localDescription,remoteDescription:r.remoteDescription}),E.push(g),t([e,E]),null})},fn=(e,t,r)=>(Ys.log.INFO([e,"PeerConnection",null,"Restarting peer connection."]),mn(e,t,r)),Rn={createOffer:(e,t,r=!1,n)=>{const s=Xi.getSkylinkState(e.id),i=Xi.getInitOptions(),{enableDataChannel:o}=i,{peerConnections:a,hasMCU:c,enableIceRestart:d,peerInformations:l,voiceActivityDetection:p,peerConnStatus:u,dataChannels:S}=s,{AdapterJS:E}=window,h=a[t],g={offerToReceiveAudio:!(!s.sdpSettings.connection.audio&&t!==Nt.MCU)&&Zs.getSDPCommonSupports(t,null,e.id).video,offerToReceiveVideo:!(!s.sdpSettings.connection.video&&t!==Nt.MCU)&&Zs.getSDPCommonSupports(t,null,e.id).audio,iceRestart:!!((l[t]||{}).config||{}).enableIceRestart&&r&&d,voiceActivityDetection:p};return c&&"function"!=typeof h.addTransceiver&&(g.offerToReceiveVideo=!0),c&&t!==Nt.MCU||zt.addLocalMediaStreams(t,s),o&&l[t].config.enableDataChannel&&(S[t]&&S[t].main||(oi.createDataChannel({peerId:t,roomState:s,createAsMessagingChannel:!0}),s.peerConnections[t].hasMainChannel=!0)),Ys.log.DEBUG([t,null,null,"Creating offer with config:"],g),h.endOfCandidates=!1,h.negotiating=!0,u[t]&&(s.peerConnStatus[t].sdpConstraints=g),Xi.setSkylinkState(s,e.id),new Promise((e,r)=>{h.createOffer("plugin"===E.webrtcDetectedType?{mandatory:{OfferToReceiveAudio:g.offerToReceiveAudio,OfferToReceiveVideo:g.offerToReceiveVideo,iceRestart:g.iceRestart,voiceActivityDetection:g.voiceActivityDetection}}:g).then(r=>((e,t,r,n,s)=>{const{room:i}=r;Ys.log.DEBUG([t,null,null,"Created offer"],s),Gr.send(i.id,an.OFFER.create,t,s,!1),on(e,t,r,s,n);})(e,t,s,n,r)).catch(e=>((e,t,r,n)=>{const{room:s}=r;Ys.log.ERROR([t,null,null,"Failed creating an offer:"],n),Gr.send(s.id,an.OFFER.create_error,t,null,!1,n),Vs(Ce({state:et.ERROR,peerId:t,error:n,room:r.room})),e(n);})(r,t,s,e));})},createAnswer:(e,t)=>{const r=Xi.getSkylinkState(e.room.id),{peerConnections:n,hasMCU:s,peerConnStatus:i,voiceActivityDetection:o}=r,a=n[t],{AdapterJS:c}=window;Ys.log.INFO([t,null,null,"Creating answer with config:"],e.room.connection.sdpConstraints);const d="edge"===c.webrtcDetectedBrowser?{offerToReceiveVideo:!(!r.sdpSettings.connection.audio&&t!==Nt.MCU)&&Zs.getSDPCommonSupports(t,a.remoteDescription,e.room.id).video,offerToReceiveAudio:!(!r.sdpSettings.connection.video&&t!==Nt.MCU)&&Zs.getSDPCommonSupports(t,a.remoteDescription,e.room.id).audio,voiceActivityDetection:o}:void 0;return s&&t!==Nt.MCU||zt.addLocalMediaStreams(t,e),i[t]&&(r.peerConnStatus[t].sdpConstraints=d),new Promise((r,n)=>a.createAnswer(d).then(n=>((e,t,r,n)=>{const{room:s}=r;Ys.log.DEBUG([t,null,null,"Created answer"],n),Gr.send(s.id,dn.ANSWER.create,t,n,!1),on(e,t,r,n);})(r,t,e,n)).catch(r=>((e,t,r,n)=>{const{room:s}=r;Ys.log.ERROR([t,null,null,"Failed creating an answer:"],n),Gr.send(s.id,dn.ANSWER.create_error,t,null,!1,n),Vs(Ce({state:et.ERROR,peerId:t,error:n,room:r.room})),e(n);})(n,t,e,r)))},addPeer:e=>{let t=null;const{currentRoom:r,targetMid:n,peerBrowser:s,cert:i,receiveOnly:o,hasScreenShare:a}=e,c=Xi.getInitOptions(),d=Xi.getSkylinkState(r.id),{peerConnections:l,room:p}=d,u=new rn;if(l[n])Ys.log.WARN([n,null,null,"Connection to peer has already been made."]);else{d.peerConnStatus[n]={connected:!1,init:!1},Ys.log.INFO([n,null,null,"Starting the connection to peer. Options provided:"],{peerBrowser:s,receiveOnly:o,enableDataChannel:c.enableDataChannel}),t=cn({currentRoom:r,targetMid:n,hasScreenShare:a,cert:i,sdpSemantics:ft.UNIFIED});try{const e=t.getConfiguration();e.sdpSemantics===ft.UNIFIED?Ys.log.INFO([n,"SDP Semantics",null,"Peer Connection has Unified plan."]):e.sdpSemantics===ft.PLAN_B?Ys.log.INFO([n,"SDP Semantics",null,"Peer Connection has Plan-B."]):Ys.log.INFO([n,"SDP Semantics",null,"The sdpSemantics parameter is not supported by this browser version."]);}catch(e){Ys.log.INFO([n,"SDP Semantics",null,"getConfiguration() is not available in this browser version. Ex : "],e);}d.peerConnections[n]=t,Xi.setSkylinkState(d,r.id),u.send(p.id,t.iceConnectionState,n),Mr.send(p.id,"new",n,!1);}return t},createDataChannel:e=>{let{peerId:t,dataChannel:r,bufferThreshold:n,createAsMessagingChannel:s,roomState:i}=e;const o=Xi.getSkylinkState(i.room.id),{user:a,peerConnections:c,dataChannels:d}=o,l=c[t];let p=`-_${t}`,u=!0===s?Fe.MESSAGING:Fe.DATA,S=u===Fe.MESSAGING?"main":p;if(!a||!a.sid)return Ys.log.ERROR([t,"RTCDataChannel",S,"Aborting of creating or initializing DataChannel as User does not have Room session"]),null;if(p=`${a.sid}_${t}`,!l||l.signalingState===Ye.CLOSED)return Ys.log.ERROR([t,"RTCDataChannel",S,"Aborting of creating or initializing Datachannel as Peer connection does not exists"]),null;if(r&&"object"==typeof r?p=r.label:"string"==typeof r&&(p=r,r=null),d[t]?d[t].main&&d[t].main.channel.label===p&&(S="main",u=Fe.MESSAGING):(S="main",u=Fe.MESSAGING,d[t]={},Ys.log.DEBUG([t,"RTCDataChannel",S,"initializing main DataChannel"])),!r)try{r=l.createDataChannel(p,{reliable:!0,ordered:!0});}catch(e){Ys.log.ERROR([t,"RTCDataChannel",S,"Failed creating Datachannel ->"],e);const n=new un,{room:s}=i;return n.send(s.id,Be.ERROR,t,{label:p},S,e),Vs(ge({state:Be.CREATE_ERROR,peerId:t,error:e,channelName:p,channelType:u,buferAmount:oi.getDataChannelBuffer(r)})),null}const E={dataChannel:r,peerId:t,channelName:p,channelProp:S,channelType:u,roomState:i,bufferThreshold:n};r.onopen=Sn.onopen.bind(r,E),r.onmessage=Sn.onmessage.bind(r,E),r.onerror=Sn.onerror.bind(r,E),r.onbufferedamountlow=Sn.onbufferedamountlow.bind(r,E),r.onclose=Sn.onclose.bind(r,E);const h=u===Fe.MESSAGING?"main":p;return o.dataChannels[t][h]={channelName:p,channelType:u,transferId:null,streamId:null,channel:r},Xi.setSkylinkState(o,i.room.id),null},sendP2PMessage:(e,t,r)=>{const n=Os(e);if(n)En(n,t,r);else{const e=Xi.getSkylinkState(),n=Object.keys(e);for(let s=0;s<n.length;s+=1){const i=e[n[s]];En(i,t,r);}}},getPeersInRoom:e=>{const t=Os(e);if(t){const e={},r=Object.keys(t.peerInformations);for(let n=0;n<r.length;n+=1)e[r[n]]=Object.assign({},Qt.getPeerInfo(r[n],t.room)),e[r[n]].isSelf=!1;return t.user&&t.user.sid&&(e[t.user.sid]=Object.assign({},Qt.getCurrentSessionInfo(t.room)),e[t.user.sid].isSelf=!0),e}return null},signalingEndOfCandidates:(e,t)=>{const r=Xi.getSkylinkState(t.room.id),n=r.peerEndOfCandidatesCounter[e],s=r.peerConnections[e],i=r.peerCandidatesQueue[e],o=r.peerConnectionConfig[e],a=r.gatheredCandidates[e],{AdapterJS:c,RTCIceCandidate:d}=window,{TAGS:l}=kt,{PEER_CONNECTION:p}=Lt;if(!n)return null;if(s&&s.signalingState!==Ye.CLOSED&&s.remoteDescription&&s.remoteDescription.sdp&&"number"==typeof n.expectedLen&&n.len>=n.expectedLen&&(!i||0===i.length)&&!n.hasSet){Ys.log.DEBUG([e,l.PEER_CONNECTION,null,p.end_of_candidates]),n.hasSet=!0;try{if("edge"===c.webrtcDetectedBrowser){let t=-1;const n=[],i=s.remoteDescription.sdp.split("\r\n");let a=!1;for(let s=0;s<i.length;s+=1)if(0===i[s].indexOf("m="))a="0"===i[s].split(" ")[1],t+=1;else if(0===i[s].indexOf("a=mid:")&&!a){const a=i[s].split("a=mid:")[1]||"";if(a&&-1===n.indexOf(a)&&(n.push(a),br.addIceCandidate(e,`endofcan-${(new Date).getTime()}`,"endOfCandidates",new d({sdpMid:a,sdpMLineIndex:t,candidate:"candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"}),r),o.bundlePolicy===Qe.MAX_BUNDLE))break}}else c&&!As(c.VERSION,"0.14.0")&&s.addIceCandidate(null);if(a){const t={expected:n.expectedLen||0,received:n.len||0,processed:a.receiving.srflx.length+a.receiving.relay.length+a.receiving.host.length};Vs((e=>new pe("candidatesGathered",{detail:e}))({room:r.room,peerId:e,candidatesLength:t}));}r.peerEndOfCandidatesCounter[e]=n,Xi.setSkylinkState(r,t.room.id);}catch(t){Ys.log.ERROR([e,l.PEER_CONNECTION,null,p.end_of_candidate_failure],t);}}return null},getDataChannelBuffer:e=>({bufferedAmountLow:parseInt(e.bufferedAmountLow,10)||0,bufferedAmountLowThreshold:parseInt(e.bufferedAmountLowThreshold,10)||0}),refreshDataChannel:(e,t)=>{const{dataChannels:r,peerConnections:n}=e;if((e=>!us(e))(r)&&Object.hasOwnProperty.call(r,t)){if(Object.hasOwnProperty.call(r[t],"main")){const s=r[t].main,{channelName:i,channelType:o}=s,a=s.channel.bufferedAmountLowThreshold||0;o===Fe.MESSAGING&&setTimeout(()=>{Object.hasOwnProperty.call(n,t)&&n[t].signalingState!==Ye.CLOSED&&n[t].localDescription.type===et.OFFER&&(oi.closeDataChannel(e,t),Ys.log.DEBUG([t,"RTCDataChannel","main",Lt.DATA_CHANNEL.reviving_dataChannel]),oi.createDataChannel({roomState:e,peerId:t,dataChannel:i,bufferThreshold:a,createAsMessagingChannel:!0}));},100);}}else Ys.log.DEBUG([t,"RTCDataChannel",Lt.DATA_CHANNEL.refresh_error]);},closeDataChannel:(e,t,r="main")=>{try{const n=Xi.getSkylinkState(e.room.id),{dataChannels:s,room:i}=n;if(!s[t]||!s[t][r])return void Ys.log.WARN([t,Ct.DATA_CHANNEL,r||null,Lt.DATA_CHANNEL.ERRORS.NO_SESSIONS]);if("main"===r)return void((e,t)=>{const{dataChannels:r}=e,n=Object.keys(r[t]);for(let s=0;s<n.length;s+=1)Object.hasOwnProperty.call(r[t],n[s])&&hn(e,t,n[s]);delete r[t];})(n,t);hn(n,t,r),Xi.setSkylinkState(n,i.id);}catch(e){Ys.log.ERROR([t,Ct.DATA_CHANNEL,r||null,Lt.DATA_CHANNEL.ERRORS.FAILED_CLOSING],e);}},refreshConnection:en,refreshPeerConnection:(e,t,r=!1,n={})=>{const s=Xi.getSkylinkState(t.room.id),{hasMCU:i}=s;try{if(!i){const t=[];for(let i=0;i<e.length;i+=1){const o=e[i],a=fn(o,s,{doIceRestart:r,bwOptions:n});t.push(a);}return Promise.all(t)}return ((e,t,r)=>new Promise(n=>{const s=e,i=Xi.getInitOptions(),{mcuUseRenegoRestart:o}=i;try{r.bandwidth&&"object"==typeof r.bandwidth&&("number"==typeof r.bandwidth.audio&&(s.streamsBandwidthSettings.bAS.audio=r.bandwidth.audio),"number"==typeof r.bandwidth.video&&(s.streamsBandwidthSettings.bAS.video=r.bandwidth.video),"number"==typeof r.bandwidth.data&&(s.streamsBandwidthSettings.bAS.data=r.bandwidth.data)),r.googleXBandwidth&&"object"==typeof r.googleXBandwidth&&("number"==typeof r.googleXBandwidth.min&&(s.streamsBandwidthSettings.googleX.min=r.googleXBandwidth.min),"number"==typeof r.googleXBandwidth.max&&(s.streamsBandwidthSettings.googleX.max=r.googleXBandwidth.max)),o&&(s.peerEndOfCandidatesCounter.MCU=s.peerEndOfCandidatesCounter.MCU||{},s.peerEndOfCandidatesCounter.MCU.len=0,Xi.setSkylinkState(s),n(gn(s,Nt.MCU,t)));}catch(e){n([Nt.MCU,e]);}}))(t,r,n)}catch(e){return Ys.log.ERROR([null,"RTCPeerConnection",null,"Failed restarting."],e),null}},restartPeerConnection:mn,buildPeerInformations:(e,t)=>{const r=e,n=r.sid;return r.room=t.room.roomName,r.settings.data=!!(t.dataChannels[n]&&t.dataChannels[n].main&&t.dataChannels[n].main.channel&&t.dataChannels[n].main.channel.readyState===Be.OPEN),delete r.publishOnly,r},getConnectionStatus:(e,t=null)=>{const{ROOM_STATE:r}=Lt;if(!e)return Ys.log.WARN(r.NO_ROOM_NAME),Ns(r.NO_ROOM_NAME);const{room:n}=e,s=((e,t)=>{const{peerConnections:r,room:n}=e,{PEER_CONNECTION:s}=Lt;let i=null,o=null;return Ss(Object.keys(r))?o=s.not_initialised:Array.isArray(t)?(i=t).forEach(e=>{Ms(n,e)||(o=`${s.peerId_does_not_exist} ${e}`);}):Ts(t)?(Ms(n,t)||(o=`${s.peerId_does_not_exist} ${t}`),i=[t]):i=Object.keys(r),{peerIds:i,errorMsg:o}})(e,t);if(s.errorMsg)return Ys.log.WARN(s.errorMsg),Ns(s.errorMsg);const{peerIds:i}=s,o=[];for(let e=0;e<i.length;e+=1){const t=new ri(n.id,i[e]);o.push(t.getConnectionStatus());}return Promise.all(o)},closePeerConnection:(e,t)=>{const r=Xi.getSkylinkState(e.room.id),{peerConnections:n,room:s}=r,{AdapterJS:i}=window;n[t].close(),"AppleWebKit"===i.webrtcDetectedType&&(r.peerConnections[t].signalingStateClosed||(r.peerConnections[t].signalingStateClosed=!0),r.peerConnections[t].iceConnectionStateClosed||(r.peerConnections[t].iceConnectionStateClosed=!0)),Xi.setSkylinkState(r,s.id);},updatePeerInformationsMediaStatus:(e,t,r,n)=>{const s=Xi.getSkylinkState(e.id);s.peerInformations[t].mediaStatus=((e,t,r,n)=>{const{peerMedias:s,peerInformations:i}=e,o=s[t],a=i[t].mediaStatus||{};return Object.values(o).forEach(e=>{e.transceiverMid===r.mid&&(a[n.id]={audioMuted:ws(n)?e.mediaState===At.MUTED?0:1:-1,videoMuted:bs(n)?e.mediaState===At.MUTED?0:1:-1});}),delete a.audioMuted,delete a.videoMuted,a})(s,t,r,n),Xi.setSkylinkState(s,e.id);},processNewSender:(e,t,r)=>{const n=e;n.currentRTCRTPSenders[t]||(n.currentRTCRTPSenders[t]=[]),n.currentRTCRTPSenders[t].push(r),Xi.setSkylinkState(n,n.room.id);}},Tn=(e,t,r,n)=>{const s=e[t]["send"===r?"sending":"receiving"][n];return ["number","string","boolean"].indexOf(typeof s)>-1?s:null},Cn=(e,t)=>({stream_id:e.id,id:t.id,label:t.label,muted:!t.enabled}),_n=(e,t,r)=>({stream_id:e.id,id:t.id,label:t.label,height:r.video.resolution.height,width:r.video.resolution.width,muted:!t.enabled});class In extends er{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,peer_id:null,audio_send:{tracks:[]},audio_recv:{},video_send:{tracks:[]},video_recv:{},error:null},this.stats=null;}gatherSendAudioPacketsStats(){this.model.audio_send.bytes=Tn(this.stats,"audio","send","bytes"),this.model.audio_send.packets=Tn(this.stats,"audio","send","packets"),this.model.audio_send.echo_return_loss=Tn(this.stats,"audio","send","echoReturnLoss"),this.model.audio_send.echo_return_loss_enhancement=Tn(this.stats,"audio","send","echoReturnLossEnhancement"),this.model.audio_send.round_trip_time=Tn(this.stats,"audio","send","roundTripTime"),this.model.audio_send.audio_level=Tn(this.stats,"audio","send","audioLevel"),this.model.audio_send.jitter=Tn(this.stats,"audio","send","jitter");}gatherReceiveAudioPacketsStats(){this.model.audio_recv.bytes=Tn(this.stats,"audio","recv","bytes"),this.model.audio_recv.packets=Tn(this.stats,"audio","recv","packets"),this.model.audio_recv.packets_lost=Tn(this.stats,"audio","recv","packetsLost"),this.model.audio_recv.jitter=Tn(this.stats,"audio","recv","jitter"),this.model.audio_recv.audio_level=Tn(this.stats,"audio","recv","audioLevel");}gatherSendVideoPacketsStats(){this.model.video_send.bytes=Tn(this.stats,"video","send","bytes"),this.model.video_send.packets=Tn(this.stats,"video","send","packets"),this.model.video_send.nack_count=Tn(this.stats,"video","send","nacks"),this.model.video_send.firs_count=Tn(this.stats,"video","send","firs"),this.model.video_send.plis_count=Tn(this.stats,"video","send","plis"),this.model.video_send.frames_encoded=Tn(this.stats,"video","send","framesEncoded"),this.model.video_send.frame_width=Tn(this.stats,"video","send","frameWidth"),this.model.video_send.frame_height=Tn(this.stats,"video","send","frameHeight"),this.model.video_send.round_trip_time=Tn(this.stats,"video","send","roundTripTime"),this.model.video_send.qp_sum=Tn(this.stats,"video","send","qpSum"),this.model.video_send.jitter=Tn(this.stats,"video","send","jitter"),this.model.video_send.frames=Tn(this.stats,"video","send","frames"),this.model.video_send.hugeFrames=Tn(this.stats,"video","send","hugeFramesSent"),this.model.video_send.framesPerSecond=Tn(this.stats,"video","send","framesPerSecond");}gatherReceiveVideoPacketsStats(){this.model.video_recv.bytes=Tn(this.stats,"video","recv","bytes"),this.model.video_recv.packets=Tn(this.stats,"video","recv","packets"),this.model.video_recv.packets_lost=Tn(this.stats,"video","recv","packetsLost"),this.model.video_recv.nack_count=Tn(this.stats,"video","recv","nacks"),this.model.video_recv.firs_count=Tn(this.stats,"video","recv","firs"),this.model.video_recv.plis_count=Tn(this.stats,"video","recv","plis"),this.model.video_recv.frames_decoded=Tn(this.stats,"video","recv","framesDecoded"),this.model.video_recv.qp_sum=Tn(this.stats,"video","recv","qpSum"),this.model.video_recv.frames_decoded=Tn(this.stats,"video","recv","framesDecoded"),this.model.video_recv.frames_dropped=Tn(this.stats,"video","recv","framesDropped"),this.model.video_recv.decoderImplementation=Tn(this.stats,"video","recv","decoderImplementation");}buildTrackInfo(e){const t=Xi.getSkylinkState(e),{streams:r}=t;let n=[];r.userMedia&&(n=Object.values(Object.values(r.userMedia))),r.screenshare&&n.push(r.screenshare),n.forEach(e=>{if(e){const t=e.stream?e.stream:e[Object.keys(e)[0]].stream,r=e.settings?e.settings:e[Object.keys(e)[0]].settings,n=t.getAudioTracks(),s=t.getVideoTracks();n.forEach(e=>{const r=Cn(t,e);this.model.audio_send.tracks.push(r);}),s.forEach(e=>{const n=_n(t,e,r);this.model.video_send.tracks.push(n);});}});}send(e,t,r){const{STATS_MODULE:n}=Lt,s=Xi.getSkylinkState(e);s?(s.streams.userMedia||s.streams.screenshare)&&(this.model.client_id=s.clientId,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=s&&s.user&&s.user.sid||null,this.model.peer_id=r,oi.retrieveStatistics(e,r,Xi.getInitOptions().beSilentOnStatsLogs).then(t=>{t&&(this.stats=t,this.gatherSendAudioPacketsStats(),this.gatherReceiveAudioPacketsStats(),this.gatherSendVideoPacketsStats(),this.gatherReceiveVideoPacketsStats(),this.buildTrackInfo(e),this.postStats(this.endpoints.bandwidth,this.model));}).catch(e=>{this.model.error=e?e.message:null,Ys.log.DEBUG(n.HANDLE_BANDWIDTH_STATS.RETRIEVE_FAILED,e);})):Ys.log.DEBUG([r,"Statistics","Bandwidth_Stats",n.HANDLE_BANDWIDTH_STATS.NO_STATE]);}}const On={};class An{constructor(e){const{peerConnection:t,state:r,targetMid:n}=e;if(On[n])return On[n];this.peerId=n,this.state=r,this.peerConnection=t,this.bandwidth=null,On[this.peerId]=this;}static formatTotalFn(e){let t=0;for(let r=0;r<e.length;r+=1)t+=e[r];return t/e.length}setAdjustmentInterval(){const{bandwidthAdjuster:e,peerBandwidth:t,room:r}=this.state,{PEER_CONNECTION_STATE:n}=kt;if(this.bandwidth)return;const s={audio:{send:[],recv:[]},video:{send:[],recv:[]}};let i=0;const o=setInterval(()=>{this.peerConnection&&this.peerConnection.signalingState!==n.CLOSED&&e&&t[this.peerId]?oi.retrieveStatistics(r.id,this.peerId,Xi.getIniOptions().beSilentOnStatsLogs,!0).then(t=>{if(this.peerConnection&&this.peerConnection.signalingState!==n.CLOSED&&e||clearInterval(o),s.audio.send.push(8*t.audio.sending.bytes),s.audio.recv.push(8*t.audio.receiving.bytes),s.video.send.push(8*t.video.sending.bytes),s.video.recv.push(8*t.video.receiving.bytes),(i+=1)===e.interval){i=0;let t=An.formatTotalFn(s.audio.send),r=An.formatTotalFn(s.video.send);e.useUploadBwOnly||(t+=An.formatTotalFn(s.audio.recv),r+=An.formatTotalFn(s.video.recv),t/=2,r/=2),t=parseInt(t*(e.limitAtPercentage/100)/1e3,10),r=parseInt(r*(e.limitAtPercentage/100)/1e3,10),oi.refreshConnection(this.state,this.peerId,!1,{bandwidth:{audio:t,video:r}});}}).catch(()=>{s.audio.send.push(0),s.audio.recv.push(0),s.video.send.push(0),s.video.recv.push(0);}):clearInterval(o);},1e3);this.bandwidth=s;}}const vn=e=>{const{ICE_CONNECTION_STATE:t}=kt;return [t.COMPLETED,t.CONNECTED].indexOf(e)>-1},Dn={ontrack:(e,t,r,n)=>{const s=Xi.getSkylinkState(r.room.id),{peerConnections:i,room:o,hasMCU:a}=s,{receiver:c}=n,{AdapterJS:d}=window,l=n.streams[0];let{transceiver:p,track:u}=n,S=t;if(!l)return Ys.log.WARN("ontrack stream is null"),null;if("safari"===d.webrtcDetectedBrowser){i[t].getTransceivers().forEach(e=>{e.receiver.track.id===c.track.id&&(p=e);});}if(null===p.mid&&Ys.log.WARN("Transceiver mid is null",p),!i[S])return null;a&&(S=((e,t)=>{const{peerMedias:r,user:n}=e,s=Object.keys(r);for(let e=0;e<s.length;e+=1)if(s[e]!==n.sid){const n=Object.values(r[s[e]]);for(let r=0;r<n.length;r+=1)if(n[r].transceiverMid===t.mid)return s[e]}return null})(s,p));const E=Jn.isVideoScreenTrack(s,S,p.mid),h=[S,o,E];return l.onremovetrack=Dn.onremovetrack.bind(void 0,...h),Jn.updateStreamIdFromOntrack(s.room,S,p.mid,l.id),oi.updatePeerInformationsMediaStatus(s.room,S,p,l),zt.updateRemoteStreams(s.room,S,l),zt.onRemoteTrackAdded(l,r,S,E,u.kind===Ot.VIDEO,u.kind===Ot.AUDIO),null},ondatachannel:(e,t,r,n)=>{const s=n.channel||n,i=Xi.getInitOptions(),o=Xi.getSkylinkState(r.room.id),{peerInformations:a}=o,{enableDataChannel:c}=i;Ys.log.DEBUG([t,"RTCDataChannel",s.label,"Received datachannel ->"],s),c&&a[t].config.enableDataChannel?(e.hasMainChannel||(e.hasMainChannel=!0),Rn.createDataChannel({peerId:t,dataChannel:s,roomState:r})):Ys.log.WARN([t,"RTCDataChannel",s.label,"Not adding datachannel as enable datachannel is set to false"]);},onicecandidate:(e,t,r,n)=>{br.onIceCandidate(t,n.candidate||n,r.room);},oniceconnectionstatechange:(e,t,r)=>{const{PEER_CONNECTION:n}=Lt,{ICE_CONNECTION_STATE:s,PEER_CONNECTION_STATE:i,BROWSER_AGENT:o}=kt,{AdapterJS:a}=window,{webrtcDetectedBrowser:c,webrtcDetectedType:d}=a,l=Xi.getSkylinkState(r.room.id),{streams:p}=l;if(!l)return void Ys.log.DEBUG([t,"RTCIceConnectionState",null,n.no_room_state]);const{hasMCU:u,bandwidthAdjuster:S,peerInformations:E,peerConnStatus:h,peerStats:g}=l,m=new rn;let f=null,R=e.iceConnectionState;if(Ys.log.DEBUG([t,"RTCIceConnectionState",null,n.ice_connection_state],R),"edge"===c&&("connecting"===R?R=s.CHECKING:"new"===R&&(R=s.FAILED)),"AppleWebKit"!==d||R!==s.CLOSED){if(l&&e.iceConnectionState!==s.CONNECTED&&m.send(r.room.id,e.iceConnectionState,t),Vs(Ae({state:R,peerId:t})),R===s.FAILED){if(a.webrtcDetectedBrowser===o.FIREFOX&&!p.userMedia)return;Vs(Ae({state:s.TRICKLE_FAILED,peerId:t}));}h&&h[t]&&(h[t].connected=vn(R)),f||!vn(R)||g[t]||(f=!0,g[t]={},Ys.log.DEBUG([t,"RTCStatsReport",null,"Retrieving first report to tabulate results"]),oi.getConnectionStatus(l,t).then(()=>{m.send(r.room.id,e.iceConnectionState,t),f=setInterval(()=>{e.signalingState===i.CLOSED||e.iceConnectionState===i.CLOSED?clearInterval(f):(new In).send(l.room.id,e,t);},2e4);})),!u&&vn(R)&&S&&"edge"!==a.webrtcDetectedBrowser&&"edge"!==(((E[t]||{}).agent||{}).name||"edge")&&new An({targetMid:t,state:l,peerConnection:e}).setAdjustmentInterval();}else setTimeout(()=>{e.iceConnectionStateClosed||(m.send(r.room.id,s.CLOSED,t),Vs(Ae({state:s.CLOSED,peerId:t})));},10);},onicegatheringstatechange:(e,t,r)=>{const{PEER_CONNECTION:n}=Lt,{iceGatheringState:s}=e;Ys.log.INFO([t,"RTCIceGatheringState",null,n.ice_gathering_state],s),Vs(Oe({state:s,room:r.room,peerId:t}));},onsignalingstatechange:(e,t)=>{const{AdapterJS:r}=window,{PEER_CONNECTION:n}=Lt,{PEER_CONNECTION_STATE:s}=kt,{signalingState:i,signalingStateClosed:o}=e;Ys.log.DEBUG([t,"RTCSignalingState",null,n.peer_connection_state],i),"AppleWebKit"!==r.webrtcDetectedType||i!==s.CLOSED?Vs(Me({state:i,peerId:t})):setTimeout(()=>{o||Vs(Me({state:s.CLOSED,peerId:t}));},10);},onremovetrack:(e,t,r,n)=>{const{AdapterJS:s}=window,i=Is(t.id),{peerInformations:o}=i,{MEDIA_STREAM:a,PEER_INFORMATIONS:c}=Lt,d=s.webrtcDetectedBrowser===yt.REACT_NATIVE?n.stream:n.target;Ys.log.INFO([e,Ct.MEDIA_STREAM,null,a.REMOTE_TRACK_REMOVED],{peerId:e,isSelf:!1,isScreensharing:r,track:n.track}),o[e]?d?(((e,t,r)=>{const n=e;delete n.peerInformations[t].mediaStatus[r],Xi.setSkylinkState(n,n.room.id);})(i,e,d.id),((e,t,r,n,s)=>{Vs(Ee({room:e.room,peerId:t,peerInfo:Qt.getPeerInfo(t,e.room),isSelf:!1,isScreensharing:r,streamId:s.id,isVideo:n.track.kind===Ot.VIDEO,isAudio:n.track.kind===Ot.AUDIO}));})(i,e,r,n,d),r&&(e=>{const{streams:t,room:r,user:n}=e;(t.userMedia?Object.values(t.userMedia):[]).forEach(e=>{bs(e.stream)&&Vs(ue({stream:e.stream,streamId:e.id,peerId:n.sid,room:r,isSelf:!0,peerInfo:Qt.getCurrentSessionInfo(r),isVideo:!0,isAudio:!1}));});})(i),((e,t)=>{Vs(ve({peerId:t,peerInfo:Qt.getPeerInfo(t,e.room),isSelf:!1}));})(i,e)):Ys.log.DEBUG([e,Ct.MEDIA_STREAM,null,`${a.ERRORS.DROPPING_ONREMOVETRACK}`-`${a.NO_STREAM}`]):Ys.log.DEBUG([e,Ct.MEDIA_STREAM,null,`${a.ERRORS.DROPPING_ONREMOVETRACK}`-`${c.NO_PEER_INFO} ${e}`]);},onsenderadded:(e,t,r,n)=>{const s=Xi.getSkylinkState(r.room.id),{sender:i}=n;Rn.processNewSender(s,t,i);}};class yn extends er{constructor(){super(),this.model={client_id:null,appKey:null,timestamp:null,room_id:null,user_id:null,state:null,recording_id:null,recordings:null,error:null};}send(e,t,r,n,s){const i=Xi.getSkylinkState(e);this.model.client_id=i.clientId,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.model.room_id=e,this.model.user_id=i&&i.user&&i.user.sid||null,this.model.state=t,this.model.recording_id=r,this.model.recordings=n,this.error=("string"==typeof s?s:s&&s.message)||null,this.postStats(this.endpoints.recording,this.model);}}const Nn=new yn,Pn=(e,t,r)=>{const n={state:e,recordingId:t};r&&(n.error=r),Vs(((e={})=>new pe("recordingState",{detail:e}))(n));},Mn="startSuccess",wn="stopSuccess",bn=(e,t,r,n,s)=>{const i=Qt.getPeerInfo(r,e.room);Vs(he({isSelf:!1,peerId:r,peerInfo:i,streamId:t,isAudio:n===Ot.AUDIO,isVideo:n===Ot.VIDEO,isScreensharing:s})),Vs(ve({isSelf:!1,peerId:r,peerInfo:i}));},kn=bn,Ln=(e,t,r)=>{Ys.log.WARN([e,Ct.SIG_SERVER,`${Lt.MEDIA_INFO.WARN.READ_ONLY_VALUE} ${r}`],t);},Un=(e,t)=>{const{rid:r,mediaId:n,transceiverMid:s}=t,i=Xi.getSkylinkState(r);Jn.updatePeerMediaInfo(i.room,e,n,vt.TRANSCEIVER_MID,s);},Gn=(e,t,r,n)=>{if(n.mediaState===At.UNAVAILABLE)((e,t,r,n)=>{const{mediaId:s}=n;Jn.setMediaStateToUnavailable(e,r,s),Jn.deleteUnavailableMedia(e,r,s);})(e,0,r,n);else switch(t){case _t.VIDEO_SCREEN:case _t.VIDEO_CAMERA:case _t.VIDEO_OTHER:case _t.VIDEO:((e,t)=>{const{type:r,rid:n,mediaId:s,mediaState:i,transceiverMid:o,mediaType:a}=t,c=Xi.getSkylinkState(n),{room:d}=c,l=Jn.retrieveStreamId(d,e,s,o),p=(new Date).toISOString();if(Ys.log.INFO([e,Ct.SIG_SERVER,r,Lt.MEDIA_INFO.VIDEO_STATE_CHANGE,i,l],t),c.peerInformations[e]){if(c.peerMessagesStamps[e]){if(p<c.peerMessagesStamps[e].videoMuted)return void Ys.log.WARN([e,Ct.SIG_SERVER,r,Lt.SIGNALING.OUTDATED_MSG],t);c.peerMessagesStamps[e].videoMuted=p;}c.peerInformations[e].mediaStatus[l]||(c.peerInformations[e].mediaStatus[l]={}),c.peerInformations[e].mediaStatus[l].videoMuted=i===At.MUTED||i===At.STOPPED?Tt.MUTED:Tt.ACTIVE,Xi.setSkylinkState(c,d.id),kn(c,l,e,Ot.VIDEO,a===_t.VIDEO_SCREEN);}else Ys.log.WARN([e,Ct.PEER_INFORMATION,r,`${Lt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`]);})(r,n);break;case _t.AUDIO_MIC:case _t.AUDIO:((e,t)=>{const{type:r,rid:n,mediaId:s,mediaState:i,transceiverMid:o}=t,a=Xi.getSkylinkState(n),{room:c}=a,d=Jn.retrieveStreamId(c,e,s,o),l=(new Date).toISOString();if(Ys.log.INFO([e,Ct.SIG_SERVER,r,Lt.MEDIA_INFO.AUDIO_STATE_CHANGE,i,d],t),a.peerInformations[e]){if(a.peerMessagesStamps[e]){if(l<a.peerMessagesStamps[e].audioMuted)return void Ys.log.WARN([e,Ct.SIG_SERVER,r,Lt.SIGNALING.OUTDATED_MSG],t);a.peerMessagesStamps[e].audioMuted=l;}a.peerInformations[e].mediaStatus[d]||(a.peerInformations[e].mediaStatus[d]={}),a.peerInformations[e].mediaStatus[d].audioMuted=i===At.MUTED||i===At.STOPPED?Tt.MUTED:Tt.ACTIVE,Xi.setSkylinkState(a,c.id),kn(a,d,e,Ot.AUDIO,!1);}else Ys.log.WARN([e,Ct.PEER_INFORMATION,r,`${Lt.PEER_INFORMATIONS.NO_PEER_INFO} ${e}`]);})(r,n);break;default:Ys.log.ERROR([r,Ct.SIG_SERVER,`${Lt.MEDIA_INFO.WARN.INVALID_MEDIA_TYPE} ${t}`],n);}},xn=(e,t,r,n,s)=>{const i=Xi.getSkylinkState(e),{peerMedias:o}=i,a=o[t][r];return a[n]&&a[n]!==s},Bn=bn,Fn=(e,t)=>{const r=Qt.getPeerInfo(t,e.room);return !(!r.agent.SDKVersion||"2.0.0"!==r.agent.SDKVersion)&&(Ys.log.INFO([t,Ct.SIG_SERVER,null,Lt.SIGNALING.DROPPING_MUTE_EVENT]),!0)},Vn={userMessageHandler:(e,t)=>{_r.processMessage(e,t);},answer:e=>{Xr(e);},answerAck:e=>{const{mid:t,rid:r,success:n}=e,s=Xi.getSkylinkState(r),i=t;Vs(Ce({state:et.ANSWER_ACK,peerId:i,room:s.room})),s.peerConnections[i].negotiating=!1,Xi.setSkylinkState(s,r),n?((e,t)=>{if(e.bufferedRemoteOffers[t]&&!Ss(e.bufferedRemoteOffers[t])){const r=e.bufferedRemoteOffers[t].shift();return Ys.log.DEBUG([t,"RTCSessionDescription",r.type,Lt.NEGOTIATION_PROGRESS.APPLYING_BUFFERED_REMOTE_OFFER],r),Xr(r),Xi.setSkylinkState(e,e.room.id),!0}return !1})(s,i)||((e,t)=>{const{peerConnections:r,currentRTCRTPSenders:n}=e;return new Promise(e=>{const s=r[t],i=s.getSenders()?s.getSenders():[],o=[],a=n[t]||[];let c=!1;i.forEach(e=>{o.push(e.getStats());});const d={};Promise.all(o).then(t=>{t.forEach((e,t)=>{e.forEach(e=>{e&&e.ssrc?d[e.ssrc]=i[t]:e&&"ssrc"===e.type&&e.id.indexOf("send")>1&&e.values.forEach(e=>{e.ssrc&&(d[e.ssrc]=i[t]);});});});const r=Object.keys(d);if(r.length!==a.length)c=!0;else{let e=0;for(let t=0;t<r.length;t+=1){const n=d[r[t]];for(let t=0;t<a.length;t+=1){if(n===a[t]){e+=1;break}}}c=e!==r.length;}e(c);});})})(s,i).then(e=>{e&&en(s,i).catch(e=>{Ys.log.ERROR([t,Ct.SESSION_DESCRIPTION,et.ANSWER_ACK,Lt.NEGOTIATION_PROGRESS.ERRORS.FAILED_RENEGOTIATION],e);});}):Ys.log.ERROR([i,Ct.SESSION_DESCRIPTION,et.ANSWER,Lt.NEGOTIATION_PROGRESS.ERRORS.FAILED_SET_REMOTE_ANSWER]);},inRoom:e=>{const{pc_config:{iceServers:t},sid:r,rid:n,tieBreaker:s}=e,i=Xi.getSkylinkState(n),o=Xi.getInitOptions(),{priorityWeightScheme:a}=o,c=new zn;let d=0;if(i.room.connection.peerConfig=br.setIceServers(t),i.room.inRoom=!0,d=a===it.AUTO?0:a===it.ENFORCE_OFFERER?2e15:-2e15,i.peerPriorityWeight=s+d,i.user.sid=r,i.inRoom=!0,Jn.updatePeerMediaWithUserSid(i.room,r),Xi.setSkylinkState(i,n),Vs(De({peerId:i.user.sid,peerInfo:Qt.getCurrentSessionInfo(i.room),isSelf:!0,room:i.room})),i.streams.userMedia){Object.keys(i.streams.userMedia).forEach(e=>{const t=i.streams.userMedia[e].stream;Vs(ue({stream:t,streamId:t.id,peerId:i.user.sid,room:i.room,isSelf:!0,peerInfo:Qt.getCurrentSessionInfo(i.room),isVideo:bs(t),isAudio:ws(t)}));});}c.enterRoom(i);},enter:e=>{Fr(e,xr.ENTER);},offer:e=>{Xr(e);},welcome:e=>{Fr(e,xr.WELCOME);},candidate:e=>{const{candidate:t,mid:r,rid:n}=e,s=Xi.getSkylinkState(n),{room:i}=s,o=Xi.getInitOptions(),a=s.peerConnections[r],c=s.peerEndOfCandidatesCounter[r]||{},{RTCIceCandidate:d}=window,{ICE_CANDIDATE:{CANDIDATE_HANDLER:l},PEER_CONNECTION:p,STATS_MODULE:{HANDLE_ICE_GATHERING_STATS:u}}=Lt,S=new yr;if(!t&&!e.id)return Ys.log.WARN([r,l.tag,null,l.INVALID_CANDIDATE],e),null;const E=new d({sdpMLineIndex:e.label,candidate:t,sdpMid:e.id}),h=`can-${E.foundation}`,g=E.candidate.split(" ")[7]||"";Ys.log.DEBUG([r,l.tag,`${h}:${g}`,l.VALID_CANDIDATE],E),c.len=c.len||0,c.hasSet=!1,c.len+=1,Xi.setSkylinkState(s,n);const m={candidate:{candidate:E.candidate,sdpMid:E.sdpMid,sdpMLineIndex:E.sdpMLineIndex},error:null};if(Vs(Ie({room:i,state:Ke.RECEIVED,peerId:r,candidateId:h,candidateType:g,candidate:m.candidate,error:m.error})),!a||a.signalingState===Ye.CLOSED)return Ys.log.WARN([r,l.tag,`${h}:${g}`,p.NO_PEER_CONNECTION]),m.error=new Error(p.NO_PEER_CONNECTION),S.send(i.id,u.PROCESS_FAILED,r,h,m.candidate,m.error),Vs(Ie({room:i,state:Ke.DROPPED,peerId:r,candidateId:h,candidateType:g,candidate:m.candidate,error:m.error})),oi.signalingEndOfCandidates(r,s),null;if(o.filterCandidatesType[g]){if(!s.hasMCU||!o.forceTURN)return Ys.log.WARN([r,l.tag,`${h}:${g}`,l.FILTERED_CANDIDATE],E),m.error=new Error(l.FILTERED_CANDIDATE),S.send(i.id,u.DROPPED,r,h,m.candidate,m.error),Vs(Ie({room:i,state:Ke.DROPPED,peerId:r,candidateId:h,candidateType:g,candidate:m.candidate,error:m.error})),oi.signalingEndOfCandidates(r,s),null;Ys.log.WARN([r,l.tag,`${h}:${g}`,l.FILTERING_FLAG_NOT_HONOURED],E);}a.remoteDescription&&a.remoteDescription.sdp&&a.localDescription&&a.localDescription.sdp?br.addIceCandidate(r,h,g,E,s):br.addIceCandidateToQueue(r,h,g,E,s),oi.signalingEndOfCandidates(r,s);let f=s.gatheredCandidates[r];return f||(f={sending:{host:[],srflx:[],relay:[]},receiving:{host:[],srflx:[],relay:[]}}),f.receiving[g].push({sdpMid:E.sdpMid,sdpMLineIndex:E.sdpMLineIndex,candidate:E.candidate}),s.gatheredCandidates[r]=f,Xi.setSkylinkState(s,n),null},getPeerList:e=>{const{result:t,type:r}=e,n=t;Ys.log.INFO(["Server",null,r,"Received list of peers"],n),Vs(Pe({state:tt.DISPATCHED,privilegePeerId:null,peerList:n}));},introduceError:e=>{const t=Xi.getSkylinkState(),{room:r,user:n}=t;Ys.log.WARN(["Server",null,e.type,`Introduce failed. Reason: ${e.reason}`]),(new tn).send(r.id,e),Vs(((e={})=>new pe("introduceStateChange",{detail:e}))({state:"introduceStateChange".ERROR,privilegedPeerId:n.sid,receivingPeerId:e.receivingPeerId,sendingPeerId:e.sendingPeerId,reason:e.reason}));},stream:e=>{const{mid:t,rid:r,status:n,streamId:s,settings:i}=e,o=_s(r),{room:a,peerInformations:c}=o;if(n===gt.SCREENSHARE_REPLACE_START&&(c[t].screenshare=!0,Xi.setSkylinkState(o,a.id),Vs(Se({room:a,peerId:t,isSelf:!1,peerInfo:Qt.getPeerInfo(t,a),stream:null,isReplace:!0,streamId:s,isVideo:!!i.audio,isAudio:!!i.video}))),n===gt.USER_MEDIA_REPLACE_START&&Vs(ue({room:a,peerId:t,isSelf:!1,peerInfo:Qt.getPeerInfo(t,a),stream:null,streamId:s,isReplace:!0,replacedStreamId:i.replacedStreamId,isVideo:!!i.audio,isAudio:!!i.video})),n===gt.ENDED&&(i.isScreensharing&&(c[t].screenshare=!1,Xi.setSkylinkState(o,a.id)),Vs(Ee({room:a,peerId:t,peerInfo:Qt.getPeerInfo(t,a),streamId:s,isSelf:!1,isScreensharing:i.isScreensharing,options:i,isVideo:!!i.audio,isAudio:!!i.video}))),n===gt.REPLACED_STREAM_ENDED){const e=zt.retrieveRemoteStreams(o,t);if(!e)return null;const r=Object.values(e);let n=null;for(let t=0;t<r.length;t+=1)if(e[t].id===s){n=r[t];break}if(!n)return null;n.getTracks().forEach(e=>{Dn.onremovetrack(t,a,s,e,!1);});}return null},bye:e=>{const{mid:t,rid:r,publisherId:n}=e,s=r;let i=t;Xi.getSkylinkState(s).hasMCU&&(i=n),Ys.log.INFO([i,Ct.PEER_CONNECTION,null,Lt.ROOM.LEAVE_ROOM.PEER_LEFT.START]);try{sn(s,i),((e,t)=>{Xi.getSkylinkState(e).peerConnections[t]&&nn(e,t);})(s,i),((e,t)=>{const r=Xi.getSkylinkState(e);setTimeout(()=>{delete r.peerConnections[t],Xi.setSkylinkState(r,r.room.id),Ys.log.INFO([t,Ct.PEER_CONNECTION,null,Lt.ROOM.LEAVE_ROOM.PEER_LEFT.SUCCESS]);},500),delete r.peerInformations[t],delete r.peerMedias[t],delete r.remoteStreams[t],delete r.peerMessagesStamps[t],delete r.peerEndOfCandidatesCounter[t],delete r.peerCandidatesQueue[t],delete r.sdpSessions[t],delete r.peerStats[t],delete r.peerBandwidth[t],delete r.gatheredCandidates[t],delete r.peerCustomConfigs[t],delete r.peerConnStatus[t];})(s,i),((e,t)=>{const r=Xi.getSkylinkState(e);oi.closeDataChannel(r,t);})(s,i);}catch(e){Ys.log.DEBUG([i,Ct.ROOM,null,Lt.ROOM.LEAVE_ROOM.PEER_LEFT.ERROR],e);}},recording:e=>{const{action:t,rid:r,recordingId:n,error:s}=e,i=_s(r);"on"===t?((e,t)=>{const r=Object.assign({},e),{room:n}=r;Ys.log.DEBUG([Nt.MCU,Ct.RECORDING,t,Lt.RECORDING.START_SUCCESS]),Nn.send(n.id,Lt.STATS_MODULE.HANDLE_RECORDING_STATS.START,t,null,null),r.currentRecordingId=t,r.recordings[t]={active:!0,state:St.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,error:null},r.recordingStartInterval=setTimeout(()=>{Ys.log.INFO([Nt.MCU,Ct.RECORDING,t,Lt.RECORDING.MIN_RECORDING_TIME_REACHED]),r.recordingStartInterval=null;},4e3),Xi.setSkylinkState(r,n.id),Pn(St.START,t);})(i,n):"off"===t?((e,t)=>{const r=Object.assign({},e),{room:n,recordings:s}=r;Nn.send(n.id,Lt.STATS_MODULE.HANDLE_RECORDING_STATS.STOP,t,null,null),s[t]?(r.currentRecordingId=null,r.recordingStartInterval&&(clearTimeout(r.recordingStartInterval),Ys.log.WARN([Nt.MCU,Ct.RECORDING,t,Lt.RECORDING.ERRORS.STOP_ABRUPT]),r.recordingStartInterval=null),Ys.log.DEBUG([Nt.MCU,Ct.RECORDING,t,Lt.RECORDING.STOP_SUCCESS]),r.recordings[t].active=!1,r.recordings[t].state=St.STOP,r.recordings[t].endedDateTime=(new Date).toISOString(),Xi.setSkylinkState(r,n.id),Pn(St.STOP,t)):Ys.log.ERROR([Nt.MCU,Ct.RECORDING,t,Lt.RECORDING.ERRORS.SESSION_EMPTY]);})(i,n):"error"===t&&(Pn(null,n,s),Ys.log.ERROR([Nt.MCU,Ct.RECORDING,n,Lt.RECORDING.ERRORS.MCU_RECORDING_ERROR],s),Nn.send(i.room.id,Lt.STATS_MODULE.HANDLE_RECORDING_STATS.MCU_RECORDING_ERROR,n,null,s));},redirect:e=>{Ys.log.INFO(["Server",null,e.type,"System action warning:"],e),Object.keys((new li).getAllStates()).length>1&&e.action===rt.REJECT&&vs(),"toClose"===e.reason&&(e.reason="toclose"),Xi.removeSkylinkState(Xi.getSkylinkState(e.rid)),Vs((e=>new pe("systemAction",{detail:e}))({action:e.action,info:e.info,reason:e.reason,rid:e.rid}));},rtmp:e=>{const{action:t,rid:r}=e,n=_s(r);Ys.log.DEBUG([Nt.MCU,"RTMP",null,Lt.RTMP.message_received_from_sig]),t===Mn?((e,t)=>{const{rtmpSessions:r}=e,{rtmpId:n,peerId:s,streamId:i}=t;if(!r[n]){const t=Object.assign({},e);Ys.log.DEBUG([Nt.MCU,"RTMP",Lt.RTMP.started_success]),t.rtmpSessions[n]={active:!0,state:Rt.START,startedDateTime:(new Date).toISOString(),endedDateTime:null,peerId:s,streamId:i},Vs(Ue({state:Rt.START,rtmpId:n,error:null})),Xi.setSkylinkState(t,t.room.id);}})(n,e):t===wn?((e,t)=>{const{rtmpSessions:r}=e,{rtmpId:n}=t,s=Object.assign({},e);r[n]?(Ys.log.DEBUG([Nt.MCU,"RTMP",Lt.RTMP.stopped_success]),s.rtmpSessions[n].active=!1,s.rtmpSessions[n].state=Rt.STOP,s.rtmpSessions[n].endedDateTime=(new Date).toISOString(),Vs(Ue({state:Rt.STOP,rtmpId:n,error:null})),Xi.setSkylinkState(s,s.room.id)):Ys.log.DEBUG([Nt.MCU,"RTMP",Lt.RTMP.stop_session_empty]);})(n,e):((e,t)=>{const{error:r,rtmpId:n}=t,{rtmpSessions:s}=e,i=new Error(r||"Unkown Error"),o=Object.assign({},e);s[n]?(Ys.log.DEBUG([Nt.MCU,"RTMP",Lt.RTMP.error_session]),o.rtmpSessions[n].state=Rt.ERROR,o.rtmpSessions[n].error=i,s[n].active&&(Ys.log.DEBUG([Nt.MCU,"RTMP",Lt.RTMP.error_Session_abrupt]),o.rtmpSessions[n].active=!1),Vs(Ue({state:Rt.ERROR,rtmpId:n,error:i})),Xi.setSkylinkState(o,o.room.id)):Ys.log.DEBUG([Nt.MCU,"RTMP",Lt.RTMP.error_session_empty]);})(n,e);},muteVideoEvent:e=>{const{type:t,mid:r,muted:n,rid:s,stamp:i,streamId:o}=e,a=r,c=Xi.getSkylinkState(s),{room:d}=c;if(!Fn(c,a))if(Ys.log.INFO([a,null,t,Lt.MEDIA_STREAM.VIDEO_MUTED,n,o],e),c.peerInformations[a]){if(c.peerMessagesStamps[a]){if(i<c.peerMessagesStamps[a].videoMuted)return void Ys.log.WARN([a,Ct.SIG_SERVER,t,Lt.SIGNALING.OUTDATED_MSG],e);c.peerMessagesStamps[a].videoMuted=i;}c.peerInformations[a].mediaStatus[o]||(c.peerInformations[a].mediaStatus[o]={}),c.peerInformations[a].mediaStatus[o].videoMuted=n?Tt.MUTED:Tt.ACTIVE,Xi.setSkylinkState(c,d.id),Bn(c,o,a);}else Ys.log.WARN([a,Ct.PEER_INFORMATION,t,`${Lt.PEER_INFORMATIONS.NO_PEER_INFO} ${a}`]);},muteAudioEvent:e=>{const{type:t,mid:r,rid:n,muted:s,stamp:i,streamId:o}=e,a=r,c=Xi.getSkylinkState(n),{room:d}=c;if(!Fn(c,a))if(Ys.log.INFO([a,Ct.SIG_SERVER,t,Lt.MEDIA_STREAM.AUDIO_MUTED,s,o],e),c.peerInformations[a]){if(c.peerMessagesStamps[a]){if(i<c.peerMessagesStamps[a].audioMuted)return void Ys.log.WARN([a,Ct.SIG_SERVER,t,Lt.SIGNALING.OUTDATED_MSG],e);c.peerMessagesStamps[a].audioMuted=i;}c.peerInformations[a].mediaStatus[o]||(c.peerInformations[a].mediaStatus[o]={}),c.peerInformations[a].mediaStatus[o].audioMuted=s?Tt.MUTED:Tt.ACTIVE,Xi.setSkylinkState(c,d.id),Bn(c,o,a);}else Ys.log.WARN([a,Ct.PEER_INFORMATION,t,`${Lt.PEER_INFORMATIONS.NO_PEER_INFO} ${a}`]);},setUserData:e=>{const{type:t,mid:r,rid:n,userData:s,stamp:i}=e,o=Xi.getSkylinkState(n),{peerInformations:a,peerMessagesStamps:c}=o,d=r,{PEER_INFORMATIONS:l}=Lt;let p=s.replace(/&quot;/g,'"');try{p=JSON.parse(p);}catch(e){Ys.log.INFO([d,null,t,`${l.USER_DATA_NOT_JSON}`],p);}finally{Ys.log.INFO([d,null,t,`${l.UPDATE_USER_DATA}`],p);}if(a[d]){if(c[d]&&ms(i)){if(i<c[d].userData)return void Ys.log.WARN([d,null,t,`${l.OUTDATED_MSG}`],e);c[d].userData=i;}a[d].userData=p||{},Vs(ve({peerId:d,peerInfo:Qt.getPeerInfo(d,o.room),isSelf:!1}));}else Ys.log.INFO([d,null,t,`${l.NO_PEER_INFO} ${d}`]);},mediaInfoEvent:e=>{const{mid:t,rid:r,mediaType:n,mediaId:s,publisherId:i}=e,o=Xi.getSkylinkState(r),{hasMCU:a,room:c}=o,d=a?i:t;try{if(!((e,t)=>{const r=e,{mediaId:n,publisherId:s}=t;return r.peerMedias[s]=r.peerMedias[s]||{},!r.peerMedias[s][n]&&(r.peerMedias[s][n]=t,Xi.setSkylinkState(r,r.room.id),!0)})(o,e)){const t=Object.values(vt);for(let i=0;i<t.length;i+=1)if(xn(r,d,s,t[i],e[t[i]])){if(Jn.updatePeerMediaInfo(o.room,d,s,t[i],e[t[i]]),t[i]===vt.MEDIA_STATE)return void Gn(c,n,d,e);if(t[i]===vt.TRANSCEIVER_MID)return void Un(d,e);Ln(d,e,t[i]);}}}catch(e){Ys.log.ERROR([d,Ct.SIG_SERVER,Lt.MEDIA_INFO.FAILED_PROCESSING_MEDIA_INFO_EVENT],e);}},storedMessages:e=>{Cr.processStoredMessages(e);}};class jn{userMessageHandler(...e){Vn.userMessageHandler(...e);}answerHandler(...e){Vn.answer(...e);}answerAckHandler(...e){Vn.answerAck(...e);}inRoomHandler(...e){Vn.inRoom(...e);}enterRoomHandler(...e){Vn.enter(...e);}offerHandler(...e){Vn.offer(...e);}welcomeHandler(...e){Vn.welcome(...e);}candidateHandler(...e){Vn.candidate(...e);}getPeerListHandler(...e){Vn.getPeerList(...e);}introduceErrorHandler(...e){Vn.introduceError(...e);}byeHandler(...e){Vn.bye(...e);}streamHandler(...e){Vn.stream(...e);}recordingHandler(...e){Vn.recording(...e);}redirectHandler(...e){Vn.redirect(...e);}rtmpHandler(...e){Vn.rtmp(...e);}setUserDataHandler(...e){Vn.setUserData(...e);}mediaInfoEventHandler(...e){Vn.mediaInfoEvent(...e);}muteAudioEventHandler(...e){Vn.muteAudioEvent(...e);}muteVideoEventHandler(...e){Vn.muteVideoEvent(...e);}storedMessagesHandler(...e){Vn.storedMessages(...e);}}const Hn={joinRoom:e=>{const{room:t}=e,r=Xi.getSkylinkState(t.id),n=Xi.getInitOptions();return {type:ht.JOIN_ROOM,uid:r.user.uid,cid:r.key,rid:t.id,userCred:r.user.token,timeStamp:r.user.timeStamp,apiOwner:r.appKeyOwner,roomCred:t.token,start:t.startDateTime,len:t.duration,isPrivileged:r.isPrivileged,autoIntroduce:r.autoIntroduce,key:n.appKey}},enterRoom:e=>{const{room:t}=e,r=Xi.getSkylinkState(t.id),n=Xi.getInitOptions(),{user:s,peerPriorityWeight:i,enableIceRestart:o,hasMCU:a}=r,{enableDataChannel:c}=n,{AdapterJS:d}=window,l=Qt.getUserInfo(t),p={type:ht.ENTER,mid:s.sid,rid:t.id,agent:d.webrtcDetectedBrowser,version:(d.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,receiveOnly:Qt.getCurrentSessionInfo(t).config.receiveOnly,weight:i,temasysPluginVersion:d.WebRTCPlugin.plugin?d.WebRTCPlugin.plugin.VERSION:null,enableDataChannel:c,enableIceRestart:o,SMProtocolVersion:ct,DTProtocolVersion:He};return a&&(p.target=Nt.MCU,p.publisherId=s.sid),p},welcome:(e,t)=>{const r=Xi.getSkylinkState(e.id),n=Xi.getInitOptions(),{user:s,peerPriorityWeight:i,enableIceRestart:o,room:a}=r,{enableDataChannel:c}=n,{AdapterJS:d}=window,l=Qt.getUserInfo(a);return {type:ht.WELCOME,mid:s.sid,rid:a.id,agent:d.webrtcDetectedBrowser,version:(d.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:l,receiveOnly:Qt.getCurrentSessionInfo(a).config.receiveOnly,weight:i,temasysPluginVersion:d.WebRTCPlugin.plugin?d.WebRTCPlugin.plugin.VERSION:null,enableDataChannel:c,enableIceRestart:o,SMProtocolVersion:ct,DTProtocolVersion:He,target:t}},offer:(...e)=>oi.createOffer(...e),answer:(...e)=>oi.createAnswer(...e),answerAck:(e,t,r)=>{const{room:n,user:s}=e;return {type:ht.ANSWER_ACK,rid:n.id,mid:s.sid,target:t,success:r}},candidate:(e,t,r)=>{const n=t.room.id,s=Xi.getSkylinkState(n);return {type:ht.CANDIDATE,label:r.sdpMLineIndex,id:r.sdpMid,candidate:r.candidate,mid:s.user.sid,target:e,rid:n}},setUserData:e=>({type:ht.UPDATE_USER,mid:e.user.sid,rid:e.room.id,userData:Ts(e.userData)?e.userData:JSON.stringify(e.userData),stamp:(new Date).getTime()}),getPeerList:e=>({type:ht.GET_PEERS,showAll:e}),restartOffer:(e,t,r)=>{const n=Xi.getSkylinkState(e),{AdapterJS:s}=window,i=Xi.getInitOptions(),{user:o,room:a,enableIceRestart:c,peerInformations:d,peerPriorityWeight:l}=n;return {type:ht.RESTART,mid:o.sid,rid:a.id,agent:s.webrtcDetectedBrowser,version:(s.webrtcDetectedVersion||0).toString(),os:window.navigator.platform,userInfo:Qt.getUserInfo(a),target:t,weight:l,receiveOnly:Qt.getCurrentSessionInfo(a).config.receiveOnly,publishOnly:Qt.getCurrentSessionInfo(a).config.publishOnly,enableDataChannel:i.enableDataChannel,enableIceRestart:c,doIceRestart:!0===r&&c&&d[t]&&d[t].config.enableIceRestart,isRestartResend:!1,temasysPluginVersion:s.WebRTCPlugin.plugin?s.WebRTCPlugin.plugin.VERSION:null,SMProtocolVersion:ct,DTProtocolVersion:He}},stream:(e,t,r,n,s)=>({type:ht.STREAM,mid:t.sid,rid:e,status:n,streamId:r.id,settings:s}),recording:(e,t)=>({type:t,rid:e,target:Nt.MCU}),rtmp:(e,t,r,n,s=null,i=null)=>{const o={type:e,rid:t,rtmpId:n,streamId:s,endpoint:i,mid:r,target:Nt.MCU};return e===ht.STOP_RTMP&&(delete o.endpoint,delete o.streamId),o},bye:(e,t)=>{const{room:r,user:n,hasMCU:s}=e,i={type:ht.BYE,rid:r.id,mid:n.sid,target:t};return s&&(i.publisherId=n.sid),i},roomLock:e=>{const{user:t,room:r,roomLocked:n}=e;return {type:ht.ROOM_LOCK,mid:t.sid,rid:r.id,lock:n}},mediaInfoEvent:(e,t,r)=>({type:ht.MEDIA_INFO_EVENT,rid:e.room.id,mid:r.publisherId,target:t,publisherId:r.publisherId,mediaId:r.mediaId,mediaType:r.mediaType,mediaState:r.mediaState,transceiverMid:r.transceiverMid}),muteAudioEvent:(e,t)=>{const r=Xi.getSkylinkState(e.id),{user:n,streamsMutedSettings:s}=r;return {type:ht.MUTE_AUDIO_EVENT,mid:n.sid,rid:e.id,muted:s[t].audioMuted,stamp:(new Date).getTime(),streamId:t}},muteVideoEvent:(e,t)=>{const r=Xi.getSkylinkState(e.id),{user:n,streamsMutedSettings:s}=r;return {type:ht.MUTE_VIDEO_EVENT,mid:n.sid,rid:e.id,muted:s[t].videoMuted,stamp:(new Date).getTime(),streamId:t}},getStoredMessages:e=>{const{user:t,room:r}=e;return {mid:t.sid,rid:r.id,target:t.sid,type:ht.GET_STORED_MESSAGES}},userMessages:(e,t,r)=>{const n=[],{user:s,room:i}=e,{listOfPeers:o,isPrivate:a,isPersistent:c,secretId:d}=t,l={data:r,mid:s.sid,rid:i.id,msgId:Ds(),type:ht.MESSAGE};if(d&&(l.secretId=d),a)for(let e=0;e<o.length;e+=1){const t=o[e],s=Object.assign({},l);s.target=t,n.push(s),Ys.log.DEBUG([t,Ct.MESSAGING,null,Lt.MESSAGING.PRIVATE_MESSAGE],{message:r});}else c&&(l.isPersistent=c),n.push(l),Ys.log.DEBUG([null,Ct.MESSAGING,null,Lt.MESSAGING.BROADCAST_MESSAGE],{message:r});return n}};class Wn{constructor(){this.messageBuilders=Hn;}getJoinRoomMessage(...e){return this.messageBuilders.joinRoom(...e)}getWelcomeMessage(...e){return this.messageBuilders.welcome(...e)}getEnterRoomMessage(...e){return this.messageBuilders.enterRoom(...e)}getAnswerMessage(...e){return this.messageBuilders.answer(...e)}getAnswerAckMessage(...e){return this.messageBuilders.answerAck(...e)}getOfferMessage(...e){return this.messageBuilders.offer(...e)}getCandidateMessage(...e){return this.messageBuilders.candidate(...e)}getSetUserDataMessage(e){return this.messageBuilders.setUserData(e)}getPeerListMessage(...e){return this.messageBuilders.getPeerList(...e)}getRestartOfferMessage(...e){return this.messageBuilders.restartOffer(...e)}getStreamMessage(...e){return this.messageBuilders.stream(...e)}getRecordingMessage(...e){return this.messageBuilders.recording(...e)}getPeerMessagesForSignaling(...e){return this.messageBuilders.signalingMessages(...e)}getMuteAudioMessage(...e){return this.messageBuilders.muteAudioEvent(...e)}getMuteVideoMessage(...e){return this.messageBuilders.muteVideoEvent(...e)}getRTMPMessage(...e){return this.messageBuilders.rtmp(...e)}getByeMessage(...e){return this.messageBuilders.bye(...e)}getRoomLockMessage(...e){return this.messageBuilders.roomLock(...e)}getMediaInfoEventMessage(...e){return this.messageBuilders.mediaInfoEvent(...e)}getGetStoredMessagesMessage(...e){return this.messageBuilders.getStoredMessages(...e)}getUserMessages(...e){return this.messageBuilders.userMessages(...e)}}const Kn={POLLING:"Polling",WEBSOCKET:"WebSocket",XHR_POLLING:"xhr-polling",JSONP_POLLING:"jsonp-polling"};let $n=null;class zn{constructor(){return $n||($n=this),this.socket=null,this.attempts=0,this.timestamp=(new Date).valueOf(),this.messageHandler=new jn,this.messageBuilder=new Wn,this.config=null,$n}resetSocketConfig(e){return {protocol:e,socketType:window.WebSocket?Kn.WEBSOCKET:Kn.POLLING,signalingServerProtocol:e,socketSession:{finalAttempts:0,attempts:0},fallbackType:null,signalingServerPort:null,socketTimeout:!1}}createSocket(e){const t=Xi.getSkylinkState(e);return t.socketSession=this.resetSocketConfig(t.signalingServerProtocol),Xi.setSkylinkState(t,e),new Promise((t,r)=>{try{null!==this.socket&&this.socket instanceof window.io.Socket&&this.socket.connected?t():this.tryCreateSocket(e,t,r);}catch(n){this.handleCreateSocketFailure(e,t,r,n);}})}tryCreateSocket(e,t,r){const n=Xi.getSkylinkState(e),{socketSession:s}=n;this.socket=or({config:s,roomKey:e}),lr(e,this,t,r);}handleCreateSocketFailure(e,t,r,n){const s=Xi.getSkylinkState(e),{socketSession:i}=s;Ys.log.ERROR(Lt.INIT.SOCKET_CREATE_FAILED,n),Vs(ke({session:Ut(i),errorCode:ot.CONNECTION_FAILED,type:i.fallbackType,error:n})),r(n);}dispatchHandshakeProgress(e,t){Vs(Ce({peerId:e.user.sid,state:et[t],error:null,room:e.room}));}answer(...e){return this.messageBuilder.getAnswerMessage(...e).then(t=>{const r=e[0];return this.sendMessage(t),this.dispatchHandshakeProgress(r,"ANSWER"),t})}answerAck(...e){const t=this.messageBuilder.getAnswerAckMessage(...e),r=e[0];this.sendMessage(t),this.dispatchHandshakeProgress(r,"ANSWER_ACK");}enterRoom(...e){const t=this.messageBuilder.getEnterRoomMessage(...e);this.sendMessage(t),this.dispatchHandshakeProgress(...e,"ENTER");}joinRoom(...e){const t=this.messageBuilder.getJoinRoomMessage(...e);this.sendMessage(t);}offer(...e){const t=e[0],r=e[1],n=Xi.getSkylinkState(t.id);n.peerConnections[r].negotiating?Ys.log.DEBUG([r,Ct.SIG_SERVER,null,`${Lt.SIGNALING.ABORTING_OFFER}`]):this.messageBuilder.getOfferMessage(...e).then(e=>{this.sendMessage(e),this.dispatchHandshakeProgress(n,"OFFER");});}welcome(...e){const t=this.messageBuilder.getWelcomeMessage(...e);this.sendMessage(t);}noop(){return null}sendCandidate(...e){const t=this.messageBuilder.getCandidateMessage(...e);t&&this.sendMessage(t);}setUserData(e){const t=this.messageBuilder.getSetUserDataMessage(e);t&&this.sendMessage(t);}getPeerList(e){const t=this.messageBuilder.getPeerListMessage(e);t&&this.sendMessage(t);}stream(...e){const t=this.messageBuilder.getStreamMessage(...e);t&&this.sendMessage(t);}recording(...e){const t=this.messageBuilder.getRecordingMessage(...e);this.sendMessage(t);}rtmp(...e){const t=this.messageBuilder.getRTMPMessage(...e);this.sendMessage(t);}muteAudioEvent(e,t){const r=this.messageBuilder.getMuteAudioMessage(e,t);r&&this.sendMessage(r);}muteVideoEvent(e,t){const r=this.messageBuilder.getMuteVideoMessage(e,t);r&&this.sendMessage(r);}roomLock(e){const t=this.messageBuilder.getRoomLockMessage(e);t&&this.sendMessage(t);}bye(...e){const t=this.messageBuilder.getByeMessage(...e);this.sendMessage(t);}mediaInfoEvent(e,t,r){const n=this.messageBuilder.getMediaInfoEventMessage(e,t,r);n&&this.sendMessage(n);}getStoredMessages(e){const t=this.messageBuilder.getGetStoredMessagesMessage(e);t&&this.sendMessage(t);}onMessage(e){const t=Xi.getSkylinkState(JSON.parse(e).rid);if(!t)return;const{socketSession:r}=t;Vs(be({message:e,socketSession:Ut(r)})),ar(this.messageHandler,JSON.parse(e));}sendMessage(e){pr(e)||(Ys.log.INFO(["SIG SERVER",null,e.type,"sent"]),cr(this.socket,e));}sendUserMessage(e,t,r){const n=this.messageBuilder.getUserMessages(e,t,r);Array.isArray(n)&&n.length&&n.map(e=>(this.sendMessage(e),null));}updateAttempts(e,t,r){this.attempts=r;const n=Xi.getSkylinkState(e),{socketSession:s}=n;s.socketSession[t]=r,Xi.setSkylinkState(n,e);}getAttempts(){return this.attempts}}const Yn={retrieveTransceiverMid:(e,t)=>{const r=Xi.getSkylinkState(e.id),{peerConnections:n}=r,s=Object.values(n);let i=null;for(let e=0;e<s.length;e+=1){const r=s[e].getTransceivers();for(let e=0;e<r.length;e+=1)if(r[e].sender.track&&r[e].sender.track.id===t.id){i=r[e].mid;break}}return i},retrieveMediaState:e=>e.readyState===It.ENDED?At.UNAVAILABLE:e.muted?At.MUTED:At.ACTIVE,retrieveMediaId:(e,t)=>{return `${e===Ot.AUDIO?"AUDIO":"VIDEO"}_${t}`},buildPeerMediaInfo:(e,t,r,n,s)=>({publisherId:t,mediaId:Yn.retrieveMediaId(r.kind,n),mediaType:s,mediaState:Yn.retrieveMediaState(r),transceiverMid:Yn.retrieveTransceiverMid(e,r),streamId:n,trackId:r.id,mediaMetaData:"",simulcast:""}),retrieveStreamIdOfTrack:(e,t)=>{const r=Xi.getSkylinkState(e.id),{streams:n}=r,s=Object.values(n.userMedia);let i=null;for(let e=0;e<s.length;e+=1){const r=s[e].stream.getTracks();for(let n=0;n<r.length;n+=1)if(Gt(r[n],t)){i=s[e].id;break}}return i},retrieveTracks:e=>{const t=Xi.getSkylinkState(e.id),{streams:r}=t,n=[];return Object.values(r.userMedia).map(e=>e.stream).forEach(e=>{e.getTracks().forEach(e=>{n.push(e);});}),n},updatePeerMediaInfo:(e,t,r,n,s=!1,i=!1,o=!1)=>{try{((e,t,r,n,s=!1,i=!1,o=!1)=>{const a=Xi.getSkylinkState(e.id);!o&&s&&i?(a.peerMedias[t][n][s]=i,Ys.log.INFO([t,Ct.PEER_MEDIA,null,`${Lt.MEDIA_INFO.UPDATE_SUCCESS} -- ${n} - ${s}: ${i}`])):!o||s||i||(a.peerMedias[t]=a.peerMedias[t]||{},a.peerMedias[t][n]=o),Xi.setSkylinkState(a,e.id);})(e,t,0,n,s,i,o),((e,t,r,n)=>{const s=Xi.getSkylinkState(e.id);s.user.sid===t&&r&&Yn.sendMediaInfoMsg(e,s.peerMedias[t][n]);})(e,t,r,n);}catch(e){const r=o?JSON.stringify(o):`${n} - ${s}: ${i}`;Ys.log.ERROR([t,Ct.PEER_MEDIA,null,`${Lt.MEDIA_INFO.ERRORS.FAILED_UPDATING} -- ${r}`],e);}},sendMediaInfoMsg:(e,t)=>{const r=new zn,n=Xi.getSkylinkState(e.id),{user:s,hasMCU:i,peerConnections:o}=n;(i?[Nt.MCU]:Object.keys(o).filter(e=>e!==s.sid&&e!==Nt.MCU)).forEach(e=>{r.mediaInfoEvent(n,e,t);});},parseSDPForTransceiverMid:(e,t,r)=>{const n=Xi.getSkylinkState(e.id),{peerMedias:s}=n,{beSilentOnParseLogs:i}=Xi.getInitOptions(),o=Object.values(s[t]),a=Zs.getTransceiverMid(r,i),c=a.audio,d=a.video;for(let r=0;r<o.length;r+=1){const n=o[r];n.transceiverMid=n.mediaState===At.UNAVAILABLE?n.transceiverMid:null;for(let r=0;r<c.length;r+=1)if(c[r].streamId===n.streamId&&("sendonly"===c[r].direction||"sendrecv"===c[r].direction)){Yn.updatePeerMediaInfo(e,t,!1,n.mediaId,vt.TRANSCEIVER_MID,c[r].transceiverMid);break}for(let r=0;r<d.length;r+=1)if(d[r].streamId===n.streamId&&("sendonly"===d[r].direction||"sendrecv"===d[r].direction)){Yn.updatePeerMediaInfo(e,t,!1,n.mediaId,vt.TRANSCEIVER_MID,d[r].transceiverMid);break}}},retrieveValueGivenTransceiverMid:(e,t,r,n)=>{const{peerMedias:s}=e,i=Object.values(s[t]);for(let e=0;e<i.length;e+=1)if(i[e].transceiverMid===r)return i[e][n];return null},retrieveFormattedMediaInfo:(e,t)=>{const r=Xi.getSkylinkState(e.id),{peerMedias:n}=r,s=Object.values(n[t]),i=[];for(let e=0;e<s.length;e+=1){const t=s[e],r=Ut(t);delete r.trackId,delete r.streamId,i.push(r);}return i},resetPeerMedia:(e,t)=>{const r=Xi.getSkylinkState(e.id);return r.peerMedias[t]&&(r.peerMedias[t]={}),r},populatePeerMediaInfo:(e,t,r)=>{const n=e.peerMedias[r.publisherId]||{};return n[r.mediaId]=r,((e,t)=>!us(e)&&e[t])(t,r.mediaId)&&(n[r.mediaId].streamId=r.transceiverMid===t[r.mediaId].transceiverMid?t[r.mediaId].streamId:""),n},processOnRemoveTrack:(e,t,r)=>{const{AdapterJS:n}=window;if(n.webrtcDetectedBrowser===yt.REACT_NATIVE&&r){const{room:n}=e,s={track:{id:null,kind:null}},i={id:null};if(s.track.id=r.trackId,s.track.kind=r.mediaType===_t.AUDIO||r.mediaType===_t.AUDIO_MIC?Ot.AUDIO:Ot.VIDEO,i.id=r.streamId,s.stream=i,!(s.track.id||s.track.kind||i.id))return void Ys.log.DEBUG([t,Ct.MEDIA_STREAM,null,`${Lt.BROWSER_AGENT.REACT_NATIVE.ERRORS.DROPPING_ONREMOVETRACK}`],s);Dn.onremovetrack(t,n,r.mediaType===_t.VIDEO_SCREEN,s);}}};class Jn{static updatePeerMediaWithUserSid(e,t){const r=Xi.getSkylinkState(e.id);r.peerMedias[t]=Object.assign({},r.peerMedias.null),delete r.peerMedias.null,Xi.setSkylinkState(r,e.id),Object.keys(r.peerMedias[t]).forEach(r=>{Yn.updatePeerMediaInfo(e,t,!1,r,vt.PUBLISHER_ID,t);});}static updateStreamIdFromOntrack(e,t,r,n){const s=Xi.getSkylinkState(e.id),i=Yn.retrieveValueGivenTransceiverMid(s,t,r,vt.MEDIA_ID);Yn.updatePeerMediaInfo(e,t,!1,i,vt.STREAM_ID,n);}static isVideoScreenTrack(e,t,r){const{peerMedias:n}=e,s=Object.values(n[t]);for(let e=0;e<s.length;e+=1)if(s[e].transceiverMid===r)return s[e].mediaType===_t.VIDEO_SCREEN;return !1}static setMediaStateToUnavailable(e,t,r){Yn.updatePeerMediaInfo(e,t,!1,r,vt.MEDIA_STATE,At.UNAVAILABLE);}static deleteUnavailableMedia(e,t,r=null){const n=Xi.getSkylinkState(e.id);if(t===Nt.MCU||!n.peerMedias[t])return;let s;if(r)s=Ut(n.peerMedias[t][r]),delete n.peerMedias[t][r];else{const e=n.peerMedias[t];Object.values(e).forEach(e=>{e.mediaState===At.UNAVAILABLE&&(s=Ut(e),delete n.peerMedias[t][e.mediaId]);});}Xi.setSkylinkState(n,e.id),Yn.processOnRemoveTrack(n,t,s),s&&Vs(xe({mediaInfo:s}));}static updatePeerMediaInfo(e,t,r,n,s){Yn.updatePeerMediaInfo(e,t,!0,r,n,s);}static updateTransceiverMid(e,t){try{Yn.retrieveTracks(e).forEach(r=>{const n=Yn.retrieveTransceiverMid(e,r),s=Yn.retrieveStreamIdOfTrack(e,r),i=Yn.retrieveMediaId(r.kind,s);Yn.updatePeerMediaInfo(e,t,!1,i,vt.TRANSCEIVER_MID,n);});}catch(e){Ys.log.ERROR([t,Ct.PEER_MEDIA,null,Lt.MEDIA_INFO.ERRORS.FAILED_UPDATING_TRANSCEIVER_MID],e);}}static setPeerMediaInfo(e,t,r=[]){try{const n=Xi.getSkylinkState(e.id);if(t!==Nt.MCU||Ss(r)){if(t!==Nt.MCU){const s=Ut(n.peerMedias[t])||{},i=Yn.resetPeerMedia(e,t);r.forEach(e=>{i.peerMedias[e.publisherId]=Yn.populatePeerMediaInfo(i,s,e);}),Xi.setSkylinkState(i,e.id);}}else{const t=[];r.forEach(e=>{-1===t.indexOf(e.publisherId)&&t.push(e.publisherId);}),t.forEach(t=>this.setPeerMediaInfo(e,t,r));}}catch(e){Ys.log.ERROR([t,Ct.PEER_MEDIA,null,Lt.MEDIA_INFO.ERRORS.FAILED_SETTING_PEER_MEDIA_INFO]);}}static retrieveStreamId(e,t,r,n){const s=Xi.getSkylinkState(e.id),{peerMedias:i}=s,o=i[t][r],a=o.transceiverMid===n?o.streamId:null;return a||Ys.log.ERROR([t,Ct.PEER_MEDIA,null,Lt.MEDIA_INFO.ERRORS.NO_ASSOCIATED_STREAM_ID]),a}static retrieveMediaId(e,t){return Yn.retrieveMediaId(e,t)}static retrieveMediaInfoForOfferAnswer(e,t){const r=Xi.getSkylinkState(e.id).user.sid;return Yn.parseSDPForTransceiverMid(e,r,t),Yn.retrieveFormattedMediaInfo(e,r)}static processPeerMedia(e,t,r,n,s=!1){const i=Xi.getSkylinkState(e.id).peerMedias[t]||{},o=r.getTracks();let a=null;try{o.forEach(o=>{a=Yn.retrieveMediaId(o.kind,r.id),i[a]=Yn.buildPeerMediaInfo(e,t,o,r.id,o.kind===Ot.AUDIO?_t.AUDIO_MIC:n?_t.VIDEO_SCREEN:_t.VIDEO_CAMERA),Yn.updatePeerMediaInfo(e,t,s,a,null,null,i[a]);});}catch(e){Ys.log.ERROR([t,Ct.MEDIA_INFO,Lt.MEDIA_INFO.ERRORS.FAILED_PROCESSING_PEER_MEDIA],e);}}}const Xn=(e,t,r,n,s=!1)=>{const i=Xi.getSkylinkState(n);return (bs(r)&&e||ws(r)&&t)&&Vs(((e={})=>new pe("localMediaMuted",{detail:e}))({streamId:r.id,isScreensharing:s,mediaStatus:i.streamsMediaStatus[r.id]})),!0},Qn=(e,t,r)=>{let n=t;const{streams:{userMedia:s}}=e,i=r||Object.keys(s).filter(e=>s[e].isReplaced);if(0===i.length)return n;if(i.indexOf(n)>-1&&i.splice(i.indexOf(n),1),i.length>1)for(let t=0;t<i.length;t+=1)if(s[i[t]].newStream&&s[i[t]].newStream.id===n){n=i[t],Qn(e,n,i);break}return i[0]},qn=(e,t,r,n)=>{const s=Xi.getSkylinkState(r.id),i=Qn(s,n),{streamsMutedSettings:o}=s;if(e){const e=Jn.retrieveMediaId(Ot.VIDEO,i);Jn.updatePeerMediaInfo(r,s.user.sid,e,vt.MEDIA_STATE,o[i].videoMuted?At.MUTED:At.ACTIVE);}if(t){const t=Jn.retrieveMediaId(Ot.AUDIO,i);setTimeout(()=>Jn.updatePeerMediaInfo(r,s.user.sid,t,vt.MEDIA_STATE,o[i].audioMuted?At.MUTED:At.ACTIVE),e?1050:0);}},Zn=(e,t,r)=>{const{streams:n,streamsMutedSettings:s}=e;let i=!1,o=!1;return n.screenshare&&n.screenshare.id===r&&s[r].videoMuted!==t.videoMuted?o=!0:n.userMedia&&n.userMedia[r]&&(ws(n.userMedia[r].stream)&&s[r].audioMuted!==t.audioMuted&&(i=!0),bs(n.userMedia[r].stream)&&s[r].videoMuted!==t.videoMuted&&(o=!0)),{hasToggledAudio:i,hasToggledVideo:o}},es=(e,t,r)=>{const n=Xi.getSkylinkState(e),{streams:s,room:i,peerConnections:o,peerInformations:a}=n,c=Zn(n,r,t),{hasToggledAudio:d,hasToggledVideo:l}=c;let p=null,u=!1;if(s.userMedia&&s.userMedia[t]?p=s.userMedia[t].stream:s.screenshare&&s.screenshare.id===t&&(p=s.screenshare.stream,u=!0),p)if(((e,t,r)=>{const n=e,{room:s}=n;t.hasToggledAudio&&(n.streamsMutedSettings[r].audioMuted=!n.streamsMutedSettings[r].audioMuted),t.hasToggledVideo&&(n.streamsMutedSettings[r].videoMuted=!n.streamsMutedSettings[r].videoMuted),Ys.log.DEBUG(Lt.MEDIA_STREAM.UPDATE_MUTED_SETTINGS,n.streamsMutedSettings,r),Xi.setSkylinkState(n,s.id);})(n,c,t),((e,t)=>{const r=t,{room:n}=r,s=(e=>e.getAudioTracks())(e),i=(e=>e.getVideoTracks())(e);r.streamsMediaStatus[e.id].audioMuted=Tt.UNAVAILABLE,r.streamsMediaStatus[e.id].videoMuted=Tt.UNAVAILABLE,s.forEach(t=>{t.enabled=!r.streamsMutedSettings[e.id].audioMuted,r.streamsMediaStatus[e.id].audioMuted=r.streamsMutedSettings[e.id].audioMuted?Tt.MUTED:Tt.ACTIVE;}),i.forEach(t=>{t.enabled=!r.streamsMutedSettings[e.id].videoMuted,r.streamsMediaStatus[e.id].videoMuted=r.streamsMutedSettings[e.id].videoMuted?Tt.MUTED:Tt.ACTIVE;}),Xi.setSkylinkState(r,n.id),Ys.log.DEBUG(Lt.MEDIA_STREAM.UPDATE_MEDIA_STATUS,r.streamsMediaStatus,e.id);})(p,n),Xn(l,d,p,i.id,u),(e=>{const t=Xi.getSkylinkState(e.id).user.sid,r=Qt.getCurrentSessionInfo(e);Vs(ve({isSelf:!0,peerId:t,peerInfo:r}));})(i),((e,t,r)=>{const n=Xi.getSkylinkState(e.id);Vs(he({isSelf:!0,peerId:n.user.sid,peerInfo:Qt.getUserInfo(e),streamId:t.id,isScreensharing:r,isAudio:ws(t),isVideo:bs(t)}));})(i,p,u),!o[Nt.MCU]&&Ss(Object.keys(o))||o[Nt.MCU]&&Ss(Object.keys(a))){const e=r=>{const{state:n}=r.detail;n===et.ANSWER_ACK&&(qn(l,d,i,t),Fs(bt.HANDSHAKE_PROGRESS,e));};Bs(bt.HANDSHAKE_PROGRESS,e);}else setTimeout(()=>{qn(l,d,i,t);},500);},ts=e=>{switch(e){case 1:return !1;case 0:default:return !0}},rs=(e,t,r=null)=>{const{streams:n,room:s}=e;if(!hs(t))return void Ys.log.ERROR(Lt.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);if(!n.userMedia&&!n.screenshare)return void Ys.log.WARN(Lt.MEDIA_STREAM.ERRORS.NO_STREAM);if(r&&!((e,t)=>{const{streams:r}=t;let n=!1;return Object.keys(r.userMedia).forEach(t=>{t===e&&(n=!0);}),r.screenshare&&r.screenshare.id===e&&(n=!0),n})(r,e))return void Ys.log.ERROR(Lt.MEDIA_STREAM.ERRORS.INVALID_MUTE_OPTIONS,t);const i={audioMuted:Rs(t.audioMuted)?t.audioMuted:!ms(t.audioMuted)||ts(t.audioMuted),videoMuted:Rs(t.videoMuted)?t.videoMuted:!ms(t.videoMuted)||ts(t.videoMuted)};let o=[];if(r&&(n.userMedia[r]&&!n.userMedia[r].isReplaced||n.screenshare.id===r&&!n.screenshare.isReplaced)?o.push(r):(o=Object.keys(n.userMedia).filter(e=>!n.userMedia[e].isReplaced),n.screenshare&&!n.screenshare.isReplaced&&o.push(n.screenshare.id)),Ss(o))return void Ys.log.ERROR(Lt.MEDIA_STREAM.ERRORS.NO_STREAMS_MUTED,t);Object.values(o).filter(t=>Zn(e,i,t).hasToggledAudio||Zn(e,i,t).hasToggledVideo).forEach((e,t)=>{setTimeout(()=>es(s.id,e,i),0===t?0:1050);});},ns=(e,t)=>{for(let r=0;r<t.length;r+=1)if(e.id===t[r].id)return !0;return !1},ss=(e,t)=>{const r=e.getTransceivers?e.getTransceivers():[],n=t.getTracks();if(Ss(r))return !1;for(let e=0;e<r.length;e+=1)if(r[e].sender.track&&ns(r[e].sender.track,n))return !0;return !1},is=(e,t,r,n)=>{const s=e,i=r.getTracks();for(let e=0;e<i.length;e+=1){const o=n.addTrack(i[e],r);o&&Rn.processNewSender(s,t,o);}Xi.setSkylinkState(s,s.room.id);},os=(e,t,r,n)=>{const{peerConnections:s}=e,i=s[t].getSenders();let o=null;return r?(i.forEach(e=>{e.track&&e.track.id===r&&e.track.kind===n&&(o=e);}),o):o},as=(e,t)=>{const{user:r,room:n}=e,s=r.sid,i=Qt.getCurrentSessionInfo(n);Vs(ue({room:n,stream:t,streamId:t.id,isSelf:!0,peerId:s,peerInfo:i,isScreensharing:!1,isVideo:bs(t),isAudio:ws(t)})),Vs(ve({isSelf:!0,peerId:s,peerInfo:i}));},cs=(e,t,r,n)=>{const{AdapterJS:s}=window,{peerConnections:i,hasMCU:o}=e;"edge"===s.webrtcDetectedBrowser&&n(new Error(Lt.PEER_CONNECTION.refresh_no_edge_support));try{if(((e,t)=>{for(let r=0;r<t.length;r+=1)if(t[r])if(Array.isArray(t[r]))for(let n=0;n<t[r].length;n+=1)t[r][n]&&as(e,t[r][n]);else as(e,t[r]);})(e,t),Object.keys(i).length>0||o){oi.refreshPeerConnection(Object.keys(i),e,!1,{}).then(()=>{r(t);}).catch(e=>{Ys.log.ERROR(Lt.PEER_CONNECTION.ERRORS.REFRESH),n(e);});}else Ys.log.WARN(Lt.ROOM.ERRORS.NO_PEERS),r(t);}catch(e){Ys.log.ERROR(e);}},ds=e=>{const t={audio:{input:[],output:[]},video:{input:[]}};return e.forEach(e=>{const r={deviceId:e.deviceId||e.sourceId||"default",label:e.label,groupId:e.groupId||null};r.label=r.label||`Source for ${r.deviceId}`,["audio","audioinput"].indexOf(e.kind)>-1?t.audio.input.push(r):["video","videoinput"].indexOf(e.kind)>-1?t.video.input.push(r):"audiooutput"===e.kind&&t.audio.output.push(r);}),t},ls=(e,t,r,n)=>({id:r.id,stream:r,isReplaced:!1,settings:n.settings,constraints:n.getUserMediaSettings}),ps={parseMediaOptions:(e,t)=>{const r=Xi.getSkylinkState(t.room.id),n=e||{};if(r.userData=n.userData||r.userData||"",r.streamsBandwidthSettings={googleX:{},bAS:{}},r.publishOnly=!1,r.sdpSettings={connection:{audio:!0,video:!0,data:!0},direction:{audio:{send:!0,receive:!0},video:{send:!0,receive:!0}}},r.voiceActivityDetection="boolean"!=typeof n.voiceActivityDetection||n.voiceActivityDetection,r.peerConnectionConfig={bundlePolicy:Qe.BALANCED,rtcpMuxPolicy:qe.REQUIRE,iceCandidatePoolSize:0,certificate:Ze.AUTO,disableBundle:!1},r.bandwidthAdjuster=null,n.bandwidth&&("number"==typeof n.bandwidth.audio&&(r.streamsBandwidthSettings.bAS.audio=n.bandwidth.audio),"number"==typeof n.bandwidth.video&&(r.streamsBandwidthSettings.bAS.video=n.bandwidth.video),"number"==typeof n.bandwidth.data&&(r.streamsBandwidthSettings.bAS.data=n.bandwidth.data)),n.googleXBandwidth&&("number"==typeof n.googleXBandwidth.min&&(r.streamsBandwidthSettings.googleX.min=n.googleXBandwidth.min),"number"==typeof n.googleXBandwidth.max&&(r.streamsBandwidthSettings.googleX.max=n.googleXBandwidth.max)),n.sdpSettings&&(n.sdpSettings.direction&&(n.sdpSettings.direction.audio&&(r.sdpSettings.direction.audio.receive="boolean"!=typeof n.sdpSettings.direction.audio.receive||n.sdpSettings.direction.audio.receive,r.sdpSettings.direction.audio.send="boolean"!=typeof n.sdpSettings.direction.audio.send||n.sdpSettings.direction.audio.send),n.sdpSettings.direction.video&&(r.sdpSettings.direction.video.receive="boolean"!=typeof n.sdpSettings.direction.video.receive||n.sdpSettings.direction.video.receive,r.sdpSettings.direction.video.send="boolean"!=typeof n.sdpSettings.direction.video.send||n.sdpSettings.direction.video.send)),n.sdpSettings.connection&&(r.sdpSettings.connection.audio="boolean"!=typeof n.sdpSettings.connection.audio||n.sdpSettings.connection.audio,r.sdpSettings.connection.video="boolean"!=typeof n.sdpSettings.connection.video||n.sdpSettings.connection.video,r.sdpSettings.connection.data="boolean"!=typeof n.sdpSettings.connection.data||n.sdpSettings.connection.data)),n.publishOnly&&(r.sdpSettings.direction.audio.send=!0,r.sdpSettings.direction.audio.receive=!1,r.sdpSettings.direction.video.send=!0,r.sdpSettings.direction.video.receive=!1,r.publishOnly=!0),n.peerConnection&&"object"==typeof n.peerConnection){if("string"==typeof n.peerConnection.bundlePolicy)for(const e in Qe)Qe.hasOwnProperty(e)&&Qe[e]===n.peerConnection.bundlePolicy&&(r.peerConnectionConfig.bundlePolicy=n.peerConnection.bundlePolicy);if("string"==typeof n.peerConnection.rtcpMuxPolicy)for(const e in qe)qe.hasOwnProperty(e)&&qe[e]===n.peerConnection.rtcpMuxPolicy&&(r.peerConnectionConfig.rtcpMuxPolicy=n.peerConnection.rtcpMuxPolicy);if("number"==typeof n.peerConnection.iceCandidatePoolSize&&n.peerConnection.iceCandidatePoolSize>0&&(r.peerConnectionConfig.iceCandidatePoolSize=n.peerConnection.iceCandidatePoolSize),"string"==typeof n.peerConnection.certificate)for(const e in Ze)Ze.hasOwnProperty(e)&&Ze[e]===n.peerConnection.certificate&&(r.peerConnectionConfig.certificate=n.peerConnection.certificate);r.peerConnectionConfig.disableBundle=!0===n.peerConnection.disableBundle;}return n.autoBandwidthAdjustment&&(r.bandwidthAdjuster={interval:10,limitAtPercentage:100,useUploadBwOnly:!1},"object"==typeof n.autoBandwidthAdjustment&&("number"==typeof n.autoBandwidthAdjustment.interval&&n.autoBandwidthAdjustment.interval>=10&&(r.bandwidthAdjuster.interval=n.autoBandwidthAdjustment.interval),"number"==typeof n.autoBandwidthAdjustment.limitAtPercentage&&n.autoBandwidthAdjustment.limitAtPercentage>=0&&n.autoBandwidthAdjustment.limitAtPercentage<=100&&(r.bandwidthAdjuster.limitAtPercentage=n.autoBandwidthAdjustment.limitAtPercentage),"boolean"==typeof n.autoBandwidthAdjustment.useUploadBwOnly&&(r.bandwidthAdjuster.useUploadBwOnly=n.autoBandwidthAdjustment.useUploadBwOnly))),r},processStreamInState:(e=null,t={},r,n=!1,s=!1)=>{if(!e)return;const i=Xi.getSkylinkState(r);((e,t)=>{const{streams:r}=e;return !(!r.userMedia&&!r.screenshare)&&(!!(r.userMedia?Object.values(r.userMedia):[]).some(e=>e.id===t.id)||r.screenshare&&r.screenshare.id===t.id)})(i,e)||(ps.processNewStream(i.room,e,t,n),Jn.processPeerMedia(i.room,i.user.sid,e,n),s&&Ys.log.DEBUG([i.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.FALLBACK_SUCCESS]),n&&Ys.log.DEBUG([i.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.START_SCREEN_SUCCESS]),Vs(((e={})=>new pe("mediaAccessSuccess",{detail:e}))({stream:e,isScreensharing:n,isAudioFallback:s,streamId:e.id,isAudio:ws(e),isVideo:bs(e)})));},parseStreamSettings:(e,t=null)=>{const{AdapterJS:r}=window,n={settings:{audio:!1,video:!1},mutedSettings:{shouldAudioMuted:!1,shouldVideoMuted:!1},getUserMediaSettings:{audio:!1,video:!1}};return (e.audio&&!t||e.audio&&t===Ot.AUDIO)&&(n.settings.audio={stereo:!1,exactConstraints:!!e.useExactConstraints,echoCancellation:!0},n.getUserMediaSettings.audio={echoCancellation:!0},"object"==typeof e.audio&&("boolean"==typeof e.audio.stereo&&(n.settings.audio.stereo=e.audio.stereo),"boolean"==typeof e.audio.useinbandfec&&(n.settings.audio.useinbandfec=e.audio.useinbandfec),"boolean"==typeof e.audio.usedtx&&(n.settings.audio.usedtx=e.audio.usedtx),"number"==typeof e.audio.maxplaybackrate&&e.audio.maxplaybackrate>=8e3&&e.audio.maxplaybackrate<=48e3&&(n.settings.audio.maxplaybackrate=e.audio.maxplaybackrate),"boolean"==typeof e.audio.mute&&(n.mutedSettings.shouldAudioMuted=e.audio.mute),"edge"!==r.webrtcDetectedBrowser&&("boolean"==typeof e.audio.echoCancellation&&(n.settings.audio.echoCancellation=e.audio.echoCancellation,n.getUserMediaSettings.audio.echoCancellation=e.audio.echoCancellation),Array.isArray(e.audio.optional)&&(n.settings.audio.optional=Ut(e.audio.optional),n.getUserMediaSettings.audio.optional=Ut(e.audio.optional)),e.audio.deviceId&&"string"==typeof e.audio.deviceId&&"firefox"!==r.webrtcDetectedBrowser&&(n.settings.audio.deviceId=e.audio.deviceId,n.getUserMediaSettings.audio.deviceId=e.useExactConstraints?{exact:e.audio.deviceId}:{ideal:e.audio.deviceId}))),"edge"===r.webrtcDetectedBrowser&&(n.getUserMediaSettings.audio=!0)),(e.video&&!t||e.video&&t===Ot.VIDEO)&&(n.settings.video={resolution:Ut(pt.VGA),exactConstraints:!!e.useExactConstraints},n.getUserMediaSettings.video={},"object"==typeof e.video?("boolean"==typeof e.video.mute&&(n.mutedSettings.shouldVideoMuted=e.video.mute),Array.isArray(e.video.optional)&&(n.settings.video.optional=Ut(e.video.optional),n.getUserMediaSettings.video.optional=Ut(e.video.optional)),e.video.deviceId&&"string"==typeof e.video.deviceId&&(n.settings.video.deviceId=e.video.deviceId,n.getUserMediaSettings.video.deviceId=e.useExactConstraints?{exact:e.video.deviceId}:{ideal:e.video.deviceId}),e.video.resolution&&"object"==typeof e.video.resolution&&((e.video.resolution.width&&"object"==typeof e.video.resolution.width||"number"==typeof e.video.resolution.width)&&(n.settings.video.resolution.width=e.video.resolution.width),(e.video.resolution.height&&"object"==typeof e.video.resolution.height||"number"==typeof e.video.resolution.height)&&(n.settings.video.resolution.height=e.video.resolution.height)),n.getUserMediaSettings.video.width="object"==typeof n.settings.video.resolution.width?n.settings.video.resolution.width:e.useExactConstraints?{exact:n.settings.video.resolution.width}:{max:n.settings.video.resolution.width},n.getUserMediaSettings.video.height="object"==typeof n.settings.video.resolution.height?n.settings.video.resolution.height:e.useExactConstraints?{exact:n.settings.video.resolution.height}:{max:n.settings.video.resolution.height},(e.video.frameRate&&"object"==typeof e.video.frameRate||"number"==typeof e.video.frameRate&&"plugin"!==r.webrtcDetectedType)&&(n.settings.video.frameRate=e.video.frameRate,n.getUserMediaSettings.video.frameRate="object"==typeof n.settings.video.frameRate?n.settings.video.frameRate:e.useExactConstraints?{exact:n.settings.video.frameRate}:{max:n.settings.video.frameRate}),e.video.facingMode&&["string","object"].indexOf(typeof e.video.facingMode)>-1&&"plugin"===r.webrtcDetectedType&&(n.settings.video.facingMode=e.video.facingMode,n.getUserMediaSettings.video.facingMode="object"==typeof n.settings.video.facingMode?n.settings.video.facingMode:e.useExactConstraints?{exact:n.settings.video.facingMode}:{max:n.settings.video.facingMode})):n.getUserMediaSettings.video={width:e.useExactConstraints?{exact:n.settings.video.resolution.width}:{max:n.settings.video.resolution.width},height:e.useExactConstraints?{exact:n.settings.video.resolution.height}:{max:n.settings.video.resolution.height}},"edge"===r.webrtcDetectedBrowser&&(n.settings.video={exactConstraints:!!e.useExactConstraints},n.getUserMediaSettings.video=!0)),n},prepMediaAccessRequest:e=>new Promise((t,r)=>{const{roomKey:n,...s}=e,i=ps.parseStreamSettings(s,Ot.AUDIO),o=ps.parseStreamSettings(s,Ot.VIDEO),{AdapterJS:a}=window;i.getUserMediaSettings.audio||o.getUserMediaSettings.video||r(Lt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS),a.webRTCReady(()=>{window.navigator.mediaDevices.getUserMedia({audio:i.getUserMediaSettings.audio,video:o.getUserMediaSettings.video}).then(e=>{const r=ps.onStreamAccessSuccess(n,e,i,o,!1),s=Xi.getSkylinkState(n);r[0]&&i.mutedSettings.shouldAudioMuted&&rs(s,{audioMuted:i.mutedSettings.shouldAudioMuted,videoMuted:o.mutedSettings.shouldVideoMuted},r[0].id),r[1]&&o.mutedSettings.shouldVideoMuted&&rs(s,{audioMuted:i.mutedSettings.shouldAudioMuted,videoMuted:o.mutedSettings.shouldVideoMuted},r[1].id),t(r);}).catch(e=>ps.onStreamAccessError(e,r,t,n,i,o));});}),addLocalMediaStreams:(e,t)=>{const r=Xi.getSkylinkState(t.room.id),{peerConnections:n,streams:s}=r,i=n[e];s.userMedia&&((e,t,r,n)=>{const s=Object.keys(r);for(let i=0;i<s.length;i+=1){const{stream:o}=r[s[i]];ss(n,o)||is(e,t,o,n);}})(r,e,s.userMedia,i),s.screenshare&&((e,t,r,n)=>{const{stream:s}=r;ss(n,s)||is(e,t,s,n);})(r,e,s.screenshare,i);},onRemoteTrackAdded:(e,t,r,n,s,i)=>{const{user:o,hasMCU:a,room:c}=t,d={dispatchOnIncomingStream:e=>{Vs(ue(e));},dispatchOnIncomingScreenStream:e=>{e.isReplace=!1,Vs(Se(e));}},l=n?"dispatchOnIncomingScreenStream":"dispatchOnIncomingStream",p={stream:e,peerId:r,room:c,isSelf:a&&r===o.sid||!1,peerInfo:Qt.getPeerInfo(r,c),streamId:e.id,isVideo:s,isAudio:i};d[l](p),Vs(ve({peerId:r,peerInfo:Qt.getPeerInfo(r,c),isSelf:a&&r===o.sid||!1,room:c}));},onStreamAccessError:(e,t,r,n,s,i)=>{const o=Xi.getInitOptions(),a=Xi.getSkylinkState(n),{audioFallback:c}=o;if(s.settings.audio&&i.settings.video&&c){const o=!0;return Ys.log.DEBUG([a.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.START_FALLBACK]),Vs(Le({error:e,state:ut.FALLBACKING,isAudioFallback:o})),window.navigator.mediaDevices.getUserMedia({audio:!0}).then(e=>ps.onStreamAccessSuccess(n,e,s,i,o,r)).catch(r=>{Ys.log.ERROR([a.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.FALLBACK,r]),Vs(Ge({error:r,isAudioFallbackError:!0})),Vs(Le({error:e,state:ut.ERROR,isAudioFallback:o})),t(r);})}Ys.log.ERROR([a.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.GET_USER_MEDIA],e),Vs(Ge({error:e,isAudioFallbackError:!1})),t(e);},replaceTrack:(e,t,r,n)=>{const s=e.getVideoTracks()[0],i=e.getAudioTracks()[0],o=os(n,r,s?s.id:null,"video"),a=os(n,r,i?i.id:null,"audio"),c=t.getVideoTracks()[0],d=t.getAudioTracks()[0];try{s&&c&&o&&o.replaceTrack(c),i&&d&&a&&a.replaceTrack(d);}catch(e){Ys.log.ERROR([r,Ct.PEER_CONNECTION,null,Lt.PEER_CONNECTION.ERRORS.REPLACE_TRACK],e);}},muteStreams:rs,sendStream:(e,t=null)=>new Promise((r,n)=>{if(!e)return n(new Error(Lt.ROOM_STATE.NO_ROOM_NAME));const{inRoom:s}=e,{AdapterJS:i}=window,o=!(hs(t)&&null!==t||i&&i.WebRTCPlugin&&i.WebRTCPlugin.plugin);if(!s)return Ys.log.WARN(Lt.ROOM.ERRORS.NOT_IN_ROOM),n(new Error(`${Lt.ROOM.ERRORS.NOT_IN_ROOM}`));if(o)return n(new Error(`${Lt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${t}`));let a=!1;try{if(Array.isArray(t)){let s=!0;return t.forEach(e=>{fs(e.getAudioTracks)&&fs(e.getVideoTracks)||(s=!1);}),s?((e,t,r,n)=>{const s=[];return t.forEach(t=>{s.push(zt.usePrefetchedStream(e.room.id,t));}),Promise.all(s).then(t=>{cs(e,t,r,n);}).catch(e=>{n(e);})})(e,t,r,n):n(new Error(Lt.MEDIA_STREAM.ERRORS.INVALID_MEDIA_STREAM_ARRAY))}return (a=!!t&&(fs(t.getAudioTracks)||fs(t.getVideoTracks)))?((e,t,r,n)=>{return zt.usePrefetchedStream(e.room.id,t).then(t=>{cs(e,t,r,n);}).catch(e=>{n(e);})})(e,t,r,n):((e,t,r,n)=>{return zt.getUserMedia(e,t).then(t=>{cs(e,t,r,n);}).catch(e=>{n(e);})})(e,t,r,n)}catch(e){Ys.log.ERROR(Lt.MEDIA_STREAM.ERRORS.SEND_STREAM,e);}}),getStreamSources:()=>{const{navigator:e}=window;return new Promise((t,r)=>{e.mediaDevices&&fs(e.mediaDevices.enumerateDevices)?e.mediaDevices.enumerateDevices().then(e=>{t(ds(e));}):r(ds([]));})},getStreams:e=>{const{streams:{userMedia:t,screenshare:r}}=e,n={userMedia:null,screenshare:null};if(!t&&!r)return n;if(t){const e=Object.keys(t);n.userMedia={},e.forEach(e=>{n.userMedia[e]=t[e].stream;});}return r&&(n.screenshare=r.stream),n},getScreenSources:()=>new Promise(e=>{const{navigator:t,AdapterJS:r}=window,n={mediaSource:[],mediaSourceInput:[]};return t.userAgent.toLowerCase().indexOf("android")>-1?("chrome"===r.webrtcDetectedBrowser&&r.webrtcDetectedVersion>=59&&(n.mediaSource=["screen"]),e(n),null):(("chrome"===r.webrtcDetectedBrowser&&r.webrtcDetectedVersion>=34||"firefox"===r.webrtcDetectedBrowser&&r.webrtcDetectedVersion>=38||"opera"===r.webrtcDetectedBrowser&&r.webrtcDetectedVersion>=21)&&("opera"!==r.webrtcDetectedBrowser||r.extensionInfo&&r.extensionInfo.opera&&r.extensionInfo.opera.extensionId||Ys.log.WARN("Please ensure that your application allows Opera screensharing!"),n.mediaSource=["window","screen"],"chrome"===r.webrtcDetectedBrowser&&r.webrtcDetectedVersion>=52||"opera"===r.webrtcDetectedBrowser&&r.webrtcDetectedVersion>=39?n.mediaSource.push("tab","audio"):"firefox"===r.webrtcDetectedBrowser&&n.mediaSource.push("browser","camera","application")),e(n),null)}),updateStreamsMediaStatus:(e,t,r)=>{const n=Xi.getSkylinkState(e),{room:s,streamsMediaStatus:i}=n,{mutedSettings:{shouldAudioMuted:o},settings:{audio:a,video:c}}=t;i[r.id]={},i[r.id].audioMuted=a?o?Tt.MUTED:Tt.ACTIVE:Tt.UNAVAILABLE,i[r.id].videoMuted=c?o?Tt.MUTED:Tt.ACTIVE:Tt.UNAVAILABLE,Xi.setSkylinkState(n,s.id);},updateRemoteStreams:(e,t,r)=>{const n=Xi.getSkylinkState(e.id);n.remoteStreams[t]=n.remoteStreams[t]||{},n.remoteStreams[t][r.id]=r,Xi.setSkylinkState(n,e.id);},retrieveVideoStreams:e=>{const t=Xi.getSkylinkState(e.id),{streams:r}=t,n=[];return Object.values(r.userMedia).forEach(e=>{e.stream.getVideoTracks().length>0&&n.push(e.stream);}),n},splitAudioAndVideoStream:e=>{const{MediaStream:t}=window,r=[],n=e.getAudioTracks(),s=e.getVideoTracks();return ws(e)?r.push(new t(n)):r.push(null),bs(e)?r.push(new t(s)):r.push(null),r},processNewStream:(e,t,r,n)=>{((e,t,r,n)=>{const s=Xi.getSkylinkState(e.id),i=n?"screenshare":"userMedia";n?s.streams[i]=ls(s.room,s.user,t,r):(s.streams[i]=s.streams[i]?s.streams[i]:{},s.streams[i][t.id]=ls(s.room,s.user,t,r)),Xi.setSkylinkState(s,e.id);})(e,t,r,n),ps.updateStreamsMutedSettings(e.id,r,t),ps.updateStreamsMediaStatus(e.id,r,t);},updateStreamsMutedSettings:(e,t,r)=>{const n=Xi.getSkylinkState(e),{room:s,streamsMutedSettings:i}=n,{audio:o,video:a}=t.settings;i[r.id]={},i[r.id].audioMuted=!o,i[r.id].videoMuted=!a,Xi.setSkylinkState(n,s.id);},onStreamAccessSuccess:(e,t,r,n,s)=>{const i=ps.splitAudioAndVideoStream(t);return i.forEach(t=>{t&&ps.processStreamInState(t,ws(t)?r:n,e,!1,s);}),i}},us=e=>{return 0===Object.keys(e).length},Ss=e=>0===e.length,Es=e=>""===e,hs=e=>"object"==typeof e&&null!==e,gs=e=>"object"==typeof e&&null==e,ms=e=>"number"==typeof e,fs=e=>"function"==typeof e,Rs=e=>void 0!==e&&"boolean"==typeof e,Ts=e=>"string"==typeof e,Cs=(e,t,r)=>{let n=!0;return null!=e&&Ts(e)||(Ys.log.ERROR(`${r}: ${t} is null, undefined or not a string.`),n=!1),n},_s=e=>{if(Cs(e,"roomId","getStateByRid")){const t=Xi.getSkylinkState(),r=Object.keys(t);let n=null;for(let s=0;s<r.length;s+=1){const i=r[s];if(i===e){n=t[i];break}}return n}return Ys.log.ERROR(`getRoomStateByRid: ${Lt.ROOM_STATE.NOT_FOUND} - ${e}`),null},Is=e=>_s(e),Os=e=>{let t=null;if(Cs(e,"roomName","getRoomStateByName")){const r=Xi.getSkylinkState(),n=Object.keys(r);for(let s=0;s<n.length;s+=1){const i=r[n[s]];if(i.room.roomName.toLowerCase()===e.toLowerCase()){t=i;break}}}return t||Ys.log.ERROR(`getRoomStateByName: ${Lt.ROOM_STATE.NOT_FOUND} - ${e}`),t},As=(e,t)=>{const r=(e||"").split("."),n=(t||"").split(".");for(let e=0;e<n.length;e+=1)if((r[e]||"0")<(n[e]||"0"))return !0;return !1},vs=()=>{try{(new zn).socket.disconnect();}catch(e){Ys.log.ERROR(e);}},Ds=()=>{let e=(new Date).getTime();return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{const r=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?r:r&&15).toString(16)})},ys=e=>new Promise((t,r)=>{const{navigator:n}=window;e&&hs(e)||r(new Error(`${Lt.MEDIA_STREAM.ERRORS.INVALID_GUM_OPTIONS} ${e}`)),n.mediaDevices.getUserMedia(e).then(e=>{const r=ps.splitAudioAndVideoStream(e);t(r);}).catch(e=>{r(e);});}),Ns=e=>new Promise((t,r)=>{r(new Error(e));}),Ps=(e,t,r,n)=>{const{streams:s,room:i}=r,o=Object.values(s.userMedia);for(let r=0;r<o.length;r+=1)o[r].id===e.id&&(o[r].isReplaced=n,o[r].newStream=t);Xi.setSkylinkState(r,i.id);},Ms=(e,t)=>{const r=Xi.getSkylinkState(e.id),{peerConnections:n}=r,s=Object.keys(n);let i=!1;return s.forEach(e=>{e===t&&(i=!0);}),i},ws=e=>e.getAudioTracks().length>0,bs=e=>e.getVideoTracks().length>0,ks=e=>{const{AdapterJS:t}=window;switch(e){case yt.CHROME:return t.webrtcDetectedBrowser===yt.CHROME;case yt.SAFARI:return t.webrtcDetectedBrowser===yt.SAFARI;case yt.FIREFOX:return t.webrtcDetectedBrowser===yt.FIREFOX;default:return Ys.log.DEBUG(Lt.UTILS.INVALID_BROWSER_AGENT),!1}},Ls=e=>{const{AdapterJS:t}=window;return t.webrtcDetectedVersion===e},Us=e=>new Date(e).toISOString(),Gs=()=>(new Date).toISOString();const xs=new class{constructor(){this.events={},this.privateEvents={};}addPrivateEventListener(e,t){this.addListener(e,t,!0);}addEventListener(e,t){this.addListener(e,t,!1);}addListener(e,t,r){try{const n=r?"privateEvents":"events";if(!fs(t))return void Ys.log.DEBUG([null,Ct.SKYLINK_EVENT,e,Lt.LOGGER.INVALID_CB]);this[n][e]||(this[n][e]={}),this[n][e].callbacks||(this[n][e].callbacks=[]),this[n][e].callbacks.push(t),r||Ys.log.DEBUG([null,Ct.SKYLINK_EVENT,e,Lt.LOGGER.EVENT_REGISTERED]);}catch(t){Ys.log.ERROR([null,Ct.SKYLINK_EVENT,e,Lt.LOGGER.EVENT_REGISTER_ERROR],t);}}dispatchEvent(e){if(e.name===bt.LOGGED_ON_CONSOLE)return;let t=[];if(this.events[e.name]){const r=this.events[e.name].callbacks;t=t.concat(r);}else Ys.log.DEBUG([null,Ct.SKYLINK_EVENT,e.name,Lt.LOGGER.EVENT_DISPATCHED]);if(this.privateEvents[e.name]){const r=this.privateEvents[e.name]?this.privateEvents[e.name].callbacks:[];t=t.concat(r);}t.forEach(t=>{try{t(e.detail);}catch(t){Ys.log.ERROR([null,Ct.SKYLINK_EVENT,e.name,Lt.LOGGER.EVENT_DISPATCH_ERROR],t);}});}removeEventListener(e,t){this.removeListener(e,t,!1);}removePrivateEventListener(e,t){this.removeListener(e,t,!0);}removeListener(e,t,r){const n=r?"privateEvents":"events";if(r||this.events[e]&&this.events[e].callbacks)try{this[n][e].callbacks.forEach((s,i)=>{s===t&&(delete this[n][e].callbacks[i],r||Ys.log.DEBUG([null,Ct.SKYLINK_EVENT,e,Lt.LOGGER.EVENT_UNREGISTERED]));});}catch(t){Ys.log.ERROR([null,Ct.SKYLINK_EVENT,e,Lt.LOGGER.EVENT_DISPATCH_ERROR],t);}else Ys.log.WARN([null,Ct.SKYLINK_EVENT,e,Lt.LOGGER.EVENT_UNREGISTERED]);}},Bs=xs.addPrivateEventListener.bind(xs),Fs=xs.removePrivateEventListener.bind(xs),Vs=xs.dispatchEvent.bind(xs),js=["trace","debug","info","warn","error"],Hs=e=>{let t=!0;return "undefined"==typeof console?t=!1:void 0===console[e]&&(t=!1),t},Ws=(e,t,r,n=null)=>{const s=`[${(new Date).toISOString()}]`,i=e.level,{logLevels:o}=e;if(i<=t&&i!==o.SILENT){const e=js[t];if(!Hs(e))return;const i=(e=>{let t="SkylinkJS -";if(Array.isArray(e)){const[r,n,s,i]=e;if(t+=r?` [${r}]`:" -",t+=n?` <<${n}>>`:r?"":" <<Method>>",s)if(Array.isArray(s))for(let e=0;e<s.length;e+=1)t+=` (${s[e]})`;else t+=` (${s})`;t+=` ${i}`;}else t+=` ${e}`;return t})(r);if(Hs(e)&&(console[e](s,i,n||""),Vs(((e={})=>new pe("loggedOnConsole",{detail:e}))({level:e,message:i,debugObject:n}))),Ys.storeLogs){const t=[s,e.toUpperCase(),i];n&&t.push(n),Ys.storedLogs.push(t);}}},Ks=e=>{window.localStorage.setItem("loglevel:skylinkjs",e);},$s=e=>{const t=window.localStorage.getItem("loglevel:skylinkjs");return null===t||Number.isNaN(+t)?e.ERROR:+t};class zs{constructor(){this.logLevels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},this.level=$s(this.logLevels),this.storeLogs=!1,this.storedLogs=[];}setLevel(e=this.levels.ERROR,t){"number"==typeof e?(this.level=e,Ks(this.level)):this.level=this.levels.ERROR,t&&(this.storeLogs=t);}enableAll(){this.setLevel(this.logLevels.TRACE);}disableAll(){this.setLevel(this.logLevels.SILENT);}getLogs(){return this.storeLogs?this.storedLogs:(this.log.WARN(Lt.LOGGER.LOGS_NOT_STORED),null)}clearLogs(){this.log.INFO(Lt.LOGGER.LOGS_CLEARED),this.storedLogs=[];}}const Ys=new zs;zs.prototype.log={TRACE:(...e)=>{Ws(Ys,Ys.logLevels.TRACE,...e);},DEBUG:(...e)=>{Ws(Ys,Ys.logLevels.DEBUG,...e);},INFO:(...e)=>{Ws(Ys,Ys.logLevels.INFO,...e);},WARN:(...e)=>{Ws(Ys,Ys.logLevels.WARN,...e);},ERROR:(...e)=>{Ws(Ys,Ys.logLevels.ERROR,...e);}};const Js=(e,t,r,n,s)=>{const i=e.sdp.match(new RegExp("m="+t+" .*\r\n","gi"));if(Array.isArray(i)&&i.length>0){const i=e.sdp.match(new RegExp("a=rtpmap:.* "+r+"/"+(n?n+("audio"===t?"[/]*.*":".*"):".*")+"\r\n","gi"));if(Array.isArray(i)&&i.length>0)for(let t=0;t<i.length;t+=1){const r=(i[t].split("a=rtpmap:")[1]||"").split(" ")[0];if(!r)continue;const n=e.sdp.match(new RegExp("a=fmtp:"+r+" .*\r\n","gi"));let o="a=fmtp:"+r+" ";const a=[];if(Array.isArray(n)&&n.length>0){const t=(n[0].split("a=fmtp:"+r+" ")[1]||"").replace(/ /g,"").replace(/\r\n/g,"").split(";");for(let e=0;e<t.length;e+=1){if(!t[e])continue;const r=t[e].split("=");s.hasOwnProperty(r[0])?o+="boolean"==typeof s[r[0]]?s[r[0]]?r[0]+"=1;":"":r[0]+"="+s[r[0]]+";":o+=t[e]+";",a.push(r[0]);}e.sdp=e.sdp.replace(n[0],"");}for(const e in s)s.hasOwnProperty(e)&&-1===a.indexOf(e)&&(o+="boolean"==typeof s[e]?s[e]?e+"=1;":"":e+"="+s[e]+";",a.push(e));o!=="a=fmtp:"+r+" "&&(e.sdp=e.sdp.replace(i[t],i[t]+o+"\r\n"));}}},Xs=e=>((e.match(/a=rtpmap:.*\ rtx\/.*\r\n/gi)||[]).forEach(t=>{const r=(t.split("a=rtpmap:")[1]||"").split(" ")[0]||"",n=(e.match(new RegExp("a=fmtp:"+r+" .*\r\n","gi"))||[])[0];if(!n)return void(e=e.replace(new RegExp(t,"g"),""));const s=(n.split(" apt=")[1]||"").replace(/\r\n/gi,"");e.match(new RegExp("a=rtpmap:"+s+" .*\r\n","gi"))||(e=(e=e.replace(new RegExp(t,"g"),"")).replace(new RegExp(n,"g"),""));}),e),Qs=e=>((e.match(/a=(fmtp|rtcp-fb):.*\ rtx\/.*\r\n/gi)||[]).forEach(t=>{const r=(t.split("a="+(t.indexOf("rtcp")>0?"rtcp-fb":"fmtp"))[1]||"").split(" ")[0]||"";e.match(new RegExp("a=rtpmap:"+r+" .*\r\n","gi"))||(e=e.replace(new RegExp(t,"g"),""));}),e),qs={getSDPCommonSupports:(e,t=null,r)=>{const n=Xi.getSkylinkState(r),s={audio:!1,video:!1},{AdapterJS:i}=window,{currentCodecSupport:o,peerInformations:a}=n,{beSilentOnParseLogs:c}=Xi.getInitOptions();if(!e||!t||!t.sdp){if(s.video=!(!o.video.h264&&!o.video.vp8),s.audio=!!o.audio.opus,e){const t=((a[e]||{}).agent||{}).name||"";i.webrtcDetectedBrowser===t&&(s.video=Object.keys(o.video).length>0,s.audio=Object.keys(o.audio).length>0);}return s}const d=qs.getSDPCodecsSupport(e,t,c),l=o;for(const e in l.audio)if(l.audio.hasOwnProperty(e)&&l.audio[e]&&d.audio[e]){s.audio=!0;break}for(const e in l.video)if(l.video.hasOwnProperty(e)&&l.video[e]&&d.video[e]){s.video=!0;break}return s},getSDPCodecsSupport:(e,t,r)=>{const n={audio:{},video:{}};if(!t||!t.sdp)return n;const s=t.sdp.split("\r\n");let i="";for(let e=0;e<s.length;e+=1)if(0!==s[e].indexOf("m=")){if(0===s[e].indexOf("a=rtpmap:")){const t=(s[e].split(" ")[1]||"").split("/"),r=(t[0]||"").toLowerCase(),o=t[1]+(t[2]?`/${t[2]}`:"");if(["ulpfec","red","telephone-event","cn","rtx"].indexOf(r)>-1)continue;n[i][r]=n[i][r]||[],-1===n[i][r].indexOf(o)&&n[i][r].push(o);}}else i=(s[e].split("m=")[1]||"").split(" ")[0];return r||Ys.log.INFO([e||null,"RTCSessionDescription",t.type,"Parsed codecs support ->"],n),n},getCodecsSupport:e=>new Promise((t,r)=>{const n=Xi.getSkylinkState(e),{beSilentOnParseLogs:s}=Xi.getInitOptions(),i=n,{AdapterJS:o,RTCRtpSender:a,RTCPeerConnection:c}=window;n.currentCodecSupport&&t(n.currentCodecSupport),i.currentCodecSupport={audio:{},video:{}},"AppleWebKit"===o.webrtcDetectedType&&(i.currentCodecSupport.audio={opus:["48000/2"]},i.currentCodecSupport.video={h264:["48000"]},t(i.currentCodecSupport));try{if("edge"===window.webrtcDetectedBrowser){const{codecs:e}=a.getCapabilities();for(let t=0;t<e.length;t+=1)if(["audio","video"].indexOf(e[t].kind)>-1&&e[t].name){const r=e[t].name.toLowerCase();i.currentCodecSupport[e[t].kind][r]=e[t].clockRate+(e[t].numChannels>1?`/${e[t].numChannels}`:"");}t(i.currentCodecSupport);}else{const e=new c(null),a="plugin"!==o.webrtcDetectedType?{offerToReceiveAudio:!0,offerToReceiveVideo:!0}:{mandatory:{OfferToReceiveVideo:!0,OfferToReceiveAudio:!0}};try{const t=e.createDataChannel("test");i.binaryChunkType=t.binaryType||n.binaryChunkType,i.binaryChunkType=n.binaryChunkType.toLowerCase().indexOf("array")>-1?je.ARRAY_BUFFER:n.binaryChunkType;const r=Object.keys(je);for(let e=0;e<r.length;e+=1)if(je.hasOwnProperty(r)&&n.binaryChunkType.toLowerCase()===je[r].toLowerCase()){i.binaryChunkType=je[r];break}}catch(e){}e.createOffer(a).then(e=>{i.currentCodecSupport=Zs.getSDPCodecsSupport(null,e,s),t(i.currentCodecSupport);}).catch(e=>{r(e);});}}catch(e){r(e);}}),setSDPCodecParams:(e,t,r)=>{const n=Xi.getSkylinkState(r),s=Xi.getInitOptions();return Js(t,"audio",lt.OPUS,48e3,(()=>{const e={},t=Object.keys(n.streams.userMedia);let r=n.streams.userMedia?n.streams.userMedia[t[0]].settings.audio:{};return r=r&&"object"==typeof r?r:{},"boolean"==typeof s.codecParams.audio.opus.stereo?e.stereo=s.codecParams.audio.opus.stereo:"boolean"==typeof r.stereo&&(e.stereo=r.stereo),"boolean"==typeof s.codecParams.audio.opus["sprop-stereo"]?e["sprop-stereo"]=s.codecParams.audio.opus["sprop-stereo"]:"boolean"==typeof r.stereo&&(e["sprop-stereo"]=r.stereo),"boolean"==typeof s.codecParams.audio.opus.usedtx?e.usedtx=s.codecParams.audio.opus.usedtx:"boolean"==typeof r.usedtx&&(e.usedtx=r.usedtx),"boolean"==typeof s.codecParams.audio.opus.useinbandfec?e.useinbandfec=s.codecParams.audio.opus.useinbandfec:"boolean"==typeof r.useinbandfec&&(e.useinbandfec=r.useinbandfec),"number"==typeof s.codecParams.audio.opus.maxplaybackrate?e.maxplaybackrate=s.codecParams.audio.opus.maxplaybackrate:"number"==typeof r.maxplaybackrate&&(e.maxplaybackrate=r.maxplaybackrate),"number"==typeof s.codecParams.audio.opus.minptime?e.minptime=s.codecParams.audio.opus.minptime:"number"==typeof r.minptime&&(e.minptime=r.minptime),e})()),Js(t,"video",dt.VP8,null,(()=>{const e={};return "number"==typeof s.codecParams.video.vp8.maxFr&&(e["max-fr"]=s.codecParams.video.vp8.maxFr),"number"==typeof s.codecParams.video.vp8.maxFs&&(e["max-fs"]=s.codecParams.video.vp8.maxFs),e})()),Js(t,"video",dt.VP9,null,(()=>{const e={};return "number"==typeof s.codecParams.video.vp9.maxFr&&(e["max-fr"]=s.codecParams.video.vp9.maxFr),"number"==typeof s.codecParams.video.vp9.maxFs&&(e["max-fs"]=s.codecParams.video.vp9.maxFs),e})()),Js(t,"video",dt.H264,null,(()=>{const e={};return "string"==typeof s.codecParams.video.h264.levelAsymmetryAllowed&&(e["profile-level-id"]=s.codecParams.video.h264.profileLevelId),"boolean"==typeof s.codecParams.video.h264.levelAsymmetryAllowed&&(e["level-asymmetry-allowed"]=s.codecParams.video.h264.levelAsymmetryAllowed),"boolean"==typeof s.codecParams.video.h264.packetizationMode&&(e["packetization-mode"]=s.codecParams.video.h264.packetizationMode),e})()),t.sdp},removeSDPFilteredCandidates:(e,t,r)=>{const n=Xi.getInitOptions(),s=Xi.getSkylinkState(r);return e===Nt.MCU&&t.type===et.ANSWER&&"firefox"===window.webrtcDetectedBrowser&&(t.sdp=t.sdp.replace(/ generation 0/g,""),t.sdp=t.sdp.replace(/ udp /g," UDP ")),n.forceTURN&&s.hasMCU?(Ys.log.WARN([e,"RTCSessionDesription",t.type,"Not filtering ICE candidates as TURN connections are enforced as MCU is present (and act as a TURN itself) so filtering of ICE candidate flags are not honoured"]),t.sdp):(n.filterCandidatesType.host&&(Ys.log.INFO([e,"RTCSessionDesription",t.type,'Removing "host" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*host.*\r\n/g,"")),n.filterCandidatesType.srflx&&(Ys.log.INFO([e,"RTCSessionDesription",t.type,'Removing "srflx" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*srflx.*\r\n/g,"")),n.filterCandidatesType.relay&&(Ys.log.INFO([e,"RTCSessionDesription",t.type,'Removing "relay" ICE candidates.']),t.sdp=t.sdp.replace(/a=candidate:.*relay.*\r\n/g,"")),t.sdp)},setSDPCodec:(e,t,r,n)=>{const s=Xi.getInitOptions(r),i=(r,n)=>{const s="object"==typeof n?n.codec:n;let i="object"==typeof n?n.samplingRate:null,o="object"==typeof n?n.channels:null;if(s===kt["audio"===r?"AUDIO_CODEC":"VIDEO_CODEC"].AUTO)return void Ys.log.WARN([e,"RTCSessionDesription",t.type,`Not preferring any codec for ${r} streaming. Using browser selection.`]);const a=t.sdp.match(new RegExp("m="+r+" .*\r\n","gi"));if(!(Array.isArray(a)&&a.length>0))return void Ys.log.ERROR([e,"RTCSessionDesription",t.type,`Not preferring any codec for ${r} streaming as m= line is not found.`]);const c=(n,c,d)=>{if(Array.isArray(n)&&n.length>0){c||(i=null),d||(o=null),Ys.log.INFO([e,"RTCSessionDesription",t.type,'Preferring "'+s+'" (samplingRate: '+(i||"n/a")+", channels: "+(o||"n/a")+') for "'+r+'" streaming.']);let l=a[0];const p=l.replace("\r\n","").split(" ");l=p[0]+" "+p[1]+" "+p[2]+" ",p.splice(0,3);for(let e=0;e<n.length;e+=1){const t=(n[e].split("a=rtpmap:")[1]||"").split(" ");t.length<2||(l+=t[0]+" ");}for(let e=0;e<p.length;e+=1)l.indexOf(" "+p[e])>0?(p.splice(e,1),e-=1):t.sdp.match(new RegExp("a=rtpmap:"+p[e]+" "+s+"/.*\r\n","gi"))&&(l+=p[e]+" ",p.splice(e,1),e-=1);return l+=p.join(" ")+"\r\n",t.sdp=t.sdp.replace(a[0],l),!0}};if(i){if("audio"===r&&o&&c(t.sdp.match(new RegExp("a=rtpmap:.* "+s+"/"+i+(1===o?"[/1]*":"/"+o)+"\r\n","gi")),!0,!0))return;if(c(t.sdp.match(new RegExp("a=rtpmap:.* "+s+"/"+i+"[/]*.*\r\n","gi")),!0))return}"audio"===r&&o&&c(t.sdp.match(new RegExp("a=rtpmap:.* "+s+"/.*/"+o+"\r\n","gi")),!1,!0)||c(t.sdp.match(new RegExp("a=rtpmap:.* "+s+"/.*\r\n","gi")));};return i("audio",n?n.audio:s.audioCodec),i("video",n?n.video:s.videoCodec),t.sdp},setSDPBitrate:(e,t,r)=>{const n=Xi.getSkylinkState(r),s=t.sdp.split("\r\n"),i=function(r,n){let i=r,o=-1,a=-1;"data"===r&&(i="application");for(let e=0;e<s.length;e+=1)if(0===s[e].indexOf("m="+i))o=e;else if(o>0){if(0===s[e].indexOf("m="))break;0===s[e].indexOf("c=")?a=e:0!==s[e].indexOf("b=AS:")&&0!==s[e].indexOf("b:TIAS:")||(s.splice(e,1),e-=1);}"number"==typeof n&&n>0?-1!==a?(Ys.log.INFO([e,"RTCSessionDesription",t.type,`Limiting maximum sending ${r} bandwidth ->`],n),s.splice(a+1,0,"firefox"===window.webrtcDetectedBrowser?"b=TIAS:"+(1e3*n*(window.webrtcDetectedVersion>52&&window.webrtcDetectedVersion<55?1e3:1)).toFixed(0):"b=AS:"+n)):Ys.log.ERROR([e,"RTCSessionDesription",t.type,`Failed setting ${r} bandwidth as c-line is missing.`]):Ys.log.WARN([e,"RTCSessionDesription",t.type,`Not limiting ${r} bandwidth`]);};let o=n.streamsBandwidthSettings.bAS.audio,a=n.streamsBandwidthSettings.bAS.video,c=n.streamsBandwidthSettings.bAS.data,d=n.streamsBandwidthSettings.googleX.min,l=n.streamsBandwidthSettings.googleX.max;if(n.peerCustomConfigs[e]&&(n.peerCustomConfigs[e].bandwidth&&"object"==typeof n.peerCustomConfigs[e].bandwidth&&("number"==typeof n.peerCustomConfigs[e].bandwidth.audio&&(o=n.peerCustomConfigs[e].bandwidth.audio),"number"==typeof n.peerCustomConfigs[e].bandwidth.video&&(a=n.peerCustomConfigs[e].bandwidth.video),"number"==typeof n.peerCustomConfigs[e].bandwidth.data&&(c=n.peerCustomConfigs[e].bandwidth.data)),n.peerCustomConfigs[e].googleXBandwidth&&"object"==typeof n.peerCustomConfigs[e].googleXBandwidth&&("number"==typeof n.peerCustomConfigs[e].googleXBandwidth.min&&(d=n.peerCustomConfigs[e].googleXBandwidth.min),"number"==typeof n.peerCustomConfigs[e].googleXBandwidth.max&&(l=n.peerCustomConfigs[e].googleXBandwidth.max))),i("audio",o),i("video",a),i("data",c),"number"==typeof d||"number"==typeof l){let r=null,n=-1,i=-1;for(let e=0;e<s.length;e+=1)if(0===s[e].indexOf("m=video"))r=s[e].split(" ")[3];else if(r){if(0===s[e].indexOf("m="))break;if(0===s[e].indexOf("a=rtpmap:"+r+" "))n=e;else if(0===s[e].indexOf("a=fmtp:"+r+" ")){s[e]=s[e].replace(/x-google-(min|max)-bitrate=[0-9]*[;]*/gi,""),i=e;break}}if(n>-1){let o="";"number"==typeof d&&(o+="x-google-min-bitrate="+d+";"),"number"==typeof l&&(o+="x-google-max-bitrate="+l+";"),Ys.log.INFO([e,"RTCSessionDesription",t.type,"Limiting x-google-bitrate ->"],o),i>-1?s[i]+=(s[i].split(" ")[1]?";":"")+o:s.splice(n+1,0,"a=fmtp:"+r+" "+o);}}return s.join("\r\n")},removeSDPCodecs:(e,t,r)=>{const n=Xi.getSkylinkState(r),s=Qt.getCurrentSessionInfo(n.room).settings.audio,i=Xi.getInitOptions(),o=(r,n)=>{const s=t.sdp.match(new RegExp("a=rtpmap:(\\d*)\\ "+n+".*","gi"));if(Array.isArray(s)&&s.length>0)for(let i=0;i<s.length;i+=1){const o=s[i].split(" ")[0].split(":")[1];Ys.log.INFO([e,"RTCSessionDesription",t.type,'Removing "'+n+'" payload ->'],o),t.sdp=t.sdp.replace(new RegExp("a=rtpmap:"+o+"\\ .*\\r\\n","g"),""),t.sdp=t.sdp.replace(new RegExp("a=fmtp:"+o+"\\ .*\\r\\n","g"),""),t.sdp=t.sdp.replace(new RegExp("a=rtpmap:\\d+ rtx\\/\\d+\\r\\na=fmtp:\\d+ apt="+o+"\\r\\n","g"),"");const a=t.sdp.split("\r\n");for(let e=0;e<a.length;e+=1)if(0===a[e].indexOf("m="+r)){const t=a[e].split(" ");t.indexOf(o)>=3&&t.splice(t.indexOf(o),1),a[e]=t.join(" ");break}t.sdp=a.join("\r\n");}else Ys.log.WARN([e,"RTCSessionDesription",t.type,`Not removing ${n} as it does not exists.`]);};return i.disableVideoFecCodecs&&(n.hasMCU?Ys.log.WARN([e,"RTCSessionDesription",t.type,'Not removing "ulpfec" or "red" codecs as connected to MCU to prevent connectivity issues.']):(o("video","red"),o("video","ulpfec"))),i.disableComfortNoiseCodec&&s&&"object"==typeof s&&s.stereo&&o("audio","CN"),"edge"===window.webrtcDetectedBrowser&&"edge"!==(((n.peerInformations[e]||{}).agent||{}).name||"unknown").name&&(t.sdp=t.sdp.replace(/a=rtcp-fb:.*\ x-message\ .*\r\n/gi,"")),t.sdp},removeSDPREMBPackets:(e,t)=>{return Xi.getInitOptions().disableREMB?(Ys.log.INFO([e,"RTCSessionDesription",t.type,"Removing REMB packets."]),t.sdp.replace(/a=rtcp-fb:\d+ goog-remb\r\n/g,"")):t.sdp},handleSDPConnectionSettings:(e,t,r,n)=>{const s=Xi.getSkylinkState(r);if(!s.sdpSessions[e])return t.sdp;const i=t.sdp.split("\r\n"),o=((s.peerInformations[e]||{}).agent||{}).name||"",a=[],c=Ut(s.sdpSettings);let d="",l=-1,p=-1;if(e===Nt.MCU&&(c.connection.audio=!0,c.connection.video=!0,c.connection.data=!0),s.hasMCU){const t=Ut(Qt.getPeerInfo(e,s.room)).settings||{};c.direction.audio.receive=e===Nt.MCU||!!t.audio,c.direction.audio.send=e===Nt.MCU,c.direction.video.receive=e===Nt.MCU||!!t.video,c.direction.video.send=e===Nt.MCU;}if("remote"===n){const n=Zs.getSDPCommonSupports(e,t,r);n.audio||(c.connection.audio=!1),n.video||(c.connection.video=!1);}s.sdpSessions[e][n].mLines=[],s.sdpSessions[e][n].bundleLine="",s.sdpSessions[e][n].connection={audio:null,video:null,data:null};for(let r=0;r<i.length;r+=1){if(0===i[r].indexOf("a=group:BUNDLE"))s.sdpSessions[e][n].bundleLine=i[r],l=r;else if(0===i[r].indexOf("m=")&&(d="application"===(d=(i[r].split("m=")[1]||"").split(" ")[0]||"")?"data":d,p+=1,s.sdpSessions[e][n].mLines[p]=i[r],!c.connection[d])){if(Ys.log.INFO([e,"RTCSessionDesription",t.type,`Removing rejected m=${d} line ->`],i[r]),s.peerConnectionConfig.bundlePolicy===Qe.MAX_BUNDLE&&l>-1&&0===p&&("remote"===n?t.type===et.OFFER:t.type===et.ANSWER)){Ys.log.WARN([e,"RTCSessionDesription",t.type,`Not removing rejected m='${d} line ->`],i[r]),c.connection[d]=!0,["audio","video"].indexOf(d)>-1&&(c.direction[d].send=!1,c.direction[d].receive=!1);continue}if("edge"===window.webrtcDetectedBrowser){i.splice(r,1),r-=1;continue}if("remote"===n||t.type===et.ANSWER){const e=i[r].split(" ");e[1]=0,i[r]=e.join(" ");continue}}if(d)if(c.connection[d]){if(0===i[r].indexOf("a=mid:"))a.push(i[r].split("a=mid:")[1]||"");else if(d&&["a=sendrecv","a=sendonly","a=recvonly"].indexOf(i[r])>-1){if(-1===["audio","video"].indexOf(d)){s.sdpSessions[e][n].connection.data=i[r];continue}if("local"===n)c.direction[d].send&&!c.direction[d].receive?i[r]=i[r].indexOf("send")>-1?"a=sendonly":"a=inactive":!c.direction[d].send&&c.direction[d].receive?i[r]=i[r].indexOf("recv")>-1?"a=recvonly":"a=inactive":c.direction[d].send||c.direction[d].receive||(i[r]="a=inactive"),s.hasMCU||"firefox"===window.webrtcDetectedBrowser||"firefox"!==o||t.type!==et.OFFER||"a=recvonly"!==i[r]||(Ys.log.WARN([e,"RTCSessionDesription",t.type,"Overriding any original settings to receive only to send and receive to resolve chrome BUNDLE errors."]),i[r]="a=sendrecv",c.direction[d].send=!0,c.direction[d].receive=!0);else if(t.type===et.ANSWER){const t=s.sdpSessions[e].local.connection[d];"a=sendonly"===t?i[r]=-1===["a=inactive","a=recvonly"].indexOf(i[r])?"a=sendonly"===i[r]?"a=inactive":"a=recvonly":i[r]:"a=recvonly"===t?i[r]=-1===["a=inactive","a=sendonly"].indexOf(i[r])?"a=recvonly"===i[r]?"a=inactive":"a=sendonly":i[r]:"a=inactive"===t&&(i[r]="a=inactive");}s.sdpSessions[e][n].connection[d]=i[r];}}else i.splice(r,1),r-=1;(i[r]||"").replace(/\n|\r|\s|\ /gi,"")||(i.splice(r,1),r-=1);}return l>-1&&(s.peerConnectionConfig.bundlePolicy===Qe.MAX_BUNDLE?i[l]="a=group:BUNDLE "+a.join(" "):s.peerConnectionConfig.bundlePolicy===Qe.NONE&&i.splice(l,1)),"edge"!==window.webrtcDetectedBrowser&&(i[i.length-1].replace(/\n|\r|\s/gi,"")?i.push(""):i[i.length-1]=""),Ys.log.INFO([e,"RTCSessionDesription",t.type,"Handling connection lines and direction ->"],c),i.join("\r\n")},removeSDPUnknownAptRtx:(e,t)=>{const r=t.sdp.split("m=");for(let e=0;e<r.length;e+=1)r[e]=Xs(r[e]),r[e]=Qs(r[e]);return r.join("m=")},removeSDPFirefoxH264Pref:(e,t)=>(Ys.log.INFO([e,"RTCSessionDesription",t.type,"Removing Firefox experimental H264 flag to ensure interopability reliability"]),t.sdp.replace(/a=fmtp:0 profile-level-id=0x42e00c;packetization-mode=1\r\n/g,"")),renderSDPOutput:(e,t,r)=>{const n=Xi.getSkylinkState(r);let s=null,i=null;if(!t||!t.sdp)return;if(!n.peerConnections[e])return t.sdp;n.peerConnections[e].localStream&&(s=n.peerConnections[e].localStream,i=n.peerConnections[e].localStreamId||n.peerConnections[e].localStream.id);const o=t.sdp.split("\r\n");if(s){let e="";for(let t=0;t<o.length;t+=1)if(0===o[t].indexOf("m="))e=(o[t].split("m=")[1]||"").split(" ")[0]||"",e=-1===["audio","video"].indexOf(e)?"":e;else if(e)if(0===o[t].indexOf("a=msid:")){const e=o[t].split(" ");e[0]="a=msid:"+i,o[t]=e.join(" ");}else if(0===o[t].indexOf("a=ssrc:")){let e=null;if(o[t].indexOf(" msid:")>0?e=o[t].split(" msid:"):o[t].indexOf(" mslabel:")>0&&(e=o[t].split(" mslabel:")),e){const r=(e[1]||"").split(" ");r[0]=i,e[1]=r.join(" "),o[t].indexOf(" msid:")>0?o[t]=e.join(" msid:"):o[t].indexOf(" mslabel:")>0&&(o[t]=e.join(" mslabel:"));}}}if(t.type===et.ANSWER&&n.sdpSessions[e]){let r=-1;for(let s=0;s<o.length;s+=1)if(0===o[s].indexOf("a=group:BUNDLE")&&n.sdpSessions[e].remote.bundleLine&&n.peerConnectionConfig.bundlePolicy===Qe.MAX_BUNDLE)o[s]=n.sdpSessions[e].remote.bundleLine;else if(0===o[s].indexOf("m=")){r+=1;const i=o[s].split(" "),a=(n.sdpSessions[e].remote.mLines[r]||"").split(" ");i[0]&&a[0]&&i[0]!==a[0]&&(a[1]=0,Ys.log.INFO([e,"RTCSessionDesription",t.type,"Appending middle rejected m= line ->"],a.join(" ")),o.splice(s,0,a.join(" ")),s+=1,r+=1);}for(;n.sdpSessions[e].remote.mLines[r+1];){r+=1;let s=o.length;o[s-1].replace(/\s/gi,"")||(s-=1);const i=(n.sdpSessions[e].remote.mLines[r]||"").split(" ");i[1]=0,Ys.log.INFO([e,"RTCSessionDesription",t.type,"Appending later rejected m= line ->"],i.join(" ")),o.splice(s,0,i.join(" "));}}return "edge"!==window.webrtcDetectedBrowser||t.type!==et.OFFER||o[o.length-1].replace(/\s/gi,"")||(Ys.log.INFO([e,"RTCSessionDesription",t.type,"Removing last empty space for Edge browsers"]),o.splice(o.length-1,1)),Ys.log.INFO([e,"RTCSessionDescription",t.type,"Formatted output ->"],o.join("\r\n")),o.join("\r\n")},getSDPICECandidates:(e,t,r)=>{const{RTCIceCandidate:n}=window,s={host:[],srflx:[],relay:[]};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t)return;const r=((e.match(/a=mid:.*\r\n/gi)||[])[0]||"").replace(/a=mid:/gi,"").replace(/\r\n/,""),i=t-1;(e.match(/a=candidate:.*\r\n/gi)||[]).forEach(e=>{const t=(e.split(" ")[7]||"host").replace(/\r\n/g,"");s[t]=s[t]||[],s[t].push(new n({sdpMid:r,sdpMLineIndex:i,candidate:(e.split("a=")[1]||"").replace(/\r\n/g,"")}));});}),r||Ys.log.INFO([e,"RTCSessionDesription",t.type,"Parsing session description ICE candidates ->"],s),s):s},getSDPSelectedCodec:(e,t,r,n)=>{const s={name:null,implementation:null,clockRate:null,channels:null,payloadType:null,params:null};return t&&t.sdp?(t.sdp.split("m=").forEach((e,t)=>{if(0===t||0!==e.indexOf(`${r} `))return;const n=(e.split("\r\n")[0]||"").split(" ");n.splice(0,3);for(let t=0;t<n.length;t+=1){const r=e.match(new RegExp(`a=rtpmap:${n[t]}.*\r\n`,"gi"));if(!r)continue;const i=((r[0]||"").replace(/\r\n/g,"").split(" ")[1]||"").split("/");if(!(["red","ulpfec","telephone-event","cn","rtx"].indexOf(i[0].toLowerCase())>-1)){s.name=i[0],s.clockRate=parseInt(i[1],10)||0,s.channels=parseInt(i[2]||"1",10)||1,s.payloadType=parseInt(n[t],10),s.params="",(e.match(new RegExp(`a=fmtp:${n[t]}.*\r\n`,"gi"))||[]).forEach(e=>{s.params+=e.replace(new RegExp(`a=fmtp:${n[t]}`,"gi"),"").replace(/ /g,"").replace(/\r\n/g,"");});break}}}),n||Ys.log.INFO([e,"RTCSessionDesription",t.type,`Parsing session description "${r}" codecs ->`],s),s):s},setOriginalDTLSRole:(e,t,r)=>{const{room:n}=e,{type:s}=t,i=t.sdp.match(/a=setup:([a-z]+)/);if(null!==e.originalDTLSRole||"offer"===s)return;if(!i)return;const o=i[1];e.originalDTLSRole=r?{active:"passive",passive:"active"}[o]:o,Xi.setSkylinkState(e,n.id);},modifyDTLSRole:(e,t)=>{const{originalDTLSRole:r}=e,{type:n}=t;return null===r||"offer"===n?t.sdp:(t.sdp=t.sdp.replace(/a=setup:[a-z]+/g,`a=setup:${r}`),t.sdp)},getTransceiverMid:(e,t)=>{const r={audio:[],video:[]};return e.sdp.split("m=").forEach((e,t)=>{const n=e.split(/\n/),s=n[0].split(" ")[0];if("application"===s||0===t)return;let i={};for(let e=0;e<n.length;e+=1){if(n[e].match(/a=recvonly|a=sendonly|a=sendrecv|a=inactive/)){const t=n[e].split("=");i.direction=t[1].trim();}if(n[e].match(/a=mid:*/)&&(i.transceiverMid=n[e].split(/:/)[1].trim()),n[e].match(/a=msid:([\w|-|{]+)/)){const t=n[e].split(" "),r=t[0].split(/:/)[1].trim();i.streamId="-"===r?"":r,i.trackId=t[1].trim();}i.transceiverMid&&i.streamId&&i.trackId&&(r[s].push(i),i={});}}),t||Ys.log.INFO([null,"RTCSessionDesription",e.type,`Parsing session description "${e.type}" transceivers ->`],r),r}};class Zs{static getSDPCommonSupports(...e){return qs.getSDPCommonSupports(...e)}static getCodecsSupport(...e){return qs.getCodecsSupport(...e)}static setSDPCodecParams(...e){return qs.setSDPCodecParams(...e)}static removeSDPFilteredCandidates(...e){return qs.removeSDPFilteredCandidates(...e)}static setSDPCodec(...e){return qs.setSDPCodec(...e)}static setSDPBitrate(...e){return qs.setSDPBitrate(...e)}static removeSDPCodecs(...e){return qs.removeSDPCodecs(...e)}static removeSDPREMBPackets(...e){return qs.removeSDPREMBPackets(...e)}static handleSDPConnectionSettings(...e){return qs.handleSDPConnectionSettings(...e)}static removeSDPUnknownAptRtx(...e){return qs.removeSDPUnknownAptRtx(...e)}static getSDPCodecsSupport(...e){return qs.getSDPCodecsSupport(...e)}static removeSDPFirefoxH264Pref(...e){return qs.removeSDPFirefoxH264Pref(...e)}static renderSDPOutput(...e){return qs.renderSDPOutput(...e)}static getSDPICECandidates(...e){return qs.getSDPICECandidates(...e)}static getSDPSelectedCodec(...e){return qs.getSDPSelectedCodec(...e)}static setOriginalDTLSRole(...e){return qs.setOriginalDTLSRole(...e)}static modifyDTLSRole(...e){return qs.modifyDTLSRole(...e)}static getTransceiverMid(...e){return qs.getTransceiverMid(...e)}}const ei=e=>"relay"===e?"relayed":"host"===e||e.indexOf("host")>-1?"local":"srflx"===e?"serverreflexive":"prflx"===e?"peerreflexive":e,ti={parseSelectedCandidatePair:(e,t,r,n,s,i,o)=>{const{peerBandwidth:a,peerStats:c}=e,{raw:d,selectedCandidatePair:l}=t,{AdapterJS:p}=window,u=Object.keys(t.raw);let S=null,E=null,h=null;if(p.webrtcDetectedBrowser===yt.CHROME)for(let e=0;e<u.length;e+=1)"transport"===d[u[e]].type&&(S=d[u[e]]);else p.webrtcDetectedBrowser===yt.FIREFOX&&(S={});if(S)for(let e=0;e<u.length;e+=1){const t=d[u[e]];if("candidate-pair"===t.type&&t.id===S.selectedCandidatePairId||"candidate-pair"===t.type&&t.selected){const e=t;E=e.localCandidateId,h=e.remoteCandidateId,l.id=e.id,l.writable=e.writable,l.priority=e.priority,l.nominated=e.nominated;const r=o?a[i][t.id]:c[i][t.id],n=parseInt(t.totalRoundTripTime||"0",10);l.totalRoundTripTime=n,l.roundTripTime=ti.tabulateStats(r,t,"totalRoundTripTime");const s=parseInt(t.consentRequestsSent||"0",10);l.consentRequests.totalSent=s,l.consentRequests.sent=ti.tabulateStats(r,t,"consentRequestsSent");const d=parseInt(t.requestsReceived||"0",10);l.requests.totalReceived=d,l.requests.received=ti.tabulateStats(r,t,"requestsReceived");const p=parseInt(t.requestsSent||"0",10);l.requests.totalSent=p,l.requests.sent=ti.tabulateStats(r,t,"requestsSent");const u=parseInt(t.responsesSent||"0",10);l.responses.totalSent=u,l.responses.sent=ti.tabulateStats(r,t,"responsesSent");const S=parseInt(t.responsesReceived||"0",10);l.responses.totalReceived=S,l.responses.received=ti.tabulateStats(r,t,"responsesReceived");}}if(E&&h){if("remote-candidate"===r){const e=n;e.id===h&&(l.remote.ipAddress=e.ip?e.ip:e.address,l.remote.portNumber=e.port,l.remote.transport=e.protocol,l.remote.priority=e.priority,l.remote.candidateType=ei(e.candidateType));}if("local-candidate"===r){const e=n;e.id===E&&(l.local.ipAddress=e.ip?e.ip:e.address,l.local.portNumber=e.port,l.local.transport=e.protocol,l.local.priority=e.priority,l.local.networkType=e.networkType,l.local.candidateType=ei(e.candidateType));}}},parseCertificates:(e,t)=>{const{certificate:r,raw:n}=e,s=Object.keys(e.raw);let i=null;for(let e=0;e<s.length;e+=1)"transport"===n[s[e]].type&&(i=n[s[e]]);if(i){r.srtpCipher=i.srtpCipher,r.dtlsCipher=i.dtlsCipher,r.tlsVersion=i.tlsVersion;const{localCertificateId:e,remoteCertificateId:n}=i;t.id===e?(r.local={},r.local.base64Certificate=t.base64Certificate,r.local.fingerprintAlgorithm=t.fingerprintAlgorithm):t.id===n&&(r.remote={},r.remote.base64Certificate=t.base64Certificate,r.remote.fingerprintAlgorithm=t.fingerprintAlgorithm);}},tabulateStats:(e=null,t,r)=>{const n=t.timestamp,s=e&&e.timestamp||0,i=parseFloat(t[r]||"0",10),o=parseFloat(e&&e[r]||"0",10);return new Date(n).getTime()===new Date(s).getTime()?i:parseFloat(((i-o)/(n-s)*1e3).toFixed(3)||"0",10)},parseAudio:(e,t,r,n,s,i,o)=>{const{peerBandwidth:a,peerStats:c}=e,d=i?a[s][n.id]:c[s][n.id];switch(o){case"receiving":((e,t,r)=>{const n=e.audio.receiving,s=parseInt(t.packetsReceived||"0",10);n.totalPackets=s,n.packets=ti.tabulateStats(r,t,"packetsReceived");const i=parseInt(t.bytesReceived||"0",10);n.totalBytes=i,n.bytes=ti.tabulateStats(r,t,"bytesReceived");const o=parseInt(t.packetsLost||"0",10);n.totalPacketsLost=o,n.packetsLost=ti.tabulateStats(r,t,"packetsLost"),n.jitter=parseInt(t.jitter||"0",10),n.ssrc=t.ssrc;const{trackId:a}=t,c=e.raw[a];c&&(n.audioLevel=parseFloat(c.audioLevel).toFixed(5),n.totalSamplesReceived=parseInt(c.totalSamplesReceived||"0",10),n.totalSamplesDuration=parseInt(c.totalSamplesDuration||"0",10));})(t,n,d);break;case"sending":((e,t,r)=>{const n=e.audio.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);n.totalBytes=e,n.bytes=ti.tabulateStats(r,t,"bytesSent");}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);n.totalPackets=e,n.packets=ti.tabulateStats(r,t,"packetsSent");}if(t.retransmittedBytesSent||ms(t.retransmittedBytesSent)){const e=parseInt(t.retransmittedBytesSent||"0",10);n.totalRetransmittedBytesSent=e,n.retransmittedBytesSent=ti.tabulateStats(r,t,"retransmittedBytesSent");}if(t.retransmittedPacketsSent||ms(t.retransmittedPacketsSent)){const e=parseInt(t.retransmittedPacketsSent||"0",10);n.totalRetransmittedPacketsSent=e,n.retransmittedPacketsSent=ti.tabulateStats(r,t,"retransmittedPacketsSent");}n.ssrc=t.ssrc,t.jitter&&(n.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(n.roundTripTime=parseInt(t.roundTripTime||"0",10));const{trackId:s,mediaSourceId:i}=t,o=e.raw[s];o&&(n.echoReturnLoss=parseInt(o.echoReturnLoss||"0",10),n.echoReturnLossEnhancement=parseInt(o.echoReturnLossEnhancement||"0",10));const a=e.raw[i];a&&(n.audioLevel=parseFloat(a.audioLevel).toFixed(5),n.totalSamplesDuration=parseInt(a.totalSamplesDuration||"0",10));})(t,n,d);break;default:Ys.log.DEBUG([s,Ct.STATS_MODULE,null,Lt.STATS_MODULE.ERRORS.PARSE_FAILED]);}},parseVideo:(e,t,r,n,s,i,o)=>{const{peerBandwidth:a,peerStats:c}=e,d=i?a[s][n.id]:c[s][n.id];switch(o){case"receiving":((e,t,r)=>{const n=e.video.receiving;if(t.bytesReceived){const e=parseInt(t.bytesReceived||"0",10);n.totalBytes=e,n.bytes=ti.tabulateStats(r,t,"bytesReceived");}if(t.packetsReceived){const e=parseInt(t.packetsReceived||"0",10);n.totalPackets=e,n.packets=ti.tabulateStats(r,t,"packetsReceived");}if(Number.isInteger(t.packetsLost)){const e=parseInt(t.packetsLost||"0",10);n.totalPacketsLost=e,n.packetsLost=ti.tabulateStats(r,t,"packetsLost");}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);n.totalFirs=e,n.firs=ti.tabulateStats(r,t,"firCount");}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);n.totalNacks=e,n.nacks=ti.tabulateStats(r,t,"nackCount");}if(t.pliCount||Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);n.totalPlis=e,n.plis=ti.tabulateStats(r,t,"pliCount");}n.ssrc=t.ssrc,n.qpSum=parseInt(t.qpSum||"0",10),n.decoderImplementation=t.decoderImplementation;const{trackId:s}=t,i=e.raw[s];i&&(n.framesDropped=parseFloat(i.framesDropped||"0"),n.frames=parseInt(i.framesReceived||"0",10),n.framesDecoded=parseInt(i.framesDecoded||"0",10),n.frameWidth=parseInt(i.frameWidth||"0",10),n.frameHeight=parseInt(i.frameHeight||"0",10));})(t,n,d);break;case"sending":((e,t,r)=>{const n=e.video.sending;if(t.bytesSent){const e=parseInt(t.bytesSent||"0",10);n.totalBytes=e,n.bytes=ti.tabulateStats(r,t,"bytesSent");}if(t.packetsSent){const e=parseInt(t.packetsSent||"0",10);n.totalPackets=e,n.packets=ti.tabulateStats(r,t,"packetsSent");}if(Number.isInteger(t.firCount)){const e=parseInt(t.firCount||"0",10);n.totalFirs=e,n.firs=ti.tabulateStats(r,t,"firCount");}if(Number.isInteger(t.nackCount)){const e=parseInt(t.nackCount||"0",10);n.totalNacks=e,n.nacks=ti.tabulateStats(r,t,"nackCount");}if(Number.isInteger(t.pliCount)){const e=parseInt(t.pliCount||"0",10);n.totalPlis=e,n.plis=ti.tabulateStats(r,t,"pliCount");}t.jitter&&(n.jitter=parseInt(t.jitter||"0",10)),t.roundTripTime&&(n.roundTripTime=parseInt(t.roundTripTime||"0",10)),Number.isInteger(t.framesEncoded)&&(n.framesEncoded=parseInt(t.framesEncoded||"0",10)),n.ssrc=t.ssrc,n.qpSum=parseInt(t.qpSum||"0",10);const{trackId:s,mediaSourceId:i}=t,o=e.raw[s];o&&(n.frameWidth=parseInt(o.frameWidth||"0",10),n.frameHeight=parseInt(o.frameHeight||"0",10),n.frames=parseInt(o.framesSent||"0",10),n.hugeFramesSent=parseInt(o.hugeFramesSent||"0",10));const a=e.raw[i];a&&(n.framesPerSecond=parseInt(a.framesPerSecond||"0",10));})(t,n,d);break;default:Ys.log.DEBUG([s,Ct.STATS_MODULE,null,Lt.STATS_MODULE.ERRORS.PARSE_FAILED]);}},parseMedia:(e,t,r,n,s,i,o,a)=>{const c=n.kind||n.mediaType;c===Ot.AUDIO?ti.parseAudio(e,t,r,n,i,o,a):c===Ot.VIDEO?ti.parseVideo(e,t,r,n,i,o,a):Ys.log.DEBUG([(void 0).peerId,Ct.STATS_MODULE,null,Lt.STATS_MODULE.INVALID_TRACK_KIND],n);}};class ri{constructor(e,t){this.roomState=Xi.getSkylinkState(e),this.peerConnection=this.roomState.peerConnections[t]||null,this.peerConnStatus=this.roomState.peerConnStatus[t]||null,this.dataChannel=this.roomState.dataChannels[t]||null,this.peerId=t,this.roomKey=e,this.output={peerId:t,raw:{},connection:{},audio:{sending:{},receiving:{}},video:{sending:{},receiving:{}},selectedCandidatePair:{id:null,local:{},remote:{},consentRequests:{},responses:{},requests:{}},certificate:{}},this.beSilentOnLogs=Xi.getInitOptions().beSilentOnStatsLogs,this.beSilentOnParseLogs=Xi.getInitOptions().beSilentOnParseLogs,this.isAutoBwStats=!1,this.bandwidth=null;}getConnectionStatus(){return this.getStatistics(!1,!1)}getStatsSuccess(e,t,r){const{AdapterJS:n}=window;if(!r&&n.webrtcDetectedBrowser===yt.REACT_NATIVE)return void e(this.output);const{peerBandwidth:s,peerStats:i,room:o}=this.roomState;"function"==typeof r.forEach?r.forEach((e,t)=>{this.output.raw[t]=e;}):this.output.raw=r;try{if(us(i))return void Ys.log.DEBUG([this.peerId,Ct.STATS_MODULE,null,Lt.STATS_MODULE.STATS_DISCARDED]);Object.entries(this.output.raw).forEach(e=>{const t=e[0],r=e[1],{type:n}=r;switch(n){case"remote-inbound-rtp":case"outbound-rtp":case"inbound-rtp":"inbound-rtp"===n?ti.parseMedia(this.roomState,this.output,n,r,this.peerConnection,this.peerId,this.isAutoBwStats,"receiving"):ti.parseMedia(this.roomState,this.output,n,r,this.peerConnection,this.peerId,this.isAutoBwStats,"sending");break;case"certificate":ti.parseCertificates(this.output,r);break;case"local-candidate":case"remote-candidate":case"media-source":ti.parseSelectedCandidatePair(this.roomState,this.output,n,r,this.peerConnection,this.peerId,this.isAutoBwStats);}this.isAutoBwStats&&!s[this.peerId][t]?s[this.peerId][t]=this.output.raw[t]:this.isAutoBwStats||i[this.peerId][t]||(i[this.peerId][t]=this.output.raw[t]),Xi.setSkylinkState(this.roomState,o.id);});}catch(e){this.getStatsFailure(t,Lt.STATS_MODULE.ERRORS.PARSE_FAILED,e);}Vs(we({state:Je.RETRIEVE_SUCCESS,peerId:this.peerId,stats:this.output})),e(this.output);}getStatsFailure(e,t,r){const n=t||Lt.STATS_MODULE.RETRIEVE_STATS_FAILED;this.beSilentOnLogs||(Ys.log.ERROR([this.peerId,Ct.STATS_MODULE,null,n],r),Vs(we({state:Je.RETRIEVE_ERROR,peerId:this.peerId,error:r}))),e(r);}getStatistics(e=!1,t=!1){const{STATS_MODULE:r}=Lt;return new Promise((n,s)=>{if(this.roomState.peerStats[this.peerId]||t){this.beSilentOnLogs=e,this.isAutoBwStats=t;try{this.gatherRTCPeerConnectionDetails(),this.gatherSDPIceCandidates(),this.gatherSDPCodecs(),this.gatherRTCDataChannelDetails();}catch(e){Ys.log.WARN([this.peerId,Ct.STATS_MODULE,null,Lt.STATS_MODULE.ERRORS.PARSE_FAILED],e);}"function"!=typeof this.peerConnection.getStats&&this.getStatsFailure(s,Lt.PEER_CONNECTION.getstats_api_not_available),Vs(we({state:Je.RETRIEVING,peerId:this.peerId})),this.peerConnection.getStats().then(e=>{this.getStatsSuccess(n,s,e);}).catch(e=>{e.message!==Lt.STATS_MODULE.ERRORS.STATS_IS_NULL?this.getStatsFailure(s,null,e):Ys.log.WARN([this.peerId,Ct.STATS_MODULE,null,Lt.STATS_MODULE.ERRORS.RETRIEVE_STATS_FAILED],e.message);});}else Ys.log.WARN(r.NOT_INITIATED),n(null);})}gatherRTCPeerConnectionDetails(){const{peerConnection:e}=this;this.output.connection.iceConnectionState=e.iceConnectionState,this.output.connection.iceGatheringState=e.iceGatheringState,this.output.connection.signalingState=e.signalingState,this.output.connection.remoteDescription={type:e.remoteDescription&&e.remoteDescription.type||"",sdp:e.remoteDescription&&e.remoteDescription.sdp||""},this.output.connection.localDescription={type:e.localDescription&&e.localDescription.type||"",sdp:e.localDescription&&e.localDescription.sdp||""},this.output.connection.constraints=this.peerConnStatus?this.peerConnStatus.constraints:null,this.output.connection.optional=this.peerConnStatus?this.peerConnStatus.optional:null,this.output.connection.sdpConstraints=this.peerConnStatus?this.peerConnStatus.sdpConstraints:null;}gatherSDPIceCandidates(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.connection.candidates={sending:Zs.getSDPICECandidates(this.peerId,e.localDescription,t),receiving:Zs.getSDPICECandidates(this.peerId,e.remoteDescription,t)};}gatherSDPCodecs(){const{peerConnection:e,beSilentOnParseLogs:t}=this;this.output.audio.sending.codec=Zs.getSDPSelectedCodec(this.peerId,e.remoteDescription,"audio",t),this.output.video.sending.codec=Zs.getSDPSelectedCodec(this.peerId,e.remoteDescription,"video",t),this.output.audio.receiving.codec=Zs.getSDPSelectedCodec(this.peerId,e.localDescription,"audio",t),this.output.video.receiving.codec=Zs.getSDPSelectedCodec(this.peerId,e.localDescription,"video",t);}gatherRTCDataChannelDetails(){const{dataChannel:e}=this;if(e){const t=Object.keys(e);this.output.connection.dataChannels={},t.forEach(t=>{const r=e[t];this.output.connection.dataChannels[r.channel.label]={label:r.channel.label,readyState:r.channel.readyState,channelType:Fe["main"===t?"MESSAGING":"DATA"],currentTransferId:r.transferId||null,currentStreamId:r.streamId||null};});}}}const ni=e=>{const{peerMedias:t,user:r}=e,n={},s=Object.keys(t).filter(e=>e!==r.sid);for(let e=0;e<s.length;e+=1){const r=s[e];Object.values(t[r]).forEach(e=>{e.mediaType===_t.VIDEO_SCREEN&&(n[r]=e.streamId);});}return n},si=(e,t,r,n=!1)=>{$t.prepStopStreams(e.id,t.id,n,!0).then(()=>Ys.log.DEBUG([r,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.STOP_SCREEN_SUCCESS}`])).catch(e=>Ys.log.DEBUG([r,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.ERRORS.STOP_SCREEN}`],e));},ii={handleScreenStreamStates:{addScreenStreamToState:(e,t)=>{const{room:r,user:n}=e,s=ps.parseStreamSettings({video:!0});ps.processStreamInState(t,s,r.id,!0,!1),Vs(Se({stream:t,peerId:n.sid,room:r,isSelf:!0,peerInfo:Qt.getCurrentSessionInfo(r),streamId:t.id,isVideo:t.getVideoTracks().length>0,isAudio:t.getAudioTracks().length>0}));},removeScreenStreamFromState:e=>{const{room:t,streams:r}=e;r.screenshare=null,Xi.setSkylinkState(e,t.id);},setScreenStateToUnavailable:(e,t)=>{const{user:r,room:n}=e,s=Jn.retrieveMediaId(Ot.VIDEO,t.id);Jn.setMediaStateToUnavailable(n,r.sid,s);}},addScreenStreamCallbacks:(e,t)=>{t.getTracks().forEach(r=>{r.onended=()=>si(e.room,t,e.user.sid);});},retrievePeersScreenStreamId:ni,retrievePeerScreenStream:e=>{const{remoteStreams:t}=e,r=ni(e);if(us(r))return null;const n={};return Object.keys(r).forEach(e=>{const s=Object.values(t[e]);n[e]=s.filter(t=>t.id===r[e].id);}),n},stopScreenStream:si};class oi{static addPeer(e){Rn.addPeer(e);}static createOffer(...e){return Rn.createOffer(...e)}static createAnswer(...e){return Rn.createAnswer(...e)}static createDataChannel(...e){return Rn.createDataChannel(...e)}static sendP2PMessage(...e){return Rn.sendP2PMessage(...e)}static getPeersInRoom(...e){return Rn.getPeersInRoom(...e)}static retrieveStatistics(e,t,r,n){return new ri(e,t).getStatistics(r,n)}static signalingEndOfCandidates(...e){return Rn.signalingEndOfCandidates(...e)}static getConnectionStatus(e,t){return Rn.getConnectionStatus(e,t)}static getDataChannelBuffer(e){return Rn.getDataChannelBuffer(e)}static refreshDataChannel(e,t){return Rn.refreshDataChannel(e,t)}static closeDataChannel(e,t){return Rn.closeDataChannel(e,t)}static refreshConnection(e,t,r,n,s){return Rn.refreshConnection(e,t,r,n,s)}static refreshPeerConnection(e,t,r,n){return Rn.refreshPeerConnection(e,t,r,n)}static getPeerScreenshare(e){return ii.retrievePeerScreenStream(e)}static buildPeerInformations(...e){return Rn.buildPeerInformations(...e)}static closePeerConnection(e,t){return Rn.closePeerConnection(e,t)}static updatePeerInformationsMediaStatus(e,t,r,n){return Rn.updatePeerInformationsMediaStatus(e,t,r,n)}}const ai={};class ci{constructor(e){const{room:t}=e;if(ai[t.id])return ai[t.id];this.roomState=e,this.stream=null,this.signaling=new zn,this.isReplace=null,this.streamId=null,ai[t.id]=this;}streamExists(){const e=ps.getStreams(this.roomState,this.roomState.room.name),t=Object.keys(e.userMedia);for(let e=0;e<t.length;e+=1)if(t[e]===this.streamId)return !0;return !1}hasMoreThanOneVideoStream(){return ps.retrieveVideoStreams(this.roomState.room).length>1}hasUserMediaStream(){const{streams:e}=this.roomState;return e.userMedia}async start(e,t=null){this.isReplace=!1,this.streamId=t;try{if(this.checkForExistingScreenStreams(),this.checksForReplaceScreen(),this.stream=await this.startScreenCapture(),!this.stream)return this.deleteScreensharingInstance(this.roomState.room),null;ii.handleScreenStreamStates.addScreenStreamToState(this.roomState,this.stream,this.isReplace),ii.addScreenStreamCallbacks(this.roomState,this.stream),this.isReplace?this.replaceUserMediaStream():this.addScreenshareStream();}catch(e){Ys.log.ERROR([this.roomState.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.REPLACE_SCREEN],e);}return this.stream}stop(e=!1){if(!this.stream)return Ys.log.DEBUG([this.roomState.user.sid,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.ERRORS.STOP_SCREEN} - ${Lt.MEDIA_STREAM.ERRORS.NO_STREAM}`]),null;try{ii.stopScreenStream(this.roomState.room,this.stream,this.roomState.user.sid,e),this.isReplace=null,this.streamId=null,this.stream=null;}catch(e){Ys.log.ERROR([this.roomState.user.sid,Ct.MEDIA_STREAM,null,`${Lt.MEDIA_STREAM.ERRORS.STOP_SCREEN}`],e);}return null}startScreenCapture(){const{navigator:e}=window;return e.mediaDevices.getDisplayMedia?e.mediaDevices.getDisplayMedia({video:!0}).then(e=>e).catch(e=>("NotAllowedError"===e.name?Ys.log.WARN(e):Ys.log.ERROR(e),null)):e.mediaDevices.getUserMedia({video:{mediaSource:"screen"}}).then(e=>e).catch(e=>(Ys.log.ERROR(e),null))}checksForReplaceScreen(){if(this.isReplace){if(!this.hasUserMediaStream())throw new Error(Lt.MEDIA_STREAM.ERRORS.NO_USER_MEDIA_STREAMS);if(this.hasMoreThanOneVideoStream()&&!this.streamId)throw new Error(Lt.MEDIA_STREAM.ERRORS.NO_STREAM_ID);if(this.streamId&&!Ts(this.streamId))throw new Error(Lt.MEDIA_STREAM.ERRORS.INVALID_STREAM_ID_TYPE);if(this.streamId&&!this.streamExists())throw new Error(`${Lt.MEDIA_STREAM.ERRORS.INVALID_STREAM_ID} - ${this.streamId}`)}}checkForExistingScreenStreams(){const e=ii.retrievePeersScreenStreamId(this.roomState);us(e)||Ys.log.WARN([this.roomState.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.PEER_SCREEN_ACTIVE]);}replaceUserMediaStream(){const{peerConnections:e,streams:t}=this.roomState,r=Object.keys(e),n=this.streamId?t.userMedia[this.streamId].stream:ps.retrieveVideoStreams(this.roomState.room)[0],s=this.stream;this.streamId=n.id,Ps(n,s,this.roomState,!0),r.forEach(e=>{ps.replaceTrack(n,s,e,this.roomState);});}addScreenshareStream(){const{peerConnections:e}=this.roomState;us(e)||oi.refreshConnection(this.roomState).catch(e=>Ys.log.ERROR([this.roomState.user.sid,Ct.MEDIA_STREAM,null,Lt.MEDIA_STREAM.ERRORS.START_SCREEN],e));}deleteScreensharingInstance(e){delete ai[e.id];}isReplaceScreenStream(){return this.isReplace}}let di=null;class li{constructor(){return di||(di=this),this.states={},di}setState(e){this.states[e.room.id]=e;}getAllStates(){return this.states}getState(e){return this.states[e]}removeStateByRoomId(e){return delete this.states[e]}clearRoomStateFromSingletons(e){const t=this.getState(e);new ci(t).deleteScreensharingInstance(t.room),Cr.deleteAsyncInstance(t.room),fr.deleteEncryptedInstance(t.room);}}class pi{static shouldProceed(e,t,r){let n=null;return e.isPrivileged||(n=Lt.PEER_PRIVILEGED.not_privileged),t||(n=Lt.PEER_PRIVILEGED.no_appkey),n&&(Ys.log.DEBUG(n),r(new Error(n))),!n}static getPeerList(e,t){return new Promise((r,n)=>{try{const s=Xi.getSkylinkState(e.id),i=Xi.getInitOptions(),o=t||!1,a=e=>{const t=e.detail;t.state===tt.DISPATCHED&&(Fs(bt.GET_PEERS_STATE_CHANGE,a),Vs(Pe({state:tt.RECEIVED,privilegePeerId:s.user.sid,peerList:t.peerList})),r(t.peerList));};this.shouldProceed(s,i.appKey,n)&&((new zn).getPeerList(o),Vs(Pe({state:tt.ENQUIRED,privilegePeerId:s.user.sid,peerList:null})),Ys.log.INFO(Lt.PEER_PRIVILEGED.getPeerListFromServer),Bs(bt.GET_PEERS_STATE_CHANGE,a));}catch(e){Ys.log.ERROR(e),n(e);}})}}const ui={defaultRoom:(new Date).valueOf(),appKey:null,roomServer:"//api.temasys.io",enableDataChannel:!0,enableSTUNServer:!0,enableTURNServer:!0,socketServerPath:null,enableStatsGathering:!0,audioFallback:!0,socketTimeout:7e3,apiTimeout:4e3,forceTURNSSL:!1,forceTURN:!1,forceSSL:!0,usePublicSTUN:!1,disableVideoFecCodecs:!1,disableComfortNoiseCodec:!1,disableREMB:!1,throttleShouldThrowError:!1,mcuUseRenegoRestart:!0,useEdgeWebRTC:!1,enableSimultaneousTransfers:!0,TURNServerTransport:ze.ANY,credentials:null,filterCandidatesType:{host:!1,srflx:!1,relay:!1},throttleIntervals:{shareScreen:1e4,refreshConnection:5e3,getUserMedia:0},iceServer:null,socketServer:null,audioCodec:lt.AUTO,videoCodec:dt.AUTO,codecParams:{audio:{opus:{stereo:null,"sprop-stereo":null,usedtx:null,useinbandfec:null,maxplaybackrate:null,minptime:null}},video:{h264:{profileLevelId:null,levelAsymmetryAllowed:null,packetizationMode:null},vp8:{maxFs:null,maxFr:null},vp9:{maxFs:null,maxFr:null}}},beSilentOnStatsLogs:!1,beSilentOnParseLogs:!1};class Si{constructor(e){this.id=e.room_key,this.token=e.roomCred,this.startDateTime=e.start,this.duration=e.len,this.roomName=e.roomName,this.connection={peerConstraints:JSON.parse(e.pc_constraints),offerConstraints:JSON.parse(e.offer_constraints),sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConfig:{iceServers:[]},mediaConstraints:JSON.parse(e.media_constraints)};}getRoomKey(){return this.id}getRoomName(){return this.roomName}}class Ei{constructor(e){this.uid=e.username,this.token=e.userCred,this.timeStamp=e.timeStamp,this.info={},this.sid=null,this.bufferMessage=null;}}class hi{constructor(e){const{offer_constraints:t,pc_constraints:r,cid:n,apiOwner:s,ipSigserver:i,isPrivileged:o,autoIntroduce:a,httpPortList:c,httpsPortList:d,hasMCU:l,ipSigserverPath:p,hasPersistentMessage:u}=e;t||r||Ys.log.ERROR(["API",null,"init","pc_constraints or offer_constraints are null"]),Ys.log.DEBUG(["API",null,"init","Parsed Peer Connection constraints:"],JSON.parse(r)),Ys.log.DEBUG(["API",null,"init","Parsed Offer constraints"],JSON.parse(t)),this.key=n,this.appKeyOwner=s,this.isPrivileged=o,this.autoIntroduce=a,this.room=new Si(e),this.user=new Ei(e),this.hasMCU=l,this.socketServer=i,this.socketServerPath=p,this.socketPorts={"http:":Array.isArray(c)&&c.length>0?c:[80,3e3],"https:":Array.isArray(d)&&d.length>0?d:[443,3443]},this.hasPersistentMessage=u;}}const gi=e=>{const{appKey:t}=e,r={isValid:!0,message:""};return Ys.log.INFO(["API",null,"init","API initialised with options:"],e),t||(r.isValid=!1,r.message=Lt.INIT.ERRORS.NO_APP_KEY,Vs(_e({readyState:nt.ERROR,error:{status:-2,content:new Error(Lt.INIT.ERRORS.NO_APP_KEY),errorCode:st.NO_PATH},room:null}))),r.isValid||Ys.log.ERROR(["API",null,"init",r.message]),r},mi=e=>{const{ok:t}=e;return (e=>{const{status:t,ok:r}=e,n=r?"INFO":"ERROR";let s=Lt.INIT.INFO.API_SUCCESS;r||(s=Lt.INIT.ERRORS.AUTH_GENERAL,403===t&&(s=Lt.INIT.ERRORS.AUTH_CORS)),Ys.log[n](["API",null,"auth",s],e);})(e),t},fi=e=>{const t=e;return !0===t.forceTURN&&(t.enableTURNServer=!0,t.enableSTUNServer=!1,t.filterCandidatesType.host=!0,t.filterCandidatesType.srflx=!0,t.filterCandidatesType.relay=!1),t},Ri=e=>{const t=Xi.getUserInitOptions(),r=Xi.getInitOptions();let n=Object.assign(r,e,t);const s=gi(n);if(!s.isValid)throw new Error(s.message);return n=fi(n),Xi.setInitOptions(n),n},Ti=async e=>{const{fetch:t}=window,r=(e=>{const{roomServer:t,appKey:r,defaultRoom:n,credentials:s,forceSSL:i}=e;let o=`${t}/api/${r}/${n}`,a="?";if(o=i?`https:${o}`:`${window.location.protocol}${o}`,s){const{startDateTime:e,duration:t}=s;o+=`/${e}/${t}?cred=${s.credentials}`,a="&";}return o+=`${a}rand=${Date.now()}`})(e);return {endpoint:r,response:await t(r,{headers:{Skylink_SDK_type:Dt.WEB,Skylink_SDK_version:"2.0.0",Skylink_API_version:"9.0.0","X-Server-Select":"sig-v2"}})}},Ci=e=>{return new hi(e)},_i=()=>{const{AdapterJS:e}=window,t={ready:!0,message:""};return (()=>{try{const e=new window.RTCPeerConnection(null);return ["object","function"].indexOf(typeof e.createOffer)>-1&&null!==e.createOffer}catch(e){return !1}})()||(window.RTCPeerConnection&&"plugin"===e.webrtcDetectedType?t.message="Plugin is not available. Please check plugin status.":t.message="WebRTC not supported. Please upgrade your browser",t.ready=!1,Vs(_e({readyState:nt.ERROR,error:{status:-2,content:new Error("plugin"===e.webrtcDetectedType&&window.RTCPeerConnection?"Plugin is not available":"WebRTC not available"),errorCode:st.NO_WEBRTC_SUPPORT},room:null}))),t},Ii=e=>new Promise((t,r)=>{Zs.getCodecsSupport(e).then(n=>{const s=Xi.getSkylinkState(e),{room:i}=s;0===Object.keys(n.audio).length&&0===Object.keys(n.video).length?(Ys.log.ERROR(Lt.JOIN_ROOM.ERRORS.CODEC_SUPPORT),Vs(_e({readyState:nt.ERROR,error:{status:-2,content:new Error(Lt.JOIN_ROOM.ERRORS.CODEC_SUPPORT),errorCode:st.PARSE_CODECS},room:i.roomName})),r(new Error(Lt.JOIN_ROOM.ERRORS.CODEC_SUPPORT))):t(!0),s.currentCodecSupport=n,Xi.setSkylinkState(s);}).catch(t=>{const n=Xi.getSkylinkState(e),{room:s}=n;Ys.log.ERROR(t),Vs(_e({readyState:nt.ERROR,error:{status:-2,content:new Error(t.message||t.toString()),errorCode:st.PARSE_CODECS},room:s.roomName})),r(new Error(t.message||t.toString()));});});let Oi=null;class Ai{constructor(){return Oi||(Oi=this),this.options={},Oi}init(e=ui){e&&(e.socketServer&&(e.socketServerPath=""),Xi.setUserInitOptions(e)),Vs(_e({readyState:nt.INIT,error:null,room:null}));const t=Ir(),{AdapterJS:r}=window;if(!t.fulfilled)throw Vs(_e({readyState:nt.ERROR,error:{status:-2,content:new Error(t.message),errorCode:t.readyStateChangeErrorCode},room:null})),new Error(t.message);let n=Object.assign({},ui,e);const s=gi(n);if(!s.isValid)throw new Error(s.message);return r.webRTCReady(()=>{const e=_i();if(!e.ready)throw new Error(e.message)}),n=fi(n)}createRoom(e){return new Promise((t,r)=>{const n=Xi.getInitOptions();n.defaultRoom=e,Ti(n).then(n=>{const{endpoint:s,response:i}=n;mi(i)?(Vs(_e({readyState:nt.COMPLETED,error:null,room:e})),i.json().then(e=>{t({endpoint:s,response:e});})):(Vs(_e({readyState:nt.ERROR,error:{status:i.status,content:new Error(i.info||`XMLHttpRequest status not OK\nStatus was: ${i.status}`),errorCode:i.error||i.status},room:e})),r(i.json()));}).catch(t=>{Vs(_e({readyState:nt.ERROR,error:{status:t.status||-1,content:new Error(t.message||"Network error occurred"),errorCode:st.XML_HTTP_REQUEST_ERROR},room:e}));});})}checkCodecSupport(e){return Ii(e)}static parseAPIResponseBody(e){return Ci(e)}enforceUserInitOptions(e){return Ri(e)}static getRoomNameFromParams(e){const t=Xi.getInitOptions(),{roomName:r}=e,{defaultRoom:n}=t;let s=null;return s=void 0!==r&&""!==r&&n!==r?r:n}static getStateByKey(e){return Is(e)}}const vi=e=>new Promise(t=>{const r=Xi.getSkylinkState(e.room.id),{room:n,peerConnections:s}=r,{ROOM:{LEAVE_ROOM:i}}=Lt,o=new zn,a=Object.keys(Xi.getSkylinkState()).length>1;if(r.inRoom=!1,Xi.setSkylinkState(r,n.id),a)Ys.log.INFO([n.roomName,null,null,i.SENDING_BYE]),Object.keys(s).forEach(e=>{o.bye(r,e);}),t(r);else{o.config=o.resetSocketConfig(window.location.protocol);const e=()=>{Ys.log.INFO([n.roomName,null,null,i.DISCONNECT_SOCKET.SUCCESS]),Fs(bt.CHANNEL_CLOSE,e),t(r);};Bs(bt.CHANNEL_CLOSE,e),o.socket.connected?o.socket.disconnect():t(r);}}),Di=e=>{const{room:t,streams:r}=e;r.userMedia&&$t.prepStopStreams(t.id,null,!0),r.screenshare&&new ci(e).stop(!0);},yi=e=>{Xi.clearRoomStateFromSingletons(e),Xi.removeSkylinkState(e);},Ni=e=>new Promise((t,r)=>{const{peerConnections:n,peerInformations:s,room:i,hasMCU:o,user:a}=e,{ROOM:{LEAVE_ROOM:c}}=Lt;try{const r=o?[Nt.MCU]:Array.from(new Set([...Object.keys(n),...Object.keys(s)]));if(Ss(r))Ys.log.DEBUG([i.roomName,null,null,c.NO_PEERS]),Di(e),vi(e).then(e=>{Ys.log.INFO([i.roomName,null,null,c.REMOVE_STATE.SUCCESS]),Vs(ye({peerId:a.sid,peerInfo:Qt.getCurrentSessionInfo(i),isSelf:!0,room:i})),yi(e.room.id),t(e.room.roomName);});else{const n=[];r.forEach(t=>{n.push(((e,t)=>new Promise(r=>{const{room:n,peerConnections:s}=e,{ROOM:{LEAVE_ROOM:i}}=Lt,{enableDataChannel:o}=Xi.getInitOptions();Ys.log.INFO([t,n.roomName,null,i.PEER_LEFT.START]),t===Nt.MCU?Vs(Ne({peerId:t,serverPeerType:Xe.MCU,room:n})):Vs(ye({peerId:t,peerInfo:Qt.getCurrentSessionInfo(n),isSelf:!1,room:n})),s[t]&&s[t].signalingState!==Ye.CLOSED&&oi.closePeerConnection(e,t),o?(Bs(bt.DATA_CHANNEL_STATE,e=>{const{detail:t}=e;t.state!==Be.CLOSED&&t.state!==Be.CLOSING||(Ys.log.INFO([t.peerId,n.roomName,null,i.PEER_LEFT.SUCCESS]),r(t.peerId));}),oi.closeDataChannel(e,t)):r(t);}))(e,t));}),Promise.all(n).then(()=>(Di(e),vi(e))).then(e=>{Ys.log.INFO([i.roomName,null,null,c.REMOVE_STATE.SUCCESS]),Vs(ye({peerId:a.sid,peerInfo:Qt.getCurrentSessionInfo(i),isSelf:!0,room:i})),yi(e.room.id),t(e.room.roomName);});}}catch(e){Ys.log.ERROR([i.roomName,null,null,c.ERROR],e),r(e);}}),Pi=(e=[],t=[])=>new Promise((r,n)=>{const{ROOM:{LEAVE_ROOM:s}}=Lt;try{const n=Xi.getSkylinkState(),i=Object.values(n);i[0]?Ni(i[0]).then(n=>{e.push(n),t.push(r),Pi(e,t);}):(Ys.log.INFO([e,"Room",null,s.LEAVE_ALL_ROOMS.SUCCESS]),t.forEach(t=>t(e)));}catch(e){Ys.log.ERROR([null,"Room",null,s.LEAVE_ALL_ROOMS.ERROR],e),n(e);}});class Mi extends er{constructor(){super();const{AdapterJS:e,navigator:t}=window;this.model={client_id:null,appKey:null,timestamp:null,username:null,sdk_name:Dt.WEB,sdk_version:null,agent_name:e.webrtcDetectedBrowser,agent_version:e.webrtcDetectedVersion,agent_platform:t.platform,agent_plugin_version:e.WebRTCPlugin.plugin&&e.WebRTCPlugin.plugin.VERSION||null,device_version:null,enumerated_devices:null,device_muted:null,network_type:t.connection?t.connection.type:"-",language:t.language};}send(e){const t=Xi.getSkylinkState(e);this.model.username=t.user&&t.user.uid||null,this.model.sdk_version=t.VERSION,this.model.client_id=t.clientId,this.model.appKey=Xi.getInitOptions().appKey,this.model.timestamp=(new Date).toISOString(),this.postStats(this.endpoints.client,this.model);}}class wi{constructor(e){this.dataChannels={},this.dataTransfers={},this.dataStreams={},this.peerCandidatesQueue={},this.peerEndOfCandidatesCounter={},this.gatheredCandidates={},this.retryCounters={},this.peerConnections={},this.peerStats={},this.peerBandwidth={},this.peerCustomConfigs={},this.peerInformations={},this.user=e.user,this.userData="",this.peerPriorityWeight=0,this.autoIntroduce=e.autoIntroduce,this.isPrivileged=e.isPrivileged,this.selectedRoom=null,this.roomLocked=!1,this.inRoom=!1,this.timestamp={socketMessage:null,shareScreen:null,refreshConnection:null,getUserMedia:null,lastRestart:null},this.socketSession={},this.socketMessageQueue=[],this.socketMessageTimeout=null,this.socketPorts=e.socketPorts,this.channelOpen=!1,this.socketServer=e.socketServer,this.signalingServerProtocol=e.forceSSL?"https:":window.location.protocol,this.signalingServerPort=null,this.socket=null,this.socketUseXDR=!1,this.enableIceRestart=!1,this.hasMCU=e.hasMCU,this.path=null,this.key=e.key,this.appKeyOwner=e.appKeyOwner,this.room=e.room,this.peerMessagesStamps={},this.streams={userMedia:null,screenshare:null},this.streamsDefaultSettings={userMedia:{audio:{stereo:!1},video:{resolution:{width:640,height:480},frameRate:50}},screenshare:{video:!0}},this.streamsMutedSettings={},this.streamsBandwidthSettings={googleX:{},bAS:{}},this.sdpSettings={connection:{audio:!0,video:!0,data:!0},direction:{audio:{send:!0,receive:!0},video:{send:!0,receive:!0}}},this.publishOnly=!1,this.recordings={},this.currentRecordingId=!1,this.recordingStartInterval=null,this.currentCodecSupport=null,this.sdpSessions={},this.voiceActivityDetection=!0,this.binaryChunkType=je.ARRAY_BUFFER,this.peerConnectionConfig={},this.bandwidthAdjuster=null,this.peerConnStatus={},this.joinRoomManager={timestamp:0,socketsFn:[]},this.statIdRandom=Date.now()+Math.floor(1e8*Math.random()),this.rtmpSessions={},this.SMProtocolVersion=ct,this.DTProtocolVersion=He,this.originalDTLSRole=null,this.bufferedLocalOffer={},this.bufferedRemoteOffers={},this.currentRTCRTPSenders={},this.clientId=Ds(),this.streamsMediaStatus={},this.peerMedias={},this.remoteStreams={},this.hasPersistentMessage=e.hasPersistentMessage;}}const bi=(e={},t)=>new Promise((r,n)=>{const{navigator:s,AdapterJS:i}=window,o=new Ai,a=new zn;let c=Xi.getInitOptions();const d=new Mi,l=Ai.getRoomNameFromParams(e)?Ai.getRoomNameFromParams(e):c.defaultRoom;Vs(_e({readyState:nt.LOADING,error:null,room:l})),o.createRoom(l).then(p=>{const{endpoint:u,response:S}=p;S.roomName=l;const E=new hi(S);c=o.enforceUserInitOptions(E);const h=new wi(c);h.userData=e.userData||"",h.path=u,Xi.setSkylinkState(h,l),o.checkCodecSupport(h.room.id).then(()=>(d.send(h.room.id),a.createSocket(S.room_key).then(()=>{const o=Ai.getStateByKey(S.room_key),c=Object.assign({},e);c.room=o,t||e.id&&e.active?zt.usePrefetchedStream(S.room_key,t,e).then(()=>{a.joinRoom(o),r(null);}).catch(e=>{n(e);}):e.audio||e.video?zt.getUserMedia(h,c).then(e=>{a.joinRoom(o),r(e);}).catch(e=>{n(e);}):(i.webrtcDetectedBrowser===yt.SAFARI?s.mediaDevices.getUserMedia({audio:!0}).then(()=>a.joinRoom(o)):a.joinRoom(o),r(null));}))).catch(e=>{n(e);});}).catch(e=>{n(e);});}),ki=(e,t=!0)=>{const r=e,{room:n,user:s}=r,i=new zn;r.roomLocked=t,Xi.setSkylinkState(r,n.id),i.roomLock(r),Vs(((e={})=>new pe("roomLock",{detail:e}))({isLocked:r.roomLocked,peerInfo:Qt.getCurrentSessionInfo(n),peerId:s.sid,isSelf:!0}));},Li=e=>ki(e,!0),Ui=e=>ki(e,!1);class Gi{static leaveRoom(e){return Ni(e)}static leaveAllRooms(){return Pi()}static lockRoom(e){return Li(e)}static unlockRoom(e){return Ui(e)}static joinRoom(e){return bi(e)}}const xi=(e,t,r,n=null,s=null)=>{const i=new yn;return Ys.log.ERROR(t),i.send(e.room.id,r,n,s,t),new Error(t)},Bi=(e,t)=>new Promise((r,n)=>{const{hasMCU:s,currentRecordingId:i,recordingStartInterval:o}=e;let a=t?Lt.RECORDING.START_FAILED:Lt.RECORDING.STOP_FAILED;if(!s){a=`${a} - ${Lt.RECORDING.ERRORS.MCU_NOT_CONNECTED}`;const r=t?Lt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_START:Lt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_NO_MCU_STOP;n(xi(e,a,r,null,null));}if(t&&i){n(xi(e,`${a} - ${Lt.RECORDING.ERRORS.EXISTING_RECORDING_IN_PROGRESS}`,Lt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_START_ACTIVE,i,null));}if(!t&&!i){n(xi(e,`${a} - ${Lt.RECORDING.ERRORS.NO_RECORDING_IN_PROGRESS}`,Lt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_STOP_ACTIVE,i,null));}if(!t&&o){n(xi(e,`${a} - ${Lt.RECORDING.ERRORS.MIN_RECORDING_TIME}`,Lt.STATS_MODULE.HANDLE_RECORDING_STATS.ERROR_MIN_STOP,i,null));}((e,t)=>{const r=n=>{const s=n.detail,i=t?St.START:St.STOP;s.state===i&&(Fs(bt.RECORDING_STATE,r),e(s.recordingId));};Bs(bt.RECORDING_STATE,r);})(r,t),((e,t,r=null)=>{const n=new zn,s=new yn;n.recording(e.room.id,t?ht.START_RECORDING:ht.STOP_RECORDING),s.send(e.room.id,t?Lt.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_START:Lt.STATS_MODULE.HANDLE_RECORDING_STATS.REQUEST_STOP,r,null,null);})(e,t,i);}),Fi=e=>Bi(e,!0),Vi=e=>Bi(e,!1);class ji{static start(...e){return Fi(...e)}static stop(...e){return Vi(...e)}static getRecordings(e){const{recordings:t}=e;return Object.assign({},t)}}var Hi={checkRTMPDependencies:(e,t,r=null,n=null)=>{const s={shouldProceed:!0,errorMessage:""},{hasMCU:i}=t;return i?e&&!r?(s.errorMessage=Lt.RTMP.start_no_stream_id,s.shouldProceed=!1,s):e&&!n?(s.errorMessage=Lt.RTMP.start_no_endpoint,s.shouldProceed=!1,s):s:(s.errorMessage=e?Lt.RTMP.start_no_mcu:Lt.RTMP.stop_no_mcu,s.shouldProceed=!1,s)},registerRTMPEventListenersAndResolve:(e,t)=>{const r=n=>{const s=n.detail,i=e?Rt.START:Rt.STOP;s.state===i&&(Fs(bt.RTMP_STATE,r),t(s.rtmpId));};Bs(bt.RTMP_STATE,r);},sendRTMPMessageViaSig:(e,t,r,n=null,s=null)=>{const{room:i,user:o}=e,a=new zn,c=t?ht.START_RTMP:ht.STOP_RTMP;a.rtmp(c,i.id,o.sid,r,n,s);}};class Wi{static startSession(e,t,r){return this.commonRTMPOperations(e,t,null,r,!0,Lt.RTMP.starting_rtmp)}static stopSession(e,t){return this.commonRTMPOperations(e,null,t,null,!1,Lt.RTMP.stopping_rtmp)}static logErrorAndReject(e,t){Ys.log.ERROR(e),t(e);}static commonRTMPOperations(e,t,r,n,s,i){return new Promise((o,a)=>{try{const c=Hi.checkRTMPDependencies(s,e,t,n),d=r||Ds();c.shouldProceed?(Hi.registerRTMPEventListenersAndResolve(s,o),Hi.sendRTMPMessageViaSig(e,s,d,t,n),Ys.log.INFO([Nt.MCU,"RTMP",i])):this.logErrorAndReject(new Error(c.errorMessage),a);}catch(e){this.logErrorAndReject(e,a);}})}}class Ki{async joinRoom(e={},t){return Gi.joinRoom(e,t)}sendP2PMessage(e="",t="",r=""){oi.sendP2PMessage(e,t,r);}sendMessage(e="",t="",r=""){_r.sendMessage(e,t,r);}getStoredMessages(e){const t=Os(e);t&&new Cr(t).getStoredMessages();}getPeersInRoom(e){return Cs(e,"roomName","getPeersInRoom")?oi.getPeersInRoom(e):null}getPeerInfo(e,t=null){const r=Os(e);return t&&r?Qt.getPeerInfo(t,r.room):!t&&r?Qt.getCurrentSessionInfo(r.room):null}getUserData(e,t){const r=Os(e);return r&&r.room?Qt.getUserData(r,t):null}setUserData(e,t){const r=Os(e);return r&&r.room?Qt.setUserData(r.room,t):null}getConnectionStatus(e,t){const r=Os(e);return oi.getConnectionStatus(r,t)}getPeers(e,t=!1){const r=Os(e);return r?pi.getPeerList(r.room,t):null}getPeersStreams(e,t=!0){const r=Os(e);return r?Qt.getPeersStreams(r,t):null}getPeersDataChannels(e){const t=Os(e);return t?Qt.getPeersDataChannels(t):null}getPeersCustomSettings(e){const t=Os(e);return t?Qt.getPeersCustomSettings(t):null}refreshDatachannel(e,t){const r=Os(e);return r?oi.refreshDataChannel(r,t):null}refreshConnection(e,t,r,n){const s=Os(e);return oi.refreshConnection(s,t,r,n)}shareScreen(e,t){const r=Os(e);if(r){return new ci(r).start(!1,t)}return null}getPeersScreenshare(e){const t=Os(e);return t?oi.getPeerScreenshare(t):null}getUserMedia(e=null,t){if(!e)return ys(t);if(Ts(e)){const r=Os(e);if(r)return zt.getUserMediaLayer(r,t)}else if(hs(e))return ys(e)}stopPrefetchedStream(e){return e&&(e.getTracks().forEach(e=>{e.stop();}),Vs(Ee({room:null,peerId:null,peerInfo:null,isSelf:!0,isScreensharing:!1,streamId:e.id}))),null}stopScreen(e){const t=Os(e);if(t){new ci(t).stop();}return null}stopStreams(e,t){const r=Os(e);return r?zt.stopStreams(r,t):null}leaveRoom(e){const t=Os(e);return t?Gi.leaveRoom(t):null}leaveAllRooms(){return Gi.leaveAllRooms()}startRecording(e){const t=Os(e);return t?ji.start(t):null}stopRecording(e){const t=Os(e);return t?ji.stop(t):null}lockRoom(e){const t=Os(e);return t?Gi.lockRoom(t):null}unlockRoom(e){const t=Os(e);return t?Gi.unlockRoom(t):null}getRecordings(e){const t=Os(e);return t?ji.getRecordings(t):null}muteStreams(e,t={audioMuted:!0,videoMuted:!0},r){const n=Os(e);return n?zt.muteStreams(n,t,r):null}startRTMPSession(e,t,r){const n=Os(e);return n?Wi.startSession(n,t,r):null}stopRTMPSession(e,t){const r=Os(e);return r?Wi.stopSession(r,t):null}getStreamSources(){return zt.getStreamSources()}sendStream(e,t){const r=Os(e);return zt.sendStream(r,t)}getScreenSources(){return zt.getScreenSources()}getStreams(e){const t=Os(e);return t?zt.getStreams(t):null}generateUUID(){return Ds()}setEncryptSecret(e="",t="",r=""){const n=Os(e);return new fr(n).setEncryptSecret(t,r)}getEncryptSecrets(e=""){const t=Os(e);return new fr(t).getEncryptSecrets()}deleteEncryptSecrets(e="",t=""){const r=Os(e);return new fr(r).deleteEncryptSecrets(t)}setSelectedSecret(e="",t=""){const r=Os(e);new fr(r).setSelectedSecretId(t);}getSelectedSecret(e,t){const r=Os(e);return new fr(r).getSelectedSecretId(t)}setMessagePersistence(e,t){const r=Os(e);return new Cr(r).setMessagePersistence(t)}getMessagePersistence(e){const t=Os(e);return new Cr(t).getMessagePersistence()}}window.AdapterJS=le,window.io=io;const $i=new li;let zi={},Yi={};const Ji=bt;class Xi extends Ki{constructor(e){super();const t=(new Ai).init(e);Xi.setInitOptions(t);}static getSkylinkState(e=null){return e?$i.getState(e):$i.getAllStates()}static setSkylinkState(e,t){t&&$i.setState(e);}static removeSkylinkState(e){if(e)return $i.removeStateByRoomId(e)}static clearRoomStateFromSingletons(e){if(e)return $i.clearRoomStateFromSingletons(e)}static getInitOptions(){return zi}static setInitOptions(e){zi=e;}static setUserInitOptions(e){Yi=e;}static getUserInitOptions(){return Yi}static logNoRoomState(e){Ys.log.ERROR(`${Lt.ROOM_STATE.NOT_FOUND} - ${e}`);}}e.default=Xi,e.SkylinkLogger=Ys,e.SkylinkEventManager=xs,e.SkylinkEvents=Ji,e.SkylinkConstants=kt,Object.defineProperty(e,"__esModule",{value:!0});}));

}));
